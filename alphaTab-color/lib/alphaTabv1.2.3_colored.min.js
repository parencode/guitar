/**
 * alphaTab v1.2.3 (, build 7)
 * 
 * Copyright Â© 2022, Daniel Kuschny and Contributors, All rights reserved.
 * 
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 * 
 * SoundFont loading and Audio Synthesis based on TinySoundFont (licensed under MIT)
 * Copyright (C) 2017, 2018 Bernhard Schelling (https://github.com/schellingb/TinySoundFont)
 * 
 * TinySoundFont is based on SFZero (licensed under MIT)
 * Copyright (C) 2012 Steve Folta (https://github.com/stevefolta/SFZero)
 */

/*
**
*	Colored modification
*	parencode
*
**
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).alphaTab={})}(this,function(T){"use strict";var H,V,c,W,r,z,w,U,X,x,l,_,v,g,Y,q,m,J,f,j,k,N,P,Q,K,n,$,Z,u,d,ee,te,b,S,E,ie,se,ae,a,re,ne,oe,he,i,le,de,ce,ue;T.LayoutMode=void 0,(e=T.LayoutMode||(T.LayoutMode={}))[e.Page=0]="Page",e[e.Horizontal=1]="Horizontal",T.StaveProfile=void 0,(e=T.StaveProfile||(T.StaveProfile={}))[e.Default=0]="Default",e[e.ScoreTab=1]="ScoreTab",e[e.Score=2]="Score",e[e.Tab=3]="Tab",e[e.TabMixed=4]="TabMixed";class pe{static getValue(e){return pe._values||(pe._values=new Map),e=e.toLowerCase().split(" ").join(""),pe._values.has(e)?pe._values.get(e):0}static isPiano(e){return e<=7||16<=e&&e<=23}static isGuitar(e){return 24<=e&&e<=39||105===e||43===e}}pe._values=new Map([["acousticgrandpiano",0],["brightacousticpiano",1],["electricgrandpiano",2],["honkytonkpiano",3],["electricpiano1",4],["electricpiano2",5],["harpsichord",6],["clavinet",7],["celesta",8],["glockenspiel",9],["musicbox",10],["vibraphone",11],["marimba",12],["xylophone",13],["tubularbells",14],["dulcimer",15],["drawbarorgan",16],["percussiveorgan",17],["rockorgan",18],["churchorgan",19],["reedorgan",20],["accordion",21],["harmonica",22],["tangoaccordion",23],["acousticguitarnylon",24],["acousticguitarsteel",25],["electricguitarjazz",26],["electricguitarclean",27],["electricguitarmuted",28],["overdrivenguitar",29],["distortionguitar",30],["guitarharmonics",31],["acousticbass",32],["electricbassfinger",33],["electricbasspick",34],["fretlessbass",35],["slapbass1",36],["slapbass2",37],["synthbass1",38],["synthbass2",39],["violin",40],["viola",41],["cello",42],["contrabass",43],["tremolostrings",44],["pizzicatostrings",45],["orchestralharp",46],["timpani",47],["stringensemble1",48],["stringensemble2",49],["synthstrings1",50],["synthstrings2",51],["choiraahs",52],["voiceoohs",53],["synthvoice",54],["orchestrahit",55],["trumpet",56],["trombone",57],["tuba",58],["mutedtrumpet",59],["frenchhorn",60],["brasssection",61],["synthbrass1",62],["synthbrass2",63],["sopranosax",64],["altosax",65],["tenorsax",66],["baritonesax",67],["oboe",68],["englishhorn",69],["bassoon",70],["clarinet",71],["piccolo",72],["flute",73],["recorder",74],["panflute",75],["blownbottle",76],["shakuhachi",77],["whistle",78],["ocarina",79],["lead1square",80],["lead2sawtooth",81],["lead3calliope",82],["lead4chiff",83],["lead5charang",84],["lead6voice",85],["lead7fifths",86],["lead8bassandlead",87],["pad1newage",88],["pad2warm",89],["pad3polysynth",90],["pad4choir",91],["pad5bowed",92],["pad6metallic",93],["pad7halo",94],["pad8sweep",95],["fx1rain",96],["fx2soundtrack",97],["fx3crystal",98],["fx4atmosphere",99],["fx5brightness",100],["fx6goblins",101],["fx7echoes",102],["fx8scifi",103],["sitar",104],["banjo",105],["shamisen",106],["koto",107],["kalimba",108],["bagpipe",109],["fiddle",110],["shanai",111],["tinklebell",112],["agogo",113],["steeldrums",114],["woodblock",115],["taikodrum",116],["melodictom",117],["synthdrum",118],["reversecymbal",119],["guitarfretnoise",120],["breathnoise",121],["seashore",122],["birdtweet",123],["telephonering",124],["helicopter",125],["applause",126],["gunshot",127]]);class ge{init(e,t){this.data=e,this.settings=t}}T.AlphaTabErrorType=void 0,(e=T.AlphaTabErrorType||(T.AlphaTabErrorType={}))[e.General=0]="General",e[e.Format=1]="Format",e[e.AlphaTex=2]="AlphaTex";class me extends Error{constructor(e,t="",i){super(null!=t?t:""),this.type=e,this.inner=null!=i?i:null,Object.setPrototypeOf(this,me.prototype)}}class fe extends me{constructor(e=null,t=null){super(T.AlphaTabErrorType.Format,null!=e?e:"Unsupported format"),this.inner=t,Object.setPrototypeOf(this,fe.prototype)}}(e=H=H||{})[e.None=0]="None",e[e.Normal=1]="Normal",e[e.Heavy=2]="Heavy",(e=V=V||{})[e.Tempo=0]="Tempo",e[e.Volume=1]="Volume",e[e.Instrument=2]="Instrument",e[e.Balance=3]="Balance";class ye{constructor(){this.isLinear=!1,this.type=V.Tempo,this.value=0,this.ratioPosition=0,this.text=""}static buildTempoAutomation(e,t,i,s){(s<1||5<s)&&(s=2);var a=new Float32Array([1,.5,1,1.5,2,3]),r=new ye;return r.type=V.Tempo,r.isLinear=e,r.ratioPosition=t,r.value=i*a[s],r}static buildInstrumentAutomation(e,t,i){var s=new ye;return s.type=V.Instrument,s.isLinear=e,s.ratioPosition=t,s.value=i,s}}(e=c=c||{})[e.Neutral=0]="Neutral",e[e.C3=1]="C3",e[e.C4=2]="C4",e[e.F4=3]="F4",e[e.G2=4]="G2",(e=W=W||{})[e._15ma=0]="_15ma",e[e._8va=1]="_8va",e[e.Regular=2]="Regular",e[e._8vb=3]="_8vb",e[e._15mb=4]="_15mb",(e=r=r||{})[e.None=0]="None",e[e.Simple=1]="Simple",e[e.FirstOfDouble=2]="FirstOfDouble",e[e.SecondOfDouble=3]="SecondOfDouble";class be{constructor(){this.id=be._globalBarId++,this.index=0,this.nextBar=null,this.previousBar=null,this.clef=c.G2,this.clefOttava=W.Regular,this.voices=[],this.simileMark=r.None,this.isMultiVoice=!1}get masterBar(){return this.staff.track.score.masterBars[this.index]}get isEmpty(){for(let e=0,t=this.voices.length;e<t;e++)if(!this.voices[e].isEmpty)return!1;return!0}addVoice(e){e.bar=this,e.index=this.voices.length,this.voices.push(e)}finish(i,s=null){this.isMultiVoice=!1;for(let e=0,t=this.voices.length;e<t;e++){var a=this.voices[e];a.finish(i,s),0<e&&!a.isEmpty&&(this.isMultiVoice=!0)}}calculateDuration(){let e=0;for(var t of this.voices){t=t.calculateDuration();t>e&&(e=t)}return e}}be._globalBarId=0;class p{static ticksToMillis(e,t){return e*(6e4/(t*p.QuarterTime))|0}static millisToTicks(e,t){return e/(6e4/(t*p.QuarterTime))|0}static toTicks(e){return p.valueToTicks(e)}static valueToTicks(e){let t=e;return t<0&&(t=1/-t),p.QuarterTime*(4/t)|0}static applyDot(e,t){return t?e+3*(e/4|0):e+(e/2|0)}static applyTuplet(e,t,i){return e*i/t|0}static removeTuplet(e,t,i){return e*t/i|0}static dynamicToVelocity(e){return p.MinVelocity+e*p.VelocityIncrement}}p.QuarterTime=960,p.MinVelocity=15,p.VelocityIncrement=16;class B{constructor(e=0,t=0){this.offset=e,this.value=t}}B.MaxPosition=60,B.MaxValue=12,(e=z=z||{})[e.Default=0]="Default",e[e.Gradual=1]="Gradual",e[e.Fast=2]="Fast",(e=w=w||{})[e.None=0]="None",e[e.Custom=1]="Custom",e[e.Bend=2]="Bend",e[e.Release=3]="Release",e[e.BendRelease=4]="BendRelease",e[e.Hold=5]="Hold",e[e.Prebend=6]="Prebend",e[e.PrebendBend=7]="PrebendBend",e[e.PrebendRelease=8]="PrebendRelease",(e=U=U||{})[e.None=0]="None",e[e.BrushUp=1]="BrushUp",e[e.BrushDown=2]="BrushDown",e[e.ArpeggioUp=3]="ArpeggioUp",e[e.ArpeggioDown=4]="ArpeggioDown",(e=X=X||{})[e.None=0]="None",e[e.Crescendo=1]="Crescendo",e[e.Decrescendo=2]="Decrescendo",(e=x=x||{})[e.QuadrupleWhole=-4]="QuadrupleWhole",e[e.DoubleWhole=-2]="DoubleWhole",e[e.Whole=1]="Whole",e[e.Half=2]="Half",e[e.Quarter=4]="Quarter",e[e.Eighth=8]="Eighth",e[e.Sixteenth=16]="Sixteenth",e[e.ThirtySecond=32]="ThirtySecond",e[e.SixtyFourth=64]="SixtyFourth",e[e.OneHundredTwentyEighth=128]="OneHundredTwentyEighth",e[e.TwoHundredFiftySixth=256]="TwoHundredFiftySixth",(e=l=l||{})[e.PPP=0]="PPP",e[e.PP=1]="PP",e[e.P=2]="P",e[e.MP=3]="MP",e[e.MF=4]="MF",e[e.F=5]="F",e[e.FF=6]="FF",e[e.FFF=7]="FFF",(e=_=_||{})[e.None=0]="None",e[e.OnBeat=1]="OnBeat",e[e.BeforeBeat=2]="BeforeBeat",e[e.BendGrace=3]="BendGrace",(e=v=v||{})[e.Unknown=-2]="Unknown",e[e.NoOrDead=-1]="NoOrDead",e[e.Thumb=0]="Thumb",e[e.IndexFinger=1]="IndexFinger",e[e.MiddleFinger=2]="MiddleFinger",e[e.AnnularFinger=3]="AnnularFinger",e[e.LittleFinger=4]="LittleFinger",(e=g=g||{})[e.None=0]="None",e[e.Natural=1]="Natural",e[e.Artificial=2]="Artificial",e[e.Pinch=3]="Pinch",e[e.Tap=4]="Tap",e[e.Semi=5]="Semi",e[e.Feedback=6]="Feedback",(e=Y=Y||{})[e.Default=0]="Default",e[e.ForceNone=1]="ForceNone",e[e.ForceNatural=2]="ForceNatural",e[e.ForceSharp=3]="ForceSharp",e[e.ForceDoubleSharp=4]="ForceDoubleSharp",e[e.ForceFlat=5]="ForceFlat",e[e.ForceDoubleFlat=6]="ForceDoubleFlat",(e=q=q||{})[e.None=0]="None",e[e.IntoFromBelow=1]="IntoFromBelow",e[e.IntoFromAbove=2]="IntoFromAbove",(e=m=m||{})[e.None=0]="None",e[e.Shift=1]="Shift",e[e.Legato=2]="Legato",e[e.OutUp=3]="OutUp",e[e.OutDown=4]="OutDown",e[e.PickSlideDown=5]="PickSlideDown",e[e.PickSlideUp=6]="PickSlideUp",(e=J=J||{})[e.None=0]="None",e[e.Slight=1]="Slight",e[e.Wide=2]="Wide",T.TabRhythmMode=void 0,(e=T.TabRhythmMode||(T.TabRhythmMode={}))[e.Hidden=0]="Hidden",e[e.ShowWithBeams=1]="ShowWithBeams",e[e.ShowWithBars=2]="ShowWithBars",T.FingeringMode=void 0,(e=T.FingeringMode||(T.FingeringMode={}))[e.ScoreDefault=0]="ScoreDefault",e[e.ScoreForcePiano=1]="ScoreForcePiano",e[e.SingleNoteEffectBand=2]="SingleNoteEffectBand",e[e.SingleNoteEffectBandForcePiano=3]="SingleNoteEffectBandForcePiano",T.NotationMode=void 0,(e=T.NotationMode||(T.NotationMode={}))[e.GuitarPro=0]="GuitarPro",e[e.SongBook=1]="SongBook",(e=f=f||{})[e.ScoreTitle=0]="ScoreTitle",e[e.ScoreSubTitle=1]="ScoreSubTitle",e[e.ScoreArtist=2]="ScoreArtist",e[e.ScoreAlbum=3]="ScoreAlbum",e[e.ScoreWords=4]="ScoreWords",e[e.ScoreMusic=5]="ScoreMusic",e[e.ScoreWordsAndMusic=6]="ScoreWordsAndMusic",e[e.ScoreCopyright=7]="ScoreCopyright",e[e.GuitarTuning=8]="GuitarTuning",e[e.TrackNames=9]="TrackNames",e[e.ChordDiagrams=10]="ChordDiagrams",e[e.ParenthesisOnTiedBends=11]="ParenthesisOnTiedBends",e[e.TabNotesOnTiedBends=12]="TabNotesOnTiedBends",e[e.ZerosOnDiveWhammys=13]="ZerosOnDiveWhammys",e[e.EffectAlternateEndings=14]="EffectAlternateEndings",e[e.EffectCapo=15]="EffectCapo",e[e.EffectChordNames=16]="EffectChordNames",e[e.EffectCrescendo=17]="EffectCrescendo",e[e.EffectDynamics=18]="EffectDynamics",e[e.EffectFadeIn=19]="EffectFadeIn",e[e.EffectFermata=20]="EffectFermata",e[e.EffectFingering=21]="EffectFingering",e[e.EffectHarmonics=22]="EffectHarmonics",e[e.EffectLetRing=23]="EffectLetRing",e[e.EffectLyrics=24]="EffectLyrics",e[e.EffectMarker=25]="EffectMarker",e[e.EffectOttavia=26]="EffectOttavia",e[e.EffectPalmMute=27]="EffectPalmMute",e[e.EffectPickSlide=28]="EffectPickSlide",e[e.EffectPickStroke=29]="EffectPickStroke",e[e.EffectSlightBeatVibrato=30]="EffectSlightBeatVibrato",e[e.EffectSlightNoteVibrato=31]="EffectSlightNoteVibrato",e[e.EffectTap=32]="EffectTap",e[e.EffectTempo=33]="EffectTempo",e[e.EffectText=34]="EffectText",e[e.EffectTrill=35]="EffectTrill",e[e.EffectTripletFeel=36]="EffectTripletFeel",e[e.EffectWhammyBar=37]="EffectWhammyBar",e[e.EffectWideBeatVibrato=38]="EffectWideBeatVibrato",e[e.EffectWideNoteVibrato=39]="EffectWideNoteVibrato",e[e.EffectLeftHandTap=40]="EffectLeftHandTap";class Se{constructor(){this.notationMode=T.NotationMode.GuitarPro,this.fingeringMode=T.FingeringMode.ScoreDefault,this.elements=new Map,this.rhythmMode=T.TabRhythmMode.Hidden,this.rhythmHeight=15,this.transpositionPitches=[],this.displayTranspositionPitches=[],this.smallGraceTabNotes=!0,this.extendBendArrowsOnTiedNotes=!0,this.extendLineEffectsToBeatEnd=!1,this.slurHeight=5}isNotationElementVisible(e){return this.elements.has(e)?this.elements.get(e):!Se.defaultElements.has(e)||Se.defaultElements.get(e)}}Se.defaultElements=new Map([[f.ZerosOnDiveWhammys,!1]]);class _e{constructor(e){this._value=void 0,this._factory=e}get value(){return void 0===this._value&&(this._value=this._factory()),this._value}}T.LogLevel=void 0,(e=T.LogLevel||(T.LogLevel={}))[e.None=0]="None",e[e.Debug=1]="Debug",e[e.Info=2]="Info",e[e.Warning=3]="Warning",e[e.Error=4]="Error";class we{static format(e,t){return`[AlphaTab][${e}] `+t}debug(e,t,...i){console.debug(we.format(e,t),...i)}warning(e,t,...i){console.warn(we.format(e,t),...i)}info(e,t,...i){console.info(we.format(e,t),...i)}error(e,t,...i){console.error(we.format(e,t),...i)}}we.logLevel=T.LogLevel.Info;class C{static shouldLog(e){return C.logLevel!==T.LogLevel.None&&e>=C.logLevel}static debug(e,t,...i){C.shouldLog(T.LogLevel.Debug)&&C.log.debug(e,t,...i)}static warning(e,t,...i){C.shouldLog(T.LogLevel.Warning)&&C.log.warning(e,t,...i)}static info(e,t,...i){C.shouldLog(T.LogLevel.Info)&&C.log.info(e,t,...i)}static error(e,t,...i){C.shouldLog(T.LogLevel.Error)&&C.log.error(e,t,...i)}}C.logLevel=T.LogLevel.Info,C.log=new we;class ve{constructor(){this.note=null,this.noteValue=0,this.octave=0}get realValue(){return 12*this.octave+this.noteValue}}class Be{static getIndex(e){return e<0?0:0|Math.log2(e)}static keySignatureIsFlat(e){return e<0}static keySignatureIsNatural(e){return 0===e}static keySignatureIsSharp(e){return 0<e}static applyPitchOffsets(t,i){for(let e=0;e<i.tracks.length;e++){if(e<t.notation.displayTranspositionPitches.length)for(var s of i.tracks[e].staves)s.displayTranspositionPitch=-t.notation.displayTranspositionPitches[e];if(e<t.notation.transpositionPitches.length)for(var a of i.tracks[e].staves)a.transpositionPitch=-t.notation.transpositionPitches[e]}}static fingerToString(e,t,i,s){if(e.notation.fingeringMode===T.FingeringMode.ScoreForcePiano||e.notation.fingeringMode===T.FingeringMode.SingleNoteEffectBandForcePiano||pe.isPiano(t.voice.bar.staff.track.playbackInfo.program))switch(i){case v.Unknown:case v.NoOrDead:return null;case v.Thumb:return"1";case v.IndexFinger:return"2";case v.MiddleFinger:return"3";case v.AnnularFinger:return"4";case v.LittleFinger:return"5";default:return null}if(s)switch(i){case v.Unknown:case v.NoOrDead:return"0";case v.Thumb:return"T";case v.IndexFinger:return"1";case v.MiddleFinger:return"2";case v.AnnularFinger:return"3";case v.LittleFinger:return"4";default:return null}switch(i){case v.Unknown:case v.NoOrDead:return null;case v.Thumb:return"p";case v.IndexFinger:return"i";case v.MiddleFinger:return"m";case v.AnnularFinger:return"a";case v.LittleFinger:return"c";default:return null}}static isTuning(e){return!!Be.parseTuning(e)}static parseTuning(t){let i="",s="";for(let e=0;e<t.length;e++){var a=t.charCodeAt(e);if(48<=a&&a<=57){if(!i)return null;s+=String.fromCharCode(a)}else{if(!(65<=a&&a<=90||97<=a&&a<=122||35===a))return null;i+=String.fromCharCode(a)}}var e;return s&&i?((e=new ve).octave=parseInt(s)+1,e.note=i.toLowerCase(),e.noteValue=Be.getToneForText(e.note),e):null}static getTuningForText(e){e=Be.parseTuning(e);return e?e.realValue:-1}static getToneForText(e){let t=0;switch(e.toLowerCase()){case"c":t=0;break;case"c#":case"db":t=1;break;case"d":t=2;break;case"d#":case"eb":t=3;break;case"e":t=4;break;case"f":t=5;break;case"f#":case"gb":t=6;break;case"g":t=7;break;case"g#":case"ab":t=8;break;case"a":t=9;break;case"a#":case"bb":t=10;break;case"b":t=11;break;default:return 0}return t}static newGuid(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)+Math.floor(65536*(1+Math.random())).toString(16).substring(1)+"-"+Math.floor(65536*(1+Math.random())).toString(16).substring(1)+"-"+Math.floor(65536*(1+Math.random())).toString(16).substring(1)+"-"+Math.floor(65536*(1+Math.random())).toString(16).substring(1)+"-"+Math.floor(65536*(1+Math.random())).toString(16).substring(1)+Math.floor(65536*(1+Math.random())).toString(16).substring(1)+Math.floor(65536*(1+Math.random())).toString(16).substring(1)}static isAlmostEqualTo(e,t){return Math.abs(e-t)<1e-5}static toHexString(e,t=0){let i="";for(;i=String.fromCharCode("0123456789ABCDEF".charCodeAt(15&e))+i,0<(e>>=4););for(;i.length<t;)i="0"+i;return i}static getNoteColor(e){let t="";switch(e%12){case 0:t=new We(0,28,125,255);break;case 1:t=new We(164,194,255,255);break;case 2:t=new We(0,191,255,255);break;case 3:t=new We(143,215,193,255);break;case 4:t=new We(61,171,96,255);break;case 5:t=new We(156,220,77,255);break;case 6:t=new We(216,223,161,255);break;case 7:t=new We(240,229,0,255);break;case 8:t=new We(255,185,111,255);break;case 9:t=new We(244,0,9,255);break;case 10:t=new We(201,122,255,255);break;case 11:t=new We(123,63,157,255)}return t}}(e=j=j||{})[e.None=0]="None",e[e.Up=1]="Up",e[e.Down=2]="Down",(e=k=k||{})[e.None=-1]="None",e[e.GClef=57424]="GClef",e[e.CClef=57436]="CClef",e[e.FClef=57442]="FClef",e[e.UnpitchedPercussionClef1=57449]="UnpitchedPercussionClef1",e[e.SixStringTabClef=57453]="SixStringTabClef",e[e.FourStringTabClef=57454]="FourStringTabClef",e[e.TimeSig0=57472]="TimeSig0",e[e.TimeSig1=57473]="TimeSig1",e[e.TimeSig2=57474]="TimeSig2",e[e.TimeSig3=57475]="TimeSig3",e[e.TimeSig4=57476]="TimeSig4",e[e.TimeSig5=57477]="TimeSig5",e[e.TimeSig6=57478]="TimeSig6",e[e.TimeSig7=57479]="TimeSig7",e[e.TimeSig8=57480]="TimeSig8",e[e.TimeSig9=57481]="TimeSig9",e[e.TimeSigCommon=57482]="TimeSigCommon",e[e.TimeSigCutCommon=57483]="TimeSigCutCommon",e[e.NoteheadDoubleWholeSquare=57505]="NoteheadDoubleWholeSquare",e[e.NoteheadDoubleWhole=57504]="NoteheadDoubleWhole",e[e.NoteheadWhole=57506]="NoteheadWhole",e[e.NoteheadHalf=57507]="NoteheadHalf",e[e.NoteheadBlack=57508]="NoteheadBlack",e[e.NoteheadNull=57509]="NoteheadNull",e[e.NoteheadXOrnate=57514]="NoteheadXOrnate",e[e.NoteheadTriangleUpWhole=57531]="NoteheadTriangleUpWhole",e[e.NoteheadTriangleUpHalf=57532]="NoteheadTriangleUpHalf",e[e.NoteheadTriangleUpBlack=57534]="NoteheadTriangleUpBlack",e[e.NoteheadDiamondBlackWide=57564]="NoteheadDiamondBlackWide",e[e.NoteheadDiamondWhite=57565]="NoteheadDiamondWhite",e[e.NoteheadDiamondWhiteWide=57566]="NoteheadDiamondWhiteWide",e[e.NoteheadCircleX=57523]="NoteheadCircleX",e[e.NoteheadXWhole=57511]="NoteheadXWhole",e[e.NoteheadXHalf=57512]="NoteheadXHalf",e[e.NoteheadXBlack=57513]="NoteheadXBlack",e[e.NoteheadParenthesis=57550]="NoteheadParenthesis",e[e.NoteheadSlashedBlack2=57552]="NoteheadSlashedBlack2",e[e.NoteheadCircleSlash=57591]="NoteheadCircleSlash",e[e.NoteheadHeavyX=57592]="NoteheadHeavyX",e[e.NoteheadHeavyXHat=57593]="NoteheadHeavyXHat",e[e.NoteQuarterUp=57813]="NoteQuarterUp",e[e.NoteEighthUp=57815]="NoteEighthUp",e[e.Tremolo3=57890]="Tremolo3",e[e.Tremolo2=57889]="Tremolo2",e[e.Tremolo1=57888]="Tremolo1",e[e.FlagEighthUp=57920]="FlagEighthUp",e[e.FlagEighthDown=57921]="FlagEighthDown",e[e.FlagSixteenthUp=57922]="FlagSixteenthUp",e[e.FlagSixteenthDown=57923]="FlagSixteenthDown",e[e.FlagThirtySecondUp=57924]="FlagThirtySecondUp",e[e.FlagThirtySecondDown=57925]="FlagThirtySecondDown",e[e.FlagSixtyFourthUp=57926]="FlagSixtyFourthUp",e[e.FlagSixtyFourthDown=57927]="FlagSixtyFourthDown",e[e.FlagOneHundredTwentyEighthUp=57928]="FlagOneHundredTwentyEighthUp",e[e.FlagOneHundredTwentyEighthDown=57929]="FlagOneHundredTwentyEighthDown",e[e.FlagTwoHundredFiftySixthUp=57930]="FlagTwoHundredFiftySixthUp",e[e.FlagTwoHundredFiftySixthDown=57931]="FlagTwoHundredFiftySixthDown",e[e.AccidentalFlat=57952]="AccidentalFlat",e[e.AccidentalNatural=57953]="AccidentalNatural",e[e.AccidentalSharp=57954]="AccidentalSharp",e[e.AccidentalDoubleSharp=57955]="AccidentalDoubleSharp",e[e.AccidentalDoubleFlat=57956]="AccidentalDoubleFlat",e[e.AccidentalQuarterToneFlatArrowUp=57968]="AccidentalQuarterToneFlatArrowUp",e[e.AccidentalQuarterToneSharpArrowUp=57972]="AccidentalQuarterToneSharpArrowUp",e[e.AccidentalQuarterToneNaturalArrowUp=57970]="AccidentalQuarterToneNaturalArrowUp",e[e.ArticAccentAbove=58528]="ArticAccentAbove",e[e.ArticStaccatoAbove=58530]="ArticStaccatoAbove",e[e.ArticMarcatoAbove=58540]="ArticMarcatoAbove",e[e.FermataAbove=58560]="FermataAbove",e[e.FermataShortAbove=58564]="FermataShortAbove",e[e.FermataLongAbove=58566]="FermataLongAbove",e[e.RestLonga=58593]="RestLonga",e[e.RestDoubleWhole=58594]="RestDoubleWhole",e[e.RestWhole=58595]="RestWhole",e[e.RestHalf=58596]="RestHalf",e[e.RestQuarter=58597]="RestQuarter",e[e.RestEighth=58598]="RestEighth",e[e.RestSixteenth=58599]="RestSixteenth",e[e.RestThirtySecond=58600]="RestThirtySecond",e[e.RestSixtyFourth=58601]="RestSixtyFourth",e[e.RestOneHundredTwentyEighth=58602]="RestOneHundredTwentyEighth",e[e.RestTwoHundredFiftySixth=58603]="RestTwoHundredFiftySixth",e[e.Repeat1Bar=58624]="Repeat1Bar",e[e.Repeat2Bars=58625]="Repeat2Bars",e[e.Ottava=58640]="Ottava",e[e.OttavaAlta=58641]="OttavaAlta",e[e.OttavaBassaVb=58652]="OttavaBassaVb",e[e.Quindicesima=58644]="Quindicesima",e[e.QuindicesimaAlta=58645]="QuindicesimaAlta",e[e.DynamicPPP=58666]="DynamicPPP",e[e.DynamicPP=58667]="DynamicPP",e[e.DynamicPiano=58656]="DynamicPiano",e[e.DynamicMP=58668]="DynamicMP",e[e.DynamicMF=58669]="DynamicMF",e[e.DynamicForte=58658]="DynamicForte",e[e.DynamicFF=58671]="DynamicFF",e[e.DynamicFFF=58672]="DynamicFFF",e[e.OrnamentTrill=58726]="OrnamentTrill",e[e.StringsDownBow=58896]="StringsDownBow",e[e.StringsUpBow=58898]="StringsUpBow",e[e.PictEdgeOfCymbal=59177]="PictEdgeOfCymbal",e[e.GuitarString0=59443]="GuitarString0",e[e.GuitarString1=59444]="GuitarString1",e[e.GuitarString2=59445]="GuitarString2",e[e.GuitarString3=59446]="GuitarString3",e[e.GuitarString4=59447]="GuitarString4",e[e.GuitarString5=59448]="GuitarString5",e[e.GuitarString6=59449]="GuitarString6",e[e.GuitarString7=59450]="GuitarString7",e[e.GuitarString8=59451]="GuitarString8",e[e.GuitarString9=59452]="GuitarString9",e[e.GuitarGolpe=59458]="GuitarGolpe",e[e.FretboardX=59481]="FretboardX",e[e.FretboardO=59482]="FretboardO",e[e.WiggleTrill=60068]="WiggleTrill",e[e.WiggleVibratoMediumFast=60126]="WiggleVibratoMediumFast",e[e.OctaveBaselineM=60565]="OctaveBaselineM",e[e.OctaveBaselineB=60563]="OctaveBaselineB",(e=N=N||{})[e.Left=0]="Left",e[e.Center=1]="Center",e[e.Right=2]="Right",(e=P=P||{})[e.Top=0]="Top",e[e.Middle=1]="Middle",e[e.Bottom=2]="Bottom";class h{constructor(e="",t=0,i=0,s=k.None,a=k.None,r=k.None,n=k.None,o=P.Middle){this.elementType=e,this.outputMidiNumber=i,this.staffLine=t,this.noteHeadDefault=s,this.noteHeadHalf=a!==k.None?a:s,this.noteHeadWhole=r!==k.None?r:s,this.techniqueSymbol=n,this.techniqueSymbolPlacement=o}getSymbol(e){switch(e){case x.Whole:return this.noteHeadWhole;case x.Half:return this.noteHeadHalf;default:return this.noteHeadDefault}}}class Te{static articulationFromElementVariation(e,t){return e<Te.gp6ElementAndVariationToArticulation.length?(t>=Te.gp6ElementAndVariationToArticulation.length&&(t=0),Te.gp6ElementAndVariationToArticulation[e][t]):38}static getArticulation(e){var t=e.percussionArticulation,e=e.beat.voice.bar.staff.track.percussionArticulations;return t<e.length?e[t]:Te.getArticulationByValue(t)}static getElementAndVariation(e){var i=Te.getArticulation(e);if(i)for(let t=0;t<Te.gp6ElementAndVariationToArticulation.length;t++){var s=Te.gp6ElementAndVariationToArticulation[t];for(let e=0;e<s.length;e++){var a=Te.getArticulationByValue(s[e]);if((null==a?void 0:a.outputMidiNumber)===i.outputMidiNumber)return[t,e]}}return[-1,-1]}static getArticulationByValue(e){return Te.instrumentArticulations.has(e)?Te.instrumentArticulations.get(e):null}}Te.gp6ElementAndVariationToArticulation=[[35,35,35],[38,91,37],[99,100,99],[56,100,56],[102,103,102],[43,43,43],[45,45,45],[47,47,47],[48,48,48],[50,50,50],[42,92,46],[44,44,44],[57,98,57],[49,97,49],[55,95,55],[51,93,127],[52,96,52]],Te.instrumentArticulations=new Map([[38,new h("snare",3,38,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[37,new h("snare",3,37,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack)],[91,new h("snare",3,38,k.NoteheadDiamondWhite,k.NoteheadDiamondWhite,k.NoteheadDiamondWhite)],[42,new h("hiHat",-1,42,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack)],[92,new h("hiHat",-1,46,k.NoteheadCircleSlash,k.NoteheadCircleSlash,k.NoteheadCircleSlash)],[46,new h("hiHat",-1,46,k.NoteheadCircleX,k.NoteheadCircleX,k.NoteheadCircleX)],[44,new h("hiHat",9,44,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack)],[35,new h("kickDrum",8,35,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[36,new h("kickDrum",7,36,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[50,new h("tom",1,50,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[48,new h("tom",2,48,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[47,new h("tom",4,47,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[45,new h("tom",5,45,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[43,new h("tom",6,43,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[93,new h("ride",0,51,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack,k.PictEdgeOfCymbal,P.Bottom)],[51,new h("ride",0,51,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack)],[53,new h("ride",0,53,k.NoteheadDiamondWhite,k.NoteheadDiamondWhite,k.NoteheadDiamondWhite)],[94,new h("ride",0,51,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack,k.ArticStaccatoAbove,P.Top)],[55,new h("splash",-2,55,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack)],[95,new h("splash",-2,55,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack,k.ArticStaccatoAbove,P.Bottom)],[52,new h("china",-3,52,k.NoteheadHeavyXHat,k.NoteheadHeavyXHat,k.NoteheadHeavyXHat)],[96,new h("china",-3,52,k.NoteheadHeavyXHat,k.NoteheadHeavyXHat,k.NoteheadHeavyXHat)],[49,new h("crash",-2,49,k.NoteheadHeavyX,k.NoteheadHeavyX,k.NoteheadHeavyX)],[97,new h("crash",-2,49,k.NoteheadHeavyX,k.NoteheadHeavyX,k.NoteheadHeavyX,k.ArticStaccatoAbove,P.Bottom)],[57,new h("crash",-1,57,k.NoteheadHeavyX,k.NoteheadHeavyX,k.NoteheadHeavyX)],[98,new h("crash",-1,57,k.NoteheadHeavyX,k.NoteheadHeavyX,k.NoteheadHeavyX,k.ArticStaccatoAbove,P.Bottom)],[99,new h("cowbell",1,56,k.NoteheadTriangleUpBlack,k.NoteheadTriangleUpHalf,k.NoteheadTriangleUpWhole)],[100,new h("cowbell",1,56,k.NoteheadXBlack,k.NoteheadXHalf,k.NoteheadXWhole)],[56,new h("cowbell",0,56,k.NoteheadTriangleUpBlack,k.NoteheadTriangleUpHalf,k.NoteheadTriangleUpWhole)],[101,new h("cowbell",0,56,k.NoteheadXBlack,k.NoteheadXHalf,k.NoteheadXWhole)],[102,new h("cowbell",-1,56,k.NoteheadTriangleUpBlack,k.NoteheadTriangleUpHalf,k.NoteheadTriangleUpWhole)],[103,new h("cowbell",-1,56,k.NoteheadXBlack,k.NoteheadXHalf,k.NoteheadXWhole)],[77,new h("woodblock",-9,77,k.NoteheadTriangleUpBlack,k.NoteheadTriangleUpBlack,k.NoteheadTriangleUpBlack)],[76,new h("woodblock",-10,76,k.NoteheadTriangleUpBlack,k.NoteheadTriangleUpBlack,k.NoteheadTriangleUpBlack)],[60,new h("bongo",-4,60,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[104,new h("bongo",-5,60,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole,k.NoteheadParenthesis,P.Middle)],[105,new h("bongo",-6,60,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack)],[61,new h("bongo",-7,61,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[106,new h("bongo",-8,61,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole,k.NoteheadParenthesis,P.Middle)],[107,new h("bongo",-16,61,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack)],[66,new h("timbale",10,66,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[65,new h("timbale",9,65,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[68,new h("agogo",12,68,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[67,new h("agogo",11,67,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[64,new h("conga",17,64,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[108,new h("conga",16,64,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack)],[109,new h("conga",15,64,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole,k.NoteheadParenthesis,P.Middle)],[63,new h("conga",14,63,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[110,new h("conga",13,63,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack)],[62,new h("conga",19,62,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole,k.NoteheadParenthesis,P.Middle)],[72,new h("whistle",-11,72,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[71,new h("whistle",-17,71,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[73,new h("guiro",38,73,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[74,new h("guiro",37,74,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[86,new h("surdo",36,86,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[87,new h("surdo",35,87,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadParenthesis,P.Middle)],[54,new h("tambourine",3,54,k.NoteheadTriangleUpBlack,k.NoteheadTriangleUpBlack,k.NoteheadTriangleUpBlack)],[111,new h("tambourine",2,54,k.NoteheadTriangleUpBlack,k.NoteheadTriangleUpBlack,k.NoteheadTriangleUpBlack,k.StringsUpBow,P.Bottom)],[112,new h("tambourine",1,54,k.NoteheadTriangleUpBlack,k.NoteheadTriangleUpBlack,k.NoteheadTriangleUpBlack,k.StringsDownBow,P.Bottom)],[113,new h("tambourine",-7,54,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack)],[79,new h("cuica",30,79,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[78,new h("cuica",29,78,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack)],[58,new h("vibraslap",28,58,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[81,new h("triangle",27,81,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[80,new h("triangle",26,80,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadParenthesis,P.Middle)],[114,new h("grancassa",25,43,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[115,new h("piatti",18,49,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[116,new h("piatti",24,49,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack)],[69,new h("cabasa",23,69,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[117,new h("cabasa",22,69,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole,k.StringsUpBow,P.Bottom)],[85,new h("castanets",21,85,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[75,new h("claves",20,75,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[70,new h("maraca",-12,70,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[118,new h("maraca",-13,70,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole,k.StringsUpBow,P.Bottom)],[119,new h("maraca",-14,70,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[120,new h("maraca",-15,70,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole,k.StringsUpBow,P.Bottom)],[82,new h("shaker",-23,54,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[122,new h("shaker",-24,54,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole,k.StringsUpBow,P.Bottom)],[84,new h("bellTree",-18,53,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[123,new h("bellTree",-19,53,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole,k.StringsUpBow,P.Bottom)],[83,new h("jingleBell",-20,53,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[124,new h("unpitched",-21,62,k.NoteheadNull,k.NoteheadNull,k.NoteheadNull,k.GuitarGolpe,P.Top)],[125,new h("unpitched",-22,62,k.NoteheadNull,k.NoteheadNull,k.NoteheadNull,k.GuitarGolpe,P.Bottom)],[39,new h("handClap",3,39,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[40,new h("snare",3,40,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[31,new h("snare",3,40,k.NoteheadSlashedBlack2,k.NoteheadSlashedBlack2,k.NoteheadSlashedBlack2)],[41,new h("tom",5,41,k.NoteheadBlack,k.NoteheadHalf,k.NoteheadWhole)],[59,new h("ride",2,59,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack,k.PictEdgeOfCymbal,P.Bottom)],[126,new h("ride",2,59,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack)],[127,new h("ride",2,59,k.NoteheadDiamondWhite,k.NoteheadDiamondWhite,k.NoteheadDiamondWhite)],[29,new h("ride",2,59,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack,k.ArticStaccatoAbove,P.Top)],[30,new h("crash",-3,49,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack)],[33,new h("snare",3,37,k.NoteheadXBlack,k.NoteheadXBlack,k.NoteheadXBlack)],[34,new h("snare",3,38,k.NoteheadBlack,k.NoteheadBlack,k.NoteheadBlack)]]);class ke{constructor(){this.tieDestinationNoteId=-1,this.tieOriginNoteId=-1,this.slurDestinationNoteId=-1,this.slurOriginNoteId=-1,this.hammerPullDestinationNoteId=-1,this.hammerPullOriginNoteId=-1}}class Ne{constructor(){this.id=Ne.GlobalNoteId++,this.index=0,this.accentuated=H.None,this.bendType=w.None,this.bendStyle=z.Default,this.bendOrigin=null,this.isContinuedBend=!1,this.bendPoints=[],this.maxBendPoint=null,this.fret=-1,this.string=-1,this.octave=-1,this.tone=-1,this.percussionArticulation=-1,this.isVisible=!0,this.isLeftHandTapped=!1,this.isHammerPullOrigin=!1,this.hammerPullOrigin=null,this.hammerPullDestination=null,this.isSlurDestination=!1,this.slurOrigin=null,this.slurDestination=null,this.harmonicType=g.None,this.harmonicValue=0,this.isGhost=!1,this.isLetRing=!1,this.letRingDestination=null,this.isPalmMute=!1,this.palmMuteDestination=null,this.isDead=!1,this.isStaccato=!1,this.slideInType=q.None,this.slideOutType=m.None,this.slideTarget=null,this.slideOrigin=null,this.vibrato=J.None,this.tieOrigin=null,this.tieDestination=null,this.isTieDestination=!1,this.leftHandFinger=v.Unknown,this.rightHandFinger=v.Unknown,this.isFingering=!1,this.trillValue=-1,this.trillSpeed=x.ThirtySecond,this.durationPercent=1,this.accidentalMode=Y.Default,this.dynamics=l.F,this.isEffectSlurOrigin=!1,this.hasEffectSlur=!1,this.effectSlurOrigin=null,this.effectSlurDestination=null,this._noteIdBag=null}get hasBend(){return this.bendType!==w.None}get isStringed(){return 0<=this.string}get isPiano(){return!this.isStringed&&0<=this.octave&&0<=this.tone}get isPercussion(){return!this.isStringed&&0<=this.percussionArticulation}get element(){return this.isPercussion?Te.getElementAndVariation(this)[0]:-1}get variation(){return this.isPercussion?Te.getElementAndVariation(this)[1]:-1}get isHammerPullDestination(){return!!this.hammerPullOrigin}get isSlurOrigin(){return!!this.slurDestination}get isHarmonic(){return this.harmonicType!==g.None}get isTieOrigin(){return null!==this.tieDestination}get trillFret(){return this.trillValue-this.stringTuning}get isTrill(){return 0<=this.trillValue}get isEffectSlurDestination(){return!!this.effectSlurOrigin}get stringTuning(){return this.beat.voice.bar.staff.capo+Ne.getStringTuning(this.beat.voice.bar.staff,this.string)}static getStringTuning(e,t){return 0<e.tuning.length?e.tuning[e.tuning.length-(t-1)-1]:0}get realValue(){let e=this.realValueWithoutHarmonic;return this.isStringed&&(this.harmonicType===g.Natural?e=this.harmonicPitch+this.stringTuning-this.beat.voice.bar.staff.transpositionPitch:e+=this.harmonicPitch),e}get realValueWithoutHarmonic(){return this.isPercussion?this.percussionArticulation:this.isStringed?this.fret+this.stringTuning-this.beat.voice.bar.staff.transpositionPitch:this.isPiano?12*this.octave+this.tone-this.beat.voice.bar.staff.transpositionPitch:0}get harmonicPitch(){var e;return this.harmonicType!==g.None&&this.isStringed?(e=this.harmonicValue,Be.isAlmostEqualTo(e,2.4)?36:Be.isAlmostEqualTo(e,2.7)?34:e<3?0:e<=3.5?31:e<=4?28:e<=5?24:e<=6?34:e<=7?19:e<=8.5?36:e<=9?28:e<=10?34:e<=11?0:e<=12?12:e<14?0:e<=15?34:e<=16?28:e<=17?36:e<=18?0:e<=19?19:e<=21?0:e<=22?36:e<=24?24:0):0}get initialBendValue(){return this.hasBend?Math.floor(this.bendPoints[0].value/2):this.bendOrigin?Math.floor(this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value/2):this.isTieDestination&&this.tieOrigin.bendOrigin?Math.floor(this.tieOrigin.bendOrigin.bendPoints[this.tieOrigin.bendOrigin.bendPoints.length-1].value/2):this.beat.hasWhammyBar?Math.floor(this.beat.whammyBarPoints[0].value/2):this.beat.isContinuedWhammy?Math.floor(this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value/2):0}get displayValue(){return this.displayValueWithoutBend+this.initialBendValue}get displayValueWithoutBend(){let e=this.realValue;switch(this.harmonicType!==g.Natural&&this.harmonicType!==g.None&&(e-=this.harmonicPitch),this.beat.ottava){case W._15ma:e-=24;break;case W._8va:e-=12;break;case W.Regular:break;case W._8vb:e+=12;break;case W._15mb:e+=24}switch(this.beat.voice.bar.clefOttava){case W._15ma:e-=24;break;case W._8va:e-=12;break;case W.Regular:break;case W._8vb:e+=12;break;case W._15mb:e+=24}return e-this.beat.voice.bar.staff.displayTranspositionPitch}get hasQuarterToneOffset(){return this.hasBend?this.bendPoints[0].value%2!=0:this.bendOrigin?this.bendOrigin.bendPoints[this.bendOrigin.bendPoints.length-1].value%2!=0:this.beat.hasWhammyBar?this.beat.whammyBarPoints[0].value%2!=0:!!this.beat.isContinuedWhammy&&this.beat.previousBeat.whammyBarPoints[this.beat.previousBeat.whammyBarPoints.length-1].value%2!=0}addBendPoint(e){this.bendPoints.push(e),(!this.maxBendPoint||e.value>this.maxBendPoint.value)&&(this.maxBendPoint=e),this.bendType===w.None&&(this.bendType=w.Custom)}finish(e,t=null){var i=new _e(()=>Ne.nextNoteOnSameLine(this)),e=e&&e.notation.notationMode===T.NotationMode.SongBook;switch(this.isTieDestination&&(this.chain(t),e)&&this.tieOrigin&&this.tieOrigin.isLetRing&&(this.isLetRing=!0),this.isLetRing&&(i.value&&i.value.isLetRing?this.letRingDestination=i.value:this.letRingDestination=this,e)&&this.isTieDestination&&!this.tieOrigin.hasBend&&(this.isVisible=!1),this.isPalmMute&&(i.value&&i.value.isPalmMute?this.palmMuteDestination=i.value:this.palmMuteDestination=this),this.isHammerPullOrigin&&((t=Ne.findHammerPullDestination(this))?(this.hammerPullDestination=t).hammerPullOrigin=this:this.isHammerPullOrigin=!1),this.slideOutType){case m.Shift:case m.Legato:this.slideTarget=i.value,this.slideTarget?this.slideTarget.slideOrigin=this:this.slideOutType=m.None}let s=null;this.isHammerPullOrigin&&this.hammerPullDestination?s=this.hammerPullDestination:this.slideOutType===m.Legato&&this.slideTarget&&(s=this.slideTarget),s&&(this.hasEffectSlur=!0,this.effectSlurOrigin&&this.beat.pickStroke===j.None?(this.effectSlurOrigin.effectSlurDestination=s,this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin,this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=s,this.effectSlurDestination.effectSlurOrigin=this));var a,r,n,o,e=this.bendPoints;0<e.length&&this.bendType===w.Custom?(t=this.isTieDestination&&this.tieOrigin.hasBend,this.isContinuedBend=t,4===e.length?(a=e[0],r=e[1],n=e[2],o=e[3],r.value===n.value?o.value>a.value?r.value>o.value?this.bendType=w.BendRelease:(!t&&0<a.value?this.bendType=w.PrebendBend:this.bendType=w.Bend,e.splice(2,1),e.splice(1,1)):o.value<a.value?(this.bendType=t?w.Release:w.PrebendRelease,e.splice(2,1),e.splice(1,1)):r.value>a.value?this.bendType=w.BendRelease:(0<a.value&&!t?this.bendType=w.Prebend:this.bendType=w.Hold,e.splice(2,1),e.splice(1,1)):C.warning("Model","Unsupported bend type detected, fallback to custom",null)):2===e.length&&(n=e[0],(o=e[1]).value>n.value?!t&&0<n.value?this.bendType=w.PrebendBend:this.bendType=w.Bend:o.value<n.value?this.bendType=t?w.Release:w.PrebendRelease:this.bendType=w.Hold)):0===e.length&&(this.bendType=w.None),0<this.initialBendValue&&(this.accidentalMode=Y.Default)}static nextNoteOnSameLine(e){let t=e.beat.nextBeat;for(;t&&t.voice.bar.index<=e.beat.voice.bar.index+Ne.MaxOffsetForSameLineSearch;){var i=t.getNoteOnString(e.string);if(i)return i;t=t.nextBeat}return null}static findHammerPullDestination(i){let s=i.beat.nextBeat;for(;s&&s.voice.bar.index<=i.beat.voice.bar.index+Ne.MaxOffsetForSameLineSearch;){let t=s.getNoteOnString(i.string);if(t)return t;for(let e=i.string;0<e;e--)if(t=s.getNoteOnString(e)){if(t.isLeftHandTapped)return t;break}for(let e=i.string;e<=i.beat.voice.bar.staff.tuning.length;e++)if(t=s.getNoteOnString(e)){if(t.isLeftHandTapped)return t;break}s=s.nextBeat}return null}static findTieOrigin(e){let t=e.beat.previousBeat;for(;t&&t.voice.bar.index>=e.beat.voice.bar.index-Ne.MaxOffsetForSameLineSearch;){if(e.isStringed){var i=t.getNoteOnString(e.string);if(i)return i}else if(-1===e.octave&&-1===e.tone){if(e.index<t.notes.length)return t.notes[e.index]}else{i=t.getNoteWithRealValue(e.realValue);if(i)return i}t=t.previousBeat}return null}chain(t=null){if(null!==t)if(null!==this._noteIdBag){let e;t.has(Ne.NoteIdLookupKey)?e=t.get(Ne.NoteIdLookupKey):(e=new Map,t.set(Ne.NoteIdLookupKey,e)),-1===this._noteIdBag.hammerPullDestinationNoteId&&-1===this._noteIdBag.tieDestinationNoteId&&-1===this._noteIdBag.slurDestinationNoteId||e.set(this.id,this),-1!==this._noteIdBag.hammerPullOriginNoteId&&(this.hammerPullOrigin=e.get(this._noteIdBag.hammerPullOriginNoteId),this.hammerPullOrigin.hammerPullDestination=this),-1!==this._noteIdBag.tieOriginNoteId&&(this.tieOrigin=e.get(this._noteIdBag.tieOriginNoteId),this.tieOrigin.tieDestination=this),-1!==this._noteIdBag.slurOriginNoteId&&(this.slurOrigin=e.get(this._noteIdBag.slurOriginNoteId),this.slurOrigin.slurDestination=this),this._noteIdBag=null}else!this.isTieDestination&&null===this.tieOrigin||((t=Ne.findTieOrigin(this))?((t.tieDestination=this).tieOrigin=t,this.fret=t.fret,this.octave=t.octave,this.tone=t.tone,t.hasBend&&(this.bendOrigin=this.tieOrigin)):this.isTieDestination=!1)}toJson(e){null!==this.tieDestination&&e.set("tiedestinationnoteid",this.tieDestination.id),null!==this.tieOrigin&&e.set("tieoriginnoteid",this.tieOrigin.id),null!==this.slurDestination&&e.set("slurdestinationnoteid",this.slurDestination.id),null!==this.slurOrigin&&e.set("sluroriginnoteid",this.slurOrigin.id),null!==this.hammerPullOrigin&&e.set("hammerpulloriginnoteid",this.hammerPullOrigin.id),null!==this.hammerPullDestination&&e.set("hammerpulldestinationnoteid",this.hammerPullDestination.id)}setProperty(e,t){switch(e){case"tiedestinationnoteid":return null===this._noteIdBag&&(this._noteIdBag=new ke),this._noteIdBag.tieDestinationNoteId=t,!0;case"tieoriginnoteid":return null===this._noteIdBag&&(this._noteIdBag=new ke),this._noteIdBag.tieOriginNoteId=t,!0;case"slurdestinationnoteid":return null===this._noteIdBag&&(this._noteIdBag=new ke),this._noteIdBag.slurDestinationNoteId=t,!0;case"sluroriginnoteid":return null===this._noteIdBag&&(this._noteIdBag=new ke),this._noteIdBag.slurOriginNoteId=t,!0;case"hammerpulloriginnoteid":return null===this._noteIdBag&&(this._noteIdBag=new ke),this._noteIdBag.hammerPullOriginNoteId=t,!0;case"hammerpulldestinationnoteid":return null===this._noteIdBag&&(this._noteIdBag=new ke),this._noteIdBag.hammerPullDestinationNoteId=t,!0}return!1}}Ne.GlobalNoteId=0,Ne.MaxOffsetForSameLineSearch=3,Ne.NoteIdLookupKey="NoteIdLookup";class xe{constructor(e){this._isEqualLengthTuplet=!0,this.totalDuration=0,this.beats=[],this.isFull=!1,this.voice=e}check(e){if(0===this.beats.length)this.beats.push(e),this.totalDuration+=e.playbackDuration;else if(e.graceType===_.None){if(e.voice!==this.voice||this.isFull||e.tupletNumerator!==this.beats[0].tupletNumerator||e.tupletDenominator!==this.beats[0].tupletDenominator)return!1;if(e.playbackDuration!==this.beats[0].playbackDuration&&(this._isEqualLengthTuplet=!1),this.beats.push(e),this.totalDuration+=e.playbackDuration,this._isEqualLengthTuplet)this.beats.length===this.beats[0].tupletNumerator&&(this.isFull=!0);else{var t,i=this.beats[0].tupletNumerator/this.beats[0].tupletDenominator|0;for(t of xe.AllTicks)if(this.totalDuration===t*i){this.isFull=!0;break}}}return!0}}xe.HalfTicks=1920,xe.QuarterTicks=960,xe.EighthTicks=480,xe.SixteenthTicks=240,xe.ThirtySecondTicks=120,xe.SixtyFourthTicks=60,xe.OneHundredTwentyEighthTicks=30,xe.TwoHundredFiftySixthTicks=15,xe.AllTicks=[xe.HalfTicks,xe.QuarterTicks,xe.EighthTicks,xe.SixteenthTicks,xe.ThirtySecondTicks,xe.SixtyFourthTicks,xe.OneHundredTwentyEighthTicks,xe.TwoHundredFiftySixthTicks],(e=Q=Q||{})[e.None=0]="None",e[e.Custom=1]="Custom",e[e.Dive=2]="Dive",e[e.Dip=3]="Dip",e[e.Hold=4]="Hold",e[e.Predive=5]="Predive",e[e.PrediveDive=6]="PrediveDive";class Pe{static clone(e){var t=new B;return t.offset=e.offset,t.value=e.value,t}}class Ee{static clone(e){var t=new Ne;t.index=e.index,t.accentuated=e.accentuated,t.bendType=e.bendType,t.bendStyle=e.bendStyle,t.isContinuedBend=e.isContinuedBend,t.bendPoints=[];for(const i of e.bendPoints)t.addBendPoint(Pe.clone(i));return t.fret=e.fret,t.string=e.string,t.octave=e.octave,t.tone=e.tone,t.percussionArticulation=e.percussionArticulation,t.isVisible=e.isVisible,t.isLeftHandTapped=e.isLeftHandTapped,t.isHammerPullOrigin=e.isHammerPullOrigin,t.isSlurDestination=e.isSlurDestination,t.harmonicType=e.harmonicType,t.harmonicValue=e.harmonicValue,t.isGhost=e.isGhost,t.isLetRing=e.isLetRing,t.isPalmMute=e.isPalmMute,t.isDead=e.isDead,t.isStaccato=e.isStaccato,t.slideInType=e.slideInType,t.slideOutType=e.slideOutType,t.vibrato=e.vibrato,t.isTieDestination=e.isTieDestination,t.leftHandFinger=e.leftHandFinger,t.rightHandFinger=e.rightHandFinger,t.isFingering=e.isFingering,t.trillValue=e.trillValue,t.trillSpeed=e.trillSpeed,t.durationPercent=e.durationPercent,t.accidentalMode=e.accidentalMode,t.dynamics=e.dynamics,t}}class Ce{static clone(e){var t=new ye;return t.isLinear=e.isLinear,t.type=e.type,t.value=e.value,t.ratioPosition=e.ratioPosition,t.text=e.text,t}}class Fe{static clone(e){var t=new Me;t.index=e.index,t.notes=[];for(const i of e.notes)t.addNote(Ee.clone(i));t.isEmpty=e.isEmpty,t.whammyStyle=e.whammyStyle,t.ottava=e.ottava,t.isLegatoOrigin=e.isLegatoOrigin,t.duration=e.duration,t.isLetRing=e.isLetRing,t.isPalmMute=e.isPalmMute,t.automations=[];for(const s of e.automations)t.automations.push(Ce.clone(s));t.dots=e.dots,t.fadeIn=e.fadeIn,t.lyrics=e.lyrics?e.lyrics.slice():null,t.hasRasgueado=e.hasRasgueado,t.pop=e.pop,t.slap=e.slap,t.tap=e.tap,t.text=e.text,t.brushType=e.brushType,t.brushDuration=e.brushDuration,t.tupletDenominator=e.tupletDenominator,t.tupletNumerator=e.tupletNumerator,t.isContinuedWhammy=e.isContinuedWhammy,t.whammyBarType=e.whammyBarType,t.whammyBarPoints=[];for(const a of e.whammyBarPoints)t.addWhammyBarPoint(Pe.clone(a));return t.vibrato=e.vibrato,t.chordId=e.chordId,t.graceType=e.graceType,t.pickStroke=e.pickStroke,t.tremoloSpeed=e.tremoloSpeed,t.crescendo=e.crescendo,t.displayStart=e.displayStart,t.playbackStart=e.playbackStart,t.displayDuration=e.displayDuration,t.playbackDuration=e.playbackDuration,t.dynamics=e.dynamics,t.invertBeamDirection=e.invertBeamDirection,t.preferredBeamDirection=e.preferredBeamDirection,t.isEffectSlurOrigin=e.isEffectSlurOrigin,t.beamingMode=e.beamingMode,t}}class Le{constructor(){this.beats=[],this.id="empty",this.isComplete=!1}addBeat(e){e.graceIndex=this.beats.length,(e.graceGroup=this).beats.push(e)}finish(){0<this.beats.length&&(this.id=this.beats[0].absoluteDisplayStart+"_"+this.beats[0].voice.index)}}(e=K=K||{})[e.Auto=0]="Auto",e[e.ForceSplitToNext=1]="ForceSplitToNext",e[e.ForceMergeWithNext=2]="ForceMergeWithNext";class Me{constructor(){this.id=Me._globalBeatId++,this.index=0,this.previousBeat=null,this.nextBeat=null,this.notes=[],this.noteStringLookup=new Map,this.noteValueLookup=new Map,this.isEmpty=!1,this.whammyStyle=z.Default,this.ottava=W.Regular,this.fermata=null,this.isLegatoOrigin=!1,this.minNote=null,this.maxNote=null,this.maxStringNote=null,this.minStringNote=null,this.duration=x.Quarter,this.isLetRing=!1,this.isPalmMute=!1,this.automations=[],this.dots=0,this.fadeIn=!1,this.lyrics=null,this.hasRasgueado=!1,this.pop=!1,this.slap=!1,this.tap=!1,this.text=null,this.brushType=U.None,this.brushDuration=0,this.tupletDenominator=-1,this.tupletNumerator=-1,this.tupletGroup=null,this.isContinuedWhammy=!1,this.whammyBarType=Q.None,this.whammyBarPoints=[],this.maxWhammyPoint=null,this.minWhammyPoint=null,this.vibrato=J.None,this.chordId=null,this.graceType=_.None,this.graceGroup=null,this.graceIndex=-1,this.pickStroke=j.None,this.tremoloSpeed=null,this.crescendo=X.None,this.displayStart=0,this.playbackStart=0,this.displayDuration=0,this.playbackDuration=0,this.dynamics=l.F,this.invertBeamDirection=!1,this.preferredBeamDirection=null,this.isEffectSlurOrigin=!1,this.effectSlurOrigin=null,this.effectSlurDestination=null,this.beamingMode=K.Auto}get isLastOfVoice(){return this.index===this.voice.beats.length-1}get isLegatoDestination(){return!!this.previousBeat&&this.previousBeat.isLegatoOrigin}get isRest(){return this.isEmpty||0===this.notes.length}get isFullBarRest(){return this.isRest&&1===this.voice.beats.length&&this.duration===x.Whole}get hasTuplet(){return!(-1===this.tupletDenominator&&-1===this.tupletNumerator||1===this.tupletDenominator&&1===this.tupletNumerator)}get hasWhammyBar(){return this.whammyBarType!==Q.None}get hasChord(){return!!this.chordId}get chord(){return this.chordId?this.voice.bar.staff.getChord(this.chordId):null}get isTremolo(){return!!this.tremoloSpeed}get absoluteDisplayStart(){return this.voice.bar.masterBar.start+this.displayStart}get absolutePlaybackStart(){return this.voice.bar.masterBar.start+this.playbackStart}get isEffectSlurDestination(){return!!this.effectSlurOrigin}addWhammyBarPoint(e){this.whammyBarPoints.push(e),(!this.maxWhammyPoint||e.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=e),(!this.minWhammyPoint||e.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=e),this.whammyBarType===Q.None&&(this.whammyBarType=Q.Custom)}removeWhammyBarPoint(e){var t=this.whammyBarPoints;if(!(e<0||e>=t.length)){t.splice(e,1);e=t[e];if(e===this.maxWhammyPoint){this.maxWhammyPoint=null;for(var i of t)(!this.maxWhammyPoint||i.value>this.maxWhammyPoint.value)&&(this.maxWhammyPoint=i)}if(e===this.minWhammyPoint){this.minWhammyPoint=null;for(var s of t)(!this.minWhammyPoint||s.value<this.minWhammyPoint.value)&&(this.minWhammyPoint=s)}}}addNote(e){e.beat=this,e.index=this.notes.length,this.notes.push(e),e.isStringed&&this.noteStringLookup.set(e.string,e)}removeNote(e){var t=this.notes.indexOf(e);0<=t&&(this.notes.splice(t,1),e.isStringed)&&this.noteStringLookup.delete(e.string)}getAutomation(i){for(let e=0,t=this.automations.length;e<t;e++){var s=this.automations[e];if(s.type===i)return s}return null}getNoteOnString(e){return this.noteStringLookup.has(e)?this.noteStringLookup.get(e):null}calculateDuration(){if(this.isFullBarRest)return this.voice.bar.masterBar.calculateDuration();let e=p.toTicks(this.duration);return 2===this.dots?e=p.applyDot(e,!0):1===this.dots&&(e=p.applyDot(e,!1)),e=0<this.tupletDenominator&&0<=this.tupletNumerator?p.applyTuplet(e,this.tupletNumerator,this.tupletDenominator):e}updateDurations(){var e=this.calculateDuration();switch(this.playbackDuration=e,this.graceType){case _.BeforeBeat:case _.OnBeat:switch(this.duration){case x.Sixteenth:this.playbackDuration=p.toTicks(x.SixtyFourth);break;case x.ThirtySecond:this.playbackDuration=p.toTicks(x.OneHundredTwentyEighth);break;default:this.playbackDuration=p.toTicks(x.ThirtySecond)}this.displayDuration=0;break;case _.BendGrace:this.playbackDuration/=2,this.displayDuration=0;break;default:this.displayDuration=e;var t=this.previousBeat;t&&t.graceType===_.BendGrace&&(this.playbackDuration=t.playbackDuration)}}finishTuplet(){var e=this.previousBeat;let t=e?e.tupletGroup:null;(this.hasTuplet||this.graceType!==_.None&&t)&&(e&&t&&t.check(this)||(t=new xe(this.voice)).check(this),this.tupletGroup=t)}finish(i,s=null){switch(null===this.getAutomation(V.Instrument)&&0===this.index&&0===this.voice.index&&0===this.voice.bar.index&&0===this.voice.bar.staff.index&&this.automations.push(ye.buildInstrumentAutomation(!1,0,this.voice.bar.staff.track.playbackInfo.program)),this.graceType){case _.OnBeat:case _.BeforeBeat:var e=this.graceGroup.beats.length;this.duration=1===e?x.Eighth:2===e?x.Sixteenth:x.ThirtySecond}var a=i?i.notation.notationMode:T.NotationMode.GuitarPro;let r="grad"===this.text||"grad."===this.text,n=(r&&a===T.NotationMode.SongBook&&(this.text=""),!1),o=(this.minNote=null,this.maxNote=null,this.minStringNote=null,this.maxStringNote=null,0),h=!1;for(let e=0,t=this.notes.length;e<t;e++){var l=this.notes[e];if(l.dynamics=this.dynamics,l.finish(i,s),l.isLetRing&&(this.isLetRing=!0),l.isPalmMute&&(this.isPalmMute=!0),a===T.NotationMode.SongBook&&l.hasBend&&this.graceType!==_.BendGrace){if(!l.isTieOrigin)switch(l.bendType){case w.Bend:case w.PrebendRelease:case w.PrebendBend:n=!0}r||l.bendStyle===z.Gradual?(r=!0,l.bendStyle=z.Gradual,n=!1):l.bendStyle=z.Fast}l.isVisible&&(o++,(!this.minNote||l.realValue<this.minNote.realValue)&&(this.minNote=l),(!this.maxNote||l.realValue>this.maxNote.realValue)&&(this.maxNote=l),(!this.minStringNote||l.string<this.minStringNote.string)&&(this.minStringNote=l),(!this.maxStringNote||l.string>this.maxStringNote.string)&&(this.maxStringNote=l),l.hasEffectSlur)&&(h=!0)}if(h&&(this.effectSlurOrigin?(this.effectSlurOrigin.effectSlurDestination=this.nextBeat,this.effectSlurOrigin.effectSlurDestination&&(this.effectSlurOrigin.effectSlurDestination.effectSlurOrigin=this.effectSlurOrigin),this.effectSlurOrigin=null):(this.isEffectSlurOrigin=!0,this.effectSlurDestination=this.nextBeat,this.effectSlurDestination&&(this.effectSlurDestination.effectSlurOrigin=this))),0<this.notes.length&&0===o&&(this.isEmpty=!0),this.isRest||this.isLetRing&&this.isPalmMute)this.isRest&&this.previousBeat&&i&&i.notation.notationMode===T.NotationMode.GuitarPro&&(this.previousBeat.isLetRing&&(this.isLetRing=!0),this.previousBeat.isPalmMute)&&(this.isPalmMute=!0);else{let e=this.previousBeat;for(;e&&e.isRest;)this.isLetRing||(e.isLetRing=!1),this.isPalmMute||(e.isPalmMute=!1),e=e.previousBeat}var t,d,c,u,p,g=this.whammyBarPoints;if(0<g.length&&this.whammyBarType===Q.Custom&&(a===T.NotationMode.SongBook&&(this.whammyStyle=r?z.Gradual:z.Fast),t=!!this.previousBeat&&this.previousBeat.hasWhammyBar,this.isContinuedWhammy=t,4===g.length)&&(d=g[0],c=g[1],u=g[2],p=g[3],c.value===u.value?d.value<c.value&&c.value<p.value||d.value>c.value&&c.value>p.value?(0===d.value||t?this.whammyBarType=Q.Dive:this.whammyBarType=Q.PrediveDive,g.splice(2,1),g.splice(1,1)):d.value>c.value&&c.value<p.value||d.value<c.value&&c.value>p.value?(this.whammyBarType=Q.Dip,c.offset!==u.offset&&a!==T.NotationMode.SongBook||g.splice(2,1)):d.value===c.value&&c.value===p.value?(0===d.value||t?this.whammyBarType=Q.Hold:this.whammyBarType=Q.Predive,g.splice(2,1),g.splice(1,1)):C.warning("Model","Unsupported whammy type detected, fallback to custom",null):C.warning("Model","Unsupported whammy type detected, fallback to custom",null)),this.updateDurations(),n){var m=Fe.clone(this);m.id=Me._globalBeatId++,m.pickStroke=j.None;for(let e=0,t=m.notes.length;e<t;e++){var f,y=m.notes[e],b=this.notes[e];y.bendType=w.None,y.maxBendPoint=null,y.bendPoints=[],y.bendStyle=z.Default,y.id=Ne.GlobalNoteId++,b.isTieOrigin&&(y.tieDestination=b.tieDestination,b.tieDestination.tieOrigin=y),b.isTieDestination&&(y.tieOrigin=b.tieOrigin||null,b.tieOrigin.tieDestination=y),b.hasBend&&b.isTieOrigin&&(f=Ne.findTieOrigin(b))&&f.hasBend&&(y.bendType=w.Hold,f=b.bendPoints[b.bendPoints.length-1],y.addBendPoint(new B(0,f.value)),y.addBendPoint(new B(B.MaxPosition,f.value))),y.isTieDestination=!0}this.graceType=_.BendGrace,this.graceGroup=new Le,this.graceGroup.addBeat(this),this.graceGroup.isComplete=!0,this.graceGroup.finish(),this.updateDurations(),this.voice.insertBeat(this,m),m.graceGroup=new Le,m.graceGroup.addBeat(this),m.graceGroup.isComplete=!0,m.graceGroup.finish()}}isBefore(e){return this.voice.bar.index<e.voice.bar.index||e.voice.bar.index===this.voice.bar.index&&this.index<e.index}isAfter(e){return this.voice.bar.index>e.voice.bar.index||e.voice.bar.index===this.voice.bar.index&&this.index>e.index}hasNoteOnString(e){return this.noteStringLookup.has(e)}getNoteWithRealValue(e){return this.noteValueLookup.has(e)?this.noteValueLookup.get(e):null}chain(e=null){for(const t of this.notes)this.noteValueLookup.set(t.realValue,t),t.chain(e)}}Me._globalBeatId=0;class De{constructor(){this.name="",this.firstFret=1,this.strings=[],this.barreFrets=[],this.showName=!0,this.showDiagram=!0,this.showFingering=!0}}(e=n=n||{})[e.Cb=-7]="Cb",e[e.Gb=-6]="Gb",e[e.Db=-5]="Db",e[e.Ab=-4]="Ab",e[e.Eb=-3]="Eb",e[e.Bb=-2]="Bb",e[e.F=-1]="F",e[e.C=0]="C",e[e.G=1]="G",e[e.D=2]="D",e[e.A=3]="A",e[e.E=4]="E",e[e.B=5]="B",e[e.FSharp=6]="FSharp",e[e.CSharp=7]="CSharp",(e=$=$||{})[e.IgnoreSpaces=0]="IgnoreSpaces",e[e.Begin=1]="Begin",e[e.Text=2]="Text",e[e.Comment=3]="Comment",e[e.Dash=4]="Dash";class Ie{constructor(){this.startBar=0,this.text=""}finish(e=!1){this.chunks=[],this.parse(this.text,0,this.chunks,e)}parse(a,r,e,n){if(a){let e=$.Begin,t=$.Begin,i=!1,s=0;for(;r<a.length;){var o=a.charCodeAt(r);switch(e){case $.IgnoreSpaces:switch(o){case Ie.CharCodeLF:case Ie.CharCodeCR:case Ie.CharCodeTab:break;case Ie.CharCodeSpace:if(i)break;e=t;continue;default:i=!1,e=t;continue}break;case $.Begin:if(o!==Ie.CharCodeBrackedOpen){s=r,e=$.Text;continue}e=$.Comment;break;case $.Comment:o===Ie.CharCodeBrackedClose&&(e=$.Begin);break;case $.Text:switch(o){case Ie.CharCodeDash:e=$.Dash;break;case Ie.CharCodeCR:case Ie.CharCodeLF:case Ie.CharCodeSpace:var h=a.substr(s,r-s);this.addChunk(h,n),e=$.IgnoreSpaces,t=$.Begin}break;case $.Dash:if(o!==Ie.CharCodeDash){var l=a.substr(s,r-s);this.addChunk(l,n),i=!0,e=$.IgnoreSpaces,t=$.Begin;continue}}r+=1}e===$.Text&&r!==s&&this.addChunk(a.substr(s,r-s),n)}}addChunk(e,t){e=this.prepareChunk(e),(!t||0<e.length&&"-"!==e)&&this.chunks.push(e)}prepareChunk(e){var t=e.split("+").join(" ");let i=t.length;for(;0<i&&"_"===t.charAt(i-1);)i--;return i!==t.length?t.substr(0,i):t}}Ie.CharCodeLF=10,Ie.CharCodeTab=9,Ie.CharCodeCR=13,Ie.CharCodeSpace=32,Ie.CharCodeBrackedClose=93,Ie.CharCodeBrackedOpen=91,Ie.CharCodeDash=45,(e=Z=Z||{})[e.Major=0]="Major",e[e.Minor=1]="Minor",(e=u=u||{})[e.NoTripletFeel=0]="NoTripletFeel",e[e.Triplet16th=1]="Triplet16th",e[e.Triplet8th=2]="Triplet8th",e[e.Dotted16th=3]="Dotted16th",e[e.Dotted8th=4]="Dotted8th",e[e.Scottish16th=5]="Scottish16th",e[e.Scottish8th=6]="Scottish8th";class Re{constructor(){this.alternateEndings=0,this.nextMasterBar=null,this.previousMasterBar=null,this.index=0,this.keySignature=n.C,this.keySignatureType=Z.Major,this.isDoubleBar=!1,this.isRepeatStart=!1,this.repeatCount=0,this.timeSignatureNumerator=4,this.timeSignatureDenominator=4,this.timeSignatureCommon=!1,this.tripletFeel=u.NoTripletFeel,this.section=null,this.tempoAutomation=null,this.fermata=new Map,this.start=0,this.isAnacrusis=!1}get isRepeatEnd(){return 0<this.repeatCount}get isSectionStart(){return!!this.section}calculateDuration(e=!0){if(this.isAnacrusis&&e){let e=0;for(var t of this.score.tracks)for(var i of t.staves){i=this.index<i.bars.length?i.bars[this.index].calculateDuration():0;i>e&&(e=i)}return e}return this.timeSignatureNumerator*p.valueToTicks(this.timeSignatureDenominator)}addFermata(e,t){this.fermata.set(e,t)}getFermata(e){var t=this.fermata;return t.has(e.playbackStart)?t.get(e.playbackStart):null}}Re.MaxAlternateEndings=8;class Ae{constructor(){this.hideDynamics=!1}}class Oe{constructor(){this.masterBars=[],this.opening=null,this.closings=[],this.isClosed=!1}get openings(){var e=this.opening;return e?[e]:[]}get isOpened(){var e;return!0===(null==(e=this.opening)?void 0:e.isRepeatStart)}addMasterBar(e){null===this.opening&&(this.opening=e),this.masterBars.push(e),e.repeatGroup=this,e.isRepeatEnd&&(this.closings.push(e),this.isClosed=!0)}}class Ge{constructor(){this._currentRepeatGroup=null,this._openedRepeatGroups=[],this._properlyOpenedRepeatGroups=0,this.album="",this.artist="",this.copyright="",this.instructions="",this.music="",this.notices="",this.subTitle="",this.title="",this.words="",this.tab="",this.tempo=120,this.tempoLabel="",this.masterBars=[],this.tracks=[],this.stylesheet=new Ae}rebuildRepeatGroups(){this._currentRepeatGroup=null,this._openedRepeatGroups=[],this._properlyOpenedRepeatGroups=0;for(const e of this.masterBars)this.addMasterBarToRepeatGroups(e)}addMasterBar(e){e.score=this,e.index=this.masterBars.length,0!==this.masterBars.length&&(e.previousMasterBar=this.masterBars[this.masterBars.length-1],(e.previousMasterBar.nextMasterBar=e).start=e.previousMasterBar.start+(e.previousMasterBar.isAnacrusis?0:e.previousMasterBar.calculateDuration())),this.addMasterBarToRepeatGroups(e),this.masterBars.push(e)}addMasterBarToRepeatGroups(e){var t;e.isRepeatStart?(null!=(t=this._currentRepeatGroup)&&t.isClosed&&(this._openedRepeatGroups.pop(),this._properlyOpenedRepeatGroups--),this._currentRepeatGroup=new Oe,this._openedRepeatGroups.push(this._currentRepeatGroup),this._properlyOpenedRepeatGroups++):this._currentRepeatGroup||(this._currentRepeatGroup=new Oe,this._openedRepeatGroups.push(this._currentRepeatGroup)),this._currentRepeatGroup.addMasterBar(e),e.isRepeatEnd&&1<this._properlyOpenedRepeatGroups&&(this._openedRepeatGroups.pop(),this._properlyOpenedRepeatGroups--,this._currentRepeatGroup=0<this._openedRepeatGroups.length?this._openedRepeatGroups[this._openedRepeatGroups.length-1]:null)}addTrack(e){e.score=this,e.index=this.tracks.length,this.tracks.push(e)}finish(i){var s=new Map;for(let e=0,t=this.tracks.length;e<t;e++)this.tracks[e].finish(i,s)}}class He{constructor(){this.marker="",this.text=""}}class Ve extends me{constructor(e){super(T.AlphaTabErrorType.Format,e),Object.setPrototypeOf(this,Ve.prototype)}}class We{constructor(e,t,i,s=255){this.raw=0,this.raw=(255&s)<<24|(255&e)<<16|(255&t)<<8|255&i,this.updateRgba()}updateRgba(){255===this.a?this.rgba="#"+Be.toHexString(this.r,2)+Be.toHexString(this.g,2)+Be.toHexString(this.b,2):this.rgba=`rgba(${this.r},${this.g},${this.b},${this.a/255})`}get a(){return this.raw>>24&255}get r(){return this.raw>>16&255}get g(){return this.raw>>8&255}get b(){return 255&this.raw}static random(e=100){return new We(255*Math.random()|0,255*Math.random()|0,255*Math.random()|0,e)}static fromJson(e){switch(typeof e){case"number":var t=new We(0,0,0,0);return t.raw=e,t.updateRgba(),t;case"string":t=e;if(t.startsWith("#")){if(4===t.length)return new We(17*parseInt(t[1],16),17*parseInt(t[2],16),17*parseInt(t[3],16));if(5===t.length)return new We(17*parseInt(t[1],16),17*parseInt(t[2],16),17*parseInt(t[3],16),17*parseInt(t[4],16));if(7===t.length)return new We(parseInt(t.substring(1,3),16),parseInt(t.substring(3,5),16),parseInt(t.substring(5,7),16));if(9===t.length)return new We(parseInt(t.substring(1,3),16),parseInt(t.substring(3,5),16),parseInt(t.substring(5,7),16),parseInt(t.substring(7,9),16))}else if(t.startsWith("rgba")||t.startsWith("rgb")){var i=t.indexOf("("),s=t.lastIndexOf(")");if(-1===i||-1===s)throw new Ve("No values specified for rgb/rgba function");t=t.substring(i+1,s).split(",");if(3===t.length)return new We(parseInt(t[0]),parseInt(t[1]),parseInt(t[2]));if(4===t.length)return new We(parseInt(t[0]),parseInt(t[1]),parseInt(t[2]),255*parseFloat(t[3]))}return null}throw new Ve("Unsupported format for color")}static toJson(e){return e.raw}}We.BlackRgb="#000000";class ze{constructor(){this.volume=15,this.balance=8,this.port=1,this.program=0,this.primaryChannel=0,this.secondaryChannel=0,this.isMute=!1,this.isSolo=!1}}class y{constructor(e="",t=null,i=!1){this.isStandard=i,this.name=e,this.tunings=null!=t?t:[]}static getTextForTuning(e,t){e=y.getTextPartsForTuning(e);return t?e.join(""):e[0]}static getTextPartsForTuning(e,t=-1){return[["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"][e%12],((e/12|0)+t).toString()]}static getDefaultTuningFor(e){return y._defaultTunings.has(e)?y._defaultTunings.get(e):null}static getPresetsFor(e){switch(e){case 7:return y._sevenStrings;case 6:return y._sixStrings;case 5:return y._fiveStrings;case 4:return y._fourStrings}return[]}static initialize(){y._defaultTunings.set(7,new y("Guitar 7 strings",[64,59,55,50,45,40,35],!0)),y._sevenStrings.push(y._defaultTunings.get(7)),y._defaultTunings.set(6,new y("Guitar Standard Tuning",[64,59,55,50,45,40],!0)),y._sixStrings.push(y._defaultTunings.get(6)),y._sixStrings.push(new y("Guitar Tune down Â½ step",[63,58,54,49,44,39],!1)),y._sixStrings.push(new y("Guitar Tune down 1 step",[62,57,53,48,43,38],!1)),y._sixStrings.push(new y("Guitar Tune down 2 step",[60,55,51,46,41,36],!1)),y._sixStrings.push(new y("Guitar Dropped D Tuning",[64,59,55,50,45,38],!1)),y._sixStrings.push(new y("Guitar Dropped D Tuning variant",[64,57,55,50,45,38],!1)),y._sixStrings.push(new y("Guitar Double Dropped D Tuning",[62,59,55,50,45,38],!1)),y._sixStrings.push(new y("Guitar Dropped E Tuning",[66,61,57,52,47,40],!1)),y._sixStrings.push(new y("Guitar Dropped C Tuning",[62,57,53,48,43,36],!1)),y._sixStrings.push(new y("Guitar Open C Tuning",[64,60,55,48,43,36],!1)),y._sixStrings.push(new y("Guitar Open Cm Tuning",[63,60,55,48,43,36],!1)),y._sixStrings.push(new y("Guitar Open C6 Tuning",[64,57,55,48,43,36],!1)),y._sixStrings.push(new y("Guitar Open Cmaj7 Tuning",[64,59,55,52,43,36],!1)),y._sixStrings.push(new y("Guitar Open D Tuning",[62,57,54,50,45,38],!1)),y._sixStrings.push(new y("Guitar Open Dm Tuning",[62,57,53,50,45,38],!1)),y._sixStrings.push(new y("Guitar Open D5 Tuning",[62,57,50,50,45,38],!1)),y._sixStrings.push(new y("Guitar Open D6 Tuning",[62,59,54,50,45,38],!1)),y._sixStrings.push(new y("Guitar Open Dsus4 Tuning",[62,57,55,50,45,38],!1)),y._sixStrings.push(new y("Guitar Open E Tuning",[64,59,56,52,47,40],!1)),y._sixStrings.push(new y("Guitar Open Em Tuning",[64,59,55,52,47,40],!1)),y._sixStrings.push(new y("Guitar Open Esus11 Tuning",[64,59,55,52,45,40],!1)),y._sixStrings.push(new y("Guitar Open F Tuning",[65,60,53,48,45,41],!1)),y._sixStrings.push(new y("Guitar Open G Tuning",[62,59,55,50,43,38],!1)),y._sixStrings.push(new y("Guitar Open Gm Tuning",[62,58,55,50,43,38],!1)),y._sixStrings.push(new y("Guitar Open G6 Tuning",[64,59,55,50,43,38],!1)),y._sixStrings.push(new y("Guitar Open Gsus4 Tuning",[62,60,55,50,43,38],!1)),y._sixStrings.push(new y("Guitar Open A Tuning",[64,61,57,52,45,40],!1)),y._sixStrings.push(new y("Guitar Open Am Tuning",[64,60,57,52,45,40],!1)),y._sixStrings.push(new y("Guitar Nashville Tuning",[64,59,67,62,57,52],!1)),y._sixStrings.push(new y("Bass 6 Strings Tuning",[48,43,38,33,28,23],!1)),y._sixStrings.push(new y("Lute or Vihuela Tuning",[64,59,54,50,45,40],!1)),y._defaultTunings.set(5,new y("Bass 5 Strings Tuning",[43,38,33,28,23],!0)),y._fiveStrings.push(y._defaultTunings.get(5)),y._fiveStrings.push(new y("Banjo Dropped C Tuning",[62,59,55,48,67],!1)),y._fiveStrings.push(new y("Banjo Open D Tuning",[62,57,54,50,69],!1)),y._fiveStrings.push(new y("Banjo Open G Tuning",[62,59,55,50,67],!1)),y._fiveStrings.push(new y("Banjo G Minor Tuning",[62,58,55,50,67],!1)),y._fiveStrings.push(new y("Banjo G Modal Tuning",[62,57,55,50,67],!1)),y._defaultTunings.set(4,new y("Bass Standard Tuning",[43,38,33,28],!0)),y._fourStrings.push(y._defaultTunings.get(4)),y._fourStrings.push(new y("Bass Tune down Â½ step",[42,37,32,27],!1)),y._fourStrings.push(new y("Bass Tune down 1 step",[41,36,31,26],!1)),y._fourStrings.push(new y("Bass Tune down 2 step",[39,34,29,24],!1)),y._fourStrings.push(new y("Bass Dropped D Tuning",[43,38,33,26],!1)),y._fourStrings.push(new y("Ukulele C Tuning",[45,40,36,43],!1)),y._fourStrings.push(new y("Ukulele G Tuning",[52,47,43,38],!1)),y._fourStrings.push(new y("Mandolin Standard Tuning",[64,57,50,43],!1)),y._fourStrings.push(new y("Mandolin or Violin Tuning",[76,69,62,55],!1)),y._fourStrings.push(new y("Viola Tuning",[69,62,55,48],!1)),y._fourStrings.push(new y("Cello Tuning",[57,50,43,36],!1))}static findTuning(s){var a=y.getPresetsFor(s.length);for(let e=0,t=a.length;e<t;e++){var r=a[e];let i=!0;for(let e=0,t=s.length;e<t;e++)if(s[e]!==r.tunings[e]){i=!1;break}if(i)return r}return null}finish(){var e=y.findTuning(this.tunings);e&&(this.name=e.name,this.isStandard=e.isStandard),this.name=this.name.trim()}}y._sevenStrings=[],y._sixStrings=[],y._fiveStrings=[],y._fourStrings=[],y._defaultTunings=new Map,y.defaultAccidentals=["","#","","#","","","#","","#","","#",""],y.defaultSteps=["C","C","D","D","E","F","F","G","G","A","A","B"],y.initialize();class Ue{constructor(){this.index=0,this.bars=[],this.chords=new Map,this.capo=0,this.transpositionPitch=0,this.displayTranspositionPitch=0,this.stringTuning=new y("",[],!1),this.showTablature=!0,this.showStandardNotation=!0,this.isPercussion=!1,this.standardNotationLineCount=5}get tuning(){return this.stringTuning.tunings}get tuningName(){return this.stringTuning.name}get isStringed(){return 0<this.stringTuning.tunings.length}finish(i,s=null){this.stringTuning.finish();for(let e=0,t=this.bars.length;e<t;e++)this.bars[e].finish(i,s)}addChord(e,t){(t.staff=this).chords.set(e,t)}hasChord(e){return this.chords.has(e)}getChord(e){return this.chords.get(e)}addBar(e){var t=this.bars;e.staff=this,e.index=t.length,0<t.length&&(e.previousBar=t[t.length-1],e.previousBar.nextBar=e),t.push(e)}}class Xe{constructor(){this.index=0,this.staves=[],this.playbackInfo=new ze,this.color=new We(200,0,0,255),this.name="",this.shortName="",this.percussionArticulations=[]}ensureStaveCount(e){for(;this.staves.length<e;)this.addStaff(new Ue)}addStaff(e){e.index=this.staves.length,(e.track=this).staves.push(e)}finish(i,s=null){this.shortName||(this.shortName=this.name,this.shortName.length>Xe.ShortNameMaxLength&&(this.shortName=this.shortName.substr(0,Xe.ShortNameMaxLength)));for(let e=0,t=this.staves.length;e<t;e++)this.staves[e].finish(i,s)}applyLyrics(s){for(var e of s)e.finish();var a=this.staves[0];for(let i=0;i<s.length;i++){var r=s[i];if(0<=r.startBar&&r.startBar<a.bars.length){let t=a.bars[r.startBar].voices[0].beats[0];for(let e=0;e<r.chunks.length&&t;e++){for(;t&&(t.isEmpty||t.isRest);)t=t.nextBeat;t&&(t.lyrics||(t.lyrics=new Array(s.length)),t.lyrics[i]=r.chunks[e],t=t.nextBeat)}}}}}Xe.ShortNameMaxLength=10;class Ye{constructor(){this.id=Ye._globalBarId++,this.index=0,this.beats=[],this.isEmpty=!0}insertBeat(e,t){t.nextBeat=e.nextBeat,t.nextBeat&&(t.nextBeat.previousBeat=t),t.previousBeat=e,t.voice=this,e.nextBeat=t,this.beats.splice(e.index+1,0,t)}addBeat(e){e.voice=this,e.index=this.beats.length,this.beats.push(e),e.isEmpty||(this.isEmpty=!1)}chain(e,t=null){var i;this.bar&&(e.index<this.beats.length-1?(e.nextBeat=this.beats[e.index+1],e.nextBeat.previousBeat=e):e.isLastOfVoice&&e.voice.bar.nextBar&&(0<(i=this.bar.nextBar.voices[this.index]).beats.length&&(e.nextBeat=i.beats[0]),e.nextBeat.previousBeat=e),e.chain(t))}addGraceBeat(e){var t;0===this.beats.length?this.addBeat(e):(t=this.beats[this.beats.length-1],this.beats.splice(this.beats.length-1,1),this.addBeat(e),this.addBeat(t),this.isEmpty=!1)}getBeatAtPlaybackStart(e){return this._beatLookup.has(e)?this._beatLookup.get(e):null}finish(t,i=null){this._beatLookup=new Map;let s=null;for(let e=0;e<this.beats.length;e++){var a=this.beats[e];a.index=e,this.chain(a,i),a.graceType===_.None?((a.graceGroup=s)&&(s.isComplete=!0),s=null):(s=s||new Le).addBeat(a)}let r=0,n=0;for(let e=0;e<this.beats.length;e++){var o=this.beats[e];if(o.index=e,o.finish(t,i),o.graceType===_.None){if(o.graceGroup){var h=o.graceGroup.beats[0],l=o.graceGroup.beats[o.graceGroup.beats.length-1];if(h.graceType!==_.BendGrace){var d=l.playbackStart+l.playbackDuration-h.playbackStart;switch(h.graceType){case _.BeforeBeat:n=h.previousBeat&&(h.previousBeat.playbackDuration-=d,h.previousBeat.voice==this)?h.previousBeat.playbackStart+h.previousBeat.playbackDuration:-d;for(const c of o.graceGroup.beats)this._beatLookup.delete(c.playbackStart),c.playbackStart=n,this._beatLookup.set(c.playbackStart,o),n+=c.playbackDuration;break;case _.OnBeat:o.playbackDuration-=d,n=l.voice===this?l.playbackStart+l.playbackDuration:-d}}}o.displayStart=r,o.playbackStart=n,o.fermata?this.bar.masterBar.addFermata(o.playbackStart,o.fermata):o.fermata=this.bar.masterBar.getFermata(o),this._beatLookup.set(o.playbackStart,o)}else o.displayStart=r,o.playbackStart=n;o.finishTuplet(),o.graceGroup&&o.graceGroup.finish(),r+=o.displayDuration,n+=o.playbackDuration}}calculateDuration(){var e,t;return this.isEmpty||0===this.beats.length?0:(e=this.beats[this.beats.length-1],t=this.beats[0],e.playbackStart+e.playbackDuration-t.playbackStart)}}Ye._globalBarId=0;class F{static float64ToBytes(e){return F._dataView.setFloat64(0,e,!0),this._conversionByteArray}static bytesToFloat64(e){throw F._conversionByteArray.set(e,0),F._dataView.getFloat64(0,!0)}static uint16ToInt16(e){return F._dataView.setUint16(0,e,!0),F._dataView.getInt16(0,!0)}static int16ToUint32(e){return F._dataView.setInt16(0,e,!0),F._dataView.getUint32(0,!0)}static int32ToUint16(e){return F._dataView.setInt32(0,e,!0),F._dataView.getUint16(0,!0)}static int32ToInt16(e){return F._dataView.setInt32(0,e,!0),F._dataView.getInt16(0,!0)}static int32ToUint32(e){return F._dataView.setInt32(0,e,!0),F._dataView.getUint32(0,!0)}static uint8ToInt8(e){return F._dataView.setUint8(0,e),F._dataView.getInt8(0)}}F._conversionBuffer=new ArrayBuffer(8),F._conversionByteArray=new Uint8Array(F._conversionBuffer),F._dataView=new DataView(F._conversionBuffer);class L{static readInt32BE(e){return e.readByte()<<24|e.readByte()<<16|e.readByte()<<8|e.readByte()}static readInt32LE(e){var t=e.readByte(),i=e.readByte(),s=e.readByte();return e.readByte()<<24|s<<16|i<<8|t}static readUInt32LE(e){var t=e.readByte(),i=e.readByte(),s=e.readByte();return e.readByte()<<24|s<<16|i<<8|t}static decodeUInt32LE(e,t){var i=e[t],s=e[t+1],a=e[t+2];return e[t+3]<<24|a<<16|s<<8|i}static readUInt16LE(e){var t=e.readByte(),e=e.readByte();return F.int32ToUint16(e<<8|t)}static readInt16LE(e){var t=e.readByte(),e=e.readByte();return F.int32ToInt16(e<<8|t)}static readUInt32BE(e){var t=e.readByte(),i=e.readByte(),s=e.readByte(),e=e.readByte();return F.int32ToUint32(t<<24|i<<16|s<<8|e)}static readUInt16BE(e){var t=e.readByte(),e=e.readByte();return F.int32ToInt16(t<<8|e)}static readInt16BE(e){var t=e.readByte(),e=e.readByte();return F.int32ToInt16(t<<8|e)}static readByteArray(e,t){var i=new Uint8Array(t);return e.read(i,0,t),i}static read8BitChars(e,t){t=new Uint8Array(t);return e.read(t,0,t.length),L.toString(t,"utf-8")}static read8BitString(e){let t="",i=e.readByte();for(;0!==i;)t+=String.fromCharCode(i),i=e.readByte();return t}static read8BitStringLength(t,i){let s="",a=-1;for(let e=0;e<i;e++){var r=t.readByte();0===r&&-1===a&&(a=e),s+=String.fromCharCode(r)}var e=s;return 0<=a?e.substr(0,a):e}static readSInt8(e){e=e.readByte();return-256*((255&e)>>7)+(255&e)}static readInt24(e,t){let i=e[t]|e[t+1]<<8|e[t+2]<<16;return 8388608==(8388608&i)&&(i|=255<<24),i}static readInt16(e,t){return F.int32ToInt16(e[t]|e[t+1]<<8)}static toString(e,t){var i=L.detectEncoding(e);return t=(t=i?i:t)||"utf-8",new TextDecoder(t).decode(e.buffer)}static detectEncoding(e){return 2<e.length&&254===e[0]&&255===e[1]?"utf-16be":2<e.length&&255===e[0]&&254===e[1]?"utf-16le":4<e.length&&0===e[0]&&0===e[1]&&254===e[2]&&255===e[3]?"utf-32be":4<e.length&&255===e[0]&&254===e[1]&&0===e[2]&&0===e[3]?"utf-32le":null}static stringToBytes(e){return(new TextEncoder).encode(e)}static writeInt32BE(e,t){e.writeByte(t>>24&255),e.writeByte(t>>16&255),e.writeByte(t>>8&255),e.writeByte(t>>0&255)}static writeInt32LE(e,t){e.writeByte(t>>0&255),e.writeByte(t>>8&255),e.writeByte(t>>16&255),e.writeByte(t>>24&255)}static writeUInt16LE(e,t){e.writeByte(t>>0&255),e.writeByte(t>>8&255)}static writeInt16LE(e,t){e.writeByte(t>>0&255),e.writeByte(t>>8&255)}}class qe{constructor(){this.length=0,this.position=0}get bytesWritten(){return this.position}getBuffer(){return this._buffer}static empty(){return qe.withCapacity(0)}static withCapacity(e){var t=new qe;return t._buffer=new Uint8Array(e),t}static fromBuffer(e){var t=new qe;return t._buffer=e,t.length=e.length,t}static fromString(e){e=L.stringToBytes(e);return qe.fromBuffer(e)}reset(){this.position=0}skip(e){this.position+=e}readByte(){return this.length-this.position<=0?-1:this._buffer[this.position++]}read(e,t,i){let s=this.length-this.position;return(s=s>i?i:s)<=0?0:(e.set(this._buffer.subarray(this.position,this.position+s),t),this.position+=s,s)}writeByte(e){var t=this.position+1;this.ensureCapacity(t),this._buffer[this.position]=255&e,t>this.length&&(this.length=t),this.position=t}write(e,t,i){var s=this.position+i,i=(this.ensureCapacity(s),Math.min(i,e.length-t));this._buffer.set(e.subarray(t,t+i),this.position),s>this.length&&(this.length=s),this.position=s}ensureCapacity(t){if(t>this._buffer.length){let e=t;(e=e<256?256:e)<2*this._buffer.length&&(e=2*this._buffer.length);t=new Uint8Array(e);0<this.length&&t.set(this._buffer.subarray(0,0+this.length),0),this._buffer=t}}readAll(){return this.toArray()}toArray(){var e=new Uint8Array(this.length);return e.set(this._buffer.subarray(0,0+this.length),0),e}}(e=d=d||{})[e.No=0]="No",e[e.Eof=1]="Eof",e[e.Number=2]="Number",e[e.DoubleDot=3]="DoubleDot",e[e.Dot=4]="Dot",e[e.String=5]="String",e[e.Tuning=6]="Tuning",e[e.LParensis=7]="LParensis",e[e.RParensis=8]="RParensis",e[e.LBrace=9]="LBrace",e[e.RBrace=10]="RBrace",e[e.Pipe=11]="Pipe",e[e.MetaCommand=12]="MetaCommand",e[e.Multiply=13]="Multiply",e[e.LowerThan=14]="LowerThan",e[e.Property=15]="Property";class Je extends me{constructor(e){super(T.AlphaTabErrorType.AlphaTex,e),this.position=0,this.nonTerm="",this.expected=d.No,this.symbol=d.No,this.symbolData=null,Object.setPrototypeOf(this,Je.prototype)}static symbolError(e,t,i,s,a=null){let r;r=i!==s?`MalFormed AlphaTex: @${e}: Error on block ${t}, expected a ${d[i]} found a ${d[s]}: '${a}'`:`MalFormed AlphaTex: @${e}: Error on block ${t}, invalid value: '${a}'`;var n=new Je(r);return n.position=e,n.nonTerm=t,n.expected=i,n.symbol=s,n.symbolData=a,n}static errorMessage(e,t){t=`MalFormed AlphaTex: @${e}: `+t;t=new Je(t);return t.position=e,t}}class je extends ge{constructor(){super(),this._trackChannel=0,this._input="",this._ch=0,this._curChPos=0,this._sy=d.No,this._syData="",this._allowNegatives=!1,this._allowTuning=!1,this._currentDuration=x.QuadrupleWhole,this._currentDynamics=l.PPP,this._currentTuplet=0,this._staffHasExplicitTuning=!1,this._staffTuningApplied=!1,this.logErrors=!1}get name(){return"AlphaTex"}initFromString(e,t){this.data=qe.empty(),this._input=e,this.settings=t}readScore(){try{if(0<this.data.length&&(this._input=L.toString(this.data.readAll(),this.settings.importer.encoding)),this._allowTuning=!0,this._lyrics=new Map,this.createDefaultScore(),this._curChPos=0,this._currentDuration=x.Quarter,this._currentDynamics=l.F,this._currentTuplet=1,this._ch=this.nextChar(),this._sy=this.newSy(),this._sy===d.LowerThan)throw new fe("Unknown start sign <");this.score(),this.consolidate(),this._score.finish(this.settings),this._score.rebuildRepeatGroups();for(var[e,t]of this._lyrics)this._score.tracks[e].applyLyrics(t);return this._score}catch(e){throw e instanceof Je?new fe(e.message):e}}consolidate(){for(var e of this._score.tracks)for(var t of e.staves)for(;t.bars.length<this._score.masterBars.length;){var i=this.newBar(t),s=new Me;s.isEmpty=!0,i.voices[0].addBeat(s)}}error(e,t,i=!0){let s;throw s=i?Je.symbolError(this._curChPos,e,t,this._sy,this._syData):Je.symbolError(this._curChPos,e,t,t,this._syData),this.logErrors&&C.error(this.name,s.message),s}errorMessage(e){e=Je.errorMessage(this._curChPos,e);throw this.logErrors&&C.error(this.name,e.message),e}createDefaultScore(){this._score=new Ge,this._score.tempo=120,this._score.tempoLabel="",this.newTrack()}newTrack(){this._currentTrack=new Xe,this._currentTrack.ensureStaveCount(1),this._currentTrack.playbackInfo.program=25,this._currentTrack.playbackInfo.primaryChannel=this._trackChannel++,this._currentTrack.playbackInfo.secondaryChannel=this._trackChannel++,this._currentStaff=this._currentTrack.staves[0],this._currentStaff.displayTranspositionPitch=-12,this._currentStaff.stringTuning.tunings=y.getDefaultTuningFor(6).tunings,this._score.addTrack(this._currentTrack),this._lyrics.set(this._currentTrack.index,[]),this._currentDynamics=l.F}parseClefFromString(e){switch(e.toLowerCase()){case"g2":case"treble":return c.G2;case"f4":case"bass":return c.F4;case"c3":case"tenor":return c.C3;case"c4":case"alto":return c.C4;case"n":case"neutral":return c.Neutral;default:return c.G2}}parseClefFromInt(e){switch(e){case 43:return c.G2;case 65:return c.F4;case 48:return c.C3;case 60:return c.C4;default:return c.G2}}parseTripletFeelFromString(e){switch(e.toLowerCase()){case"no":case"none":return u.NoTripletFeel;case"t16":case"triplet-16th":return u.Triplet16th;case"t8":case"triplet-8th":return u.Triplet8th;case"d16":case"dotted-16th":return u.Dotted16th;case"d8":case"dotted-8th":return u.Dotted8th;case"s16":case"scottish-16th":return u.Scottish16th;case"s8":case"scottish-8th":return u.Scottish8th;default:return u.NoTripletFeel}}parseTripletFeelFromInt(e){switch(e){case 0:return u.NoTripletFeel;case 1:return u.Triplet16th;case 2:return u.Triplet8th;case 3:return u.Dotted16th;case 4:return u.Dotted8th;case 5:return u.Scottish16th;case 6:return u.Scottish8th;default:return u.NoTripletFeel}}parseKeySignature(e){switch(e.toLowerCase()){case"cb":case"cbmajor":return n.Cb;case"gb":case"gbmajor":case"d#minor":return n.Gb;case"db":case"dbmajor":case"bbminor":return n.Db;case"ab":case"abmajor":case"fminor":return n.Ab;case"eb":case"ebmajor":case"cminor":return n.Eb;case"bb":case"bbmajor":case"gminor":return n.Bb;case"f":case"fmajor":case"dminor":return n.F;case"c":case"cmajor":case"aminor":return n.C;case"g":case"gmajor":case"eminor":return n.G;case"d":case"dmajor":case"bminor":return n.D;case"a":case"amajor":case"f#minor":return n.A;case"e":case"emajor":case"c#minor":return n.E;case"b":case"bmajor":case"g#minor":return n.B;case"f#":case"f#major":case"ebminor":return n.FSharp;case"c#":case"c#major":return n.CSharp;default:return n.C}}nextChar(){return this._curChPos<this._input.length?this._ch=this._input.charCodeAt(this._curChPos++):this._ch=0,this._ch}newSy(){this._sy=d.No;do{if(this._ch===je.Eof)this._sy=d.Eof;else if(32===this._ch||11===this._ch||13===this._ch||10===this._ch||9===this._ch)this._ch=this.nextChar();else if(47===this._ch)if(this._ch=this.nextChar(),47===this._ch)for(;13!==this._ch&&10!==this._ch&&this._ch!==je.Eof;)this._ch=this.nextChar();else if(42===this._ch)for(;this._ch!==je.Eof;)if(42===this._ch){if(this._ch=this.nextChar(),47===this._ch){this._ch=this.nextChar();break}}else this._ch=this.nextChar();else this.error("symbol",d.String,!1);else if(34===this._ch||39===this._ch){var t=this._ch;this._ch=this.nextChar();let e="";for(this._sy=d.String;this._ch!==t&&this._ch!==je.Eof;)e+=String.fromCharCode(this._ch),this._ch=this.nextChar();this._syData=e,this._ch=this.nextChar()}else{var e,i;45===this._ch?this._allowNegatives&&this.isDigit(this._ch)?(this._sy=d.Number,this._syData=this.readNumber()):(this._sy=d.String,this._syData=this.readName()):46===this._ch?(this._sy=d.Dot,this._ch=this.nextChar()):58===this._ch?(this._sy=d.DoubleDot,this._ch=this.nextChar()):40===this._ch?(this._sy=d.LParensis,this._ch=this.nextChar()):92===this._ch?(this._ch=this.nextChar(),this._sy=d.MetaCommand,this._syData=this.readName()):41===this._ch?(this._sy=d.RParensis,this._ch=this.nextChar()):123===this._ch?(this._sy=d.LBrace,this._ch=this.nextChar()):125===this._ch?(this._sy=d.RBrace,this._ch=this.nextChar()):124===this._ch?(this._sy=d.Pipe,this._ch=this.nextChar()):42===this._ch?(this._sy=d.Multiply,this._ch=this.nextChar()):60===this._ch?(this._sy=d.LowerThan,this._ch=this.nextChar()):this.isDigit(this._ch)?(this._sy=d.Number,this._syData=this.readNumber()):je.isLetter(this._ch)?(e=this.readName(),(i=this._allowTuning?Be.parseTuning(e):null)?(this._sy=d.Tuning,this._syData=i):(this._sy=d.String,this._syData=e)):this.error("symbol",d.String,!1)}}while(this._sy===d.No);return this._sy}static isLetter(e){return!je.isTerminal(e)&&(33<=e&&e<=47||58<=e&&e<=126||128<e)}static isTerminal(e){return 46===e||123===e||125===e||91===e||93===e||40===e||41===e||124===e||39===e||34===e||92===e}isDigit(e){return 48<=e&&e<=57||45===e&&this._allowNegatives}readName(){let e="";for(;e+=String.fromCharCode(this._ch),this._ch=this.nextChar(),je.isLetter(this._ch)||this.isDigit(this._ch)||35===this._ch;);return e}readNumber(){let e="";for(;e+=String.fromCharCode(this._ch),this._ch=this.nextChar(),this.isDigit(this._ch););return parseInt(e)}score(){if(this._sy===d.Eof)throw new fe("Unexpected end of file");var e=this.metaData(),t=this.bars();if(!e&&!t)throw new fe("No alphaTex data found")}metaData(){let e=!1,t=!0;for(;this._sy===d.MetaCommand&&t;)switch(this._syData.toLowerCase()){case"title":this._sy=this.newSy(),this._sy===d.String?this._score.title=this._syData:this.error("title",d.String,!0),this._sy=this.newSy(),e=!0;break;case"subtitle":this._sy=this.newSy(),this._sy===d.String?this._score.subTitle=this._syData:this.error("subtitle",d.String,!0),this._sy=this.newSy(),e=!0;break;case"artist":this._sy=this.newSy(),this._sy===d.String?this._score.artist=this._syData:this.error("artist",d.String,!0),this._sy=this.newSy(),e=!0;break;case"album":this._sy=this.newSy(),this._sy===d.String?this._score.album=this._syData:this.error("album",d.String,!0),this._sy=this.newSy(),e=!0;break;case"words":this._sy=this.newSy(),this._sy===d.String?this._score.words=this._syData:this.error("words",d.String,!0),this._sy=this.newSy(),e=!0;break;case"music":this._sy=this.newSy(),this._sy===d.String?this._score.music=this._syData:this.error("music",d.String,!0),this._sy=this.newSy(),e=!0;break;case"copyright":this._sy=this.newSy(),this._sy===d.String?this._score.copyright=this._syData:this.error("copyright",d.String,!0),this._sy=this.newSy(),e=!0;break;case"tempo":this._sy=this.newSy(),this._sy===d.Number?this._score.tempo=this._syData:this.error("tempo",d.Number,!0),this._sy=this.newSy(),e=!0;break;default:this.handleStaffMeta()?e=!0:e?this.error("metaDataTags",d.String,!1):t=!1}return e?(this._sy!==d.Dot&&this.error("song",d.Dot,!0),this._sy=this.newSy()):this._sy===d.Dot&&(this._sy=this.newSy()),e}handleStaffMeta(){switch(this._syData.toLowerCase()){case"capo":return this._sy=this.newSy(),this._sy===d.Number?this._currentStaff.capo=this._syData:this.error("capo",d.Number,!0),this._sy=this.newSy(),!0;case"tuning":this._sy=this.newSy();var e=this._currentStaff.tuning.length;switch(this._staffHasExplicitTuning=!0,this._staffTuningApplied=!1,this._sy){case d.String:var t=this._syData.toLowerCase();"piano"===t||"none"===t||"voice"===t?(this._currentStaff.stringTuning.tunings=[],this._currentStaff.displayTranspositionPitch=0):this.error("tuning",d.Tuning,!0),this._sy=this.newSy();break;case d.Tuning:var i=[];do{var s=this._syData;i.push(s.realValue),this._sy=this.newSy()}while(this._sy===d.Tuning);this._currentStaff.stringTuning.tunings=i;break;default:this.error("tuning",d.Tuning,!0)}return e!==this._currentStaff.tuning.length&&0<this._currentStaff.chords.size&&this.errorMessage("Tuning must be defined before any chord"),!0;case"instrument":return this._sy=this.newSy(),this._staffTuningApplied=!1,this._sy===d.Number?0<=(e=this._syData)&&e<=128?this._currentTrack.playbackInfo.program=this._syData:this.error("instrument",d.Number,!1):this._sy===d.String?(e=this._syData.toLowerCase(),this._currentTrack.playbackInfo.program=pe.getValue(e)):this.error("instrument",d.Number,!0),this._sy=this.newSy(),!0;case"lyrics":this._sy=this.newSy();e=new Ie;return e.startBar=0,e.text="",this._sy===d.Number&&(e.startBar=this._syData,this._sy=this.newSy()),this._sy===d.String?(e.text=this._syData,this._sy=this.newSy()):this.error("lyrics",d.String,!0),this._lyrics.get(this._currentTrack.index).push(e),!0;case"chord":this._sy=this.newSy();var a=new De;this.chordProperties(a),this._sy===d.String?(a.name=this._syData,this._sy=this.newSy()):this.error("chord-name",d.Number,!0);for(let e=0;e<this._currentStaff.tuning.length;e++)this._sy===d.Number?a.strings.push(this._syData):this._sy===d.String&&"x"===this._syData.toLowerCase()&&a.strings.push(-1),this._sy=this.newSy();return this._currentStaff.addChord(this.getChordId(this._currentStaff,a.name),a),!0;default:return!1}}chordProperties(e){if(this._sy===d.LBrace){for(this._sy=this.newSy();this._sy===d.String;)switch(this._syData.toLowerCase()){case"firstfret":this._sy=this.newSy(),this._sy===d.Number?e.firstFret=this._syData:this.error("chord-firstfret",d.Number,!0),this._sy=this.newSy();break;case"showdiagram":switch(this._sy=this.newSy(),this._sy){case d.String:e.showDiagram="false"!==this._syData.toLowerCase();break;case d.Number:e.showDiagram=0!==this._syData;break;default:this.error("chord-showdiagram",d.String,!0)}this._sy=this.newSy();break;case"showfingering":switch(this._sy=this.newSy(),this._sy){case d.String:e.showDiagram="false"!==this._syData.toLowerCase();break;case d.Number:e.showFingering=0!==this._syData;break;default:this.error("chord-showfingering",d.String,!0)}this._sy=this.newSy();break;case"showname":switch(this._sy=this.newSy(),this._sy){case d.String:e.showName="false"!==this._syData.toLowerCase();break;case d.Number:e.showName=0!==this._syData;break;default:this.error("chord-showname",d.String,!0)}this._sy=this.newSy();break;case"barre":for(this._sy=this.newSy();this._sy===d.Number;)e.barreFrets.push(this._syData),this._sy=this.newSy();break;default:this.error("chord-properties",d.String,!1)}this._sy!==d.RBrace&&this.error("chord-properties",d.RBrace,!0),this._sy=this.newSy()}}bars(){for(var e=this.bar();this._sy!==d.Eof;){if(this._sy===d.Pipe)this._sy=this.newSy();else if(this._sy!==d.MetaCommand)break;this.bar()}return e}trackStaffMeta(){let e=!1;return this._sy===d.MetaCommand&&(e=!0,"track"===this._syData.toLowerCase()&&(this._staffHasExplicitTuning=!1,this._staffTuningApplied=!1,this._sy=this.newSy(),0<this._score.masterBars.length&&this.newTrack(),this._sy===d.String&&(this._currentTrack.name=this._syData,this._sy=this.newSy()),this._sy===d.String)&&(this._currentTrack.shortName=this._syData,this._sy=this.newSy()),this._sy===d.MetaCommand)&&"staff"===this._syData.toLowerCase()&&(this._staffHasExplicitTuning=!1,this._staffTuningApplied=!1,this._sy=this.newSy(),0<this._currentTrack.staves[0].bars.length&&(this._currentTrack.ensureStaveCount(this._currentTrack.staves.length+1),this._currentStaff=this._currentTrack.staves[this._currentTrack.staves.length-1],this._currentDynamics=l.F),this.staffProperties()),e}staffProperties(){if(this._sy===d.LBrace){this._sy=this.newSy();let e=!1,t=!1;for(;this._sy===d.String;)switch(this._syData.toLowerCase()){case"score":e=!0,this._sy=this.newSy();break;case"tabs":t=!0,this._sy=this.newSy();break;default:this.error("staff-properties",d.String,!1)}(e||t)&&(this._currentStaff.showStandardNotation=e,this._currentStaff.showTablature=t),this._sy!==d.RBrace&&this.error("staff-properties",d.RBrace,!0),this._sy=this.newSy()}}bar(){var e=this.trackStaffMeta(),t=this.newBar(this._currentStaff),i=(this._currentStaff.bars.length>this._score.masterBars.length&&(i=new Re,this._score.addMasterBar(i),0<i.index)&&(i.keySignature=i.previousMasterBar.keySignature,i.keySignatureType=i.previousMasterBar.keySignatureType,i.timeSignatureDenominator=i.previousMasterBar.timeSignatureDenominator,i.timeSignatureNumerator=i.previousMasterBar.timeSignatureNumerator,i.tripletFeel=i.previousMasterBar.tripletFeel),this.barMeta(t));this._staffTuningApplied||this._staffHasExplicitTuning||(a=this._currentTrack.playbackInfo.program,this._currentStaff.displayTranspositionPitch=0,this._currentStaff.stringTuning.tunings=[],15==a||24<=a&&a<=31?(this._currentStaff.displayTranspositionPitch=-12,this._currentStaff.stringTuning.tunings=y.getDefaultTuningFor(6).tunings):32<=a&&a<=39?(this._currentStaff.displayTranspositionPitch=-12,this._currentStaff.stringTuning.tunings=[43,38,33,28]):40==a||44==a||45==a||48==a||49==a||50==a||51==a?this._currentStaff.stringTuning.tunings=[52,57,50,43]:41==a?this._currentStaff.stringTuning.tunings=[57,50,43,36]:42==a?this._currentStaff.stringTuning.tunings=[45,38,31,24]:43==a?(this._currentStaff.displayTranspositionPitch=-12,this._currentStaff.stringTuning.tunings=[43,38,33,28]):105==a?this._currentStaff.stringTuning.tunings=[50,47,43,38,55]:106==a?this._currentStaff.stringTuning.tunings=[57,52,45]:107==a?this._currentStaff.stringTuning.tunings=[52,45,38,31]:110==a&&(this._currentStaff.stringTuning.tunings=[64,57,50,43]),this._staffTuningApplied=!0);let s=!1;for(var a,r=t.voices[0];this._sy!==d.Pipe&&this._sy!==d.Eof&&this.beat(r);)s=!0;return 0===r.beats.length&&((a=new Me).isEmpty=!0,r.addBeat(a)),e||i||s}newBar(e){var t=new be,e=(e.addBar(t),0<t.index&&(t.clef=t.previousBar.clef),new Ye);return t.addVoice(e),t}beat(t){this.beatDuration();var i=new Me;if(t.addBeat(i),this._sy===d.LParensis){for(this._sy=this.newSy(),this.note(i);this._sy!==d.RParensis&&this._sy!==d.Eof&&this.note(i););this._sy!==d.RParensis&&this.error("note-list",d.RParensis,!0),this._sy=this.newSy()}else if(this._sy===d.String&&"r"===this._syData.toLowerCase())this._sy=this.newSy();else if(!this.note(i))return t.beats.splice(t.beats.length-1,1),!1;this._sy===d.Dot&&(this._allowNegatives=!0,this._sy=this.newSy(),this._allowNegatives=!1,this._sy!==d.Number&&this.error("duration",d.Number,!0),this._currentDuration=this.parseDuration(this._syData),this._sy=this.newSy()),i.duration=this._currentDuration,i.dynamics=this._currentDynamics,1===this._currentTuplet||i.hasTuplet||this.applyTuplet(i,this._currentTuplet);let s=1;this._sy===d.Multiply&&(this._sy=this.newSy(),this._sy!==d.Number?this.error("multiplier",d.Number,!0):s=this._syData,this._sy=this.newSy()),this.beatEffects(i);for(let e=0;e<s-1;e++)t.addBeat(Fe.clone(i));return!0}beatDuration(){if(this._sy===d.DoubleDot&&(this._allowNegatives=!0,this._sy=this.newSy(),this._allowNegatives=!1,this._sy!==d.Number&&this.error("duration",d.Number,!0),this._currentDuration=this.parseDuration(this._syData),this._currentTuplet=1,this._sy=this.newSy(),this._sy===d.LBrace)){for(this._sy=this.newSy();this._sy===d.String;)"tu"===this._syData.toLowerCase()?(this._sy=this.newSy(),this._sy!==d.Number&&this.error("duration-tuplet",d.Number,!0),this._currentTuplet=this._syData,this._sy=this.newSy()):this.error("beat-duration",d.String,!1);this._sy!==d.RBrace&&this.error("beat-duration",d.RBrace,!0),this._sy=this.newSy()}}beatEffects(e){if(this._sy===d.LBrace){for(this._sy=this.newSy();this._sy===d.String;)this._syData=this._syData.toLowerCase(),this.applyBeatEffect(e)||this.error("beat-effects",d.String,!1);this._sy!==d.RBrace&&this.error("beat-effects",d.RBrace,!0),this._sy=this.newSy()}}applyBeatEffect(i){var e,t,s,a=this._syData.toLowerCase();if("f"===a)return i.fadeIn=!0,this._sy=this.newSy(),!0;if("v"===a)return i.vibrato=J.Slight,this._sy=this.newSy(),!0;if("s"===a)return i.slap=!0,this._sy=this.newSy(),!0;if("p"===a)return i.pop=!0,this._sy=this.newSy(),!0;if("tt"===a)return i.tap=!0,this._sy=this.newSy(),!0;if("dd"===a)return i.dots=2,this._sy=this.newSy(),!0;if("d"===a)return i.dots=1,this._sy=this.newSy(),!0;if("su"===a)return i.pickStroke=j.Up,this._sy=this.newSy(),!0;if("sd"===a)return i.pickStroke=j.Down,this._sy=this.newSy(),!0;if("tu"===a)return this._sy=this.newSy(),this._sy!==d.Number?(this.error("tuplet",d.Number,!0),!1):(this.applyTuplet(i,this._syData),this._sy=this.newSy(),!0);if("tb"===a||"tbe"===a){var r="tbe"===a;if(this._sy=this.newSy(),this._sy!==d.LParensis)return this.error("tremolobar-effect",d.LParensis,!0),!1;for(this._allowNegatives=!0,this._sy=this.newSy();this._sy!==d.RParensis&&this._sy!==d.Eof;){let e=0,t=0;if(r){if(this._sy!==d.Number)return this.error("tremolobar-effect",d.Number,!0),!1;if(e=this._syData,this._sy=this.newSy(),this._sy!==d.Number)return this.error("tremolobar-effect",d.Number,!0),!1}else{if(this._sy!==d.Number)return this.error("tremolobar-effect",d.Number,!0),!1;e=0}t=this._syData,i.addWhammyBarPoint(new B(e,t)),this._sy=this.newSy()}for(;60<i.whammyBarPoints.length;)i.removeWhammyBarPoint(i.whammyBarPoints.length-1);if(r)i.whammyBarPoints.sort((e,t)=>e.offset-t.offset);else{var n=i.whammyBarPoints.length,o=60/n|0;let e=0;for(;e<n;)i.whammyBarPoints[e].offset=Math.min(60,e*o),e++}return(this._allowNegatives=!1,this._sy!==d.RParensis)?(this.error("tremolobar-effect",d.RParensis,!0),!1):(this._sy=this.newSy(),!0)}if("bu"===a||"bd"===a||"au"===a||"ad"===a){switch(a){case"bu":i.brushType=U.BrushUp;break;case"bd":i.brushType=U.BrushDown;break;case"au":i.brushType=U.ArpeggioUp;break;case"ad":i.brushType=U.ArpeggioDown}return this._sy=this.newSy(),this._sy===d.Number?(i.brushDuration=this._syData,this._sy=this.newSy()):(i.updateDurations(),"bu"===a||"bd"===a?i.brushDuration=i.playbackDuration/4/i.notes.length:"au"!==a&&"ad"!==a||(i.brushDuration=i.playbackDuration/i.notes.length)),!0}if("ch"===a)return this._sy=this.newSy(),e=this._syData,t=this.getChordId(this._currentStaff,e),this._currentStaff.hasChord(t)||((s=new De).showDiagram=!1,s.name=e,this._currentStaff.addChord(t,s)),i.chordId=t,this._sy=this.newSy(),!0;if("gr"===a)return this._sy=this.newSy(),"ob"===this._syData.toLowerCase()?(i.graceType=_.OnBeat,this._sy=this.newSy()):"b"===this._syData.toLowerCase()?(i.graceType=_.BendGrace,this._sy=this.newSy()):i.graceType=_.BeforeBeat,!0;if("dy"===a){switch(this.newSy(),this._syData.toLowerCase()){case"ppp":i.dynamics=l.PPP;break;case"pp":i.dynamics=l.PP;break;case"p":i.dynamics=l.P;break;case"mp":i.dynamics=l.MP;break;case"mf":i.dynamics=l.MF;break;case"f":i.dynamics=l.F;break;case"ff":i.dynamics=l.FF;break;case"fff":i.dynamics=l.FFF}return this._currentDynamics=i.dynamics,this.newSy(),!0}if("cre"===a)return i.crescendo=X.Crescendo,this.newSy(),!0;if("dec"===a)return i.crescendo=X.Decrescendo,this.newSy(),!0;if("tp"!==a)return!1;{this._sy=this.newSy();let e=x.Eighth;if(this._sy===d.Number){switch(this._syData){case 8:e=x.Eighth;break;case 16:e=x.Sixteenth;break;case 32:e=x.ThirtySecond;break;default:e=x.Eighth}this._sy=this.newSy()}return i.tremoloSpeed=e,!0}}getChordId(e,t){return t.toLowerCase()+e.index+e.track.index}applyTuplet(e,t){switch(t){case 3:e.tupletNumerator=3,e.tupletDenominator=2;break;case 5:e.tupletNumerator=5,e.tupletDenominator=4;break;case 6:e.tupletNumerator=6,e.tupletDenominator=4;break;case 7:e.tupletNumerator=7,e.tupletDenominator=4;break;case 9:e.tupletNumerator=9,e.tupletDenominator=8;break;case 10:e.tupletNumerator=10,e.tupletDenominator=8;break;case 11:e.tupletNumerator=11,e.tupletDenominator=8;break;case 12:e.tupletNumerator=12,e.tupletDenominator=8;break;default:e.tupletNumerator=1,e.tupletDenominator=1}}isNoteText(e){return"x"===e||"-"===e||"r"===e}note(e){let t=!1,i=!1,s=-1,a=-1,r=-1;switch(this._sy){case d.Number:s=this._syData;break;case d.String:t="x"===this._syData,(i="-"===this._syData)||t?s=0:this.error("note-fret",d.Number,!0);break;case d.Tuning:var n=this._syData;a=n.octave,r=n.noteValue;break;default:return!1}this._sy=this.newSy();var o=-1===a&&0<this._currentStaff.tuning.length;let h=-1;o&&(this._sy!==d.Dot&&this.error("note",d.Dot,!0),this._sy=this.newSy(),this._sy!==d.Number&&this.error("note-string",d.Number,!0),((h=this._syData)<1||h>this._currentStaff.tuning.length)&&this.error("note-string",d.Number,!1),this._sy=this.newSy());var l=new Ne;return o?(l.string=this._currentStaff.tuning.length-(h-1),l.isDead=t,(l.isTieDestination=i)||(l.fret=s)):(l.octave=a,l.tone=r,l.isTieDestination=i),e.addNote(l),this.noteEffects(l),!0}noteEffects(i){if(this._sy===d.LBrace){for(this._sy=this.newSy();this._sy===d.String;){var e=this._syData.toLowerCase();if("b"===(this._syData=e)||"be"===e){var s="be"===this._syData;for(this._sy=this.newSy(),this._sy!==d.LParensis&&this.error("bend-effect",d.LParensis,!0),this._sy=this.newSy();this._sy!==d.RParensis&&this._sy!==d.Eof;){let e=0,t=0;t=(s&&(this._sy!==d.Number&&this.error("bend-effect-value",d.Number,!0),e=this._syData,this._sy=this.newSy()),this._sy!==d.Number&&this.error("bend-effect-value",d.Number,!0),this._syData),i.addBendPoint(new B(e,t)),this._sy=this.newSy()}for(var t=i.bendPoints;60<t.length;)t.splice(t.length-1,1);if(s)t.sort((e,t)=>e.offset-t.offset);else{var a=t.length,r=60/(a-1)|0;let e=0;for(;e<a;)t[e].offset=Math.min(60,e*r),e++}this._sy!==d.RParensis&&this.error("bend-effect",d.RParensis,!0),this._sy=this.newSy()}else if("nh"===e)i.harmonicType=g.Natural,this._sy=this.newSy();else if("ah"===e)i.harmonicType=g.Artificial,this._sy=this.newSy();else if("th"===e)i.harmonicType=g.Tap,this._sy=this.newSy();else if("ph"===e)i.harmonicType=g.Pinch,this._sy=this.newSy();else if("sh"===e)i.harmonicType=g.Semi,this._sy=this.newSy();else if("tr"===e){this._sy=this.newSy(),this._sy!==d.Number&&this.error("trill-effect",d.Number,!0);var n=this._syData;this._sy=this.newSy();let e=x.Sixteenth;if(this._sy===d.Number){switch(this._syData){case 16:e=x.Sixteenth;break;case 32:e=x.ThirtySecond;break;case 64:e=x.SixtyFourth;break;default:e=x.Sixteenth}this._sy=this.newSy()}i.trillValue=n+i.stringTuning,i.trillSpeed=e}else if("v"===e)this._sy=this.newSy(),i.vibrato=J.Slight;else if("sl"===e)this._sy=this.newSy(),i.slideOutType=m.Legato;else if("ss"===e)this._sy=this.newSy(),i.slideOutType=m.Shift;else if("sib"===e)this._sy=this.newSy(),i.slideInType=q.IntoFromBelow;else if("sia"===e)this._sy=this.newSy(),i.slideInType=q.IntoFromAbove;else if("sou"===e)this._sy=this.newSy(),i.slideOutType=m.OutUp;else if("sod"===e)this._sy=this.newSy(),i.slideOutType=m.OutDown;else if("psd"===e)this._sy=this.newSy(),i.slideOutType=m.PickSlideDown;else if("psu"===e)this._sy=this.newSy(),i.slideOutType=m.PickSlideUp;else if("h"===e)this._sy=this.newSy(),i.isHammerPullOrigin=!0;else if("lht"===e)this._sy=this.newSy(),i.isLeftHandTapped=!0;else if("g"===e)this._sy=this.newSy(),i.isGhost=!0;else if("ac"===e)this._sy=this.newSy(),i.accentuated=H.Normal;else if("hac"===e)this._sy=this.newSy(),i.accentuated=H.Heavy;else if("pm"===e)this._sy=this.newSy(),i.isPalmMute=!0;else if("st"===e)this._sy=this.newSy(),i.isStaccato=!0;else if("lr"===e)this._sy=this.newSy(),i.isLetRing=!0;else if("x"===e)this._sy=this.newSy(),i.fret=0,i.isDead=!0;else if("-"===e||"t"===e)this._sy=this.newSy(),i.isTieDestination=!0;else if("lf"===e){this._sy=this.newSy();let e=v.Thumb;this._sy===d.Number&&(e=this.toFinger(this._syData),this._sy=this.newSy()),i.leftHandFinger=e}else if("rf"===e){this._sy=this.newSy();let e=v.Thumb;this._sy===d.Number&&(e=this.toFinger(this._syData),this._sy=this.newSy()),i.rightHandFinger=e}else this.applyBeatEffect(i.beat)||this.error(e,d.String,!1)}this._sy!==d.RBrace&&this.error("note-effect",d.RBrace,!1),this._sy=this.newSy()}}toFinger(e){switch(e){case 1:return v.Thumb;case 2:return v.IndexFinger;case 3:return v.MiddleFinger;case 4:return v.AnnularFinger;case 5:return v.LittleFinger}return v.Thumb}parseDuration(e){switch(e){case-4:return x.QuadrupleWhole;case-2:return x.DoubleWhole;case 1:return x.Whole;case 2:return x.Half;case 4:return x.Quarter;case 8:return x.Eighth;case 16:return x.Sixteenth;case 32:return x.ThirtySecond;case 64:return x.SixtyFourth;case 128:return x.OneHundredTwentyEighth;case 256:return x.TwoHundredFiftySixth;default:return x.Quarter}}barMeta(e){let t=!1;for(var i,s=e.masterBar;this._sy===d.MetaCommand;){t=!0;var a=this._syData.toLowerCase();if("ts"===a)this._sy=this.newSy(),this._sy!==d.Number&&this.error("timesignature-numerator",d.Number,!0),s.timeSignatureNumerator=this._syData,this._sy=this.newSy(),this._sy!==d.Number&&this.error("timesignature-denominator",d.Number,!0),s.timeSignatureDenominator=this._syData,this._sy=this.newSy();else if("ro"===a)s.isRepeatStart=!0,this._sy=this.newSy();else if("rc"===a)this._sy=this.newSy(),this._sy!==d.Number&&this.error("repeatclose",d.Number,!0),2048<this._syData&&this.error("repeatclose",d.Number,!1),s.repeatCount=this._syData,this._sy=this.newSy();else if("ae"===a)if(this._sy=this.newSy(),this._sy===d.LParensis){for(this._sy=this.newSy(),this._sy!==d.Number&&this.error("alternateending",d.Number,!0),this.applyAlternateEnding(s);this._sy===d.Number;)this.applyAlternateEnding(s);this._sy!==d.RParensis&&this.error("alternateending-list",d.RParensis,!0),this._sy=this.newSy()}else this._sy!==d.Number&&this.error("alternateending",d.Number,!0),this.applyAlternateEnding(s);else if("ks"===a)this._sy=this.newSy(),this._sy!==d.String&&this.error("keysignature",d.String,!0),s.keySignature=this.parseKeySignature(this._syData),this._sy=this.newSy();else if("clef"===a){switch(this._sy=this.newSy(),this._sy){case d.String:e.clef=this.parseClefFromString(this._syData);break;case d.Number:e.clef=this.parseClefFromInt(this._syData);break;case d.Tuning:var r=this._syData;e.clef=this.parseClefFromInt(r.realValue);break;default:this.error("clef",d.String,!0)}this._sy=this.newSy()}else if("tempo"===a){this._sy=this.newSy(),this._sy!==d.Number&&this.error("tempo",d.Number,!0);var n=new ye;n.isLinear=!1,n.type=V.Tempo,n.value=this._syData,s.tempoAutomation=n,this._sy=this.newSy()}else if("section"===a){this._sy=this.newSy(),this._sy!==d.String&&this.error("section",d.String,!0);let e=this._syData,t=(this._sy=this.newSy(),"");this._sy!==d.String||this.isNoteText(this._syData.toLowerCase())||(t=e,e=this._syData,this._sy=this.newSy());n=new He;n.marker=t,n.text=e,s.section=n}else if("tf"===a){switch(this._allowTuning=!1,this._sy=this.newSy(),this._allowTuning=!0,this._sy){case d.String:s.tripletFeel=this.parseTripletFeelFromString(this._syData);break;case d.Number:s.tripletFeel=this.parseTripletFeelFromInt(this._syData);break;default:this.error("triplet-feel",d.String,!0)}this._sy=this.newSy()}else"ac"===a?(s.isAnacrusis=!0,this._sy=this.newSy()):0===e.index&&this.handleStaffMeta()||this.error("measure-effects",d.String,!1)}return 0!==s.index||s.tempoAutomation||((i=new ye).isLinear=!1,i.type=V.Tempo,i.value=this._score.tempo,s.tempoAutomation=i),t}applyAlternateEnding(e){var t=this._syData;t<1&&this.error("alternateending",d.Number,!0),e.alternateEndings|=1<<t-1,this._sy=this.newSy()}}je.Eof=0;class Qe extends ge{constructor(){super(),this._versionNumber=0,this._globalTripletFeel=u.NoTripletFeel,this._lyricsTrack=0,this._lyrics=[],this._barCount=0,this._trackCount=0,this._playbackInfos=[],this._beatTextChunksByTrack=new Map}get name(){return"Guitar Pro 3-5"}readScore(){return this.readVersion(),this._score=new Ge,this.readScoreInformation(),this._versionNumber<500&&(this._globalTripletFeel=Ke.gpReadBool(this.data)?u.Triplet8th:u.NoTripletFeel),400<=this._versionNumber&&this.readLyrics(),510<=this._versionNumber&&this.data.skip(19),500<=this._versionNumber&&(this.readPageSetup(),this._score.tempoLabel=Ke.gpReadStringIntByte(this.data,this.settings.importer.encoding)),this._score.tempo=L.readInt32LE(this.data),510<=this._versionNumber&&Ke.gpReadBool(this.data),L.readInt32LE(this.data),400<=this._versionNumber&&this.data.readByte(),this.readPlaybackInfos(),500<=this._versionNumber&&(this.data.skip(38),this.data.skip(4)),this._barCount=L.readInt32LE(this.data),this._trackCount=L.readInt32LE(this.data),this.readMasterBars(),this.readTracks(),this.readBars(),0<this._score.masterBars.length&&(this._score.masterBars[0].tempoAutomation=ye.buildTempoAutomation(!1,0,this._score.tempo,2),this._score.masterBars[0].tempoAutomation.text=this._score.tempoLabel),this._score.finish(this.settings),this._lyrics&&0<=this._lyricsTrack&&this._score.tracks[this._lyricsTrack].applyLyrics(this._lyrics),this._score}readVersion(){let e=Ke.gpReadStringByteLength(this.data,30,this.settings.importer.encoding);if(!e.startsWith(Qe.VersionString))throw new fe("Unsupported format");var t=(e=e.substr(Qe.VersionString.length+1)).indexOf(String.fromCharCode(46));this._versionNumber=100*parseInt(e.substr(0,t))+parseInt(e.substr(t+1)),C.debug(this.name,"Guitar Pro version "+e+" detected")}readScoreInformation(){this._score.title=Ke.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.subTitle=Ke.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.artist=Ke.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.album=Ke.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.words=Ke.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.music=500<=this._versionNumber?Ke.gpReadStringIntUnused(this.data,this.settings.importer.encoding):this._score.words,this._score.copyright=Ke.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.tab=Ke.gpReadStringIntUnused(this.data,this.settings.importer.encoding),this._score.instructions=Ke.gpReadStringIntUnused(this.data,this.settings.importer.encoding);var t,i=L.readInt32LE(this.data);let s="";for(let e=0;e<i;e++)0<e&&(s+="\r\n"),s+=null==(t=Ke.gpReadStringIntUnused(this.data,this.settings.importer.encoding))?void 0:t.toString();this._score.notices=s}readLyrics(){this._lyrics=[],this._lyricsTrack=L.readInt32LE(this.data)-1;for(let e=0;e<5;e++){var t=new Ie;t.startBar=L.readInt32LE(this.data)-1,t.text=Ke.gpReadStringInt(this.data,this.settings.importer.encoding),this._lyrics.push(t)}}readPageSetup(){this.data.skip(30);for(let e=0;e<10;e++)Ke.gpReadStringIntByte(this.data,this.settings.importer.encoding)}readPlaybackInfos(){this._playbackInfos=[];for(let e=0;e<64;e++){var t=new ze;t.primaryChannel=e,t.secondaryChannel=e,t.program=L.readInt32LE(this.data),t.volume=this.data.readByte(),t.balance=this.data.readByte(),this.data.skip(6),this._playbackInfos.push(t)}}readMasterBars(){for(let e=0;e<this._barCount;e++)this.readMasterBar()}readMasterBar(){let s=null;0<this._score.masterBars.length&&(s=this._score.masterBars[this._score.masterBars.length-1]);var e,a=new Re,t=this.data.readByte();if(0!=(1&t)?a.timeSignatureNumerator=this.data.readByte():s&&(a.timeSignatureNumerator=s.timeSignatureNumerator),0!=(2&t)?a.timeSignatureDenominator=this.data.readByte():s&&(a.timeSignatureDenominator=s.timeSignatureDenominator),a.isRepeatStart=0!=(4&t),0!=(8&t)&&(a.repeatCount=this.data.readByte()+(500<=this._versionNumber?0:1)),0!=(16&t))if(this._versionNumber<500){let e=s,t=0;for(;e&&(!e.isRepeatEnd||e===s)&&!e.isRepeatStart;)t|=e.alternateEndings,e=e.previousMasterBar;let i=0;var r=this.data.readByte();for(let e=0;e<8;e++){var n=1<<e;r>e&&0==(t&n)&&(i|=n)}a.alternateEndings=i}else a.alternateEndings=this.data.readByte();if(0!=(32&t)&&((e=new He).text=Ke.gpReadStringIntByte(this.data,this.settings.importer.encoding),e.marker="",Ke.gpReadColor(this.data,!1),a.section=e),0!=(64&t)?(a.keySignature=L.readSInt8(this.data),a.keySignatureType=this.data.readByte()):s&&(a.keySignature=s.keySignature,a.keySignatureType=s.keySignatureType),500<=this._versionNumber&&0!=(3&t)&&this.data.skip(4),500<=this._versionNumber&&0==(16&t)&&(a.alternateEndings=this.data.readByte()),500<=this._versionNumber){switch(this.data.readByte()){case 1:a.tripletFeel=u.Triplet8th;break;case 2:a.tripletFeel=u.Triplet16th}this.data.readByte()}else a.tripletFeel=this._globalTripletFeel;a.isDoubleBar=0!=(128&t),this._score.addMasterBar(a)}readTracks(){for(let e=0;e<this._trackCount;e++)this.readTrack()}readTrack(){var e=new Xe,t=(e.ensureStaveCount(1),this._score.addTrack(e),e.staves[0]),i=this.data.readByte(),s=(e.name=Ke.gpReadStringByteLength(this.data,40,this.settings.importer.encoding),0!=(1&i)&&(t.isPercussion=!0),L.readInt32LE(this.data)),a=[];for(let e=0;e<7;e++){var r=L.readInt32LE(this.data);s>e&&a.push(r)}t.stringTuning.tunings=a;var n=L.readInt32LE(this.data),o=L.readInt32LE(this.data)-1,h=L.readInt32LE(this.data)-1;this.data.skip(4),0<=o&&o<this._playbackInfos.length&&((o=this._playbackInfos[o]).port=n,o.isSolo=0!=(16&i),o.isMute=0!=(32&i),o.secondaryChannel=h,pe.isGuitar(o.program)&&(t.displayTranspositionPitch=-12),e.playbackInfo=o),t.capo=L.readInt32LE(this.data),e.color=Ke.gpReadColor(this.data,!1),500<=this._versionNumber&&(this.data.readByte(),this.data.readByte(),this.data.skip(43)),510<=this._versionNumber&&(this.data.skip(4),Ke.gpReadStringIntByte(this.data,this.settings.importer.encoding),Ke.gpReadStringIntByte(this.data,this.settings.importer.encoding))}readBars(){for(let e=0;e<this._barCount;e++)for(let e=0;e<this._trackCount;e++)this.readBar(this._score.tracks[e])}readBar(t){var i=new be,e=t.staves[0];e.isPercussion&&(i.clef=c.Neutral),e.addBar(i);let s=1;500<=this._versionNumber&&(this.data.readByte(),s=2);for(let e=0;e<s;e++)this.readVoice(t,i)}readVoice(t,i){var s=L.readInt32LE(this.data);if(0!==s){var a=new Ye;i.addVoice(a);for(let e=0;e<s;e++)this.readBeat(t,i,a)}}readBeat(t,i,s){var a=new Me,e=this.data.readByte(),r=(0!=(1&e)&&(a.dots=1),0!=(64&e)&&(r=this.data.readByte(),a.isEmpty=0==(2&r)),s.addBeat(a),L.readSInt8(this.data));switch(r){case-2:a.duration=x.Whole;break;case-1:a.duration=x.Half;break;case 0:a.duration=x.Quarter;break;case 1:a.duration=x.Eighth;break;case 2:a.duration=x.Sixteenth;break;case 3:a.duration=x.ThirtySecond;break;case 4:a.duration=x.SixtyFourth;break;default:a.duration=x.Quarter}if(0!=(32&e))switch(a.tupletNumerator=L.readInt32LE(this.data),a.tupletNumerator){case 1:a.tupletDenominator=1;break;case 3:a.tupletDenominator=2;break;case 5:case 6:case 7:a.tupletDenominator=4;break;case 9:case 10:case 11:case 12:case 13:a.tupletDenominator=8;break;case 2:case 4:case 8:break;default:a.tupletNumerator=1,a.tupletDenominator=1}0!=(2&e)&&this.readChord(a);r=this.settings.importer.beatTextAsLyrics&&t.index!==this._lyricsTrack;if(0!=(4&e)){var n=Ke.gpReadStringIntUnused(this.data,this.settings.importer.encoding);if(r){var o=new Ie,h=(o.text=n.trim(),o.finish(!0),[]);for(let e=o.chunks.length-1;0<=e;e--)h.push(o.chunks[e]);this._beatTextChunksByTrack.set(t.index,h)}else a.text=n}let l=g.None;0!=(8&e)&&(l=this.readBeatEffects(a)),0!=(16&e)&&this.readMixTableChange(a);var d,c=this.data.readByte();for(let e=6;0<=e;e--)0!=(c&1<<e)&&6-e<i.staff.tuning.length&&(d=this.readNote(t,i,s,a,6-e),l!==g.None)&&(d.harmonicType=l,d.harmonicType===g.Natural)&&(d.harmonicValue=this.deltaFretToHarmonicValue(d.fret));500<=this._versionNumber&&(this.data.readByte(),0!=(8&this.data.readByte()))&&this.data.readByte(),r&&!a.isRest&&this._beatTextChunksByTrack.has(t.index)&&0<this._beatTextChunksByTrack.get(t.index).length&&(a.lyrics=[this._beatTextChunksByTrack.get(t.index).pop()])}readChord(t){var i=new De,e=Be.newGuid();if(500<=this._versionNumber){this.data.skip(17),i.name=Ke.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),i.firstFret=L.readInt32LE(this.data);for(let e=0;e<7;e++){var s=L.readInt32LE(this.data);e<t.voice.bar.staff.tuning.length&&i.strings.push(s)}var a=this.data.readByte(),r=new Uint8Array(5);this.data.read(r,0,r.length);for(let e=0;e<a;e++)i.barreFrets.push(r[e]);this.data.skip(26)}else if(0!==this.data.readByte())if(400<=this._versionNumber){this.data.skip(16),i.name=Ke.gpReadStringByteLength(this.data,21,this.settings.importer.encoding),this.data.skip(4),i.firstFret=L.readInt32LE(this.data);for(let e=0;e<7;e++){var n=L.readInt32LE(this.data);e<t.voice.bar.staff.tuning.length&&i.strings.push(n)}var o=this.data.readByte(),h=new Uint8Array(5);this.data.read(h,0,h.length);for(let e=0;e<o;e++)i.barreFrets.push(h[e]);this.data.skip(26)}else{this.data.skip(25),i.name=Ke.gpReadStringByteLength(this.data,34,this.settings.importer.encoding),i.firstFret=L.readInt32LE(this.data);for(let e=0;e<6;e++){var l=L.readInt32LE(this.data);e<t.voice.bar.staff.tuning.length&&i.strings.push(l)}this.data.skip(36)}else{var d=406<=this._versionNumber?7:6;if(i.name=Ke.gpReadStringIntByte(this.data,this.settings.importer.encoding),i.firstFret=L.readInt32LE(this.data),0<i.firstFret)for(let e=0;e<d;e++){var c=L.readInt32LE(this.data);e<t.voice.bar.staff.tuning.length&&i.strings.push(c)}}i.name&&(t.chordId=e,t.voice.bar.staff.addChord(t.chordId,i))}readBeatEffects(i){var e=this.data.readByte();let t=0;if(400<=this._versionNumber&&(t=this.data.readByte()),i.fadeIn=0!=(16&e),(this._versionNumber<400&&0!=(1&e)||0!=(2&e))&&(i.vibrato=J.Slight),i.hasRasgueado=0!=(1&t),0!=(32&e)&&400<=this._versionNumber)switch(L.readSInt8(this.data)){case 1:i.tap=!0;break;case 2:i.slap=!0;break;case 3:i.pop=!0}else if(0!=(32&e)){switch(L.readSInt8(this.data)){case 1:i.tap=!0;break;case 2:i.slap=!0;break;case 3:i.pop=!0}this.data.skip(4)}if(0!=(4&t)&&this.readTremoloBarEffect(i),0!=(64&e)){let e=0,t=0;this._versionNumber<500?(t=this.data.readByte(),e=this.data.readByte()):(e=this.data.readByte(),t=this.data.readByte()),0<e?(i.brushType=U.BrushUp,i.brushDuration=Qe.toStrokeValue(e)):0<t&&(i.brushType=U.BrushDown,i.brushDuration=Qe.toStrokeValue(t))}if(0!=(2&t))switch(L.readSInt8(this.data)){case 0:i.pickStroke=j.None;break;case 1:i.pickStroke=j.Up;break;case 2:i.pickStroke=j.Down}if(this._versionNumber<400){if(0!=(4&e))return g.Natural;if(0!=(8&e))return g.Artificial}return g.None}readTremoloBarEffect(t){this.data.readByte(),L.readInt32LE(this.data);var i=L.readInt32LE(this.data);if(0<i)for(let e=0;e<i;e++){var s=new B(0,0);s.offset=L.readInt32LE(this.data),s.value=L.readInt32LE(this.data)/Qe.BendStep|0,Ke.gpReadBool(this.data),t.addWhammyBarPoint(s)}}static toStrokeValue(e){switch(e){case 1:case 2:return 30;case 3:return 60;case 4:return 120;case 5:return 240;case 6:return 480;default:return 0}}readMixTableChange(e){var t=new $e,i=(t.instrument=L.readSInt8(this.data),500<=this._versionNumber&&this.data.skip(16),t.volume=L.readSInt8(this.data),t.balance=L.readSInt8(this.data),L.readSInt8(this.data)),s=L.readSInt8(this.data),a=L.readSInt8(this.data),r=L.readSInt8(this.data);500<=this._versionNumber&&(t.tempoName=Ke.gpReadStringIntByte(this.data,this.settings.importer.encoding)),t.tempo=L.readInt32LE(this.data),0<=t.volume&&this.data.readByte(),0<=t.balance&&this.data.readByte(),0<=i&&this.data.readByte(),0<=s&&this.data.readByte(),0<=a&&this.data.readByte(),0<=r&&this.data.readByte(),0<=t.tempo&&(t.duration=L.readSInt8(this.data),510<=this._versionNumber)&&this.data.readByte(),400<=this._versionNumber&&this.data.readByte(),500<=this._versionNumber&&this.data.readByte(),510<=this._versionNumber&&(Ke.gpReadStringIntByte(this.data,this.settings.importer.encoding),Ke.gpReadStringIntByte(this.data,this.settings.importer.encoding)),0<=t.volume&&((i=new ye).isLinear=!0,i.type=V.Volume,i.value=t.volume,e.automations.push(i)),0<=t.balance&&((s=new ye).isLinear=!0,s.type=V.Balance,s.value=t.balance,e.automations.push(s)),0<=t.instrument&&((a=new ye).isLinear=!0,a.type=V.Instrument,a.value=t.instrument,e.automations.push(a)),0<=t.tempo&&((r=new ye).isLinear=!0,r.type=V.Tempo,r.value=t.tempo,e.automations.push(r),e.voice.bar.masterBar.tempoAutomation=r)}readNote(e,t,i,s,a){var r,n=new Ne,a=(n.string=t.staff.tuning.length-a,this.data.readByte());0!=(2&a)?n.accentuated=H.Heavy:0!=(64&a)&&(n.accentuated=H.Normal),n.isGhost=0!=(4&a),0!=(32&a)&&(3===(r=this.data.readByte())?n.isDead=!0:2===r&&(n.isTieDestination=!0)),0!=(1&a)&&this._versionNumber<500&&(this.data.readByte(),this.data.readByte()),0!=(16&a)&&(r=L.readSInt8(this.data),n.dynamics=this.toDynamicValue(r),s.dynamics=n.dynamics),0!=(32&a)&&(n.fret=L.readSInt8(this.data)),0!=(128&a)&&(n.leftHandFinger=L.readSInt8(this.data),n.rightHandFinger=L.readSInt8(this.data),n.isFingering=!0);let o=!1;return 500<=this._versionNumber&&(0!=(1&a)&&(n.durationPercent=Ke.gpReadDouble(this.data)),r=this.data.readByte(),o=0!=(2&r)),s.addNote(n),0!=(8&a)&&this.readNoteEffects(e,i,s,n),t.staff.isPercussion&&(n.percussionArticulation=n.fret,n.string=-1,n.fret=-1),o&&("#"===(r=y.defaultAccidentals[n.realValueWithoutHarmonic%12])?n.accidentalMode=Y.ForceFlat:"b"===r&&(n.accidentalMode=Y.ForceSharp)),n}toDynamicValue(e){switch(e){case 1:return l.PPP;case 2:return l.PP;case 3:return l.P;case 4:return l.MP;case 5:return l.MF;case 6:return l.F;case 7:return l.FF;case 8:return l.FFF;default:return l.F}}readNoteEffects(e,t,i,s){var a=this.data.readByte();let r=0;400<=this._versionNumber&&(r=this.data.readByte()),0!=(1&a)&&this.readBend(s),0!=(16&a)&&this.readGrace(t,s),0!=(4&r)&&this.readTremoloPicking(i),0!=(8&r)?this.readSlide(s):this._versionNumber<400&&0!=(4&a)&&(s.slideOutType=m.Shift),0!=(16&r)&&this.readArtificialHarmonic(s),0!=(32&r)&&this.readTrill(s),s.isLetRing=0!=(8&a),s.isHammerPullOrigin=0!=(2&a),0!=(64&r)&&(s.vibrato=J.Slight),s.isPalmMute=0!=(2&r),s.isStaccato=0!=(1&r)}readBend(t){this.data.readByte(),L.readInt32LE(this.data);var i=L.readInt32LE(this.data);if(0<i)for(let e=0;e<i;e++){var s=new B(0,0);s.offset=L.readInt32LE(this.data),s.value=L.readInt32LE(this.data)/Qe.BendStep|0,Ke.gpReadBool(this.data),t.addBendPoint(s)}}readGrace(e,t){var i=new Me,s=new Ne,a=(s.string=t.string,s.fret=L.readSInt8(this.data),i.duration=x.ThirtySecond,i.dynamics=this.toDynamicValue(L.readSInt8(this.data)),L.readSInt8(this.data));switch(a){case 0:break;case 1:s.slideOutType=m.Legato,s.slideTarget=t;break;case 2:break;case 3:s.isHammerPullOrigin=!0}s.dynamics=i.dynamics,this.data.skip(1),this._versionNumber<500?i.graceType=_.BeforeBeat:(a=this.data.readByte(),s.isDead=0!=(1&a),i.graceType=0!=(2&a)?_.OnBeat:_.BeforeBeat),e.addGraceBeat(i),i.addNote(s)}readTremoloPicking(e){switch(this.data.readByte()){case 1:e.tremoloSpeed=x.Eighth;break;case 2:e.tremoloSpeed=x.Sixteenth;break;case 3:e.tremoloSpeed=x.ThirtySecond}}readSlide(e){if(500<=this._versionNumber){var t=L.readSInt8(this.data);0!=(1&t)?e.slideOutType=m.Shift:0!=(2&t)?e.slideOutType=m.Legato:0!=(4&t)?e.slideOutType=m.OutDown:0!=(8&t)&&(e.slideOutType=m.OutUp),0!=(16&t)?e.slideInType=q.IntoFromBelow:0!=(32&t)&&(e.slideInType=q.IntoFromAbove)}else switch(L.readSInt8(this.data)){case 1:e.slideOutType=m.Shift;break;case 2:e.slideOutType=m.Legato;break;case 3:e.slideOutType=m.OutDown;break;case 4:e.slideOutType=m.OutUp;break;case-1:e.slideInType=q.IntoFromBelow;break;case-2:e.slideInType=q.IntoFromAbove}}readArtificialHarmonic(e){var t=this.data.readByte();if(500<=this._versionNumber)switch(t){case 1:e.harmonicType=g.Natural,e.harmonicValue=this.deltaFretToHarmonicValue(e.fret);break;case 2:this.data.readByte(),this.data.readByte(),this.data.readByte(),e.harmonicType=g.Artificial;break;case 3:e.harmonicType=g.Tap,e.harmonicValue=this.deltaFretToHarmonicValue(this.data.readByte());break;case 4:e.harmonicType=g.Pinch,e.harmonicValue=12;break;case 5:e.harmonicType=g.Semi,e.harmonicValue=12}else if(400<=this._versionNumber)switch(t){case 1:e.harmonicType=g.Natural;break;case 3:e.harmonicType=g.Tap;break;case 4:e.harmonicType=g.Pinch;break;case 5:e.harmonicType=g.Semi;break;case 15:case 17:case 22:e.harmonicType=g.Artificial}}deltaFretToHarmonicValue(e){switch(e){case 2:return 2.4;case 3:return 3.2;case 4:case 5:case 7:case 9:case 12:case 16:case 17:case 19:case 24:return e;case 8:return 8.2;case 10:return 9.6;case 14:case 15:return 14.7;case 21:case 22:return 21.7;default:return 12}}readTrill(e){switch(e.trillValue=this.data.readByte()+e.stringTuning,this.data.readByte()){case 1:e.trillSpeed=x.Sixteenth;break;case 2:e.trillSpeed=x.ThirtySecond;break;case 3:e.trillSpeed=x.SixtyFourth}}}Qe.VersionString="FICHIER GUITAR PRO ",Qe.BendStep=25;class Ke{static gpReadDouble(e){var t=new Uint8Array(8),e=(e.read(t,0,t.length),new Float64Array(t.buffer));return e[0]}static gpReadFloat(e){var t=new Uint8Array(4),e=(t[3]=e.readByte(),t[2]=e.readByte(),t[2]=e.readByte(),t[1]=e.readByte(),new Float32Array(t.buffer));return e[0]}static gpReadColor(e,t=!1){var i=e.readByte(),s=e.readByte(),a=e.readByte();let r=255;return t?r=e.readByte():e.skip(1),new We(i,s,a,r)}static gpReadBool(e){return 0!==e.readByte()}static gpReadStringIntUnused(e,t){return e.skip(4),Ke.gpReadString(e,e.readByte(),t)}static gpReadStringInt(e,t){return Ke.gpReadString(e,L.readInt32LE(e),t)}static gpReadStringIntByte(e,t){var i=L.readInt32LE(e)-1;return e.readByte(),Ke.gpReadString(e,i,t)}static gpReadString(e,t,i){t=new Uint8Array(t);return e.read(t,0,t.length),L.toString(t,i)}static gpWriteString(e,t){var i=L.stringToBytes(t);e.writeByte(t.length),e.write(i,0,i.length)}static gpReadStringByteLength(e,t,i){var s=e.readByte(),i=Ke.gpReadString(e,s,i);return s<t&&e.skip(t-s),i}}class $e{constructor(){this.volume=-1,this.balance=-1,this.instrument=-1,this.tempoName="",this.tempo=-1,this.duration=-1}}class Ze{constructor(){this.x=0,this.y=0,this.w=0,this.h=0}}(e=ee=ee||{})[e.Boolean=0]="Boolean",e[e.Integer=1]="Integer",e[e.Float=2]="Float",e[e.String=3]="String",e[e.Point=4]="Point",e[e.Size=5]="Size",e[e.Rectangle=6]="Rectangle",e[e.Color=7]="Color";class et{constructor(e){this.raw=new Map;var t=qe.fromBuffer(e),i=L.readInt32BE(t);for(let e=0;e<i;e++){var s=Ke.gpReadString(t,t.readByte(),"utf-8");switch(t.readByte()){case ee.Boolean:var a=1===t.readByte();this.addValue(s,a);break;case ee.Integer:a=L.readInt32BE(t);this.addValue(s,a);break;case ee.Float:var r=Ke.gpReadFloat(t);this.addValue(s,r);break;case ee.String:r=Ke.gpReadString(t,L.readInt16BE(t),"utf-8");this.addValue(s,r);break;case ee.Point:var n=L.readInt32BE(t),o=L.readInt32BE(t);this.addValue(s,new B(n,o));break;case ee.Size:n=L.readInt32BE(t),o=L.readInt32BE(t);this.addValue(s,new B(n,o));break;case ee.Rectangle:var h=new Ze;h.x=L.readInt32BE(t),h.y=L.readInt32BE(t),h.w=L.readInt32BE(t),h.h=L.readInt32BE(t),this.addValue(s,h);break;case ee.Color:h=Ke.gpReadColor(t,!0);this.addValue(s,h)}}}apply(e){for(var[t,i]of this.raw)"StandardNotation/hideDynamics"===t&&(e.stylesheet.hideDynamics=i)}addValue(e,t){this.raw.set(e,t)}static writeForScore(e){var t=qe.withCapacity(128);return L.writeInt32BE(t,1),et.writeBooleanEntry(t,"StandardNotation/hideDynamics",e.stylesheet.hideDynamics),t.toArray()}static writeBooleanEntry(e,t,i){Ke.gpWriteString(e,t),e.writeByte(ee.Boolean),e.writeByte(i?1:0)}}(e=te=te||{})[e.Short=0]="Short",e[e.Medium=1]="Medium",e[e.Long=2]="Long";class tt{constructor(){this.type=te.Short,this.length=0}}(e=b=b||{})[e.None=0]="None",e[e.Element=1]="Element",e[e.Text=2]="Text",e[e.CDATA=3]="CDATA",e[e.Document=4]="Document",e[e.DocumentType=5]="DocumentType";class it{constructor(){this.nodeType=b.None,this.localName=null,this.value=null,this.childNodes=[],this.attributes=new Map,this.firstChild=null,this.firstElement=null}addChild(e){this.childNodes.push(e),(this.firstChild=e).nodeType!==b.Element&&e.nodeType!==b.CDATA||(this.firstElement=e)}getAttribute(e){return this.attributes.has(e)?this.attributes.get(e):""}getElementsByTagName(e,t=!1){var i=[];return this.searchElementsByTagName(this.childNodes,i,e,t),i}searchElementsByTagName(e,t,i,s=!1){for(var a of e)a&&a.nodeType===b.Element&&a.localName===i&&t.push(a),s&&this.searchElementsByTagName(a.childNodes,t,i,!0)}findChildElement(e){for(var t of this.childNodes)if(t&&t.nodeType===b.Element&&t.localName===e)return t;return null}addElement(e){var t=new it;return t.nodeType=b.Element,t.localName=e,this.addChild(t),t}get innerText(){var e;if(this.nodeType!==b.Element&&this.nodeType!==b.Document)return null!=(e=this.value)?e:"";{if(this.firstElement&&this.firstElement.nodeType===b.CDATA)return this.firstElement.innerText;let e="";for(var t of this.childNodes)e+=null==(t=t.innerText)?void 0:t.toString();return e.trim()}}set innerText(e){var t=new it;t.nodeType=b.Text,t.value=e,this.childNodes=[t]}setCData(e){var t=new it;t.nodeType=b.CDATA,t.value=e,this.childNodes=[t]}}class st extends me{constructor(e,t,i){super(T.AlphaTabErrorType.Format,e),this.pos=0,this.xml=t,this.pos=i,Object.setPrototypeOf(this,st.prototype)}}(e=S=S||{})[e.IgnoreSpaces=0]="IgnoreSpaces",e[e.Begin=1]="Begin",e[e.BeginNode=2]="BeginNode",e[e.TagName=3]="TagName",e[e.Body=4]="Body",e[e.AttribName=5]="AttribName",e[e.Equals=6]="Equals",e[e.AttvalBegin=7]="AttvalBegin",e[e.AttribVal=8]="AttribVal",e[e.Childs=9]="Childs",e[e.Close=10]="Close",e[e.WaitEnd=11]="WaitEnd",e[e.WaitEndRet=12]="WaitEndRet",e[e.Pcdata=13]="Pcdata",e[e.Header=14]="Header",e[e.Comment=15]="Comment",e[e.Doctype=16]="Doctype",e[e.Cdata=17]="Cdata",e[e.Escape=18]="Escape";class M{static parse(e,t,i){var s,a,r,n,o;e.charCodeAt(t);let h=S.Begin,l=S.Begin,d=0,c="",u=S.Begin,p=null,g=null,m=0,f=0;for(;t<e.length;){switch(s=e.charCodeAt(t),h){case S.IgnoreSpaces:switch(s){case M.CharCodeLF:case M.CharCodeCR:case M.CharCodeTab:case M.CharCodeSpace:break;default:h=l;continue}break;case S.Begin:if(s!==M.CharCodeLowerThan){d=t,h=S.Pcdata;continue}h=S.IgnoreSpaces,l=S.BeginNode;break;case S.Pcdata:s===M.CharCodeLowerThan?(c+=e.substr(d,t-d),(a=new it).nodeType=b.Text,a.value=c,c="",i.addChild(a),h=S.IgnoreSpaces,l=S.BeginNode):s===M.CharCodeAmp&&(c+=e.substr(d,t-d),h=S.Escape,u=S.Pcdata,d=t+1);break;case S.Cdata:s===M.CharCodeBrackedClose&&e.charCodeAt(t+1)===M.CharCodeBrackedClose&&e.charCodeAt(t+2)===M.CharCodeGreaterThan&&((a=new it).nodeType=b.CDATA,a.value=e.substr(d,t-d),i.addChild(a),t+=2,h=S.Begin);break;case S.BeginNode:switch(s){case M.CharCodeExclamation:if(e.charCodeAt(t+1)===M.CharCodeBrackedOpen){if(t+=2,"CDATA["!==e.substr(t,6).toUpperCase())throw new st("Expected <![CDATA[",e,t);t+=5,h=S.Cdata}else if(e.charCodeAt(t+1)===M.CharCodeUpperD||e.charCodeAt(t+1)===M.CharCodeLowerD){if("OCTYPE"!==e.substr(t+2,6).toUpperCase())throw new st("Expected <!DOCTYPE",e,t);t+=8,h=S.Doctype}else{if(e.charCodeAt(t+1)!==M.CharCodeMinus||e.charCodeAt(t+2)!==M.CharCodeMinus)throw new st("Expected \x3c!--",e,t);t+=2,h=S.Comment}d=t+1;break;case M.CharCodeQuestion:h=S.Header,d=t;break;case M.CharCodeSlash:if(!i)throw new st("Expected node name",e,t);d=t+1,h=S.IgnoreSpaces,l=S.Close;break;default:h=S.TagName,d=t;continue}break;case S.TagName:if(M.isValidChar(s))break;if(t===d)throw new st("Expected node name",e,t);(p=new it).nodeType=b.Element,p.localName=e.substr(d,t-d),i.addChild(p),h=S.IgnoreSpaces,l=S.Body;continue;case S.Body:switch(s){case M.CharCodeSlash:h=S.WaitEnd;break;case M.CharCodeGreaterThan:h=S.Childs;break;default:h=S.AttribName,d=t;continue}break;case S.AttribName:if(M.isValidChar(s))break;if(d===t)throw new st("Expected attribute name",e,t);var y=e.substr(d,t-d);if(g=y,p.attributes.has(g))throw new st(`Duplicate attribute [${g}]`,e,t);h=S.IgnoreSpaces,l=S.Equals;continue;case S.Equals:if(s!==M.CharCodeEquals)throw new st("Expected =",e,t);h=S.IgnoreSpaces,l=S.AttvalBegin;break;case S.AttvalBegin:switch(s){case M.CharCodeDoubleQuote:case M.CharCodeSingleQuote:c="",h=S.AttribVal,d=t+1,f=s}break;case S.AttribVal:s===M.CharCodeAmp?(c+=e.substr(d,t-d),h=S.Escape,u=S.AttribVal,d=t+1):s===f&&(y=c+=e.substr(d,t-d),c="",p.attributes.set(g,y),h=S.IgnoreSpaces,l=S.Body);break;case S.Childs:t=M.parse(e,t,p),d=t,h=S.Begin;break;case S.WaitEnd:if(s!==M.CharCodeGreaterThan)throw new st("Expected >",e,t);h=S.Begin;break;case S.WaitEndRet:if(s!==M.CharCodeGreaterThan)throw new st("Expected >",e,t);return t;case S.Close:if(M.isValidChar(s))break;if(d===t)throw new st("Expected node name",e,t);if(e.substr(d,t-d)!==i.localName)throw new st("Expected </"+i.localName+">",e,t);h=S.IgnoreSpaces,l=S.WaitEndRet;continue;case S.Comment:s===M.CharCodeMinus&&e.charCodeAt(t+1)===M.CharCodeMinus&&e.charCodeAt(t+2)===M.CharCodeGreaterThan&&(t+=2,h=S.Begin);break;case S.Doctype:s===M.CharCodeBrackedOpen?m++:s===M.CharCodeBrackedClose?m--:s===M.CharCodeGreaterThan&&0===m&&((r=new it).nodeType=b.DocumentType,r.value=e.substr(d,t-d),i.addChild(r),h=S.Begin);break;case S.Header:s===M.CharCodeQuestion&&e.charCodeAt(t+1)===M.CharCodeGreaterThan&&(t++,h=S.Begin);break;case S.Escape:s===M.CharCodeSemi?((r=e.substr(d,t-d)).charCodeAt(0)===M.CharCodeSharp?(n=r.charCodeAt(1)===M.CharCodeLowerX?parseInt("0"+r.substr(1,r.length-1)):parseInt(r.substr(1,r.length-1)),c+=String.fromCharCode(n)):M.Escapes.has(r)?c+=M.Escapes.get(r):c+=null==(n="&"+r+";")?void 0:n.toString(),d=t+1,h=u):M.isValidChar(s)||s===M.CharCodeSharp||(c=(c+="&")+e.substr(d,t-d),t--,d=t+1,h=u)}t++}if(h===S.Begin&&(d=t,h=S.Pcdata),h===S.Pcdata)return t!==d&&(c+=e.substr(d,t-d),(o=new it).nodeType=b.Text,o.value=c,i.addChild(o)),t;if(h===S.Escape&&u===S.Pcdata)return c=(c+="&")+e.substr(d,t-d),(o=new it).nodeType=b.Text,o.value=c,i.addChild(o),t;throw new st("Unexpected end",e,t)}static isValidChar(e){return e>=M.CharCodeLowerA&&e<=M.CharCodeLowerZ||e>=M.CharCodeUpperA&&e<=M.CharCodeUpperZ||e>=M.CharCode0&&e<=M.CharCode9||e===M.CharCodeColon||e===M.CharCodeDot||e===M.CharCodeUnderscore||e===M.CharCodeMinus}}M.CharCodeLF=10,M.CharCodeTab=9,M.CharCodeCR=13,M.CharCodeSpace=32,M.CharCodeLowerThan=60,M.CharCodeAmp=38,M.CharCodeBrackedClose=93,M.CharCodeBrackedOpen=91,M.CharCodeGreaterThan=62,M.CharCodeExclamation=33,M.CharCodeUpperD=68,M.CharCodeLowerD=100,M.CharCodeMinus=45,M.CharCodeQuestion=63,M.CharCodeSlash=47,M.CharCodeEquals=61,M.CharCodeDoubleQuote=34,M.CharCodeSingleQuote=39,M.CharCodeSharp=35,M.CharCodeLowerX=120,M.CharCodeLowerA=97,M.CharCodeLowerZ=122,M.CharCodeUpperA=65,M.CharCodeUpperZ=90,M.CharCode0=48,M.CharCode9=57,M.CharCodeColon=58,M.CharCodeDot=46,M.CharCodeUnderscore=95,M.CharCodeSemi=59,M.Escapes=new Map([["lt","<"],["gt",">"],["amp","&"],["quot",'"'],["apos","'"]]);class at{constructor(e,t){this._result=[],this._indention=e,this._xmlHeader=t,this._currentIndention="",this._isStartOfLine=!0}static write(e,t,i){t=new at(t,i);return t.writeNode(e),t.toString()}writeNode(e){switch(e.nodeType){case b.None:break;case b.Element:0<this._result.length&&this.writeLine(),this.write("<"+e.localName);for(var[t,i]of e.attributes)this.write(` ${t}="`),this.writeAttributeValue(i),this.write('"');if(0===e.childNodes.length)this.write("/>");else{if(this.write(">"),1!==e.childNodes.length||e.firstElement){this.indent();for(const s of e.childNodes)s.nodeType===b.Element&&this.writeNode(s);this.unindend(),this.writeLine()}else this.writeNode(e.childNodes[0]);this.write(`</${e.localName}>`)}break;case b.Text:e.value&&this.write(e.value);break;case b.CDATA:null!==e.value&&this.write(`<![CDATA[${e.value}]]>`);break;case b.Document:this._xmlHeader&&this.write('<?xml version="1.0" encoding="utf-8"?>');for(const a of e.childNodes)this.writeNode(a);break;case b.DocumentType:this.write(`<!DOCTYPE ${e.value}>`)}}unindend(){this._currentIndention=this._currentIndention.substr(0,this._currentIndention.length-this._indention.length)}indent(){this._currentIndention+=this._indention}writeAttributeValue(t){for(let e=0;e<t.length;e++){var i=t.charAt(e);switch(i){case"<":this._result.push("&lt;");break;case">":this._result.push("&gt;");break;case"&":this._result.push("&amp;");break;case"'":this._result.push("&apos;");break;case'"':this._result.push("&quot;");break;default:this._result.push(i)}}}write(e){this._isStartOfLine&&this._result.push(this._currentIndention),this._result.push(e),this._isStartOfLine=!1}writeLine(e=null){e&&this.write(e),0<this._indention.length&&!this._isStartOfLine&&(this._result.push("\n"),this._isStartOfLine=!0)}toString(){return this._result.join("").trimRight()}}class rt extends it{constructor(){super(),this.nodeType=b.Document}parse(e){M.parse(e,0,this)}toString(){return this.toFormattedString()}toFormattedString(e="",t=!1){return at.write(this,e,t)}}(e=E=E||{})[e.Up=0]="Up",e[e.Down=1]="Down";class nt{constructor(){this.id="",this.dots=0,this.tupletDenominator=-1,this.tupletNumerator=-1,this.value=x.Quarter}}class ot{constructor(){this.name="",this.path="",this.role="",this.program=0}get uniqueId(){return this.path+";"+this.name+";"+this.role}}class ht{constructor(){this._hasAnacrusis=!1,this._skipApplyLyrics=!1}parseXml(e,t){this._masterTrackAutomations=new Map,this._automationsPerTrackIdAndBarIndex=new Map,this._tracksMapping=[],this._tracksById=new Map,this._masterBars=[],this._barsOfMasterBar=[],this._voicesOfBar=new Map,this._barsById=new Map,this._voiceById=new Map,this._beatsOfVoice=new Map,this._beatById=new Map,this._rhythmOfBeat=new Map,this._rhythmById=new Map,this._notesOfBeat=new Map,this._noteById=new Map,this._tappedNotes=new Map,this._lyricsByTrack=new Map,this._soundsByTrack=new Map,this._skipApplyLyrics=!1;var i=new rt;try{i.parse(e)}catch(e){throw new fe("Could not parse XML",e)}if(this.parseDom(i),this.buildModel(),this.score.finish(t),!this._skipApplyLyrics&&0<this._lyricsByTrack.size)for(var[s,a]of this._lyricsByTrack)this._tracksById.get(s).applyLyrics(a)}parseDom(e){e=e.firstElement;if(e){if("GPIF"!==e.localName)throw new fe("Root node of XML was not GPIF");this.score=new Ge;for(var t of e.childNodes)if(t.nodeType===b.Element)switch(t.localName){case"Score":this.parseScoreNode(t);break;case"MasterTrack":this.parseMasterTrackNode(t);break;case"Tracks":this.parseTracksNode(t);break;case"MasterBars":this.parseMasterBarsNode(t);break;case"Bars":this.parseBars(t);break;case"Voices":this.parseVoices(t);break;case"Beats":this.parseBeats(t);break;case"Notes":this.parseNotes(t);break;case"Rhythms":this.parseRhythms(t)}}}parseScoreNode(e){for(var t of e.childNodes)if(t.nodeType===b.Element)switch(t.localName){case"Title":this.score.title=t.firstChild.innerText;break;case"SubTitle":this.score.subTitle=t.firstChild.innerText;break;case"Artist":this.score.artist=t.firstChild.innerText;break;case"Album":this.score.album=t.firstChild.innerText;break;case"Words":this.score.words=t.firstChild.innerText;break;case"Music":this.score.music=t.firstChild.innerText;break;case"WordsAndMusic":var i;t.firstChild&&""!==t.firstChild.innerText&&((i=t.firstChild.innerText)&&!this.score.words&&(this.score.words=i),i)&&!this.score.music&&(this.score.music=i);break;case"Copyright":this.score.copyright=t.firstChild.innerText;break;case"Tabber":this.score.tab=t.firstChild.innerText;break;case"Instructions":this.score.instructions=t.firstChild.innerText;break;case"Notices":this.score.notices=t.firstChild.innerText}}parseMasterTrackNode(e){for(var t of e.childNodes)if(t.nodeType===b.Element)switch(t.localName){case"Automations":this.parseAutomations(t,this._masterTrackAutomations,null);break;case"Tracks":this._tracksMapping=t.innerText.split(" ");break;case"Anacrusis":this._hasAnacrusis=!0}}parseAutomations(e,t,i){for(var s of e.childNodes)s.nodeType===b.Element&&"Automation"===s.localName&&this.parseAutomation(s,t,i)}parseAutomation(e,t,i){let s=null,a=!1,r=-1,n=0,o=0,h=null,l=0,d=null;for(var c of e.childNodes)if(c.nodeType===b.Element)switch(c.localName){case"Type":s=c.innerText;break;case"Linear":a="true"===c.innerText.toLowerCase();break;case"Bar":r=parseInt(c.innerText);break;case"Position":n=parseFloat(c.innerText);break;case"Value":var u;c.firstElement&&c.firstElement.nodeType===b.CDATA?h=c.innerText:(u=c.innerText.split(" "),l=1===u.length?(o=parseFloat(u[0]),1):(o=parseFloat(u[0]),parseInt(u[1])));break;case"Text":d=c.innerText}if(s){let e=null;switch(s){case"Tempo":e=ye.buildTempoAutomation(a,n,o,l);break;case"Sound":h&&i&&i.has(h)&&(e=ye.buildInstrumentAutomation(a,n,i.get(h).program))}e&&(d&&(e.text=d),0<=r)&&(t.has(r)||t.set(r,[]),t.get(r).push(e))}}parseTracksNode(e){for(var t of e.childNodes)t.nodeType===b.Element&&"Track"===t.localName&&this.parseTrack(t)}parseTrack(e){this._articulationByName=new Map;var t=new Xe;t.ensureStaveCount(1);t.staves[0].showStandardNotation=!0;var i,s=e.getAttribute("id");for(i of e.childNodes)if(i.nodeType===b.Element)switch(i.localName){case"Name":t.name=i.innerText;break;case"Color":var a=i.innerText.split(" ");3<=a.length&&(r=parseInt(a[0]),n=parseInt(a[1]),a=parseInt(a[2]),t.color=new We(r,n,a,255));break;case"Instrument":var r=i.getAttribute("ref");(r.endsWith("-gs")||r.endsWith("GrandStaff"))&&(t.ensureStaveCount(2),t.staves[1].showStandardNotation=!0);break;case"InstrumentSet":this.parseInstrumentSet(t,i);break;case"NotationPatch":this.parseNotationPatch(t,i);break;case"ShortName":t.shortName=i.innerText;break;case"Lyrics":this.parseLyrics(s,i);break;case"Properties":this.parseTrackProperties(t,i);break;case"GeneralMidi":case"MidiConnection":case"MIDISettings":this.parseGeneralMidi(t,i);break;case"Sounds":this.parseSounds(s,t,i);break;case"PlaybackState":var n=i.innerText;t.playbackInfo.isSolo="Solo"===n,t.playbackInfo.isMute="Mute"===n;break;case"PartSounding":this.parsePartSounding(t,i);break;case"Staves":this.parseStaves(t,i);break;case"Transpose":this.parseTranspose(t,i);break;case"RSE":this.parseRSE(t,i);break;case"Automations":this.parseTrackAutomations(s,i)}this._tracksById.set(s,t)}parseTrackAutomations(e,t){var i=new Map;this._automationsPerTrackIdAndBarIndex.set(e,i),this.parseAutomations(t,i,this._soundsByTrack.get(e))}parseNotationPatch(e,t){for(var i of t.childNodes)if(i.nodeType===b.Element)switch(i.localName){case"LineCount":var s,a=parseInt(i.innerText);for(s of e.staves)s.standardNotationLineCount=a;break;case"Elements":this.parseElements(e,i)}}parseInstrumentSet(e,t){for(var i of t.childNodes)if(i.nodeType===b.Element)switch(i.localName){case"Type":if("drumKit"===i.innerText)for(var s of e.staves)s.isPercussion=!0;if("drumKit"===i.innerText)for(var a of e.staves)a.isPercussion=!0;break;case"Elements":this.parseElements(e,i);break;case"LineCount":var r,n=parseInt(i.innerText);for(r of e.staves)r.standardNotationLineCount=n}}parseElements(e,t){for(var i of t.childNodes)i.nodeType===b.Element&&"Element"===i.localName&&this.parseElement(e,i)}parseElement(e,t){var i,s=t.findChildElement("Type"),a=s?s.innerText:"";for(i of t.childNodes)if(i.nodeType===b.Element)switch(i.localName){case"Name":case"Articulations":this.parseArticulations(e,i,a)}}parseArticulations(e,t,i){for(var s of t.childNodes)s.nodeType===b.Element&&"Articulation"===s.localName&&this.parseArticulation(e,s,i)}parseArticulation(e,t,i){var s,a=new h;a.outputMidiNumber=-1,a.elementType=i;let r="";for(s of t.childNodes)if(s.nodeType===b.Element){var n=s.innerText;switch(s.localName){case"Name":r=s.innerText;break;case"OutputMidiNumber":0<n.length&&(a.outputMidiNumber=parseInt(n));break;case"TechniqueSymbol":a.techniqueSymbol=this.parseTechniqueSymbol(n);break;case"TechniquePlacement":switch(n){case"outside":a.techniqueSymbolPlacement=P.Bottom;break;case"inside":a.techniqueSymbolPlacement=P.Middle;break;case"above":a.techniqueSymbolPlacement=P.Bottom;break;case"below":a.techniqueSymbolPlacement=P.Top}break;case"Noteheads":var o=n.split(" ");1<=o.length&&(a.noteHeadDefault=this.parseNoteHead(o[0])),2<=o.length&&(a.noteHeadHalf=this.parseNoteHead(o[1])),3<=o.length&&(a.noteHeadWhole=this.parseNoteHead(o[2])),a.noteHeadHalf==k.None&&(a.noteHeadHalf=a.noteHeadDefault),a.noteHeadWhole==k.None&&(a.noteHeadWhole=a.noteHeadDefault);break;case"StaffLine":0<n.length&&(a.staffLine=parseInt(n))}}-1!==a.outputMidiNumber?(e.percussionArticulations.push(a),0<r.length&&this._articulationByName.set(r,a)):0<r.length&&this._articulationByName.has(r)&&(this._articulationByName.get(r).staffLine=a.staffLine)}parseTechniqueSymbol(e){switch(e){case"pictEdgeOfCymbal":return k.PictEdgeOfCymbal;case"articStaccatoAbove":return k.ArticStaccatoAbove;case"noteheadParenthesis":return k.NoteheadParenthesis;case"stringsUpBow":return k.StringsUpBow;case"stringsDownBow":return k.StringsDownBow;case"guitarGolpe":return k.GuitarGolpe;default:return k.None}}parseNoteHead(e){switch(e){case"noteheadDoubleWholeSquare":return k.NoteheadDoubleWholeSquare;case"noteheadDoubleWhole":return k.NoteheadDoubleWhole;case"noteheadWhole":return k.NoteheadWhole;case"noteheadHalf":return k.NoteheadHalf;case"noteheadBlack":return k.NoteheadBlack;case"noteheadNull":return k.NoteheadNull;case"noteheadXOrnate":return k.NoteheadXOrnate;case"noteheadTriangleUpWhole":return k.NoteheadTriangleUpWhole;case"noteheadTriangleUpHalf":return k.NoteheadTriangleUpHalf;case"noteheadTriangleUpBlack":return k.NoteheadTriangleUpBlack;case"noteheadDiamondBlackWide":return k.NoteheadDiamondBlackWide;case"noteheadDiamondWhite":return k.NoteheadDiamondWhite;case"noteheadDiamondWhiteWide":return k.NoteheadDiamondWhiteWide;case"noteheadCircleX":return k.NoteheadCircleX;case"noteheadXWhole":return k.NoteheadXWhole;case"noteheadXHalf":return k.NoteheadXHalf;case"noteheadXBlack":return k.NoteheadXBlack;case"noteheadParenthesis":return k.NoteheadParenthesis;case"noteheadSlashedBlack2":return k.NoteheadSlashedBlack2;case"noteheadCircleSlash":return k.NoteheadCircleSlash;case"noteheadHeavyX":return k.NoteheadHeavyX;case"noteheadHeavyXHat":return k.NoteheadHeavyXHat;default:return C.warning("GPIF","Unknown notehead symbol",e),k.None}}parseStaves(e,t){let i=0;for(var s of t.childNodes){var a;s.nodeType===b.Element&&"Staff"===s.localName&&(e.ensureStaveCount(i+1),a=e.staves[i],this.parseStaff(a,s),i++)}}parseStaff(e,t){for(var i of t.childNodes)i.nodeType===b.Element&&"Properties"===i.localName&&this.parseStaffProperties(e,i)}parseStaffProperties(e,t){for(var i of t.childNodes)i.nodeType===b.Element&&"Property"===i.localName&&this.parseStaffProperty(e,i)}parseStaffProperty(e,t){switch(t.getAttribute("name")){case"Tuning":for(var i of t.childNodes)if(i.nodeType===b.Element)switch(i.localName){case"Pitches":var s=t.findChildElement("Pitches").innerText.split(" "),a=new Array(s.length);for(let e=0;e<a.length;e++)a[a.length-1-e]=parseInt(s[e]);e.stringTuning.tunings=a;break;case"Label":e.stringTuning.name=i.innerText}e.isPercussion||(e.showTablature=!0);break;case"DiagramCollection":case"ChordCollection":this.parseDiagramCollectionForStaff(e,t);break;case"CapoFret":var r=parseInt(t.findChildElement("Fret").innerText);e.capo=r}}parseLyrics(e,t){var i,s=[];for(i of t.childNodes)i.nodeType===b.Element&&"Line"===i.localName&&s.push(this.parseLyricsLine(i));this._lyricsByTrack.set(e,s)}parseLyricsLine(e){var t,i=new Ie;for(t of e.childNodes)if(t.nodeType===b.Element)switch(t.localName){case"Offset":i.startBar=parseInt(t.innerText);break;case"Text":i.text=t.innerText}return i}parseDiagramCollectionForTrack(e,t){var i;for(i of t.findChildElement("Items").childNodes)i.nodeType===b.Element&&"Item"===i.localName&&this.parseDiagramItemForTrack(e,i)}parseDiagramCollectionForStaff(e,t){var i;for(i of t.findChildElement("Items").childNodes)i.nodeType===b.Element&&"Item"===i.localName&&this.parseDiagramItemForStaff(e,i)}parseDiagramItemForTrack(e,t){var i,s=new De,a=t.getAttribute("id");for(i of e.staves)i.addChord(a,s);this.parseDiagramItemForChord(s,t)}parseDiagramItemForStaff(e,t){var i=new De,s=t.getAttribute("id");e.addChord(s,i),this.parseDiagramItemForChord(i,t)}parseDiagramItemForChord(t,e){t.name=e.getAttribute("name");var i,e=e.findChildElement("Diagram"),s=parseInt(e.getAttribute("stringCount")),a=parseInt(e.getAttribute("baseFret"));t.firstFret=a+1;for(let e=0;e<s;e++)t.strings.push(-1);for(i of e.childNodes)if(i.nodeType===b.Element)switch(i.localName){case"Fret":var r=parseInt(i.getAttribute("string"));t.strings[s-r-1]=a+parseInt(i.getAttribute("fret"));break;case"Fingering":var n,o=new Map;for(n of i.childNodes)if(n.nodeType===b.Element&&"Position"===n.localName){let e=v.Unknown;var h=a+parseInt(n.getAttribute("fret"));switch(n.getAttribute("finger")){case"Index":e=v.IndexFinger;break;case"Middle":e=v.MiddleFinger;break;case"Rank":e=v.AnnularFinger;break;case"Pinky":e=v.LittleFinger;break;case"Thumb":e=v.Thumb}e!==v.Unknown&&(o.has(e)?t.barreFrets.push(h):o.set(e,!0))}break;case"Property":switch(i.getAttribute("name")){case"ShowName":t.showName="true"===i.getAttribute("value");break;case"ShowDiagram":t.showDiagram="true"===i.getAttribute("value");break;case"ShowFingering":t.showFingering="true"===i.getAttribute("value")}}}parseTrackProperties(e,t){for(var i of t.childNodes)i.nodeType===b.Element&&"Property"===i.localName&&this.parseTrackProperty(e,i)}parseTrackProperty(e,t){switch(t.getAttribute("name")){case"Tuning":var i,s=t.findChildElement("Pitches").innerText.split(" "),a=new Array(s.length);for(let e=0;e<a.length;e++)a[a.length-1-e]=parseInt(s[e]);for(i of e.staves)i.stringTuning.tunings=a,i.showStandardNotation=!0,i.showTablature=!0;break;case"DiagramCollection":case"ChordCollection":this.parseDiagramCollectionForTrack(e,t);break;case"CapoFret":var r,n=parseInt(t.findChildElement("Fret").innerText);for(r of e.staves)r.capo=n}}parseGeneralMidi(e,t){for(var i of t.childNodes)if(i.nodeType===b.Element)switch(i.localName){case"Program":e.playbackInfo.program=parseInt(i.innerText);break;case"Port":e.playbackInfo.port=parseInt(i.innerText);break;case"PrimaryChannel":e.playbackInfo.primaryChannel=parseInt(i.innerText);break;case"SecondaryChannel":e.playbackInfo.secondaryChannel=parseInt(i.innerText)}if("Percussion"===t.getAttribute("table"))for(var s of e.staves)s.isPercussion=!0}parseSounds(e,t,i){for(var s of i.childNodes)s.nodeType===b.Element&&"Sound"===s.localName&&this.parseSound(e,t,s)}parseSound(e,t,i){var s,a=new ot;for(s of i.childNodes)if(s.nodeType===b.Element)switch(s.localName){case"Name":a.name=s.innerText;break;case"Path":a.path=s.innerText;break;case"Role":a.role=s.innerText;break;case"MIDI":this.parseSoundMidi(a,s)}"Factory"!==a.role&&0!==t.playbackInfo.program||(t.playbackInfo.program=a.program),this._soundsByTrack.has(e)||this._soundsByTrack.set(e,new Map),this._soundsByTrack.get(e).set(a.uniqueId,a)}parseSoundMidi(e,t){for(var i of t.childNodes)i.nodeType===b.Element&&"Program"===i.localName&&(e.program=parseInt(i.innerText))}parsePartSounding(e,t){for(var i of t.childNodes)if(i.nodeType===b.Element&&"TranspositionPitch"===i.localName)for(var s of e.staves)s.displayTranspositionPitch=parseInt(i.innerText)}parseTranspose(e,t){let i=0,s=0;for(var a of t.childNodes)if(a.nodeType===b.Element)switch(a.localName){case"Chromatic":s=parseInt(a.innerText);break;case"Octave":i=parseInt(a.innerText)}for(var r of e.staves)r.displayTranspositionPitch=12*i+s}parseRSE(e,t){for(var i of t.childNodes)i.nodeType===b.Element&&"ChannelStrip"===i.localName&&this.parseChannelStrip(e,i)}parseChannelStrip(e,t){for(var i of t.childNodes)i.nodeType===b.Element&&"Parameters"===i.localName&&this.parseChannelStripParameters(e,i)}parseChannelStripParameters(e,t){t.firstChild&&t.firstChild.value&&12<=(t=t.firstChild.value.split(" ")).length&&(e.playbackInfo.balance=Math.floor(16*parseFloat(t[11])),e.playbackInfo.volume=Math.floor(16*parseFloat(t[12])))}parseMasterBarsNode(e){for(var t of e.childNodes)t.nodeType===b.Element&&"MasterBar"===t.localName&&this.parseMasterBar(t)}parseMasterBar(e){var i,s=new Re;0===this._masterBars.length&&this._hasAnacrusis&&(s.isAnacrusis=!0);for(i of e.childNodes)if(i.nodeType===b.Element)switch(i.localName){case"Time":var a=i.innerText.split("/");s.timeSignatureNumerator=parseInt(a[0]),s.timeSignatureDenominator=parseInt(a[1]);break;case"DoubleBar":s.isDoubleBar=!0;break;case"Section":s.section=new He,s.section.marker=i.findChildElement("Letter").innerText,s.section.text=i.findChildElement("Text").innerText;break;case"Repeat":"true"===i.getAttribute("start").toLowerCase()&&(s.isRepeatStart=!0),"true"===i.getAttribute("end").toLowerCase()&&i.getAttribute("count")&&(s.repeatCount=parseInt(i.getAttribute("count")));break;case"AlternateEndings":var r=i.innerText.split(" ");let t=0;for(let e=0;e<r.length;e++)t|=1<<-1+parseInt(r[e]);s.alternateEndings=t;break;case"Bars":this._barsOfMasterBar.push(i.innerText.split(" "));break;case"TripletFeel":switch(i.innerText){case"NoTripletFeel":s.tripletFeel=u.NoTripletFeel;break;case"Triplet8th":s.tripletFeel=u.Triplet8th;break;case"Triplet16th":s.tripletFeel=u.Triplet16th;break;case"Dotted8th":s.tripletFeel=u.Dotted8th;break;case"Dotted16th":s.tripletFeel=u.Dotted16th;break;case"Scottish8th":s.tripletFeel=u.Scottish8th;break;case"Scottish16th":s.tripletFeel=u.Scottish16th}break;case"Key":s.keySignature=parseInt(i.findChildElement("AccidentalCount").innerText);a=i.findChildElement("Mode");if(a)switch(a.innerText.toLowerCase()){case"major":s.keySignatureType=Z.Major;break;case"minor":s.keySignatureType=Z.Minor}break;case"Fermatas":this.parseFermatas(s,i)}this._masterBars.push(s)}parseFermatas(e,t){for(var i of t.childNodes)i.nodeType===b.Element&&"Fermata"===i.localName&&this.parseFermata(e,i)}parseFermata(e,t){let i=0;var s,a=new tt;for(s of t.childNodes)if(s.nodeType===b.Element)switch(s.localName){case"Type":switch(s.innerText){case"Short":a.type=te.Short;break;case"Medium":a.type=te.Medium;break;case"Long":a.type=te.Long}break;case"Length":a.length=parseFloat(s.innerText);break;case"Offset":var r,n=s.innerText.split("/");2===n.length&&(r=parseInt(n[0]),n=parseInt(n[1]),i=r/n*p.QuarterTime|0)}e.addFermata(i,a)}parseBars(e){for(var t of e.childNodes)t.nodeType===b.Element&&"Bar"===t.localName&&this.parseBar(t)}parseBar(e){var t,i=new be,s=e.getAttribute("id");for(t of e.childNodes)if(t.nodeType===b.Element)switch(t.localName){case"Voices":this._voicesOfBar.set(s,t.innerText.split(" "));break;case"Clef":switch(t.innerText){case"Neutral":i.clef=c.Neutral;break;case"G2":i.clef=c.G2;break;case"F4":i.clef=c.F4;break;case"C4":i.clef=c.C4;break;case"C3":i.clef=c.C3}break;case"Ottavia":switch(t.innerText){case"8va":i.clefOttava=W._8va;break;case"15ma":i.clefOttava=W._15ma;break;case"8vb":i.clefOttava=W._8vb;break;case"15mb":i.clefOttava=W._15mb}break;case"SimileMark":switch(t.innerText){case"Simple":i.simileMark=r.Simple;break;case"FirstOfDouble":i.simileMark=r.FirstOfDouble;break;case"SecondOfDouble":i.simileMark=r.SecondOfDouble}}this._barsById.set(s,i)}parseVoices(e){for(var t of e.childNodes)t.nodeType===b.Element&&"Voice"===t.localName&&this.parseVoice(t)}parseVoice(e){var t,i=new Ye,s=e.getAttribute("id");for(t of e.childNodes)t.nodeType===b.Element&&"Beats"===t.localName&&this._beatsOfVoice.set(s,t.innerText.split(" "));this._voiceById.set(s,i)}parseBeats(e){for(var t of e.childNodes)t.nodeType===b.Element&&"Beat"===t.localName&&this.parseBeat(t)}parseBeat(e){var t,i=new Me,s=e.getAttribute("id");for(t of e.childNodes)if(t.nodeType===b.Element)switch(t.localName){case"Notes":this._notesOfBeat.set(s,t.innerText.split(" "));break;case"Rhythm":this._rhythmOfBeat.set(s,t.getAttribute("ref"));break;case"Fadding":"FadeIn"===t.innerText&&(i.fadeIn=!0);break;case"Tremolo":switch(t.innerText){case"1/2":i.tremoloSpeed=x.Eighth;break;case"1/4":i.tremoloSpeed=x.Sixteenth;break;case"1/8":i.tremoloSpeed=x.ThirtySecond}break;case"Chord":i.chordId=t.innerText;break;case"Hairpin":switch(t.innerText){case"Crescendo":i.crescendo=X.Crescendo;break;case"Decrescendo":i.crescendo=X.Decrescendo}break;case"Arpeggio":"Up"===t.innerText?i.brushType=U.ArpeggioUp:i.brushType=U.ArpeggioDown;break;case"Properties":this.parseBeatProperties(t,i);break;case"XProperties":this.parseBeatXProperties(t,i);break;case"FreeText":i.text=t.innerText;break;case"TransposedPitchStemOrientation":switch(t.innerText){case"Upward":i.preferredBeamDirection=E.Up;break;case"Downward":i.preferredBeamDirection=E.Down}break;case"Dynamic":switch(t.innerText){case"PPP":i.dynamics=l.PPP;break;case"PP":i.dynamics=l.PP;break;case"P":i.dynamics=l.P;break;case"MP":i.dynamics=l.MP;break;case"MF":i.dynamics=l.MF;break;case"F":i.dynamics=l.F;break;case"FF":i.dynamics=l.FF;break;case"FFF":i.dynamics=l.FFF}break;case"GraceNotes":switch(t.innerText){case"OnBeat":i.graceType=_.OnBeat;break;case"BeforeBeat":i.graceType=_.BeforeBeat}break;case"Legato":"true"===t.getAttribute("origin")&&(i.isLegatoOrigin=!0);break;case"Whammy":var a=new B(0,0),a=(a.value=this.toBendValue(parseFloat(t.getAttribute("originValue"))),a.offset=this.toBendOffset(parseFloat(t.getAttribute("originOffset"))),i.addWhammyBarPoint(a),new B(0,0)),a=(a.value=this.toBendValue(parseFloat(t.getAttribute("middleValue"))),a.offset=this.toBendOffset(parseFloat(t.getAttribute("middleOffset1"))),i.addWhammyBarPoint(a),new B(0,0)),a=(a.value=this.toBendValue(parseFloat(t.getAttribute("middleValue"))),a.offset=this.toBendOffset(parseFloat(t.getAttribute("middleOffset2"))),i.addWhammyBarPoint(a),new B(0,0));a.value=this.toBendValue(parseFloat(t.getAttribute("destinationValue"))),a.offset=this.toBendOffset(parseFloat(t.getAttribute("destinationOffset"))),i.addWhammyBarPoint(a);break;case"Ottavia":switch(t.innerText){case"8va":i.ottava=W._8va;break;case"8vb":i.ottava=W._8vb;break;case"15ma":i.ottava=W._15ma;break;case"15mb":i.ottava=W._15mb}break;case"Lyrics":i.lyrics=this.parseBeatLyrics(t),this._skipApplyLyrics=!0}this._beatById.set(s,i)}parseBeatLyrics(e){var t,i=[];for(t of e.childNodes)t.nodeType===b.Element&&"Line"===t.localName&&i.push(t.innerText);return i}parseBeatXProperties(e,t){for(var i of e.childNodes)if(i.nodeType===b.Element&&"XProperty"===i.localName){let e=0;switch(i.getAttribute("id")){case"1124204545":e=parseInt(i.findChildElement("Int").innerText),t.invertBeamDirection=1===e;break;case"687935489":e=parseInt(i.findChildElement("Int").innerText),t.brushDuration=e}}}parseBeatProperties(e,t){let i=!1,s=null,a=null,r=null,n=null,o=null;for(var h of e.childNodes)if(h.nodeType===b.Element)if("Property"===h.localName)switch(h.getAttribute("name")){case"Brush":"Up"===h.findChildElement("Direction").innerText?t.brushType=U.BrushUp:t.brushType=U.BrushDown;break;case"PickStroke":"Up"===h.findChildElement("Direction").innerText?t.pickStroke=j.Up:t.pickStroke=j.Down;break;case"Slapped":h.findChildElement("Enable")&&(t.slap=!0);break;case"Popped":h.findChildElement("Enable")&&(t.pop=!0);break;case"VibratoWTremBar":switch(h.findChildElement("Strength").innerText){case"Wide":t.vibrato=J.Wide;break;case"Slight":t.vibrato=J.Slight}break;case"WhammyBar":i=!0;break;case"WhammyBarExtend":break;case"WhammyBarOriginValue":(s=s||new B(0,0)).value=this.toBendValue(parseFloat(h.findChildElement("Float").innerText));break;case"WhammyBarOriginOffset":(s=s||new B(0,0)).offset=this.toBendOffset(parseFloat(h.findChildElement("Float").innerText));break;case"WhammyBarMiddleValue":a=this.toBendValue(parseFloat(h.findChildElement("Float").innerText));break;case"WhammyBarMiddleOffset1":r=this.toBendOffset(parseFloat(h.findChildElement("Float").innerText));break;case"WhammyBarMiddleOffset2":n=this.toBendOffset(parseFloat(h.findChildElement("Float").innerText));break;case"WhammyBarDestinationValue":(o=o||new B(B.MaxPosition,0)).value=this.toBendValue(parseFloat(h.findChildElement("Float").innerText));break;case"WhammyBarDestinationOffset":(o=o||new B(0,0)).offset=this.toBendOffset(parseFloat(h.findChildElement("Float").innerText))}i&&(s=s||new B(0,0),o=o||new B(B.MaxPosition,0),t.addWhammyBarPoint(s),r&&a&&t.addWhammyBarPoint(new B(r,a)),n&&a&&t.addWhammyBarPoint(new B(n,a)),r||n||!a||t.addWhammyBarPoint(new B(B.MaxPosition/2|0,a)),t.addWhammyBarPoint(o))}parseNotes(e){for(var t of e.childNodes)t.nodeType===b.Element&&"Note"===t.localName&&this.parseNote(t)}parseNote(e){var t,i=new Ne,s=e.getAttribute("id");for(t of e.childNodes)if(t.nodeType===b.Element)switch(t.localName){case"Properties":this.parseNoteProperties(t,i,s);break;case"AntiAccent":"normal"===t.innerText.toLowerCase()&&(i.isGhost=!0);break;case"LetRing":i.isLetRing=!0;break;case"Trill":i.trillValue=parseInt(t.innerText),i.trillSpeed=x.Sixteenth;break;case"Accent":var a=parseInt(t.innerText);0!=(1&a)&&(i.isStaccato=!0),0!=(4&a)&&(i.accentuated=H.Heavy),0!=(8&a)&&(i.accentuated=H.Normal);break;case"Tie":"true"===t.getAttribute("destination").toLowerCase()&&(i.isTieDestination=!0);break;case"Vibrato":switch(t.innerText){case"Slight":i.vibrato=J.Slight;break;case"Wide":i.vibrato=J.Wide}break;case"LeftFingering":switch(i.isFingering=!0,t.innerText){case"P":i.leftHandFinger=v.Thumb;break;case"I":i.leftHandFinger=v.IndexFinger;break;case"M":i.leftHandFinger=v.MiddleFinger;break;case"A":i.leftHandFinger=v.AnnularFinger;break;case"C":i.leftHandFinger=v.LittleFinger}break;case"RightFingering":switch(i.isFingering=!0,t.innerText){case"P":i.rightHandFinger=v.Thumb;break;case"I":i.rightHandFinger=v.IndexFinger;break;case"M":i.rightHandFinger=v.MiddleFinger;break;case"A":i.rightHandFinger=v.AnnularFinger;break;case"C":i.rightHandFinger=v.LittleFinger}break;case"InstrumentArticulation":i.percussionArticulation=parseInt(t.innerText)}this._noteById.set(s,i)}parseNoteProperties(e,t,i){let s=!1,a=null,r=null,n=null,o=null,h=null,l=-1,d=-1;for(var c of e.childNodes)if(c.nodeType===b.Element)if("Property"===c.localName)switch(c.getAttribute("name")){case"String":t.string=parseInt(c.findChildElement("String").innerText)+1;break;case"Fret":t.fret=parseInt(c.findChildElement("Fret").innerText);break;case"Element":l=parseInt(c.findChildElement("Element").innerText);break;case"Variation":d=parseInt(c.findChildElement("Variation").innerText);break;case"Tapped":this._tappedNotes.set(i,!0);break;case"HarmonicType":var u=c.findChildElement("HType");if(u)switch(u.innerText){case"NoHarmonic":t.harmonicType=g.None;break;case"Natural":t.harmonicType=g.Natural;break;case"Artificial":t.harmonicType=g.Artificial;break;case"Pinch":t.harmonicType=g.Pinch;break;case"Tap":t.harmonicType=g.Tap;break;case"Semi":t.harmonicType=g.Semi;break;case"Feedback":t.harmonicType=g.Feedback}break;case"HarmonicFret":u=c.findChildElement("HFret");u&&(t.harmonicValue=parseFloat(u.innerText));break;case"Muted":c.findChildElement("Enable")&&(t.isDead=!0);break;case"PalmMuted":c.findChildElement("Enable")&&(t.isPalmMute=!0);break;case"Octave":t.octave=parseInt(c.findChildElement("Number").innerText),-1===t.tone&&(t.tone=0);break;case"Tone":t.tone=parseInt(c.findChildElement("Step").innerText);break;case"ConcertPitch":this.parseConcertPitch(c,t);break;case"Bended":s=!0;break;case"BendOriginValue":(a=a||new B(0,0)).value=this.toBendValue(parseFloat(c.findChildElement("Float").innerText));break;case"BendOriginOffset":(a=a||new B(0,0)).offset=this.toBendOffset(parseFloat(c.findChildElement("Float").innerText));break;case"BendMiddleValue":r=this.toBendValue(parseFloat(c.findChildElement("Float").innerText));break;case"BendMiddleOffset1":n=this.toBendOffset(parseFloat(c.findChildElement("Float").innerText));break;case"BendMiddleOffset2":o=this.toBendOffset(parseFloat(c.findChildElement("Float").innerText));break;case"BendDestinationValue":(h=h||new B(B.MaxPosition,0)).value=this.toBendValue(parseFloat(c.findChildElement("Float").innerText));break;case"BendDestinationOffset":(h=h||new B(0,0)).offset=this.toBendOffset(parseFloat(c.findChildElement("Float").innerText));break;case"HopoOrigin":c.findChildElement("Enable")&&(t.isHammerPullOrigin=!0);break;case"HopoDestination":break;case"LeftHandTapped":t.isLeftHandTapped=!0;break;case"Slide":var p=parseInt(c.findChildElement("Flags").innerText);0!=(1&p)?t.slideOutType=m.Shift:0!=(2&p)?t.slideOutType=m.Legato:0!=(4&p)?t.slideOutType=m.OutDown:0!=(8&p)&&(t.slideOutType=m.OutUp),0!=(16&p)?t.slideInType=q.IntoFromBelow:0!=(32&p)&&(t.slideInType=q.IntoFromAbove),0!=(64&p)?t.slideOutType=m.PickSlideDown:0!=(128&p)&&(t.slideOutType=m.PickSlideUp)}s&&(a=a||new B(0,0),h=h||new B(B.MaxPosition,0),t.addBendPoint(a),n&&r&&t.addBendPoint(new B(n,r)),o&&r&&t.addBendPoint(new B(o,r)),n||o||!r||t.addBendPoint(new B(B.MaxPosition/2|0,r)),t.addBendPoint(h)),-1!==l&&-1!==d&&(t.percussionArticulation=Te.articulationFromElementVariation(l,d))}parseConcertPitch(e,t){e=e.findChildElement("Pitch");if(e)for(var i of e.childNodes)if(i.nodeType===b.Element&&"Accidental"===i.localName)switch(i.innerText){case"x":t.accidentalMode=Y.ForceDoubleSharp;break;case"#":t.accidentalMode=Y.ForceSharp;break;case"b":t.accidentalMode=Y.ForceFlat;break;case"bb":t.accidentalMode=Y.ForceDoubleFlat}}toBendValue(e){return e*ht.BendPointValueFactor|0}toBendOffset(e){return e*ht.BendPointPositionFactor}parseRhythms(e){for(var t of e.childNodes)t.nodeType===b.Element&&"Rhythm"===t.localName&&this.parseRhythm(t)}parseRhythm(e){var t,i=new nt,s=e.getAttribute("id");i.id=s;for(t of e.childNodes)if(t.nodeType===b.Element)switch(t.localName){case"NoteValue":switch(t.innerText){case"Long":i.value=x.QuadrupleWhole;break;case"DoubleWhole":i.value=x.DoubleWhole;break;case"Whole":i.value=x.Whole;break;case"Half":i.value=x.Half;break;case"Quarter":i.value=x.Quarter;break;case"Eighth":i.value=x.Eighth;break;case"16th":i.value=x.Sixteenth;break;case"32nd":i.value=x.ThirtySecond;break;case"64th":i.value=x.SixtyFourth;break;case"128th":i.value=x.OneHundredTwentyEighth;break;case"256th":i.value=x.TwoHundredFiftySixth}break;case"PrimaryTuplet":i.tupletNumerator=parseInt(t.getAttribute("num")),i.tupletDenominator=parseInt(t.getAttribute("den"));break;case"AugmentationDot":i.dots=parseInt(t.getAttribute("count"))}this._rhythmById.set(s,i)}buildModel(){for(let e=0,t=this._masterBars.length;e<t;e++){var i=this._masterBars[e];this.score.addMasterBar(i)}for(var e of this._tracksMapping)e&&(e=this._tracksById.get(e),this.score.addTrack(e));for(var s of this._barsOfMasterBar){let i=0;for(let e=0,t=0;e<s.length&&t<this.score.tracks.length;e++){var a=s[e];if(a!==ht.InvalidId){var r=this._barsById.get(a),n=this.score.tracks[t],o=n.staves[i];if(o.addBar(r),this._voicesOfBar.has(a))for(var h of this._voicesOfBar.get(a))if(h!==ht.InvalidId){var l=this._voiceById.get(h);if(r.addVoice(l),this._beatsOfVoice.has(h))for(var d of this._beatsOfVoice.get(h))if(d!==ht.InvalidId){var c,u=Fe.clone(this._beatById.get(d)),p=(l.addBeat(u),this._rhythmOfBeat.get(d)),p=this._rhythmById.get(p);if(u.duration=p.value,u.dots=p.dots,u.tupletNumerator=p.tupletNumerator,u.tupletDenominator=p.tupletDenominator,this._notesOfBeat.has(d))for(var g of this._notesOfBeat.get(d))g!==ht.InvalidId&&(c=Ee.clone(this._noteById.get(g)),o.isPercussion?(c.fret=-1,c.string=-1):c.percussionArticulation=-1,u.addNote(c),this._tappedNotes.has(g))&&(u.tap=!0)}}else{var h=new Ye,m=(r.addVoice(h),new Me);m.isEmpty=!0,m.duration=x.Quarter,h.addBeat(m)}i===n.staves.length-1?(t++,i=0):i++}else t++}}for(var t of this._tracksMapping)if(t){var f,y,b=this._tracksById.get(t);let e=!1;for(const k of b.staves)if(k.isPercussion){e=!0;break}if(e||(b.percussionArticulations=[]),this._automationsPerTrackIdAndBarIndex.has(t))for([f,y]of this._automationsPerTrackIdAndBarIndex.get(t))if(0<b.staves.length&&f<b.staves[0].bars.length){var S=b.staves[0].bars[f];if(0<S.voices.length&&0<S.voices[0].beats.length){var _=S.voices[0].beats[0];for(const N of y)_.automations.push(N)}}}for(var[w,v]of this._masterTrackAutomations){var B=this.score.masterBars[w];for(let e=0,t=v.length;e<t;e++){var T=v[e];T.type===V.Tempo&&(0===w&&(this.score.tempo=0|T.value,T.text)&&(this.score.tempoLabel=T.text),B.tempoAutomation=T)}}}}ht.InvalidId="-1",ht.BendPointPositionFactor=B.MaxPosition/100,ht.BendPointValueFactor=.04;class lt{constructor(){this.showSlash=!1,this.showStandardNotation=!1,this.showTablature=!1}}class dt{constructor(){this.isMultiRest=!1,this.tracks=[]}}class ct{constructor(e){this.parts=[],this.zoomLevel=0,this.layout=0;var t=qe.fromBuffer(e),i=L.readInt32BE(t);for(let e=0;e<i;e++){var s=new dt,a=(this.parts.push(s),s.isMultiRest=Ke.gpReadBool(t),L.readInt32BE(t));for(let e=0;e<a;e++){let e=t.readByte();0===e&&(e=1);var r=new lt;r.showStandardNotation=0!=(1&e),r.showTablature=0!=(2&e),r.showSlash=0!=(4&e),s.tracks.push(r)}}}apply(e){let t=0,i=0;for(var s of this.parts)for(var a of s.tracks){var r;i<e.tracks.length&&(r=e.tracks[i],t<r.staves.length)&&((r=r.staves[t]).showTablature=a.showTablature,r.showStandardNotation=a.showStandardNotation),++i>=e.tracks.length&&(t++,i=0)}}static writeForScore(e){var t=qe.withCapacity(128),i=[new dt];for(const r of e.tracks)for(const n of r.staves){var s,a=new lt;a.showStandardNotation=n.showStandardNotation,a.showTablature=n.showTablature,0===n.index?i[0].tracks.push(a):((s=new dt).tracks.push(a),i.push(s))}L.writeInt32BE(t,i.length);for(const o of i){t.writeByte(o.isMultiRest?1:0),L.writeInt32BE(t,o.tracks.length);for(const h of o.tracks){let e=0;h.showStandardNotation&&(e|=1),h.showTablature&&(e|=2),h.showSlash&&(e|=4),t.writeByte(e)}}return t.toArray()}}class ut{}class pt extends ut{constructor(e){super(),this.n=e}}class gt extends ut{constructor(e,t){super(),this.left=e,this.right=t}}class mt extends ut{constructor(e,t){super(),this.n=e,this.table=t}}class ft{static make(t,i,s,a){var r=[],n=[];if(32<a)throw new Ve("Invalid huffman");for(let e=0;e<a;e++)r.push(0),n.push(0);for(let e=0;e<s;e++){var o=t[e+i];if(a<=o)throw new Ve("Invalid huffman");r[o]++}let h=0;for(let e=1;e<a-1;e++)h=h+r[e]<<1,n[e]=h;var l=new Map;for(let e=0;e<s;e++){var d,c=t[e+i];0!==c&&(n[c-1]=(d=n[c-1])+1,l.set(d<<5|c,e))}return ft.treeCompress(new gt(ft.treeMake(l,a,0,1),ft.treeMake(l,a,1,1)))}static treeMake(e,t,i,s){if(t<s)throw new Ve("Invalid huffman");var a=i<<5|s;return e.has(a)?new pt(e.get(a)):(i<<=1,s+=1,new gt(ft.treeMake(e,t,i,s),ft.treeMake(e,t,1|i,s)))}static treeCompress(e){var t=ft.treeDepth(e);if(0===t)return e;if(1===t){if(e instanceof gt)return new gt(ft.treeCompress(e.left),ft.treeCompress(e.right));throw new Ve("assert")}var i=1<<t,s=[];for(let e=0;e<i;e++)s.push(new pt(-1));return ft.treeWalk(s,0,0,t,e),new mt(t,s)}static treeWalk(e,t,i,s,a){a instanceof gt&&0<s?(ft.treeWalk(e,t,i+1,s-1,a.left),ft.treeWalk(e,t|1<<i,i+1,s-1,a.right)):e[t]=ft.treeCompress(a)}static treeDepth(e){if(e instanceof pt)return 0;if(e instanceof mt)throw new Ve("assert");var t;return e instanceof gt?1+((t=ft.treeDepth(e.left))<(e=ft.treeDepth(e.right))?t:e):0}}(e=ie=ie||{})[e.Head=0]="Head",e[e.Block=1]="Block",e[e.CData=2]="CData",e[e.Flat=3]="Flat",e[e.Crc=4]="Crc",e[e.Dist=5]="Dist",e[e.DistOne=6]="DistOne",e[e.Done=7]="Done";class yt{constructor(){this.buffer=new Uint8Array(yt.BufferSize),this.pos=0}slide(){var e=new Uint8Array(yt.BufferSize);this.pos-=yt.Size,e.set(this.buffer.subarray(yt.Size,yt.Size+this.pos),0),this.buffer=e}addBytes(e,t,i){this.pos+i>yt.BufferSize&&this.slide(),this.buffer.set(e.subarray(t,t+i),this.pos),this.pos+=i}addByte(e){this.pos===yt.BufferSize&&this.slide(),this.buffer[this.pos]=e,this.pos++}getLastChar(){return this.buffer[this.pos-1]}available(){return this.pos}}yt.Size=32768,yt.BufferSize=65536;class bt{constructor(e){this._nbits=0,this._bits=0,this._state=ie.Block,this._isFinal=!1,this._huffman=bt._fixedHuffman,this._huffdist=null,this._len=0,this._dist=0,this._needed=0,this._output=null,this._outpos=0,this._lengths=[],this._window=new yt,this._input=e;for(let e=0;e<19;e++)this._lengths.push(-1)}static buildFixedHuffman(){var t=[];for(let e=0;e<288;e++)t.push(e<=143?8:e<=255?9:e<=279?7:8);return ft.make(t,0,288,10)}readBytes(e,t,i){if(this._needed=i,this._outpos=t,this._output=e,0<i)for(;this.inflateLoop(););return i-this._needed}inflateLoop(){switch(this._state){case ie.Head:var e=this._input.readByte();if(8!=(15&e))throw new Ve("Invalid data");var t=this._input.readByte(),i=0!=(32&t);if(((e<<8)+t)%31!=0)throw new Ve("Invalid data");if(i)throw new Ve("Unsupported dictionary");return this._state=ie.Block,!0;case ie.Crc:return this._state=ie.Done,!0;case ie.Done:return!1;case ie.Block:switch(this._isFinal=this.getBit(),this.getBits(2)){case 0:if(this._len=L.readUInt16LE(this._input),L.readUInt16LE(this._input)!==65535-this._len)throw new Ve("Invalid data");this._state=ie.Flat;var s=this.inflateLoop();return this.resetBits(),s;case 1:return this._huffman=bt._fixedHuffman,this._huffdist=null,this._state=ie.CData,!0;case 2:var a=this.getBits(5)+257,r=this.getBits(5)+1,n=this.getBits(4)+4;for(let e=0;e<n;e++)this._lengths[bt.CodeLengthsPos[e]]=this.getBits(3);for(let e=n;e<19;e++)this._lengths[bt.CodeLengthsPos[e]]=0;this._huffman=ft.make(this._lengths,0,19,8);var o=[];for(let e=0;e<a+r;e++)o.push(0);return this.inflateLengths(o,a+r),this._huffdist=ft.make(o,a,r,16),this._huffman=ft.make(o,0,a,16),this._state=ie.CData,!0;default:throw new Ve("Invalid data")}case ie.Flat:e=this._len<this._needed?this._len:this._needed,t=L.readByteArray(this._input,e);return this._len-=e,this.addBytes(t,0,e),0===this._len&&(this._state=this._isFinal?ie.Crc:ie.Block),0<this._needed;case ie.DistOne:i=this._len<this._needed?this._len:this._needed;return this.addDistOne(i),this._len-=i,0===this._len&&(this._state=ie.CData),0<this._needed;case ie.Dist:for(;0<this._len&&0<this._needed;){var h=this._len<this._dist?this._len:this._dist,h=this._needed<h?this._needed:h;this.addDist(this._dist,h),this._len-=h}return 0===this._len&&(this._state=ie.CData),0<this._needed;case ie.CData:if((t=this.applyHuffman(this._huffman))<256)return this.addByte(t),0<this._needed;if(256===t)this._state=this._isFinal?ie.Crc:ie.Block;else{t=t-257&255,e=bt.LenExtraBitsTbl[t];if(-1===e)throw new Ve("Invalid data");this._len=bt.LenBaseValTbl[t]+this.getBits(e);i=this._huffdist,t=i?this.applyHuffman(i):this.getRevBits(5);if(-1===(e=bt.DistExtraBitsTbl[t]))throw new Ve("Invalid data");if(this._dist=bt.DistBaseValTbl[t]+this.getBits(e),this._dist>this._window.available())throw new Ve("Invalid data");this._state=1===this._dist?ie.DistOne:ie.Dist}return!0}return!1}addDistOne(t){var i=this._window.getLastChar();for(let e=0;e<t;e++)this.addByte(i)}addByte(e){this._window.addByte(e),this._output[this._outpos]=e,this._needed--,this._outpos++}addDist(e,t){this.addBytes(this._window.buffer,this._window.pos-e,t)}getBit(){0===this._nbits&&(this._nbits=8,this._bits=this._input.readByte());var e=1==(1&this._bits);return this._nbits--,this._bits=this._bits>>1,e}getBits(e){for(;this._nbits<e;)this._bits=this._bits|this._input.readByte()<<this._nbits,this._nbits+=8;var t=this._bits&(1<<e)-1;return this._nbits-=e,this._bits=this._bits>>e,t}getRevBits(e){return 0===e?0:this.getBit()?1<<e-1|this.getRevBits(e-1):this.getRevBits(e-1)}resetBits(){this._bits=0,this._nbits=0}addBytes(e,t,i){this._window.addBytes(e,t,i),this._output.set(e.subarray(t,t+i),this._outpos),this._needed-=i,this._outpos+=i}inflateLengths(e,t){let i=0,s=0;for(;i<t;){var a=this.applyHuffman(this._huffman);switch(a){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:s=a,e[i]=a,i++;break;case 16:var r=i+3+this.getBits(2);if(t<r)throw new Ve("Invalid data");for(;i<r;)e[i]=s,i++;break;case 17:if((i+=3+this.getBits(3))>t)throw new Ve("Invalid data");break;case 18:if((i+=11+this.getBits(7))>t)throw new Ve("Invalid data");break;default:throw new Ve("Invalid data")}}}applyHuffman(e){if(e instanceof pt)return e.n;if(e instanceof gt)return this.applyHuffman(this.getBit()?e.right:e.left);if(e instanceof mt)return this.applyHuffman(e.table[this.getBits(e.n)]);throw new Ve("Invalid data")}}bt.LenExtraBitsTbl=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,-1,-1],bt.LenBaseValTbl=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258],bt.DistExtraBitsTbl=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,-1,-1],bt.DistBaseValTbl=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],bt.CodeLengthsPos=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],bt._fixedHuffman=bt.buildFixedHuffman();class St{constructor(e,t){var i=(this.fullName=e).lastIndexOf("/");this.fileName=-1===i||i===e.length-1?this.fullName:e.substr(i+1),this.data=t}}St.OptionalDataDescriptorSignature=134695760,St.CompressionMethodDeflate=8,St.LocalFileHeaderSignature=67324752,St.CentralFileHeaderSignature=33639248,St.EndOfCentralDirSignature=101010256;class _t{constructor(e){this._readable=e}read(){for(var e=[];;){var t=this.readEntry();if(!t)break;e.push(t)}return e}readEntry(){var e=this._readable;if(L.readInt32LE(e)!==St.LocalFileHeaderSignature)return null;L.readUInt16LE(e);var t=L.readUInt16LE(e),i=L.readUInt16LE(e),s=0!==i;if(s&&i!==St.CompressionMethodDeflate)return null;L.readInt16LE(this._readable),L.readInt16LE(this._readable),L.readInt32LE(e),L.readInt32LE(e);var i=L.readInt32LE(e),a=L.readInt16LE(e),r=L.readInt16LE(e),a=L.toString(L.readByteArray(e,a),"utf-8");e.skip(r);let n;if(s){for(var o=qe.empty(),h=new bt(this._readable),l=new Uint8Array(65536);;){var d=h.readBytes(l,0,l.length);if(o.write(l,0,d),d<l.length)break}n=o.toArray()}else n=L.readByteArray(this._readable,i);return 0!=(8&t)&&(L.readInt32LE(this._readable)===St.OptionalDataDescriptorSignature&&L.readInt32LE(this._readable),L.readInt32LE(this._readable),L.readInt32LE(this._readable)),new St(a,n)}}class wt extends ge{get name(){return"Guitar Pro 7"}constructor(){super()}readScore(){C.debug(this.name,"Loading ZIP entries");var e,t=new _t(this.data);let i;try{i=t.read()}catch(e){throw new fe("No Zip archive",e)}C.debug(this.name,"Zip entries loaded");let s=null,a=null,r=null;for(e of i)switch(e.fileName){case"score.gpif":s=L.toString(e.data,this.settings.importer.encoding);break;case"BinaryStylesheet":a=e.data;break;case"PartConfiguration":r=e.data}if(!s)throw new fe("No score.gpif found in zip archive");C.debug(this.name,"Start Parsing score.gpif");t=new ht,t.parseXml(s,this.settings),C.debug(this.name,"score.gpif parsed"),t=t.score;return a&&(C.debug(this.name,"Start Parsing BinaryStylesheet"),new et(a).apply(t),C.debug(this.name,"BinaryStylesheet parsed")),r&&(C.debug(this.name,"Start Parsing Part Configuration"),new ct(r).apply(t),C.debug(this.name,"Part Configuration parsed")),t}}class vt extends me{constructor(){super(T.AlphaTabErrorType.Format,"Unexpected end of data within reader"),Object.setPrototypeOf(this,vt.prototype)}}class Bt{constructor(e){this._currentByte=0,this._position=Bt.ByteSize,this._source=e}readByte(){return this.readBits(8)}readBytes(t){var i=new Uint8Array(t);for(let e=0;e<t;e++)i[e]=255&this.readByte();return i}readBits(e){let t=0,i=e-1;for(;0<=i;)t|=this.readBit()<<i,i--;return t}readBitsReversed(t){let i=0;for(let e=0;e<t;e++)i|=this.readBit()<<e;return i}readBit(){if(8<=this._position){if(this._currentByte=this._source.readByte(),-1===this._currentByte)throw new vt;this._position=0}var e=this._currentByte>>Bt.ByteSize-this._position-1&1;return this._position++,e}readAll(){var e=qe.empty();try{for(;;)e.writeByte(255&this.readByte())}catch(e){if(!(e instanceof vt))throw e}return e.toArray()}}Bt.ByteSize=8;class Tt{constructor(){this.fileName="",this.fileSize=0,this.data=null}}class kt{constructor(){this.files=[],this.files=[],this.fileFilter=e=>!0}load(e){e=new Bt(e);this.readBlock(e)}readHeader(e){return this.getString(e.readBytes(4),0,4)}decompress(t,e=!1){var i=qe.empty();let s;var a=this.getInteger(t.readBytes(4),0);try{for(;i.length<a;)if(1===t.readBits(1)){var r=t.readBits(4),n=t.readBitsReversed(r),o=t.readBitsReversed(r),h=i.length-n,l=Math.min(n,o);s=i.getBuffer(),i.write(s,h,l)}else{var d=t.readBitsReversed(2);for(let e=0;e<d;e++)i.writeByte(t.readByte())}}catch(e){if(!(e instanceof vt))throw e}s=i.getBuffer();var e=e?4:0,c=i.length-e,u=new Uint8Array(c);return u.set(s.subarray(e,e+c),0),u}readBlock(e){var t=this.readHeader(e);if("BCFZ"===t)this.readUncompressedBlock(this.decompress(e,!0));else{if("BCFS"!==t)throw new fe("Unsupported format");this.readUncompressedBlock(e.readAll())}}readUncompressedBlock(t){let i=4096;for(;i+3<t.length;){if(2===this.getInteger(t,i)){var s,a=new Tt,r=(a.fileName=this.getString(t,i+4,127),a.fileSize=this.getInteger(t,i+140),!this.fileFilter||this.fileFilter(a.fileName)),n=(r&&this.files.push(a),i+148);let e=0;for(var o,h=r?qe.withCapacity(a.fileSize):null;;){if(0===(s=this.getInteger(t,n+4*e++)))break;i=4096*s,r&&h.write(t,i,4096)}r&&(a.data=new Uint8Array(Math.min(a.fileSize,h.length)),o=h.toArray(),a.data.set(o.subarray(0,0+a.data.length),0))}i+=4096}}getString(t,i,s){let a="";for(let e=0;e<s;e++){var r=255&t[i+e];if(0==r)break;a+=String.fromCharCode(r)}return a}getInteger(e,t){return e[t+3]<<24|e[t+2]<<16|e[t+1]<<8|e[t]}}kt.HeaderBcFs="BCFS",kt.HeaderBcFz="BCFZ",kt.ScoreGpif="score.gpif",kt.BinaryStylesheet="BinaryStylesheet",kt.PartConfiguration="PartConfiguration";class Nt extends ge{get name(){return"Guitar Pro 6"}constructor(){super()}readScore(){C.debug(this.name,"Loading GPX filesystem");var e,t=new kt;t.fileFilter=e=>e.endsWith("score.gpif")||e.endsWith("BinaryStylesheet")||e.endsWith("PartConfiguration"),t.load(this.data),C.debug(this.name,"GPX filesystem loaded");let i=null,s=null,a=null;for(e of t.files)switch(e.fileName){case"score.gpif":i=L.toString(e.data,this.settings.importer.encoding);break;case"BinaryStylesheet":s=e.data;break;case"PartConfiguration":a=e.data}if(!i)throw new fe("No score.gpif found in GPX");C.debug(this.name,"Start Parsing score.gpif");t=new ht,t.parseXml(i,this.settings),C.debug(this.name,"score.gpif parsed"),t=t.score;return s&&(C.debug(this.name,"Start Parsing BinaryStylesheet"),new et(s).apply(t),C.debug(this.name,"BinaryStylesheet parsed")),a&&(C.debug(this.name,"Start Parsing Part Configuration"),new ct(a).apply(t),C.debug(this.name,"Part Configuration parsed")),t}}class xt extends ge{constructor(){super(),this._currentPartGroup=null,this._trackFirstMeasureNumber=0,this._maxVoices=0,this._currentDirection=null,this._currentChord=null,this._divisionsPerQuarterNote=0,this._voiceOfStaff=new Map,this._isBeamContinue=!1,this._previousBeatWasPulled=!1,this._previousBeat=null}get name(){return"MusicXML"}readScore(){this._trackById=new Map,this._partGroups=new Map,this._tieStarts=[],this._tieStartIds=new Map,this._slurStarts=new Map;var e=L.toString(this.data.readAll(),this.settings.importer.encoding),t=new rt;try{t.parse(e)}catch(e){throw new fe("Unsupported format")}return this._score=new Ge,this._score.tempo=120,this.parseDom(t),this.settings.importer.mergePartGroupsInMusicXml&&this.mergePartGroups(),this._score.finish(this.settings),this._score.rebuildRepeatGroups(),this._score}mergePartGroups(){let e=!1;for(const t of this._partGroups.values())1<t.length&&(this.mergeGroup(t),e=!0);if(e)for(let e=0;e<this._score.tracks.length;e++)this._score.tracks[e].index=e}mergeGroup(t){var i=t[0];for(let e=1;e<t.length;e++){var s,a=t[e];for(s of a.staves)i.addStaff(s);a=this._score.tracks.indexOf(a);this._score.tracks.splice(a,1)}}parseDom(e){var t=e.firstElement;if(!t)throw new fe("Unsupported format");switch(t.localName){case"score-partwise":this.parsePartwise(t);break;case"score-timewise":break;default:throw new fe("Unsupported format")}}parsePartwise(e){for(var t of e.childNodes)if(t.nodeType===b.Element)switch(t.localName){case"work":this.parseWork(t);break;case"movement-title":this._score.title=t.innerText;break;case"identification":this.parseIdentification(t);break;case"part-list":this.parsePartList(t);break;case"part":this.parsePart(t)}}parseWork(e){for(var t of e.childNodes)t.nodeType===b.Element&&"work-title"===t.localName&&(this._score.title=t.innerText)}parsePart(e){let t=e.getAttribute("id");if(!this._trackById.has(t)){if(1!==this._trackById.size)return;for(var[i,s]of this._trackById)0!==s.staves.length&&0!==s.staves[0].bars.length||(t=i);if(!this._trackById.has(t))return}var a,r,n=this._trackById.get(t);let o=!0;this._maxVoices=0;for(a of e.childNodes)a.nodeType===b.Element&&"measure"===a.localName&&this.parseMeasure(a,n,o)&&(o=!1);for(r of n.staves)for(var h of r.bars)this.ensureVoices(h)}parseMeasure(t,i,e){if("yes"===t.getAttribute("implicit")&&0===t.getElementsByTagName("note",!1).length)return!1;let s=0;if(e)this._divisionsPerQuarterNote=0,this._trackFirstMeasureNumber=parseInt(t.getAttribute("number")),this._trackFirstMeasureNumber||(this._trackFirstMeasureNumber=0),s=0;else{if(!(s=parseInt(t.getAttribute("number"))))return!1;s-=this._trackFirstMeasureNumber}e&&0<(e=t.getElementsByTagName("attributes",!1)).length&&0<(e=e[0].getElementsByTagName("staves",!1)).length&&(e=parseInt(e[0].innerText),i.ensureStaveCount(e));var a=new Array(i.staves.length);let r=null;for(let e=i.staves[0].bars.length;e<=s;e++)for(let e=0;e<i.staves.length;e++){var n,o=new be;a[e]=o,0<i.staves[e].bars.length&&(n=i.staves[e].bars[i.staves[e].bars.length-1],o.clef=n.clef),r=this.getOrCreateMasterBar(s),i.staves[e].addBar(o),this.ensureVoices(o)}if(r){let e=!1;for(var h of t.childNodes)if(h.nodeType===b.Element)switch(h.localName){case"note":this.parseNoteBeat(h,a);break;case"forward":this.parseForward(h,a);break;case"direction":this.parseDirection(h,r);break;case"attributes":e||(this.parseAttributes(h,a,r,i),e=!0);break;case"harmony":this.parseHarmony(h,i);break;case"sound":break;case"barline":this.parseBarline(h,r)}}return!0}ensureVoices(e){for(;e.voices.length<this._maxVoices;){var t=new Ye,i=(e.addVoice(t),new Me);i.isEmpty=!0,i.chordId=this._currentChord,t.addBeat(i)}}getOrCreateBeat(e,t,i){let s=0;var a=e.getElementsByTagName("voice",!1),a=(0<a.length&&(s=parseInt(a[0].innerText)-1),this._previousBeatWasPulled),e=(this._previousBeatWasPulled=!1,e.getElementsByTagName("staff",!1));let r=1;0<e.length&&(r=parseInt(e[0].innerText),(this._isBeamContinue||a)&&this._previousBeat.voice.bar.staff.index!==r-1&&(r=this._previousBeat.voice.bar.staff.index+1,this._previousBeatWasPulled=!0),e=t[0].staff.track.index+"-"+r,this._voiceOfStaff.has(e)||this._voiceOfStaff.set(e,s)),r--;let n;n=r<0?t[0]:r>=t.length?t[t.length-1]:t[r];let o;a=this.getOrCreateVoice(n,s);return i&&0<a.beats.length||1===a.beats.length&&a.isEmpty?o=a.beats[a.beats.length-1]:((o=new Me).isEmpty=!1,a.addBeat(o)),this._isBeamContinue=!1,this._previousBeat=o}parseForward(e,t){var i,s=this.getOrCreateBeat(e,t,!1);let a=parseInt(e.findChildElement("duration").innerText)*x.Quarter/this._divisionsPerQuarterNote;for(i of[x.SixtyFourth,x.ThirtySecond,x.Sixteenth,x.Eighth,x.Quarter,x.Half,x.Whole])if(a>=i){s.duration=i,a-=i;break}s.isEmpty=!1}parseStaffDetails(e,t){for(var i of e.childNodes)if(i.nodeType===b.Element)switch(i.localName){case"staff-lines":for(var s of t.staves)s.stringTuning.tunings=new Array(parseInt(i.innerText)).fill(0);break;case"staff-tuning":this.parseStaffTuning(i,t)}for(var a of t.staves)this.isEmptyTuning(a.tuning)&&(a.stringTuning.tunings=[])}parseStaffTuning(e,t){var i,s=parseInt(e.getAttribute("line"));let a="C",r="",n=0;for(i of e.childNodes)if(i.nodeType===b.Element)switch(i.localName){case"tuning-step":a=i.innerText;break;case"tuning-alter":n=parseInt(i.innerText);break;case"tuning-octave":r=i.innerText}var o,h=Be.getTuningForText(a+r)+n;for(o of t.staves)o.tuning[o.tuning.length-s]=h}parseHarmony(e,t){let i=null,s="";for(var a of e.childNodes)if(a.nodeType===b.Element&&"root"===a.localName)for(var r of a.childNodes)if(r.nodeType===b.Element)switch(r.localName){case"root-step":i=r.innerText;break;case"root-alter":switch(parseInt(a.innerText)){case-2:s=" bb";break;case-1:s=" b";break;case 0:s="";break;case 1:s=" #";break;case 2:s=" ##"}}var n,o=new De;o.name=i+s,this._currentChord=Be.newGuid();for(n of t.staves)n.addChord(this._currentChord,o)}parseBarline(e,t){for(var i of e.childNodes)if(i.nodeType===b.Element)switch(i.localName){case"repeat":this.parseRepeat(i,t);break;case"ending":this.parseEnding(i,t)}}parseEnding(e,t){e=parseInt(e.getAttribute("number"));0<e&&(t.alternateEndings=t.alternateEndings|1<<--e&255)}parseRepeat(e,t){var i=e.getAttribute("direction");let s=parseInt(e.getAttribute("times"));(s<0||isNaN(s))&&(s=2),"backward"===i?t.repeatCount=s:"forward"===i&&(t.isRepeatStart=!0)}parseNoteBeat(e,t){var i,s=0<e.getElementsByTagName("chord",!1).length,a=this.getOrCreateBeat(e,t,s),r=(!a.chordId&&this._currentChord&&(a.chordId=this._currentChord,this._currentChord=null),this._currentDirection&&(a.text=this._currentDirection,this._currentDirection=null),new Ne);a.voice.isEmpty=!1,a.isEmpty=!1,a.addNote(r),a.dots=0;let n=!1;for(i of e.childNodes)if(i.nodeType===b.Element)switch(i.localName){case"grace":a.graceType=_.BeforeBeat,a.duration=x.ThirtySecond;break;case"duration":if(a.isRest&&!n)switch(parseInt(i.innerText)){case 1:a.duration=x.Whole;break;case 2:a.duration=x.Half;break;case 4:a.duration=x.Quarter;break;case 8:a.duration=x.Eighth;break;case 16:a.duration=x.Sixteenth;break;case 32:a.duration=x.ThirtySecond;break;case 64:a.duration=x.SixtyFourth;break;default:a.duration=x.Quarter}break;case"tie":this.parseTied(i,r);break;case"cue":case"instrument":break;case"type":a.duration=this.getDuration(i.innerText),a.graceType!==_.None&&a.duration<x.Sixteenth&&(a.duration=x.Eighth);break;case"dot":a.dots++;break;case"accidental":this.parseAccidental(i,r);break;case"time-modification":this.parseTimeModification(i,a);break;case"stem":break;case"notehead":"yes"===i.getAttribute("parentheses")&&(r.isGhost=!0);break;case"beam":"continue"===i.innerText&&(this._isBeamContinue=!0);break;case"notations":this.parseNotations(i,a,r);break;case"lyric":this.parseLyric(i,a);break;case"pitch":this.parsePitch(i,r);break;case"unpitched":this.parseUnpitched(i,r);break;case"rest":n="yes"===i.getAttribute("measure"),a.isEmpty=!1,a.notes=[],a.duration=x.Whole}if(r.isStringed)for(let e=0;e<a.notes.length;e++)if(a.notes[e].string===r.string&&a.notes[e]!==r){a.removeNote(r);break}}getDuration(e){switch(e){case"256th":case"128th":case"64th":return x.SixtyFourth;case"32nd":return x.ThirtySecond;case"16th":return x.Sixteenth;case"eighth":return x.Eighth;case"quarter":return x.Quarter;case"half":return x.Half;case"long":case"breve":case"whole":return x.Whole}return x.Quarter}parseLyric(e,t){for(var i of e.childNodes)i.nodeType===b.Element&&"text"===i.localName&&(t.text?t.text+=" "+i.innerText:t.text=i.innerText)}parseAccidental(e,t){switch(e.innerText){case"sharp":t.accidentalMode=Y.ForceSharp;break;case"natural":t.accidentalMode=Y.ForceNatural;break;case"flat":t.accidentalMode=Y.ForceFlat}}parseTied(e,t){"start"===e.getAttribute("type")?this._tieStartIds.has(t.id)||(this._tieStartIds.set(t.id,!0),this._tieStarts.push(t)):"stop"===e.getAttribute("type")&&0<this._tieStarts.length&&!t.isTieDestination&&(t.isTieDestination=!0,t.tieOrigin=this._tieStarts[0],this._tieStarts.splice(0,1),this._tieStartIds.delete(t.id))}parseNotations(e,t,i){for(var s of e.childNodes)if(s.nodeType===b.Element)switch(s.localName){case"articulations":this.parseArticulations(s,i);break;case"tied":this.parseTied(s,i);break;case"slide":case"glissando":"start"===s.getAttribute("type")&&(i.slideOutType=m.Shift);break;case"dynamics":this.parseDynamics(s,t);break;case"technical":this.parseTechnical(s,i);break;case"ornaments":this.parseOrnaments(s,i);break;case"slur":let e=s.getAttribute("number");switch(e=e||"1",e=t.voice.bar.staff.index+"_"+e,s.getAttribute("type")){case"start":this._slurStarts.set(e,i);break;case"stop":var a;this._slurStarts.has(e)&&(i.isSlurDestination=!0,((a=this._slurStarts.get(e)).slurDestination=i).slurOrigin=a)}}}parseOrnaments(e,t){for(var i of e.childNodes)if(i.nodeType===b.Element)if("tremolo"===i.localName)switch(parseInt(i.innerText)){case 1:t.beat.tremoloSpeed=x.Eighth;break;case 2:t.beat.tremoloSpeed=x.Sixteenth;break;case 3:t.beat.tremoloSpeed=x.ThirtySecond}}parseTechnical(e,t){for(var i of e.childNodes)if(i.nodeType===b.Element)switch(i.localName){case"string":t.string=parseInt(i.innerText),-2147483648!==t.string&&(t.string=t.beat.voice.bar.staff.tuning.length-t.string+1);break;case"fret":t.fret=parseInt(i.innerText);break;case"down-bow":t.beat.pickStroke=j.Down;break;case"up-bow":t.beat.pickStroke=j.Up}-2147483648!==t.string&&-2147483648!==t.fret||(t.string=-1,t.fret=-1)}parseArticulations(e,t){for(var i of e.childNodes)switch(i.localName){case"accent":t.accentuated=H.Normal;break;case"strong-accent":t.accentuated=H.Heavy;break;case"staccato":case"detached-legato":t.isStaccato=!0}}parseDynamics(e,t){for(var i of e.childNodes)if(i.nodeType===b.Element)switch(i.localName){case"p":t.dynamics=l.P;break;case"pp":t.dynamics=l.PP;break;case"ppp":t.dynamics=l.PPP;break;case"f":t.dynamics=l.F;break;case"ff":t.dynamics=l.FF;break;case"fff":t.dynamics=l.FFF;break;case"mp":t.dynamics=l.MP;break;case"mf":t.dynamics=l.MF}}parseTimeModification(e,t){for(var i of e.childNodes)if(i.nodeType===b.Element)switch(i.localName){case"actual-notes":t.tupletNumerator=parseInt(i.innerText);break;case"normal-notes":t.tupletDenominator=parseInt(i.innerText)}}parseUnpitched(e,t){let i="",s=0,a=0;for(var r of e.childNodes)if(r.nodeType===b.Element)switch(r.localName){case"display-step":i=r.innerText;break;case"display-alter":s=parseInt(r.innerText);break;case"display-octave":a=parseInt(r.innerText)}e=12*a+Be.getToneForText(i)+s;t.octave=e/12|0,t.tone=e-12*t.octave}parsePitch(e,t){let i="",s=0,a=0;for(var r of e.childNodes)if(r.nodeType===b.Element)switch(r.localName){case"step":i=r.innerText;break;case"alter":s=parseFloat(r.innerText),isNaN(s)&&(s=0);break;case"octave":a=parseInt(r.innerText)+1}e=12*a+Be.getToneForText(i)+(0|s);t.octave=e/12|0,t.tone=e-12*t.octave}getOrCreateVoice(t,i){if(!(i<t.voices.length)){for(let e=t.voices.length;e<=i;e++)t.addVoice(new Ye);this._maxVoices=Math.max(this._maxVoices,t.voices.length)}return t.voices[i]}parseDirection(e,t){for(var i of e.childNodes)if(i.nodeType===b.Element)switch(i.localName){case"sound":var s,a=i.getAttribute("tempo");a&&((s=new ye).isLinear=!0,s.type=V.Tempo,s.value=parseInt(a),t.tempoAutomation=s,0===t.index)&&(t.score.tempo=s.value);break;case"direction-type":var r=i.firstElement;switch(r.localName){case"words":this._currentDirection=r.innerText;break;case"metronome":this.parseMetronome(r,t)}}}parseMetronome(e,t){let i=x.Quarter,s=120;for(var a of e.childNodes)if(a.nodeType===b.Element)switch(a.localName){case"beat-unit":i=this.getDuration(a.innerText);break;case"per-minute":s=parseInt(a.innerText)}e=new ye;e.type=V.Tempo,e.value=s*(i/4|0),t.tempoAutomation=e,0===t.index&&(t.score.tempo=e.value)}parseAttributes(e,t,i,s){let a=0,r=!1;for(var n of e.childNodes)if(n.nodeType===b.Element)switch(n.localName){case"divisions":this._divisionsPerQuarterNote=parseInt(n.innerText);break;case"key":this.parseKey(n,i);break;case"time":this.parseTime(n,i),r=!0;break;case"clef":a=parseInt(n.getAttribute("number")),isNaN(a)&&(a=1),this.parseClef(n,t[a-1]);break;case"staff-details":this.parseStaffDetails(n,s);break;case"transpose":this.parseTranspose(n,s)}r||(i.timeSignatureCommon=!0)}parseTranspose(e,t){let i=0;for(var s of e.childNodes)if(s.nodeType===b.Element)switch(s.localName){case"chromatic":i+=parseInt(s.innerText);break;case"octave-change":i+=12*parseInt(s.innerText)}for(var a of t.staves)a.transpositionPitch=i}parseClef(e,t){let i="s",s=0;for(var a of e.childNodes)if(a.nodeType===b.Element)switch(a.localName){case"sign":i=a.innerText.toLowerCase();break;case"line":s=parseInt(a.innerText);break;case"clef-octave-change":switch(parseInt(a.innerText)){case-2:t.clefOttava=W._15mb;break;case-1:t.clefOttava=W._8vb;break;case 1:t.clefOttava=W._8va;break;case 2:t.clefOttava=W._15mb}}switch(i){case"g":t.clef=c.G2;break;case"f":t.clef=c.F4;break;case"c":3===s?t.clef=c.C3:t.clef=c.C4;break;case"percussion":t.clef=c.Neutral,t.staff.isPercussion=!0;break;case"tab":t.clef=c.G2,t.staff.showTablature=!0;break;default:t.clef=c.G2}}parseTime(e,t){"common"===e.getAttribute("symbol")&&(t.timeSignatureCommon=!0);let i=!1,s=!1;for(var a of e.childNodes)if(a.nodeType===b.Element){var r=a.innerText;switch(a.localName){case"beats":i||(-1===r.indexOf("+")?t.timeSignatureNumerator=parseInt(r):t.timeSignatureNumerator=4,i=!0);break;case"beat-type":s||(-1===r.indexOf("+")?t.timeSignatureDenominator=parseInt(r):t.timeSignatureDenominator=4,s=!0)}}}parseKey(e,t){let i=-2147483648,s="";for(var a of e.childNodes)if(a.nodeType===b.Element)switch(a.localName){case"fifths":i=parseInt(a.innerText);break;case"key-step":case"key-alter":break;case"mode":s=a.innerText}-7<=i&&i<=7?t.keySignature=i:t.keySignature=n.C,"minor"===s?t.keySignatureType=Z.Minor:t.keySignatureType=Z.Major}getOrCreateMasterBar(t){if(!(t<this._score.masterBars.length))for(let e=this._score.masterBars.length;e<=t;e++){var i,s=new Re;0<this._score.masterBars.length&&(i=this._score.masterBars[this._score.masterBars.length-1],s.timeSignatureDenominator=i.timeSignatureDenominator,s.timeSignatureNumerator=i.timeSignatureNumerator,s.keySignature=i.keySignature,s.keySignatureType=i.keySignatureType),this._score.addMasterBar(s)}return this._score.masterBars[t]}parseIdentification(e){for(var t of e.childNodes)if(t.nodeType===b.Element)switch(t.localName){case"creator":"composer"===t.getAttribute("type")&&(this._score.music=t.innerText);break;case"rights":this._score.copyright&&(this._score.copyright+="\n"),this._score.copyright+=t.innerText}}parsePartList(e){for(var t of e.childNodes)if(t.nodeType===b.Element)switch(t.localName){case"part-group":this.parsePartGroup(t);break;case"score-part":this.parseScorePart(t)}}parsePartGroup(e){switch(e.getAttribute("type")){case"start":this._currentPartGroup=e.getAttribute("number"),this._partGroups.set(this._currentPartGroup,[]);break;case"stop":this._currentPartGroup=null}}parseScorePart(e){var t,i=e.getAttribute("id"),s=new Xe;s.ensureStaveCount(1),s.staves[0].showStandardNotation=!0,this._trackById.set(i,s),this._score.addTrack(s),this._currentPartGroup&&this._partGroups.get(this._currentPartGroup).push(s);for(t of e.childNodes)if(t.nodeType===b.Element)switch(t.localName){case"part-name":s.name=t.innerText;break;case"part-abbreviation":s.shortName=t.innerText;break;case"midi-instrument":this.parseMidiInstrument(t,s)}this.isEmptyTuning(s.staves[0].tuning)&&(s.staves[0].stringTuning.tunings=[])}isEmptyTuning(t){if(t)for(let e=0;e<t.length;e++)if(0!==t[e])return!1;return!0}parseMidiInstrument(e,t){for(var i of e.childNodes)if(i.nodeType===b.Element)switch(i.localName){case"midi-channel":t.playbackInfo.primaryChannel=parseInt(i.innerText);break;case"midi-program":t.playbackInfo.program=parseInt(i.innerText);break;case"volume":t.playbackInfo.volume=Math.floor(parseInt(i.innerText)/100*16);break;case"pan":t.playbackInfo.balance=Math.max(0,Math.min(16,Math.floor((parseInt(i.innerText)+90)/180*16)))}}}(e=se=se||{})[e.PerNotePitchBend=96]="PerNotePitchBend",e[e.NoteOff=128]="NoteOff",e[e.NoteOn=144]="NoteOn",e[e.NoteAftertouch=160]="NoteAftertouch",e[e.Controller=176]="Controller",e[e.ProgramChange=192]="ProgramChange",e[e.ChannelAftertouch=208]="ChannelAftertouch",e[e.PitchBend=224]="PitchBend",e[e.SystemExclusive=240]="SystemExclusive",e[e.SystemExclusive2=247]="SystemExclusive2",e[e.Meta=255]="Meta";class Pt{constructor(e,t,i,s,a){this.track=e,this.tick=t,this.message=i|s<<8|a<<16}get channel(){return 15&this.message}get command(){return 240&this.message}get data1(){return(65280&this.message)>>8}set data1(e){this.message&=-65281,this.message|=e<<8}get data2(){return(16711680&this.message)>>16}set data2(e){this.message&=-16711681,this.message|=e<<16}writeTo(e){var t=new Uint8Array([this.message>>24&255,this.message>>16&255,this.message>>8&255,255&this.message]);e.write(t,0,t.length)}}(e=ae=ae||{})[e.SequenceNumber=0]="SequenceNumber",e[e.TextEvent=1]="TextEvent",e[e.CopyrightNotice=2]="CopyrightNotice",e[e.SequenceOrTrackName=3]="SequenceOrTrackName",e[e.InstrumentName=4]="InstrumentName",e[e.LyricText=5]="LyricText",e[e.MarkerText=6]="MarkerText",e[e.CuePoint=7]="CuePoint",e[e.PatchName=8]="PatchName",e[e.PortName=9]="PortName",e[e.MidiChannel=32]="MidiChannel",e[e.MidiPort=33]="MidiPort",e[e.EndOfTrack=47]="EndOfTrack",e[e.Tempo=81]="Tempo",e[e.SmpteOffset=84]="SmpteOffset",e[e.TimeSignature=88]="TimeSignature",e[e.KeySignature=89]="KeySignature",e[e.SequencerSpecific=127]="SequencerSpecific";class Et extends Pt{get channel(){return-1}get command(){return 255&this.message}get metaStatus(){return this.data1}constructor(e,t,i,s,a){super(e,t,i,s,a)}}(e=a=a||{})[e.SystemExclusive=240]="SystemExclusive",e[e.MtcQuarterFrame=241]="MtcQuarterFrame",e[e.SongPosition=242]="SongPosition",e[e.SongSelect=243]="SongSelect",e[e.TuneRequest=246]="TuneRequest",e[e.SystemExclusive2=247]="SystemExclusive2";class Ct extends Pt{get channel(){return-1}get command(){return 255&this.message}constructor(e,t,i,s,a){super(e,t,i,s,a)}}(e=re=re||{})[e.MetronomeTick=0]="MetronomeTick",e[e.Rest=1]="Rest";class Ft extends Ct{constructor(e,t,i,s,a){super(e,t,i,255&s,s>>8&255),this.data=a}get isMetronome(){return this.manufacturerId==Ft.AlphaTabManufacturerId&&this.data[0]==re.MetronomeTick}get metronomeNumerator(){return this.isMetronome?this.data[1]:-1}get metronomeDurationInTicks(){return this.isMetronome?L.decodeUInt32LE(this.data,2):-1}get metronomeDurationInMilliseconds(){return this.isMetronome?L.decodeUInt32LE(this.data,6):-1}get isRest(){return this.manufacturerId==Ft.AlphaTabManufacturerId&&this.data[0]==re.Rest}get manufacturerId(){return this.message>>8}writeTo(e){e.writeByte(240);var t=this.data.length+2,t=(e.writeByte(this.manufacturerId),new Uint8Array([t>>24&255,t>>16&255,t>>8&255,255&t]));e.write(t,0,t.length),e.writeByte(247)}static encodeMetronome(e,t,i){var s=qe.withCapacity(10);return s.writeByte(re.MetronomeTick),s.writeByte(e),L.writeInt32LE(s,t),L.writeInt32LE(s,i),s.toArray()}}Ft.AlphaTabManufacturerId=125;class Lt{constructor(e,t){this.time=0,this.eventIndex=e,this.event=t,this.isMetronome=this.event instanceof Ft&&this.event.isMetronome}static newMetronomeEvent(e,t,i,s,a){t=new Ft(0,t,se.SystemExclusive2,Ft.AlphaTabManufacturerId,Ft.encodeMetronome(i,s,a));return new Lt(e,t)}}class D{}D.DefaultChannelCount=17,D.MetronomeChannel=D.DefaultChannelCount-1,D.AudioChannels=2,D.MinVolume=0,D.MinProgram=0,D.MaxProgram=127,D.MinPlaybackSpeed=.125,D.MaxPlaybackSpeed=8,D.MaxPitchWheel=16384,D.MaxPitchWheel20=4294967296,D.DefaultPitchWheel=D.MaxPitchWheel/2,D.MicroBufferCount=32,D.MicroBufferSize=64;class Mt{constructor(e,t,i){this.bpm=e,this.ticks=t,this.time=i}}class Dt{constructor(){this.tempoChanges=[],this.firstProgramEventPerChannel=new Map,this.firstTimeSignatureNumerator=0,this.firstTimeSignatureDenominator=0,this.synthData=[],this.division=p.QuarterTime,this.eventIndex=0,this.currentTime=0,this.playbackRange=null,this.playbackRangeStartTime=0,this.playbackRangeEndTime=0,this.endTick=0,this.endTime=0}}class It{constructor(e){this._oneTimeState=null,this._countInState=null,this.isLooping=!1,this.playbackSpeed=1,this._synthesizer=e,this._mainState=new Dt,this._currentState=this._mainState}get isPlayingMain(){return this._currentState==this._mainState}get isPlayingOneTimeMidi(){return this._currentState==this._oneTimeState}get isPlayingCountIn(){return this._currentState==this._countInState}get mainPlaybackRange(){return this._mainState.playbackRange}set mainPlaybackRange(e){(this._mainState.playbackRange=e)&&(this._mainState.playbackRangeStartTime=this.tickPositionToTimePositionWithSpeed(this._mainState,e.startTick,1),this._mainState.playbackRangeEndTime=this.tickPositionToTimePositionWithSpeed(this._mainState,e.endTick,1))}get currentTime(){return this._currentState.currentTime/this.playbackSpeed}get currentEndTick(){return this._currentState.endTick}get currentEndTime(){return this._currentState.endTime/this.playbackSpeed}mainSeek(e){var t;e*=this.playbackSpeed,this.mainPlaybackRange&&(e<this._mainState.playbackRangeStartTime?e=this._mainState.playbackRangeStartTime:e>this._mainState.playbackRangeEndTime&&(e=this._mainState.playbackRangeEndTime)),e>this._mainState.currentTime?this.mainSilentProcess(e-this._mainState.currentTime):e<this._mainState.currentTime&&(this._mainState.currentTime=0,this._mainState.eventIndex=0,this.isPlayingMain&&(t=this._synthesizer.metronomeVolume,this._synthesizer.noteOffAll(!0),this._synthesizer.resetSoft(),this._synthesizer.setupMetronomeChannel(t)),this.mainSilentProcess(e))}mainSilentProcess(e){if(!(e<=0)){var t=Date.now(),i=this._mainState.currentTime+e;if(this.isPlayingMain)for(;this._mainState.currentTime<i;)this.fillMidiEventQueueLimited(i-this._mainState.currentTime)&&this._synthesizer.synthesizeSilent(D.MicroBufferSize);this._mainState.currentTime=i;e=Date.now()-t;C.debug("Sequencer","Silent seek finished in "+e+"ms (main)")}}loadOneTimeMidi(e){this._oneTimeState=this.createStateFromFile(e),this._currentState=this._oneTimeState}loadMidi(e){this._mainState=this.createStateFromFile(e),this._currentState=this._mainState}createStateFromFile(e){var t,i=new Dt;i.tempoChanges=[],i.division=e.division,i.eventIndex=0,i.currentTime=0,i.synthData=[];let s=120,a=0,r=0,n=0,o=0,h=0,l=0,d=0,c=0;for(t of e.events){var u,p=new Lt(i.synthData.length,t),g=(i.synthData.push(p),t.tick-c);if(a+=g,r+=g*(6e4/(s*e.division)),p.time=r,c=t.tick,0<o)for(;l<a;){var m=Lt.newMetronomeEvent(i.synthData.length,l,Math.floor(l/o)%n,o,h);i.synthData.push(m),m.time=d,l+=o,d+=h}t.command===se.Meta&&t.data1===ae.Tempo?(g=t,s=6e7/g.value,i.tempoChanges.push(new Mt(s,a,r)),h=o*(6e4/(s*e.division))):t.command===se.Meta&&t.data1===ae.TimeSignature?(g=t,u=Math.pow(2,g.data[1]),n=g.data[0],o=i.division*(4/u)|0,h=o*(6e4/(s*e.division)),0===i.firstTimeSignatureDenominator&&(i.firstTimeSignatureNumerator=g.data[0],i.firstTimeSignatureDenominator=u)):t.command===se.ProgramChange&&(g=t.channel,i.firstProgramEventPerChannel.has(g)||i.firstProgramEventPerChannel.set(g,p))}return i.synthData.sort((e,t)=>e.time>t.time?1:e.time<t.time?-1:e.eventIndex-t.eventIndex),i.endTime=r,i.endTick=a,i}fillMidiEventQueue(){return this.fillMidiEventQueueLimited(-1)}fillMidiEventQueueLimited(e){let t=D.MicroBufferSize/this._synthesizer.outSampleRate*1e3*this.playbackSpeed,i=this.internalEndTime,s=(0<e&&(e<t&&(t=e),i=Math.min(this.internalEndTime,this._currentState.currentTime+e)),!1);for(this._currentState.currentTime+=t;this._currentState.eventIndex<this._currentState.synthData.length&&this._currentState.synthData[this._currentState.eventIndex].time<this._currentState.currentTime&&this._currentState.currentTime<i;)this._synthesizer.dispatchEvent(this._currentState.synthData[this._currentState.eventIndex]),this._currentState.eventIndex++,s=!0;return s}mainTickPositionToTimePosition(e){return this.tickPositionToTimePositionWithSpeed(this._mainState,e,this.playbackSpeed)}mainTimePositionToTickPosition(e){return this.timePositionToTickPositionWithSpeed(this._mainState,e,this.playbackSpeed)}currentTimePositionToTickPosition(e){return this.timePositionToTickPositionWithSpeed(this._currentState,e,this.playbackSpeed)}tickPositionToTimePositionWithSpeed(e,t,i){let s=0,a=120,r=0;for(const n of e.tempoChanges){if(t<n.ticks)break;s=n.time,a=n.bpm,r=n.ticks}return t-=r,(s+=t*(6e4/(a*e.division)))/i}timePositionToTickPositionWithSpeed(e,t,i){t*=i;let s=0,a=120,r=0;for(const n of e.tempoChanges){if(t<n.time)break;s=n.ticks,a=n.bpm,r=n.time}return t-=r,(s+=t/(6e4/(a*e.division))|0)+1}get internalEndTime(){return this.isPlayingMain&&this.mainPlaybackRange?this._currentState.playbackRangeEndTime:this._currentState.endTime}get isFinished(){return this._currentState.currentTime>=this.internalEndTime}stop(){this.isPlayingMain&&this.mainPlaybackRange?this._currentState.currentTime=this.mainPlaybackRange.startTick:this._currentState.currentTime=0,this._currentState.eventIndex=0}resetOneTimeMidi(){this._oneTimeState=null,this._currentState=this._mainState}resetCountIn(){this._countInState=null,this._currentState=this._mainState}startCountIn(){this.generateCountInMidi(),this._currentState=this._countInState,this.stop(),this._synthesizer.noteOffAll(!0)}generateCountInMidi(){var t=new Dt;t.division=this._mainState.division;let e=120,i=4,s=4;s=0===this._mainState.eventIndex?(e=this._mainState.tempoChanges[0].bpm,i=this._mainState.firstTimeSignatureNumerator,this._mainState.firstTimeSignatureDenominator):(e=this._synthesizer.currentTempo,i=this._synthesizer.timeSignatureNumerator,this._synthesizer.timeSignatureDenominator),t.tempoChanges.push(new Mt(e,0,0));var a=t.division*(4/s)|0,r=a*(6e4/(e*this._mainState.division));let n=0,o=0;for(let e=0;e<i;e++){var h=Lt.newMetronomeEvent(t.synthData.length,n,e,a,r);t.synthData.push(h),h.time=o,n+=a,o+=r}t.synthData.sort((e,t)=>e.time>t.time?1:e.time<t.time?-1:e.eventIndex-t.eventIndex),t.endTime=o,t.endTick=n,this._countInState=t}}(e=ne=ne||{})[e.Paused=0]="Paused",e[e.Playing=1]="Playing";class Rt{constructor(e,t){this.state=e,this.stopped=t}}class At{constructor(e,t,i,s,a){this.currentTime=e,this.endTime=t,this.currentTick=i,this.endTick=s,this.isSeek=a}}class Ot{constructor(){this.id="",this.size=0}static load(e,t,i){if(e&&Ot.HeaderSize>e.size)return!1;if(i.position+Ot.HeaderSize>=i.length)return!1;if(t.id=L.read8BitStringLength(i,4),t.id.charCodeAt(0)<=32||122<=t.id.charCodeAt(0))return!1;if(t.size=L.readUInt32LE(i),e&&Ot.HeaderSize+t.size>e.size)return!1;e&&(e.size-=Ot.HeaderSize+t.size);var s="RIFF"===t.id,a="LIST"===t.id;if(s&&e)return!1;if(s||a){if(t.id=L.read8BitStringLength(i,4),t.id.charCodeAt(0)<=32||122<=t.id.charCodeAt(0))return!1;t.size-=4}return!0}}Ot.HeaderSize=8;class Gt{constructor(){this.phdrs=[],this.pbags=[],this.pmods=[],this.pgens=[],this.insts=[],this.ibags=[],this.imods=[],this.igens=[],this.sHdrs=[],this.fontSamples=new Float32Array(0)}load(i){var e=new Ot,t=new Ot;if(!Ot.load(null,e,i)||"sfbk"!==e.id)throw new Ve("Soundfont is not a valid Soundfont2 file");for(;Ot.load(e,t,i);){var s=new Ot;if("pdta"===t.id)for(;Ot.load(t,s,i);)switch(s.id){case"phdr":for(let e=0,t=s.size/Yt.SizeInFile|0;e<t;e++)this.phdrs.push(new Yt(i));break;case"pbag":for(let e=0,t=s.size/Ut.SizeInFile|0;e<t;e++)this.pbags.push(new Ut(i));break;case"pmod":for(let e=0,t=s.size/qt.SizeInFile|0;e<t;e++)this.pmods.push(new qt(i));break;case"pgen":for(let e=0,t=s.size/Xt.SizeInFile|0;e<t;e++)this.pgens.push(new Xt(i));break;case"inst":for(let e=0,t=s.size/zt.SizeInFile|0;e<t;e++)this.insts.push(new zt(i));break;case"ibag":for(let e=0,t=s.size/Ht.SizeInFile|0;e<t;e++)this.ibags.push(new Ht(i));break;case"imod":for(let e=0,t=s.size/Vt.SizeInFile|0;e<t;e++)this.imods.push(new Vt(i));break;case"igen":for(let e=0,t=s.size/Wt.SizeInFile|0;e<t;e++)this.igens.push(new Wt(i));break;case"shdr":for(let e=0,t=s.size/Jt.SizeInFile|0;e<t;e++)this.sHdrs.push(new Jt(i));break;default:i.position+=s.size}else if("sdta"===t.id)for(;Ot.load(t,s,i);)"smpl"===s.id?this.fontSamples=Gt.loadSamples(s,i):i.position+=s.size;else i.position+=t.size}}static loadSamples(e,t){let i=e.size/2|0;var s=new Float32Array(i);let a=0;for(var r=new Uint8Array(16384);0<i;){var n=Math.min(i,r.length/2|0);t.read(r,0,2*n);for(let e=0;e<n;e++){var o=F.int32ToInt16(r[2*e+1]<<8|r[2*e]);s[a+e]=o/32767}i-=n,a+=n}return s}}class Ht{constructor(e){this.instGenNdx=L.readUInt16LE(e),this.instModNdx=L.readUInt16LE(e)}}Ht.SizeInFile=4;class Vt{constructor(e){this.modSrcOper=L.readUInt16LE(e),this.modDestOper=L.readUInt16LE(e),this.modAmount=L.readInt16LE(e),this.modAmtSrcOper=L.readUInt16LE(e),this.modTransOper=L.readUInt16LE(e)}}Vt.SizeInFile=10;class Wt{constructor(e){this.genOper=L.readUInt16LE(e),this.genAmount=new jt(e)}}Wt.SizeInFile=4;class zt{constructor(e){this.instName=L.read8BitStringLength(e,20),this.instBagNdx=L.readUInt16LE(e)}}zt.SizeInFile=22;class Ut{constructor(e){this.genNdx=L.readUInt16LE(e),this.modNdx=L.readUInt16LE(e)}}Ut.SizeInFile=4;class Xt{constructor(e){this.genOper=L.readUInt16LE(e),this.genAmount=new jt(e)}}Xt.SizeInFile=4,Xt.GenInstrument=41,Xt.GenKeyRange=43,Xt.GenVelRange=44,Xt.GenSampleId=53;class Yt{constructor(e){this.presetName=L.read8BitStringLength(e,20),this.preset=L.readUInt16LE(e),this.bank=L.readUInt16LE(e),this.presetBagNdx=L.readUInt16LE(e),this.library=L.readUInt32LE(e),this.genre=L.readUInt32LE(e),this.morphology=L.readUInt32LE(e)}}Yt.SizeInFile=38;class qt{constructor(e){this.modSrcOper=L.readUInt16LE(e),this.modDestOper=L.readUInt16LE(e),this.modAmount=L.readUInt16LE(e),this.modAmtSrcOper=L.readUInt16LE(e),this.modTransOper=L.readUInt16LE(e)}}qt.SizeInFile=10;class Jt{constructor(e){this.sampleName=L.read8BitStringLength(e,20),this.start=L.readUInt32LE(e),this.end=L.readUInt32LE(e),this.startLoop=L.readUInt32LE(e),this.endLoop=L.readUInt32LE(e),this.sampleRate=L.readUInt32LE(e),this.originalPitch=e.readByte(),this.pitchCorrection=L.readSInt8(e),this.sampleLink=L.readUInt16LE(e),this.sampleType=L.readUInt16LE(e)}}Jt.SizeInFile=46;class jt{constructor(e){this.wordAmount=L.readUInt16LE(e)}get shortAmount(){return F.uint16ToInt16(this.wordAmount)}get lowByteAmount(){return 255&this.wordAmount}get highByteAmount(){return(65280&this.wordAmount)>>8&255}}class Qt{constructor(){this.presetIndex=0,this.bank=0,this.pitchWheel=0,this.perNotePitchWheel=new Map,this.midiPan=0,this.midiVolume=0,this.midiExpression=0,this.midiRpn=0,this.midiData=0,this.panOffset=0,this.gainDb=0,this.pitchRange=0,this.tuning=0,this.mixVolume=0,this.mute=!1,this.solo=!1}}class Kt{constructor(){this.activeChannel=0,this.channelList=[]}setupVoice(e,t){var i=this.channelList[this.activeChannel],s=t.region.pan+i.panOffset;t.playingChannel=this.activeChannel,t.mixVolume=i.mixVolume,t.noteGainDb+=i.gainDb,t.updatePitchRatio(i,e.outSampleRate),s<=-.5?(t.panFactorLeft=1,t.panFactorRight=0):.5<=s?(t.panFactorLeft=0,t.panFactorRight=1):(t.panFactorLeft=Math.sqrt(.5-s),t.panFactorRight=Math.sqrt(.5+s))}}(e=oe=oe||{})[e.None=0]="None",e[e.Continuous=1]="Continuous",e[e.Sustain=2]="Sustain",(e=he=he||{})[e.StereoInterleaved=0]="StereoInterleaved",e[e.StereoUnweaved=1]="StereoUnweaved",e[e.Mono=2]="Mono";class $t{constructor(){this.name="",this.presetNumber=0,this.bank=0,this.regions=null,this.fontSamples=null}}class Zt{static timecents2Secs(e){return Math.pow(2,e/1200)}static decibelsToGain(e){return-100<e?Math.pow(10,.05*e):0}static gainToDecibels(e){return e<=1e-5?-100:20*Math.log10(e)}static cents2Hertz(e){return 8.176*Math.pow(2,e/1200)}static clamp(e,t,i){return e<=t?t:i<=e?i:e}}class ei{constructor(e){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0,e&&(this.delay=e.delay,this.attack=e.attack,this.hold=e.hold,this.decay=e.decay,this.sustain=e.sustain,this.release=e.release,this.keynumToHold=e.keynumToHold,this.keynumToDecay=e.keynumToDecay)}clear(){this.delay=0,this.attack=0,this.hold=0,this.decay=0,this.sustain=0,this.release=0,this.keynumToHold=0,this.keynumToDecay=0}envToSecs(e){this.delay=this.delay<-11950?0:Zt.timecents2Secs(this.delay),this.attack=this.attack<-11950?0:Zt.timecents2Secs(this.attack),this.release=this.release<-11950?0:Zt.timecents2Secs(this.release),0===this.keynumToHold&&(this.hold=this.hold<-11950?0:Zt.timecents2Secs(this.hold)),0===this.keynumToDecay&&(this.decay=this.decay<-11950?0:Zt.timecents2Secs(this.decay)),this.sustain<0?this.sustain=0:this.sustain=e?Zt.decibelsToGain(-this.sustain/10):1-this.sustain/1e3}}(e=i=i||{})[e.StartAddrsOffset=0]="StartAddrsOffset",e[e.EndAddrsOffset=1]="EndAddrsOffset",e[e.StartloopAddrsOffset=2]="StartloopAddrsOffset",e[e.EndloopAddrsOffset=3]="EndloopAddrsOffset",e[e.StartAddrsCoarseOffset=4]="StartAddrsCoarseOffset",e[e.ModLfoToPitch=5]="ModLfoToPitch",e[e.VibLfoToPitch=6]="VibLfoToPitch",e[e.ModEnvToPitch=7]="ModEnvToPitch",e[e.InitialFilterFc=8]="InitialFilterFc",e[e.InitialFilterQ=9]="InitialFilterQ",e[e.ModLfoToFilterFc=10]="ModLfoToFilterFc",e[e.ModEnvToFilterFc=11]="ModEnvToFilterFc",e[e.EndAddrsCoarseOffset=12]="EndAddrsCoarseOffset",e[e.ModLfoToVolume=13]="ModLfoToVolume",e[e.Unused1=14]="Unused1",e[e.ChorusEffectsSend=15]="ChorusEffectsSend",e[e.ReverbEffectsSend=16]="ReverbEffectsSend",e[e.Pan=17]="Pan",e[e.Unused2=18]="Unused2",e[e.Unused3=19]="Unused3",e[e.Unused4=20]="Unused4",e[e.DelayModLFO=21]="DelayModLFO",e[e.FreqModLFO=22]="FreqModLFO",e[e.DelayVibLFO=23]="DelayVibLFO",e[e.FreqVibLFO=24]="FreqVibLFO",e[e.DelayModEnv=25]="DelayModEnv",e[e.AttackModEnv=26]="AttackModEnv",e[e.HoldModEnv=27]="HoldModEnv",e[e.DecayModEnv=28]="DecayModEnv",e[e.SustainModEnv=29]="SustainModEnv",e[e.ReleaseModEnv=30]="ReleaseModEnv",e[e.KeynumToModEnvHold=31]="KeynumToModEnvHold",e[e.KeynumToModEnvDecay=32]="KeynumToModEnvDecay",e[e.DelayVolEnv=33]="DelayVolEnv",e[e.AttackVolEnv=34]="AttackVolEnv",e[e.HoldVolEnv=35]="HoldVolEnv",e[e.DecayVolEnv=36]="DecayVolEnv",e[e.SustainVolEnv=37]="SustainVolEnv",e[e.ReleaseVolEnv=38]="ReleaseVolEnv",e[e.KeynumToVolEnvHold=39]="KeynumToVolEnvHold",e[e.KeynumToVolEnvDecay=40]="KeynumToVolEnvDecay",e[e.Instrument=41]="Instrument",e[e.Reserved1=42]="Reserved1",e[e.KeyRange=43]="KeyRange",e[e.VelRange=44]="VelRange",e[e.StartloopAddrsCoarseOffset=45]="StartloopAddrsCoarseOffset",e[e.Keynum=46]="Keynum",e[e.Velocity=47]="Velocity",e[e.InitialAttenuation=48]="InitialAttenuation",e[e.Reserved2=49]="Reserved2",e[e.EndloopAddrsCoarseOffset=50]="EndloopAddrsCoarseOffset",e[e.CoarseTune=51]="CoarseTune",e[e.FineTune=52]="FineTune",e[e.SampleID=53]="SampleID",e[e.SampleModes=54]="SampleModes",e[e.Reserved3=55]="Reserved3",e[e.ScaleTuning=56]="ScaleTuning",e[e.ExclusiveClass=57]="ExclusiveClass",e[e.OverridingRootKey=58]="OverridingRootKey",e[e.Unused5=59]="Unused5",e[e.EndOper=60]="EndOper";class ti{constructor(e){this.loopMode=oe.None,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv=new ei,this.modEnv=new ei,this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,e&&(this.loopMode=e.loopMode,this.sampleRate=e.sampleRate,this.loKey=e.loKey,this.hiKey=e.hiKey,this.loVel=e.loVel,this.hiVel=e.hiVel,this.group=e.group,this.offset=e.offset,this.end=e.end,this.loopStart=e.loopStart,this.loopEnd=e.loopEnd,this.transpose=e.transpose,this.tune=e.tune,this.pitchKeyCenter=e.pitchKeyCenter,this.pitchKeyTrack=e.pitchKeyTrack,this.attenuation=e.attenuation,this.pan=e.pan,this.ampEnv=new ei(e.ampEnv),this.modEnv=new ei(e.modEnv),this.initialFilterQ=e.initialFilterQ,this.initialFilterFc=e.initialFilterFc,this.modEnvToPitch=e.modEnvToPitch,this.modEnvToFilterFc=e.modEnvToFilterFc,this.modLfoToFilterFc=e.modLfoToFilterFc,this.modLfoToVolume=e.modLfoToVolume,this.delayModLFO=e.delayModLFO,this.freqModLFO=e.freqModLFO,this.modLfoToPitch=e.modLfoToPitch,this.delayVibLFO=e.delayVibLFO,this.freqVibLFO=e.freqVibLFO,this.vibLfoToPitch=e.vibLfoToPitch)}clear(e){this.loopMode=oe.None,this.sampleRate=0,this.loKey=0,this.hiKey=0,this.loVel=0,this.hiVel=0,this.group=0,this.offset=0,this.end=0,this.loopStart=0,this.loopEnd=0,this.transpose=0,this.tune=0,this.pitchKeyCenter=0,this.pitchKeyTrack=0,this.attenuation=0,this.pan=0,this.ampEnv.clear(),this.modEnv.clear(),this.initialFilterQ=0,this.initialFilterFc=0,this.modEnvToPitch=0,this.modEnvToFilterFc=0,this.modLfoToFilterFc=0,this.modLfoToVolume=0,this.delayModLFO=0,this.freqModLFO=0,this.modLfoToPitch=0,this.delayVibLFO=0,this.freqVibLFO=0,this.vibLfoToPitch=0,this.hiKey=127,this.hiVel=127,this.pitchKeyCenter=60,e||(this.pitchKeyTrack=100,this.pitchKeyCenter=-1,this.ampEnv.delay=-12e3,this.ampEnv.attack=-12e3,this.ampEnv.hold=-12e3,this.ampEnv.decay=-12e3,this.ampEnv.release=-12e3,this.modEnv.delay=-12e3,this.modEnv.attack=-12e3,this.modEnv.hold=-12e3,this.modEnv.decay=-12e3,this.modEnv.release=-12e3,this.initialFilterFc=13500,this.delayModLFO=-12e3,this.delayVibLFO=-12e3)}operator(e,t){switch(e){case i.StartAddrsOffset:this.offset+=F.int16ToUint32(t.shortAmount);break;case i.EndAddrsOffset:this.end+=F.int16ToUint32(t.shortAmount);break;case i.StartloopAddrsOffset:this.loopStart+=F.int16ToUint32(t.shortAmount);break;case i.EndloopAddrsOffset:this.loopEnd+=F.int16ToUint32(t.shortAmount);break;case i.StartAddrsCoarseOffset:this.offset+=32768*F.int16ToUint32(t.shortAmount);break;case i.ModLfoToPitch:this.modLfoToPitch=t.shortAmount;break;case i.VibLfoToPitch:this.vibLfoToPitch=t.shortAmount;break;case i.ModEnvToPitch:this.modEnvToPitch=t.shortAmount;break;case i.InitialFilterFc:this.initialFilterFc=t.shortAmount;break;case i.InitialFilterQ:this.initialFilterQ=t.shortAmount;break;case i.ModLfoToFilterFc:this.modLfoToFilterFc=t.shortAmount;break;case i.ModEnvToFilterFc:this.modEnvToFilterFc=t.shortAmount;break;case i.EndAddrsCoarseOffset:this.end+=32768*F.int16ToUint32(t.shortAmount);break;case i.ModLfoToVolume:this.modLfoToVolume=t.shortAmount;break;case i.Pan:this.pan=t.shortAmount/1e3;break;case i.DelayModLFO:this.delayModLFO=t.shortAmount;break;case i.FreqModLFO:this.freqModLFO=t.shortAmount;break;case i.DelayVibLFO:this.delayVibLFO=t.shortAmount;break;case i.FreqVibLFO:this.freqVibLFO=t.shortAmount;break;case i.DelayModEnv:this.modEnv.delay=t.shortAmount;break;case i.AttackModEnv:this.modEnv.attack=t.shortAmount;break;case i.HoldModEnv:this.modEnv.hold=t.shortAmount;break;case i.DecayModEnv:this.modEnv.decay=t.shortAmount;break;case i.SustainModEnv:this.modEnv.sustain=t.shortAmount;break;case i.ReleaseModEnv:this.modEnv.release=t.shortAmount;break;case i.KeynumToModEnvHold:this.modEnv.keynumToHold=t.shortAmount;break;case i.KeynumToModEnvDecay:this.modEnv.keynumToDecay=t.shortAmount;break;case i.DelayVolEnv:this.ampEnv.delay=t.shortAmount;break;case i.AttackVolEnv:this.ampEnv.attack=t.shortAmount;break;case i.HoldVolEnv:this.ampEnv.hold=t.shortAmount;break;case i.DecayVolEnv:this.ampEnv.decay=t.shortAmount;break;case i.SustainVolEnv:this.ampEnv.sustain=t.shortAmount;break;case i.ReleaseVolEnv:this.ampEnv.release=t.shortAmount;break;case i.KeynumToVolEnvHold:this.ampEnv.keynumToHold=t.shortAmount;break;case i.KeynumToVolEnvDecay:this.ampEnv.keynumToDecay=t.shortAmount;break;case i.KeyRange:this.loKey=t.lowByteAmount,this.hiKey=t.highByteAmount;break;case i.VelRange:this.loVel=t.lowByteAmount,this.hiVel=t.highByteAmount;break;case i.StartloopAddrsCoarseOffset:this.loopStart+=32768*F.int16ToUint32(t.shortAmount);break;case i.InitialAttenuation:this.attenuation+=.1*t.shortAmount;break;case i.EndloopAddrsCoarseOffset:this.loopEnd+=32768*F.int16ToUint32(t.shortAmount);break;case i.CoarseTune:this.transpose+=t.shortAmount;break;case i.FineTune:this.tune+=t.shortAmount;break;case i.SampleModes:this.loopMode=3==(3&t.wordAmount)?oe.Sustain:1==(3&t.wordAmount)?oe.Continuous:oe.None;break;case i.ScaleTuning:this.pitchKeyTrack=t.shortAmount;break;case i.ExclusiveClass:this.group=t.wordAmount;break;case i.OverridingRootKey:this.pitchKeyCenter=t.shortAmount}}}(e=le=le||{})[e.None=0]="None",e[e.Delay=1]="Delay",e[e.Attack=2]="Attack",e[e.Hold=3]="Hold",e[e.Decay=4]="Decay",e[e.Sustain=5]="Sustain",e[e.Release=6]="Release",e[e.Done=7]="Done";class ii{constructor(){this.level=0,this.slope=0,this.samplesUntilNextSegment=0,this.segment=le.None,this.midiVelocity=0,this.parameters=null,this.segmentIsExponential=!1,this.isAmpEnv=!1}nextSegment(e,t){if(this.parameters)for(;;)switch(e){case le.None:if(this.samplesUntilNextSegment=this.parameters.delay*t|0,0<this.samplesUntilNextSegment)return this.segment=le.Delay,this.segmentIsExponential=!1,this.level=0,void(this.slope=0);e=le.Delay;break;case le.Delay:if(this.samplesUntilNextSegment=this.parameters.attack*t|0,0<this.samplesUntilNextSegment)return this.isAmpEnv||(this.samplesUntilNextSegment=this.parameters.attack*((145-this.midiVelocity)/144)*t|0),this.segment=le.Attack,this.segmentIsExponential=!1,this.level=0,void(this.slope=1/this.samplesUntilNextSegment);e=le.Attack;break;case le.Attack:if(this.samplesUntilNextSegment=this.parameters.hold*t|0,0<this.samplesUntilNextSegment)return this.segment=le.Hold,this.segmentIsExponential=!1,this.level=1,void(this.slope=0);e=le.Hold;break;case le.Hold:if(this.samplesUntilNextSegment=this.parameters.decay*t|0,0<this.samplesUntilNextSegment)return this.segment=le.Decay,this.level=1,void(this.isAmpEnv?(i=-9.226/this.samplesUntilNextSegment,this.slope=Math.exp(i),this.segmentIsExponential=!0,0<this.parameters.sustain&&(this.samplesUntilNextSegment=Math.log(this.parameters.sustain)/i|0)):(this.slope=-1/this.samplesUntilNextSegment,this.samplesUntilNextSegment=this.parameters.decay*(1-this.parameters.sustain)*t|0,this.segmentIsExponential=!1));e=le.Decay;break;case le.Decay:return this.segment=le.Sustain,this.level=this.parameters.sustain,this.slope=0,this.samplesUntilNextSegment=2147483647,void(this.segmentIsExponential=!1);case le.Sustain:var i;return this.segment=le.Release,this.samplesUntilNextSegment=(this.parameters.release<=0?ii.FastReleaseTime:this.parameters.release)*t|0,void(this.isAmpEnv?(i=-9.226/this.samplesUntilNextSegment,this.slope=Math.exp(i),this.segmentIsExponential=!0):(this.slope=-this.level/this.samplesUntilNextSegment,this.segmentIsExponential=!1));default:return this.segment=le.Done,this.segmentIsExponential=!1,this.level=0,this.slope=0,void(this.samplesUntilNextSegment=134217727)}}setup(e,t,i,s,a){this.parameters=new ei(e),0<this.parameters.keynumToHold&&(this.parameters.hold+=this.parameters.keynumToHold*(60-t),this.parameters.hold=this.parameters.hold<-1e4?0:Zt.timecents2Secs(this.parameters.hold)),0<this.parameters.keynumToDecay&&(this.parameters.decay+=this.parameters.keynumToDecay*(60-t),this.parameters.decay=this.parameters.decay<-1e4?0:Zt.timecents2Secs(this.parameters.decay)),this.midiVelocity=0|i,this.isAmpEnv=s,this.nextSegment(le.None,a)}process(e,t){0<this.slope&&(this.segmentIsExponential?this.level*=Math.pow(this.slope,e):this.level+=this.slope*e),this.samplesUntilNextSegment-=e,this.samplesUntilNextSegment<=0&&this.nextSegment(this.segment,t)}}ii.FastReleaseTime=.01;class si{constructor(){this.samplesUntil=0,this.level=0,this.delta=0}setup(e,t,i){this.samplesUntil=e*i|0,this.delta=4*Zt.cents2Hertz(t)/i,this.level=0}process(e){this.samplesUntil>e?this.samplesUntil-=e:(this.level+=this.delta*e,1<this.level?(this.delta=-this.delta,this.level=2-this.level):this.level<-1&&(this.delta=-this.delta,this.level=-2-this.level))}}class ai{constructor(e){this.qInv=0,this.a0=0,this.a1=0,this.b1=0,this.b2=0,this.z1=0,this.z2=0,this.active=!1,e&&(this.qInv=e.qInv,this.a0=e.a0,this.a1=e.a1,this.b1=e.b1,this.b2=e.b2,this.z1=e.z1,this.z2=e.z2,this.active=e.active)}setup(e){var e=Math.tan(Math.PI*e),t=e*e,i=1/(1+e*this.qInv+t);this.a0=t*i,this.a1=2*this.a0,this.b1=2*(t-1)*i,this.b2=(1-e*this.qInv+t)*i}process(e){var t=e*this.a0+this.z1;return this.z1=e*this.a1+this.z2-this.b1*t,this.z2=e*this.a0-this.b2*t,t}}class ri{constructor(){this.playingPreset=0,this.playingKey=0,this.playingChannel=0,this.region=null,this.pitchInputTimecents=0,this.pitchOutputFactor=0,this.sourceSamplePosition=0,this.noteGainDb=0,this.panFactorLeft=0,this.panFactorRight=0,this.playIndex=0,this.loopStart=0,this.loopEnd=0,this.ampEnv=new ii,this.modEnv=new ii,this.lowPass=new ai,this.modLfo=new si,this.vibLfo=new si,this.mixVolume=0,this.mute=!1}updatePitchRatio(e,t){let i=e.pitchWheel;e.perNotePitchWheel.has(this.playingKey)&&(i+=e.perNotePitchWheel.get(this.playingKey)-8192);e=8192===i?e.tuning:i/16383*e.pitchRange*2-e.pitchRange+e.tuning;this.calcPitchRatio(e,t)}calcPitchRatio(t,i){if(this.region){var s=this.playingKey+this.region.transpose+this.region.tune/100;let e=this.region.pitchKeyCenter+(s-this.region.pitchKeyCenter)*(this.region.pitchKeyTrack/100);0!==t&&(e+=t),this.pitchInputTimecents=100*e,this.pitchOutputFactor=this.region.sampleRate/(Zt.timecents2Secs(100*this.region.pitchKeyCenter)*i)}}end(e){this.region&&(this.ampEnv.nextSegment(le.Sustain,e),this.modEnv.nextSegment(le.Sustain,e),this.region.loopMode===oe.Sustain)&&(this.loopEnd=this.loopStart)}endQuick(e){this.ampEnv.parameters.release=0,this.ampEnv.nextSegment(le.Sustain,e),this.modEnv.parameters.release=0,this.modEnv.nextSegment(le.Sustain,e)}render(y,b,S,_,w){if(this.region){var e=this.region,v=y.presets[this.playingPreset].fontSamples;let a=0,r=y.outputMode===he.StereoUnweaved?_:-1;var B=0!==e.modEnvToPitch||0!==e.modEnvToFilterFc,T=0<this.modLfo.delta&&(0!==e.modLfoToPitch||0!==e.modLfoToFilterFc||0!==e.modLfoToVolume),k=0<this.vibLfo.delta&&0!==e.vibLfoToPitch,N=this.loopStart<this.loopEnd,x=this.loopStart,P=this.loopEnd,E=e.end,C=P+1;let n=this.sourceSamplePosition;var F=new ai(this.lowPass),L=0!==e.modLfoToFilterFc||0!==e.modEnvToFilterFc;let o=0,h=0,l=0,d=0;var M=0!==e.modLfoToPitch||0!==e.modEnvToPitch||0!==e.vibLfoToPitch;let c=0,u=0,p=0,g=0;var D,I=0!==e.modLfoToVolume;let m=0,f=0;for(d=L?(o=y.outSampleRate,h=e.initialFilterFc,l=e.modLfoToFilterFc,e.modEnvToFilterFc):(o=0,h=0,l=0),g=M?(c=0,u=e.modLfoToPitch,p=e.vibLfoToPitch,e.modEnvToPitch):(c=Zt.timecents2Secs(this.pitchInputTimecents)*this.pitchOutputFactor,u=0,p=0),f=I?.1*e.modLfoToVolume:(m=Zt.decibelsToGain(this.noteGainDb),0);0<_;){let t,i,s=0,e=_>ri.RenderEffectSampleBlock?ri.RenderEffectSampleBlock:_;switch(_-=e,L&&(D=h+this.modLfo.level*l+this.modEnv.level*d,F.active=D<=13500,F.active)&&F.setup(Zt.cents2Hertz(D)/o),M&&(c=Zt.timecents2Secs(this.pitchInputTimecents+(this.modLfo.level*u+this.vibLfo.level*p+this.modEnv.level*g))*this.pitchOutputFactor),I&&(m=Zt.decibelsToGain(this.noteGainDb+this.modLfo.level*f)),t=m*this.ampEnv.level,w?t=0:t*=this.mixVolume,this.ampEnv.process(e,y.outSampleRate),B&&this.modEnv.process(e,y.outSampleRate),T&&this.modLfo.process(e),k&&this.vibLfo.process(e),y.outputMode){case he.StereoInterleaved:for(i=t*this.panFactorLeft,s=t*this.panFactorRight;0<e--&&n<E;){var R=0|n,A=n-R;let e=v[R]*(1-A)+v[P<=R&&N?x:1+R]*A;F.active&&(e=F.process(e)),b[S+a]+=e*i,b[S+ ++a]+=e*s,a++,(n+=c)>=C&&N&&(n-=P-x+1)}break;case he.StereoUnweaved:for(i=t*this.panFactorLeft,s=t*this.panFactorRight;0<e--&&n<E;){var O=0|n,G=n-O;let e=v[O]*(1-G)+v[P<=O&&N?x:1+O]*G;F.active&&(e=F.process(e)),b[S+a]+=e*i,a++,b[S+r]+=e*s,r++,(n+=c)>=C&&N&&(n-=P-x+1)}break;case he.Mono:for(;0<e--&&n<E;){var H=0|n,V=n-H;let e=v[H]*(1-V)+v[P<=H&&N?x:1+H]*V;F.active&&(e=F.process(e)),b[S+a]=e*t,a++,(n+=c)>=C&&N&&(n-=P-x+1)}}if(n>=E||this.ampEnv.segment===le.Done)return void this.kill()}this.sourceSamplePosition=n,(F.active||L)&&(this.lowPass=F)}}kill(){this.playingPreset=-1}}ri.RenderEffectSampleBlock=D.MicroBufferSize;class ni{constructor(){this._items=[],this._position=0,this.isEmpty=!0}clear(){this._items=[],this._position=0,this.isEmpty=!0}enqueue(e){this.isEmpty=!1,this._items.push(e)}peek(){return this._items[this._position]}dequeue(){var e=this._items[this._position];return this._position++,this._position>=this._items.length/2&&(this._items=this._items.slice(this._position),this._position=0),this.isEmpty=0==this._items.length,e}toArray(){var e=this._items.slice(this._position);return e.reverse(),e}}class oi{constructor(e){this._midiEventQueue=new ni,this._mutedChannels=new Map,this._soloChannels=new Map,this._isAnySolo=!1,this.currentTempo=0,this.timeSignatureNumerator=0,this.timeSignatureDenominator=0,this.presets=null,this._voices=[],this._channels=null,this._voicePlayIndex=0,this.outputMode=he.StereoInterleaved,this.outSampleRate=0,this.globalGainDb=0,this.outSampleRate=e}synthesize(e,t,i){return this.fillWorkingBuffer(e,t,i)}synthesizeSilent(e){this.fillWorkingBuffer(null,0,e)}channelGetMixVolume(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].mixVolume:1}channelSetMixVolume(e,t){var i,s=this.channelInit(e);for(i of this._voices)i.playingChannel===e&&-1!==i.playingPreset&&(i.mixVolume=t);s.mixVolume=t}channelSetMute(e,t){t?this._mutedChannels.set(e,!0):this._mutedChannels.delete(e)}channelSetSolo(e,t){t?this._soloChannels.set(e,!0):this._soloChannels.delete(e),this._isAnySolo=0<this._soloChannels.size}resetChannelStates(){this._mutedChannels=new Map,this._soloChannels=new Map,this._isAnySolo=!1}dispatchEvent(e){this._midiEventQueue.enqueue(e)}fillWorkingBuffer(e,t,i){for(var s,a=this._isAnySolo,r=[];!this._midiEventQueue.isEmpty;){var n=this._midiEventQueue.dequeue();n.isMetronome&&0<this.metronomeVolume?(this.channelNoteOff(D.MetronomeChannel,33),this.channelNoteOn(D.MetronomeChannel,33,95/127)):n.event&&this.processMidiMessage(n.event),r.push(n)}for(const o of this._voices)-1!==o.playingPreset&&(s=o.playingChannel,s=this._mutedChannels.has(s)||a&&s!=D.MetronomeChannel&&!this._soloChannels.has(s),e?o.render(this,e,t,i,s):o.kill());return r}processMidiMessage(e){var t=e.command,i=e.channel,s=e.data1,a=e.data2;switch(t){case se.NoteOff:this.channelNoteOff(i,s);break;case se.NoteOn:this.channelNoteOn(i,s,a/127);break;case se.NoteAftertouch:break;case se.Controller:this.channelMidiControl(i,s,a);break;case se.ProgramChange:this.channelSetPresetNumber(i,s,9===i);break;case se.ChannelAftertouch:break;case se.PitchBend:this.channelSetPitchWheel(i,s|a<<7);break;case se.PerNotePitchBend:var r=e,n=r.pitch*D.MaxPitchWheel/D.MaxPitchWheel20;this.channelSetPerNotePitchWheel(i,r.noteKey,n);break;case se.Meta:switch(e.data1){case ae.Tempo:this.currentTempo=6e7/e.value;break;case ae.TimeSignature:this.timeSignatureNumerator=e.data[0],this.timeSignatureDenominator=Math.pow(2,e.data[1])}}}get metronomeVolume(){return this.channelGetMixVolume(D.MetronomeChannel)}set metronomeVolume(e){this.setupMetronomeChannel(e)}setupMetronomeChannel(e){this.channelSetMixVolume(D.MetronomeChannel,e),0<e&&(this.channelSetVolume(D.MetronomeChannel,1),this.channelSetPresetNumber(D.MetronomeChannel,0,!0))}get masterVolume(){return Zt.decibelsToGain(this.globalGainDb)}set masterVolume(e){var e=Zt.gainToDecibels(e),t=e-this.globalGainDb;if(0!=t){for(const i of this._voices)-1!==i.playingPreset&&(i.noteGainDb+=t);this.globalGainDb=e}}resetSoft(){for(const e of this._voices)-1!==e.playingPreset&&(e.ampEnv.segment<le.Release||0!==e.ampEnv.parameters.release)&&e.endQuick(this.outSampleRate);if(this._channels)for(const t of this._channels.channelList)t.presetIndex=0,t.bank=0,t.pitchWheel=8192,t.midiPan=8192,t.perNotePitchWheel.clear(),t.midiVolume=16383,t.midiExpression=16383,t.midiRpn=65535,t.midiData=0,t.panOffset=0,t.gainDb=0,t.pitchRange=2,t.tuning=0}get presetCount(){var e;return null!=(e=null==(e=this.presets)?void 0:e.length)?e:0}reset(){for(var e of this._voices)-1!==e.playingPreset&&(e.ampEnv.segment<le.Release||0!==e.ampEnv.parameters.release)&&e.endQuick(this.outSampleRate);this._channels=null}setOutput(e,t,i){this.outputMode=e,this.outSampleRate=1<=t?t:44100,this.globalGainDb=i}noteOn(t,i,s){if(this.presets){var a=127*s|0;if(!(t<0||t>=this.presets.length))if(s<=0)this.noteOff(t,i);else{var r=this._voicePlayIndex++;for(const l of this.presets[t].regions)if(!(i<l.loKey||i>l.hiKey||a<l.loVel||a>l.hiVel)){let e=null;if(0!==l.group)for(const d of this._voices)d.playingPreset===t&&d.region.group===l.group?d.endQuick(this.outSampleRate):-1===d.playingPreset&&(e=e||d);else for(var n of this._voices)-1===n.playingPreset&&(e=n);if(!e){for(let e=0;e<4;e++){var o=new ri;o.playingPreset=-1,this._voices.push(o)}e=this._voices[this._voices.length-4]}e.region=l,e.playingPreset=t,e.playingKey=i,e.playIndex=r,e.noteGainDb=this.globalGainDb-l.attenuation-Zt.gainToDecibels(1/s),this._channels?this._channels.setupVoice(this,e):(e.calcPitchRatio(0,this.outSampleRate),e.panFactorLeft=Math.sqrt(.5-l.pan),e.panFactorRight=Math.sqrt(.5+l.pan)),e.sourceSamplePosition=l.offset;var h=l.loopMode!==oe.None&&l.loopStart<l.loopEnd,h=(e.loopStart=h?l.loopStart:0,e.loopEnd=h?l.loopEnd:0,e.ampEnv.setup(l.ampEnv,i,a,!0,this.outSampleRate),e.modEnv.setup(l.modEnv,i,a,!1,this.outSampleRate),l.initialFilterQ/10);e.lowPass.qInv=1/Math.pow(10,h/20),e.lowPass.z1=0,e.lowPass.z2=0,e.lowPass.active=l.initialFilterFc<=13500,e.lowPass.active&&e.lowPass.setup(Zt.cents2Hertz(l.initialFilterFc)/this.outSampleRate),e.modLfo.setup(l.delayModLFO,l.freqModLFO,this.outSampleRate),e.vibLfo.setup(l.delayVibLFO,l.freqVibLFO,this.outSampleRate)}}}}bankNoteOn(e,t,i,s){e=this.getPresetIndex(e,t);return-1!==e&&(this.noteOn(e,i,s),!0)}noteOff(e,t){let i=null,s=null;var a,r=[];for(a of this._voices)a.playingPreset!==e||a.playingKey!==t||a.ampEnv.segment>=le.Release||(!i||a.playIndex<i.playIndex?(i=a,s=a,r.push(a)):a.playIndex===i.playIndex&&(s=a,r.push(a)));if(i)for(const n of r)n!==i&&n!==s&&(n.playIndex!==i.playIndex||n.playingPreset!==e||n.playingKey!==t||n.ampEnv.segment>=le.Release)||n.end(this.outSampleRate)}bankNoteOff(e,t,i){e=this.getPresetIndex(e,t);return-1!==e&&(this.noteOff(e,i),!0)}noteOffAll(e){for(const t of this._voices)-1!==t.playingPreset&&t.ampEnv.segment<le.Release&&(e?t.endQuick(this.outSampleRate):t.end(this.outSampleRate))}get activeVoiceCount(){let e=0;for(const t of this._voices)-1!==t.playingPreset&&e++;return e}channelInit(t){if(!(this._channels&&t<this._channels.channelList.length)){this._channels||(this._channels=new Kt);for(let e=this._channels.channelList.length;e<=t;e++){var i=new Qt;i.presetIndex=0,i.bank=0,i.pitchWheel=8192,i.midiPan=8192,i.midiVolume=16383,i.midiExpression=16383,i.midiRpn=65535,i.midiData=0,i.panOffset=0,i.gainDb=0,i.pitchRange=2,i.tuning=0,i.mixVolume=1,this._channels.channelList.push(i)}}return this._channels.channelList[t]}getPresetIndex(t,i){if(this.presets)for(let e=this.presets.length-1;0<=e;e--){var s=this.presets[e];if(s.presetNumber===i&&s.bank===t)return e}return-1}getPresetName(e){return!this.presets||e<0||e>=this.presets.length?null:this.presets[e].name}bankGetPresetName(e,t){return this.getPresetName(this.getPresetIndex(e,t))}channelNoteOn(e,t,i){!this._channels||e>this._channels.channelList.length||(this._channels.activeChannel=e,this.noteOn(this._channels.channelList[e].presetIndex,t,i))}channelNoteOff(e,t){var i=[];let s=null,a=null;for(const r of this._voices)-1===r.playingPreset||r.playingChannel!==e||r.playingKey!==t||r.ampEnv.segment>=le.Release||(!s||r.playIndex<s.playIndex?(s=r,a=r,i.push(r)):r.playIndex===s.playIndex&&(a=r,i.push(r)));if(this.channelInit(e).perNotePitchWheel.delete(t),s)for(const n of i)n!==s&&n!==a&&(n.playIndex!==s.playIndex||-1===n.playingPreset||n.playingChannel!==e||n.playingKey!==t||n.ampEnv.segment>=le.Release)||n.end(this.outSampleRate)}channelNoteOffAll(e){this.channelInit(e).perNotePitchWheel.clear();for(const t of this._voices)-1!==t.playingPreset&&t.playingChannel===e&&t.ampEnv.segment<le.Release&&t.end(this.outSampleRate)}channelSoundsOffAll(e){var t;this.channelInit(e).perNotePitchWheel.clear();for(t of this._voices)-1!==t.playingPreset&&t.playingChannel===e&&(t.ampEnv.segment<le.Release||0===t.ampEnv.parameters.release)&&t.endQuick(this.outSampleRate)}channelSetPresetIndex(e,t){this.channelInit(e).presetIndex=F.int32ToUint16(t)}channelSetPresetNumber(e,t,i=!1){e=this.channelInit(e);let s=0;return i&&-1!==(s=-1===(s=-1===(s=this.getPresetIndex(128|32767&e.bank,t))?this.getPresetIndex(128,t):s)?this.getPresetIndex(128,0):s)||(s=this.getPresetIndex(2047&e.bank,t)),-1!==(e.presetIndex=s)}channelSetBank(e,t){this.channelInit(e).bank=F.int32ToUint16(t)}channelSetBankPreset(e,t,i){e=this.channelInit(e),i=this.getPresetIndex(t,i);return-1!==i&&(e.presetIndex=F.int32ToUint16(i),e.bank=F.int32ToUint16(t),!0)}channelSetPan(e,t){for(const s of this._voices){var i;s.playingChannel===e&&-1!==s.playingPreset&&((i=s.region.pan+t-.5)<=-.5?(s.panFactorLeft=1,s.panFactorRight=0):.5<=i?(s.panFactorLeft=0,s.panFactorRight=1):(s.panFactorLeft=Math.sqrt(.5-i),s.panFactorRight=Math.sqrt(.5+i)))}this.channelInit(e).panOffset=t-.5}channelSetVolume(e,t){var i=this.channelInit(e),t=Zt.gainToDecibels(t),s=t-i.gainDb;if(0!=s){for(const a of this._voices)a.playingChannel===e&&-1!==a.playingPreset&&(a.noteGainDb+=s);i.gainDb=t}}channelSetPitchWheel(e,t){var i=this.channelInit(e);i.pitchWheel!==t&&(i.pitchWheel=F.int32ToUint16(t),this.channelApplyPitch(e,i))}channelSetPerNotePitchWheel(e,t,i){var s=this.channelInit(e);s.perNotePitchWheel.has(t)&&s.perNotePitchWheel.get(t)===i||(s.perNotePitchWheel.set(t,i),this.channelApplyPitch(e,s,t))}channelApplyPitch(e,t,i=-1){for(const s of this._voices)s.playingChannel!==e||-1===s.playingPreset||-1!=i&&s.playingKey!==i||s.updatePitchRatio(t,this.outSampleRate)}channelSetPitchRange(e,t){var i=this.channelInit(e);i.pitchRange!==t&&(i.pitchRange=t,8192!==i.pitchWheel)&&this.channelApplyPitch(e,i)}channelSetTuning(e,t){var i=this.channelInit(e);i.tuning!==t&&(i.tuning=t,this.channelApplyPitch(e,i))}channelMidiControl(e,t,i){var s=this.channelInit(e);switch(t){case 5:case 96:case 97:case 64:case 65:case 66:case 122:case 124:case 125:case 126:case 127:return;case 38:return s.midiData=F.int32ToUint16(16256&s.midiData|i),void(0===s.midiRpn?this.channelSetPitchRange(e,(s.midiData>>7)+.01*(127&s.midiData)):1===s.midiRpn?this.channelSetTuning(e,(0|s.tuning)+(s.midiData-8192)/8192):2===s.midiRpn&&this.channelSetTuning(e,i-64+(s.tuning-(0|s.tuning))));case 7:return s.midiVolume=F.int32ToUint16(127&s.midiVolume|i<<7),void this.channelSetVolume(e,Math.pow(s.midiVolume/16383*(s.midiExpression/16383),3));case 39:return s.midiVolume=F.int32ToUint16(16256&s.midiVolume|i),void this.channelSetVolume(e,Math.pow(s.midiVolume/16383*(s.midiExpression/16383),3));case 11:return s.midiExpression=F.int32ToUint16(127&s.midiExpression|i<<7),void this.channelSetVolume(e,Math.pow(s.midiVolume/16383*(s.midiExpression/16383),3));case 43:return s.midiExpression=F.int32ToUint16(16256&s.midiExpression|i),void this.channelSetVolume(e,Math.pow(s.midiVolume/16383*(s.midiExpression/16383),3));case 10:return s.midiPan=F.int32ToUint16(127&s.midiPan|i<<7),void this.channelSetPan(e,s.midiPan/16383);case 42:return s.midiPan=F.int32ToUint16(16256&s.midiPan|i),void this.channelSetPan(e,s.midiPan/16383);case 6:return s.midiData=F.int32ToUint16(127&s.midiData|i<<7),void(0===s.midiRpn?this.channelSetPitchRange(e,(s.midiData>>7)+.01*(127&s.midiData)):1===s.midiRpn?this.channelSetTuning(e,(0|s.tuning)+(s.midiData-8192)/8192):2===s.midiRpn&&6===t&&this.channelSetTuning(e,i-64+(s.tuning-(0|s.tuning))));case 0:return void(s.bank=F.int32ToUint16(32768|i));case 32:return void(s.bank=F.int32ToUint16((0!=(32768&s.bank)?(127&s.bank)<<7:0)|i));case 101:return void(s.midiRpn=F.int32ToUint16(127&(65535===s.midiRpn?0:s.midiRpn)|i<<7));case 100:return void(s.midiRpn=F.int32ToUint16(16256&(65535===s.midiRpn?0:s.midiRpn)|i));case 98:case 99:return void(s.midiRpn=65535);case 120:return void this.channelSoundsOffAll(e);case 123:return void this.channelNoteOffAll(e);case 121:return s.midiVolume=16383,s.midiExpression=16383,s.midiPan=8192,s.bank=0,this.channelSetVolume(e,1),this.channelSetPan(e,.5),void this.channelSetPitchRange(e,2)}}channelGetPresetIndex(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].presetIndex:0}channelGetPresetBank(e){return this._channels&&e<this._channels.channelList.length?32767&this._channels.channelList[e].bank:0}channelGetPan(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].panOffset-.5:.5}channelGetVolume(e){return this._channels&&e<this._channels.channelList.length?Zt.decibelsToGain(this._channels.channelList[e].gainDb):1}channelGetPitchWheel(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].pitchWheel:8192}channelGetPitchRange(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].pitchRange:2}channelGetTuning(e){return this._channels&&e<this._channels.channelList.length?this._channels.channelList[e].tuning:0}resetPresets(){this.presets=[]}loadPresets(c,e){var t=[];for(let a=0;a<c.phdrs.length-1;a++){var r=c.phdrs[a];let s=0;var n=new $t;t.push(n),n.name=r.presetName,n.bank=r.bank,n.presetNumber=r.preset,n.fontSamples=c.fontSamples;let d=0;for(let t=r.presetBagNdx;t<c.phdrs[a+1].presetBagNdx;t++){let n=0,o=127,h=0,l=127;for(let e=c.pbags[t].genNdx;e<c.pbags[t+1].genNdx;e++){var i=c.pgens[e];if(i.genOper===Xt.GenKeyRange)n=i.genAmount.lowByteAmount,o=i.genAmount.highByteAmount;else if(i.genOper===Xt.GenVelRange)h=i.genAmount.lowByteAmount,l=i.genAmount.highByteAmount;else if(i.genOper===Xt.GenInstrument)if(!(i.genAmount.wordAmount>=c.insts.length))for(let r=c.insts[i.genAmount.wordAmount].instBagNdx;r<c.insts[i.genAmount.wordAmount+1].instBagNdx;r++){let t=0,i=127,s=0,a=127;for(let e=c.ibags[r].instGenNdx;e<c.ibags[r+1].instGenNdx;e++){var u=c.igens[e];u.genOper===Xt.GenKeyRange?(t=u.genAmount.lowByteAmount,i=u.genAmount.highByteAmount):u.genOper===Xt.GenVelRange?(s=u.genAmount.lowByteAmount,a=u.genAmount.highByteAmount):53===u.genOper&&i>=n&&t<=o&&a>=h&&s<=l&&d++}}}}n.regions=new Array(d);let e=new ti;e.clear(!0);for(let i=r.presetBagNdx;i<c.phdrs[a+1].presetBagNdx;i++){var o=c.pbags[i],h=new ti(e);let t=!1;for(let e=o.genNdx;e<c.pbags[i+1].genNdx;e++){var l=c.pgens[e];if(l.genOper===Xt.GenInstrument){var p=l.genAmount.wordAmount;if(!(p>=c.insts.length)){let e=new ti;e.clear(!1);var g=c.insts[p];for(let i=g.instBagNdx;i<c.insts[p+1].instBagNdx;i++){var m=c.ibags[i],f=new ti(e);let t=!1;for(let e=m.instGenNdx;e<c.ibags[i+1].instGenNdx;e++){var y,b=c.igens[e];b.genOper===Xt.GenSampleId?f.hiKey<h.loKey||f.loKey>h.hiKey||f.hiVel<h.loVel||f.loVel>h.hiVel||(h.loKey>f.loKey&&(f.loKey=h.loKey),h.hiKey<f.hiKey&&(f.hiKey=h.hiKey),h.loVel>f.loVel&&(f.loVel=h.loVel),h.hiVel<f.hiVel&&(f.hiVel=h.hiVel),f.offset+=h.offset,f.end+=h.end,f.loopStart+=h.loopStart,f.loopEnd+=h.loopEnd,f.transpose+=h.transpose,f.tune+=h.tune,f.pitchKeyTrack+=h.pitchKeyTrack,f.attenuation+=h.attenuation,f.pan+=h.pan,f.ampEnv.delay+=h.ampEnv.delay,f.ampEnv.attack+=h.ampEnv.attack,f.ampEnv.hold+=h.ampEnv.hold,f.ampEnv.decay+=h.ampEnv.decay,f.ampEnv.sustain+=h.ampEnv.sustain,f.ampEnv.release+=h.ampEnv.release,f.modEnv.delay+=h.modEnv.delay,f.modEnv.attack+=h.modEnv.attack,f.modEnv.hold+=h.modEnv.hold,f.modEnv.decay+=h.modEnv.decay,f.modEnv.sustain+=h.modEnv.sustain,f.modEnv.release+=h.modEnv.release,f.initialFilterQ+=h.initialFilterQ,f.initialFilterFc+=h.initialFilterFc,f.modEnvToPitch+=h.modEnvToPitch,f.modEnvToFilterFc+=h.modEnvToFilterFc,f.delayModLFO+=h.delayModLFO,f.freqModLFO+=h.freqModLFO,f.modLfoToPitch+=h.modLfoToPitch,f.modLfoToFilterFc+=h.modLfoToFilterFc,f.modLfoToVolume+=h.modLfoToVolume,f.delayVibLFO+=h.delayVibLFO,f.freqVibLFO+=h.freqVibLFO,f.vibLfoToPitch+=h.vibLfoToPitch,f.ampEnv.envToSecs(!0),f.modEnv.envToSecs(!1),f.delayModLFO=f.delayModLFO<-11950?0:Zt.timecents2Secs(f.delayModLFO),f.delayVibLFO=f.delayVibLFO<-11950?0:Zt.timecents2Secs(f.delayVibLFO),f.pan<-.5?f.pan=-.5:.5<f.pan&&(f.pan=.5),(f.initialFilterQ<1500||13500<f.initialFilterQ)&&(f.initialFilterQ=0),y=c.sHdrs[b.genAmount.wordAmount],f.offset+=y.start,f.end+=y.end,f.loopStart+=y.startLoop,f.loopEnd+=y.endLoop,0<y.endLoop&&--f.loopEnd,-1===f.pitchKeyCenter&&(f.pitchKeyCenter=y.originalPitch),f.tune+=y.pitchCorrection,f.sampleRate=y.sampleRate,0!==f.end&&f.end<n.fontSamples.length?f.end++:f.end=n.fontSamples.length,n.regions[s]=new ti(f),s++,t=!0):f.operator(b.genOper,b.genAmount)}m!==c.ibags[g.instBagNdx]||t||(e=new ti(f))}t=!0}}else h.operator(l.genOper,l.genAmount)}o!==c.pbags[r.presetBagNdx]||t||(e=h)}}if(e&&this.presets)for(const s of t)this.presets.push(s);else this.presets=t}}class hi{constructor(){this._listeners=[]}on(e){this._listeners.push(e)}off(t){this._listeners=this._listeners.filter(e=>e!==t)}trigger(){for(const e of this._listeners)e()}}class li{constructor(){this._listeners=[]}on(e){this._listeners.push(e)}off(t){this._listeners=this._listeners.filter(e=>e!==t)}trigger(e){for(const t of this._listeners)t(e)}}class di{constructor(e){this.events=e}}class ci{constructor(e){this.playbackRange=e}}class ui{constructor(e,t){this._isSoundFontLoaded=!1,this._isMidiLoaded=!1,this._tickPosition=0,this._timePosition=0,this._metronomeVolume=0,this._countInVolume=0,this._playedEventsQueue=new ni,this._midiEventsPlayedFilter=new Set,this._notPlayedSamples=0,this.isReady=!1,this.state=ne.Paused,this.ready=new hi,this.readyForPlayback=new hi,this.finished=new hi,this.soundFontLoaded=new hi,this.soundFontLoadFailed=new li,this.midiLoaded=new li,this.midiLoadFailed=new li,this.stateChanged=new li,this.positionChanged=new li,this.midiEventsPlayed=new li,this.playbackRangeChanged=new li,C.debug("AlphaSynth","Initializing player"),this.state=ne.Paused,C.debug("AlphaSynth","Creating output"),this.output=e,C.debug("AlphaSynth","Creating synthesizer"),this._synthesizer=new oi(this.output.sampleRate),this._sequencer=new It(this._synthesizer),C.debug("AlphaSynth","Opening output"),this.output.ready.on(()=>{this.isReady=!0,this.ready.trigger(),this.checkReadyForPlayback()}),this.output.sampleRequest.on(()=>{if(this._sequencer.isFinished){var e=new Float32Array(0);this.output.addSamples(e)}else{let t=new Float32Array(D.MicroBufferSize*D.MicroBufferCount*D.AudioChannels),i=0;for(let e=0;e<D.MicroBufferCount;e++){this._sequencer.fillMidiEventQueue();var s=this._synthesizer.synthesize(t,i,D.MicroBufferSize);i+=D.MicroBufferSize*D.AudioChannels;for(const a of s)this._midiEventsPlayedFilter.has(a.event.command)&&this._playedEventsQueue.enqueue(a);if(this._sequencer.isFinished)break}i<t.length&&(t=t.subarray(0,i)),this._notPlayedSamples+=t.length,this.output.addSamples(t)}}),this.output.samplesPlayed.on(this.onSamplesPlayed.bind(this)),this.output.open(t)}get isReadyForPlayback(){return this.isReady&&this._isSoundFontLoaded&&this._isMidiLoaded}get logLevel(){return C.logLevel}set logLevel(e){C.logLevel=e}get masterVolume(){return this._synthesizer.masterVolume}set masterVolume(e){e=Math.max(e,D.MinVolume),this._synthesizer.masterVolume=e}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Math.max(e,D.MinVolume),this._metronomeVolume=e,this._synthesizer.metronomeVolume=e}get countInVolume(){return this._countInVolume}set countInVolume(e){e=Math.max(e,D.MinVolume),this._countInVolume=e}get midiEventsPlayedFilter(){return Array.from(this._midiEventsPlayedFilter)}set midiEventsPlayedFilter(e){this._midiEventsPlayedFilter=new Set(e)}get playbackSpeed(){return this._sequencer.playbackSpeed}set playbackSpeed(e){e=Zt.clamp(e,D.MinPlaybackSpeed,D.MaxPlaybackSpeed);var t=this._sequencer.playbackSpeed;this._sequencer.playbackSpeed=e,this.timePosition=this.timePosition*(t/e)}get tickPosition(){return this._tickPosition}set tickPosition(e){this.timePosition=this._sequencer.mainTickPositionToTimePosition(e)}get timePosition(){return this._timePosition}set timePosition(e){C.debug("AlphaSynth",`Seeking to position ${e}ms (main)`),this._sequencer.mainSeek(e),this.updateTimePosition(e,!0),this._sequencer.isPlayingMain&&(this._notPlayedSamples=0,this.output.resetSamples())}get playbackRange(){return this._sequencer.mainPlaybackRange}set playbackRange(e){(this._sequencer.mainPlaybackRange=e)&&(this.tickPosition=e.startTick),this.playbackRangeChanged.trigger(new ci(e))}get isLooping(){return this._sequencer.isLooping}set isLooping(e){this._sequencer.isLooping=e}destroy(){C.debug("AlphaSynth","Destroying player"),this.stop(),this.output.destroy()}play(){return!(this.state!==ne.Paused||!this._isMidiLoaded||(this.output.activate(),this.playInternal(),0<this._countInVolume&&(C.debug("AlphaSynth","Starting countin"),this._sequencer.startCountIn(),this._synthesizer.setupMetronomeChannel(this._countInVolume),this.updateTimePosition(0,!0)),this.output.play(),0))}playInternal(){this._sequencer.isPlayingOneTimeMidi&&(C.debug("AlphaSynth","Cancelling one time midi"),this.stopOneTimeMidi()),C.debug("AlphaSynth","Starting playback"),this._synthesizer.setupMetronomeChannel(this.metronomeVolume),this.state=ne.Playing,this.stateChanged.trigger(new Rt(this.state,!1))}pause(){this.state!==ne.Paused&&this._isMidiLoaded&&(C.debug("AlphaSynth","Pausing playback"),this.state=ne.Paused,this.stateChanged.trigger(new Rt(this.state,!1)),this.output.pause(),this._synthesizer.noteOffAll(!1))}playPause(){this.state===ne.Paused&&this._isMidiLoaded?this.play():this.pause()}stop(){this._isMidiLoaded&&(C.debug("AlphaSynth","Stopping playback"),this.state=ne.Paused,this.output.pause(),this._notPlayedSamples=0,this._sequencer.stop(),this._synthesizer.noteOffAll(!0),this.tickPosition=this._sequencer.mainPlaybackRange?this._sequencer.mainPlaybackRange.startTick:0,this.stateChanged.trigger(new Rt(this.state,!0)))}playOneTimeMidiFile(e){this._sequencer.isPlayingOneTimeMidi?this.stopOneTimeMidi():this.pause(),this._sequencer.loadOneTimeMidi(e),this._synthesizer.noteOffAll(!0),this.updateTimePosition(0,!0),this._notPlayedSamples=0,this.output.resetSamples(),this.output.play()}resetSoundFonts(){this.stop(),this._synthesizer.resetPresets(),this._isSoundFontLoaded=!1,this.soundFontLoaded.trigger()}loadSoundFont(e,t){this.pause();e=qe.fromBuffer(e);try{C.debug("AlphaSynth","Loading soundfont from bytes");var i=new Gt;i.load(e),this._synthesizer.loadPresets(i,t),this._isSoundFontLoaded=!0,this.soundFontLoaded.trigger(),C.debug("AlphaSynth","soundFont successfully loaded"),this.checkReadyForPlayback()}catch(e){C.error("AlphaSynth","Could not load soundfont from bytes "+e),this.soundFontLoadFailed.trigger(e)}}checkReadyForPlayback(){this.isReadyForPlayback&&(this._synthesizer.setupMetronomeChannel(this.metronomeVolume),this.readyForPlayback.trigger())}loadMidiFile(e){this.stop();try{C.debug("AlphaSynth","Loading midi from model"),this._sequencer.loadMidi(e),this._isMidiLoaded=!0,this.midiLoaded.trigger(new At(0,this._sequencer.currentEndTime,0,this._sequencer.currentEndTick,!1)),C.debug("AlphaSynth","Midi successfully loaded"),this.checkReadyForPlayback(),this.tickPosition=0}catch(e){C.error("AlphaSynth","Could not load midi from model "+e),this.midiLoadFailed.trigger(e)}}setChannelMute(e,t){this._synthesizer.channelSetMute(e,t)}resetChannelStates(){this._synthesizer.resetChannelStates()}setChannelSolo(e,t){this._synthesizer.channelSetSolo(e,t)}setChannelVolume(e,t){t=Math.max(t,D.MinVolume),this._synthesizer.channelSetMixVolume(e,t)}onSamplesPlayed(e){var t;0!==e&&(t=e/this._synthesizer.outSampleRate*1e3,this._notPlayedSamples-=e*D.AudioChannels,this.updateTimePosition(this._timePosition+t,!1),this.checkForFinish())}checkForFinish(){let e=0,t=0;t=this.playbackRange?(e=this.playbackRange.startTick,this.playbackRange.endTick):this._sequencer.currentEndTick,this._tickPosition>=t&&this._notPlayedSamples<=0&&(this._notPlayedSamples=0,this._sequencer.isPlayingCountIn?(C.debug("AlphaSynth","Finished playback (count-in)"),this._sequencer.resetCountIn(),this.timePosition=this._sequencer.currentTime,this.playInternal(),this.output.resetSamples()):this._sequencer.isPlayingOneTimeMidi?(C.debug("AlphaSynth","Finished playback (one time)"),this.output.resetSamples(),this.state=ne.Paused,this.stopOneTimeMidi()):(C.debug("AlphaSynth","Finished playback (main)"),this.finished.trigger(),this.isLooping?this.tickPosition=e:this.stop()))}stopOneTimeMidi(){this.output.pause(),this._synthesizer.noteOffAll(!0),this._sequencer.resetOneTimeMidi(),this.timePosition=this._sequencer.currentTime}updateTimePosition(e,t){var i=e,e=(this._timePosition=i,this._sequencer.currentTimePositionToTickPosition(i)),s=(this._tickPosition=e,this._sequencer.currentEndTime),a=this._sequencer.currentEndTick,r=this._sequencer.isPlayingMain?"main":this._sequencer.isPlayingCountIn?"count-in":"one-time";if(C.debug("AlphaSynth",`Position changed: (time: ${i}/${s}, tick: ${e}/${a}, Active Voices: ${this._synthesizer.activeVoiceCount} (${r})`),this._sequencer.isPlayingMain&&this.positionChanged.trigger(new At(i,s,e,a,t)),t)this._playedEventsQueue.clear();else{for(var n=new ni;!this._playedEventsQueue.isEmpty&&this._playedEventsQueue.peek().time<i;){var o=this._playedEventsQueue.dequeue();n.enqueue(o.event)}n.isEmpty||this.midiEventsPlayed.trigger(new di(n.toArray()))}}}class pi{constructor(){this.division=p.QuarterTime,this.events=[]}addEvent(t){if(0===this.events.length)this.events.push(t);else{let e=this.events.length;for(;0<e;){if(!(this.events[e-1].tick>t.tick))break;e--}this.events.splice(e,0,t)}}toBinary(){var e=qe.empty();return this.writeTo(e),e.toArray()}writeTo(e){var t,i=new Uint8Array([77,84,104,100]),i=(e.write(i,0,i.length),i=new Uint8Array([0,0,0,6]),e.write(i,0,i.length),i=new Uint8Array([0,0]),e.write(i,0,i.length),new Uint8Array([0,1])),s=(e.write(i,0,i.length),n=this.division,i=new Uint8Array([n>>8&255,255&n]),e.write(i,0,i.length),qe.empty());let a=0;for(t of this.events){var r=t.tick-a;pi.writeVariableInt(s,r),t.writeTo(s),a=t.tick}i=new Uint8Array([77,84,114,107]),e.write(i,0,i.length);var n=s.toArray(),o=n.length;i=new Uint8Array([o>>24&255,o>>16&255,o>>8&255,255&o]),e.write(i,0,i.length),e.write(n,0,n.length)}static writeVariableInt(e,t){var i=new Uint8Array(4);let s=0;for(;i[s++]=127&t,0<(t>>=7););for(;0<s;)0<--s?e.writeByte(128|i[s]):e.writeByte(i[s])}}class gi extends Et{constructor(e,t,i,s,a){super(e,t,i,s,0),this.data=a}writeTo(e){e.writeByte(255),e.writeByte(this.metaStatus);var t=this.data.length;pi.writeVariableInt(e,t),e.write(this.data,0,this.data.length)}}class mi extends Et{constructor(e,t,i,s,a){super(e,t,i,s,0),this.value=a}writeTo(e){e.writeByte(255),e.writeByte(this.metaStatus),pi.writeVariableInt(e,3);var t=new Uint8Array([this.value>>16&255,this.value>>8&255,255&this.value]);e.write(t,0,t.length)}}class I{static parseEnum(t,e){switch(typeof t){case"string":var i=parseInt(t);return isNaN(i)?e[Object.keys(e).find(e=>e.toLowerCase()===t.toLowerCase())]:i;case"number":return t;case"undefined":case"object":return null}throw new me(T.AlphaTabErrorType.Format,`Could not parse enum value '${t}'`)}static forEach(e,t){if(e instanceof Map)e.forEach(t);else if("object"==typeof e)for(const i in e)t(e[i],i)}}class fi{constructor(e,t,i){this.text=e,this.startPos=t,this.endPos=i}}class yi{constructor(e){this.style="normal",this.variant="normal",this.weight="normal",this.stretch="normal",this.lineHeight="normal",this.size="1rem",this.families=[],this.parseOnlyFamilies=!1,this._currentTokenIndex=-1,this._input="",this._currentToken=null,this._input=e,this._tokens=this.splitToTokens(e)}splitToTokens(t){var i=[];let s=0;for(;s<t.length;){let e=s;for(;e<t.length&&" "!==t.charAt(e);)e++;e>s&&i.push(new fi(t.substring(s,e),s,e)),s=e+1}return i}parse(){var e;if(this.reset(),1===this._tokens.length)switch(null==(e=this._currentToken)?void 0:e.text){case"caption":case"icon":case"menu":case"message-box":case"small-caption":case"status-bar":case"inherit":return}this.parseOnlyFamilies||(this.fontStyleVariantWeight(),this.fontSizeLineHeight()),this.fontFamily()}static parseFamilies(e){e=new yi(e);return e.parseOnlyFamilies=!0,e.parse(),e.families}fontFamily(){if(!this._currentToken){if(this.parseOnlyFamilies)return;throw new Error("Missing font list")}var e=this._input.substr(this._currentToken.startPos).trim();let t=0;for(;t<e.length;){var i,s=e.charAt(t);" "===s||","==s?t++:t='"'===s||"'"===s?(i=this.findEndOfQuote(e,t+1,s),this.families.push(e.substring(t+1,i).split("\\"+s).join(s)),i+1):(s=this.findEndOfQuote(e,t+1,","),this.families.push(e.substring(t,s).trim()),s+1)}}findEndOfQuote(e,t,i){let s=!1;for(;t<e.length;){var a=e.charAt(t);if(!s&&a===i)return t;s=!s&&"\\"===a,t+=1}return e.length}fontSizeLineHeight(){if(!this._currentToken)throw new Error("Missing font size");var e=this._currentToken.text.split("/");if(3<=e.length)throw new Error(`Invalid font size '${this._currentToken}' specified`);if(this.nextToken(),2<=e.length)if("/"===e[1]){if(!this._currentToken)throw new Error("Missing line-height after font size");this.lineHeight=this._currentToken.text,this.nextToken()}else this.size=e[0],this.lineHeight=e[1];else{if(!(1<=e.length))throw new Error("Missing font size");if(this.size=e[0],this._currentToken&&0===this._currentToken.text.indexOf("/")){if("/"===this._currentToken.text){if(this.nextToken(),!this._currentToken)throw new Error("Missing line-height after font size");this.lineHeight=this._currentToken.text}else this.lineHeight=this._currentToken.text.substr(1);this.nextToken()}}}nextToken(){this._currentTokenIndex++,this._currentTokenIndex<this._tokens.length?this._currentToken=this._tokens[this._currentTokenIndex]:this._currentToken=null}fontStyleVariantWeight(){let e=!1,t=!1,i=!1,s=3;for(var a=[];;){if(!this._currentToken)return;var r=this._currentToken.text;switch(r){case"normal":case"inherit":a.push(r),s--,this.nextToken();break;case"italic":case"oblique":this.style=r,e=!0,s--,this.nextToken();break;case"small-caps":this.variant=r,t=!0,s--,this.nextToken();break;case"bold":case"bolder":case"lighter":case"100":case"200":case"300":case"400":case"500":case"600":case"700":case"800":case"900":this.weight=r,i=!0,s--,this.nextToken();break;default:return}if(0===s)break}for(;0<a.length;){var n=a.pop();i?t?e||(this.style=n):this.variant=n:this.weight=n}}reset(){this._currentTokenIndex=-1,this.nextToken()}static quoteFont(e){return-1===e.indexOf(" ")?e:`"${e.replaceAll('"','\\"')}"`}}(e=de=de||{})[e.Plain=0]="Plain",e[e.Italic=1]="Italic",(e=ce=ce||{})[e.Regular=0]="Regular",e[e.Bold=1]="Bold";class bi{constructor(e,t,i=de.Plain,s=ce.Regular){this._cssScale=0,this._families=yi.parseFamilies(e),this._size=t,this._style=i,this._weight=s,this._css=this.toCssString()}reset(){this._cssScale=0,this._css=this.toCssString()}get family(){return this._families[0]}set family(e){this.families=yi.parseFamilies(e)}get families(){return this._families}set families(e){this._families=e,this.reset()}get size(){return this._size}set size(e){this._size=e,this.reset()}get style(){return this._style}set style(e){this._style=e,this.reset()}get weight(){return this._weight}set weight(e){this._weight=e,this.reset()}get isBold(){return this.weight===ce.Bold}get isItalic(){return this.style===de.Italic}static withFamilyList(e,t,i=de.Plain,s=ce.Regular){t=new bi("",t,i,s);return t.families=e,t}toCssString(t=1){if(!(this._css&&Math.abs(t-this._cssScale)<.01)){let e="";this.isBold&&(e+="bold "),this.isItalic&&(e+="italic "),e=(e=e+this.size*t+"px ")+this.families.map(e=>yi.quoteFont(e)).join(", "),this._css=e,this._cssScale=t}return this._css}static fromJson(s){switch(typeof s){case"undefined":return null;case"object":var e=s,a=e.get("families"),r=e.get("size"),t=I.parseEnum(e.get("style"),de),e=I.parseEnum(e.get("weight"),ce);return bi.withFamilyList(a,r,t,e);case"string":{var a=new yi(s),r=(a.parse(),a.families),n=a.size.toLowerCase();let t=0;switch(n){case"xx-small":t=7;break;case"x-small":t=10;break;case"small":case"smaller":t=13;break;case"medium":t=16;break;case"large":case"larger":t=18;break;case"x-large":t=24;break;case"xx-large":t=32;break;default:try{t=n.endsWith("em")?16*parseFloat(n.substr(0,n.length-2)):n.endsWith("pt")?16*parseFloat(n.substr(0,n.length-2))/12:n.endsWith("px")?parseFloat(n.substr(0,n.length-2)):12}catch(e){t=12}}let e=de.Plain,i=("italic"===a.style&&(e=de.Italic),ce.Regular);switch(a.weight.toLowerCase()){case"normal":case"lighter":break;default:i=ce.Bold}return bi.withFamilyList(r,t,e,i)}default:return null}}static toJson(e){var t=new Map;return t.set("families",e.families),t.set("size",e.size),t.set("style",e.style),t.set("weight",e.weight),t}}class Si{constructor(){this.copyrightFont=new bi(Si.sansFont,12,de.Plain,ce.Bold),this.titleFont=new bi(Si.serifFont,32,de.Plain),this.subTitleFont=new bi(Si.serifFont,20,de.Plain),this.wordsFont=new bi(Si.serifFont,15,de.Plain),this.effectFont=new bi(Si.serifFont,12,de.Italic),this.fretboardNumberFont=new bi(Si.sansFont,11,de.Plain),this.tablatureFont=new bi(Si.sansFont,13,de.Plain),this.graceFont=new bi(Si.sansFont,11,de.Plain),this.staffLineColor=new We(165,165,165,255),this.barSeparatorColor=new We(34,34,17,255),this.barNumberFont=new bi(Si.sansFont,11,de.Plain),this.barNumberColor=new We(200,0,0,255),this.fingeringFont=new bi(Si.serifFont,14,de.Plain),this.markerFont=new bi(Si.serifFont,14,de.Plain,ce.Bold),this.mainGlyphColor=new We(0,0,0,255),this.secondaryGlyphColor=new We(0,0,0,100),this.scoreInfoColor=new We(0,0,0,255)}}Si.sansFont="Arial, sans-serif",Si.serifFont="Georgia, serif";class _i{constructor(){this.scale=1,this.stretchForce=1,this.layoutMode=T.LayoutMode.Page,this.staveProfile=T.StaveProfile.Default,this.barsPerRow=-1,this.startBar=1,this.barCount=-1,this.barCountPerPartial=10,this.resources=new Si,this.padding=null}}class wi{constructor(){this.encoding="utf-8",this.mergePartGroupsInMusicXml=!1,this.beatTextAsLyrics=!1}}T.ScrollMode=void 0,(e=T.ScrollMode||(T.ScrollMode={}))[e.Off=0]="Off",e[e.Continuous=1]="Continuous",e[e.OffScreen=2]="OffScreen";class vi{constructor(){this.noteWideLength=480,this.noteWideAmplitude=2,this.noteSlightLength=480,this.noteSlightAmplitude=2,this.beatWideLength=240,this.beatWideAmplitude=3,this.beatSlightLength=240,this.beatSlightAmplitude=3}}class Bi{constructor(){this.simpleSlidePitchOffset=6,this.simpleSlideDurationRatio=.25,this.shiftSlideDurationRatio=.5}}class Ti{constructor(){this.soundFont=null,this.scrollElement="html,body",this.enablePlayer=!1,this.enableCursor=!0,this.enableAnimatedBeatCursor=!0,this.enableElementHighlighting=!0,this.enableUserInteraction=!0,this.scrollOffsetX=0,this.scrollOffsetY=0,this.scrollMode=T.ScrollMode.OffScreen,this.scrollSpeed=0,this.nativeBrowserSmoothScroll=!0,this.songBookBendDuration=75,this.songBookDipDuration=150,this.vibrato=new vi,this.slide=new Bi,this.playTripletFeel=!0,this.bufferTimeInMilliseconds=500}}class ki{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t.toLowerCase(),e))}static toJson(e){var t;return e?((t=new Map).set("scriptfile",e.scriptFile),t.set("fontdirectory",e.fontDirectory),t.set("file",e.file),t.set("tex",e.tex),t.set("tracks",e.tracks),t.set("enablelazyloading",e.enableLazyLoading),t.set("engine",e.engine),t.set("loglevel",e.logLevel),t.set("useworkers",e.useWorkers),t.set("includenotebounds",e.includeNoteBounds),t):null}static setProperty(e,t,i){switch(t){case"scriptfile":return e.scriptFile=i,!0;case"fontdirectory":return e.fontDirectory=i,!0;case"file":return e.file=i,!0;case"tex":return e.tex=i,!0;case"tracks":return e.tracks=i,!0;case"enablelazyloading":return e.enableLazyLoading=i,!0;case"engine":return e.engine=i,!0;case"loglevel":return e.logLevel=I.parseEnum(i,T.LogLevel),!0;case"useworkers":return e.useWorkers=i,!0;case"includenotebounds":return e.includeNoteBounds=i,!0}return!1}}class Ni{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t.toLowerCase(),e))}static toJson(e){var t;return e?((t=new Map).set("copyrightfont",bi.toJson(e.copyrightFont)),t.set("titlefont",bi.toJson(e.titleFont)),t.set("subtitlefont",bi.toJson(e.subTitleFont)),t.set("wordsfont",bi.toJson(e.wordsFont)),t.set("effectfont",bi.toJson(e.effectFont)),t.set("fretboardnumberfont",bi.toJson(e.fretboardNumberFont)),t.set("tablaturefont",bi.toJson(e.tablatureFont)),t.set("gracefont",bi.toJson(e.graceFont)),t.set("stafflinecolor",We.toJson(e.staffLineColor)),t.set("barseparatorcolor",We.toJson(e.barSeparatorColor)),t.set("barnumberfont",bi.toJson(e.barNumberFont)),t.set("barnumbercolor",We.toJson(e.barNumberColor)),t.set("fingeringfont",bi.toJson(e.fingeringFont)),t.set("markerfont",bi.toJson(e.markerFont)),t.set("mainglyphcolor",We.toJson(e.mainGlyphColor)),t.set("secondaryglyphcolor",We.toJson(e.secondaryGlyphColor)),t.set("scoreinfocolor",We.toJson(e.scoreInfoColor)),t):null}static setProperty(e,t,i){switch(t){case"copyrightfont":return e.copyrightFont=bi.fromJson(i),!0;case"titlefont":return e.titleFont=bi.fromJson(i),!0;case"subtitlefont":return e.subTitleFont=bi.fromJson(i),!0;case"wordsfont":return e.wordsFont=bi.fromJson(i),!0;case"effectfont":return e.effectFont=bi.fromJson(i),!0;case"fretboardnumberfont":return e.fretboardNumberFont=bi.fromJson(i),!0;case"tablaturefont":return e.tablatureFont=bi.fromJson(i),!0;case"gracefont":return e.graceFont=bi.fromJson(i),!0;case"stafflinecolor":return e.staffLineColor=We.fromJson(i),!0;case"barseparatorcolor":return e.barSeparatorColor=We.fromJson(i),!0;case"barnumberfont":return e.barNumberFont=bi.fromJson(i),!0;case"barnumbercolor":return e.barNumberColor=We.fromJson(i),!0;case"fingeringfont":return e.fingeringFont=bi.fromJson(i),!0;case"markerfont":return e.markerFont=bi.fromJson(i),!0;case"mainglyphcolor":return e.mainGlyphColor=We.fromJson(i),!0;case"secondaryglyphcolor":return e.secondaryGlyphColor=We.fromJson(i),!0;case"scoreinfocolor":return e.scoreInfoColor=We.fromJson(i),!0}return!1}}class xi{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t.toLowerCase(),e))}static toJson(e){var t;return e?((t=new Map).set("scale",e.scale),t.set("stretchforce",e.stretchForce),t.set("layoutmode",e.layoutMode),t.set("staveprofile",e.staveProfile),t.set("barsperrow",e.barsPerRow),t.set("startbar",e.startBar),t.set("barcount",e.barCount),t.set("barcountperpartial",e.barCountPerPartial),t.set("resources",Ni.toJson(e.resources)),t.set("padding",e.padding),t):null}static setProperty(e,t,i){switch(t){case"scale":return e.scale=i,!0;case"stretchforce":return e.stretchForce=i,!0;case"layoutmode":return e.layoutMode=I.parseEnum(i,T.LayoutMode),!0;case"staveprofile":return e.staveProfile=I.parseEnum(i,T.StaveProfile),!0;case"barsperrow":return e.barsPerRow=i,!0;case"startbar":return e.startBar=i,!0;case"barcount":return e.barCount=i,!0;case"barcountperpartial":return e.barCountPerPartial=i,!0;case"padding":return e.padding=i,!0}if(0<=["resources"].indexOf(t))return Ni.fromJson(e.resources,i),!0;for(const s of["resources"])if(0===t.indexOf(s)&&Ni.setProperty(e.resources,t.substring(s.length),i))return!0;return!1}}class Pi{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t.toLowerCase(),e))}static toJson(e){if(!e)return null;var t,i,s=new Map,a=(s.set("notationmode",e.notationMode),s.set("fingeringmode",e.fingeringMode),new Map);s.set("elements",a);for([t,i]of e.elements)a.set(t.toString(),i);return s.set("rhythmmode",e.rhythmMode),s.set("rhythmheight",e.rhythmHeight),s.set("transpositionpitches",e.transpositionPitches),s.set("displaytranspositionpitches",e.displayTranspositionPitches),s.set("smallgracetabnotes",e.smallGraceTabNotes),s.set("extendbendarrowsontiednotes",e.extendBendArrowsOnTiedNotes),s.set("extendlineeffectstobeatend",e.extendLineEffectsToBeatEnd),s.set("slurheight",e.slurHeight),s}static setProperty(i,e,t){switch(e){case"notationmode":return i.notationMode=I.parseEnum(t,T.NotationMode),!0;case"fingeringmode":return i.fingeringMode=I.parseEnum(t,T.FingeringMode),!0;case"elements":return i.elements=new Map,I.forEach(t,(e,t)=>{i.elements.set(I.parseEnum(t,f),e)}),!0;case"rhythmmode":return i.rhythmMode=I.parseEnum(t,T.TabRhythmMode),!0;case"rhythmheight":return i.rhythmHeight=t,!0;case"transpositionpitches":return i.transpositionPitches=t,!0;case"displaytranspositionpitches":return i.displayTranspositionPitches=t,!0;case"smallgracetabnotes":return i.smallGraceTabNotes=t,!0;case"extendbendarrowsontiednotes":return i.extendBendArrowsOnTiedNotes=t,!0;case"extendlineeffectstobeatend":return i.extendLineEffectsToBeatEnd=t,!0;case"slurheight":return i.slurHeight=t,!0}return!1}}class Ei{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t.toLowerCase(),e))}static toJson(e){var t;return e?((t=new Map).set("encoding",e.encoding),t.set("mergepartgroupsinmusicxml",e.mergePartGroupsInMusicXml),t.set("beattextaslyrics",e.beatTextAsLyrics),t):null}static setProperty(e,t,i){switch(t){case"encoding":return e.encoding=i,!0;case"mergepartgroupsinmusicxml":return e.mergePartGroupsInMusicXml=i,!0;case"beattextaslyrics":return e.beatTextAsLyrics=i,!0}return!1}}class Ci{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t.toLowerCase(),e))}static toJson(e){var t;return e?((t=new Map).set("notewidelength",e.noteWideLength),t.set("notewideamplitude",e.noteWideAmplitude),t.set("noteslightlength",e.noteSlightLength),t.set("noteslightamplitude",e.noteSlightAmplitude),t.set("beatwidelength",e.beatWideLength),t.set("beatwideamplitude",e.beatWideAmplitude),t.set("beatslightlength",e.beatSlightLength),t.set("beatslightamplitude",e.beatSlightAmplitude),t):null}static setProperty(e,t,i){switch(t){case"notewidelength":return e.noteWideLength=i,!0;case"notewideamplitude":return e.noteWideAmplitude=i,!0;case"noteslightlength":return e.noteSlightLength=i,!0;case"noteslightamplitude":return e.noteSlightAmplitude=i,!0;case"beatwidelength":return e.beatWideLength=i,!0;case"beatwideamplitude":return e.beatWideAmplitude=i,!0;case"beatslightlength":return e.beatSlightLength=i,!0;case"beatslightamplitude":return e.beatSlightAmplitude=i,!0}return!1}}class Fi{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t.toLowerCase(),e))}static toJson(e){var t;return e?((t=new Map).set("simpleslidepitchoffset",e.simpleSlidePitchOffset),t.set("simpleslidedurationratio",e.simpleSlideDurationRatio),t.set("shiftslidedurationratio",e.shiftSlideDurationRatio),t):null}static setProperty(e,t,i){switch(t){case"simpleslidepitchoffset":return e.simpleSlidePitchOffset=i,!0;case"simpleslidedurationratio":return e.simpleSlideDurationRatio=i,!0;case"shiftslidedurationratio":return e.shiftSlideDurationRatio=i,!0}return!1}}class Li{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t.toLowerCase(),e))}static toJson(e){var t;return e?((t=new Map).set("soundfont",e.soundFont),t.set("enableplayer",e.enablePlayer),t.set("enablecursor",e.enableCursor),t.set("enableanimatedbeatcursor",e.enableAnimatedBeatCursor),t.set("enableelementhighlighting",e.enableElementHighlighting),t.set("enableuserinteraction",e.enableUserInteraction),t.set("scrolloffsetx",e.scrollOffsetX),t.set("scrolloffsety",e.scrollOffsetY),t.set("scrollmode",e.scrollMode),t.set("scrollspeed",e.scrollSpeed),t.set("nativebrowsersmoothscroll",e.nativeBrowserSmoothScroll),t.set("songbookbendduration",e.songBookBendDuration),t.set("songbookdipduration",e.songBookDipDuration),t.set("vibrato",Ci.toJson(e.vibrato)),t.set("slide",Fi.toJson(e.slide)),t.set("playtripletfeel",e.playTripletFeel),t.set("buffertimeinmilliseconds",e.bufferTimeInMilliseconds),t):null}static setProperty(e,t,i){switch(t){case"soundfont":return e.soundFont=i,!0;case"scrollelement":return e.scrollElement=i,!0;case"enableplayer":return e.enablePlayer=i,!0;case"enablecursor":return e.enableCursor=i,!0;case"enableanimatedbeatcursor":return e.enableAnimatedBeatCursor=i,!0;case"enableelementhighlighting":return e.enableElementHighlighting=i,!0;case"enableuserinteraction":return e.enableUserInteraction=i,!0;case"scrolloffsetx":return e.scrollOffsetX=i,!0;case"scrolloffsety":return e.scrollOffsetY=i,!0;case"scrollmode":return e.scrollMode=I.parseEnum(i,T.ScrollMode),!0;case"scrollspeed":return e.scrollSpeed=i,!0;case"nativebrowsersmoothscroll":return e.nativeBrowserSmoothScroll=i,!0;case"songbookbendduration":return e.songBookBendDuration=i,!0;case"songbookdipduration":return e.songBookDipDuration=i,!0;case"playtripletfeel":return e.playTripletFeel=i,!0;case"buffertimeinmilliseconds":return e.bufferTimeInMilliseconds=i,!0}if(0<=["vibrato"].indexOf(t))return Ci.fromJson(e.vibrato,i),!0;for(const s of["vibrato"])if(0===t.indexOf(s)&&Ci.setProperty(e.vibrato,t.substring(s.length),i))return!0;if(0<=["slide"].indexOf(t))return Fi.fromJson(e.slide,i),!0;for(const a of["slide"])if(0===t.indexOf(a)&&Fi.setProperty(e.slide,t.substring(a.length),i))return!0;return!1}}class Mi{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t.toLowerCase(),e))}static toJson(e){var t;return e?((t=new Map).set("core",ki.toJson(e.core)),t.set("display",xi.toJson(e.display)),t.set("notation",Pi.toJson(e.notation)),t.set("importer",Ei.toJson(e.importer)),t.set("player",Li.toJson(e.player)),t):null}static setProperty(e,t,i){if(0<=["core",""].indexOf(t))return ki.fromJson(e.core,i),!0;for(const s of["core",""])if(0===t.indexOf(s)&&ki.setProperty(e.core,t.substring(s.length),i))return!0;if(0<=["display",""].indexOf(t))return xi.fromJson(e.display,i),!0;for(const a of["display",""])if(0===t.indexOf(a)&&xi.setProperty(e.display,t.substring(a.length),i))return!0;if(0<=["notation"].indexOf(t))return Pi.fromJson(e.notation,i),!0;for(const r of["notation"])if(0===t.indexOf(r)&&Pi.setProperty(e.notation,t.substring(r.length),i))return!0;if(0<=["importer"].indexOf(t))return Ei.fromJson(e.importer,i),!0;for(const n of["importer"])if(0===t.indexOf(n)&&Ei.setProperty(e.importer,t.substring(n.length),i))return!0;if(0<=["player"].indexOf(t))return Li.fromJson(e.player,i),!0;for(const o of["player"])if(0===t.indexOf(o)&&Li.setProperty(e.player,t.substring(o.length),i))return!0;return!1}}class Di{constructor(){this.core=new po,this.display=new _i,this.notation=new Se,this.importer=new wi,this.player=new Ti}setSongBookModeSettings(){this.notation.notationMode=T.NotationMode.SongBook,this.notation.smallGraceTabNotes=!1,this.notation.fingeringMode=T.FingeringMode.SingleNoteEffectBand,this.notation.extendBendArrowsOnTiedNotes=!1,this.notation.elements.set(f.ParenthesisOnTiedBends,!1),this.notation.elements.set(f.TabNotesOnTiedBends,!1),this.notation.elements.set(f.ZerosOnDiveWhammys,!0)}static get songBook(){var e=new Di;return e.setSongBookModeSettings(),e}fillFromJson(e){Mi.fromJson(this,e)}}class Ii extends Pt{constructor(e,t,i,s,a){super(e,t,i,0,0),this.noteKey=s,this.pitch=a}writeTo(e){var t=new Uint8Array([64,255&this.message,255&this.noteKey,0,this.pitch>>24&255,this.pitch>>16&255,this.pitch>>8&255,255&this.pitch]);e.write(t,0,t.length)}}class Ri{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t,e))}static toJson(e){var t;return e?((t=new Map).set("marker",e.marker),t.set("text",e.text),t):null}static setProperty(e,t,i){switch(t){case"marker":return e.marker=i,!0;case"text":return e.text=i,!0}return!1}}class Ai{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t,e))}static toJson(e){var t;return e?((t=new Map).set("islinear",e.isLinear),t.set("type",e.type),t.set("value",e.value),t.set("ratioposition",e.ratioPosition),t.set("text",e.text),t):null}static setProperty(e,t,i){switch(t){case"islinear":return e.isLinear=i,!0;case"type":return e.type=I.parseEnum(i,V),!0;case"value":return e.value=i,!0;case"ratioposition":return e.ratioPosition=i,!0;case"text":return e.text=i,!0}return!1}}class Oi{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t,e))}static toJson(e){var t;return e?((t=new Map).set("type",e.type),t.set("length",e.length),t):null}static setProperty(e,t,i){switch(t){case"type":return e.type=I.parseEnum(i,te),!0;case"length":return e.length=i,!0}return!1}}class Gi{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t,e))}static toJson(e){if(!e)return null;var t,i,s=new Map,a=(s.set("alternateendings",e.alternateEndings),s.set("keysignature",e.keySignature),s.set("keysignaturetype",e.keySignatureType),s.set("isdoublebar",e.isDoubleBar),s.set("isrepeatstart",e.isRepeatStart),s.set("repeatcount",e.repeatCount),s.set("timesignaturenumerator",e.timeSignatureNumerator),s.set("timesignaturedenominator",e.timeSignatureDenominator),s.set("timesignaturecommon",e.timeSignatureCommon),s.set("tripletfeel",e.tripletFeel),s.set("section",Ri.toJson(e.section)),s.set("tempoautomation",Ai.toJson(e.tempoAutomation)),new Map);s.set("fermata",a);for([t,i]of e.fermata)a.set(t.toString(),Oi.toJson(i));return s.set("start",e.start),s.set("isanacrusis",e.isAnacrusis),s}static setProperty(s,e,t){switch(e){case"alternateendings":return s.alternateEndings=t,!0;case"keysignature":return s.keySignature=I.parseEnum(t,n),!0;case"keysignaturetype":return s.keySignatureType=I.parseEnum(t,Z),!0;case"isdoublebar":return s.isDoubleBar=t,!0;case"isrepeatstart":return s.isRepeatStart=t,!0;case"repeatcount":return s.repeatCount=t,!0;case"timesignaturenumerator":return s.timeSignatureNumerator=t,!0;case"timesignaturedenominator":return s.timeSignatureDenominator=t,!0;case"timesignaturecommon":return s.timeSignatureCommon=t,!0;case"tripletfeel":return s.tripletFeel=I.parseEnum(t,u),!0;case"fermata":return s.fermata=new Map,I.forEach(t,(e,t)=>{var i=new tt;Oi.fromJson(i,e),s.addFermata(parseInt(t),i)}),!0;case"start":return s.start=t,!0;case"isanacrusis":return s.isAnacrusis=t,!0}return 0<=["section"].indexOf(e)?(t?(s.section=new He,Ri.fromJson(s.section,t)):s.section=null,!0):0<=["tempoautomation"].indexOf(e)&&(t?(s.tempoAutomation=new ye,Ai.fromJson(s.tempoAutomation,t)):s.tempoAutomation=null,!0)}}class Hi{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t,e))}static toJson(e){var t;return e?((t=new Map).set("offset",e.offset),t.set("value",e.value),t):null}static setProperty(e,t,i){switch(t){case"offset":return e.offset=i,!0;case"value":return e.value=i,!0}return!1}}class Vi{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t,e))}static toJson(e){var t;return e?((t=new Map).set("id",e.id),t.set("accentuated",e.accentuated),t.set("bendtype",e.bendType),t.set("bendstyle",e.bendStyle),t.set("iscontinuedbend",e.isContinuedBend),t.set("bendpoints",e.bendPoints.map(e=>Hi.toJson(e))),t.set("fret",e.fret),t.set("string",e.string),t.set("octave",e.octave),t.set("tone",e.tone),t.set("percussionarticulation",e.percussionArticulation),t.set("isvisible",e.isVisible),t.set("islefthandtapped",e.isLeftHandTapped),t.set("ishammerpullorigin",e.isHammerPullOrigin),t.set("isslurdestination",e.isSlurDestination),t.set("harmonictype",e.harmonicType),t.set("harmonicvalue",e.harmonicValue),t.set("isghost",e.isGhost),t.set("isletring",e.isLetRing),t.set("ispalmmute",e.isPalmMute),t.set("isdead",e.isDead),t.set("isstaccato",e.isStaccato),t.set("slideintype",e.slideInType),t.set("slideouttype",e.slideOutType),t.set("vibrato",e.vibrato),t.set("istiedestination",e.isTieDestination),t.set("lefthandfinger",e.leftHandFinger),t.set("righthandfinger",e.rightHandFinger),t.set("isfingering",e.isFingering),t.set("trillvalue",e.trillValue),t.set("trillspeed",e.trillSpeed),t.set("durationpercent",e.durationPercent),t.set("accidentalmode",e.accidentalMode),t.set("dynamics",e.dynamics),e.toJson(t),t):null}static setProperty(e,t,i){switch(t){case"id":return e.id=i,!0;case"accentuated":return e.accentuated=I.parseEnum(i,H),!0;case"bendtype":return e.bendType=I.parseEnum(i,w),!0;case"bendstyle":return e.bendStyle=I.parseEnum(i,z),!0;case"iscontinuedbend":return e.isContinuedBend=i,!0;case"bendpoints":e.bendPoints=[];for(const a of i){var s=new B;Hi.fromJson(s,a),e.addBendPoint(s)}return!0;case"fret":return e.fret=i,!0;case"string":return e.string=i,!0;case"octave":return e.octave=i,!0;case"tone":return e.tone=i,!0;case"percussionarticulation":return e.percussionArticulation=i,!0;case"isvisible":return e.isVisible=i,!0;case"islefthandtapped":return e.isLeftHandTapped=i,!0;case"ishammerpullorigin":return e.isHammerPullOrigin=i,!0;case"isslurdestination":return e.isSlurDestination=i,!0;case"harmonictype":return e.harmonicType=I.parseEnum(i,g),!0;case"harmonicvalue":return e.harmonicValue=i,!0;case"isghost":return e.isGhost=i,!0;case"isletring":return e.isLetRing=i,!0;case"ispalmmute":return e.isPalmMute=i,!0;case"isdead":return e.isDead=i,!0;case"isstaccato":return e.isStaccato=i,!0;case"slideintype":return e.slideInType=I.parseEnum(i,q),!0;case"slideouttype":return e.slideOutType=I.parseEnum(i,m),!0;case"vibrato":return e.vibrato=I.parseEnum(i,J),!0;case"istiedestination":return e.isTieDestination=i,!0;case"lefthandfinger":return e.leftHandFinger=I.parseEnum(i,v),!0;case"righthandfinger":return e.rightHandFinger=I.parseEnum(i,v),!0;case"isfingering":return e.isFingering=i,!0;case"trillvalue":return e.trillValue=i,!0;case"trillspeed":return e.trillSpeed=I.parseEnum(i,x),!0;case"durationpercent":return e.durationPercent=i,!0;case"accidentalmode":return e.accidentalMode=I.parseEnum(i,Y),!0;case"dynamics":return e.dynamics=I.parseEnum(i,l),!0}return e.setProperty(t,i)}}class Wi{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t,e))}static toJson(e){var t;return e?((t=new Map).set("id",e.id),t.set("notes",e.notes.map(e=>Vi.toJson(e))),t.set("isempty",e.isEmpty),t.set("whammystyle",e.whammyStyle),t.set("ottava",e.ottava),t.set("islegatoorigin",e.isLegatoOrigin),t.set("duration",e.duration),t.set("automations",e.automations.map(e=>Ai.toJson(e))),t.set("dots",e.dots),t.set("fadein",e.fadeIn),t.set("lyrics",e.lyrics),t.set("hasrasgueado",e.hasRasgueado),t.set("pop",e.pop),t.set("slap",e.slap),t.set("tap",e.tap),t.set("text",e.text),t.set("brushtype",e.brushType),t.set("brushduration",e.brushDuration),t.set("tupletdenominator",e.tupletDenominator),t.set("tupletnumerator",e.tupletNumerator),t.set("iscontinuedwhammy",e.isContinuedWhammy),t.set("whammybartype",e.whammyBarType),t.set("whammybarpoints",e.whammyBarPoints.map(e=>Hi.toJson(e))),t.set("vibrato",e.vibrato),t.set("chordid",e.chordId),t.set("gracetype",e.graceType),t.set("pickstroke",e.pickStroke),t.set("tremolospeed",e.tremoloSpeed),t.set("crescendo",e.crescendo),t.set("displaystart",e.displayStart),t.set("playbackstart",e.playbackStart),t.set("displayduration",e.displayDuration),t.set("playbackduration",e.playbackDuration),t.set("dynamics",e.dynamics),t.set("invertbeamdirection",e.invertBeamDirection),t.set("preferredbeamdirection",e.preferredBeamDirection),t.set("beamingmode",e.beamingMode),t):null}static setProperty(e,t,i){switch(t){case"id":return e.id=i,!0;case"notes":e.notes=[];for(const n of i){var s=new Ne;Vi.fromJson(s,n),e.addNote(s)}return!0;case"isempty":return e.isEmpty=i,!0;case"whammystyle":return e.whammyStyle=I.parseEnum(i,z),!0;case"ottava":return e.ottava=I.parseEnum(i,W),!0;case"islegatoorigin":return e.isLegatoOrigin=i,!0;case"duration":return e.duration=I.parseEnum(i,x),!0;case"automations":e.automations=[];for(const o of i){var a=new ye;Ai.fromJson(a,o),e.automations.push(a)}return!0;case"dots":return e.dots=i,!0;case"fadein":return e.fadeIn=i,!0;case"lyrics":return e.lyrics=i,!0;case"hasrasgueado":return e.hasRasgueado=i,!0;case"pop":return e.pop=i,!0;case"slap":return e.slap=i,!0;case"tap":return e.tap=i,!0;case"text":return e.text=i,!0;case"brushtype":return e.brushType=I.parseEnum(i,U),!0;case"brushduration":return e.brushDuration=i,!0;case"tupletdenominator":return e.tupletDenominator=i,!0;case"tupletnumerator":return e.tupletNumerator=i,!0;case"iscontinuedwhammy":return e.isContinuedWhammy=i,!0;case"whammybartype":return e.whammyBarType=I.parseEnum(i,Q),!0;case"whammybarpoints":e.whammyBarPoints=[];for(const h of i){var r=new B;Hi.fromJson(r,h),e.addWhammyBarPoint(r)}return!0;case"vibrato":return e.vibrato=I.parseEnum(i,J),!0;case"chordid":return e.chordId=i,!0;case"gracetype":return e.graceType=I.parseEnum(i,_),!0;case"pickstroke":return e.pickStroke=I.parseEnum(i,j),!0;case"tremolospeed":return e.tremoloSpeed=I.parseEnum(i,x),!0;case"crescendo":return e.crescendo=I.parseEnum(i,X),!0;case"displaystart":return e.displayStart=i,!0;case"playbackstart":return e.playbackStart=i,!0;case"displayduration":return e.displayDuration=i,!0;case"playbackduration":return e.playbackDuration=i,!0;case"dynamics":return e.dynamics=I.parseEnum(i,l),!0;case"invertbeamdirection":return e.invertBeamDirection=i,!0;case"preferredbeamdirection":return e.preferredBeamDirection=I.parseEnum(i,E),!0;case"beamingmode":return e.beamingMode=I.parseEnum(i,K),!0}return!1}}class zi{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t,e))}static toJson(e){var t;return e?((t=new Map).set("id",e.id),t.set("beats",e.beats.map(e=>Wi.toJson(e))),t.set("isempty",e.isEmpty),t):null}static setProperty(e,t,i){switch(t){case"id":return e.id=i,!0;case"beats":e.beats=[];for(const a of i){var s=new Me;Wi.fromJson(s,a),e.addBeat(s)}return!0;case"isempty":return e.isEmpty=i,!0}return!1}}class Ui{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t,e))}static toJson(e){var t;return e?((t=new Map).set("id",e.id),t.set("clef",e.clef),t.set("clefottava",e.clefOttava),t.set("voices",e.voices.map(e=>zi.toJson(e))),t.set("similemark",e.simileMark),t):null}static setProperty(e,t,i){switch(t){case"id":return e.id=i,!0;case"clef":return e.clef=I.parseEnum(i,c),!0;case"clefottava":return e.clefOttava=I.parseEnum(i,W),!0;case"voices":e.voices=[];for(const a of i){var s=new Ye;zi.fromJson(s,a),e.addVoice(s)}return!0;case"similemark":return e.simileMark=I.parseEnum(i,r),!0}return!1}}class Xi{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t,e))}static toJson(e){var t;return e?((t=new Map).set("name",e.name),t.set("firstfret",e.firstFret),t.set("strings",e.strings),t.set("barrefrets",e.barreFrets),t.set("showname",e.showName),t.set("showdiagram",e.showDiagram),t.set("showfingering",e.showFingering),t):null}static setProperty(e,t,i){switch(t){case"name":return e.name=i,!0;case"firstfret":return e.firstFret=i,!0;case"strings":return e.strings=i,!0;case"barrefrets":return e.barreFrets=i,!0;case"showname":return e.showName=i,!0;case"showdiagram":return e.showDiagram=i,!0;case"showfingering":return e.showFingering=i,!0}return!1}}class Yi{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t,e))}static toJson(e){var t;return e?((t=new Map).set("isstandard",e.isStandard),t.set("name",e.name),t.set("tunings",e.tunings),t):null}static setProperty(e,t,i){switch(t){case"isstandard":return e.isStandard=i,!0;case"name":return e.name=i,!0;case"tunings":return e.tunings=i,!0}return!1}}class qi{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t,e))}static toJson(e){if(!e)return null;var t,i,s=new Map,a=(s.set("bars",e.bars.map(e=>Ui.toJson(e))),new Map);s.set("chords",a);for([t,i]of e.chords)a.set(t.toString(),Xi.toJson(i));return s.set("capo",e.capo),s.set("transpositionpitch",e.transpositionPitch),s.set("displaytranspositionpitch",e.displayTranspositionPitch),s.set("stringtuning",Yi.toJson(e.stringTuning)),s.set("showtablature",e.showTablature),s.set("showstandardnotation",e.showStandardNotation),s.set("ispercussion",e.isPercussion),s.set("standardnotationlinecount",e.standardNotationLineCount),s}static setProperty(s,e,t){switch(e){case"bars":s.bars=[];for(const a of t){var i=new be;Ui.fromJson(i,a),s.addBar(i)}return!0;case"chords":return s.chords=new Map,I.forEach(t,(e,t)=>{var i=new De;Xi.fromJson(i,e),s.addChord(t,i)}),!0;case"capo":return s.capo=t,!0;case"transpositionpitch":return s.transpositionPitch=t,!0;case"displaytranspositionpitch":return s.displayTranspositionPitch=t,!0;case"showtablature":return s.showTablature=t,!0;case"showstandardnotation":return s.showStandardNotation=t,!0;case"ispercussion":return s.isPercussion=t,!0;case"standardnotationlinecount":return s.standardNotationLineCount=t,!0}return 0<=["stringtuning"].indexOf(e)&&(Yi.fromJson(s.stringTuning,t),!0)}}class Ji{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t,e))}static toJson(e){var t;return e?((t=new Map).set("volume",e.volume),t.set("balance",e.balance),t.set("port",e.port),t.set("program",e.program),t.set("primarychannel",e.primaryChannel),t.set("secondarychannel",e.secondaryChannel),t.set("ismute",e.isMute),t.set("issolo",e.isSolo),t):null}static setProperty(e,t,i){switch(t){case"volume":return e.volume=i,!0;case"balance":return e.balance=i,!0;case"port":return e.port=i,!0;case"program":return e.program=i,!0;case"primarychannel":return e.primaryChannel=i,!0;case"secondarychannel":return e.secondaryChannel=i,!0;case"ismute":return e.isMute=i,!0;case"issolo":return e.isSolo=i,!0}return!1}}class ji{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t,e))}static toJson(e){var t;return e?((t=new Map).set("elementtype",e.elementType),t.set("staffline",e.staffLine),t.set("noteheaddefault",e.noteHeadDefault),t.set("noteheadhalf",e.noteHeadHalf),t.set("noteheadwhole",e.noteHeadWhole),t.set("techniquesymbol",e.techniqueSymbol),t.set("techniquesymbolplacement",e.techniqueSymbolPlacement),t.set("outputmidinumber",e.outputMidiNumber),t):null}static setProperty(e,t,i){switch(t){case"elementtype":return e.elementType=i,!0;case"staffline":return e.staffLine=i,!0;case"noteheaddefault":return e.noteHeadDefault=I.parseEnum(i,k),!0;case"noteheadhalf":return e.noteHeadHalf=I.parseEnum(i,k),!0;case"noteheadwhole":return e.noteHeadWhole=I.parseEnum(i,k),!0;case"techniquesymbol":return e.techniqueSymbol=I.parseEnum(i,k),!0;case"techniquesymbolplacement":return e.techniqueSymbolPlacement=I.parseEnum(i,P),!0;case"outputmidinumber":return e.outputMidiNumber=i,!0}return!1}}class Qi{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t,e))}static toJson(e){var t;return e?((t=new Map).set("staves",e.staves.map(e=>qi.toJson(e))),t.set("playbackinfo",Ji.toJson(e.playbackInfo)),t.set("color",We.toJson(e.color)),t.set("name",e.name),t.set("shortname",e.shortName),t.set("percussionarticulations",e.percussionArticulations.map(e=>ji.toJson(e))),t):null}static setProperty(e,t,i){switch(t){case"staves":e.staves=[];for(const r of i){var s=new Ue;qi.fromJson(s,r),e.addStaff(s)}return!0;case"color":return e.color=We.fromJson(i),!0;case"name":return e.name=i,!0;case"shortname":return e.shortName=i,!0;case"percussionarticulations":e.percussionArticulations=[];for(const n of i){var a=new h;ji.fromJson(a,n),e.percussionArticulations.push(a)}return!0}return 0<=["playbackinfo"].indexOf(t)&&(Ji.fromJson(e.playbackInfo,i),!0)}}class Ki{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t,e))}static toJson(e){var t;return e?((t=new Map).set("hidedynamics",e.hideDynamics),t):null}static setProperty(e,t,i){return"hidedynamics"===t&&(e.hideDynamics=i,!0)}}class $i{static fromJson(i,e){e&&I.forEach(e,(e,t)=>this.setProperty(i,t,e))}static toJson(e){var t;return e?((t=new Map).set("album",e.album),t.set("artist",e.artist),t.set("copyright",e.copyright),t.set("instructions",e.instructions),t.set("music",e.music),t.set("notices",e.notices),t.set("subtitle",e.subTitle),t.set("title",e.title),t.set("words",e.words),t.set("tab",e.tab),t.set("tempo",e.tempo),t.set("tempolabel",e.tempoLabel),t.set("masterbars",e.masterBars.map(e=>Gi.toJson(e))),t.set("tracks",e.tracks.map(e=>Qi.toJson(e))),t.set("stylesheet",Ki.toJson(e.stylesheet)),t):null}static setProperty(e,t,i){switch(t){case"album":return e.album=i,!0;case"artist":return e.artist=i,!0;case"copyright":return e.copyright=i,!0;case"instructions":return e.instructions=i,!0;case"music":return e.music=i,!0;case"notices":return e.notices=i,!0;case"subtitle":return e.subTitle=i,!0;case"title":return e.title=i,!0;case"words":return e.words=i,!0;case"tab":return e.tab=i,!0;case"tempo":return e.tempo=i,!0;case"tempolabel":return e.tempoLabel=i,!0;case"masterbars":e.masterBars=[];for(const r of i){var s=new Re;Gi.fromJson(s,r),e.addMasterBar(s)}return!0;case"tracks":e.tracks=[];for(const n of i){var a=new Xe;Qi.fromJson(a,n),e.addTrack(a)}return!0}return 0<=["stylesheet"].indexOf(t)&&(Ki.fromJson(e.stylesheet,i),!0)}}class Zi{static jsonReplacer(e,t){if(t instanceof Map){if("fromEntries"in Object)return Object.fromEntries(t);var i,s,a={};for([i,s]of t)a[i]=s;return a}return ArrayBuffer.isView(t)?Array.apply([],[t]):t}static scoreToJson(e){e=Zi.scoreToJsObject(e);return JSON.stringify(e,Zi.jsonReplacer)}static jsonToScore(e,t){return Zi.jsObjectToScore(JSON.parse(e),t)}static scoreToJsObject(e){return $i.toJson(e)}static jsObjectToScore(e,t){var i=new Ge;return $i.fromJson(i,e),i.finish(null!=t?t:new Di),i}static settingsToJson(e){e=Zi.settingsToJsObject(e);return JSON.stringify(e,Zi.jsonReplacer)}static jsonToSettings(e){return Zi.jsObjectToSettings(JSON.parse(e))}static settingsToJsObject(e){return Mi.toJson(e)}static jsObjectToSettings(e){var t=new Di;return Mi.fromJson(t,e),t}static jsObjectToMidiFile(e){var t,i=new pi,e=(i.division=e.division,e.events);for(t of e){var s=Zi.jsObjectToMidiEvent(t);i.events.push(s)}return i}static jsObjectToMidiEvent(e){var t=e.track,i=e.tick,s=e.message;let a;switch(e.type){case"SystemExclusiveEvent":(a=new Ft(t,i,0,0,e.data)).message=s;break;case"MetaDataEvent":(a=new gi(t,i,0,0,e.data)).message=s;break;case"MetaNumberEvent":(a=new mi(t,i,0,0,e.value)).message=s;break;case"Midi20PerNotePitchBendEvent":(a=new Ii(t,i,0,e.noteKey,e.pitch)).message=s;break;default:(a=new Pt(t,i,0,0,0)).message=s}return a}static midiFileToJsObject(e){var t,i={},s=(i.division=e.division,[]);i.events=s;for(t of e.events)s.push(Zi.midiEventToJsObject(t));return i}static midiEventToJsObject(e){var t={};return t.track=e.track,t.tick=e.tick,t.message=e.message,e instanceof Ft?(t.type="SystemExclusiveEvent",t.data=e.data):e instanceof gi?(t.type="MetaDataEvent",t.data=e.data):e instanceof mi?(t.type="MetaNumberEvent",t.value=e.value):e instanceof Ii&&(t.type="Midi20PerNotePitchBendEvent",t.noteKey=e.noteKey,t.pitch=e.pitch),t}}class es{constructor(){this.ready=new hi,this.samplesPlayed=new li,this.sampleRequest=new hi}get sampleRate(){return es.preferredSampleRate}open(){C.debug("AlphaSynth","Initializing webworker worker"),this._worker=O.globalThis,this._worker.addEventListener("message",this.handleMessage.bind(this)),this.ready.trigger()}destroy(){this._worker.postMessage({cmd:"alphaSynth.output.destroy"})}handleMessage(e){var t=e.data;switch(t.cmd){case es.CmdOutputSampleRequest:this.sampleRequest.trigger();break;case es.CmdOutputSamplesPlayed:this.samplesPlayed.trigger(t.samples)}}addSamples(e){this._worker.postMessage({cmd:"alphaSynth.output.addSamples",samples:e})}play(){this._worker.postMessage({cmd:"alphaSynth.output.play"})}pause(){this._worker.postMessage({cmd:"alphaSynth.output.pause"})}resetSamples(){this._worker.postMessage({cmd:"alphaSynth.output.resetSamples"})}activate(){}}es.CmdOutputPrefix="alphaSynth.output.",es.CmdOutputAddSamples=es.CmdOutputPrefix+"addSamples",es.CmdOutputPlay=es.CmdOutputPrefix+"play",es.CmdOutputPause=es.CmdOutputPrefix+"pause",es.CmdOutputResetSamples=es.CmdOutputPrefix+"resetSamples",es.CmdOutputSampleRequest=es.CmdOutputPrefix+"sampleRequest",es.CmdOutputSamplesPlayed=es.CmdOutputPrefix+"samplesPlayed",es.preferredSampleRate=0;class ts{constructor(e,t){this._main=e,this._main.addEventListener("message",this.handleMessage.bind(this)),this._player=new ui(new es,t),this._player.positionChanged.on(this.onPositionChanged.bind(this)),this._player.stateChanged.on(this.onPlayerStateChanged.bind(this)),this._player.finished.on(this.onFinished.bind(this)),this._player.soundFontLoaded.on(this.onSoundFontLoaded.bind(this)),this._player.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this._player.soundFontLoadFailed.on(this.onSoundFontLoadFailed.bind(this)),this._player.midiLoaded.on(this.onMidiLoaded.bind(this)),this._player.midiLoadFailed.on(this.onMidiLoadFailed.bind(this)),this._player.readyForPlayback.on(this.onReadyForPlayback.bind(this)),this._player.midiEventsPlayed.on(this.onMidiEventsPlayed.bind(this)),this._player.playbackRangeChanged.on(this.onPlaybackRangeChanged.bind(this)),this._main.postMessage({cmd:"alphaSynth.ready"})}static init(){let t=O.globalThis;t.addEventListener("message",e=>{e=e.data;"alphaSynth.initialize"===e.cmd&&(es.preferredSampleRate=e.sampleRate,C.logLevel=e.logLevel,O.globalThis.alphaSynthWebWorker=new ts(t,e.bufferTimeInMilliseconds))})}handleMessage(e){var t=e.data;switch(t.cmd){case"alphaSynth.setLogLevel":C.logLevel=t.value;break;case"alphaSynth.setMasterVolume":this._player.masterVolume=t.value;break;case"alphaSynth.setMetronomeVolume":this._player.metronomeVolume=t.value;break;case"alphaSynth.setPlaybackSpeed":this._player.playbackSpeed=t.value;break;case"alphaSynth.setTickPosition":this._player.tickPosition=t.value;break;case"alphaSynth.setTimePosition":this._player.timePosition=t.value;break;case"alphaSynth.setPlaybackRange":this._player.playbackRange=t.value;break;case"alphaSynth.setIsLooping":this._player.isLooping=t.value;break;case"alphaSynth.setCountInVolume":this._player.countInVolume=t.value;break;case"alphaSynth.setMidiEventsPlayedFilter":this._player.midiEventsPlayedFilter=t.value;break;case"alphaSynth.play":this._player.play();break;case"alphaSynth.pause":this._player.pause();break;case"alphaSynth.playPause":this._player.playPause();break;case"alphaSynth.stop":this._player.stop();break;case"alphaSynth.playOneTimeMidiFile":this._player.playOneTimeMidiFile(Zi.jsObjectToMidiFile(t.midi));break;case"alphaSynth.loadSoundFontBytes":this._player.loadSoundFont(t.data,t.append);break;case"alphaSynth.resetSoundFonts":this._player.resetSoundFonts();break;case"alphaSynth.loadMidi":this._player.loadMidiFile(Zi.jsObjectToMidiFile(t.midi));break;case"alphaSynth.setChannelMute":this._player.setChannelMute(t.channel,t.mute);break;case"alphaSynth.setChannelSolo":this._player.setChannelSolo(t.channel,t.solo);break;case"alphaSynth.setChannelVolume":this._player.setChannelVolume(t.channel,t.volume);break;case"alphaSynth.resetChannelStates":this._player.resetChannelStates();break;case"alphaSynth.destroy":this._player.destroy(),this._main.postMessage({cmd:"alphaSynth.destroyed"})}}onPositionChanged(e){this._main.postMessage({cmd:"alphaSynth.positionChanged",currentTime:e.currentTime,endTime:e.endTime,currentTick:e.currentTick,endTick:e.endTick,isSeek:e.isSeek})}onPlayerStateChanged(e){this._main.postMessage({cmd:"alphaSynth.playerStateChanged",state:e.state,stopped:e.stopped})}onFinished(){this._main.postMessage({cmd:"alphaSynth.finished"})}onSoundFontLoaded(){this._main.postMessage({cmd:"alphaSynth.soundFontLoaded"})}onSoundFontLoadFailed(e){this._main.postMessage({cmd:"alphaSynth.soundFontLoadFailed",error:this.serializeException(e)})}serializeException(e){var t=JSON.parse(JSON.stringify(e));return e.message&&(t.message=e.message),e.stack&&(t.stack=e.stack),e.constructor&&e.constructor.name&&(t.type=e.constructor.name),t}onMidiLoaded(e){this._main.postMessage({cmd:"alphaSynth.midiLoaded",currentTime:e.currentTime,endTime:e.endTime,currentTick:e.currentTick,endTick:e.endTick,isSeek:e.isSeek})}onMidiLoadFailed(e){this._main.postMessage({cmd:"alphaSynth.midiLoaded",error:this.serializeException(e)})}onReadyForPlayback(){this._main.postMessage({cmd:"alphaSynth.readyForPlayback"})}onMidiEventsPlayed(e){this._main.postMessage({cmd:"alphaSynth.midiEventsPlayed",events:e.events.map(Zi.midiEventToJsObject)})}onPlaybackRangeChanged(e){this._main.postMessage({cmd:"alphaSynth.playbackRangeChanged",playbackRange:e.playbackRange})}}class is{static generateFontLookup(e){if(!is.FontSizeLookupTables.has(e))if(O.isRunningInWorker)is.FontSizeLookupTables.set(e,new Uint8Array([8]));else{var t=document.createElement("canvas").getContext("2d"),i=(t.font="11px "+e,[]);for(let e=32;e<255;e++){var s=String.fromCharCode(e);i.push(t.measureText(s).width)}var a=new Uint8Array(i);is.FontSizeLookupTables.set(e,a)}}static measureString(t,i,s,e,a){var r;let n=i[0];for(let e=0;e<i.length;e++)if(is.FontSizeLookupTables.has(i[e])){n=i[e];break}is.FontSizeLookupTables.has(n)||is.generateFontLookup(n),r=is.FontSizeLookupTables.get(n);let o=1,h=(e===de.Italic&&(o*=1.2),a===ce.Bold&&(o*=1.2),0);for(let e=0;e<t.length;e++){var l=Math.min(r.length-1,t.charCodeAt(e)-32);0<=l&&(h+=r[l]*s/11)}return h*o}}is.Georgia=new Uint8Array([3,4,5,7,7,9,8,2,4,4,5,7,3,4,3,5,7,5,6,6,6,6,6,6,7,6,3,3,7,7,7,5,10,7,7,7,8,7,7,8,9,4,6,8,7,10,8,8,7,8,8,6,7,8,7,11,8,7,7,4,5,4,7,7,6,6,6,5,6,5,4,6,6,3,3,6,3,10,6,6,6,6,5,5,4,6,5,8,6,5,5,5,4,5,7,6,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,3,4,6,7,6,7,4,6,6,10,6,6,7,0,10,7,5,7,6,6,6,6,6,3,6,6,6,6,12,12,12,5,7,7,7,7,7,7,11,7,7,7,7,7,4,4,4,4,8,8,8,8,8,8,8,7,8,8,8,8,8,7,7,6,6,6,6,6,6,6,8,5,5,5,5,5,3,3,3,3,6,6,6,6,6,6,6,7,6,6,6,6,6,5,6]),is.Arial=new Uint8Array([3,3,4,6,6,10,7,2,4,4,4,6,3,4,3,3,6,6,6,6,6,6,6,6,6,6,3,3,6,6,6,6,11,7,7,8,8,7,7,9,8,3,6,7,6,9,8,9,7,9,8,7,7,8,7,10,7,7,7,3,3,3,5,6,4,6,6,6,6,6,3,6,6,2,2,6,2,9,6,6,6,6,4,6,3,6,6,8,6,6,6,4,3,4,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,4,6,6,6,6,3,6,4,8,4,6,6,0,8,6,4,6,4,4,4,6,6,4,4,4,4,6,9,9,9,7,7,7,7,7,7,7,11,8,7,7,7,7,3,3,3,3,8,8,9,9,9,9,9,6,9,8,8,8,8,7,7,7,6,6,6,6,6,6,10,6,6,6,6,6,3,3,3,3,6,6,6,6,6,6,6,6,7,6,6,6,6,6,6]),is.FontSizeLookupTables=new Map([["Arial",is.Arial],["'Arial'",is.Arial],['"Arial"',is.Arial],["Georgia",is.Georgia],["'Georgia'",is.Georgia],['"Georgia"',is.Georgia]]),is.ControlChars=32;class ss{constructor(){this.id=Be.newGuid(),this.x=0,this.y=0,this.width=0,this.height=0,this.totalWidth=0,this.totalHeight=0,this.firstMasterBarIndex=-1,this.lastMasterBarIndex=-1,this.renderResult=null}}class as{constructor(){this.beats=[]}addBeat(e){(e.barBounds=this).beats.push(e),this.masterBarBounds.addBeat(e)}findBeatAtPos(e){let t=null;for(var i of this.beats)if(!t||i.realBounds.x<e)t=i;else if(i.realBounds.x>e)break;return t}finish(){this.beats.sort((e,t)=>e.realBounds.x-t.realBounds.x)}}class rs{constructor(){this.notes=null}addNote(e){this.notes||(this.notes=[]),(e.beatBounds=this).notes.push(e)}findNoteAtPos(e,t){var i=this.notes;if(i)for(var s of i){var a=s.noteHeadBounds.y+s.noteHeadBounds.h,r=s.noteHeadBounds.x+s.noteHeadBounds.w;if(s.noteHeadBounds.x<=e&&s.noteHeadBounds.y<=t&&e<=r&&t<=a)return s.note}return null}}class ns{constructor(){this.index=0,this.isFirstOfLine=!1,this.bars=[],this.staveGroupBounds=null}addBar(e){(e.masterBarBounds=this).bars.push(e)}findBeatAtPos(e,t){let i=null;var s;for(s of this.bars){var a,r=s.findBeatAtPos(e);r&&(!i||i.realBounds.x<r.realBounds.x)&&(a=Math.abs(r.realBounds.x-e),!i||a<1e7)&&(i=r)}return i?i.beat:null}finish(){this.bars.sort((e,t)=>e.realBounds.y<t.realBounds.y?-1:e.realBounds.y>t.realBounds.y?1:e.realBounds.x<t.realBounds.x?-1:e.realBounds.x>t.realBounds.x?1:0);for(const e of this.bars)e.finish()}addBeat(e){this.staveGroupBounds.boundsLookup.addBeat(e)}}class os{}class hs{constructor(){this.index=0,this.bars=[]}finish(){for(var e of this.bars)e.finish()}addBar(e){this.boundsLookup.addMasterBar(e),(e.staveGroupBounds=this).bars.push(e)}findBarAtPos(e){let t=null;for(var i of this.bars)if(!t||i.realBounds.x<e)t=i;else if(e>i.realBounds.x+i.realBounds.w)break;return t}}class ls{constructor(){this._beatLookup=new Map,this._masterBarLookup=new Map,this._currentStaveGroup=null,this.staveGroups=[],this.isFinished=!1}toJson(){var e,t={},i=[];t.staveGroups=i;for(e of this.staveGroups){var s,a={};a.visualBounds=this.boundsToJson(e.visualBounds),a.realBounds=this.boundsToJson(e.realBounds),a.bars=[];for(s of e.bars){var r,n={};n.lineAlignedBounds=this.boundsToJson(s.lineAlignedBounds),n.visualBounds=this.boundsToJson(s.visualBounds),n.realBounds=this.boundsToJson(s.realBounds),n.index=s.index,n.bars=[];for(r of s.bars){var o,h={};h.visualBounds=this.boundsToJson(r.visualBounds),h.realBounds=this.boundsToJson(r.realBounds),h.beats=[];for(o of r.beats){var l={},d=(l.visualBounds=this.boundsToJson(o.visualBounds),l.realBounds=this.boundsToJson(o.realBounds),l);if(d.beatIndex=o.beat.index,d.voiceIndex=o.beat.voice.index,d.barIndex=o.beat.voice.bar.index,d.staffIndex=o.beat.voice.bar.staff.index,d.trackIndex=o.beat.voice.bar.staff.track.index,o.notes){var c,u=l.notes=[];for(c of o.notes){var p={};p.index=c.note.index,p.noteHeadBounds=this.boundsToJson(c.noteHeadBounds),u.push(p)}}h.beats.push(l)}n.bars.push(h)}a.bars.push(n)}i.push(a)}return t}static fromJson(e,t){var i,s=new ls;for(i of e.staveGroups){var a,r=new hs;r.visualBounds=i.visualBounds,r.realBounds=i.realBounds,s.addStaveGroup(r);for(a of i.bars){var n,o=new ns;o.index=a.index,o.isFirstOfLine=a.isFirstOfLine,o.lineAlignedBounds=a.lineAlignedBounds,o.visualBounds=a.visualBounds,o.realBounds=a.realBounds,r.addBar(o);for(n of a.bars){var h,l=new as;l.visualBounds=n.visualBounds,l.realBounds=n.realBounds,o.addBar(l);for(h of n.beats){var d=new rs,c=(d.visualBounds=h.visualBounds,d.realBounds=h.realBounds,h);if(d.beat=t.tracks[c.trackIndex].staves[c.staffIndex].bars[c.barIndex].voices[c.voiceIndex].beats[c.beatIndex],h.notes){d.notes=[];for(var u of h.notes){var p=new os,g=u;p.note=d.beat.notes[g.index],p.noteHeadBounds=u.noteHeadBounds,d.addNote(p)}}l.addBeat(d)}}}}return s}boundsToJson(e){var t={};return t.x=e.x,t.y=e.y,t.w=e.w,t.h=e.h,t}finish(){for(var e of this.staveGroups)e.finish();this.isFinished=!0}addStaveGroup(e){e.index=this.staveGroups.length,(e.boundsLookup=this).staveGroups.push(e),this._currentStaveGroup=e}addMasterBar(e){e.staveGroupBounds?this._masterBarLookup.set(e.index,e):(e.staveGroupBounds=this._currentStaveGroup,this._masterBarLookup.set(e.index,e),this._currentStaveGroup.addBar(e))}addBeat(e){var t;this._beatLookup.has(e.beat.id)||this._beatLookup.set(e.beat.id,[]),null!=(t=this._beatLookup.get(e.beat.id))&&t.push(e)}findMasterBarByIndex(e){return this._masterBarLookup.has(e)?this._masterBarLookup.get(e):null}findMasterBar(e){e=e.index;return this._masterBarLookup.has(e)?this._masterBarLookup.get(e):null}findBeat(e){e=this.findBeats(e);return e?e[0]:null}findBeats(e){e=e.id;return this._beatLookup.has(e)?this._beatLookup.get(e):null}getBeatAtPos(e,t){let i=0,s=this.staveGroups.length-1,a=-1;for(;i<=s;){var r=(s+i)/2|0,n=this.staveGroups[r];if(t>=n.realBounds.y&&t<=n.realBounds.y+n.realBounds.h){a=r;break}t<n.realBounds.y?s=r-1:i=1+r}var o;return-1!==a&&(o=this.staveGroups[a].findBarAtPos(e))?o.findBeatAtPos(e,t):null}getNoteAtPos(e,t,i){e=this.findBeats(e);if(e)for(const a of e){var s=a.findNoteAtPos(t,i);if(s)return s}return null}}class ds{constructor(e){this._currentLayoutMode=T.LayoutMode.Page,this._currentRenderEngine=null,this._renderedTracks=null,this.canvas=null,this.score=null,this.tracks=null,this.layout=null,this.boundsLookup=null,this.width=0,this.preRender=new li,this.renderFinished=new li,this.partialRenderFinished=new li,this.partialLayoutFinished=new li,this.postRenderFinished=new hi,this.error=new li,this.settings=e,this.recreateCanvas(),this.recreateLayout()}destroy(){this.score=null,this.canvas=null,this.layout=null,this.boundsLookup=null,this.tracks=null}recreateCanvas(){return this._currentRenderEngine!==this.settings.core.engine&&(this.canvas=O.getRenderEngineFactory(this.settings.core.engine).createCanvas(),this._currentRenderEngine=this.settings.core.engine,!0)}recreateLayout(){return!(this.layout&&this._currentLayoutMode===this.settings.display.layoutMode||(this.layout=O.getLayoutEngineFactory(this.settings.display.layoutMode).createLayout(this),this._currentLayoutMode=this.settings.display.layoutMode,0))}renderScore(t,i){try{this.score=t;let e=null;if(null!=t&&null!=i){if(i){e=[];for(var s of i)0<=s&&s<t.tracks.length&&e.push(t.tracks[s])}else e=t.tracks.slice(0);0===e.length&&0<t.tracks.length&&e.push(t.tracks[0])}this.tracks=e,this.render()}catch(e){this.error.trigger(e)}}renderTracks(e){0===e.length?this.score=null:this.score=e[0].score,this.tracks=e,this.render()}updateSettings(e){this.settings=e}renderResult(e){try{var t=this.layout;t?(C.debug("Rendering","Request render of lazy partial "+e),t.renderLazyPartial(e)):C.warning("Rendering","Request render of lazy partial "+e+" ignored, no layout exists")}catch(e){this.error.trigger(e)}}render(){if(0===this.width)C.warning("Rendering","AlphaTab skipped rendering because of width=0 (element invisible)",null);else if(this.boundsLookup=new ls,this.recreateCanvas(),this.canvas.lineWidth=this.settings.display.scale,this.canvas.settings=this.settings,this.tracks&&0!==this.tracks.length&&this.score){C.debug("Rendering","Rendering "+this.tracks.length+" tracks");for(let e=0;e<this.tracks.length;e++){var t=this.tracks[e];C.debug("Rendering","Track "+e+": "+t.name)}this.preRender.trigger(!1),this.recreateLayout(),this.layoutAndRender(),C.debug("Rendering","Rendering finished")}else C.debug("Rendering","Clearing rendered tracks because no score or tracks are set"),this.preRender.trigger(!1),this._renderedTracks=null,this.onRenderFinished(),this.postRenderFinished.trigger(),C.debug("Rendering","Clearing finished")}resizeRender(){this.recreateLayout()||this.recreateCanvas()||this._renderedTracks!==this.tracks||!this.tracks?(C.debug("Rendering","Starting full rerendering due to layout or canvas change",null),this.render()):this.layout.supportsResize?(C.debug("Rendering","Starting optimized rerendering for resize"),this.boundsLookup=new ls,this.preRender.trigger(!0),this.canvas.settings=this.settings,this.layout.resize(),this.onRenderFinished(),this.postRenderFinished.trigger()):C.warning("Rendering","Current layout does not support dynamic resizing, nothing was done",null),C.debug("Rendering","Resize finished")}layoutAndRender(){C.debug("Rendering","Rendering at scale "+this.settings.display.scale+" with layout "+this.layout.name,null),this.layout.layoutAndRender(),this._renderedTracks=this.tracks,this.onRenderFinished(),this.postRenderFinished.trigger()}onRenderFinished(){null!=(e=this.boundsLookup)&&e.finish();var e=new ss;e.totalHeight=this.layout.height,e.totalWidth=this.layout.width,e.renderResult=this.canvas.onRenderFinished(),this.renderFinished.trigger(e)}}class cs{constructor(e){this._main=e,this._main.addEventListener("message",this.handleMessage.bind(this),!1)}static init(){O.globalThis.alphaTabWebWorker=new cs(O.globalThis)}handleMessage(e){var t=e.data;switch(t?t.cmd:""){case"alphaTab.initialize":var i=Zi.jsObjectToSettings(t.settings);C.logLevel=i.core.logLevel,this._renderer=new ds(i),this._renderer.partialRenderFinished.on(e=>{this._main.postMessage({cmd:"alphaTab.partialRenderFinished",result:e})}),this._renderer.partialLayoutFinished.on(e=>{this._main.postMessage({cmd:"alphaTab.partialLayoutFinished",result:e})}),this._renderer.renderFinished.on(e=>{this._main.postMessage({cmd:"alphaTab.renderFinished",result:e})}),this._renderer.postRenderFinished.on(()=>{var e;this._main.postMessage({cmd:"alphaTab.postRenderFinished",boundsLookup:null!=(e=null==(e=this._renderer.boundsLookup)?void 0:e.toJson())?e:null})}),this._renderer.preRender.on(e=>{this._main.postMessage({cmd:"alphaTab.preRender",resize:e})}),this._renderer.error.on(this.error.bind(this));break;case"alphaTab.invalidate":this._renderer.render();break;case"alphaTab.resizeRender":this._renderer.resizeRender();break;case"alphaTab.renderResult":this._renderer.renderResult(t.resultId);break;case"alphaTab.setWidth":this._renderer.width=t.width;break;case"alphaTab.renderScore":this.updateFontSizes(t.fontSizes);i=null==t.score?null:Zi.jsObjectToScore(t.score,this._renderer.settings);this.renderMultiple(i,t.trackIndexes);break;case"alphaTab.updateSettings":this.updateSettings(t.settings)}}updateFontSizes(e){if(e)for(var t in is.FontSizeLookupTables||(is.FontSizeLookupTables=new Map),e)is.FontSizeLookupTables.set(t,e[t])}updateSettings(e){Mi.fromJson(this._renderer.settings,e)}renderMultiple(e,t){try{this._renderer.renderScore(e,t)}catch(e){this.error(e)}}error(e){C.error("Worker","An unexpected error occurred in worker",e),this._main.postMessage({cmd:"alphaTab.error",error:e})}}class us{constructor(){this._canvas=null,this._color=new We(0,0,0,255),this._font=new bi("Arial",10,de.Plain),this._lineWidth=0;var e=document.createElement("span"),e=(e.classList.add("at"),document.body.appendChild(e),window.getComputedStyle(e));let t=e.fontFamily;(t.startsWith('"')||t.startsWith("'"))&&(t=t.substr(1,t.length-2)),this._musicFont=new bi(t,parseFloat(e.fontSize),de.Plain),this._measureCanvas=document.createElement("canvas"),this._measureCanvas.width=10,this._measureCanvas.height=10,this._measureCanvas.style.width="10px",this._measureCanvas.style.height="10px",this._measureContext=this._measureCanvas.getContext("2d"),this._measureContext.textBaseline="hanging"}onRenderFinished(){return null}beginRender(e,t){this._canvas=document.createElement("canvas"),this._canvas.width=e*O.HighDpiFactor|0,this._canvas.height=t*O.HighDpiFactor|0,this._canvas.style.width=e+"px",this._canvas.style.height=t+"px",this._context=this._canvas.getContext("2d"),this._context.textBaseline="hanging",this._context.scale(O.HighDpiFactor,O.HighDpiFactor),this._context.lineWidth=this._lineWidth}endRender(){var e=this._canvas;return this._canvas=null,e}get color(){return this._color}set color(e){this._color.rgba!==e.rgba&&(this._color=e,this._context.strokeStyle=e.rgba,this._context.fillStyle=e.rgba)}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=e,this._context&&(this._context.lineWidth=e)}fillRect(e,t,i,s){0<i&&this._context.fillRect(0|e,0|t,i,s)}strokeRect(e,t,i,s){this._context.strokeRect(0|e,0|t,i,s)}beginPath(){this._context.beginPath()}closePath(){this._context.closePath()}moveTo(e,t){this._context.moveTo(e,t)}lineTo(e,t){this._context.lineTo(e,t)}quadraticCurveTo(e,t,i,s){this._context.quadraticCurveTo(e,t,i,s)}bezierCurveTo(e,t,i,s,a,r){this._context.bezierCurveTo(e,t,i,s,a,r)}fillCircle(e,t,i){this._context.beginPath(),this._context.arc(e,t,i,0,2*Math.PI,!0),this.fill()}strokeCircle(e,t,i){this._context.beginPath(),this._context.arc(e,t,i,0,2*Math.PI,!0),this.stroke()}fill(){this._context.fill(),this._context.beginPath()}stroke(){this._context.stroke(),this._context.beginPath()}get font(){return this._font}set font(e){this._font=e,this._context&&(this._context.font=e.toCssString(this.settings.display.scale)),this._measureContext.font=e.toCssString(this.settings.display.scale)}get textAlign(){switch(this._context.textAlign){case"left":return N.Left;case"center":return N.Center;case"right":return N.Right;default:return N.Left}}set textAlign(e){switch(e){case N.Left:this._context.textAlign="left";break;case N.Center:this._context.textAlign="center";break;case N.Right:this._context.textAlign="right"}}get textBaseline(){switch(this._context.textBaseline){case"hanging":return P.Top;case"middle":return P.Middle;case"bottom":return P.Bottom;default:return P.Top}}set textBaseline(e){switch(e){case P.Top:this._context.textBaseline="hanging";break;case P.Middle:this._context.textBaseline="middle";break;case P.Bottom:this._context.textBaseline="bottom"}}beginGroup(e){}endGroup(){}fillText(e,t,i){this._context.fillText(e,t,i)}measureText(e){return this._measureContext.measureText(e).width}fillMusicFontSymbol(e,t,i,s,a=!1){s!==k.None&&this.fillMusicFontSymbolText(e,t,i,String.fromCharCode(s),a)}fillMusicFontSymbols(e,t,i,s,a=!1){let r="";for(var n of s)n!==k.None&&(r+=String.fromCharCode(n));this.fillMusicFontSymbolText(e,t,i,r,a)}fillMusicFontSymbolText(e,t,i,s,a=!1){var r=this._context.textAlign,n=this._context.textBaseline,o=this._context.font;this._context.font=this._musicFont.toCssString(i),this._context.textBaseline="middle",this._context.textAlign=a?"center":"left",this._context.fillText(s,e,t),this._context.textBaseline=n,this._context.font=o,this._context.textAlign=r}beginRotate(e,t,i){this._context.save(),this._context.translate(e,t),this._context.rotate(i*Math.PI/180)}endRotate(){this._context.restore()}}class ps{constructor(e){this._midiFile=e}addTimeSignature(e,t,i){let s=0;for(;;){if(!(0<(i>>=1)))break;s++}e=new gi(0,e,255,ae.TimeSignature,new Uint8Array([255&t,255&s,48,8]));this._midiFile.addEvent(e)}addRest(e,t,i){e=new Ft(e,t,a.SystemExclusive,Ft.AlphaTabManufacturerId,new Uint8Array([re.Rest]));this._midiFile.addEvent(e)}addNote(e,t,i,s,a,r){var a=p.dynamicToVelocity(a),n=new Pt(e,t,this.makeCommand(se.NoteOn,r),ps.fixValue(s),ps.fixValue(a)),n=(this._midiFile.addEvent(n),new Pt(e,t+i,this.makeCommand(se.NoteOff,r),ps.fixValue(s),ps.fixValue(a)));this._midiFile.addEvent(n)}makeCommand(e,t){return 240&e|15&t}static fixValue(e){return 127<e?127:e<0?0:e}addControlChange(e,t,i,s,a){e=new Pt(e,t,this.makeCommand(se.Controller,i),ps.fixValue(s),ps.fixValue(a));this._midiFile.addEvent(e)}addProgramChange(e,t,i,s){e=new Pt(e,t,this.makeCommand(se.ProgramChange,i),ps.fixValue(s),0);this._midiFile.addEvent(e)}addTempo(e,t){t=6e7/t|0,e=new mi(0,e,255,ae.Tempo,t);this._midiFile.addEvent(e)}addBend(e,t,i,s){s=s>=D.MaxPitchWheel?D.MaxPitchWheel:Math.floor(s);e=new Pt(e,t,this.makeCommand(se.PitchBend,i),127&s,s>>7&127);this._midiFile.addEvent(e)}addNoteBend(e,t,i,s,a){a=(a=a>=D.MaxPitchWheel?D.MaxPitchWheel:Math.floor(a))*D.MaxPitchWheel20/D.MaxPitchWheel;e=new Ii(e,t,this.makeCommand(se.PerNotePitchBend,i),s,a);this._midiFile.addEvent(e)}finishTrack(e,t){e=new gi(e,t,255,ae.EndOfTrack,new Uint8Array(0));this._midiFile.addEvent(e)}}class gs{constructor(){this._highlightedBeats=new Map,this.index=0,this.start=0,this.end=0,this.isEmptyBar=!1,this.beatsToHighlight=[]}highlightBeat(e){this._highlightedBeats.has(e.id)||(this._highlightedBeats.set(e.id,!0),this.beatsToHighlight.push(e))}}(e=ue=ue||{})[e.BankSelectCoarse=0]="BankSelectCoarse",e[e.ModulationCoarse=1]="ModulationCoarse",e[e.DataEntryCoarse=6]="DataEntryCoarse",e[e.VolumeCoarse=7]="VolumeCoarse",e[e.PanCoarse=10]="PanCoarse",e[e.ExpressionControllerCoarse=11]="ExpressionControllerCoarse",e[e.ModulationFine=33]="ModulationFine",e[e.DataEntryFine=38]="DataEntryFine",e[e.VolumeFine=39]="VolumeFine",e[e.PanFine=42]="PanFine",e[e.ExpressionControllerFine=43]="ExpressionControllerFine",e[e.HoldPedal=64]="HoldPedal",e[e.LegatoPedal=68]="LegatoPedal",e[e.NonRegisteredParameterFine=98]="NonRegisteredParameterFine",e[e.NonRegisteredParameterCourse=99]="NonRegisteredParameterCourse",e[e.RegisteredParameterFine=100]="RegisteredParameterFine",e[e.RegisteredParameterCourse=101]="RegisteredParameterCourse",e[e.ResetControllers=121]="ResetControllers",e[e.AllNotesOff=123]="AllNotesOff";class ms{constructor(e,t){this.closingIndex=0,this.group=e,this.opening=t,e.closings=e.closings.sort((e,t)=>e.index-t.index),this.iterations=e.closings.map(e=>0)}}class fs{constructor(e){this._repeatStack=[],this._groupsOnStack=new Set,this._previousAlternateEndings=0,this.shouldPlay=!0,this.index=0,this.currentTick=0,this._score=e}get finished(){return this.index>=this._score.masterBars.length}processCurrent(){var e,t=this._score.masterBars[this.index];let i=t.alternateEndings;0===i&&(i=this._previousAlternateEndings),t===t.repeatGroup.opening&&t.repeatGroup.isClosed&&!this._groupsOnStack.has(t.repeatGroup)&&(e=new ms(t.repeatGroup,t),this._repeatStack.push(e),this._groupsOnStack.add(t.repeatGroup),this._previousAlternateEndings=0),0!==this._repeatStack.length&&0!==i&&(e=(e=this._repeatStack[this._repeatStack.length-1]).iterations[e.closingIndex],0==((this._previousAlternateEndings=i)&1<<e))?this.shouldPlay=!1:this.shouldPlay=!0,this.shouldPlay&&(this.currentTick+=t.calculateDuration())}moveNext(){var e=this._score.masterBars[this.index].repeatCount-1;if(0<this._repeatStack.length&&0<e){var t=this._repeatStack[this._repeatStack.length-1];if(t.iterations[t.closingIndex]<e){this.index=t.opening.index,t.iterations[t.closingIndex]++;for(let e=0;e<t.closingIndex;e++)t.iterations[e]=0;t.closingIndex=0,this._previousAlternateEndings=0}else t.closingIndex<t.group.closings.length-1?t.closingIndex++:(this._repeatStack.pop(),this._groupsOnStack.delete(t.group)),this.index++}else this.index++}}class ys{constructor(){this.start=0,this.end=0,this.tempo=0,this.beats=[],this.nextMasterBar=null}finish(){this.beats.sort((e,t)=>e.start-t.start)}addBeat(e){e.masterBar=this,e.index=this.beats.length,this.beats.push(e)}}class bs{constructor(){this.duration=0,this.tickDuration=0,this.nextBeatLookup=null}get currentBeat(){return this.currentBeatLookup.beat}get nextBeat(){var e;return null!=(e=null==(e=this.nextBeatLookup)?void 0:e.beat)?e:null}}class Ss{constructor(){this._currentMasterBar=null,this.masterBarLookup=new Map,this.masterBars=[]}finish(){let e=null,t=[];for(var i of this.masterBars){i.finish(),e&&(e.nextMasterBar=i);for(const r of i.beats){var s,a=[];for(s of t)s.end>r.start&&(a.push(s),r.highlightBeat(s.beat),r.start<=s.start)&&s.highlightBeat(r.beat);a.push(r),t=a}e=i}}findBeat(e,t,i=null){var s=new Map;for(const r of e)s.set(r.index,!0);let a=null;return a=(a=i?this.findBeatFast(s,i,t):a)||this.findBeatSlow(s,t)}findBeatFast(e,t,i){var s=t.currentBeatLookup.start+t.tickDuration;return i>=t.currentBeatLookup.start&&i<s?t:t.nextBeatLookup&&i>=t.nextBeatLookup.start&&i<t.nextBeatLookup.end?this.createResult(t.nextBeatLookup,e):null}findBeatSlow(t,i){var e=this.findMasterBar(i);if(!e)return null;let s=null;var a=e.beats;for(let e=0;e<a.length;e++){var r=a[e];if(t.has(r.beat.voice.bar.staff.track.index))if(r.start<=i&&i<r.end)(!s||s.start<r.start)&&(s=a[e]);else if(r.end>i)break}return s?this.createResult(s,t):null}createResult(e,t){var t=this.findNextBeat(e,t),i=new bs;return i.currentBeatLookup=e,i.nextBeatLookup=t,i.tickDuration=t?t.start-e.start:e.end-e.start,i.duration=p.ticksToMillis(i.tickDuration,e.masterBar.tempo),i.beatsToHighlight=e.beatsToHighlight,i}findNextBeat(t,i){var e=t.masterBar;let s=e.beats,a=null;for(let e=t.index+1;e<s.length;e++){var r=s[e];if(r.start>t.start&&i.has(r.beat.voice.bar.staff.track.index)){a=r;break}}if(!a&&e.nextMasterBar){s=e.nextMasterBar.beats;for(let e=0;e<s.length;e++){var n=s[e];if(i.has(n.beat.voice.bar.staff.track.index)){a=n;break}}}return a}findMasterBar(e){var t=this.masterBars;let i=0,s=t.length-1;for(;i<=s;){var a=(s+i)/2|0,r=t[a];if(e>=r.start&&e<r.end)return r;e<r.start?s=a-1:i=1+a}return null}getMasterBar(e){var t;return this.masterBarLookup.has(e.index)?this.masterBarLookup.get(e.index):((t=new ys).masterBar=e,t)}getMasterBarStart(e){return this.masterBarLookup.has(e.index)?this.masterBarLookup.get(e.index).start:0}addMasterBar(e){this.masterBars.push(e),this._currentMasterBar=e,this.masterBarLookup.has(e.masterBar.index)||this.masterBarLookup.set(e.masterBar.index,e)}addBeat(e){var t;null!=(t=this._currentMasterBar)&&t.addBeat(e)}}class _s{constructor(){this.noteOnly=0,this.untilTieOrSlideEnd=0,this.letRingEnd=0}}class ws{constructor(){this.firstBeatDuration=0,this.secondBeatStartOffset=0,this.secondBeatDuration=0}}class vs{constructor(e,t,i){this._currentTempo=0,this._currentBarRepeatLookup=null,this._programsPerChannel=new Map,this.tickLookup=new Ss,this._currentTripletFeel=null,this.vibratoResolution=16,this._score=e,this._settings=t||new Di,this._currentTempo=this._score.tempo,this._handler=i}generate(){for(const r of this._score.tracks)this.generateTrack(r);C.debug("Midi","Begin midi generation");var e=new fs(this._score);let t=null;for(;!e.finished;){var i=e.index,s=this._score.masterBars[i],a=e.currentTick;if(e.processCurrent(),e.shouldPlay){this.generateMasterBar(s,t,a);for(const n of this._score.tracks)for(const o of n.staves)i<o.bars.length&&this.generateBar(o.bars[i],a)}e.moveNext(),t=s}for(const h of this._score.tracks)this._handler.finishTrack(h.index,e.currentTick);this.tickLookup.finish(),C.debug("Midi","Midi generation done")}generateTrack(e){this.generateChannel(e,e.playbackInfo.primaryChannel,e.playbackInfo),e.playbackInfo.primaryChannel!==e.playbackInfo.secondaryChannel&&this.generateChannel(e,e.playbackInfo.secondaryChannel,e.playbackInfo)}addProgramChange(e,t,i,s){this._programsPerChannel.has(i)&&this._programsPerChannel.get(i)===s||(this._handler.addProgramChange(e.index,t,i,s),this._programsPerChannel.set(i,s))}generateChannel(e,t,i){var s=vs.toChannelShort(i.volume),a=vs.toChannelShort(i.balance);this._handler.addControlChange(e.index,0,t,ue.VolumeCoarse,s),this._handler.addControlChange(e.index,0,t,ue.PanCoarse,a),this._handler.addControlChange(e.index,0,t,ue.ExpressionControllerCoarse,127),this._handler.addControlChange(e.index,0,t,ue.RegisteredParameterFine,0),this._handler.addControlChange(e.index,0,t,ue.RegisteredParameterCourse,0),this._handler.addControlChange(e.index,0,t,ue.DataEntryFine,0),this._handler.addControlChange(e.index,0,t,ue.DataEntryCoarse,vs.PitchBendRangeInSemitones),this.addProgramChange(e,0,t,i.program)}static toChannelShort(e){e=Math.max(-32768,Math.min(32767,8*e-1));return Math.max(e,-1)+1}generateMasterBar(e,t,i){t&&t.timeSignatureDenominator===e.timeSignatureDenominator&&t.timeSignatureNumerator===e.timeSignatureNumerator||this._handler.addTimeSignature(i,e.timeSignatureNumerator,e.timeSignatureDenominator),e.tempoAutomation?(this._handler.addTempo(i,e.tempoAutomation.value),this._currentTempo=e.tempoAutomation.value):t||(this._handler.addTempo(i,e.score.tempo),this._currentTempo=e.score.tempo);t=new ys;t.masterBar=e,t.start=i,t.tempo=this._currentTempo,t.end=t.start+e.calculateDuration(),this.tickLookup.addMasterBar(t)}generateBar(e,t){var i=this.getPlaybackBar(e);this._currentBarRepeatLookup=null;for(const s of i.voices)this.generateVoice(s,t,e)}getPlaybackBar(e){switch(e.simileMark){case r.Simple:e.previousBar&&(e=this.getPlaybackBar(e.previousBar));break;case r.FirstOfDouble:case r.SecondOfDouble:e.previousBar&&e.previousBar.previousBar&&(e=this.getPlaybackBar(e.previousBar.previousBar))}return e}generateVoice(e,t,i){if(!e.isEmpty||e.bar.isEmpty&&0===e.index)for(const s of e.beats)this.generateBeat(s,t,i)}generateBeat(i,s,e){let a=i.playbackStart,t=i.playbackDuration;i.voice.bar.isEmpty?t=i.voice.bar.masterBar.calculateDuration():i.voice.bar.masterBar.tripletFeel!==u.NoTripletFeel&&this._settings.player.playTripletFeel&&(this._currentTripletFeel?(a-=this._currentTripletFeel.secondBeatStartOffset,t=this._currentTripletFeel.secondBeatDuration,this._currentTripletFeel=null):(this._currentTripletFeel=vs.calculateTripletFeelInfo(a,t,i),this._currentTripletFeel&&(t=this._currentTripletFeel.firstBeatDuration)));var r=new gs,n=(r.start=s+a,i.nextBeat?i.nextBeat.absolutePlaybackStart-i.absolutePlaybackStart:t);r.end=s+a,r.highlightBeat(i),r.end+=n>t?n:t,e===i.voice.bar?(r.beat=i,this.tickLookup.addBeat(r)):(r.isEmptyBar=!0,r.beat=e.voices[0].beats[0],this._currentBarRepeatLookup?this._currentBarRepeatLookup.end=r.end:(this._currentBarRepeatLookup=r,this.tickLookup.addBeat(this._currentBarRepeatLookup)));const o=i.voice.bar.staff.track;for(const l of i.automations)this.generateAutomation(i,l,s);if(i.isRest)this._handler.addRest(o.index,s+a,o.playbackInfo.primaryChannel);else{var h=this.getBrushInfo(i);for(const d of i.notes)this.generateNote(d,s+a,t,h)}if(i.vibrato!==J.None){let e=240,t=3;switch(i.vibrato){case J.Slight:e=this._settings.player.vibrato.beatSlightLength,t=this._settings.player.vibrato.beatSlightAmplitude;break;case J.Wide:e=this._settings.player.vibrato.beatWideLength,t=this._settings.player.vibrato.beatWideAmplitude}this.generateVibratorWithParams(s+a,i.playbackDuration,e,t,(e,t)=>{this._handler.addBend(i.voice.bar.staff.track.index,e,o.playbackInfo.secondaryChannel,t)})}}static calculateTripletFeelInfo(e,t,i){let s;switch(i.voice.bar.masterBar.tripletFeel){case u.Triplet8th:case u.Dotted8th:case u.Scottish8th:s=x.Eighth;break;case u.Triplet16th:case u.Dotted16th:case u.Scottish16th:s=x.Sixteenth;break;default:return null}var a=p.toTicks(s);if(t!==a)return null;if(e%a!=0)return null;if(!i.nextBeat||i.nextBeat.voice!==i.voice||i.playbackDuration!==a)return null;var r=new ws;switch(i.voice.bar.masterBar.tripletFeel){case u.Triplet8th:r.firstBeatDuration=p.applyTuplet(p.toTicks(x.Quarter),3,2),r.secondBeatDuration=p.applyTuplet(p.toTicks(x.Eighth),3,2);break;case u.Dotted8th:r.firstBeatDuration=p.applyDot(p.toTicks(x.Eighth),!1),r.secondBeatDuration=p.toTicks(x.Sixteenth);break;case u.Scottish8th:r.firstBeatDuration=p.toTicks(x.Sixteenth),r.secondBeatDuration=p.applyDot(p.toTicks(x.Eighth),!1);break;case u.Triplet16th:r.firstBeatDuration=p.applyTuplet(p.toTicks(x.Eighth),3,2),r.secondBeatDuration=p.applyTuplet(p.toTicks(x.Sixteenth),3,2);break;case u.Dotted16th:r.firstBeatDuration=p.applyDot(p.toTicks(x.Sixteenth),!1),r.secondBeatDuration=p.toTicks(x.ThirtySecond);break;case u.Scottish16th:r.firstBeatDuration=p.toTicks(x.ThirtySecond),r.secondBeatDuration=p.applyDot(p.toTicks(x.Sixteenth),!1)}return r.secondBeatStartOffset=t-r.firstBeatDuration,r}generateNote(e,t,i,s){var a=e.beat.voice.bar.staff.track,r=e.beat.voice.bar.staff;let n=e.realValue;e.isPercussion&&(o=Te.getArticulation(e))&&(n=o.outputMidiNumber);var o=e.isStringed&&e.string<=s.length?s[e.string-1]:0,s=t+o,t=this.getNoteDuration(e,i),i=(t.untilTieOrSlideEnd-=o,t.noteOnly-=o,t.letRingEnd-=o,vs.getDynamicValue(e)),o=e.hasBend||e.beat.hasWhammyBar||e.beat.vibrato!==J.None?a.playbackInfo.secondaryChannel:a.playbackInfo.primaryChannel;let h=0;0<=(h=e.hasBend?vs.getPitchWheel(e.bendPoints[0].value):e.beat.hasWhammyBar?vs.getPitchWheel(e.beat.whammyBarPoints[0].value):e.isTieDestination||e.slideOrigin&&e.slideOrigin.slideOutType===m.Legato?-1:vs.getPitchWheel(0))&&this._handler.addNoteBend(a.index,s,o,n,h),e.beat.fadeIn&&this.generateFadeIn(e,s,t),e.isTrill&&!r.isPercussion?this.generateTrill(e,s,t,n,i,o):e.beat.isTremolo?this.generateTremoloPicking(e,s,t,n,i,o):(e.hasBend?this.generateBend(e,s,t,n,o):e.beat.hasWhammyBar&&0===e.index?this.generateWhammy(e.beat,s,t,o):e.slideInType!==q.None||e.slideOutType!==m.None?this.generateSlide(e,s,t,n,i,o):(e.vibrato!==J.None||e.isTieDestination&&e.tieOrigin.vibrato!==J.None)&&this.generateVibrato(e,s,t,n,o),e.isTieDestination||e.slideOrigin&&e.slideOrigin.slideOutType===m.Legato||(r=Math.max(t.untilTieOrSlideEnd,t.letRingEnd),this._handler.addNote(a.index,s,r,n,i,o)))}getNoteDuration(i,s){var e,t,a,r=new _s;if(r.noteOnly=s,r.untilTieOrSlideEnd=s,r.letRingEnd=s,i.isDead)r.noteOnly=this.applyStaticDuration(vs.DefaultDurationDead,s),r.untilTieOrSlideEnd=r.noteOnly,r.letRingEnd=r.noteOnly;else if(i.isPalmMute)r.noteOnly=this.applyStaticDuration(vs.DefaultDurationPalmMute,s),r.untilTieOrSlideEnd=r.noteOnly,r.letRingEnd=r.noteOnly;else if(i.isStaccato)r.noteOnly=s/2|0,r.untilTieOrSlideEnd=r.noteOnly,r.letRingEnd=r.noteOnly;else if(i.isTieOrigin?(e=i.tieDestination)&&(i.isTieDestination?(t=this.getNoteDuration(e,e.beat.playbackDuration),r.untilTieOrSlideEnd=s+t.untilTieOrSlideEnd):(t=i.beat.absolutePlaybackStart,a=this.getNoteDuration(e,e.beat.playbackDuration),e=e.beat.absolutePlaybackStart+a.untilTieOrSlideEnd,r.untilTieOrSlideEnd=e-t)):i.slideOutType===m.Legato&&(a=i.slideTarget)&&(e=i.beat.absolutePlaybackStart,t=this.getNoteDuration(a,a.beat.playbackDuration),a=a.beat.absolutePlaybackStart+t.untilTieOrSlideEnd,r.untilTieOrSlideEnd=a-e),i.isLetRing&&this._settings.notation.notationMode===T.NotationMode.GuitarPro){let e=i.beat,t=0;for(var n=i.beat.voice.bar.masterBar.calculateDuration();e.nextBeat;){var o=e.nextBeat;if(o.isRest)break;if(i.isStringed&&o.hasNoteOnString(i.string))break;if(e=e.nextBeat,(t=e.absolutePlaybackStart-i.beat.absolutePlaybackStart+e.playbackDuration)>n){t=n;break}}e===i.beat?r.letRingEnd=s:r.letRingEnd=t}else r.letRingEnd=r.untilTieOrSlideEnd;return r}applyStaticDuration(e,t){e=this._currentTempo*e/B.MaxPosition|0;return Math.min(e,t)}static getDynamicValue(e){let t=e.dynamics;switch(!e.beat.voice.bar.staff.isPercussion&&e.hammerPullOrigin&&t--,e.isGhost&&t--,e.accentuated){case H.Normal:t++;break;case H.Heavy:t+=2}return t=t<0?0:t}generateFadeIn(e,t,i){var s=e.beat.voice.bar.staff.track,a=vs.toChannelShort(s.playbackInfo.volume)/i.noteOnly,r=i.noteOnly/120|0,n=t+i.noteOnly;for(let e=r-1;0<=e;e--){var o=n-120*e,h=(o-t)*a;e===r-1&&(this._handler.addControlChange(s.index,t,s.playbackInfo.primaryChannel,ue.VolumeCoarse,h),this._handler.addControlChange(s.index,t,s.playbackInfo.secondaryChannel,ue.VolumeCoarse,h)),this._handler.addControlChange(s.index,o,s.playbackInfo.primaryChannel,ue.VolumeCoarse,h),this._handler.addControlChange(s.index,o,s.playbackInfo.secondaryChannel,ue.VolumeCoarse,h)}}generateVibrato(e,t,i,s,a){let r=0,n=0;switch(e.vibrato!==J.None?e.vibrato:e.isTieDestination?e.tieOrigin.vibrato:J.Slight){case J.Slight:r=this._settings.player.vibrato.noteSlightLength,n=this._settings.player.vibrato.noteSlightAmplitude;break;case J.Wide:r=this._settings.player.vibrato.noteWideLength,n=this._settings.player.vibrato.noteWideAmplitude;break;default:return}const o=e.beat.voice.bar.staff.track;this.generateVibratorWithParams(t,i.noteOnly,r,n,(e,t)=>{this._handler.addNoteBend(o.index,e,a,s,t)})}generateVibratorWithParams(t,e,i,s,a){for(var r=this.vibratoResolution,n=i/2|0,o=(t+=i)+e;t<o;){let e=0;for(var h=t+i<o?i:o-t;e<h;){var l=s*Math.sin(e*Math.PI/n);a(t+e|0,vs.getPitchWheel(l)),e+=r}t+=i}}static getPitchWheel(e){return D.DefaultPitchWheel+e/2*vs.PitchValuePerSemitone}generateSlide(e,t,i,s,a,r){var i=e.slideOutType===m.Legato?i.noteOnly:i.untilTieOrSlideEnd,n=[];let o=e.beat.voice.bar.staff.track;var h=this._settings.player.slide.simpleSlidePitchOffset,l=Math.floor(B.MaxPosition*this._settings.player.slide.simpleSlideDurationRatio),d=Math.floor(B.MaxPosition*this._settings.player.slide.shiftSlideDurationRatio);switch(e.slideInType){case q.IntoFromAbove:n.push(new B(0,h)),n.push(new B(l,0));break;case q.IntoFromBelow:n.push(new B(0,-h)),n.push(new B(l,0))}switch(e.slideOutType){case m.Legato:case m.Shift:n.push(new B(d,0));var c=2*(e.slideTarget.realValue-e.realValue);n.push(new B(B.MaxPosition,c));break;case m.OutDown:n.push(new B(B.MaxPosition-l,0)),n.push(new B(B.MaxPosition,-h));break;case m.OutUp:n.push(new B(B.MaxPosition-l,0)),n.push(new B(B.MaxPosition,h))}this.generateWhammyOrBend(t,i,n,(e,t)=>{this._handler.addNoteBend(o.index,e,r,s,t)})}generateBend(t,e,i,s,a){var r=t.bendPoints;let n=t.beat.voice.bar.staff.track;var o=(e,t)=>{this._handler.addNoteBend(n.index,e,a,s,t)};let h=null,l;if(t.isTieOrigin&&this._settings.notation.extendBendArrowsOnTiedNotes){let e=t;for(;e.isTieOrigin&&!e.tieDestination.hasBend;)e=e.tieDestination;l=e.beat.absolutePlaybackStart-t.beat.absolutePlaybackStart+this.getNoteDuration(e,e.beat.playbackDuration).noteOnly}else if(t.isTieOrigin&&t.beat.graceType!==_.None){switch(t.tieDestination.bendType){case w.Bend:case w.BendRelease:case w.PrebendBend:h=t.tieDestination.bendPoints[1].value;break;case w.Prebend:case w.PrebendRelease:h=t.tieDestination.bendPoints[0].value}l=Math.max(i.noteOnly,p.millisToTicks(this._settings.player.songBookBendDuration,this._currentTempo))}else l=i.noteOnly;0<r[0].value&&!t.isContinuedBend&&0<e&&e--;var d=Math.min(l,p.millisToTicks(this._settings.player.songBookBendDuration,this._currentTempo));let c=[];switch(t.bendType){case w.Custom:c=r;break;case w.Bend:case w.Release:switch(t.bendStyle){case z.Default:c=r;break;case z.Gradual:c.push(new B(0,t.bendPoints[0].value)),(!h||h<t.bendPoints[1].value)&&(h=t.bendPoints[1].value),c.push(new B(B.MaxPosition,h));break;case z.Fast:return(!h||h<t.bendPoints[1].value)&&(h=t.bendPoints[1].value),void(t.beat.graceType===_.BendGrace?this.generateSongBookWhammyOrBend(e,l,!0,[t.bendPoints[0].value,h],d,o):this.generateSongBookWhammyOrBend(e,l,!1,[t.bendPoints[0].value,h],d,o))}break;case w.BendRelease:switch(t.bendStyle){case z.Default:c=r;break;case z.Gradual:c.push(new B(0,t.bendPoints[0].value)),c.push(new B(B.MaxPosition/2|0,t.bendPoints[1].value)),c.push(new B(B.MaxPosition,t.bendPoints[2].value));break;case z.Fast:return void this.generateSongBookWhammyOrBend(e,l,!1,[t.bendPoints[0].value,t.bendPoints[1].value,t.bendPoints[2].value],d,o)}break;case w.Hold:case w.Prebend:c=r;break;case w.PrebendBend:switch(t.bendStyle){case z.Default:c=r;break;case z.Gradual:c.push(new B(0,t.bendPoints[0].value)),c.push(new B(B.MaxPosition,t.bendPoints[1].value));break;case z.Fast:return o(e,0|vs.getPitchWheel(t.bendPoints[0].value)),(!h||h<t.bendPoints[1].value)&&(h=t.bendPoints[1].value),void this.generateSongBookWhammyOrBend(e,l,!1,[t.bendPoints[0].value,h],d,o)}break;case w.PrebendRelease:switch(t.bendStyle){case z.Default:c=r;break;case z.Gradual:c.push(new B(0,t.bendPoints[0].value)),c.push(new B(B.MaxPosition,t.bendPoints[1].value));break;case z.Fast:return o(e,0|vs.getPitchWheel(t.bendPoints[0].value)),void this.generateSongBookWhammyOrBend(e,l,!1,[t.bendPoints[0].value,t.bendPoints[1].value],d,o)}}this.generateWhammyOrBend(e,l,c,o)}generateSongBookWhammyOrBend(e,t,i,s,a,r){var n=i?e:e+t-a,o=a/(s.length-1);for(let e=0;e<s.length-1;e++){var h=vs.getPitchWheel(s[e]),l=vs.getPitchWheel(s[e+1]),d=n+o*e;this.generateBendValues(d,o,h,l,r)}}generateWhammy(e,t,i,s){var a=e.whammyBarPoints;const r=e.voice.bar.staff.track;var n=i.noteOnly,o=(0<a[0].value&&!e.isContinuedWhammy&&t--,(e,t)=>{this._handler.addBend(r.index,e,s,t)});let h=[];switch(e.whammyBarType){case Q.Custom:h=a;break;case Q.Dive:switch(e.whammyStyle){case z.Default:h=a;break;case z.Gradual:h.push(new B(0,a[0].value)),h.push(new B(B.MaxPosition,a[1].value));break;case z.Fast:var l=Math.min(n,p.millisToTicks(this._settings.player.songBookBendDuration,this._currentTempo));return void this.generateSongBookWhammyOrBend(t,n,!1,[a[0].value,a[1].value],l,o)}break;case Q.Dip:switch(e.whammyStyle){case z.Default:h=a;break;case z.Gradual:h.push(new B(0,a[0].value)),h.push(new B(B.MaxPosition/2|0,a[1].value)),h.push(new B(B.MaxPosition,a[2].value));break;case z.Fast:var d=Math.min(n,p.millisToTicks(this._settings.player.songBookDipDuration,this._currentTempo));return void this.generateSongBookWhammyOrBend(t,n,!0,[a[0].value,a[1].value,a[2].value],d,o)}break;case Q.Hold:case Q.Predive:h=a;break;case Q.PrediveDive:switch(e.whammyStyle){case z.Default:h=a;break;case z.Gradual:h.push(new B(0,a[0].value)),h.push(new B(B.MaxPosition/2|0,a[0].value)),h.push(new B(B.MaxPosition,a[1].value));break;case z.Fast:var c=vs.getPitchWheel(a[0].value),c=(this._handler.addBend(r.index,t,s,0|c),Math.min(n,p.millisToTicks(this._settings.player.songBookBendDuration,this._currentTempo)));return void this.generateSongBookWhammyOrBend(t,n,!1,[a[0].value,a[1].value],c,o)}}this.generateWhammyOrBend(t,n,h,o)}generateWhammyOrBend(t,e,i,s){var a=e/B.MaxPosition;for(let e=0;e<i.length-1;e++){var r=i[e],n=i[e+1],o=vs.getPitchWheel(r.value),h=vs.getPitchWheel(n.value),n=a*(n.offset-r.offset),r=t+a*r.offset;this.generateBendValues(r,n,o,h,s)}}generateBendValues(t,e,i,s,a){var r=p.ticksToMillis(e,this._currentTempo),n=Math.abs(s-i)/vs.PitchValuePerSemitone,o=Math.max(vs.MinBreakpointsPerSemitone*n,r/vs.MillisecondsPerBreakpoint),h=e/o,l=(s-i)/o;for(let e=0;e<o;e++)a(0|t,Math.round(i)),i+=l,t+=h;i<s&&a(0|t,s)}generateTrill(e,t,i,s,a,r){var n=e.beat.voice.bar.staff.track,o=e.stringTuning+e.trillFret;let h=p.toTicks(e.trillSpeed),l=!0,d=t;for(var c=t+i.untilTieOrSlideEnd;d+10<c;)d+h>=c&&(h=c-d),this._handler.addNote(n.index,d,h,l?o:s,a,r),l=!l,d+=h}generateTremoloPicking(e,t,i,s,a,r){var n=e.beat.voice.bar.staff.track;let o=p.toTicks(e.beat.tremoloSpeed),h=t;for(var l=t+i.untilTieOrSlideEnd;h+10<l;)h+o>=l&&(o=l-h),this._handler.addNote(n.index,h,o,s,a,r),h+=o}getBrushInfo(s){var a=new Int32Array(s.voice.bar.staff.tuning.length);if(s.brushType!==U.None){let i=0,e=0;for(const t of s.notes)t.isTieDestination||(i|=1<<t.string-1,e++);if(0<s.notes.length){let t=0;var r=s.brushDuration/(e-1)|0;for(let e=0;e<s.voice.bar.staff.tuning.length;e++){var n=s.brushType===U.ArpeggioDown||s.brushType===U.BrushDown?e:a.length-1-e;0!=(i&1<<n)&&(a[n]=t,t+=r)}}}return a}generateAutomation(e,t,i){switch(t.type){case V.Instrument:this.addProgramChange(e.voice.bar.staff.track,e.playbackStart+i,e.voice.bar.staff.track.playbackInfo.primaryChannel,255&(0|t.value)),this.addProgramChange(e.voice.bar.staff.track,e.playbackStart+i,e.voice.bar.staff.track.playbackInfo.secondaryChannel,255&(0|t.value));break;case V.Balance:var s=vs.toChannelShort(t.value);this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+i,e.voice.bar.staff.track.playbackInfo.primaryChannel,ue.PanCoarse,s),this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+i,e.voice.bar.staff.track.playbackInfo.secondaryChannel,ue.PanCoarse,s);break;case V.Volume:s=vs.toChannelShort(t.value);this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+i,e.voice.bar.staff.track.playbackInfo.primaryChannel,ue.VolumeCoarse,s),this._handler.addControlChange(e.voice.bar.staff.track.index,e.playbackStart+i,e.voice.bar.staff.track.playbackInfo.secondaryChannel,ue.VolumeCoarse,s)}}prepareSingleBeat(e){let t=-1,i=-1,s=e;for(;s&&(-1===t||-1===i);){for(const o of e.automations)switch(o.type){case V.Instrument:i=o.value;break;case V.Tempo:t=o.value}s=s.previousBeat}var a=e.voice.bar.staff.track,r=e.voice.bar.masterBar,n=(-1===t&&(t=r.score.tempo),-1===i&&(i=a.playbackInfo.program),a.playbackInfo.volume),r=(this.generateTrack(a),this._handler.addTimeSignature(0,r.timeSignatureNumerator,r.timeSignatureDenominator),this._handler.addTempo(0,t),vs.toChannelShort(n));this._handler.addControlChange(0,0,a.playbackInfo.primaryChannel,ue.VolumeCoarse,r),this._handler.addControlChange(0,0,a.playbackInfo.secondaryChannel,ue.VolumeCoarse,r)}generateSingleBeat(e){this.prepareSingleBeat(e),this.generateBeat(e,-e.playbackStart,e.voice.bar)}generateSingleNote(e){this.prepareSingleBeat(e.beat),this.generateNote(e,0,e.beat.playbackDuration,new Int32Array(e.beat.voice.bar.staff.tuning.length))}}vs.DefaultDurationDead=30,vs.DefaultDurationPalmMute=80,vs.PitchBendRangeInSemitones=16,vs.PitchValuePerSemitone=D.DefaultPitchWheel/vs.PitchBendRangeInSemitones,vs.MinBreakpointsPerSemitone=6,vs.MillisecondsPerBreakpoint=150;class Bs{constructor(){this.startTick=0,this.endTick=0}}class Ts{constructor(e,t){this.width=0,this.height=0,this.x=e,this.y=t}get scale(){return this.renderer.scale}doLayout(){}paint(e,t,i){}}class ks extends Ts{constructor(e=0,t=0){super(e,t),this.beat=null,this.nextGlyph=null,this.previousGlyph=null}}class Ns extends ks{constructor(e,t,i,s){super(e,t),this.glyphScale=0,this.glyphScale=i,this.symbol=s}paint(e,t,i){i.fillMusicFontSymbol(e+this.x,t+this.y,this.glyphScale*this.scale,this.symbol,!1)}}class R extends Ns{constructor(e,t,i,s){super(e,t,s?R.GraceScale:1,R.getSymbol(i)),this._isGrace=s,this._duration=i}paint(e,t,i){var s=this._isGrace?this.scale:0;i.fillMusicFontSymbol(e+this.x,t+this.y+s,this.glyphScale*this.scale,this.symbol,!1)}doLayout(){var e=(this._isGrace?R.GraceScale:1)*this.scale;switch(this._duration){case x.QuadrupleWhole:this.width=14*e;break;case x.DoubleWhole:case x.Whole:this.width=14*(this._isGrace?R.GraceScale:1)*this.scale;break;default:this.width=R.QuarterNoteHeadWidth*(this._isGrace?R.GraceScale:1)*this.scale}this.height=R.NoteHeadHeight*e}static getSymbol(e){switch(e){case x.QuadrupleWhole:return k.NoteheadDoubleWholeSquare;case x.DoubleWhole:return k.NoteheadDoubleWhole;case x.Whole:return k.NoteheadWhole;case x.Half:return k.NoteheadHalf;default:return k.NoteheadBlack}}}R.GraceScale=.75,R.NoteHeadHeight=8,R.QuarterNoteHeadWidth=9;class xs extends Ns{constructor(e,t,i,s,a){super(e,t,a?R.GraceScale:1,xs.getSymbol(i,s,a))}doLayout(){this.width=0}static getSymbol(e,t,i){if(i&&(e=x.Eighth),t===E.Up)switch(e){case x.Eighth:return k.FlagEighthUp;case x.Sixteenth:return k.FlagSixteenthUp;case x.ThirtySecond:return k.FlagThirtySecondUp;case x.SixtyFourth:return k.FlagSixtyFourthUp;case x.OneHundredTwentyEighth:return k.FlagOneHundredTwentyEighthUp;case x.TwoHundredFiftySixth:return k.FlagTwoHundredFiftySixthUp;default:return k.FlagEighthUp}switch(e){case x.Eighth:return k.FlagEighthDown;case x.Sixteenth:return k.FlagSixteenthDown;case x.ThirtySecond:return k.FlagThirtySecondDown;case x.SixtyFourth:return k.FlagSixtyFourthDown;case x.OneHundredTwentyEighth:case x.TwoHundredFiftySixth:return k.FlagOneHundredTwentyEighthDown;default:return k.FlagEighthDown}}}xs.FlagWidth=11;class Ps extends Ts{constructor(e,t){super(0,0),this.ties=[],this.minWidth=0,this.beat=e,this.ties=[],this.voiceContainer=t}get onTimeX(){return this.onNotes.x+this.onNotes.centerX}addTie(e){e.renderer=this.renderer,this.ties.push(e)}registerLayoutingInfo(e){let t=this.preNotes.computedWidth+this.onNotes.centerX,i=(this.beat.graceGroup&&!this.beat.graceGroup.isComplete&&(t+=Ps.GraceBeatPadding*this.renderer.scale),this.onNotes.computedWidth-this.onNotes.centerX);var s=this.renderer.helpers.getBeamingHelperForBeat(this.beat);(s&&s.hasFlag||this.beat.graceType!==_.None)&&(i+=xs.FlagWidth*this.scale*(this.beat.graceType!==_.None?R.GraceScale:1));for(const a of this.ties)i+=a.width;this.beat.graceType!==_.None&&(i+=Ps.GraceBeatPadding*this.renderer.scale),e.addBeatSpring(this.beat,t,i),e.setPreBeatSize(this.beat,this.preNotes.computedWidth),e.setOnBeatSize(this.beat,this.onNotes.computedWidth),e.setBeatCenterX(this.beat,this.onNotes.centerX)}applyLayoutingInfo(e){let t=e.getBeatCenterX(this.beat)-this.onNotes.centerX;this.beat.graceGroup&&!this.beat.graceGroup.isComplete&&(t+=Ps.GraceBeatPadding*this.renderer.scale),this.preNotes.x=t,this.preNotes.width=e.getPreBeatSize(this.beat),this.onNotes.width=e.getOnBeatSize(this.beat),this.onNotes.x=this.preNotes.x+this.preNotes.width,this.onNotes.updateBeamingHelper(),this.updateWidth()}doLayout(){this.preNotes.x=0,this.preNotes.renderer=this.renderer,(this.preNotes.container=this).preNotes.doLayout(),this.onNotes.x=this.preNotes.x+this.preNotes.width,this.onNotes.renderer=this.renderer,(this.onNotes.container=this).onNotes.doLayout();let e=this.beat.notes.length-1;for(;0<=e;)this.createTies(this.beat.notes[e--]);this.renderer.registerTies(this.ties),this.updateWidth()}updateWidth(){if(this.minWidth=this.preNotes.width+this.onNotes.width,!this.beat.isRest)if(1===this.onNotes.beamingHelper.beats.length)this.beat.duration>=x.Eighth&&(this.minWidth+=20*this.scale);else switch(this.beat.duration){case x.OneHundredTwentyEighth:case x.TwoHundredFiftySixth:this.minWidth+=10*this.scale}let e=0;for(var t of this.ties)t.width>e&&(e=t.width);this.minWidth+=e,this.width=this.minWidth}scaleToWidth(e){this.onNotes.updateBeamingHelper(),this.width=e}createTies(e){}static getGroupId(e){return"b"+e.id}paint(e,t,i){if(!this.beat.voice.isEmpty){var s=this.preNotes.isEmpty&&this.onNotes.isEmpty&&0===this.ties.length;if(!s){i.beginGroup(Ps.getGroupId(this.beat)),this.preNotes.paint(e+this.x,t+this.y,i),this.onNotes.paint(e+this.x,t+this.y,i);var a=e-this.voiceContainer.x-this.renderer.x,r=t-this.voiceContainer.y-this.renderer.y;for(let e=0,t=this.ties.length;e<t;e++){var n=this.ties[e];n.renderer=this.renderer,n.paint(a,r,i)}i.endGroup()}}}buildBoundingsLookup(e,t,i,s){var a=new rs;a.beat=this.beat,a.visualBounds=new Ze,a.visualBounds.x=t+this.x+this.onNotes.x,a.visualBounds.y=e.visualBounds.y,a.visualBounds.w=this.onNotes.width,a.visualBounds.h=e.visualBounds.h,a.realBounds=new Ze,a.realBounds.x=t+this.x,a.realBounds.y=e.realBounds.y,a.realBounds.w=this.width,a.realBounds.h=e.realBounds.h,s&&(a.visualBounds.x=t+this.x,a.realBounds.x=a.visualBounds.x),e.addBeat(a),this.renderer.settings.core.includeNoteBounds&&this.onNotes.buildBoundingsLookup(a,t+this.x,i+this.y)}}Ps.GraceBeatPadding=3;class Es{constructor(){this.oldWidth=0,this.newWidth=0,this.settings=null}core(){return this.settings&&this.causeIssue()?this.settings.core:new po}causeIssue(){return!(this.settings=null)}}class Cs{constructor(e){this.activeBeats=e}}class Fs{constructor(e){this.bounds=null,this.beat=e}}class Ls extends me{constructor(e,t){super(T.AlphaTabErrorType.General,e),this.xhr=t,Object.setPrototypeOf(this,Ls.prototype)}}class Ms{static loadScoreAsync(e,a,r,n){let o=new XMLHttpRequest;o.open("GET",e,!0,null,null),o.responseType="arraybuffer",o.onreadystatechange=()=>{if(o.readyState===XMLHttpRequest.DONE){var e=o.response;if(200===o.status||0===o.status&&e)try{var t=o.response,i=new Uint8Array(t),s=Ms.loadScoreFromBytes(i,n);a(s)}catch(e){r(e)}else 0===o.status?r(new Ls("You are offline!!\n Please Check Your Network.",o)):404===o.status?r(new Ls("Requested URL not found.",o)):500===o.status?r(new Ls("Internel Server Error.",o)):"parsererror"===o.statusText?r(new Ls("Error.\nParsing JSON Request failed.",o)):"timeout"===o.statusText?r(new Ls("Request Time out.",o)):r(new Ls("Unknow Error: "+o.responseText,o))}},o.send()}static loadScoreFromBytes(e,t){t=t||new Di;var i=O.buildImporters();C.debug("ScoreLoader","Loading score from "+e.length+" bytes using "+i.length+" importers",null);let s=null;var a,r=qe.fromBuffer(e);for(a of i){r.reset();try{C.debug("ScoreLoader","Importing using importer "+a.name),a.init(r,t),s=a.readScore(),C.debug("ScoreLoader","Score imported using "+a.name);break}catch(e){if(!(e instanceof fe))throw C.error("ScoreLoader","Score import failed due to unexpected error: ",e),e;C.debug("ScoreLoader",a.name+" does not support the file")}}if(s)return s;throw C.error("ScoreLoader","No compatible importer found for file"),new fe("No compatible importer found for file")}}class Ds{constructor(e){this.mouseEvent=e}get isLeftMouseButton(){return 0===this.mouseEvent.button}getX(e){e=e.element,e=e.getBoundingClientRect().left+e.ownerDocument.defaultView.pageXOffset;return this.mouseEvent.pageX-e}getY(e){e=e.element,e=e.getBoundingClientRect().top+e.ownerDocument.defaultView.pageYOffset;return this.mouseEvent.pageY-e}preventDefault(){this.mouseEvent.preventDefault()}}class Is{constructor(e){this._resizeListeners=0,this.lastBounds=new Ze,this.element=e,this.mouseDown={on:t=>{this.element.addEventListener("mousedown",e=>{t(new Ds(e))},!0)},off:e=>{}},this.mouseUp={on:t=>{this.element.addEventListener("mouseup",e=>{t(new Ds(e))},!0)},off:e=>{}},this.mouseMove={on:t=>{this.element.addEventListener("mousemove",e=>{t(new Ds(e))},!0)},off:e=>{}},this.resize={on:e=>{0===this._resizeListeners&&Is.resizeObserver.value.observe(this.element),this.element.addEventListener("resize",e,!0),this._resizeListeners++},off:e=>{this.element.removeEventListener("resize",e,!0),this._resizeListeners--,this._resizeListeners<=0&&(this._resizeListeners=0,Is.resizeObserver.value.unobserve(this.element))}}}get width(){return this.element.offsetWidth}set width(e){this.element.style.width=e+"px"}get scrollLeft(){return this.element.scrollLeft}set scrollLeft(e){this.element.scrollTop=e}get scrollTop(){return this.element.scrollLeft}set scrollTop(e){this.element.scrollTop=e}get height(){return this.element.offsetHeight}set height(e){this.element.style.height=0<=e?e+"px":"100%"}get isVisible(){return!!this.element.offsetWidth||!!this.element.offsetHeight||!!this.element.getClientRects().length}stopAnimation(){this.element.style.transition="none"}transitionToX(e,t){this.element.style.transition=`transform ${e}ms linear`,this.setBounds(t,NaN,NaN,NaN)}setBounds(e,t,i,s){isNaN(e)&&(e=this.lastBounds.x),isNaN(t)&&(t=this.lastBounds.y),isNaN(i)&&(i=this.lastBounds.w),isNaN(s)&&(s=this.lastBounds.h),this.element.style.transform=`translate(${e}px, ${t}px) scale(${i}, ${s})`,this.element.style.transformOrigin="top left",this.lastBounds.x=e,this.lastBounds.y=t,this.lastBounds.w=i,this.lastBounds.h=s}appendChild(e){this.element.appendChild(e.element)}clear(){this.element.innerHTML=""}}Is.resizeObserver=new _e(()=>new ResizeObserver(e=>{for(const i of e){var t=new CustomEvent("resize",{detail:i});i.target.dispatchEvent(t)}}));var Rs,As,Os,Gs,A,Hs,Vs,Ws,zs,Us=function(e,n,o,h){return new(o=o||Promise)(function(i,t){function s(e){try{r(h.next(e))}catch(e){t(e)}}function a(e){try{r(h.throw(e))}catch(e){t(e)}}function r(e){var t;e.done?i(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(s,a)}r((h=h.apply(e,n||[])).next())})};class Xs{constructor(e){this._isStarted=!1,this.isFontLoaded=!1,this.fontLoaded=new li,this._originalFamilies=e,this._families=e}checkForFontAvailability(){if(O.isRunningInWorker)return void(this.isFontLoaded=!1);if(this._isStarted)return;this._isStarted=!0;let e=0,t=window.setInterval(()=>{C.warning("Rendering",`Could not load font '${this._families[0]}' within ${5*(e+1)} seconds`,null),1<this._families.length?(this._families.shift(),e=0):e++},5e3),i=(C.debug("Font","Start checking for font availablility: "+this._families.join(", ")),e=>{1<this._families.length?(C.debug("Font",`[${this._families[0]}] Loading Failed, switching to `+this._families[1],e),this._families.shift(),window.setTimeout(()=>{a()},0)):(C.error("Font",`[${this._originalFamilies.join(",")}] Loading Failed, rendering cannot start`,e),window.clearInterval(t))}),s=e=>{C.debug("Font",`[${e}] Font API signaled available`),this.isFontLoaded=!0,window.clearInterval(t),this.fontLoaded.trigger(this._families[0])},a=()=>Us(this,void 0,void 0,function*(){for(const e of this._families)if(yield this.isFontAvailable(e,!1))return void s(e);try{yield document.fonts.load("1em "+this._families[0])}catch(e){i(e)}return C.debug("Font",`[${this._families[0]}] Font API signaled loaded`),(yield this.isFontAvailable(this._families[0],!0))?s(this._families[0]):i("Font not available"),!0});document.fonts.ready.then(()=>{a()})}isFontAvailable(s,a){return new Promise(e=>{const t="1em "+s;if(document.fonts.check(t))e(!0);else if(a){C.debug("Font",`Font ${s} not available, creating test element to trigger load`);const i=document.createElement("div");i.style.font=t,i.style.opacity="0",i.style.position="absolute",i.style.top="0",i.style.left="0",i.innerText=`Trigger ${s} load`,document.body.appendChild(i),setTimeout(()=>{document.body.removeChild(i),document.fonts.check(t)?e(!0):e(!1)},200)}else e(!1)})}}class Ys{constructor(e){this._writePosition=0,this._readPosition=0,this.count=0,this._buffer=new Float32Array(e)}clear(){this._readPosition=0,this._writePosition=0,this.count=0,this._buffer=new Float32Array(this._buffer.length)}write(e,t,i){let s=0;i>this._buffer.length-this.count&&(i=this._buffer.length-this.count);var a=Math.min(this._buffer.length-this._writePosition,i);return this._buffer.set(e.subarray(t,t+a),this._writePosition),this._writePosition+=a,this._writePosition%=this._buffer.length,(s+=a)<i&&(this._buffer.set(e.subarray(t+s,t+s+i-s),this._writePosition),this._writePosition+=i-s,s=i),this.count+=s,s}read(e,t,i){i>this.count&&(i=this.count);let s=0;var a=Math.min(this._buffer.length-this._readPosition,i);return e.set(this._buffer.subarray(this._readPosition,this._readPosition+a),t),s+=a,this._readPosition+=a,this._readPosition%=this._buffer.length,s<i&&(e.set(this._buffer.subarray(this._readPosition,this._readPosition+i-s),t+s),this._readPosition+=i-s,s=i),this.count-=s,s}}class qs{constructor(){this._context=null,this._buffer=null,this._source=null,this.ready=new hi,this.samplesPlayed=new li,this.sampleRequest=new hi}get sampleRate(){return this._context?this._context.sampleRate:qs.PreferredSampleRate}activate(t){this._context||(this._context=this.createAudioContext()),"suspended"!==this._context.state&&"interrupted"!==this._context.state||(C.debug("WebAudio","Audio Context is suspended, trying resume"),this._context.resume().then(()=>{var e;C.debug("WebAudio",`Audio Context resume success: state=${null==(e=this._context)?void 0:e.state}, sampleRate:`+(null==(e=this._context)?void 0:e.sampleRate)),t&&t()},e=>{var t;C.warning("WebAudio",`Audio Context resume failed: state=${null==(t=this._context)?void 0:t.state}, sampleRate:${null==(t=this._context)?void 0:t.sampleRate}, reason=`+e)}))}patchIosSampleRate(){var e,t,i=navigator.userAgent;-1===i.indexOf("iPhone")&&-1===i.indexOf("iPad")||(e=(i=this.createAudioContext()).createBuffer(1,1,qs.PreferredSampleRate),(t=i.createBufferSource()).buffer=e,t.connect(i.destination),t.start(0),t.disconnect(0),i.close())}createAudioContext(){if("AudioContext"in O.globalThis)return new AudioContext;if("webkitAudioContext"in O.globalThis)return new webkitAudioContext;throw new me(T.AlphaTabErrorType.General,"AudioContext not found")}open(e){this.patchIosSampleRate(),this._context=this.createAudioContext(),"suspended"===this._context.state&&this.registerResumeHandler()}registerResumeHandler(){this._resumeHandler=(()=>{this.activate(()=>{this.unregisterResumeHandler()})}).bind(this),document.body.addEventListener("touchend",this._resumeHandler,!1),document.body.addEventListener("click",this._resumeHandler,!1)}unregisterResumeHandler(){var e=this._resumeHandler;e&&(document.body.removeEventListener("touchend",e,!1),document.body.removeEventListener("click",e,!1))}play(){var e=this._context;this.activate(),this._buffer=e.createBuffer(2,qs.BufferSize,e.sampleRate),this._source=e.createBufferSource(),this._source.buffer=this._buffer,this._source.loop=!0}pause(){this._source&&(this._source.stop(0),this._source.disconnect()),this._source=null}destroy(){var e;this.pause(),null!=(e=this._context)&&e.close(),this._context=null,this.unregisterResumeHandler()}onSamplesPlayed(e){this.samplesPlayed.trigger(e)}onSampleRequest(){this.sampleRequest.trigger()}onReady(){this.ready.trigger()}}qs.BufferSize=4096,qs.PreferredSampleRate=44100;class Js extends qs{constructor(){super(...arguments),this._audioNode=null,this._bufferCount=0,this._requestedBufferCount=0,this._outputBuffer=new Float32Array(0)}open(e){super.open(e),this._bufferCount=Math.floor(e*this.sampleRate/1e3/qs.BufferSize),this._circularBuffer=new Ys(qs.BufferSize*this._bufferCount),this.onReady()}play(){super.play();var e=this._context;this._audioNode=e.createScriptProcessor(4096,0,2),this._audioNode.onaudioprocess=this.generateSound.bind(this),this._circularBuffer.clear(),this.requestBuffers(),this._source=e.createBufferSource(),this._source.buffer=this._buffer,this._source.loop=!0,this._source.connect(this._audioNode,0,0),this._source.start(0),this._audioNode.connect(e.destination,0,0)}pause(){super.pause(),this._audioNode&&this._audioNode.disconnect(0),this._audioNode=null}addSamples(e){this._circularBuffer.write(e,0,e.length),this._requestedBufferCount--}resetSamples(){this._circularBuffer.clear()}requestBuffers(){var t=this._bufferCount/2|0,e=t*qs.BufferSize;if(this._circularBuffer.count+this._requestedBufferCount*qs.BufferSize<e){for(let e=0;e<t;e++)this.onSampleRequest();this._requestedBufferCount+=t}}generateSound(e){var t=e.outputBuffer.getChannelData(0),i=e.outputBuffer.getChannelData(1),e=t.length+i.length;let s=this._outputBuffer;s.length!==e&&(s=new Float32Array(e),this._outputBuffer=s);e=this._circularBuffer.read(s,0,Math.min(s.length,this._circularBuffer.count));let a=0;for(let e=0;e<t.length;e++)t[e]=s[a++],i[e]=s[a++];this.onSamplesPlayed(e/D.AudioChannels),this.requestBuffers()}}class js{constructor(e,t){this.loaded=e,this.total=t}}class Qs{constructor(e,t,i,s){this._workerIsReadyForPlayback=!1,this._workerIsReady=!1,this._outputIsReady=!1,this._state=ne.Paused,this._masterVolume=0,this._metronomeVolume=0,this._countInVolume=0,this._playbackSpeed=0,this._tickPosition=0,this._timePosition=0,this._isLooping=!1,this._playbackRange=null,this._midiEventsPlayedFilter=[],this.ready=new hi,this.readyForPlayback=new hi,this.finished=new hi,this.soundFontLoaded=new hi,this.soundFontLoadFailed=new li,this.midiLoaded=new li,this.midiLoadFailed=new li,this.stateChanged=new li,this.positionChanged=new li,this.midiEventsPlayed=new li,this.playbackRangeChanged=new li,this._workerIsReadyForPlayback=!1,this._workerIsReady=!1,this._outputIsReady=!1,this._state=ne.Paused,this._masterVolume=0,this._metronomeVolume=0,this._playbackSpeed=0,this._tickPosition=0,this._timePosition=0,this._isLooping=!1,this._playbackRange=null,this._output=e,this._output.ready.on(this.onOutputReady.bind(this)),this._output.samplesPlayed.on(this.onOutputSamplesPlayed.bind(this)),this._output.sampleRequest.on(this.onOutputSampleRequest.bind(this)),this._output.open(s);try{this._synth=O.createAlphaTabWorker(t)}catch(e){C.error("AlphaSynth","Failed to create WebWorker: "+e)}this._synth.addEventListener("message",this.handleWorkerMessage.bind(this),!1),this._synth.postMessage({cmd:"alphaSynth.initialize",sampleRate:this._output.sampleRate,logLevel:i,bufferTimeInMilliseconds:s}),this.masterVolume=1,this.playbackSpeed=1,this.metronomeVolume=0}get isReady(){return this._workerIsReady&&this._outputIsReady}get isReadyForPlayback(){return this._workerIsReadyForPlayback}get state(){return this._state}get logLevel(){return C.logLevel}set logLevel(e){C.logLevel=e,this._synth.postMessage({cmd:"alphaSynth.setLogLevel",value:e})}get masterVolume(){return this._masterVolume}set masterVolume(e){e=Math.max(e,D.MinVolume),this._masterVolume=e,this._synth.postMessage({cmd:"alphaSynth.setMasterVolume",value:e})}get metronomeVolume(){return this._metronomeVolume}set metronomeVolume(e){e=Math.max(e,D.MinVolume),this._metronomeVolume=e,this._synth.postMessage({cmd:"alphaSynth.setMetronomeVolume",value:e})}get countInVolume(){return this._countInVolume}set countInVolume(e){e=Math.max(e,D.MinVolume),this._countInVolume=e,this._synth.postMessage({cmd:"alphaSynth.setCountInVolume",value:e})}get midiEventsPlayedFilter(){return this._midiEventsPlayedFilter}set midiEventsPlayedFilter(e){this._midiEventsPlayedFilter=e,this._synth.postMessage({cmd:"alphaSynth.setMidiEventsPlayedFilter",value:e})}get playbackSpeed(){return this._playbackSpeed}set playbackSpeed(e){e=Zt.clamp(e,D.MinPlaybackSpeed,D.MaxPlaybackSpeed),this._playbackSpeed=e,this._synth.postMessage({cmd:"alphaSynth.setPlaybackSpeed",value:e})}get tickPosition(){return this._tickPosition}set tickPosition(e){this._tickPosition=e=e<0?0:e,this._synth.postMessage({cmd:"alphaSynth.setTickPosition",value:e})}get timePosition(){return this._timePosition}set timePosition(e){this._timePosition=e=e<0?0:e,this._synth.postMessage({cmd:"alphaSynth.setTimePosition",value:e})}get isLooping(){return this._isLooping}set isLooping(e){this._isLooping=e,this._synth.postMessage({cmd:"alphaSynth.setIsLooping",value:e})}get playbackRange(){return this._playbackRange}set playbackRange(e){e&&(e.startTick<0&&(e.startTick=0),e.endTick<0)&&(e.endTick=0),this._playbackRange=e,this._synth.postMessage({cmd:"alphaSynth.setPlaybackRange",value:e})}destroy(){this._synth.postMessage({cmd:"alphaSynth.destroy"})}play(){return this._output.activate(),this._synth.postMessage({cmd:"alphaSynth.play"}),!0}pause(){this._synth.postMessage({cmd:"alphaSynth.pause"})}playPause(){this._output.activate(),this._synth.postMessage({cmd:"alphaSynth.playPause"})}stop(){this._synth.postMessage({cmd:"alphaSynth.stop"})}playOneTimeMidiFile(e){this._synth.postMessage({cmd:"alphaSynth.playOneTimeMidiFile",midi:Zi.midiFileToJsObject(e)})}loadSoundFont(e,t){this._synth.postMessage({cmd:"alphaSynth.loadSoundFontBytes",data:e,append:t})}loadSoundFontFromUrl(e,i,t){C.debug("AlphaSynth","Start loading Soundfont from url "+e);let s=new XMLHttpRequest;s.open("GET",e,!0,null,null),s.responseType="arraybuffer",s.onload=e=>{var t=new Uint8Array(s.response);this.loadSoundFont(t,i)},s.onerror=e=>{C.error("AlphaSynth","Loading failed: "+e.message),this.soundFontLoadFailed.trigger(new Ls(e.message,s))},s.onprogress=e=>{C.debug("AlphaSynth",`Soundfont downloading: ${e.loaded}/${e.total} bytes`),t(new js(e.loaded,e.total))},s.send()}resetSoundFonts(){this._synth.postMessage({cmd:"alphaSynth.resetSoundFonts"})}loadMidiFile(e){this._synth.postMessage({cmd:"alphaSynth.loadMidi",midi:Zi.midiFileToJsObject(e)})}setChannelMute(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelMute",channel:e,mute:t})}resetChannelStates(){this._synth.postMessage({cmd:"alphaSynth.resetChannelStates"})}setChannelSolo(e,t){this._synth.postMessage({cmd:"alphaSynth.setChannelSolo",channel:e,solo:t})}setChannelVolume(e,t){t=Math.max(t,D.MinVolume),this._synth.postMessage({cmd:"alphaSynth.setChannelVolume",channel:e,volume:t})}handleWorkerMessage(e){var t=e.data;switch(t.cmd){case"alphaSynth.ready":this._workerIsReady=!0,this.checkReady();break;case"alphaSynth.destroyed":this._synth.terminate();break;case"alphaSynth.readyForPlayback":this._workerIsReadyForPlayback=!0,this.checkReadyForPlayback();break;case"alphaSynth.positionChanged":this._timePosition=t.currentTime,this._tickPosition=t.currentTick,this.positionChanged.trigger(new At(t.currentTime,t.endTime,t.currentTick,t.endTick,t.isSeek));break;case"alphaSynth.midiEventsPlayed":this.midiEventsPlayed.trigger(new di(t.events.map(Zi.jsObjectToMidiEvent)));break;case"alphaSynth.playerStateChanged":this._state=t.state,this.stateChanged.trigger(new Rt(t.state,t.stopped));break;case"alphaSynth.playbackRangeChanged":this._playbackRange=t.playbackRange,this.playbackRangeChanged.trigger(new ci(this._playbackRange));break;case"alphaSynth.finished":this.finished.trigger();break;case"alphaSynth.soundFontLoaded":this.soundFontLoaded.trigger();break;case"alphaSynth.soundFontLoadFailed":this.soundFontLoadFailed.trigger(t.error);break;case"alphaSynth.midiLoaded":this.checkReadyForPlayback(),this.midiLoaded.trigger(new At(t.currentTime,t.endTime,t.currentTick,t.endTick,t.isSeek));break;case"alphaSynth.midiLoadFailed":this.checkReadyForPlayback(),this.midiLoadFailed.trigger(t.error);break;case"alphaSynth.output.addSamples":this._output.addSamples(t.samples);break;case"alphaSynth.output.play":this._output.play();break;case"alphaSynth.output.pause":this._output.pause();break;case"alphaSynth.output.destroy":this._output.destroy();break;case"alphaSynth.output.resetSamples":this._output.resetSamples()}}checkReady(){this.isReady&&this.ready.trigger()}checkReadyForPlayback(){this.isReadyForPlayback&&this.readyForPlayback.trigger()}onOutputSampleRequest(){this._synth.postMessage({cmd:"alphaSynth.output.sampleRequest"})}onOutputSamplesPlayed(e){this._synth.postMessage({cmd:"alphaSynth.output.samplesPlayed",samples:e})}onOutputReady(){this._outputIsReady=!0,this.checkReady()}}class Ks{constructor(e,t){this._width=0,this.boundsLookup=null,this.preRender=new li,this.partialRenderFinished=new li,this.partialLayoutFinished=new li,this.renderFinished=new li,this.postRenderFinished=new hi,this.error=new li,this._api=e;try{this._worker=O.createAlphaTabWorker(t.core.scriptFile)}catch(e){return void C.error("Rendering","Failed to create WebWorker: "+e)}this._worker.postMessage({cmd:"alphaTab.initialize",settings:this.serializeSettingsForWorker(t)}),this._worker.addEventListener("message",this.handleWorkerMessage.bind(this))}destroy(){this._worker.terminate()}updateSettings(e){this._worker.postMessage({cmd:"alphaTab.updateSettings",settings:this.serializeSettingsForWorker(e)})}serializeSettingsForWorker(e){e=Zi.settingsToJsObject(e);return e.delete("player"),e}render(){this._worker.postMessage({cmd:"alphaTab.render"})}resizeRender(){this._worker.postMessage({cmd:"alphaTab.resizeRender"})}renderResult(e){this._worker.postMessage({cmd:"alphaTab.renderResult",resultId:e})}get width(){return this._width}set width(e){this._width=e,this._worker.postMessage({cmd:"alphaTab.setWidth",width:e})}handleWorkerMessage(e){var t=e.data;switch(t.cmd){case"alphaTab.preRender":this.preRender.trigger(t.resize);break;case"alphaTab.partialRenderFinished":this.partialRenderFinished.trigger(t.result);break;case"alphaTab.partialLayoutFinished":this.partialLayoutFinished.trigger(t.result);break;case"alphaTab.renderFinished":this.renderFinished.trigger(t.result);break;case"alphaTab.postRenderFinished":this.boundsLookup=ls.fromJson(t.boundsLookup,this._api.score),this.boundsLookup.finish(),this.postRenderFinished.trigger();break;case"alphaTab.error":this.error.trigger(t.error)}}renderScore(e,t){e=null==e?null:Zi.scoreToJsObject(e);this._worker.postMessage({cmd:"alphaTab.renderScore",score:e,trackIndexes:t,fontSizes:is.FontSizeLookupTables})}}class $s{constructor(e,t,i,s){this.cursorWrapper=e,this.barCursor=t,this.beatCursor=i,this.selectionWrapper=s}}(e=Rs=Rs||{})[e.Browser=0]="Browser",e[e.NodeJs=1]="NodeJs",e[e.BrowserModule=2]="BrowserModule";class Zs{static init(){var e;Zs._isRegistered||(Zs._isRegistered=!0,registerProcessor("alphatab",((e=class i extends AudioWorkletProcessor{constructor(e){super(e),this._outputBuffer=new Float32Array(0),this._bufferCount=0,this._requestedBufferCount=0,C.debug("WebAudio","creating processor"),this._bufferCount=Math.floor(e.processorOptions.bufferTimeInMilliseconds*sampleRate/1e3/i.BufferSize),this._circularBuffer=new Ys(i.BufferSize*this._bufferCount),this.port.onmessage=this.handleMessage.bind(this)}handleMessage(e){var t=e.data;switch(t.cmd){case es.CmdOutputAddSamples:var i=t.samples;this._circularBuffer.write(i,0,i.length),this._requestedBufferCount--;break;case es.CmdOutputResetSamples:this._circularBuffer.clear()}}process(e,s,t){if(1!==s.length&&2!==s[0].length)return!1;var a=s[0][0],r=s[0][1];if(a&&r){s=a.length+r.length;let t=this._outputBuffer;t.length!==s&&(t=new Float32Array(s),this._outputBuffer=t);s=this._circularBuffer.read(t,0,Math.min(t.length,this._circularBuffer.count));let i=0;for(let e=0;e<a.length;e++)a[e]=t[i++],r[e]=t[i++];this.port.postMessage({cmd:es.CmdOutputSamplesPlayed,samples:s/D.AudioChannels}),this.requestBuffers()}return!0}requestBuffers(){var t=this._bufferCount/2|0,e=t*i.BufferSize;if(this._circularBuffer.count+this._requestedBufferCount*i.BufferSize<e){for(let e=0;e<t;e++)this.port.postMessage({cmd:es.CmdOutputSampleRequest});this._requestedBufferCount+=t}}}).BufferSize=4096,e)))}}Zs._isRegistered=!1;class ea extends qs{constructor(){super(...arguments),this._worklet=null,this._bufferTimeInMilliseconds=0}open(e){super.open(e),this._bufferTimeInMilliseconds=e,this.onReady()}play(){super.play();let e=this._context;e.audioWorklet.addModule(O.scriptFile).then(()=>{this._worklet=new AudioWorkletNode(e,"alphatab",{numberOfOutputs:1,outputChannelCount:[2],processorOptions:{bufferTimeInMilliseconds:this._bufferTimeInMilliseconds}}),this._worklet.port.onmessage=this.handleMessage.bind(this),this._source.connect(this._worklet),this._source.start(0),this._worklet.connect(e.destination)},e=>{C.error("WebAudio","Audio Worklet creation failed: reason="+e)})}handleMessage(e){var t=e.data;switch(t.cmd){case es.CmdOutputSamplesPlayed:this.onSamplesPlayed(t.samples);break;case es.CmdOutputSampleRequest:this.onSampleRequest()}}pause(){super.pause(),this._worklet&&(this._worklet.port.onmessage=null,this._worklet.disconnect()),this._worklet=null}addSamples(e){var t;null!=(t=this._worklet)&&t.port.postMessage({cmd:es.CmdOutputAddSamples,samples:e})}resetSamples(){var e;null!=(e=this._worklet)&&e.port.postMessage({cmd:es.CmdOutputResetSamples})}}class ta extends Is{constructor(e,t,i){super(e),this._xscale=t,this._yscale=i}get width(){return this.element.offsetWidth/this._xscale}set width(e){this.element.style.width=e*this._xscale+"px"}get height(){return this.element.offsetHeight/this._yscale}set height(e){this.element.style.height=0<=e?e*this._yscale+"px":"100%"}setBounds(e,t,i,s){isNaN(e)&&(e=this.lastBounds.x),isNaN(t)&&(t=this.lastBounds.y),isNaN(i)?i=this.lastBounds.w:i/=this._xscale,isNaN(s)?s=this.lastBounds.h:s/=this._yscale,this.element.style.transform=`translate(${e}px, ${t}px) scale(${i}, ${s})`,this.element.style.transformOrigin="top left",this.lastBounds.x=e,this.lastBounds.y=t,this.lastBounds.w=i,this.lastBounds.h=s}}(e=As=As||{})[e.LayoutDone=0]="LayoutDone",e[e.RenderRequested=1]="RenderRequested",e[e.RenderDone=2]="RenderDone",e[e.Detached=3]="Detached";class ia{constructor(e){if(this._fontCheckers=new Map,this._contents=null,this._file=null,this._totalResultCount=0,this._initialTrackIndexes=null,this._barToElementLookup=new Map,this._resultIdToElementLookup=new Map,this.rootContainerBecameVisible=new hi,this.canRenderChanged=new hi,this._highlightedElements=[],this._scrollContainer=null,O.webPlatform!==Rs.Browser&&O.webPlatform!==Rs.BrowserModule)throw new me(T.AlphaTabErrorType.General,"Usage of AlphaTabApi is only possible in browser environments. For usage in node use the Low Level APIs");e.classList.add("alphaTab"),this.rootContainer=new Is(e),this.areWorkersSupported="Worker"in window,O.bravuraFontChecker.fontLoaded.on(this.onFontLoaded.bind(this)),this._intersectionObserver=new IntersectionObserver(this.onElementVisibilityChanged.bind(this),{threshold:[0,.01,1]}),this._intersectionObserver.observe(e)}get resizeThrottle(){return 10}get canRender(){return this.areAllFontsLoaded()}areAllFontsLoaded(){if(O.bravuraFontChecker.checkForFontAvailability(),!O.bravuraFontChecker.isFontLoaded)return!1;let e=!1;for(const t of this._fontCheckers.values())t.isFontLoaded||(e=!0);return!e&&(C.debug("Font","All fonts loaded: "+this._fontCheckers.size),!0)}onFontLoaded(e){is.generateFontLookup(e),this.areAllFontsLoaded()&&this.canRenderChanged.trigger()}onElementVisibilityChanged(e){for(const s of e){var t,i=s.target;i===this.rootContainer.element?s.isIntersecting&&(this.rootContainerBecameVisible.trigger(),this._intersectionObserver.unobserve(this.rootContainer.element)):"layoutResultId"in i&&this._api.settings.core.enableLazyLoading&&(t=i,s.isIntersecting?t.renderedResultId!==t.layoutResultId?this._resultIdToElementLookup.has(t.layoutResultId)?this._api.renderer.renderResult(t.layoutResultId):i.replaceChildren():t.resultState===As.Detached&&(i.replaceChildren(...t.renderedResult),t.resultState=As.RenderDone):t.resultState===As.RenderDone&&(t.resultState=As.Detached,t.replaceChildren()))}}createWorkerRenderer(){return new Ks(this._api,this._api.settings)}initialize(e,t){this._api=e;let i;i=t instanceof Di?t:Zi.jsObjectToSettings(t);t=this.getDataAttributes(),Mi.fromJson(i,t),i.notation.notationMode===T.NotationMode.SongBook&&i.setSongBookModeSettings(),e.settings=i,this.setupFontCheckers(i),this._initialTrackIndexes=this.parseTracks(i.core.tracks),this._contents="",t=e.container;i.core.tex&&(this._contents=t.element.innerHTML,t.element.innerHTML=""),this.createStyleElement(i),this._file=i.core.file}setupFontCheckers(e){this.registerFontChecker(e.display.resources.copyrightFont),this.registerFontChecker(e.display.resources.effectFont),this.registerFontChecker(e.display.resources.fingeringFont),this.registerFontChecker(e.display.resources.graceFont),this.registerFontChecker(e.display.resources.markerFont),this.registerFontChecker(e.display.resources.tablatureFont),this.registerFontChecker(e.display.resources.titleFont),this.registerFontChecker(e.display.resources.wordsFont),this.registerFontChecker(e.display.resources.barNumberFont),this.registerFontChecker(e.display.resources.fretboardNumberFont),this.registerFontChecker(e.display.resources.subTitleFont)}registerFontChecker(e){var t;this._fontCheckers.has(e.families.join(", "))||(t=new Xs(e.families),this._fontCheckers.set(e.families.join(", "),t),t.fontLoaded.on(this.onFontLoaded.bind(this)),t.checkForFontAvailability())}destroy(){this.rootContainer.element.innerHTML=""}createCanvasElement(){var e=document.createElement("div");return e.className="at-surface",e.style.fontSize="0",e.style.overflow="hidden",e.style.lineHeight="0",e.style.position="relative",new Is(e)}triggerEvent(e,t,i=null,s){var a,e=e.element,r=(t="alphaTab."+t,document.createEvent("CustomEvent")),s=s?s.mouseEvent:null;r.initCustomEvent(t,!1,!1,i),s&&(r.originalEvent=s),e.dispatchEvent(r),window&&"jQuery"in window&&(r=window.jQuery,(a=[]).push(i),s&&a.push(s),r(e).trigger(t,a))}load(e,t,i){var s;return e instanceof Ge?(t(e),!0):e instanceof ArrayBuffer?(s=new Uint8Array(e),t(Ms.loadScoreFromBytes(s,this._api.settings)),!0):e instanceof Uint8Array?(t(Ms.loadScoreFromBytes(e,this._api.settings)),!0):"string"==typeof e&&(Ms.loadScoreAsync(e,t,i,this._api.settings),!0)}loadSoundFont(e,t){return!(!this._api.player||(e instanceof ArrayBuffer?(this._api.player.loadSoundFont(new Uint8Array(e),t),0):e instanceof Uint8Array?(this._api.player.loadSoundFont(e,t),0):"string"!=typeof e||(this._api.loadSoundFontFromUrl(e,t),0)))}initialRender(){this._api.renderer.preRender.on(e=>{this._totalResultCount=0,this._resultIdToElementLookup.clear(),this._barToElementLookup.clear()});var e=()=>{var e;this._api.renderer.width=0|this.rootContainer.width,this._api.renderer.updateSettings(this._api.settings),this._contents?(this._api.tex(this._contents,null!=(e=this._initialTrackIndexes)?e:void 0),this._initialTrackIndexes=null):this._file&&Ms.loadScoreAsync(this._file,e=>{this._api.renderScore(e,null!=(e=this._initialTrackIndexes)?e:void 0),this._initialTrackIndexes=null},e=>{this._api.onError(e)},this._api.settings)};this.rootContainer.isVisible?e():this.rootContainerBecameVisible.on(e)}createStyleElement(e){var t=this._api.container.element.ownerDocument;O.createStyleElement(t,e.core.fontDirectory)}parseTracks(t){if(!t)return[];var i=[];if("string"==typeof t)try{if("all"===t)return[-1];t=JSON.parse(t)}catch(e){t=[0]}if("number"==typeof t)i.push(t);else if("length"in t){var e=t.length,s=t;for(let t=0;t<e;t++){var a=s[t];let e=0;(0<=(e="number"==typeof a?a:"index"in a?a.index:parseInt(a.toString()))||-1===e)&&i.push(e)}}else"index"in t&&i.push(t.index);return i}getDataAttributes(){var s=new Map,i=this._api.container.element;if(i.dataset)for(var e of Object.keys(i.dataset)){let t=i.dataset[e];try{var a=t;t=JSON.parse(a)}catch(e){""===t&&(t=null)}s.set(e,t)}else for(let e=0;e<i.attributes.length;e++){var r=i.attributes.item(e),n=r.nodeName;if(n.startsWith("data-")){var o=n.substr(5).split("-");let t=o[0];for(let e=1;e<o.length;e++)t+=o[e].substr(0,1).toUpperCase()+o[e].substr(1);let i=r.nodeValue;try{i=JSON.parse(i)}catch(e){""===i&&(i=null)}s.set(t,i)}}return s}beginUpdateRenderResults(e){var t,i;this._resultIdToElementLookup.has(e.id)&&(t=this._resultIdToElementLookup.get(e.id),"string"==typeof(i=e.renderResult)?t.innerHTML=i:"nodeType"in i&&t.replaceChildren(i),t.resultState=As.RenderDone,t.renderedResultId=e.id,t.renderedResult=Array.from(t.children))}beginAppendRenderResults(i){var e=this._api.canvasElement.element;if(i){let t;this._totalResultCount<e.childElementCount?t=e.childNodes.item(this._totalResultCount):(t=document.createElement("div"),e.appendChild(t)),t.style.zIndex="1",t.style.position="absolute",t.style.left=i.x+"px",t.style.top=i.y+"px",t.style.width=i.width+"px",t.style.height=i.height+"px",t.style.display="inline-block",t.layoutResultId=i.id,t.resultState=As.LayoutDone,delete t.renderedResultId,delete t.renderedResult,this._resultIdToElementLookup.set(i.id,t);for(let e=i.firstMasterBarIndex;e<=i.lastMasterBarIndex;e++)0<=e&&this._barToElementLookup.set(e,t);this._api.settings.core.enableLazyLoading&&(this._intersectionObserver.unobserve(t),this._intersectionObserver.observe(t)),this._totalResultCount++}else for(;e.childElementCount>this._totalResultCount;)this._api.settings.core.enableLazyLoading&&this._intersectionObserver.unobserve(e.lastChild),e.removeChild(e.lastElementChild)}createWorkerPlayer(){var e=O.scriptFile;if(!e)return C.error("Player","alphaTab script file could not be detected, player cannot initialize"),null;let t=null;var i="ScriptProcessorNode"in window;return window.isSecureContext&&"AudioWorkletNode"in window&&!O.isWebPackBundled?(C.debug("Player","Will use webworkers for synthesizing and web audio api with worklets for playback"),t=new Qs(new ea,e,this._api.settings.core.logLevel,this._api.settings.player.bufferTimeInMilliseconds)):i&&(C.debug("Player","Will use webworkers for synthesizing and web audio api for playback"),t=new Qs(new Js,e,this._api.settings.core.logLevel,this._api.settings.player.bufferTimeInMilliseconds)),t?t.ready.on(()=>{this._api.settings.player.soundFont&&this._api.loadSoundFontFromUrl(this._api.settings.player.soundFont,!1)}):C.error("Player","Player requires webworkers and web audio api, browser unsupported",null),t}beginInvoke(e){window.requestAnimationFrame(()=>{e()})}highlightElements(e,t){t=this._barToElementLookup.get(t);if(t){var i=t.getElementsByClassName(e);for(let e=0;e<i.length;e++)i.item(e).classList.add("at-highlight"),this._highlightedElements.push(i.item(e))}}removeHighlights(){var e=this._highlightedElements;if(e){for(const t of e)t.classList.remove("at-highlight");this._highlightedElements=[]}}destroyCursors(){var e=this._api.container.element,t=e.querySelector(".at-cursors");e.removeChild(t)}createCursors(){var e=this._api.container.element,t=document.createElement("div"),i=(t.classList.add("at-cursors"),document.createElement("div")),s=(i.classList.add("at-selection"),this.createScalingElement()),a=this.createScalingElement(),r=s.element,n=(r.classList.add("at-cursor-bar"),a.element);return n.classList.add("at-cursor-beat"),e.style.position="relative",e.style.textAlign="left",t.style.position="absolute",t.style.zIndex="1000",t.style.display="inline",t.style.pointerEvents="none",i.style.position="absolute",r.style.position="absolute",r.style.left="0",r.style.top="0",r.style.willChange="transform",s.width=1,s.height=1,s.setBounds(0,0,1,1),n.style.position="absolute",n.style.transition="all 0s linear",n.style.left="0",n.style.top="0",n.style.willChange="transform",a.width=3,a.height=1,a.setBounds(0,0,1,1),e.insertBefore(t,e.firstChild),t.appendChild(i),t.appendChild(r),t.appendChild(n),new $s(new Is(t),s,a,new Is(i))}getOffset(e,t){var i,t=t.element,s=t.getBoundingClientRect();let a=s.top+t.ownerDocument.defaultView.pageYOffset,r=s.left+t.ownerDocument.defaultView.pageXOffset;e&&"html"!==(i=(t=e.element).nodeName.toLowerCase())&&"body"!==i&&(i=this.getOffset(null,e),a=a+t.scrollTop-i.y,r=r+t.scrollLeft-i.x);e=new Ze;return e.x=r,e.y=a,e.w=s.width,e.h=s.height,e}getScrollContainer(){if(!this._scrollContainer){let e="string"==typeof this._api.settings.player.scrollElement?document.querySelector(this._api.settings.player.scrollElement):this._api.settings.player.scrollElement;var t=e.nodeName.toLowerCase();"html"!==t&&"body"!==t||(e="scrollingElement"in document?document.scrollingElement:-1!==navigator.userAgent.indexOf("WebKit")?document.body:document.documentElement),this._scrollContainer=new Is(e)}return this._scrollContainer}createSelectionElement(){return this.createScalingElement()}createScalingElement(){var e=document.createElement("div"),e=(e.style.position="absolute",new ta(e,100,100));return e.width=1,e.height=1,e.setBounds(0,0,1,1),e}scrollToY(e,t,i){this.internalScrollToY(e.element,t,i)}scrollToX(e,t,i){this.internalScrollToX(e.element,t,i)}internalScrollToY(n,e,o){if(this._api.settings.player.nativeBrowserSmoothScroll)n.scrollTo({top:e,behavior:"smooth"});else{let i=n.scrollTop,s=e-i,a=0,r=e=>{var e=e-(a=0===a?e:a),t=Math.min(e/o,1);n.scrollTop=i+s*t|0,e<o&&window.requestAnimationFrame(r)};window.requestAnimationFrame(r)}}internalScrollToX(n,e,o){if(this._api.settings.player.nativeBrowserSmoothScroll)n.scrollTo({left:e,behavior:"smooth"});else{let i=n.scrollLeft,s=e-i,a=0,r=e=>{var e=e-(a=0===a?e:a),t=Math.min(e/o,1);n.scrollLeft=i+s*t|0,e<o&&window.requestAnimationFrame(r)};window.requestAnimationFrame(r)}}}class sa extends class{constructor(e,t){this._startTime=0,this._trackIndexes=null,this._isDestroyed=!1,this.score=null,this.tracks=[],this._tickCache=null,this.player=null,this._cursorWrapper=null,this._barCursor=null,this._beatCursor=null,this._selectionWrapper=null,this._previousTick=0,this._playerState=ne.Paused,this._currentBeat=null,this._currentBarBounds=null,this._previousStateForCursor=ne.Paused,this._previousCursorCache=null,this._lastScroll=0,this.playedBeatChanged=new li,this.activeBeatsChanged=new li,this._beatMouseDown=!1,this._noteMouseDown=!1,this._selectionStart=null,this._selectionEnd=null,this.beatMouseDown=new li,this.beatMouseMove=new li,this.beatMouseUp=new li,this.noteMouseDown=new li,this.noteMouseMove=new li,this.noteMouseUp=new li,this.scoreLoaded=new li,this.resize=new li,this.renderStarted=new li,this.renderFinished=new li,this.postRenderFinished=new hi,this.error=new li,this.playerReady=new hi,this.playerFinished=new hi,this.soundFontLoaded=new hi,this.midiLoad=new li,this.midiLoaded=new li,this.playerStateChanged=new li,this.playerPositionChanged=new li,this.midiEventsPlayed=new li,this.playbackRangeChanged=new li,this.settingsUpdated=new hi,this.uiFacade=e,this.container=e.rootContainer,e.initialize(this,t),C.logLevel=this.settings.core.logLevel,this.canvasElement=e.createCanvasElement(),this.container.appendChild(this.canvasElement),this.settings.core.useWorkers&&this.uiFacade.areWorkersSupported&&O.getRenderEngineFactory(this.settings.core.engine).supportsWorkers?this.renderer=this.uiFacade.createWorkerRenderer():this.renderer=new ds(this.settings),this.container.resize.on(O.throttle(()=>{this._isDestroyed||this.container.width!==this.renderer.width&&this.triggerResize()},e.resizeThrottle));t=new Es;t.oldWidth=this.renderer.width,t.newWidth=0|this.container.width,t.settings=this.settings,this.onResize(t),this.renderer.preRender.on(this.onRenderStarted.bind(this)),this.renderer.renderFinished.on(e=>{this.onRenderFinished(e)}),this.renderer.postRenderFinished.on(()=>{var e=Date.now()-this._startTime;C.debug("rendering","Rendering completed in "+e+"ms"),this.onPostRenderFinished()}),this.renderer.preRender.on(e=>{this._startTime=Date.now()}),this.renderer.partialLayoutFinished.on(this.appendRenderResult.bind(this)),this.renderer.partialRenderFinished.on(this.updateRenderResult.bind(this)),this.renderer.renderFinished.on(e=>{this.appendRenderResult(e),this.appendRenderResult(null)}),this.renderer.error.on(this.onError.bind(this)),this.settings.player.enablePlayer&&this.setupPlayer(),this.setupClickHandling(),this.uiFacade.beginInvoke(()=>{this.uiFacade.initialRender()})}destroy(){this._isDestroyed=!0,this.player&&this.player.destroy(),this.uiFacade.destroy(),this.renderer.destroy()}updateSettings(){var e=this.score;e&&Be.applyPitchOffsets(this.settings,e),this.renderer.updateSettings(this.settings),this.settings.player.enablePlayer?this.setupPlayer():this.destroyPlayer(),this.onSettingsUpdated()}load(e,t){try{return this.uiFacade.load(e,e=>{this.renderScore(e,t)},e=>{this.onError(e)})}catch(e){return this.onError(e),!1}}renderScore(e,t){var i=[];if(t)if(0===t.length)0<e.tracks.length&&i.push(e.tracks[0]);else if(1===t.length&&-1===t[0])for(var s of e.tracks)i.push(s);else for(var a of t)0<=a&&a<=e.tracks.length&&i.push(e.tracks[a]);else 0<e.tracks.length&&i.push(e.tracks[0]);this.internalRenderTracks(e,i)}renderTracks(e){if(0<e.length){var t,i=e[0].score;for(t of e)if(t.score!==i)return void this.onError(new me(T.AlphaTabErrorType.General,"All rendered tracks must belong to the same score."));this.internalRenderTracks(i,e)}}internalRenderTracks(e,t){if(Be.applyPitchOffsets(this.settings,e),e!==this.score){this.score=e,this.tracks=t,this._trackIndexes=[];for(var i of t)this._trackIndexes.push(i.index);this.onScoreLoaded(e),this.loadMidiForScore()}else{this.tracks=t,this._trackIndexes=[];for(var s of t)this._trackIndexes.push(s.index)}this.render()}triggerResize(){var e;this.container.isVisible?((e=new Es).oldWidth=this.renderer.width,e.newWidth=this.container.width,e.settings=this.settings,this.onResize(e),this.renderer.updateSettings(this.settings),this.renderer.width=this.container.width,this.renderer.resizeRender()):(C.warning("Rendering","AlphaTab container was invisible while autosizing, waiting for element to become visible",null),this.uiFacade.rootContainerBecameVisible.on(()=>{C.debug("Rendering","AlphaTab container became visible, doing autosizing",null),this.triggerResize()}))}appendRenderResult(e){e&&(this.canvasElement.width=e.totalWidth,this.canvasElement.height=e.totalHeight,this._cursorWrapper)&&(this._cursorWrapper.width=e.totalWidth,this._cursorWrapper.height=e.totalHeight),this.uiFacade.beginAppendRenderResults(e)}updateRenderResult(e){e&&e.renderResult&&this.uiFacade.beginUpdateRenderResults(e)}tex(e,t){try{var i=new je,s=(i.logErrors=!0,i.initFromString(e,this.settings),i.readScore());this.renderScore(s,t)}catch(e){this.onError(e)}}loadSoundFont(e,t=!1){return!!this.player&&this.uiFacade.loadSoundFont(e,t)}resetSoundFonts(){this.player&&this.player.resetSoundFonts()}render(){this.renderer&&(this.uiFacade.canRender?(this.renderer.width=this.container.width,this.renderer.renderScore(this.score,this._trackIndexes)):this.uiFacade.canRenderChanged.on(()=>this.render()))}get tickCache(){return this._tickCache}get isReadyForPlayback(){return!!this.player&&this.player.isReadyForPlayback}get playerState(){return this.player?this.player.state:ne.Paused}get masterVolume(){return this.player?this.player.masterVolume:0}set masterVolume(e){this.player&&(this.player.masterVolume=e)}get metronomeVolume(){return this.player?this.player.metronomeVolume:0}set metronomeVolume(e){this.player&&(this.player.metronomeVolume=e)}get countInVolume(){return this.player?this.player.countInVolume:0}set countInVolume(e){this.player&&(this.player.countInVolume=e)}get midiEventsPlayedFilter(){return this.player?this.player.midiEventsPlayedFilter:[]}set midiEventsPlayedFilter(e){this.player&&(this.player.midiEventsPlayedFilter=e)}get tickPosition(){return this.player?this.player.tickPosition:0}set tickPosition(e){this.player&&(this.player.tickPosition=e)}get timePosition(){return this.player?this.player.timePosition:0}set timePosition(e){this.player&&(this.player.timePosition=e)}get playbackRange(){return this.player?this.player.playbackRange:null}set playbackRange(e){this.player&&(this.player.playbackRange=e,this.settings.player.enableCursor)&&this.updateSelectionCursor(e)}get playbackSpeed(){return this.player?this.player.playbackSpeed:0}set playbackSpeed(e){this.player&&(this.player.playbackSpeed=e)}get isLooping(){return!!this.player&&this.player.isLooping}set isLooping(e){this.player&&(this.player.isLooping=e)}destroyPlayer(){this.player&&(this.player.destroy(),this.player=null,this._previousTick=0,this._playerState=ne.Paused,this.destroyCursors())}setupPlayer(){this.updateCursors(),this.player||(this.player=this.uiFacade.createWorkerPlayer(),this.player&&(this.player.ready.on(()=>{this.loadMidiForScore()}),this.player.readyForPlayback.on(()=>{if(this.onPlayerReady(),this.tracks)for(var e of this.tracks){var t=e.playbackInfo.volume/16;this.player.setChannelVolume(e.playbackInfo.primaryChannel,t),this.player.setChannelVolume(e.playbackInfo.secondaryChannel,t)}}),this.player.soundFontLoaded.on(this.onSoundFontLoaded.bind(this)),this.player.soundFontLoadFailed.on(e=>{this.onError(e)}),this.player.midiLoaded.on(this.onMidiLoaded.bind(this)),this.player.midiLoadFailed.on(e=>{this.onError(e)}),this.player.stateChanged.on(this.onPlayerStateChanged.bind(this)),this.player.positionChanged.on(this.onPlayerPositionChanged.bind(this)),this.player.midiEventsPlayed.on(this.onMidiEventsPlayed.bind(this)),this.player.playbackRangeChanged.on(this.onPlaybackRangeChanged.bind(this)),this.player.finished.on(this.onPlayerFinished.bind(this)),this.setupPlayerEvents()))}loadMidiForScore(){var e,t;this.player&&this.score&&this.player.isReady&&(C.debug("AlphaTab","Generating Midi"),e=new pi,t=new ps(e),(t=new vs(this.score,this.settings,t)).generate(),this._tickCache=t.tickLookup,this.onMidiLoad(e),this.player.loadMidiFile(e))}changeTrackVolume(e,t){if(this.player)for(var i of e)this.player.setChannelVolume(i.playbackInfo.primaryChannel,t),this.player.setChannelVolume(i.playbackInfo.secondaryChannel,t)}changeTrackSolo(e,t){if(this.player)for(var i of e)this.player.setChannelSolo(i.playbackInfo.primaryChannel,t),this.player.setChannelSolo(i.playbackInfo.secondaryChannel,t)}changeTrackMute(e,t){if(this.player)for(var i of e)this.player.setChannelMute(i.playbackInfo.primaryChannel,t),this.player.setChannelMute(i.playbackInfo.secondaryChannel,t)}play(){return!!this.player&&this.player.play()}pause(){this.player&&this.player.pause()}playPause(){this.player&&this.player.playPause()}stop(){this.player&&this.player.stop()}playBeat(e){var t,i;this.player&&(t=new pi,i=new ps(t),new vs(e.voice.bar.staff.track.score,this.settings,i).generateSingleBeat(e),this.player.playOneTimeMidiFile(t))}playNote(e){var t,i;this.player&&(t=new pi,i=new ps(t),new vs(e.beat.voice.bar.staff.track.score,this.settings,i).generateSingleNote(e),this.player.playOneTimeMidiFile(t))}destroyCursors(){this._cursorWrapper&&(this.uiFacade.destroyCursors(),this._cursorWrapper=null,this._barCursor=null,this._beatCursor=null,this._selectionWrapper=null)}updateCursors(){var e;this.settings.player.enableCursor&&!this._cursorWrapper?((e=this.uiFacade.createCursors())&&(this._cursorWrapper=e.cursorWrapper,this._barCursor=e.barCursor,this._beatCursor=e.beatCursor,this._selectionWrapper=e.selectionWrapper),null!==this._currentBeat&&this.cursorUpdateBeat(this._currentBeat,!1,10<this._previousTick,!0)):!this.settings.player.enableCursor&&this._cursorWrapper&&this.destroyCursors()}setupPlayerEvents(){this._previousTick=0,this._playerState=ne.Paused,this.renderer.postRenderFinished.on(()=>{this._currentBeat=null,this.cursorUpdateTick(this._previousTick,!1,10<this._previousTick)}),this.player&&(this.player.positionChanged.on(e=>{this._previousTick=e.currentTick,this.uiFacade.beginInvoke(()=>{this.cursorUpdateTick(e.currentTick,!1)})}),this.player.stateChanged.on(e=>{var t;this._playerState=e.state,e.stopped||e.state!==ne.Paused||(e=this._currentBeat,t=this._tickCache,e&&t&&(this.player.tickPosition=t.getMasterBarStart(e.currentBeat.voice.bar.masterBar)+e.currentBeat.playbackStart))}))}cursorUpdateTick(e,t,i=!1){var s,a=this._tickCache;a&&0<(s=this.tracks).length&&(a=a.findBeat(s,e,this._currentBeat))&&this.cursorUpdateBeat(a,t,i)}cursorUpdateBeat(i,s,a,e=!1){const r=i.currentBeat,n=i.nextBeat,o=i.duration,h=i.beatsToHighlight;if(r){let t=this.renderer.boundsLookup;if(t){var l=this._currentBeat,d=this._previousCursorCache,c=this._previousStateForCursor;if(e||r!==(null==l?void 0:l.currentBeat)||t!==d||c!==this._playerState){let e=t.findBeat(r);e&&(this._currentBeat=i,this._previousCursorCache=t,this._previousStateForCursor=this._playerState,this.uiFacade.beginInvoke(()=>{this.internalCursorUpdateBeat(r,n,o,s,h,t,e,a)}))}}}}scrollToCursor(){var e=this._currentBarBounds;e&&this.internalScrollToCursor(e)}internalScrollToCursor(e){var t=this.uiFacade.getScrollContainer(),i=O.getLayoutEngineFactory(this.settings.display.layoutMode).vertical,s=this.settings.player.scrollMode;if(i){var a=e.realBounds.y+this.settings.player.scrollOffsetY;if(a!==this._lastScroll)switch(this._lastScroll=a,s){case T.ScrollMode.Continuous:var r=this.uiFacade.getOffset(t,this.container);this.uiFacade.scrollToY(t,r.y+a,this.settings.player.scrollSpeed);break;case T.ScrollMode.OffScreen:var r=t.scrollTop+this.uiFacade.getOffset(null,t).h;(e.visualBounds.y+e.visualBounds.h>=r||e.visualBounds.y<t.scrollTop)&&(r=e.realBounds.y+this.settings.player.scrollOffsetY,this.uiFacade.scrollToY(t,r,this.settings.player.scrollSpeed))}}else{i=e.visualBounds.x;if(i!==this._lastScroll)switch(this._lastScroll=i,s){case T.ScrollMode.Continuous:var n=e.realBounds.x+this.settings.player.scrollOffsetX;this._lastScroll=e.visualBounds.x,this.uiFacade.scrollToX(t,n,this.settings.player.scrollSpeed);break;case T.ScrollMode.OffScreen:var n=t.scrollLeft+this.uiFacade.getOffset(null,t).w;(e.visualBounds.x+e.visualBounds.w>=n||e.visualBounds.x<t.scrollLeft)&&(n=e.realBounds.x+this.settings.player.scrollOffsetX,this._lastScroll=e.visualBounds.x,this.uiFacade.scrollToX(t,n,this.settings.player.scrollSpeed))}}}internalCursorUpdateBeat(t,i,s,e,a,r,n,o){var h=this._barCursor;const l=this._beatCursor;var d=n.barBounds.masterBarBounds,c=d.visualBounds;this._currentBarBounds=d,h&&h.setBounds(c.x,c.y,c.w,c.h),l&&(this.settings.player.enableAnimatedBeatCursor&&l.stopAnimation(),l.setBounds(n.visualBounds.x,c.y,1,c.h)),this.settings.player.enableElementHighlighting&&this.uiFacade.removeHighlights();let u=!1;if(this._playerState===ne.Playing&&!e){if(this.settings.player.enableElementHighlighting)for(var p of a){p=Ps.getGroupId(p);this.uiFacade.highlightElements(p,t.voice.bar.index)}if(this.settings.player.enableAnimatedBeatCursor){let e=d.visualBounds.x+d.visualBounds.w;i&&(i.voice.bar.index===t.voice.bar.index&&i.index>t.index||i.voice.bar.index===t.voice.bar.index+1)&&(h=r.findBeat(i))&&h.barBounds.masterBarBounds.staveGroupBounds===d.staveGroupBounds&&(e=h.visualBounds.x),this.uiFacade.beginInvoke(()=>{l&&l.transitionToX(s/this.playbackSpeed,e)})}o=!e,u=!0}o&&!this._beatMouseDown&&this.settings.player.scrollMode!==T.ScrollMode.Off&&this.internalScrollToCursor(d),u&&(this.onPlayedBeatChanged(t),this.onActiveBeatsChanged(new Cs(a)))}onPlayedBeatChanged(e){this._isDestroyed||(this.playedBeatChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"playedBeatChanged",e))}onActiveBeatsChanged(e){this._isDestroyed||(this.activeBeatsChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"activeBeatsChanged",e))}onBeatMouseDown(e,t){this._isDestroyed||(this.settings.player.enablePlayer&&this.settings.player.enableCursor&&this.settings.player.enableUserInteraction&&(this._selectionStart=new Fs(t),this._selectionEnd=null),this._beatMouseDown=!0,this.beatMouseDown.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseDown",t,e))}onNoteMouseDown(e,t){this._isDestroyed||(this._noteMouseDown=!0,this.noteMouseDown.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseDown",t,e))}onBeatMouseMove(e,t){this._isDestroyed||(!this.settings.player.enableUserInteraction||this._selectionEnd&&this._selectionEnd.beat===t||(this._selectionEnd=new Fs(t),this.cursorSelectRange(this._selectionStart,this._selectionEnd)),this.beatMouseMove.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseMove",t,e))}onNoteMouseMove(e,t){this._isDestroyed||(this.noteMouseMove.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseMove",t,e))}onBeatMouseUp(e,t){var i,s,a;this._isDestroyed||(this.settings.player.enableUserInteraction&&(this._selectionEnd&&(s=this._selectionStart.beat.absolutePlaybackStart,this._selectionEnd.beat.absolutePlaybackStart<s)&&(s=this._selectionStart,this._selectionStart=this._selectionEnd,this._selectionEnd=s),this._selectionStart)&&this._tickCache&&(i=(s=this._tickCache).getMasterBarStart(this._selectionStart.beat.voice.bar.masterBar),this._currentBeat=null,this._playerState===ne.Paused&&this.cursorUpdateTick(this._selectionStart.beat.absolutePlaybackStart,!1),this.tickPosition=i+this._selectionStart.beat.playbackStart,this._selectionEnd&&this._selectionStart.beat!==this._selectionEnd.beat?(s=s.getMasterBarStart(this._selectionEnd.beat.voice.bar.masterBar),(a=new Bs).startTick=i+this._selectionStart.beat.playbackStart,a.endTick=s+this._selectionEnd.beat.playbackStart+this._selectionEnd.beat.playbackDuration-50,this.playbackRange=a):(this._selectionStart=null,this.playbackRange=null,this.cursorSelectRange(this._selectionStart,this._selectionEnd))),this.beatMouseUp.trigger(t),this.uiFacade.triggerEvent(this.container,"beatMouseUp",t,e),this._beatMouseDown=!1)}onNoteMouseUp(e,t){this._isDestroyed||(this.noteMouseUp.trigger(t),this.uiFacade.triggerEvent(this.container,"noteMouseUp",t,e),this._noteMouseDown=!1)}updateSelectionCursor(e){var t;this._tickCache&&(e?(t=this._tickCache.findBeat(this.tracks,e.startTick),e=this._tickCache.findBeat(this.tracks,e.endTick),t&&e&&(t=new Fs(t.currentBeat),e=new Fs(e.currentBeat),this.cursorSelectRange(t,e))):this.cursorSelectRange(null,null))}setupClickHandling(){this.canvasElement.mouseDown.on(e=>{var t,i,s,a;e.isLeftMouseButton&&(this.settings.player.enableUserInteraction&&e.preventDefault(),t=e.getX(this.canvasElement),i=e.getY(this.canvasElement),s=null!=(s=null==(s=this.renderer.boundsLookup)?void 0:s.getBeatAtPos(t,i))?s:null)&&(this.onBeatMouseDown(e,s),this.settings.core.includeNoteBounds)&&(a=null==(a=this.renderer.boundsLookup)?void 0:a.getNoteAtPos(s,t,i))&&this.onNoteMouseDown(e,a)}),this.canvasElement.mouseMove.on(e=>{var t,i,s,a;this._beatMouseDown&&(t=e.getX(this.canvasElement),i=e.getY(this.canvasElement),s=null!=(s=null==(s=this.renderer.boundsLookup)?void 0:s.getBeatAtPos(t,i))?s:null)&&(this.onBeatMouseMove(e,s),this._noteMouseDown)&&(a=null==(a=this.renderer.boundsLookup)?void 0:a.getNoteAtPos(s,t,i))&&this.onNoteMouseMove(e,a)}),this.canvasElement.mouseUp.on(e=>{var t,i,s,a;this._beatMouseDown&&(this.settings.player.enableUserInteraction&&e.preventDefault(),i=e.getX(this.canvasElement),s=e.getY(this.canvasElement),a=null!=(a=null==(a=this.renderer.boundsLookup)?void 0:a.getBeatAtPos(i,s))?a:null,this.onBeatMouseUp(e,a),this._noteMouseDown)&&(a?(a=null!=(t=null==(t=this.renderer.boundsLookup)?void 0:t.getNoteAtPos(a,i,s))?t:null,this.onNoteMouseUp(e,a)):this.onNoteMouseUp(e,null))}),this.renderer.postRenderFinished.on(()=>{this._selectionStart&&this.settings.player.enablePlayer&&this.settings.player.enableCursor&&this.settings.player.enableUserInteraction&&this.cursorSelectRange(this._selectionStart,this._selectionEnd)})}cursorSelectRange(t,i){var s=this.renderer.boundsLookup;if(s){var a=this._selectionWrapper;if(a&&(a.clear(),t)&&i&&t.beat!==i.beat){t.bounds||(t.bounds=s.findBeat(t.beat)),i.bounds||(i.bounds=s.findBeat(i.beat));var r=t.beat.absolutePlaybackStart,r=(i.beat.absolutePlaybackStart<r&&(r=t,t=i,i=r),t.bounds.realBounds.x);let e=i.bounds.realBounds.x+i.bounds.realBounds.w;if(i.beat.index===i.beat.voice.beats.length-1&&(e=i.bounds.barBounds.masterBarBounds.realBounds.x+i.bounds.barBounds.masterBarBounds.realBounds.w),t.bounds.barBounds.masterBarBounds.staveGroupBounds!==i.bounds.barBounds.masterBarBounds.staveGroupBounds){var n=t.bounds.barBounds.masterBarBounds.staveGroupBounds.visualBounds.x,o=t.bounds.barBounds.masterBarBounds.staveGroupBounds.visualBounds.x+t.bounds.barBounds.masterBarBounds.staveGroupBounds.visualBounds.w,h=this.uiFacade.createSelectionElement(),h=(h.setBounds(r,t.bounds.barBounds.masterBarBounds.visualBounds.y,o-r,t.bounds.barBounds.masterBarBounds.visualBounds.h),a.appendChild(h),t.bounds.barBounds.masterBarBounds.staveGroupBounds.index+1),l=i.bounds.barBounds.masterBarBounds.staveGroupBounds.index;for(let e=h;e<l;e++){var d=s.staveGroups[e],c=this.uiFacade.createSelectionElement();c.setBounds(n,d.visualBounds.y,o-n,d.visualBounds.h),a.appendChild(c)}h=this.uiFacade.createSelectionElement();h.setBounds(n,i.bounds.barBounds.masterBarBounds.visualBounds.y,e-n,i.bounds.barBounds.masterBarBounds.visualBounds.h),a.appendChild(h)}else{i=this.uiFacade.createSelectionElement();i.setBounds(r,t.bounds.barBounds.masterBarBounds.visualBounds.y,e-r,t.bounds.barBounds.masterBarBounds.visualBounds.h),a.appendChild(i)}}}}onScoreLoaded(e){this._isDestroyed||(this.scoreLoaded.trigger(e),this.uiFacade.triggerEvent(this.container,"scoreLoaded",e))}onResize(e){this._isDestroyed||(this.resize.trigger(e),this.uiFacade.triggerEvent(this.container,"resize",e))}onRenderStarted(e){this._isDestroyed||(this.renderStarted.trigger(e),this.uiFacade.triggerEvent(this.container,"renderStarted",e))}onRenderFinished(e){this._isDestroyed||(this.renderFinished.trigger(e),this.uiFacade.triggerEvent(this.container,"renderFinished",e))}onPostRenderFinished(){this._isDestroyed||(this.postRenderFinished.trigger(),this.uiFacade.triggerEvent(this.container,"postRenderFinished",null))}onError(e){this._isDestroyed||(C.error("API","An unexpected error occurred",e),this.error.trigger(e),this.uiFacade.triggerEvent(this.container,"error",e))}onPlayerReady(){this._isDestroyed||(this.playerReady.trigger(),this.uiFacade.triggerEvent(this.container,"playerReady",null))}onPlayerFinished(){this._isDestroyed||(this.playerFinished.trigger(),this.uiFacade.triggerEvent(this.container,"playerFinished",null))}onSoundFontLoaded(){this._isDestroyed||(this.soundFontLoaded.trigger(),this.uiFacade.triggerEvent(this.container,"soundFontLoaded",null))}onMidiLoad(e){this._isDestroyed||(this.midiLoad.trigger(e),this.uiFacade.triggerEvent(this.container,"midiLoad",e))}onMidiLoaded(e){this._isDestroyed||(this.midiLoaded.trigger(e),this.uiFacade.triggerEvent(this.container,"midiFileLoaded",e))}onPlayerStateChanged(e){this._isDestroyed||(this.playerStateChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"playerStateChanged",e))}onPlayerPositionChanged(e){this._isDestroyed||null!==this.score&&0<this.tracks.length&&(this.playerPositionChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"playerPositionChanged",e))}onMidiEventsPlayed(e){this._isDestroyed||(this.midiEventsPlayed.trigger(e),this.uiFacade.triggerEvent(this.container,"midiEventsPlayed",e))}onPlaybackRangeChanged(e){this._isDestroyed||(this.playbackRangeChanged.trigger(e),this.uiFacade.triggerEvent(this.container,"playbackRangeChanged",e))}onSettingsUpdated(){this._isDestroyed||(this.settingsUpdated.trigger(),this.uiFacade.triggerEvent(this.container,"settingsUpdated",null))}}{constructor(e,t){super(new ia(e),t),this.soundFontLoad=new li}tex(e,t){var i=this.uiFacade;super.tex(e,i.parseTracks(t))}print(e,t=null){let i=window.open("","","width=0,height=0");var s=i.document.createElement("div"),e=(e?s.style.width=e:this.settings.display.layoutMode===T.LayoutMode.Horizontal?s.style.width="297mm":s.style.width="210mm",i.document.write(`
        <!DOCTYPE html>
        <html>
          <head>
            <style>
            .at-surface {
                width: auto !important;
                height: auto !important;
            }
            .at-surface > div {
                position: relative!important;
                left: auto !important;
                top: auto !important;
                break-inside: avoid;
            }
            </style>
          </head>
          <body></body>
        </html>
        `),this.score),e=(e&&(e.artist&&e.title?i.document.title=e.title+" - "+e.artist:e.title&&(i.document.title=""+e.title)),i.document.body.appendChild(s),void 0!==window.screenLeft?window.screenLeft:window.left),a=void 0!==window.screenTop?window.screenTop:window.top,r="innerWidth"in window?window.innerWidth:"clientWidth"in document.documentElement?document.documentElement.clientWidth:window.screen.width,n="innerHeight"in window?window.innerHeight:"clientHeight"in document.documentElement?document.documentElement.clientHeight:window.screen.height,o=s.offsetWidth+50,h=window.innerHeight,r=(r/2|0)-(o/2|0)+e,e=(n/2|0)-(h/2|0)+a,n=(i.resizeTo(o,h),i.moveTo(r,e),i.focus(),Zi.jsObjectToSettings(Zi.settingsToJsObject(this.settings)));n.core.enableLazyLoading=!1,n.core.useWorkers=!0,n.core.file=null,n.core.tracks=null,n.player.enableCursor=!1,n.player.enablePlayer=!1,n.player.enableElementHighlighting=!1,n.player.enableUserInteraction=!1,n.player.soundFont=null,n.display.scale=.8,n.display.stretchForce=.8,Mi.fromJson(n,t);let l=new sa(s,n);i.onunload=()=>{l.destroy()},l.renderer.postRenderFinished.on(()=>{i.print()}),l.renderTracks(this.tracks)}downloadMidi(){var e,t,i;this.score&&(t=new pi,i=new ps(t),new vs(this.score,this.settings,i).generate(),i=t.toBinary(),t=this.score.title?this.score.title+".mid":"File.mid",(e=document.createElement("a")).download=t,t=new Blob([i],{type:"audio/midi"}),i=URL.createObjectURL(t),e.href=i,e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e))}changeTrackMute(e,t){e=this.trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackMute(e,t)}changeTrackSolo(e,t){e=this.trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackSolo(e,t)}changeTrackVolume(e,t){e=this.trackIndexesToTracks(this.uiFacade.parseTracks(e));super.changeTrackVolume(e,t)}trackIndexesToTracks(e){if(!this.score)return[];var t=[];if(1===e.length&&-1===e[0])for(var i of this.score.tracks)t.push(i);else for(var s of e)0<=s&&s<this.score.tracks.length&&t.push(this.score.tracks[s]);return t}loadSoundFontFromUrl(e,t){this.player&&this.player.loadSoundFontFromUrl(e,t,e=>{this.soundFontLoad.trigger(e),this.uiFacade.triggerEvent(this.container,"soundFontLoad",e)})}}class aa{constructor(){this._initListeners=[]}exec(e,t,i){if("string"!=typeof t&&(i=[t],t="init"),95===t.charCodeAt(0)||"exec"===t)return null;var s,e=new jQuery(e),a=e.data("alphaTab");if("destroy"===t&&!a)return null;if("init"===t||a)return(s=this[t])?(e=[e,a].concat(i),s.apply(this,e)):(C.error("Api","Method '"+t+"' does not exist on jQuery.alphaTab"),null);throw new Error("alphaTab not initialized")}init(e,t,i){if(!t){t=new sa(e[0],i),e.data("alphaTab",t);for(var s of this._initListeners)s(e,t,i)}}destroy(e,t){e.removeData("alphaTab"),t.destroy()}print(e,t,i,s){t.print(i,s)}load(e,t,i,s){return t.load(i,s)}render(e,t){t.render()}renderScore(e,t,i,s){t.renderScore(i,s)}renderTracks(e,t,i){t.renderTracks(i)}invalidate(e,t){t.render()}tex(e,t,i,s){t.tex(i,s)}muteTrack(e,t,i,s){t.changeTrackMute(i,s)}soloTrack(e,t,i,s){t.changeTrackSolo(i,s)}trackVolume(e,t,i,s){t.changeTrackVolume(i,s)}loadSoundFont(e,t,i,s){t.loadSoundFont(i,s)}resetSoundFonts(e,t){t.resetSoundFonts()}pause(e,t){t.pause()}play(e,t){return t.play()}playPause(e,t){t.playPause()}stop(e,t){t.stop()}api(e,t){return t}player(e,t){return t.player}isReadyForPlayback(e,t){return t.isReadyForPlayback}playerState(e,t){return t.playerState}masterVolume(e,t,i){return"number"==typeof i&&(t.masterVolume=i),t.masterVolume}metronomeVolume(e,t,i){return"number"==typeof i&&(t.metronomeVolume=i),t.metronomeVolume}countInVolume(e,t,i){return"number"==typeof i&&(t.countInVolume=i),t.countInVolume}midiEventsPlayedFilter(e,t,i){return Array.isArray(i)&&(t.midiEventsPlayedFilter=i),t.midiEventsPlayedFilter}playbackSpeed(e,t,i){return"number"==typeof i&&(t.playbackSpeed=i),t.playbackSpeed}tickPosition(e,t,i){return"number"==typeof i&&(t.tickPosition=i),t.tickPosition}timePosition(e,t,i){return"number"==typeof i&&(t.timePosition=i),t.timePosition}loop(e,t,i){return"boolean"==typeof i&&(t.isLooping=i),t.isLooping}renderer(e,t){return t.renderer}score(e,t){return t.score}settings(e,t){return t.settings}tracks(e,t){return t.tracks}_oninit(e){this._initListeners.push(e)}static restore(e){new jQuery(e).empty().removeData("alphaTab")}}class ra{constructor(){this.buffer="",this._currentPath="",this._currentPathIsEmpty=!0,this.color=new We(255,255,255,255),this.lineWidth=1,this.font=new bi("Arial",10,de.Plain),this.textAlign=N.Left,this.textBaseline=P.Top}beginRender(e,t){this.buffer=`<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${0|e}px" height="${0|t}px" class="at-surface-svg">
`,this._currentPath="",this._currentPathIsEmpty=!0,this.textBaseline=P.Top}beginGroup(e){this.buffer+=`<g class="${e}">`}endGroup(){this.buffer+="</g>"}endRender(){return this.buffer+="</svg>",this.buffer}fillRect(e,t,i,s){0<i&&(this.buffer+=`<rect x="${0|e}" y="${0|t}" width="${i}" height="${s}" fill="${this.color.rgba}" />
`)}strokeRect(e,t,i,s){this.buffer+=`<rect x="${0|e}" y="${0|t}" width="${i}" height="${s}" stroke="${this.color.rgba}"`,1!==this.lineWidth&&(this.buffer+=` stroke-width="${this.lineWidth}"`),this.buffer+=' fill="transparent" />\n'}beginPath(){}closePath(){this._currentPath+=" z"}moveTo(e,t){this._currentPath+=` M${e},`+t}lineTo(e,t){this._currentPathIsEmpty=!1,this._currentPath+=` L${e},`+t}quadraticCurveTo(e,t,i,s){this._currentPathIsEmpty=!1,this._currentPath+=` Q${e},${t},${i},`+s}bezierCurveTo(e,t,i,s,a,r){this._currentPathIsEmpty=!1,this._currentPath+=` C${e},${t},${i},${s},${a},`+r}fillCircle(e,t,i){this._currentPathIsEmpty=!1,this._currentPath+=` M${e-i},${t} A1,1 0 0,0 ${e+i},${t} A1,1 0 0,0 ${e-i},${t} z`,this.fill()}strokeCircle(e,t,i){this._currentPathIsEmpty=!1,this._currentPath+=` M${e-i},${t} A1,1 0 0,0 ${e+i},${t} A1,1 0 0,0 ${e-i},${t} z`,this.stroke()}fill(){this._currentPathIsEmpty||(this.buffer+=`<path d="${this._currentPath}"`,"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),this.buffer+=' style="stroke: none"/>'),this._currentPath="",this._currentPathIsEmpty=!0}stroke(){if(!this._currentPathIsEmpty){let e=`<path d="${this._currentPath}" stroke="${this.color.rgba}"`;1!==this.lineWidth&&(e+=` stroke-width="${this.lineWidth}"`),e+=' style="fill: none" />',this.buffer+=e}this._currentPath="",this._currentPathIsEmpty=!0}fillText(t,i,s){if(""!==t){let e=`<text x="${0|i}" y="${0|s}" style="stroke: none; font:${this.font.toCssString(this.settings.display.scale)}" `+this.getSvgBaseLine();"#000000"!==this.color.rgba&&(e+=` fill="${this.color.rgba}"`),this.textAlign!==N.Left&&(e+=` text-anchor="${this.getSvgTextAlignment(this.textAlign)}"`),e+=`>${ra.escapeText(t)}</text>`,this.buffer+=e}}static escapeText(e){return e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}getSvgTextAlignment(e){switch(e){case N.Left:return"start";case N.Center:return"middle";case N.Right:return"end"}return""}getSvgBaseLine(){switch(this.textBaseline){case P.Top:return'dominant-baseline="hanging"';case P.Bottom:return'dominant-baseline="bottom"';default:return""}}measureText(e){return e?is.measureString(e,this.font.families,this.font.size,this.font.style,this.font.weight):0}onRenderFinished(){return null}beginRotate(e,t,i){this.buffer+='<g transform="translate('+e+" ,"+t+") rotate( "+i+')">'}endRotate(){this.buffer+="</g>"}}class na extends ra{constructor(){super()}fillMusicFontSymbol(e,t,i,s,a){s!==k.None&&this.fillMusicFontSymbolText(e,t,i,`&#${s};`,a)}fillMusicFontSymbols(e,t,i,s,a){let r="";for(var n of s)n!==k.None&&(r+=`&#${n};`);this.fillMusicFontSymbolText(e,t,i,r,a)}fillMusicFontSymbolText(e,t,i,s,a){this.buffer+=`<g transform="translate(${e} ${t})" class="at" ><text`,this.buffer+=1!==i?` style="font-size: ${100*i}%; stroke:none"`:' style="stroke:none"',"#000000"!==this.color.rgba&&(this.buffer+=` fill="${this.color.rgba}"`),a&&(this.buffer+=' text-anchor="'+this.getSvgTextAlignment(N.Center)+'"'),this.buffer+=`>${s}</text></g>`}}class oa{constructor(){this.isInAccolade=!0,this.isRelevantForBoundsLookup=!0,this.hideOnMultiTrack=!1,this.hideOnPercussionTrack=!1}canCreate(e,t){return!this.hideOnPercussionTrack||!t.isPercussion}}(e=Os=Os||{})[e.PreNotes=0]="PreNotes",e[e.OnNotes=1]="OnNotes",e[e.MiddleNotes=2]="MiddleNotes",e[e.Stem=3]="Stem",e[e.PostNotes=4]="PostNotes",e[e.EndBeat=5]="EndBeat";class ha extends Ts{constructor(e,t){super(e,t),this.glyphs=null}get isEmpty(){return!this.glyphs||0===this.glyphs.length}doLayout(){if(this.glyphs&&0!==this.glyphs.length){let i=0;for(let e=0,t=this.glyphs.length;e<t;e++){var s=this.glyphs[e];s.renderer=this.renderer,s.doLayout(),i=Math.max(i,s.width)}this.width=i}else this.width=0}addGlyph(e){this.glyphs||(this.glyphs=[]),this.renderer&&(e.renderer=this.renderer),this.glyphs.push(e)}paint(e,t,i){var s=this.glyphs;if(s&&0!==s.length)for(var a of s)a.paint(e+this.x,t+this.y,i)}}class la extends ha{constructor(){super(0,0),this.glyphs=[]}addGlyph(e){e.x=0===this.glyphs.length?0:this.glyphs[this.glyphs.length-1].x+this.glyphs[this.glyphs.length-1].width,e.renderer=this.renderer,e.doLayout(),this.width=e.x+e.width,super.addGlyph(e)}}class da extends ha{constructor(e,t,i){super(e,t),this.voice=i,this.beatGlyphs=[],this.tupletGroups=[]}scaleToWidth(e){var t=this.renderer.scale,e=this.renderer.layoutingInfo.spaceToForce(e/t);this.scaleToForce(e)}scaleToForce(e){var i=this.renderer.scale,s=(this.width=this.renderer.layoutingInfo.calculateVoiceWidth(e)*i,this.renderer.layoutingInfo.buildOnTimePositions(e)),a=this.beatGlyphs;for(let e=0,t=a.length;e<t;e++){var r,n,o,h=a[e];h.beat.graceType===_.None?h.x=s.get(h.beat.absoluteDisplayStart)*i-h.onTimeX:(o=h.beat.graceGroup.beats[0].absoluteDisplayStart,n=h.beat.graceGroup.id,h.beat.graceGroup.isComplete&&s.has(o)?(h.x=s.get(o)*i-h.onTimeX,r=this.renderer.layoutingInfo.allGraceRods.get(n),o=this.renderer.layoutingInfo.springs.get(o).preBeatWidth,h.x-=o,h.x-=r[h.beat.graceIndex].postSpringWidth,h.x+=r[h.beat.graceIndex].graceBeatWidth,o=r[h.beat.graceGroup.beats.length-1],h.x-=o.graceBeatWidth):(o=(r=this.renderer.layoutingInfo.incompleteGraceRods.get(n))[h.beat.graceIndex].postSpringWidth-r[h.beat.graceIndex].preSpringWidth,0<e?0===h.beat.graceIndex?h.x=a[e-1].x+a[e-1].width:h.x=a[e-1].x+r[h.beat.graceIndex-1].postSpringWidth-r[h.beat.graceIndex-1].preSpringWidth-o:h.x=-o)),0<e&&(n=h.x-a[e-1].x,a[e-1].scaleToWidth(n)),e===t-1&&(o=this.width-a[a.length-1].x,h.scaleToWidth(o))}}registerLayoutingInfo(e){var t;e.updateVoiceSize(this.width);for(t of this.beatGlyphs)t.registerLayoutingInfo(e)}applyLayoutingInfo(e){var t;for(t of this.beatGlyphs)t.applyLayoutingInfo(e);this.scaleToForce(Math.max(this.renderer.settings.display.stretchForce,e.minStretchForce))}addGlyph(e){var t=e;e.x=0===this.beatGlyphs.length?0:this.beatGlyphs[this.beatGlyphs.length-1].x+this.beatGlyphs[this.beatGlyphs.length-1].width,e.renderer=this.renderer,e.doLayout(),this.beatGlyphs.push(t),this.width=e.x+e.width,t.beat.hasTuplet&&t.beat.tupletGroup.beats[0].id===t.beat.id&&this.tupletGroups.push(t.beat.tupletGroup)}doLayout(){}paint(i,s,a){a.color=0===this.voice.index?this.renderer.resources.mainGlyphColor:this.renderer.resources.secondaryGlyphColor;for(let e=0,t=this.beatGlyphs.length;e<t;e++)this.beatGlyphs[e].paint(i+this.x,s+this.y,a)}}da.KeySizeBeat="Beat",(e=Gs=Gs||{})[e.None=0]="None",e[e.Natural=1]="Natural",e[e.Sharp=2]="Sharp",e[e.Flat=3]="Flat",e[e.NaturalQuarterNoteUp=4]="NaturalQuarterNoteUp",e[e.SharpQuarterNoteUp=5]="SharpQuarterNoteUp",e[e.FlatQuarterNoteUp=6]="FlatQuarterNoteUp",e[e.DoubleSharp=7]="DoubleSharp",e[e.DoubleFlat=8]="DoubleFlat";class ca{constructor(){this.maxLine=-1e3,this.minLine=-1e3}}class ua{constructor(e){this._registeredAccidentals=new Map,this._appliedScoreLines=new Map,this._appliedScoreLinesByValue=new Map,this._notesByValue=new Map,this._beatLines=new Map,this.maxLineBeat=null,this.minLineBeat=null,this.maxLine=-1e3,this.minLine=-1e3,this._barRenderer=e,this._bar=e.bar}static getPercussionLine(e,t){return t<e.staff.track.percussionArticulations.length?e.staff.track.percussionArticulations[t].staffLine:null!=(t=null==(e=Te.getArticulationByValue(t))?void 0:e.staffLine)?t:0}static getNoteValue(e){if(e.isPercussion)return e.percussionArticulation;let t=e.displayValue;switch(e.accidentalMode){case Y.ForceDoubleFlat:t+=2;break;case Y.ForceDoubleSharp:t-=2;break;case Y.ForceFlat:t+=1;break;case Y.ForceSharp:--t}return t}applyAccidental(e){var t=ua.getNoteValue(e),i=e.hasQuarterToneOffset;return this.getAccidental(t,i,e.beat,!1,e)}applyAccidentalForValue(e,t,i,s){return this.getAccidental(t,i,e,s,null)}static computeLineWithoutAccidentals(e,t){let i=0;var s=ua.getNoteValue(t);return i=e.staff.isPercussion?ua.getPercussionLine(e,s):(t=t?t.accidentalMode:Y.Default,ua.calculateNoteLine(e,s,t))}getAccidental(e,t,i,s,a=null){let r=Gs.None,n=0;if(this._bar.staff.isPercussion)n=ua.getPercussionLine(this._bar,e);else{var o=a?a.accidentalMode:Y.Default,h=(n=ua.calculateNoteLine(this._bar,e,o),this._bar.masterBar.keySignature),h=h+7,l=e%12,d=h<7?Gs.Flat:Gs.Sharp,c=ua.KeySignatureLookup[h][l],u=ua.AccidentalNotes[l];if(t)switch(r=u?d:Gs.Natural){case Gs.Natural:r=Gs.NaturalQuarterNoteUp;break;case Gs.Sharp:r=Gs.SharpQuarterNoteUp;break;case Gs.Flat:r=Gs.FlatQuarterNoteUp}else{switch(o){case Y.ForceSharp:r=Gs.Sharp;break;case Y.ForceDoubleSharp:r=Gs.DoubleSharp;break;case Y.ForceFlat:r=Gs.Flat;break;case Y.ForceDoubleFlat:r=Gs.DoubleFlat;break;default:u?r=d:c&&(r=Gs.Natural)}let e=!1;(e=a&&a.isTieDestination&&0===a.beat.index&&(h=this._barRenderer.previousRenderer)&&h.accidentalHelper.getNoteLine(a.tieOrigin)===n?!0:e)?r=Gs.None:r!==Gs.None?(this._registeredAccidentals.has(n)?this._registeredAccidentals.get(n)===r&&(r=Gs.None):c&&r===d&&(r=Gs.None),r!==Gs.None&&this._registeredAccidentals.set(n,r)):this._registeredAccidentals.has(n)?this._registeredAccidentals.get(n)===Gs.Natural?r=Gs.None:(r=Gs.Natural,this._registeredAccidentals.set(n,r)):this._registeredAccidentals.delete(n)}}return a?(this._appliedScoreLines.set(a.id,n),this._notesByValue.set(e,a)):this._appliedScoreLinesByValue.set(e,n),(-1e3===this.minLine||this.minLine<n)&&(this.minLine=n,this.minLineBeat=i),(-1e3===this.maxLine||this.maxLine>n)&&(this.maxLine=n,this.maxLineBeat=i),s||this.registerLine(i,n),r}registerLine(e,t){let i;this._beatLines.has(e.id)?i=this._beatLines.get(e.id):(i=new ca,this._beatLines.set(e.id,i)),(-1e3===i.minLine||t<i.minLine)&&(i.minLine=t),(-1e3===i.minLine||t>i.maxLine)&&(i.maxLine=t)}getMaxLine(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).maxLine:0}getMinLine(e){return this._beatLines.has(e.id)?this._beatLines.get(e.id).minLine:0}static calculateNoteLine(e,t,i){var s=e.masterBar.keySignature,e=e.clef,a=t%12,t=(t/12|0)-1,e=ua.OctaveSteps[e],t=(e-=t*ua.StepsPerOctave,Be.keySignatureIsSharp(s)||Be.keySignatureIsNatural(s)?ua.SharpNoteSteps:ua.FlatNoteSteps);return e-=t[a]}getNoteLine(e){return this._appliedScoreLines.get(e.id)}getNoteLineForValue(e,t=!1){return this._appliedScoreLinesByValue.has(e)?this._appliedScoreLinesByValue.get(e):t&&this._notesByValue.has(e)?this.getNoteLine(this._notesByValue.get(e)):0}}ua.KeySignatureLookup=[[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0],[!0,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0],[!1,!0,!0,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!0,!0,!0,!0],[!1,!1,!1,!0,!0,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0],[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],[!1,!1,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!1,!1,!1,!1,!1],[!0,!0,!1,!1,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!1,!1,!1],[!0,!0,!0,!0,!1,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]],ua.AccidentalNotes=[!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!0,!1],ua.StepsPerOctave=7,ua.OctaveSteps=[38,32,30,26,38],ua.SharpNoteSteps=[0,0,1,1,2,3,3,4,4,5,5,6],ua.FlatNoteSteps=[0,1,1,2,2,3,4,4,5,5,6,6];class pa{constructor(){this.staffId="",this.up=0,this.down=0}}class ga{constructor(){this.startBeat=null,this.startX=0,this.startY=0,this.endBeat=null,this.endX=0,this.endY=0}calcY(e){return this.startX===this.endX?this.startY:(this.endY-this.startY)/(this.endX-this.startX)*(e-this.startX)+this.startY}}class ma{constructor(e,t){this._beatLineXPositions=new Map,this._firstNonRestBeat=null,this._lastNonRestBeat=null,this.voice=null,this.beats=[],this.shortestDuration=x.QuadrupleWhole,this.fingeringCount=0,this.hasTuplet=!1,this._firstBeatLowestNoteCompareValue=-1,this._firstBeatHighestNoteCompareValue=-1,this._lastBeatLowestNoteCompareValue=-1,this._lastBeatHighestNoteCompareValue=-1,this.lowestNoteInHelper=null,this._lowestNoteCompareValueInHelper=-1,this.highestNoteInHelper=null,this._highestNoteCompareValueInHelper=-1,this.invertBeamDirection=!1,this.preferredBeamDirection=null,this.isGrace=!1,this.minRestLine=null,this.beatOfMinRestLine=null,this.maxRestLine=null,this.beatOfMaxRestLine=null,this.direction=E.Up,this.drawingInfos=new Map,this._staff=e,this._renderer=t,this.beats=[]}get isRestBeamHelper(){return 1===this.beats.length&&this.beats[0].isRest}get hasLine(){return 1===this.beats.length&&this.beats[0].duration>x.Whole}get hasFlag(){return 1===this.beats.length&&!this.beats[0].isRest&&(this.beats[0].duration>x.Quarter||this.beats[0].graceType!==_.None)}getBeatLineX(e){return this.hasBeatLineX(e)?this.direction===E.Up?this._beatLineXPositions.get(e.index).up:this._beatLineXPositions.get(e.index).down:0}hasBeatLineX(e){return this._beatLineXPositions.has(e.index)}registerBeatLineX(e,t,i,s){var a=this.getOrCreateBeatPositions(t);a.staffId=e,a.up=i,a.down=s;for(const r of this.drawingInfos.values())r.startBeat==t?r.startX=this.getBeatLineX(t):r.endBeat==t&&(r.endX=this.getBeatLineX(t))}getOrCreateBeatPositions(e){return this._beatLineXPositions.has(e.index)||this._beatLineXPositions.set(e.index,new pa),this._beatLineXPositions.get(e.index)}finish(){this.direction=this.calculateDirection()}calculateDirection(){let e=null;var t,i;return this.voice?null!==this.preferredBeamDirection?e=this.preferredBeamDirection:0<this.voice.index?e=this.invert(E.Down):!this.voice.bar.isMultiVoice&&this.beats[0].graceType===_.None||(e=this.invert(E.Up)):e=E.Up,this.highestNoteInHelper&&this.lowestNoteInHelper?(t=this._renderer.getNoteY(this.highestNoteInHelper,A.Center),i=this._renderer.getNoteY(this.lowestNoteInHelper,A.Center),null===e&&(e=this.invert(this._renderer.middleYPosition<(t+i)/2?E.Up:E.Down))):e=this.invert(E.Up),this._renderer.completeBeamingHelper(this),e}static computeLineHeightsForRest(e){switch(e){case x.QuadrupleWhole:case x.DoubleWhole:return[2,2];case x.Whole:return[0,1];case x.Half:return[1,0];case x.Quarter:return[3,3];case x.Eighth:return[2,2];case x.Sixteenth:return[2,4];case x.ThirtySecond:return[4,4];case x.SixtyFourth:return[4,6];case x.OneHundredTwentyEighth:return[6,6];case x.TwoHundredFiftySixth:return[6,8]}return[0,0]}applyRest(e,t){var i,s,a;this._lastNonRestBeat&&e.index>=this._lastNonRestBeat.index||this._firstNonRestBeat&&e.index<=this._firstNonRestBeat.index||(i=t=t,t-=(s=ma.computeLineHeightsForRest(e.duration))[0],i+=s[1],s=this.minRestLine,a=this.maxRestLine,(null===s||t<s)&&(this.minRestLine=t,this.beatOfMinRestLine=e),(null===a||a<i)&&(this.maxRestLine=i,this.beatOfMaxRestLine=e))}invert(e){return this.invertBeamDirection?e!==E.Down?E.Down:E.Up:e}checkBeat(i){i.invertBeamDirection&&(this.invertBeamDirection=!0),this.voice||(this.voice=i.voice);let e=!1;if(0===this.beats.length)e=!0;else switch(this.beats[this.beats.length-1].beamingMode){case K.Auto:e=ma.canJoin(this.beats[this.beats.length-1],i);break;case K.ForceSplitToNext:e=!1;break;case K.ForceMergeWithNext:e=!0}if(e){if(null!==i.preferredBeamDirection&&(this.preferredBeamDirection=i.preferredBeamDirection),i.isRest)0===this.beats.length&&this.beats.push(i);else{this.isRestBeamHelper&&(this.beats=[]),this.beats.push(i),i.graceType!==_.None&&(this.isGrace=!0),i.hasTuplet&&(this.hasTuplet=!0);let t=0;for(let e=0;e<i.notes.length;e++){var s=i.notes[e];s.leftHandFinger===v.Unknown&&s.rightHandFinger===v.Unknown||t++}t>this.fingeringCount&&(this.fingeringCount=t),this.checkNote(i.minNote),this.checkNote(i.maxNote),this.shortestDuration<i.duration&&(this.shortestDuration=i.duration),this._firstNonRestBeat||(this._firstNonRestBeat=i),this._lastNonRestBeat=i}i.hasTuplet&&(this.hasTuplet=!0)}return e}checkNote(i){if(i){let e,t;this.voice&&i.isPercussion?(e=-ua.getPercussionLine(this.voice.bar,ua.getNoteValue(i)),t=e):(e=ua.getNoteValue(i),t=e,i.harmonicType!==g.None&&i.harmonicType!==g.Natural&&(t=i.realValue-this._staff.displayTranspositionPitch)),1===this.beats.length&&this.beats[0]===i.beat&&((-1===this._firstBeatLowestNoteCompareValue||e<this._firstBeatLowestNoteCompareValue)&&(this._firstBeatLowestNoteCompareValue=e),-1===this._firstBeatHighestNoteCompareValue||t>this._firstBeatHighestNoteCompareValue)&&(this._firstBeatHighestNoteCompareValue=t),(-1===this._lastBeatLowestNoteCompareValue||e<this._lastBeatLowestNoteCompareValue)&&(this._lastBeatLowestNoteCompareValue=e),(-1===this._lastBeatHighestNoteCompareValue||t>this._lastBeatHighestNoteCompareValue)&&(this._lastBeatHighestNoteCompareValue=t),(!this.lowestNoteInHelper||e<this._lowestNoteCompareValueInHelper)&&(this.lowestNoteInHelper=i,this._lowestNoteCompareValueInHelper=e),(!this.highestNoteInHelper||t>this._highestNoteCompareValueInHelper)&&(this.highestNoteInHelper=i,this._highestNoteCompareValueInHelper=t)}}static canJoin(e,t){if(!e||!t||e.graceType!==t.graceType||e.graceType===_.BendGrace||t.graceType===_.BendGrace)return!1;if(e.graceType!==_.None&&t.graceType!==_.None)return!0;var i=e.voice.bar;if(i!==t.voice.bar)return!1;var s=e.playbackStart,a=t.playbackStart;if(!ma.canJoinDuration(e.duration)||!ma.canJoinDuration(t.duration))return s===a;if(e.tupletGroup!==t.tupletGroup)return!1;if(e.hasTuplet&&t.hasTuplet&&e.tupletGroup===t.tupletGroup&&e.tupletGroup.isFull)return!0;let r=p.QuarterTime;return 8===i.masterBar.timeSignatureDenominator&&i.masterBar.timeSignatureNumerator%3==0&&(r+=p.QuarterTime/2|0),((r+s)/r|0)==((r+a)/r|0)}static canJoinDuration(e){switch(e){case x.Whole:case x.Half:case x.Quarter:return!1;default:return!0}}static isFullBarJoin(e,t,i){return 0<Be.getIndex(e.duration)-2-i&&0<Be.getIndex(t.duration)-2-i}get beatOfLowestNote(){return this.lowestNoteInHelper.beat}get beatOfHighestNote(){return this.highestNoteInHelper.beat}isPositionFrom(e,t){return!this._beatLineXPositions.has(t.index)||this._beatLineXPositions.get(t.index).staffId===e||!this._beatLineXPositions.get(t.index).staffId}}class fa{constructor(e,t){this.topY=0,this.bottomY=0,this.topY=e,this.bottomY=t}}class ya{constructor(e){this.topY=-1e3,this.bottomY=-1e3,this.slots=[],this.beat=e}addSlot(e,t){var i;this.slots.push(new fa(e,t)),-1e3===this.topY?(this.topY=e,this.bottomY=t):(i=Math.min(e,t),e=Math.max(e,t),i<this.topY&&(this.topY=i),e>this.bottomY&&(this.bottomY=e))}}class ba{constructor(){this.reservedLayoutAreasByDisplayTime=new Map,this.restDurationsByDisplayTime=new Map}getBeatMinMaxY(){let e=-1e3,t=-1e3;for(const i of this.reservedLayoutAreasByDisplayTime.values())-1e3===e?(e=i.topY,t=i.bottomY):(e>i.topY&&(e=i.topY),t<i.bottomY&&(t=i.bottomY));return-1e3===e?[0,0]:[e,t]}reserveBeatSlot(e,t,i){t!=i&&(this.reservedLayoutAreasByDisplayTime.has(e.displayStart)||this.reservedLayoutAreasByDisplayTime.set(e.displayStart,new ya(e)),this.reservedLayoutAreasByDisplayTime.get(e.displayStart).addSlot(t,i),e.isRest)&&this.registerRest(e)}registerRest(e){this.restDurationsByDisplayTime.has(e.displayStart)||this.restDurationsByDisplayTime.set(e.displayStart,new Map),this.restDurationsByDisplayTime.get(e.displayStart).has(e.playbackDuration)||this.restDurationsByDisplayTime.get(e.displayStart).set(e.playbackDuration,e.id)}applyRestCollisionOffset(i,s,a){if(0<i.voice.index&&this.reservedLayoutAreasByDisplayTime.has(i.playbackStart)){var r=ma.computeLineHeightsForRest(i.duration).map(e=>e*a),n=s-r[0],o=s+r[1];let e=n;var h,s=this.reservedLayoutAreasByDisplayTime.get(i.playbackStart);let t=!1;for(const l of s.slots)if(n>=l.topY&&n<=l.bottomY||o>=l.topY&&o<=l.bottomY){t=!0;break}if(t)return i=(e=1==i.voice.index?s.topY-r[1]-r[0]:s.bottomY)+r[0]+r[1],r=2*a,h=Math.ceil(Math.abs(e-n)/r),s.addSlot(e,i),e<n?h*-r:h*r}return 0}}class Sa{constructor(e){this.beamHelpers=[],this.beamHelperLookup=[],this._renderer=e,this.collisionHelper=new ba}initialize(){var i=this._renderer,s=this._renderer.bar;let a=null,r=null;for(let e=0,t=s.voices.length;e<t;e++){var n=s.voices[e];this.beamHelpers.push([]),this.beamHelperLookup.push(new Map);for(let t=0,e=n.beats.length;t<e;t++){var o=n.beats[t];let e;o.graceType!==_.None?e=r:(e=a,r=null),e&&e.checkBeat(o)||(e&&e.finish(),(e=new ma(s.staff,i)).checkBeat(o),o.graceType!==_.None?r=e:a=e,this.beamHelpers[n.index].push(e)),this.beamHelperLookup[n.index].set(o.index,e)}a&&a.finish(),r&&r.finish(),a=null,r=null}}getBeamingHelperForBeat(e){return this.beamHelperLookup[e.voice.index].get(e.index)}}(e=A=A||{})[e.TopWithStem=0]="TopWithStem",e[e.Top=1]="Top",e[e.Center=2]="Center",e[e.Bottom=3]="Bottom",e[e.BottomWithStem=4]="BottomWithStem",(e=Hs=Hs||{})[e.Left=0]="Left",e[e.Center=1]="Center",e[e.Right=2]="Right";class _a{constructor(e,t){this._preBeatGlyphs=new la,this._voiceContainers=new Map,this._postBeatGlyphs=new la,this._ties=[],this.x=0,this.y=0,this.width=0,this.height=0,this.index=0,this.topOverflow=0,this.bottomOverflow=0,this.isLinkedToPrevious=!1,this.canWrap=!0,this._wasFirstOfLine=!1,this._appliedLayoutingInfo=0,this.isFinalized=!1,this.topPadding=0,this.bottomPadding=0,this.scoreRenderer=e,(this.bar=t)&&(this.helpers=new Sa(this))}get nextRenderer(){return this.bar&&this.bar.nextBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staveId,this.bar.nextBar):null}get previousRenderer(){return this.bar&&this.bar.previousBar?this.scoreRenderer.layout.getRendererForBar(this.staff.staveId,this.bar.previousBar):null}registerTies(e){this._ties.push(...e)}get middleYPosition(){return 0}registerOverflowTop(e){return e>this.topOverflow&&(this.topOverflow=e,!0)}registerOverflowBottom(e){return e>this.bottomOverflow&&(this.bottomOverflow=e,!0)}scaleToWidth(e){var t=e-this._preBeatGlyphs.width-this._postBeatGlyphs.width;for(const i of this._voiceContainers.values())i.scaleToWidth(t);this._postBeatGlyphs.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width+t,this.width=e}get resources(){return this.settings.display.resources}get settings(){return this.scoreRenderer.settings}get scale(){return this.settings.display.scale}get isFirstOfLine(){return 0===this.index}get isLast(){return!this.bar||this.bar.index===this.scoreRenderer.layout.lastBarIndex}registerLayoutingInfo(){var e=this.layoutingInfo,t=this._preBeatGlyphs.width;e.preBeatSize<t&&(e.preBeatSize=t);for(const i of this._voiceContainers.values())i.registerLayoutingInfo(e);t=this._postBeatGlyphs.width;e.postBeatSize<t&&(e.postBeatSize=t)}applyLayoutingInfo(){if(this._appliedLayoutingInfo>=this.layoutingInfo.version)return!1;this._appliedLayoutingInfo=this.layoutingInfo.version,this._preBeatGlyphs.width=this.layoutingInfo.preBeatSize;let e=this._preBeatGlyphs.x+this._preBeatGlyphs.width;for(const i of this._voiceContainers.values()){i.x=this._preBeatGlyphs.x+this._preBeatGlyphs.width,i.applyLayoutingInfo(this.layoutingInfo);var t=i.x+i.width;e<t&&(e=t)}return this._postBeatGlyphs.x=Math.floor(e),this._postBeatGlyphs.width=this.layoutingInfo.postBeatSize,this.width=Math.ceil(this._postBeatGlyphs.x+this._postBeatGlyphs.width),!0}finalizeRenderer(){let e=!(this.isFinalized=!0);var t,i=this.y-this.staff.topSpacing,s=this.y+this.height+this.staff.bottomSpacing;for(const a of this._ties)a.doLayout(),0<a.height&&(0<(t=a.y+a.height-s)&&this.registerOverflowBottom(t)&&(e=!0),(t=a.y-i)<0)&&this.registerOverflowTop(-1*t)&&(e=!0);return e}doLayout(){if(this.bar){this.helpers.initialize(),this._ties=[],this._preBeatGlyphs=new la,(this._preBeatGlyphs.renderer=this)._voiceContainers.clear(),this._postBeatGlyphs=new la,this._postBeatGlyphs.renderer=this;for(let e=0;e<this.bar.voices.length;e++){var t=this.bar.voices[e];this.hasVoiceContainer(t)&&((t=new da(0,0,t)).renderer=this)._voiceContainers.set(this.bar.voices[e].index,t)}this.bar.simileMark===r.SecondOfDouble&&(this.canWrap=!1),this.createPreBeatGlyphs(),this.createBeatGlyphs(),this.createPostBeatGlyphs(),this.updateSizes();for(const e of this.helpers.beamHelpers)for(const i of e)i.finish()}}hasVoiceContainer(e){return!e.isEmpty||0===e.index}updateSizes(){this.staff.registerStaffTop(this.topPadding),this.staff.registerStaffBottom(this.height-this.bottomPadding);var e=this._voiceContainers,t=this.beatGlyphsStart;let i=t;for(const a of e.values()){a.x=t,a.doLayout();var s=a.x+a.width;i<s&&(i=s)}this._postBeatGlyphs.x=Math.floor(i),this.width=Math.ceil(this._postBeatGlyphs.x+this._postBeatGlyphs.width),this.height+=this.layoutingInfo.height*this.scale}addPreBeatGlyph(e){(e.renderer=this)._preBeatGlyphs.addGlyph(e)}addBeatGlyph(e){e.renderer=this,e.preNotes.renderer=this,e.onNotes.renderer=this,e.onNotes.beamingHelper=this.helpers.beamHelperLookup[e.beat.voice.index].get(e.beat.index),this.getVoiceContainer(e.beat.voice).addGlyph(e)}getVoiceContainer(e){return this._voiceContainers.has(e.index)?this._voiceContainers.get(e.index):void 0}getBeatContainer(e){var t;return null==(t=null==(t=this.getVoiceContainer(e.voice))?void 0:t.beatGlyphs)?void 0:t[e.index]}getPreNotesGlyphForBeat(e){return null==(e=this.getBeatContainer(e))?void 0:e.preNotes}getOnNotesGlyphForBeat(e){return null==(e=this.getBeatContainer(e))?void 0:e.onNotes}paint(e,t,i){this.paintBackground(e,t,i),i.color=this.resources.mainGlyphColor,this._preBeatGlyphs.paint(e+this.x,t+this.y,i);for(const s of this._voiceContainers.values())i.color=0===s.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,s.paint(e+this.x,t+this.y,i);i.color=this.resources.mainGlyphColor,this._postBeatGlyphs.paint(e+this.x,t+this.y,i)}paintBackground(e,t,i){this.layoutingInfo.paint(e+this.x+this._preBeatGlyphs.x+this._preBeatGlyphs.width,t+this.y+this.height,i)}buildBoundingsLookup(e,i,s){var t,a,r=new as;r.bar=this.bar,r.visualBounds=new Ze,r.visualBounds.x=i+this.x,r.visualBounds.y=s+this.y+this.topPadding,r.visualBounds.w=this.width,r.visualBounds.h=this.height-this.topPadding-this.bottomPadding,r.realBounds=new Ze,r.realBounds.x=i+this.x,r.realBounds.y=s+this.y,r.realBounds.w=this.width,r.realBounds.h=this.height,e.addBar(r);for([t,a]of this._voiceContainers){var n=this.bar.isEmpty&&0===t;if(!a.voice.isEmpty||n)for(let e=0,t=a.beatGlyphs.length;e<t;e++)a.beatGlyphs[e].buildBoundingsLookup(r,i+this.x+a.x,s+this.y+a.y,n)}}addPostBeatGlyph(e){this._postBeatGlyphs.addGlyph(e)}createPreBeatGlyphs(){this._wasFirstOfLine=this.isFirstOfLine}createBeatGlyphs(){for(let e=0;e<this.bar.voices.length;e++){var t=this.bar.voices[e];this.hasVoiceContainer(t)&&this.createVoiceGlyphs(this.bar.voices[e])}}createVoiceGlyphs(e){}createPostBeatGlyphs(){}get beatGlyphsStart(){return this._preBeatGlyphs.x+this._preBeatGlyphs.width}get postBeatGlyphsStart(){return this._postBeatGlyphs.x}getBeatX(e,t=Os.PreNotes){var i=this.getBeatContainer(e);if(i)switch(t){case Os.PreNotes:return i.voiceContainer.x+i.x;case Os.OnNotes:return i.voiceContainer.x+i.x+i.onNotes.x;case Os.MiddleNotes:return i.voiceContainer.x+i.x+i.onTimeX;case Os.Stem:var s=i.onNotes.beamingHelper?i.onNotes.beamingHelper.getBeatLineX(e):i.onNotes.x+i.onNotes.width/2;return i.voiceContainer.x+s;case Os.PostNotes:return i.voiceContainer.x+i.x+i.onNotes.x+i.onNotes.width;case Os.EndBeat:return i.voiceContainer.x+i.x+i.width}return 0}getNoteX(e,t){var i=this.getBeatContainer(e.beat);return i?i.voiceContainer.x+i.x+i.onNotes.x+i.onNotes.getNoteX(e,t):0}getNoteY(e,t){var i=this.getOnNotesGlyphForBeat(e.beat);return i?i.getNoteY(e,t):NaN}reLayout(){(this._wasFirstOfLine&&!this.isFirstOfLine||!this._wasFirstOfLine&&this.isFirstOfLine)&&(this._preBeatGlyphs=new la,(this._preBeatGlyphs.renderer=this).createPreBeatGlyphs()),this.updateSizes(),this.registerLayoutingInfo()}paintSimileMark(e,t,i){switch(this.bar.simileMark){case r.Simple:i.fillMusicFontSymbol(e+this.x+(this.width-20*this.scale)/2,t+this.y+this.height/2,1,k.Repeat1Bar,!1);break;case r.SecondOfDouble:i.fillMusicFontSymbol(e+this.x-28*this.scale/2,t+this.y+this.height/2,1,k.Repeat2Bars,!1)}}completeBeamingHelper(e){}}_a.LineSpacing=8,_a.StemWidth=.12*_a.LineSpacing,_a.StaffLineThickness=.13*_a.LineSpacing,_a.BeamThickness=.5*_a.LineSpacing,_a.BeamSpacing=.25*_a.LineSpacing,(e=Vs=Vs||{})[e.SinglePreBeat=0]="SinglePreBeat",e[e.SingleOnBeat=1]="SingleOnBeat",e[e.SingleOnBeatToEnd=2]="SingleOnBeatToEnd",e[e.GroupedOnBeat=3]="GroupedOnBeat",e[e.GroupedOnBeatToEnd=4]="GroupedOnBeatToEnd",e[e.FullBar=5]="FullBar";class wa extends Ts{constructor(e,t){super(0,0),this._uniqueEffectGlyphs=[],this._effectGlyphs=[],this.isEmpty=!0,this.previousBand=null,this.isLinkedToPrevious=!1,this.firstBeat=null,this.lastBeat=null,this.height=0,this.slot=null,this.voice=e,this.info=t}doLayout(){super.doLayout();for(let e=0;e<this.renderer.bar.voices.length;e++)this._effectGlyphs.push(new Map),this._uniqueEffectGlyphs.push([])}createGlyph(e){if(e.voice===this.voice&&this.info.shouldCreateGlyph(this.renderer.settings,e)&&(!this.info.hideOnMultiTrack||0===this.renderer.staff.trackIndex)){if(this.isEmpty=!1,this.firstBeat&&!e.isBefore(this.firstBeat)||(this.firstBeat=e),!this.lastBeat||e.isAfter(this.lastBeat))switch(this.lastBeat=e,this.info.sizingMode){case Vs.SingleOnBeatToEnd:case Vs.GroupedOnBeatToEnd:this.lastBeat.nextBeat&&(this.lastBeat=this.lastBeat.nextBeat)}e=this.createOrResizeGlyph(this.info.sizingMode,e);e.height>this.height&&(this.height=e.height)}}createOrResizeGlyph(e,t){let i;switch(e){case Vs.FullBar:return(i=this.info.createNewGlyph(this.renderer,t)).renderer=this.renderer,i.beat=t,i.doLayout(),this._effectGlyphs[t.voice.index].set(t.index,i),this._uniqueEffectGlyphs[t.voice.index].push(i),i;case Vs.SinglePreBeat:case Vs.SingleOnBeat:case Vs.SingleOnBeatToEnd:return(i=this.info.createNewGlyph(this.renderer,t)).renderer=this.renderer,i.beat=t,i.doLayout(),this._effectGlyphs[t.voice.index].set(t.index,i),this._uniqueEffectGlyphs[t.voice.index].push(i),i;case Vs.GroupedOnBeat:case Vs.GroupedOnBeatToEnd:var s=e===Vs.GroupedOnBeat?Vs.SingleOnBeat:Vs.SingleOnBeatToEnd;if(0<t.index||0<this.renderer.index){var a=t.previousBeat;if(this.info.shouldCreateGlyph(this.renderer.settings,a)){let e=null;0<t.index&&this._effectGlyphs[t.voice.index].has(a.index)?e=this._effectGlyphs[t.voice.index].get(a.index):0<this.renderer.index&&(r=this.renderer.previousRenderer.getBand(this.voice,this.info.effectId)._effectGlyphs[t.voice.index]).has(a.index)&&(e=r.get(a.index));var r=this.createOrResizeGlyph(s,t);return e&&this.info.canExpand(a,t)&&((e.nextGlyph=r).previousGlyph=e,this.isLinkedToPrevious=!0),r}}return this.createOrResizeGlyph(s,t);default:return this.createOrResizeGlyph(Vs.SingleOnBeat,t)}}paint(i,s,a){super.paint(i,s,a);for(let e=0,t=this._uniqueEffectGlyphs.length;e<t;e++){var r=this._uniqueEffectGlyphs[e];for(let e=0,t=r.length;e<t;e++)r[e].paint(i+this.x,s+this.y,a)}}alignGlyphs(){for(let e=0;e<this._effectGlyphs.length;e++)for(const t of this._effectGlyphs[e].keys())this.alignGlyph(this.info.sizingMode,this.renderer.bar.voices[e].beats[t])}alignGlyph(e,t){var i=this._effectGlyphs[t.voice.index].get(t.index);let s;var a=this.renderer.getBeatContainer(t);switch(e){case Vs.SinglePreBeat:s=a.preNotes,i.x=this.renderer.beatGlyphsStart+s.x+a.x,i.width=s.width;break;case Vs.SingleOnBeat:case Vs.GroupedOnBeat:s=a.onNotes,i.x=this.renderer.beatGlyphsStart+s.x+a.x,i.width=s.width;break;case Vs.SingleOnBeatToEnd:case Vs.GroupedOnBeatToEnd:s=a.onNotes,i.x=this.renderer.beatGlyphsStart+s.x+a.x,a.beat.isLastOfVoice?i.width=this.renderer.width-i.x:i.width=a.width-a.preNotes.width-a.preNotes.x;break;case Vs.FullBar:i.width=this.renderer.width}}}class va{constructor(){this.uniqueEffectId=null,this.y=0,this.height=0,this.firstBeat=null,this.lastBeat=null}}class Ba{constructor(){this.bands=[],this.shared=new va}update(e){e.info.canShareBand||(this.shared.uniqueEffectId=e.info.effectId),(e.slot=this).bands.push(e),e.height>this.shared.height&&(this.shared.height=e.height),this.shared.firstBeat&&!e.firstBeat.isBefore(this.shared.firstBeat)||(this.shared.firstBeat=e.firstBeat),this.shared.lastBeat&&!e.lastBeat.isAfter(this.shared.lastBeat)||(this.shared.lastBeat=e.lastBeat)}canBeUsed(e){return(!this.shared.uniqueEffectId&&e.info.canShareBand||e.info.effectId===this.shared.uniqueEffectId)&&(!this.shared.firstBeat||this.shared.lastBeat.isBefore(e.firstBeat)||this.shared.lastBeat.isBefore(this.shared.firstBeat))}}class Ta{constructor(){this.slots=[],this._effectSlot=new Map}getOrCreateSlot(e){if(this._effectSlot.has(e.info.effectId)){var t=this._effectSlot.get(e.info.effectId);if(t.canBeUsed(e))return t}for(var i of this.slots)if(i.canBeUsed(e))return i;t=new Ba;return this.slots.push(t),t}register(e){var t=this.getOrCreateSlot(e);t.update(e),this._effectSlot.set(e.info.effectId,t)}}class ka extends ha{constructor(){super(0,0),this.computedWidth=0}doLayout(){let i=0;if(this.glyphs)for(let e=0,t=this.glyphs.length;e<t;e++){var s=this.glyphs[e];s.x=i,s.renderer=this.renderer,s.doLayout(),i+=s.width}this.width=i,this.computedWidth=i}noteLoop(t){for(let e=this.container.beat.notes.length-1;0<=e;e--)t(this.container.beat.notes[e])}}class Na extends ka{constructor(){super(...arguments),this.centerX=0}updateBeamingHelper(){}buildBoundingsLookup(e,t,i){}getNoteX(e,t){return 0}getNoteY(e,t){return 0}}class xa extends _a{constructor(e,t,i){super(e,t),this._bands=[],this._bandLookup=new Map,this.sizingInfo=null,this._infos=i}updateSizes(){this.topOverflow=0,this.bottomOverflow=0,this.topPadding=0,this.bottomPadding=0,this.updateHeight(),super.updateSizes()}finalizeRenderer(){let e=super.finalizeRenderer();return e=this.updateHeight()?!0:e}updateHeight(){if(!this.sizingInfo)return!1;let e=0;for(var t of this.sizingInfo.slots){t.shared.y=e;for(var i of t.bands)i.y=e,i.height=t.shared.height;e+=t.shared.height}return e!==this.height&&(this.height=e,!0)}applyLayoutingInfo(){if(!super.applyLayoutingInfo())return!1;var e,t;0<this.index?(e=this.previousRenderer,this.sizingInfo=e.sizingInfo):this.sizingInfo=new Ta;for(t of this._bands)t.alignGlyphs(),t.isEmpty||this.sizingInfo.register(t);return this.updateHeight(),!0}scaleToWidth(e){super.scaleToWidth(e);for(var t of this._bands)t.alignGlyphs()}createBeatGlyphs(){this._bands=[],this._bandLookup=new Map;for(var e of this.bar.voices)if(this.hasVoiceContainer(e))for(var t of this._infos){var i=new wa(e,t);i.renderer=this,i.doLayout(),this._bands.push(i),this._bandLookup.set(e.index+"."+t.effectId,i)}for(var s of this.bar.voices)this.hasVoiceContainer(s)&&this.createVoiceGlyphs(s);for(var a of this._bands)a.isLinkedToPrevious&&(this.isLinkedToPrevious=!0)}createVoiceGlyphs(e){for(var t of e.beats){var i,s=new Ps(t,this.getVoiceContainer(e));s.preNotes=new ka,s.onNotes=new Na,this.addBeatGlyph(s);for(i of this._bands)i.createGlyph(t)}}paint(e,t,i){this.paintBackground(e,t,i);for(var s of this._bands)i.color=0===s.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,s.isEmpty||s.paint(e+this.x,t+this.y,i)}getBand(e,t){e=e.index+"."+t;return this._bandLookup.has(e)?this._bandLookup.get(e):null}}class Pa extends oa{constructor(e,t){super(),this._infos=t,this._staffId=e,this.isInAccolade=!1,this.isRelevantForBoundsLookup=!1}get staffId(){return this._staffId}create(t,e){return new xa(t,e,this._infos.filter(e=>t.settings.notation.isNotationElementVisible(e.notationElement)))}}class Ea extends ks{constructor(e,t,i){super(e,t),this._endingsString="",this._endings=[];for(let e=0;e<Re.MaxAlternateEndings;e++)0!=(i&1<<e)&&this._endings.push(e)}doLayout(){super.doLayout(),this.height=this.renderer.resources.wordsFont.size+(Ea.Padding*this.scale+2);let i="";for(let e=0,t=this._endings.length;e<t;e++)i=i+(this._endings[e]+1)+". ";this._endingsString=i}paint(e,t,i){super.paint(e,t,i);var s,a=i.textBaseline;i.textBaseline=P.Top,0<this._endings.length&&(s=this.renderer.resources,i.font=s.wordsFont,i.moveTo(e+this.x,t+this.y+this.height),i.lineTo(e+this.x,t+this.y),i.lineTo(e+this.x+this.width,t+this.y),i.stroke(),i.fillText(this._endingsString,e+this.x+Ea.Padding*this.scale,t+this.y*this.scale)),i.textBaseline=a}}Ea.Padding=3;class Ca{get effectId(){return this.notationElement.toString()}}class Fa extends Ca{get notationElement(){return f.EffectAlternateEndings}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return Vs.FullBar}shouldCreateGlyph(e,t){return 0===t.voice.index&&0===t.index&&0!==t.voice.bar.masterBar.alternateEndings}createNewGlyph(e,t){return new Ea(0,0,t.voice.bar.masterBar.alternateEndings)}canExpand(e,t){return!0}}class La extends ks{constructor(e,t,i,s,a=N.Left){super(e,t),this._lines=i.split("\n"),this.font=s,this.textAlign=a}doLayout(){super.doLayout(),this.height=this.font.size*this._lines.length}paint(e,t,i){var s,a=i.color,a=(i.color=a,i.font=this.font,i.textAlign);i.textAlign=this.textAlign;let r=t+this.y;for(s of this._lines)i.fillText(s,e+this.x,r),r+=this.font.size;i.textAlign=a}}class Ma extends Ca{get notationElement(){return f.EffectCapo}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Vs.SingleOnBeat}shouldCreateGlyph(e,t){return 0===t.index&&0===t.voice.bar.index&&0!==t.voice.bar.staff.capo}createNewGlyph(e,t){return new La(0,0,"Capo. fret "+t.voice.bar.staff.capo,e.resources.effectFont,N.Left)}canExpand(e,t){return!1}}class Da extends Ca{get notationElement(){return f.EffectChordNames}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Vs.SingleOnBeat}shouldCreateGlyph(e,t){return t.hasChord}createNewGlyph(e,t){return new La(0,0,t.chord.name,e.resources.effectFont,N.Center)}canExpand(e,t){return!1}}class Ia extends ks{constructor(e){super(),this.forceGroupedRendering=!1,this.endOnBarLine=!1,this.endPosition=e}get isLinkedWithPrevious(){return!!this.previousGlyph&&this.previousGlyph.renderer.staff.staveGroup===this.renderer.staff.staveGroup}get isLinkedWithNext(){return!!this.nextGlyph&&this.nextGlyph.renderer.isFinalized&&this.nextGlyph.renderer.staff.staveGroup===this.renderer.staff.staveGroup}paint(t,i,s){if(!this.isLinkedWithPrevious)if(this.isLinkedWithNext||this.forceGroupedRendering){let e;if(!this.isLinkedWithNext&&this.forceGroupedRendering)e=this;else for(e=this.nextGlyph;e.isLinkedWithNext;)e=e.nextGlyph;var a=e.renderer,r=e.beat,n=this.endPosition,o=t-this.renderer.x,a=this.calculateEndX(a,r,o,n);this.paintGrouped(t,i,a,s)}else this.paintNonGrouped(t,i,s)}calculateEndX(e,t,i,s){return t?i+e.x+e.getBeatX(t,s):i+e.x+this.x+this.width}paintNonGrouped(e,t,i){var s=e-this.renderer.x,s=this.calculateEndX(this.renderer,this.beat,s,this.endPosition);this.paintGrouped(e,t,s,i)}}class Ra extends Ia{constructor(e,t,i){super(Os.EndBeat),this._crescendo=X.None,this._crescendo=i,this.x=e,this.y=t}doLayout(){super.doLayout(),this.height=17*this.scale}paintGrouped(e,t,i,s){var e=e+this.x,a=this.height*this.scale;s.beginPath(),this._crescendo===X.Crescendo?(i-=Ra.Padding*this.scale,s.moveTo(i,t+this.y),s.lineTo(e,t+this.y+a/2),s.lineTo(i,t+this.y+a)):(i-=Ra.Padding*this.scale,s.moveTo(e,t+this.y),s.lineTo(i,t+this.y+a/2),s.lineTo(e,t+this.y+a)),s.stroke()}}Ra.Padding=R.QuarterNoteHeadWidth/2|0;class Aa extends Ca{get notationElement(){return f.EffectCrescendo}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Vs.GroupedOnBeatToEnd}shouldCreateGlyph(e,t){return t.crescendo!==X.None}createNewGlyph(e,t){return new Ra(0,0,t.crescendo)}canExpand(e,t){return e.crescendo===t.crescendo}}class Oa extends Ns{constructor(e,t,i){super(e,t,.6,Oa.getSymbol(i))}doLayout(){super.doLayout(),this.height=17*this.scale,this.y+=this.height/2}static getSymbol(e){switch(e){case l.PPP:return k.DynamicPPP;case l.PP:return k.DynamicPP;case l.P:return k.DynamicPiano;case l.MP:return k.DynamicMP;case l.MF:return k.DynamicMF;case l.F:return k.DynamicForte;case l.FF:return k.DynamicFF;case l.FFF:return k.DynamicFFF;default:return k.None}}}class Ga extends Ca{get notationElement(){return f.EffectDynamics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Vs.SingleOnBeat}shouldCreateGlyph(e,t){return this.internalShouldCreateGlyph(t)}internalShouldCreateGlyph(e){if(e.voice.bar.staff.track.score.stylesheet.hideDynamics||e.isEmpty||e.voice.isEmpty||e.isRest||e.graceType!==_.None)return!1;var t=this.getPreviousDynamicsBeat(e);let i=0===e.voice.index&&!t||e.dynamics!==(null==t?void 0:t.dynamics);if(i&&0<e.voice.index)for(var s of e.voice.bar.voices)s.index<e.voice.index&&(s=s.getBeatAtPlaybackStart(e.playbackStart))&&e.dynamics===s.dynamics&&this.internalShouldCreateGlyph(s)&&(i=!1);return i}getPreviousDynamicsBeat(e){let t=e.previousBeat;for(;null!=t;){if(!t.isRest&&t.graceType===_.None)return t;t=t.previousBeat}return null}createNewGlyph(e,t){return new Oa(0,0,t.dynamics)}canExpand(e,t){return!0}}class Ha extends ks{doLayout(){super.doLayout(),this.height=17*this.scale}paint(e,t,i){var s=6*this.scale,a=Math.max(this.width,14*this.scale),r=this.height/2;i.beginPath(),i.moveTo(e+this.x,t+this.y+r),i.quadraticCurveTo(e+this.x+a/2,t+this.y+r,e+this.x+a,t+this.y+r-s),i.moveTo(e+this.x,t+this.y+r),i.quadraticCurveTo(e+this.x+a/2,t+this.y+r,e+this.x+a,t+this.y+r+s),i.stroke()}}class Va extends Ca{get notationElement(){return f.EffectFadeIn}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Vs.SingleOnBeat}shouldCreateGlyph(e,t){return t.fadeIn}createNewGlyph(e,t){return new Ha}canExpand(e,t){return!0}}class Wa extends Ns{constructor(e,t,i){super(e,t,1,Wa.getSymbol(i))}static getSymbol(e){switch(e){case te.Short:return k.FermataShortAbove;case te.Medium:return k.FermataAbove;case te.Long:return k.FermataLongAbove;default:return k.None}}doLayout(){this.width=23*this.scale,this.height=12*this.scale}paint(e,t,i){super.paint(e-this.width/2,t+this.height,i)}}class za extends Ca{get notationElement(){return f.EffectFermata}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Vs.SingleOnBeat}shouldCreateGlyph(e,t){return 0===t.voice.index&&!!t.fermata}createNewGlyph(e,t){return new Wa(0,0,t.fermata.type)}canExpand(e,t){return!0}}class Ua extends Ca{get notationElement(){return f.EffectFingering}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Vs.SingleOnBeat}shouldCreateGlyph(e,t){return!(0!==t.voice.index||t.isRest||e.notation.fingeringMode!==T.FingeringMode.SingleNoteEffectBand&&e.notation.fingeringMode!==T.FingeringMode.SingleNoteEffectBandForcePiano)&&1===t.notes.length&&t.notes[0].isFingering}createNewGlyph(e,t){let i=v.Unknown,s=!1;var a=t.notes[0],t=(a.leftHandFinger!==v.Unknown?(i=a.leftHandFinger,s=!0):a.rightHandFinger!==v.Unknown&&(i=a.rightHandFinger),null!=(a=Be.fingerToString(e.settings,t,i,s))?a:"");return new La(0,0,t,e.resources.fingeringFont,N.Left)}canExpand(e,t){return!0}}class Xa extends Ca{constructor(){super(...arguments),this.lastCreateInfo=null}shouldCreateGlyph(e,i){this.lastCreateInfo=[];for(let e=0,t=i.notes.length;e<t;e++){var s=i.notes[e];this.shouldCreateGlyphForNote(s)&&this.lastCreateInfo.push(s)}return 0<this.lastCreateInfo.length}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}canExpand(e,t){return!0}}class Ya extends Ia{constructor(e){super(Os.OnNotes),this._label=e}doLayout(){this.renderer.settings.notation.extendLineEffectsToBeatEnd&&(this.endPosition=Os.EndBeat,this.forceGroupedRendering=!0),super.doLayout(),this.height=this.renderer.resources.effectFont.size}paintNonGrouped(e,t,i){var s=this.renderer.resources,s=(i.font=s.effectFont,i.textAlign);i.textAlign=N.Center,i.fillText(this._label,e+this.x,t+this.y),i.textAlign=s}paintGrouped(t,e,i,s){this.paintNonGrouped(t,e,s);var a=3*this.scale,r=s.measureText(this._label),t=t+this.x+r/2+a,n=e+this.y+4*this.scale,o=8*this.scale;if(t<i){let e=t;for(;e<i;)s.beginPath(),s.moveTo(e,0|n),s.lineTo(Math.min(e+o,i),0|n),e+=o+a,s.stroke();s.beginPath(),s.moveTo(i,n-5*this.scale|0),s.lineTo(i,n+5*this.scale|0),s.stroke()}}}Ya.LineSpacing=3,Ya.LineTopPadding=4,Ya.LineTopOffset=5,Ya.LineSize=8;class qa extends Xa{constructor(e){switch(super(),this._beat=null,this._harmonicType=e){case g.None:this._effectId="harmonics-none";break;case g.Natural:this._effectId="harmonics-natural";break;case g.Artificial:this._effectId="harmonics-artificial";break;case g.Pinch:this._effectId="harmonics-pinch";break;case g.Tap:this._effectId="harmonics-tap";break;case g.Semi:this._effectId="harmonics-semi";break;case g.Feedback:this._effectId="harmonics-feedback";break;default:this._effectId=""}}get effectId(){return this._effectId}get notationElement(){return f.EffectHarmonics}shouldCreateGlyphForNote(e){return!(!e.isHarmonic||e.harmonicType!==this._harmonicType||(e.beat!==this._beat&&(this._beat=e.beat),0))}get sizingMode(){return Vs.GroupedOnBeat}createNewGlyph(e,t){return new Ya(qa.harmonicToString(this._harmonicType))}static harmonicToString(e){switch(e){case g.Natural:return"N.H.";case g.Artificial:return"A.H.";case g.Pinch:return"P.H.";case g.Tap:return"T.H.";case g.Semi:return"S.H.";case g.Feedback:return"Fdbk."}return""}}class Ja extends Ca{get notationElement(){return f.EffectLetRing}get canShareBand(){return!1}get hideOnMultiTrack(){return!1}shouldCreateGlyph(e,t){return t.isLetRing}get sizingMode(){return Vs.GroupedOnBeat}createNewGlyph(e,t){return new Ya("LetRing")}canExpand(e,t){return!0}}class ja extends ks{constructor(e,t,i,s,a=N.Center){super(e,t),this._lines=i,this.font=s,this.textAlign=a}doLayout(){super.doLayout(),this.height=this.font.size*this._lines.length}paint(t,i,s){s.font=this.font;var e=s.textAlign;s.textAlign=this.textAlign;for(let e=0;e<this._lines.length;e++)this._lines[e]&&s.fillText(this._lines[e],t+this.x,i+this.y+e*this.font.size);s.textAlign=e}}class Qa extends Ca{get notationElement(){return f.EffectLyrics}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Vs.SingleOnBeat}shouldCreateGlyph(e,t){return!!t.lyrics}createNewGlyph(e,t){return new ja(0,0,t.lyrics,e.resources.effectFont,N.Center)}canExpand(e,t){return!0}}class Ka extends Ca{get notationElement(){return f.EffectMarker}get hideOnMultiTrack(){return!0}get canShareBand(){return!0}get sizingMode(){return Vs.SinglePreBeat}shouldCreateGlyph(e,t){return 0===t.voice.bar.staff.index&&0===t.voice.index&&0===t.index&&t.voice.bar.masterBar.isSectionStart}createNewGlyph(e,t){return new La(0,0,t.voice.bar.masterBar.section.marker?"["+t.voice.bar.masterBar.section.marker+"] "+t.voice.bar.masterBar.section.text:t.voice.bar.masterBar.section.text,e.resources.markerFont,N.Left)}canExpand(e,t){return!0}}class $a extends Ia{constructor(e,t){super(Os.PostNotes),this._ottava=e,this._aboveStaff=t}doLayout(){super.doLayout(),this.height=13*this.scale}paintNonGrouped(e,t,i){this.paintOttava(e,t,i)}paintOttava(e,t,i){let s=0;switch(this._ottava){case W._15ma:s=37*this.scale,i.fillMusicFontSymbol(e+this.x-s/2,t+this.y+this.height,.8,k.QuindicesimaAlta,!1);break;case W._8va:s=26*this.scale,i.fillMusicFontSymbol(e+this.x-s/2,t+this.y+this.height,.8,k.OttavaAlta,!1);break;case W._8vb:s=23*this.scale,i.fillMusicFontSymbol(e+this.x-s/2,t+this.y+this.height,.8,k.OttavaBassaVb,!1);break;case W._15mb:s=36*this.scale,i.fillMusicFontSymbols(e+this.x-s/2,t+this.y+this.height,.8,[k.Quindicesima,k.OctaveBaselineM,k.OctaveBaselineB],!1)}return s/2}paintGrouped(t,i,s,a){var e=this.paintOttava(t,i,a),r=3*this.scale,t=t+this.x+e+r,n=i+this.y,o=(n+=this._aboveStaff?2*this.scale:this.height-2*this.scale,8*this.scale);if(t<s){let e=t;for(;e<s;)a.beginPath(),a.moveTo(e,0|n),a.lineTo(Math.min(e+o,s),0|n),e+=o+r,a.stroke();a.beginPath(),this._aboveStaff?(a.moveTo(s,n),a.lineTo(s,i+this.y+this.height)):(a.moveTo(s,n),a.lineTo(s,i+this.y)),a.stroke()}}}class Za extends Ca{constructor(e){super(),this._aboveStaff=e}get effectId(){return"ottavia-"+(this._aboveStaff?"above":"below")}get notationElement(){return f.EffectOttavia}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Vs.GroupedOnBeat}shouldCreateGlyph(e,t){switch(t.ottava){case W._15ma:case W._8va:return this._aboveStaff;case W._8vb:case W._15mb:return!this._aboveStaff}return!1}createNewGlyph(e,t){return new $a(t.ottava,this._aboveStaff)}canExpand(e,t){return e.ottava===t.ottava}}class er extends Xa{get notationElement(){return f.EffectPalmMute}shouldCreateGlyphForNote(e){return e.isPalmMute}get sizingMode(){return Vs.GroupedOnBeat}createNewGlyph(e,t){return new Ya("P.M.")}constructor(){super()}}class tr extends Xa{get notationElement(){return f.EffectPickSlide}shouldCreateGlyphForNote(e){return e.slideOutType===m.PickSlideDown||e.slideOutType===m.PickSlideUp}get sizingMode(){return Vs.GroupedOnBeat}createNewGlyph(e,t){return new Ya("P.S.")}constructor(){super()}}class ir extends Ns{constructor(e,t,i){super(e,t,R.GraceScale,ir.getSymbol(i))}doLayout(){this.width=9*this.scale,this.height=13*this.scale}paint(e,t,i){super.paint(e,t+this.height,i)}static getSymbol(e){switch(e){case j.Up:return k.StringsUpBow;case j.Down:return k.StringsDownBow;default:return k.None}}}class sr extends Ca{get notationElement(){return f.EffectPickStroke}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Vs.SingleOnBeat}shouldCreateGlyph(e,t){return t.pickStroke!==j.None}createNewGlyph(e,t){return new ir(0,0,t.pickStroke)}canExpand(e,t){return!0}}class ar extends Ia{constructor(e){super(Os.EndBeat),this._stepSize=0,this._type=e}doLayout(){switch(super.doLayout(),this._type){case J.Slight:this._stepSize=12*this.scale;break;case J.Wide:this._stepSize=23*this.scale}this.height=18*this.scale}paintGrouped(e,t,i,s){let a=e+this.x;var e=i-a,r=Math.max(1,e/this._stepSize);s.beginPath(),s.moveTo(a,t+this.y);for(let e=0;e<r;e++)s.lineTo(a+this._stepSize/2,t+this.y+this.height),s.lineTo(a+this._stepSize,t+this.y),a+=this._stepSize;s.stroke()}}class rr extends Ca{get notationElement(){return f.EffectSlightBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Vs.GroupedOnBeatToEnd}shouldCreateGlyph(e,t){return t.vibrato===J.Slight}createNewGlyph(e,t){return new ar(J.Slight)}canExpand(e,t){return!0}}class nr extends Ia{constructor(e,t,i,s=1.2,a=!1){super(Os.EndBeat),this._scale=0,this._symbol=k.None,this._symbolSize=0,this._type=i,this._scale=s,this.x=e,this.y=t,this._partialWaves=a}doLayout(){super.doLayout();let e=0;switch(this._type){case J.Slight:this._symbol=k.WiggleTrill,this._symbolSize=9*this._scale,e=6*this._scale;break;case J.Wide:this._symbol=k.WiggleVibratoMediumFast,this._symbolSize=10*this._scale,e=10*this._scale}this.height=e*this.scale}paintGrouped(t,i,e,s){var a=t+this.x,r=this._symbolSize*this.scale;let n=(e-a)/r,o=((n=this._partialWaves?n:Math.floor(n))<1&&(n=1),0);for(let e=0;e<n;e++)s.fillMusicFontSymbol(t+this.x+o,i+this.y+2*this.height,this._scale*this.scale,this._symbol,!1),o+=r}}class or extends Xa{get notationElement(){return f.EffectSlightNoteVibrato}shouldCreateGlyphForNote(e){return e.vibrato===J.Slight||e.isTieDestination&&e.tieOrigin.vibrato===J.Slight}get sizingMode(){return Vs.GroupedOnBeatToEnd}createNewGlyph(e,t){return new nr(0,0,J.Slight,1.2)}constructor(){super()}}class hr extends Ca{get notationElement(){return f.EffectTap}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Vs.SingleOnBeat}shouldCreateGlyph(e,t){return t.slap||t.pop||t.tap}createNewGlyph(e,t){e=e.resources;return t.slap?new La(0,0,"S",e.effectFont,N.Left):t.pop?new La(0,0,"P",e.effectFont,N.Left):new La(0,0,"T",e.effectFont,N.Left)}canExpand(e,t){return!0}}class lr extends ks{constructor(e,t,i){super(e,t),this._tempo=0,this._tempo=i}doLayout(){super.doLayout(),this.height=25*this.scale}paint(e,t,i){var s=this.renderer.resources;i.font=s.markerFont,i.fillMusicFontSymbol(e+this.x,t+this.y+.8*this.height,this.scale*R.GraceScale,k.NoteQuarterUp,!1),i.fillText("= "+this._tempo.toString(),e+this.x+this.height/2,t+this.y+i.font.size/2)}}class dr extends Ca{get notationElement(){return f.EffectTempo}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return Vs.SinglePreBeat}shouldCreateGlyph(e,t){return 0===t.voice.bar.staff.index&&0===t.voice.index&&0===t.index&&(!!t.voice.bar.masterBar.tempoAutomation||0===t.voice.bar.index)}createNewGlyph(e,t){let i=0;return i=t.voice.bar.masterBar.tempoAutomation?t.voice.bar.masterBar.tempoAutomation.value:t.voice.bar.staff.track.score.tempo,new lr(0,0,i)}canExpand(e,t){return!0}}class cr extends Ca{get notationElement(){return f.EffectText}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Vs.SingleOnBeat}shouldCreateGlyph(e,t){return!!t.text}createNewGlyph(e,t){return new La(0,0,t.text,e.resources.effectFont,N.Left)}canExpand(e,t){return!0}}class ur extends ks{constructor(e,t){super(e,t)}doLayout(){super.doLayout(),this.height=this.renderer.resources.markerFont.size*this.scale}paint(t,e,i){var s=this.renderer.resources,s=(i.font=s.markerFont,i.measureText("tr")),s=(i.fillText("tr",t+this.x,e+this.y),s+3*this.scale),a=this.width-s,r=11*this.scale*1.2,n=Math.max(1,(a-s)/r);let o=s;var h=e+this.y+1.2*this.height;for(let e=0;e<n;e++)i.fillMusicFontSymbol(t+this.x+o,h,1.2,k.WiggleTrill,!1),o+=r}}class pr extends Xa{get notationElement(){return f.EffectTrill}shouldCreateGlyphForNote(e){return e.isTrill}get sizingMode(){return Vs.SingleOnBeat}createNewGlyph(e,t){return new ur(0,0)}}(e=Ws=Ws||{})[e.Full=0]="Full",e[e.PartialLeft=1]="PartialLeft",e[e.PartialRight=2]="PartialRight";class gr extends ks{constructor(e){super(0,0),this._tripletFeel=e}doLayout(){super.doLayout(),this.height=25*this.scale}paint(e,t,i){e+=this.x;var s=(t+=this.y)+this.height*R.GraceScale,a=(i.font=this.renderer.resources.effectFont,i.fillText("(",e,t+.3*this.height),e+10*this.scale),r=e+40*this.scale;switch(this._tripletFeel){case u.NoTripletFeel:this.renderBarNote(a,s,gr.NoteScale,i,[Ws.Full]),this.renderBarNote(r,s,gr.NoteScale,i,[Ws.Full]);break;case u.Triplet8th:this.renderBarNote(a,s,gr.NoteScale,i,[Ws.Full]),i.fillMusicFontSymbol(r,s,gr.NoteScale,k.NoteQuarterUp,!1),i.fillMusicFontSymbol(r+gr.NoteSeparation*this.scale,s,gr.NoteScale,k.NoteEighthUp,!1),this.renderTriplet(r,t,i);break;case u.Triplet16th:this.renderBarNote(a,s,gr.NoteScale,i,[Ws.Full,Ws.Full]),this.renderBarNote(r,s,gr.NoteScale,i,[Ws.Full,Ws.PartialRight]),this.renderTriplet(r,t,i);break;case u.Dotted8th:this.renderBarNote(a,s,gr.NoteScale,i,[Ws.Full]),this.renderBarNote(r,s,gr.NoteScale,i,[Ws.Full,Ws.PartialRight]),i.fillCircle(r+9*this.scale,s,this.scale);break;case u.Dotted16th:this.renderBarNote(a,s,gr.NoteScale,i,[Ws.Full,Ws.Full]),this.renderBarNote(r,s,gr.NoteScale,i,[Ws.Full,Ws.Full,Ws.PartialRight]),i.fillCircle(r+9*this.scale,s,this.scale);break;case u.Scottish8th:this.renderBarNote(a,s,gr.NoteScale,i,[Ws.Full]),this.renderBarNote(r,s,gr.NoteScale,i,[Ws.Full,Ws.PartialLeft]),i.fillCircle(r+gr.NoteSeparation*this.scale+8*this.scale,s,this.scale);break;case u.Scottish16th:this.renderBarNote(a,s,gr.NoteScale,i,[Ws.Full,Ws.Full]),this.renderBarNote(r,s,gr.NoteScale,i,[Ws.Full,Ws.Full,Ws.PartialLeft]),i.fillCircle(r+gr.NoteSeparation*this.scale+8*this.scale,s,this.scale)}i.fillText("=",e+30*this.scale,t+5*this.scale),i.fillText(")",e+65*this.scale,t+.3*this.height)}renderBarNote(t,i,e,s,a){s.fillMusicFontSymbol(t,i,e,k.NoteQuarterUp,!1);var r=gr.NoteSeparation/2*this.scale;for(let e=0;e<a.length;e++)switch(a[e]){case Ws.Full:s.fillRect(t+4*this.scale,i-gr.NoteHeight*this.scale+gr.BarSeparation*this.scale*e,gr.NoteSeparation*this.scale,gr.BarHeight*this.scale);break;case Ws.PartialLeft:s.fillRect(t+4*this.scale,i-gr.NoteHeight*this.scale+gr.BarSeparation*this.scale*e,r,gr.BarHeight*this.scale);break;case Ws.PartialRight:s.fillRect(t+4*this.scale+r,i-gr.NoteHeight*this.scale+gr.BarSeparation*this.scale*e,r,gr.BarHeight*this.scale)}s.fillMusicFontSymbol(t+gr.NoteSeparation*this.scale,i,e,k.NoteQuarterUp,!1)}renderTriplet(e,t,i){t+=2*this.scale;var s=this.renderer.resources.effectFont,a=(i.font=bi.withFamilyList(s.families,.8*s.size,s.style),e+gr.NoteSeparation*this.scale+3*this.scale);i.beginPath(),i.moveTo(e,t+3*this.scale),i.lineTo(e,t),i.lineTo(e+5*this.scale,t),i.moveTo(a+5*this.scale,t+3*this.scale),i.lineTo(a+5*this.scale,t),i.lineTo(a,t),i.stroke(),i.fillText("3",e+7*this.scale,t-10*this.scale),i.font=s}}gr.NoteScale=.4,gr.NoteHeight=12,gr.NoteSeparation=12,gr.BarHeight=2,gr.BarSeparation=3;class mr extends Ca{get notationElement(){return f.EffectTripletFeel}get hideOnMultiTrack(){return!0}get canShareBand(){return!1}get sizingMode(){return Vs.SinglePreBeat}shouldCreateGlyph(e,t){return 0===t.index&&(0===t.voice.bar.masterBar.index&&t.voice.bar.masterBar.tripletFeel!==u.NoTripletFeel||0<t.voice.bar.masterBar.index&&t.voice.bar.masterBar.tripletFeel!==t.voice.bar.masterBar.previousMasterBar.tripletFeel)}createNewGlyph(e,t){return new gr(t.voice.bar.masterBar.tripletFeel)}canExpand(e,t){return!0}}class fr extends Ca{get notationElement(){return f.EffectWhammyBar}get hideOnMultiTrack(){return!1}get canShareBand(){return!1}get sizingMode(){return Vs.GroupedOnBeat}shouldCreateGlyph(e,t){return t.hasWhammyBar}createNewGlyph(e,t){return new Ya("w/bar")}canExpand(e,t){return!0}}class yr extends Ca{get notationElement(){return f.EffectWideBeatVibrato}get hideOnMultiTrack(){return!1}get canShareBand(){return!0}get sizingMode(){return Vs.GroupedOnBeatToEnd}shouldCreateGlyph(e,t){return t.vibrato===J.Wide}createNewGlyph(e,t){return new ar(J.Wide)}canExpand(e,t){return!0}}class br extends Xa{get notationElement(){return f.EffectWideNoteVibrato}shouldCreateGlyphForNote(e){return e.vibrato===J.Wide||e.isTieDestination&&e.tieOrigin.vibrato===J.Wide}get sizingMode(){return Vs.GroupedOnBeatToEnd}createNewGlyph(e,t){return new nr(0,0,J.Wide,1.2)}}class Sr extends ks{constructor(e,t,i){super(e,t),this._textRow=0,this._fretRow=0,this._firstFretSpacing=0,this._chord=i}doLayout(){super.doLayout();var e=this.scale,t=this.renderer.resources;this._textRow=1.5*t.effectFont.size*e,this._fretRow=1.5*t.effectFont.size*e,1<this._chord.firstFret?this._firstFretSpacing=Sr.FretSpacing*e:this._firstFretSpacing=0,this.height=this._textRow+this._fretRow+(Sr.Frets-1)*Sr.FretSpacing*e+2*Sr.Padding*e,this.width=this._firstFretSpacing+(this._chord.staff.tuning.length-1)*Sr.StringSpacing*e+2*Sr.Padding*e}paint(t,i,s){t+=this.x+Sr.Padding*this.scale+this._firstFretSpacing,i+=this.y;var a=this.width-2*Sr.Padding*this.scale+this.scale-this._firstFretSpacing,r=Sr.StringSpacing*this.scale,n=Sr.FretSpacing*this.scale,e=this.renderer.resources,o=Sr.CircleRadius*this.scale,h=s.textAlign,l=s.textBaseline;s.font=e.effectFont,s.textAlign=N.Center,s.textBaseline=P.Top,this._chord.showName&&s.fillText(this._chord.name,t+this.width/2,i+e.effectFont.size/2),i+=this._textRow,t+=r/2,s.font=e.fretboardNumberFont,s.textBaseline=P.Middle;for(let e=0;e<this._chord.staff.tuning.length;e++){var d=t+e*r,c=i+this._fretRow/2,u=this._chord.strings[this._chord.staff.tuning.length-e-1];u<0?s.fillMusicFontSymbol(d,c,this.scale,k.FretboardX,!0):0===u?s.fillMusicFontSymbol(d,c,this.scale,k.FretboardO,!0):(u-=this._chord.firstFret-1,s.fillText(u.toString(),d,c))}i+=this._fretRow;for(let e=0;e<this._chord.staff.tuning.length;e++){var p=t+e*r;s.fillRect(p,i,1,n*Sr.Frets+this.scale)}1<this._chord.firstFret&&(s.textAlign=N.Left,s.fillText(this._chord.firstFret.toString(),t-this._firstFretSpacing,i+n/2)),s.fillRect(t,i-this.scale,a,2*this.scale);for(let e=0;e<=Sr.Frets;e++){var g=i+e*n;s.fillRect(t,g,a,this.scale)}var m,f,y,b=new Map;for(m of this._chord.barreFrets)b.set(m-this._chord.firstFret,[-1,-1]);for(let e=0;e<this._chord.strings.length;e++){var S,_=this._chord.strings[e];0<_&&(_-=this._chord.firstFret,b.has(_)&&((-1===(S=b.get(_))[0]||e<S[0])&&(S[0]=e),-1===S[1]||e>S[1])&&(S[1]=e),S=i+_*n+n/2+.5*this.scale,_=t+(this._chord.strings.length-e-1)*r,s.fillCircle(_,S,o))}for([f,y]of b){var w=i+f*n+n/2+.5*this.scale,v=t+(this._chord.strings.length-y[1]-1)*r,B=t+(this._chord.strings.length-y[0]-1)*r;s.fillRect(v,w-o,B-v,2*o)}s.textAlign=h,s.textBaseline=l}}Sr.Padding=5,Sr.Frets=5,Sr.CircleRadius=2.5,Sr.StringSpacing=10,Sr.FretSpacing=12;class _r extends ha{constructor(e,t,i=N.Center){super(e,t),this._glyphWidth=0,this.glyphs=[],this._align=i}doLayout(){let e=0;switch(this._align){case N.Left:e=0;break;case N.Center:e=(this.width-this._glyphWidth)/2;break;case N.Right:e=this.width-this._glyphWidth}for(var t of this.glyphs)t.x=e,e+=t.width}addGlyphToRow(e){this.glyphs.push(e),this._glyphWidth+=e.width,e.height>this.height&&(this.height=e.height)}}class wr extends ha{constructor(e,t,i=N.Center){super(e,t),this._rows=[],this.height=0,this.glyphs=[],this._align=i}doLayout(){let e=0,t=0;var i,s=2*wr.Padding*this.scale;this._rows=[];let a=new _r(e,t,this._align);a.width=this.width;for(i of this.glyphs)e+i.width<this.width||(a.isEmpty||(a.doLayout(),this._rows.push(a),t+=a.height+s),e=0,(a=new _r(e,t,this._align)).width=this.width),a.addGlyphToRow(i),e+=i.width;a.isEmpty||(a.doLayout(),this._rows.push(a),t+=a.height+s),this.height=t+s}paint(e,t,i){for(var s of this._rows)s.paint(e+this.x,t+this.y+wr.Padding*this.scale,i)}}wr.Padding=3;class vr extends wr{constructor(e,t){super(e,t)}addChord(e){0<e.strings.length&&((e=new Sr(0,0,e)).renderer=this.renderer,e.doLayout(),this.glyphs.push(e))}}class Br{constructor(e,t,i){this._sharedLayoutData=new Map,this.barRenderers=[],this.x=0,this.y=0,this.height=0,this.index=0,this.staffIndex=0,this.trackIndex=0,this.staveTop=0,this.topSpacing=20,this.bottomSpacing=5,this.staveBottom=0,this.isFirstInAccolade=!1,this.isLastInAccolade=!1,this._factory=i,this.trackIndex=e,this.modelStaff=t}get staveId(){return this._factory.staffId}getSharedLayoutData(e,t){return this._sharedLayoutData.has(e)?this._sharedLayoutData.get(e):t}setSharedLayoutData(e,t){this._sharedLayoutData.set(e,t)}get isInAccolade(){return this._factory.isInAccolade}get isRelevantForBoundsLookup(){return this._factory.isRelevantForBoundsLookup}registerStaffTop(e){this.staveTop=e}registerStaffBottom(e){this.staveBottom=e}addBarRenderer(e){e.staff=this,e.index=this.barRenderers.length,e.reLayout(),this.barRenderers.push(e),this.staveGroup.layout.registerBarRenderer(this.staveId,e)}addBar(e,t){let i;(i=e?this._factory.create(this.staveGroup.layout.renderer,e):new _a(this.staveGroup.layout.renderer,e)).staff=this,i.index=this.barRenderers.length,i.layoutingInfo=t,i.doLayout(),i.registerLayoutingInfo(),this.barRenderers.push(i),e&&this.staveGroup.layout.registerBarRenderer(this.staveId,i)}revertLastBar(){var e=this.barRenderers[this.barRenderers.length-1];return this.barRenderers.splice(this.barRenderers.length-1,1),this.staveGroup.layout.unregisterBarRenderer(this.staveId,e),e}scaleToWidth(e){this._sharedLayoutData=new Map;var i=e-this.staveGroup.width,s=i/this.barRenderers.length;let a=0;var r=this.topOverflow;for(let e=0,t=this.barRenderers.length;e<t;e++)this.barRenderers[e].x=a,this.barRenderers[e].y=this.topSpacing+r,0!=i&&this.barRenderers[e].scaleToWidth(this.barRenderers[e].width+s),a+=this.barRenderers[e].width}get topOverflow(){let i=0;for(let e=0,t=this.barRenderers.length;e<t;e++){var s=this.barRenderers[e];s.topOverflow>i&&(i=s.topOverflow)}return i}get bottomOverflow(){let i=0;for(let e=0,t=this.barRenderers.length;e<t;e++){var s=this.barRenderers[e];s.bottomOverflow>i&&(i=s.bottomOverflow)}return i}finalizeStaff(){this.height=0;let t=!1,i=this.topOverflow;for(let e=0;e<this.barRenderers.length;e++)this.barRenderers[e].y=this.topSpacing+i,this.height=Math.max(this.height,this.barRenderers[e].height),this.barRenderers[e].finalizeRenderer()&&(t=!0);if(t){i=this.topOverflow;for(let e=0;e<this.barRenderers.length;e++)this.barRenderers[e].y=this.topSpacing+i,this.height=Math.max(this.height,this.barRenderers[e].height),this.barRenderers[e].finalizeRenderer()}0<this.height&&(this.height+=this.topSpacing+i+this.bottomOverflow+this.bottomSpacing)}paint(i,s,a,r,n){if(0!==this.height&&0!==n)for(let e=r,t=Math.min(r+n,this.barRenderers.length);e<t;e++)this.barRenderers[e].paint(i+this.x,s+this.y,a)}}class Tr{constructor(){this.timePosition=0,this.longestDuration=0,this.smallestDuration=0,this.force=0,this.springConstant=0,this.preBeatWidth=0,this.graceBeatWidth=0,this.postSpringWidth=0,this.allDurations=new Set}get springWidth(){return this.preSpringWidth+this.postSpringWidth}get preSpringWidth(){return this.preBeatWidth+this.graceBeatWidth}}class kr{constructor(){this._timeSortedSprings=[],this._xMin=0,this._minTime=-1,this._onTimePositionsForce=0,this._onTimePositions=new Map,this._incompleteGraceRodsWidth=0,this.version=0,this.preBeatSizes=new Map,this.onBeatSizes=new Map,this.onBeatCenterX=new Map,this.preBeatSize=0,this.postBeatSize=0,this.voiceSize=0,this.minStretchForce=0,this.totalSpringConstant=0,this.incompleteGraceRods=new Map,this.allGraceRods=new Map,this.springs=new Map,this.height=0}updateVoiceSize(e){e>this.voiceSize&&(this.voiceSize=e,this.version++)}setPreBeatSize(e,t){(!this.preBeatSizes.has(e.index)||this.preBeatSizes.get(e.index)<t)&&(this.preBeatSizes.set(e.index,t),this.version++)}getPreBeatSize(e){return this.preBeatSizes.has(e.index)?this.preBeatSizes.get(e.index):0}setOnBeatSize(e,t){(!this.onBeatSizes.has(e.index)||this.onBeatSizes.get(e.index)<t)&&(this.onBeatSizes.set(e.index,t),this.version++)}getOnBeatSize(e){return this.onBeatSizes.has(e.index)?this.onBeatSizes.get(e.index):0}getBeatCenterX(e){return this.onBeatCenterX.has(e.index)?this.onBeatCenterX.get(e.index):0}setBeatCenterX(e,t){(!this.onBeatCenterX.has(e.index)||this.onBeatCenterX.get(e.index)<t)&&(this.onBeatCenterX.set(e.index,t),this.version++)}updateMinStretchForce(e){this.minStretchForce<e&&(this.minStretchForce=e)}addSpring(t,i,s,a,r){this.version++;let n;if(this.springs.has(t))(n=this.springs.get(t)).postSpringWidth<r&&(n.postSpringWidth=r),n.graceBeatWidth<s&&(n.graceBeatWidth=s),n.preBeatWidth<a&&(n.preBeatWidth=a),i<n.smallestDuration&&(n.smallestDuration=i),i>n.longestDuration&&(n.longestDuration=i),n.allDurations.add(i);else{if((n=new Tr).timePosition=t,n.allDurations.add(i),0<this._timeSortedSprings.length){var o=this._timeSortedSprings[this._timeSortedSprings.length-1];for(const l of o.allDurations)o.timePosition,l}n.longestDuration=i,n.postSpringWidth=r,n.graceBeatWidth=s,n.preBeatWidth=a,this.springs.set(t,n);var h=this._timeSortedSprings;let e=h.length-1;for(;0<e&&h[e].timePosition>t;)e--;this._timeSortedSprings.splice(e+1,0,n)}return(-1===this._minTime||this._minTime>t)&&(this._minTime=t),n}addBeatSpring(t,i,s){var a=t.absoluteDisplayStart;if(t.graceType!==_.None){var e=t.graceGroup.id,r=(this.allGraceRods.has(e)||this.allGraceRods.set(e,new Array(t.graceGroup.beats.length)),t.graceGroup.isComplete||this.incompleteGraceRods.has(e)||this.incompleteGraceRods.set(e,new Array(t.graceGroup.beats.length)),this.allGraceRods.get(e)[t.graceIndex]);r?(r.postSpringWidth<s&&(r.postSpringWidth=s),r.preBeatWidth<i&&(r.preBeatWidth=i)):((r=new Tr).timePosition=a,r.postSpringWidth=s,r.preBeatWidth=i,t.graceGroup.isComplete||(this.incompleteGraceRods.get(e)[t.graceIndex]=r),this.allGraceRods.get(e)[t.graceIndex]=r)}else{let e=0;if(t.graceGroup&&this.allGraceRods.has(t.graceGroup.id))for(const n of this.allGraceRods.get(t.graceGroup.id))e+=n.springWidth;this.addSpring(a,t.displayDuration,e,i,s)}}finish(){for(var[e,i]of this.allGraceRods){let t=0;if(this.incompleteGraceRods.has(e))for(const s of i)t+=s.preBeatWidth,s.graceBeatWidth=t,t+=s.postSpringWidth;else for(let e=i.length-1;0<=e;e--)i[e].graceBeatWidth=t,t-=i[e].preBeatWidth+i[e].postSpringWidth}this._incompleteGraceRodsWidth=0;for(const t of this.incompleteGraceRods.values())for(const a of t)this._incompleteGraceRodsWidth+=a.preBeatWidth+a.postSpringWidth;this.calculateSpringConstants(),this.version++}calculateSpringConstants(){this._xMin=0;for(const e of this.springs.values())e.springWidth<this._xMin&&(this._xMin=e.springWidth);let i=0;var s=this._timeSortedSprings;if(0===s.length)this.totalSpringConstant=-1,this.minStretchForce=-1;else{for(let t=0;t<s.length;t++){var a,r=s[t];let e=0;e=t===s.length-1?r.longestDuration:(a=s[t+1],Math.abs(a.timePosition-r.timePosition)),r.springConstant=this.calculateSpringConstant(r,e),i+=1/r.springConstant}this.totalSpringConstant=1/i;for(let t=this.minStretchForce=0;t<s.length;t++){var n=s[t];let e=0;e=t===s.length-1?n.postSpringWidth:(o=s[t+1],n.postSpringWidth+o.preSpringWidth),0===t&&(e+=n.preSpringWidth);var o=e*n.springConstant;this.updateMinStretchForce(o)}}}paint(e,t,i){}calculateSpringConstant(e,t){return t<=0&&(t=p.toTicks(x.SixtyFourth)),0===e.smallestDuration&&(e.smallestDuration=t),e.smallestDuration/t*(1/((1+.85*Math.log2(t/kr.MinDuration))*kr.MinDurationWidth))}spaceToForce(e){return-1!==this.totalSpringConstant?(0<this._timeSortedSprings.length&&(e-=this._timeSortedSprings[0].preSpringWidth),e-=this._incompleteGraceRodsWidth,Math.max(e,0)*this.totalSpringConstant):-1}calculateVoiceWidth(e){let t=0;return-1!==this.totalSpringConstant&&(t=this.calculateWidth(e,this.totalSpringConstant)),0<this._timeSortedSprings.length&&(t+=this._timeSortedSprings[0].preSpringWidth),t+=this._incompleteGraceRodsWidth}calculateWidth(e,t){return e/t}buildOnTimePositions(i){if(-1===this.totalSpringConstant)return new Map;if(Be.isAlmostEqualTo(this._onTimePositionsForce,i)&&this._onTimePositions)return this._onTimePositions;this._onTimePositionsForce=i;var s=new Map,a=(this._onTimePositions=s,this._timeSortedSprings);if(0!==a.length){let t=a[0].preSpringWidth;for(let e=0;e<a.length;e++)s.set(a[e].timePosition,t),t+=this.calculateWidth(i,a[e].springConstant)}return s}}kr.MinDuration=30,kr.MinDurationWidth=7;class Nr{constructor(){this.width=0,this.isLinkedToPrevious=!1,this.canWrap=!0,this.renderers=[]}}class xr{constructor(e,t){this.staves=[],this.stavesRelevantForBoundsLookup=[],this.firstStaffInAccolade=null,this.lastStaffInAccolade=null,this.staveGroup=e,this.track=t}addStaff(e){this.staves.push(e),e.isRelevantForBoundsLookup&&this.stavesRelevantForBoundsLookup.push(e)}}class Pr{constructor(){this._allStaves=[],this._firstStaffInAccolade=null,this._lastStaffInAccolade=null,this._accoladeSpacingCalculated=!1,this.x=0,this.y=0,this.index=0,this.accoladeSpacing=0,this.isFull=!1,this.width=0,this.isLast=!1,this.masterBarsRenderers=[],this.staves=[]}get firstBarIndex(){return this.masterBarsRenderers[0].masterBar.index}get lastBarIndex(){return this.masterBarsRenderers[this.masterBarsRenderers.length-1].masterBar.index}addMasterBarRenderers(e,i){if(0===e.length)return null;this.masterBarsRenderers.push(i),this.calculateAccoladeSpacing(e);let s=i.layoutingInfo.preBeatSize=0;for(let e=0,t=this.staves.length;e<t;e++){var a=this.staves[e];for(let e=0,t=a.staves.length;e<t;e++){var r=a.staves[e],n=i.renderers[s++];r.addBarRenderer(n)}}return this.updateWidth(),i}addBars(e,t){if(0===e.length)return null;var i,s=new Nr,a=(s.layoutingInfo=new kr,s.masterBar=e[0].score.masterBars[t],this.masterBarsRenderers.push(s),this.calculateAccoladeSpacing(e),s.layoutingInfo);for(i of this.staves)for(var r of i.staves){var n=i.track.staves[r.modelStaff.index].bars[t],n=(r.addBar(n,a),r.barRenderers[r.barRenderers.length-1]);s.renderers.push(n),n.isLinkedToPrevious&&(s.isLinkedToPrevious=!0),n.canWrap||(s.canWrap=!1)}return a.finish(),s.width=this.updateWidth(),s}revertLastBar(){if(1<this.masterBarsRenderers.length){var e=this.masterBarsRenderers[this.masterBarsRenderers.length-1];this.masterBarsRenderers.splice(this.masterBarsRenderers.length-1,1);let i=0;for(let e=0,t=this._allStaves.length;e<t;e++){var s=this._allStaves[e].revertLastBar();i=Math.max(i,s.width)}return this.width-=i,e}return null}updateWidth(){let i=0;for(let e=0,t=this._allStaves.length;e<t;e++){var s=this._allStaves[e];s.barRenderers[s.barRenderers.length-1].applyLayoutingInfo(),s.barRenderers[s.barRenderers.length-1].width>i&&(i=s.barRenderers[s.barRenderers.length-1].width)}return this.width+=i,i}calculateAccoladeSpacing(e){if(!this._accoladeSpacingCalculated&&0===this.index)if(this._accoladeSpacingCalculated=!0,this.layout.renderer.settings.notation.isNotationElementVisible(f.TrackNames)){var t,i=this.layout.renderer.canvas,s=this.layout.renderer.settings.display.resources.effectFont;i.font=s;for(t of e)this.accoladeSpacing=Math.ceil(Math.max(this.accoladeSpacing,i.measureText(t.shortName)));this.accoladeSpacing*=this.layout.scale,this.accoladeSpacing+=2*Pr.AccoladeLabelSpacing*this.layout.scale,this.width+=this.accoladeSpacing}else this.accoladeSpacing=0}getStaveTrackGroup(i){for(let e=0,t=this.staves.length;e<t;e++){var s=this.staves[e];if(s.track===i)return s}return null}addStaff(e,t){let i=this.getStaveTrackGroup(e);i||(i=new xr(this,e),this.staves.push(i)),t.staveTrackGroup=i,t.staveGroup=this,t.index=this._allStaves.length,this._allStaves.push(t),i.addStaff(t),t.isInAccolade&&(this._firstStaffInAccolade||((this._firstStaffInAccolade=t).isFirstInAccolade=!0),i.firstStaffInAccolade||(i.firstStaffInAccolade=t),this._lastStaffInAccolade||((this._lastStaffInAccolade=t).isLastInAccolade=!0),this._lastStaffInAccolade&&(this._lastStaffInAccolade.isLastInAccolade=!1),this._lastStaffInAccolade=t,this._lastStaffInAccolade.isLastInAccolade=!0,i.lastStaffInAccolade=t)}get height(){return this._allStaves[this._allStaves.length-1].y+this._allStaves[this._allStaves.length-1].height}scaleToWidth(i){for(let e=0,t=this._allStaves.length;e<t;e++)this._allStaves[e].scaleToWidth(i);this.width=i}paint(e,t,i){this.paintPartial(e+this.x,t+this.y,i,0,this.masterBarsRenderers.length)}paintPartial(i,s,a,r,n){for(let e=0,t=this._allStaves.length;e<t;e++)this._allStaves[e].paint(i,s,a,r,n);var e,t,o,h=this.layout.renderer.settings.display.resources;if(0<this.staves.length&&0===r){a.color=h.barSeparatorColor,this._firstStaffInAccolade&&this._lastStaffInAccolade&&(e=s+this._firstStaffInAccolade.y+this._firstStaffInAccolade.staveTop+this._firstStaffInAccolade.topSpacing+this._firstStaffInAccolade.topOverflow,t=s+this._lastStaffInAccolade.y+this._lastStaffInAccolade.topSpacing+this._lastStaffInAccolade.topOverflow+this._lastStaffInAccolade.staveBottom,o=i+this._firstStaffInAccolade.x,a.beginPath(),a.moveTo(o,e),a.lineTo(o,t),a.stroke()),a.font=h.effectFont;for(let e=0,t=this.staves.length;e<t;e++){var l,d,c,u,p,g,m=this.staves[e];m.firstStaffInAccolade&&m.lastStaffInAccolade&&(g=s+m.firstStaffInAccolade.y+m.firstStaffInAccolade.staveTop+m.firstStaffInAccolade.topSpacing+m.firstStaffInAccolade.topOverflow,p=s+m.lastStaffInAccolade.y+m.lastStaffInAccolade.topSpacing+m.lastStaffInAccolade.topOverflow+m.lastStaffInAccolade.staveBottom,l=i+m.firstStaffInAccolade.x,u=g-4*(c=d=3*this.layout.renderer.settings.display.scale),p=p+4*d,0===this.index&&this.layout.renderer.settings.notation.isNotationElementVisible(f.TrackNames)&&a.fillText(m.track.shortName,i+Pr.AccoladeLabelSpacing*this.layout.scale,g),a.fillRect(l-c-d,u,d,p-u),m=l-c-d,g=l+2*d,a.beginPath(),a.moveTo(m,u),a.bezierCurveTo(m,u,m,u,g,u-d),a.bezierCurveTo(l,u+d,m,u+d,m,u+d),a.closePath(),a.fill(),a.beginPath(),a.moveTo(m,p),a.bezierCurveTo(m,p,l,p,g,p+d),a.bezierCurveTo(l,p-d,m,p-d,m,p-d),a.closePath(),a.fill())}}}finalizeGroup(){let e=0;for(var t of this._allStaves)t.x=this.accoladeSpacing,t.y=e,t.finalizeStaff(),e+=t.height}buildBoundingsLookup(e,t){if(!this.layout.renderer.boundsLookup.isFinished&&this._firstStaffInAccolade&&this._lastStaffInAccolade){var i=this._allStaves[this._allStaves.length-1],s=t+this.y+this._firstStaffInAccolade.y,a=t+this.y+this._lastStaffInAccolade.y+this._lastStaffInAccolade.height,r=t+this.y+this._allStaves[0].y,n=t+this.y+i.y+i.height,o=t+this.y+this._firstStaffInAccolade.y+this._firstStaffInAccolade.topSpacing+this._firstStaffInAccolade.topOverflow+(0<this._firstStaffInAccolade.barRenderers.length?this._firstStaffInAccolade.barRenderers[0].topPadding:0),h=a-s,l=t+this.y+i.y+i.height-i.bottomSpacing-i.bottomOverflow-(0<i.barRenderers.length?i.barRenderers[0].bottomPadding:0)-o,d=n-r,c=this.x+this._firstStaffInAccolade.x,a=new hs,u=(a.visualBounds=new Ze,a.visualBounds.x=e,a.visualBounds.y=t+this.y,a.visualBounds.w=this.width,a.visualBounds.h=this.height,a.realBounds=new Ze,a.realBounds.x=e,a.realBounds.y=t+this.y,a.realBounds.w=this.width,a.realBounds.h=this.height,this.layout.renderer.boundsLookup.addStaveGroup(a),new Map);for(let e=0;e<this.staves.length;e++)for(var p of this.staves[e].stavesRelevantForBoundsLookup)for(var g of p.barRenderers){let e;u.has(g.bar.masterBar.index)?e=u.get(g.bar.masterBar.index):((e=new ns).index=g.bar.masterBar.index,e.isFirstOfLine=g.isFirstOfLine,e.realBounds=new Ze,e.realBounds.x=c+g.x,e.realBounds.y=r,e.realBounds.w=g.width,e.realBounds.h=d,e.visualBounds=new Ze,e.visualBounds.x=c+g.x,e.visualBounds.y=s,e.visualBounds.w=g.width,e.visualBounds.h=h,e.lineAlignedBounds=new Ze,e.lineAlignedBounds.x=c+g.x,e.lineAlignedBounds.y=o,e.lineAlignedBounds.w=g.width,e.lineAlignedBounds.h=l,this.layout.renderer.boundsLookup.addMasterBar(e),u.set(e.index,e)),g.buildBoundingsLookup(e,c,t+this.y+p.y)}}}getBarX(e){return this._firstStaffInAccolade&&0!==this.layout.renderer.tracks.length?(e=this.layout.renderer.tracks[0].staves[0].bars[e],this.layout.getRendererForBar(this._firstStaffInAccolade.staveId,e).x):0}}Pr.AccoladeLabelSpacing=10;class Er extends ha{constructor(e,t,i,s){super(e,t),this._tuning=i,this._trackLabel=s,this.glyphs=[]}doLayout(){if(!(0<this.glyphs.length)){this.createGlyphs(this._tuning);for(const e of this.glyphs)e.renderer=this.renderer,e.doLayout()}}createGlyphs(a){var r=this.renderer.scale,n=this.renderer.resources,o=15*r,h=((this.height=0)<this._trackLabel.length&&(this.addGlyph(new La(0,this.height,this._trackLabel,n.effectFont,N.Left)),this.height+=o),this.addGlyph(new La(0,this.height,a.name,n.effectFont,N.Left)),64*r);if(this.renderer.scoreRenderer.canvas.font=n.effectFont,this.width=Math.max(this.renderer.scoreRenderer.canvas.measureText(this._trackLabel)*r,Math.max(this.renderer.scoreRenderer.canvas.measureText(a.name)*r,2*h)),this.height+=o,!a.isStandard){var l=.7*Er.CircleNumberHeight*r,d=0|Math.ceil(a.tunings.length/2);let i=0,s=this.height;for(let e=0,t=a.tunings.length;e<t;e++){var c=k.GuitarString0+(e+1),c=(this.addGlyph(new Ns(i,s+l/1.2,.7,c)),"= "+y.getTextForTuning(a.tunings[e],!1));this.addGlyph(new La(i+l+ +r,s,c,n.effectFont,N.Left)),s+=o,e===d-1&&(s=this.height,i+=h)}this.height+=d*o}this.width+=15*r}}Er.CircleNumberHeight=20;class Cr extends wr{constructor(e,t){super(e,t,N.Left)}addTuning(e,t){0<e.tunings.length&&((e=new Er(0,0,e,t)).renderer=this.renderer,e.doLayout(),this.glyphs.push(e))}}class Fr{constructor(e,t){this.args=e,this.renderCallback=t}}class Lr{constructor(e){this._barRendererLookup=new Map,this.width=0,this.height=0,this.scoreInfoGlyphs=new Map,this.chordDiagrams=null,this.tuningGlyph=null,this._lazyPartials=new Map,this.firstBarIndex=0,this.lastBarIndex=0,this.renderer=e}resize(){this._lazyPartials.clear(),this.doResize()}layoutAndRender(){this._lazyPartials.clear();var e=this.renderer.score,t=this.renderer.settings.display.startBar;t--,t=Math.min(e.masterBars.length-1,Math.max(0,t)),this.firstBarIndex=t;let i=this.renderer.settings.display.barCount;i=t+(i=i<0?e.masterBars.length:i)-1,i=Math.min(e.masterBars.length-1,Math.max(0,i)),this.lastBarIndex=i,this.createScoreInfoGlyphs(),this.doLayoutAndRender()}registerPartial(e,t){this.renderer.partialLayoutFinished.trigger(e),this.renderer.settings.core.enableLazyLoading?this._lazyPartials.set(e.id,new Fr(e,t)):this.internalRenderLazyPartial(e,t)}internalRenderLazyPartial(e,t){var i=this.renderer.canvas;i.beginRender(e.width,e.height),t(i),e.renderResult=i.endRender(),this.renderer.partialRenderFinished.trigger(e)}renderLazyPartial(e){this._lazyPartials.has(e)&&(e=this._lazyPartials.get(e),this.internalRenderLazyPartial(e.args,e.renderCallback))}createScoreInfoGlyphs(){C.debug("ScoreLayout","Creating score info glyphs");var e=this.renderer.settings.notation,t=this.renderer.score,i=this.renderer.settings.display.resources,t=(this.scoreInfoGlyphs=new Map,t.title&&e.isNotationElementVisible(f.ScoreTitle)&&this.scoreInfoGlyphs.set(f.ScoreTitle,new La(0,0,t.title,i.titleFont,N.Center)),t.subTitle&&e.isNotationElementVisible(f.ScoreSubTitle)&&this.scoreInfoGlyphs.set(f.ScoreSubTitle,new La(0,0,t.subTitle,i.subTitleFont,N.Center)),t.artist&&e.isNotationElementVisible(f.ScoreArtist)&&this.scoreInfoGlyphs.set(f.ScoreArtist,new La(0,0,t.artist,i.subTitleFont,N.Center)),t.album&&e.isNotationElementVisible(f.ScoreAlbum)&&this.scoreInfoGlyphs.set(f.ScoreAlbum,new La(0,0,t.album,i.subTitleFont,N.Center)),t.music&&t.music===t.words&&e.isNotationElementVisible(f.ScoreWordsAndMusic)?this.scoreInfoGlyphs.set(f.ScoreWordsAndMusic,new La(0,0,"Music and Words by "+t.words,i.wordsFont,N.Center)):(t.music&&e.isNotationElementVisible(f.ScoreMusic)&&this.scoreInfoGlyphs.set(f.ScoreMusic,new La(0,0,"Music by "+t.music,i.wordsFont,N.Right)),t.words&&e.isNotationElementVisible(f.ScoreWords)&&this.scoreInfoGlyphs.set(f.ScoreWords,new La(0,0,"Words by "+t.words,i.wordsFont,N.Left))),new _a(this.renderer,this.renderer.tracks[0].staves[0].bars[0]));if(e.isNotationElementVisible(f.GuitarTuning)){var s,a=[];for(s of this.renderer.tracks)for(var r of s.staves)if(!r.isPercussion&&r.isStringed&&0<r.tuning.length&&r.showTablature){a.push(r);break}if(0<a.length){this.tuningGlyph=new Cr(0,0),this.tuningGlyph.renderer=t;for(const c of a)this.tuningGlyph.addTuning(c.stringTuning,1<a.length?c.track.name:"")}}if(e.isNotationElementVisible(f.ChordDiagrams)){this.chordDiagrams=new vr(0,0),this.chordDiagrams.renderer=t;var n,o,h,l=new Map;for(n of this.renderer.tracks)for(var d of n.staves)for([o,h]of d.chords)l.has(o)||h.showDiagram&&(l.set(o,h),this.chordDiagrams.addChord(h))}}get scale(){return this.renderer.settings.display.scale}createEmptyStaveGroup(){var a=new Pr;a.layout=this;for(let s=0;s<this.renderer.tracks.length;s++){var e,r=this.renderer.tracks[s];let i=!1;for(e of r.staves)if(e.showStandardNotation){i=!0;break}for(let t=0;t<r.staves.length;t++){var n,o=r.staves[t];let e;if(o.isPercussion)e=T.StaveProfile.Score;else if(this.renderer.settings.display.staveProfile!==T.StaveProfile.Default)e=this.renderer.settings.display.staveProfile;else if(o.showTablature&&o.showStandardNotation)e=T.StaveProfile.ScoreTab;else if(o.showTablature)e=i?T.StaveProfile.TabMixed:T.StaveProfile.Tab;else{if(!o.showStandardNotation)continue;e=T.StaveProfile.Score}for(n of O.staveProfiles.get(e))n.canCreate(r,o)&&a.addStaff(r,new Br(s,o,n))}}return a}registerBarRenderer(e,t){this._barRendererLookup.has(e)||this._barRendererLookup.set(e,new Map),this._barRendererLookup.get(e).set(t.bar.id,t)}unregisterBarRenderer(e,t){this._barRendererLookup.has(e)&&this._barRendererLookup.get(e).delete(t.bar.id)}getRendererForBar(e,t){t=t.id;return this._barRendererLookup.has(e)&&this._barRendererLookup.get(e).has(t)?this._barRendererLookup.get(e).get(t):null}layoutAndRenderAnnotation(e){let t="rendered by alphaTab",i=this.renderer.settings.display.resources,s=12*this.renderer.settings.display.scale;var a=Math.floor(2*s),r=new ss;const n=bi.withFamilyList(i.copyrightFont.families,s,de.Plain,ce.Bold);this.renderer.canvas.font=n;var o=O.getLayoutEngineFactory(this.renderer.settings.display.layoutMode).vertical;return r.width=this.renderer.canvas.measureText(t),r.height=a,r.x=o?(this.width-r.width)/2:this.firstBarX,r.y=e,r.totalWidth=this.width,r.totalHeight=e+a,r.firstMasterBarIndex=-1,r.lastMasterBarIndex=-1,this.registerPartial(r,e=>{e.color=i.mainGlyphColor,e.font=n,e.textAlign=N.Left,e.fillText(t,0,s)}),e+a}}class Mr{constructor(){this.x=0,this.width=0,this.masterBars=[]}}class Dr extends Lr{constructor(e){super(e),this._group=null,this._pagePadding=null}get name(){return"HorizontalScreen"}get supportsResize(){return!1}get firstBarX(){let e=this._pagePadding[0];return this._group&&(e+=this._group.accoladeSpacing),e}doResize(){}doLayoutAndRender(){this._pagePadding=this.renderer.settings.display.padding,this._pagePadding||(this._pagePadding=Dr.PagePadding),1===this._pagePadding.length?this._pagePadding=[this._pagePadding[0],this._pagePadding[0],this._pagePadding[0],this._pagePadding[0]]:2===this._pagePadding.length&&(this._pagePadding=[this._pagePadding[0],this._pagePadding[1],this._pagePadding[0],this._pagePadding[1]]);var e=this.renderer.score,t=this.renderer.settings.display.startBar;t--;let i=t=Math.min(e.masterBars.length-1,Math.max(0,t)),s=this.renderer.settings.display.barCount;s=t+(s=s<=0?e.masterBars.length:s)-1,s=Math.min(e.masterBars.length-1,Math.max(0,s)),this._group=this.createEmptyStaveGroup(),this._group.isLast=!0,this._group.x=this._pagePadding[0],this._group.y=this._pagePadding[1];var a=this.renderer.settings.display.barCountPerPartial,r=[];let n=new Mr,o=0;for(;i<=s;){var h,l=this._group.addBars(this.renderer.tracks,i);l&&(0===n.masterBars.length&&l.isLinkedToPrevious&&0<r.length?((h=r[r.length-1]).masterBars.push(e.masterBars[i]),h.width+=l.width,o+=l.width,n.x+=o):(n.masterBars.push(e.masterBars[i]),n.width+=l.width,n.masterBars.length>=a&&(0===r.length&&(n.width+=this._group.accoladeSpacing+this._pagePadding[0]),o+=n.width,r.push(n),C.debug(this.name,"Finished partial from bar "+n.masterBars[0].index+" to "+n.masterBars[n.masterBars.length-1].index,null),(n=new Mr).x=o))),i++}0<n.masterBars.length&&(0===r.length&&(n.width+=this._group.accoladeSpacing+this._pagePadding[0]),r.push(n),C.debug(this.name,"Finished partial from bar "+n.masterBars[0].index+" to "+n.masterBars[n.masterBars.length-1].index,null)),this.finalizeGroup(),this.height=Math.floor(this._group.y+this._group.height),this.width=this._group.x+this._group.width+this._pagePadding[2];let d=i=0;for(let e=0;e<r.length;e++){const u=r[e];var c=new ss;c.x=d,c.y=0,c.totalWidth=this.width,c.totalHeight=this.height,c.width=u.width,c.height=this.height,c.firstMasterBarIndex=u.masterBars[0].index,c.lastMasterBarIndex=u.masterBars[u.masterBars.length-1].index,d+=u.width;const p=i,g=e;this._group.buildBoundingsLookup(this._group.x,this._group.y),this.registerPartial(c,e=>{let t=this._group.getBarX(u.masterBars[0].index)+this._group.accoladeSpacing;0===g&&(t-=this._group.x+this._group.accoladeSpacing),e.color=this.renderer.settings.display.resources.mainGlyphColor,e.textAlign=N.Left,C.debug(this.name,"Rendering partial from bar "+u.masterBars[0].index+" to "+u.masterBars[u.masterBars.length-1].index,null),this._group.paintPartial(-t,this._group.y,e,p,u.masterBars.length)}),i+=u.masterBars.length}this.height=this.layoutAndRenderAnnotation(this.height)+this._pagePadding[3]}finalizeGroup(){this._group.scaleToWidth(this._group.width),this._group.finalizeGroup()}}Dr.PagePadding=[20,20,20,20],Dr.GroupSpacing=20;class Ir extends Lr{constructor(e){super(e),this._groups=[],this._allMasterBarRenderers=[],this._barsFromPreviousGroup=[],this._pagePadding=null}get name(){return"PageView"}doLayoutAndRender(){this._pagePadding=this.renderer.settings.display.padding,this._pagePadding||(this._pagePadding=Ir.PagePadding),1===this._pagePadding.length?this._pagePadding=[this._pagePadding[0],this._pagePadding[0],this._pagePadding[0],this._pagePadding[0]]:2===this._pagePadding.length&&(this._pagePadding=[this._pagePadding[0],this._pagePadding[1],this._pagePadding[0],this._pagePadding[1]]);var e;this.width=this.renderer.width,this._allMasterBarRenderers=[],e=this.layoutAndRenderScoreInfo(0,-1),e=this.layoutAndRenderTunings(e,-1),e=this.layoutAndRenderChordDiagrams(e,-1),e=this.layoutAndRenderScore(e),e=this.layoutAndRenderAnnotation(e),this.height=e+this._pagePadding[3]}get supportsResize(){return!0}get firstBarX(){let e=this._pagePadding[0];return 0<this._groups.length&&(e+=this._groups[0].accoladeSpacing),e}doResize(){this.width=this.renderer.width;var e=this.height,t=this.layoutAndRenderScoreInfo(0,e);t=this.layoutAndRenderTunings(t,e),t=this.layoutAndRenderChordDiagrams(t,e),t=this.resizeAndRenderScore(t,e),t=this.layoutAndRenderAnnotation(t),this.height=t+this._pagePadding[3]}layoutAndRenderTunings(e,t=-1){if(!this.tuningGlyph)return e;let i=this.renderer.settings.display.resources;this.tuningGlyph.x=this._pagePadding[0],this.tuningGlyph.width=this.width,this.tuningGlyph.doLayout();var s=this.tuningGlyph.height+11*this.scale,a=new ss;return a.x=0,a.y=e,a.width=this.width,a.height=s,a.totalWidth=this.width,a.totalHeight=t<0?e+a.height:t,this.registerPartial(a,e=>{e.color=i.scoreInfoColor,e.textAlign=N.Center,this.tuningGlyph.paint(0,0,e)}),e+s}layoutAndRenderChordDiagrams(e,t=-1){if(!this.chordDiagrams)return e;const i=this.renderer.settings.display.resources;this.chordDiagrams.width=this.width,this.chordDiagrams.doLayout();var s=Math.floor(this.chordDiagrams.height),a=new ss;return a.x=0,a.y=e,a.width=this.width,a.height=s,a.totalWidth=this.width,a.totalHeight=t<0?e+s:t,this.registerPartial(a,e=>{e.color=i.scoreInfoColor,e.textAlign=N.Center,this.chordDiagrams.paint(0,0,e)}),e+s}layoutAndRenderScoreInfo(e,t=-1){C.debug(this.name,"Layouting score info");var i=new ss;i.x=0,i.y=e;let s=this._pagePadding[1];var a=this.scale;let r=this.renderer.settings.display.resources;var n,o,h=[f.ScoreTitle,f.ScoreSubTitle,f.ScoreArtist,f.ScoreAlbum,f.ScoreWordsAndMusic];for(let e=0;e<h.length;e++)this.scoreInfoGlyphs.has(h[e])&&((n=this.scoreInfoGlyphs.get(h[e])).x=this.width/2,n.y=s,n.textAlign=N.Center,s+=n.font.size*a);let l=!1,d=0;return this.scoreInfoGlyphs.has(f.ScoreMusic)&&((o=this.scoreInfoGlyphs.get(f.ScoreMusic)).x=this.width-this._pagePadding[2],o.y=s,o.textAlign=N.Right,l=!0,d=o.font.size*a),this.scoreInfoGlyphs.has(f.ScoreWords)&&((o=this.scoreInfoGlyphs.get(f.ScoreWords)).x=this._pagePadding[0],o.y=s,o.textAlign=N.Left,l=!0,d=o.font.size*a),l&&(s+=d),s=Math.floor(s+17*this.scale),i.width=this.width,i.height=s,i.totalWidth=this.width,i.totalHeight=t<0?e+i.height:t,this.registerPartial(i,e=>{e.color=r.scoreInfoColor,e.textAlign=N.Center;for(const t of this.scoreInfoGlyphs.values())t.paint(0,0,e)}),e+s}resizeAndRenderScore(s,a){if(-1!==this.renderer.settings.display.barsPerRow)for(let e=0;e<this._groups.length;e++){var t=this._groups[e];this.fitGroup(t),s+=this.paintGroup(t,a)}else{this._groups=[];let t=0;var r=this.maxWidth;let i=this.createEmptyStaveGroup();for(i.index=this._groups.length,i.x=this._pagePadding[0],i.y=s;t<this._allMasterBarRenderers.length;){let e=this._allMasterBarRenderers[t];if(i.width+e.width<=r||0===i.masterBarsRenderers.length)i.addMasterBarRenderers(this.renderer.tracks,e),t++;else{for(;e&&!e.canWrap&&1<i.masterBarsRenderers.length;)e=i.revertLastBar(),t--;i.isFull=!0,i.isLast=this.lastBarIndex===i.lastBarIndex,this._groups.push(i),this.fitGroup(i),s+=this.paintGroup(i,a),(i=this.createEmptyStaveGroup()).index=this._groups.length,i.x=this._pagePadding[0],i.y=s}}i.isLast=this.lastBarIndex===i.lastBarIndex,this.fitGroup(i),s+=this.paintGroup(i,a)}return s}layoutAndRenderScore(e){let t=this.firstBarIndex;var i=this.lastBarIndex;for(this._groups=[];t<=i;){var s=this.createStaveGroup(t,i);this._groups.push(s),s.x=this._pagePadding[0],s.y=e,t=s.lastBarIndex+1,this.fitGroup(s),C.debug(this.name,"Rendering partial from bar "+s.firstBarIndex+" to "+s.lastBarIndex,null),e+=this.paintGroup(s,e)}return e}paintGroup(t,e){var i=Math.floor(t.height+20*this.scale);const s=new ss;return s.x=0,s.y=t.y,s.totalWidth=this.width,s.totalHeight=e,s.width=this.width,s.height=i,s.firstMasterBarIndex=t.firstBarIndex,s.lastMasterBarIndex=t.lastBarIndex,t.buildBoundingsLookup(0,0),this.registerPartial(s,e=>{this.renderer.canvas.color=this.renderer.settings.display.resources.mainGlyphColor,this.renderer.canvas.textAlign=N.Left,t.paint(0,-s.y,e)}),e+=i,i}fitGroup(e){e.isFull||e.width>this.maxWidth?e.scaleToWidth(this.maxWidth):e.scaleToWidth(e.width),e.finalizeGroup()}createStaveGroup(e,t){var i=this.createEmptyStaveGroup(),s=(i.index=this._groups.length,this.renderer.settings.display.barsPerRow),a=this.maxWidth,r=t+1;let n=e;for(;n<r;){if(0<this._barsFromPreviousGroup.length)for(var o of this._barsFromPreviousGroup)i.addMasterBarRenderers(this.renderer.tracks,o),n=o.masterBar.index;else{var h=i.addBars(this.renderer.tracks,n);h&&this._allMasterBarRenderers.push(h)}let e=!(this._barsFromPreviousGroup=[]);if(e=-1===s&&i.width>=a&&0!==i.masterBarsRenderers.length||i.masterBarsRenderers.length===s+1?!0:e){let e=i.revertLastBar();if(e)for(this._barsFromPreviousGroup.push(e);e&&!e.canWrap&&1<i.masterBarsRenderers.length;)(e=i.revertLastBar())&&this._barsFromPreviousGroup.push(e);return i.isFull=!0,i.isLast=!1,this._barsFromPreviousGroup.reverse(),i}i.x=0,n++}return i.isLast=t===i.lastBarIndex,i}get maxWidth(){return this.renderer.width-this._pagePadding[0]-this._pagePadding[2]}}Ir.PagePadding=[40,40,40,40],Ir.GroupSpacing=20;class Rr extends Ns{constructor(e,t,i,s=!1){super(e,t,s?R.GraceScale:1,Rr.getMusicSymbol(i)),this._isGrace=s,this._accidentalType=i}static getMusicSymbol(e){switch(e){case Gs.Natural:return k.AccidentalNatural;case Gs.Sharp:return k.AccidentalSharp;case Gs.Flat:return k.AccidentalFlat;case Gs.NaturalQuarterNoteUp:return k.AccidentalQuarterToneNaturalArrowUp;case Gs.SharpQuarterNoteUp:return k.AccidentalQuarterToneSharpArrowUp;case Gs.FlatQuarterNoteUp:return k.AccidentalQuarterToneFlatArrowUp;case Gs.DoubleSharp:return k.AccidentalDoubleSharp;case Gs.DoubleFlat:return k.AccidentalDoubleFlat}return k.None}doLayout(){this._accidentalType===Gs.DoubleFlat?this.width=18:this.width=8,this.width=this.width*(this._isGrace?R.GraceScale:1)*this.scale}}class Ar extends Ts{constructor(e,t,i){super(e,t),this._number=0,this._number=i}doLayout(){this.renderer.scoreRenderer.canvas.font=this.renderer.resources.barNumberFont,this.width=this.renderer.scoreRenderer.canvas.measureText(this._number.toString())+5*this.scale}paint(e,t,i){var s,a;this.renderer.staff.isFirstInAccolade&&(s=this.renderer.resources,a=i.color,i.color=s.barNumberColor,i.font=s.barNumberFont,i.fillText(this._number.toString(),e+this.x,t+this.y),i.color=a)}}class Or extends Ts{constructor(e,t){super(e,t)}doLayout(){this.renderer.isLast?this.width=15*this.scale:this.renderer.nextRenderer&&this.renderer.nextRenderer.staff===this.renderer.staff&&this.renderer.nextRenderer.bar.masterBar.isRepeatStart?this.width=2*this.scale:(this.width=2*this.scale,this.renderer.bar.masterBar.isDoubleBar&&(this.width+=2*this.scale))}paint(e,t,i){var s=4*this.scale,a=t+this.y+this.renderer.topPadding,t=t+this.y+this.renderer.height-this.renderer.bottomPadding,e=e+this.x,t=t-a;this.renderer.isLast?(i.fillRect(e+this.width-s-s,a,this.scale,t),i.fillRect(e+this.width-s,a,s,t)):this.renderer.nextRenderer&&this.renderer.nextRenderer.staff===this.renderer.staff&&this.renderer.nextRenderer.bar.masterBar.isRepeatStart||(i.fillRect(e+this.width-this.scale,a,this.scale,t),this.renderer.bar.masterBar.isDoubleBar&&i.fillRect(e+this.width-5*this.scale,a,this.scale,t))}}class Gr extends Ns{constructor(e,t,i,s){super(e,t,1,Gr.getSymbol(i)),this._clef=i,this._clefOttava=s}doLayout(){switch(this._clef){case c.Neutral:this.width=15*this.scale;break;case c.C3:case c.C4:case c.F4:case c.G2:this.width=28*this.scale}}static getSymbol(e){switch(e){case c.Neutral:return k.UnpitchedPercussionClef1;case c.C3:case c.C4:return k.CClef;case c.F4:return k.FClef;case c.G2:return k.GClef;default:return k.None}}paint(e,t,i){super.paint(e,t,i);let s,a=!1;switch(this._clefOttava){case W._15ma:s=new Ns(-4*this.scale,0,.5,k.Quindicesima),a=!0;break;case W._8va:s=new Ns(-2*this.scale,0,.5,k.Ottava),a=!0;break;case W._8vb:s=new Ns(-6*this.scale,0,.5,k.Ottava);break;case W._15mb:s=new Ns(-8*this.scale,0,.5,k.Quindicesima);break;default:return}let r=0,n=0;switch(this._clef){case c.Neutral:r=a?-12:15,n=0;break;case c.C3:case c.C4:r=a?-19:27,n=0;break;case c.F4:r=a?-9:27,n=-4;break;case c.G2:r=a?-37:30,n=0;break;default:return}s.renderer=this.renderer,s.doLayout();var o=this.width/2;s.paint(e+this.x+o+n*this.scale,t+this.y+r*this.scale,i)}}class Hr extends Ts{constructor(e,t){super(e,t)}doLayout(){this.width=11*this.scale}paint(e,t,i){var s=4*this.scale,a=t+this.y+this.renderer.topPadding,t=t+this.y+this.renderer.height-this.renderer.bottomPadding,e=e+this.x,r=t-a,n=1.5*this.scale,o=(a+t)/2;i.fillCircle(e,o-3*n,n),i.fillCircle(e,o+3*n,n),e+=4*this.scale,i.beginPath(),i.moveTo(e,a),i.lineTo(e,t),i.stroke(),e+=3*this.scale+.5,i.fillRect(e,a,s,r)}}class Vr extends Ts{constructor(e,t,i){super(e,t),this._count=0,this._count=0,this._count=i}doLayout(){this.width=0}paint(e,t,i){var s=this.renderer.resources,a=i.textAlign,s=(i.font=s.barNumberFont,i.textAlign=N.Right,"x"+this._count),r=i.measureText(s)/1.5;i.fillText(s,e+this.x-r,t+this.y),i.textAlign=a}}class Wr extends Ts{constructor(e,t,i,s){super(e,t),this._dotOffset=0,this._circleSize=0,this._dotOffset=0,this._circleSize=0,this._dotOffset=s,this._circleSize=i}doLayout(){this.width=13*this.scale}paint(e,t,i){var s=4*this.scale,a=t+this.y+this.renderer.topPadding,t=t+this.y+this.renderer.height-this.renderer.bottomPadding,e=e+this.x+.5,s=(i.fillRect(e,a,s,t-a),e+=2*s-.5,i.beginPath(),i.moveTo(e,a),i.lineTo(e,t),i.stroke(),e+=3*this.scale,this._circleSize*this.scale),a=(a+t)/2;i.fillCircle(e,a-s*this._dotOffset,s),i.fillCircle(e,a+s*this._dotOffset,s)}}class zr extends Ns{constructor(e,t,i){super(e,t,1,zr.getSymbol(i))}static getSymbol(e){switch(e){case H.None:return k.None;case H.Normal:return k.ArticAccentAbove;case H.Heavy:return k.ArticMarcatoAbove;default:return k.None}}doLayout(){this.width=9*this.scale,this.height=9*this.scale}paint(e,t,i){super.paint(e-2*this.scale,t+this.height,i)}}class Ur extends Ts{constructor(e,t,i){super(e,t),this._size=0,this._size=i}doLayout(){this.width=this._size+3*this.scale}paint(e,t,i){i.fillCircle(e+this.x,t+this.y,this._size)}}class Xr extends Ns{constructor(e,t,i){super(e,t,i?R.GraceScale:1,k.NoteheadXOrnate),this._isGrace=i}doLayout(){this.width=9*(this._isGrace?R.GraceScale:1)*this.scale,this.height=R.NoteHeadHeight*this.scale}}class Yr extends Ns{constructor(e,t,i,s){super(e,t,s?R.GraceScale:1,Yr.getSymbol(i)),this._isGrace=s}static getSymbol(e){switch(e){case x.QuadrupleWhole:case x.DoubleWhole:case x.Whole:case x.Half:return k.NoteheadDiamondWhiteWide;default:return k.NoteheadDiamondBlackWide}}doLayout(){this.width=9*(this._isGrace?R.GraceScale:1)*this.scale,this.height=R.NoteHeadHeight*this.scale}}class qr extends Ts{constructor(e,t,i){super(0,0),this.yOffset=0,this.startNoteRenderer=null,this.endNoteRenderer=null,this.tieDirection=E.Up,this._startX=0,this._startY=0,this._endX=0,this._endY=0,this._tieHeight=0,this._shouldDraw=!1,this.startBeat=e,this.endBeat=t,this.forEnd=i}doLayout(){var e,t;this.width=0,this.endBeat?(e=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,this.startBeat.voice.bar),this.startNoteRenderer=e,t=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,this.endBeat.voice.bar),this.endNoteRenderer=t,this._startX=0,this._endX=0,this._startY=0,this._endY=0,this.height=0,this._shouldDraw=!1,this.tieDirection=e?this.getBeamDirection(this.startBeat,e):this.getBeamDirection(this.endBeat,t),!this.forEnd&&e?(e!==t?(this._startX=e.x+this.getStartX(),this._startY=e.y+this.getStartY()+this.yOffset,t&&e.staff===t.staff?(this._endX=t.x+this.getEndX(),this._endY=t.y+this.getEndY()+this.yOffset):(this._endX=e.x+e.width,this._endY=this._startY)):(this._startX=e.x+this.getStartX(),this._endX=t.x+this.getEndX(),this._startY=e.y+this.getStartY()+this.yOffset,this._endY=t.y+this.getEndY()+this.yOffset),this._shouldDraw=!0):e&&e.staff===t.staff||(this._startX=t.x,this._endX=t.x+this.getEndX(),this._startY=t.y+this.getEndY()+this.yOffset,this._endY=this._startY,this._shouldDraw=!0),this._shouldDraw&&(this.y=Math.min(this._startY,this._endY),this.shouldDrawBendSlur()?this._tieHeight=0:(this._tieHeight=this.getTieHeight(this._startX,this._startY,this._endX,this._endY),this.height=qr.calculateActualTieHeight(this.renderer.scale,this._startX,this._startY,this._endX,this._endY,this.tieDirection===E.Down,this._tieHeight,4).h),this.tieDirection===E.Up)&&(this.y-=this.height)):this._shouldDraw=!1}paint(e,t,i){this._shouldDraw&&(this.shouldDrawBendSlur()?qr.drawBendSlur(i,e+this._startX,t+this._startY,e+this._endX,t+this._endY,this.tieDirection===E.Down,this.scale):qr.paintTie(i,this.scale,e+this._startX,t+this._startY,e+this._endX,t+this._endY,this.tieDirection===E.Down,this._tieHeight,4))}shouldDrawBendSlur(){return!1}getTieHeight(e,t,i,s){return 22}getBeamDirection(e,t){return E.Down}getStartY(){return 0}getEndY(){return 0}getStartX(){return 0}getEndX(){return 0}static calculateActualTieHeight(e,t,i,s,a,r,n,o){var e=qr.computeBezierControlPoints(e,t,i,s,a,r,n,o),r=(t=e[0],i=e[1],e[2]),n=e[3],o=(s=e[6],a=e[7],(t-r)/(t-2*r+s)),e=qr.calculateExtrema(t,i,r,n,s,a,o),o=0<e.length?Math.min(t,s,e[0]):Math.min(t,s),e=0<e.length?Math.max(t,s,e[0]):Math.max(t,s),h=(i-n)/(i-2*n+a),t=qr.calculateExtrema(t,i,r,n,s,a,h),r=0<t.length?Math.min(i,a,t[1]):Math.min(i,a),n=0<t.length?Math.max(i,a,t[1]):Math.max(i,a),s=new Ze;return s.x=o,s.y=r,s.w=e-o,s.h=n-r,s}static calculateExtrema(e,t,i,s,a,r,n){return n<=0||1<=n?[]:[(e=e+(i-e)*n)+(i+(a-i)*n-e)*n,(a=t+(s-t)*n)+(s+(r-s)*n-a)*n]}static computeBezierControlPoints(e,t,i,s,a,r,n,o){if(t===s&&i===a)return[];s<t&&(d=t,t=s,s=d,d=i,i=a,a=d),n*=e,o*=e;let h=a-i,l=s-t;var d=Math.sqrt(h*h+l*l),e=(r?h*=-1:l*=-1,h/=d,l/=d,(s+t)/2),r=(a+i)/2;return[t,i,e+n*h,r+n*l,e+(n-o)*h,r+(n-o)*l,s,a]}static paintTie(e,t,i,s,a,r,n=!1,o=22,h=4){t=qr.computeBezierControlPoints(t,i,s,a,r,n,o,h);e.beginPath(),e.moveTo(t[0],t[1]),e.quadraticCurveTo(t[2],t[3],t[6],t[7]),e.quadraticCurveTo(t[4],t[5],t[0],t[1]),e.closePath(),e.fill()}static drawBendSlur(e,t,i,s,a,r,n,o){let h=a-i,l=s-t;var d=Math.sqrt(h*h+l*l),d=(r?h*=-1:l*=-1,h/=d,l/=d,(s+t)/2),c=(a+i)/2;let u=qr.BendSlurHeight*n;s-t<20&&(u/=2);n=d+u*h,d=c+u*l;e.beginPath(),e.moveTo(t,i),e.lineTo(n,d),e.lineTo(s,a),e.stroke(),o&&(c=e.measureText(o),t=r?0:-e.font.size,e.fillText(o,n-c/2,d+t))}}qr.BendSlurHeight=11;class Jr extends Ts{constructor(e){super(0,0),this._isOpen=e}doLayout(){super.doLayout(),this.width=Jr.Size*this.scale}paint(e,t,i){this._isOpen?qr.paintTie(i,this.scale,e+this.x+this.width,t+this.y+this.height,e+this.x+this.width,t+this.y,!1,6,3):qr.paintTie(i,this.scale,e+this.x,t+this.y,e+this.x,t+this.y+this.height,!1,6,3)}}Jr.Size=6;class jr{constructor(e,t){this.line=0,this.line=e,this.isGhost=t}}class Qr extends Ts{constructor(e){super(0,0),this._infos=[],this._glyphs=[],this.isEmpty=!0,this._isOpen=e}addParenthesis(e){var t=this.renderer,i=t.getNoteLine(e),e=e.isGhost||this.isTiedBend(e)&&t.settings.notation.isNotationElementVisible(f.ParenthesisOnTiedBends);this.addParenthesisOnLine(i,e)}addParenthesisOnLine(e,t){e=new jr(e,t);this._infos.push(e),t&&(this.isEmpty=!1)}isTiedBend(e){return!!e.isTieDestination&&(!!e.tieOrigin.hasBend||this.isTiedBend(e.tieOrigin))}doLayout(){var i=this.renderer;this._infos.sort((e,t)=>e.line-t.line);let s=null;var a,r=i.getScoreHeight(1);for(let e=0,t=this._infos.length;e<t;e++)this._infos[e].isGhost?s?(a=i.getScoreY(this._infos[e].line)+r,s.height=a-s.y):((a=new Jr(this._isOpen)).renderer=this.renderer,a.y=i.getScoreY(this._infos[e].line)-r,a.height=2*r,a.doLayout(),this._glyphs.push(a),s=a):s=null;this.width=0<this._glyphs.length?this._glyphs[0].width:0}paint(e,t,i){super.paint(e,t,i);for(var s of this._glyphs)s.paint(e+this.x,t+this.y,i)}}class Kr{constructor(e,t){this.line=0,this.glyph=e,this.line=t}}class $r extends Ts{constructor(){super(0,0),this._infos=[],this._noteHeadPadding=0,this.minNote=null,this.maxNote=null,this.spacingChanged=new hi,this.upLineX=0,this.downLineX=0,this.displacedX=0,this.noteStartX=0}add(e,t){e=new Kr(e,t);this._infos.push(e),(!this.minNote||this.minNote.line>e.line)&&(this.minNote=e),(!this.maxNote||this.maxNote.line<e.line)&&(this.maxNote=e)}get hasTopOverflow(){return!!this.minNote&&this.minNote.line<=0}get hasBottomOverflow(){return!!this.maxNote&&8<this.maxNote.line}doLayout(){this._infos.sort((e,t)=>t.line-e.line);let i=0,s=!1,a=0,r=!1;var n=this.direction;let o=0;for(let t=0,e=this._infos.length;t<e;t++){var h=this._infos[t].glyph;h.renderer=this.renderer,h.doLayout();let e=!1;0===t?i=h.width:s=Math.abs(a-this._infos[t].line)<=1&&!s&&(e=!0,h.x=i,r=!0),n===E.Down?h.x=e?0:i:h.x=e?i:0,h.x+=this.noteStartX,a=this._infos[t].line,o=Math.max(o,h.x+h.width)}r?(this._noteHeadPadding=0,this.upLineX=i,this.downLineX=i):(this._noteHeadPadding=n===E.Down?-i:0,o+=this._noteHeadPadding,this.upLineX=o,this.downLineX=0),this.displacedX=i,this.width=o}paint(t,i,s){t+=this.x,i+=this.y;var a=this.renderer,r=3*this.scale,n=this.width-this.noteStartX+2*r;if(this.hasTopOverflow){var o=s.color;s.color=a.resources.staffLineColor;let e=-2;for(;e>=this.minNote.line;){var h=i+a.getScoreY(e);s.fillRect(t-r+this.noteStartX,h,n,this.scale),e-=2}s.color=o}if(this.hasBottomOverflow){o=s.color;s.color=a.resources.staffLineColor;let e=10;for(;e<=this.maxNote.line;){var l=i+a.getScoreY(e);s.fillRect(t-r+this.noteStartX,l,n,this.scale),e+=2}s.color=o}var e,d,o=this._infos,c=t+this._noteHeadPadding;for([e,d]of o.entries())d.glyph.renderer=this.renderer,this._notes&&(s.color=Be.getNoteColor(this._notes[e].realValue)),d.glyph.paint(c,i,s),s.color=this.renderer.resources.mainGlyphColor}}class Zr extends Ns{constructor(e,t,i){super(e,t,1,Zr.getSymbol(i))}doLayout(){this.width=12*this.scale}static getSymbol(e){switch(e){case x.ThirtySecond:return k.Tremolo3;case x.Sixteenth:return k.Tremolo2;case x.Eighth:return k.Tremolo1;default:return k.None}}}class en extends $r{constructor(){super(),this._noteGlyphLookup=new Map,this._notes=[],this._tremoloPicking=null,this.aboveBeatEffects=new Map,this.belowBeatEffects=new Map}get direction(){return this.beamingHelper.direction}getNoteX(t,i){if(this._noteGlyphLookup.has(t.id)){var s=this._noteGlyphLookup.get(t.id);let e=this.x+s.x+this._noteHeadPadding;switch(i){case Hs.Left:break;case Hs.Center:e+=s.width/2;break;case Hs.Right:e+=s.width}return e}return 0}getNoteY(t,i){if(this._noteGlyphLookup.has(t.id)){var s=this._noteGlyphLookup.get(t.id);let e=this.y+s.y;switch(i){case A.TopWithStem:e-=this.renderer.getStemSize(this.beamingHelper);break;case A.Top:e-=s.height/2;break;case A.Center:break;case A.Bottom:e+=s.height/2;break;case A.BottomWithStem:e+=this.renderer.getStemSize(this.beamingHelper)}return e}return 0}addNoteGlyph(e,t,i){super.add(e,i),this._noteGlyphLookup.set(t.id,e),this._notes.push(t)}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,e+this.x+this.upLineX,e+this.x+this.downLineX)}doLayout(){super.doLayout();var t=this.direction;for(const e of this.aboveBeatEffects.values())e.renderer=this.renderer,e.doLayout();for(const r of this.belowBeatEffects.values())r.renderer=this.renderer,r.doLayout();if(this.beat.isTremolo){let e=0;var i=t===E.Up?this.minNote:this.maxNote,s=t===E.Up?this.displacedX:0,a=this.beat.tremoloSpeed;switch(a){case x.ThirtySecond:e=t===E.Up?-15:15;break;case x.Sixteenth:e=t===E.Up?-12:15;break;case x.Eighth:e=t===E.Up?-10:10;break;default:e=t===E.Up?-10:15}this._tremoloPicking=new Zr(s,i.glyph.y+e*this.scale,a),this._tremoloPicking.renderer=this.renderer,this._tremoloPicking.doLayout()}}buildBoundingsLookup(e,t,i){for(var s of this._notes){var a,r;this._noteGlyphLookup.has(s.id)&&(a=this._noteGlyphLookup.get(s.id),(r=new os).note=s,r.noteHeadBounds=new Ze,r.noteHeadBounds.x=t+this.x+this._noteHeadPadding+a.x,r.noteHeadBounds.y=i+this.y+a.y-a.height/2,r.noteHeadBounds.w=a.width,r.noteHeadBounds.h=a.height,e.addNote(r))}}paint(e,t,i){var s=this.renderer;let a=0,r=0,n=1,o=-n;this.beamingHelper.direction===E.Up?(r=s.getScoreY(this.minNote.line),a=s.getScoreY(this.maxNote.line-2)):(r=s.getScoreY(this.maxNote.line-1),a=s.getScoreY(this.minNote.line+1),o*=-1,n*=-1);for(const h of this.aboveBeatEffects.values())a+=o*h.height,h.paint(e+this.x+2*this.scale,t+this.y+a,i);for(const l of this.belowBeatEffects.values())r+=n*l.height,l.paint(e+this.x+2*this.scale,t+this.y+r,i);super.paint(e,t,i),this._tremoloPicking&&this._tremoloPicking.paint(e,t,i)}}class tn extends Ns{constructor(e,t,i){super(e,t,1,tn.getSymbol(i)),this._duration=i}static getSymbol(e){switch(e){case x.QuadrupleWhole:return k.RestLonga;case x.DoubleWhole:return k.RestDoubleWhole;case x.Whole:return k.RestWhole;case x.Half:return k.RestHalf;case x.Quarter:return k.RestQuarter;case x.Eighth:return k.RestEighth;case x.Sixteenth:return k.RestSixteenth;case x.ThirtySecond:return k.RestThirtySecond;case x.SixtyFourth:return k.RestSixtyFourth;case x.OneHundredTwentyEighth:return k.RestOneHundredTwentyEighth;case x.TwoHundredFiftySixth:return k.RestTwoHundredFiftySixth;default:return k.None}}static getSize(e){switch(e){case x.QuadrupleWhole:case x.DoubleWhole:case x.Whole:case x.Half:case x.Quarter:case x.Eighth:case x.Sixteenth:return 9;case x.ThirtySecond:return 12;case x.SixtyFourth:return 14;case x.OneHundredTwentyEighth:case x.TwoHundredFiftySixth:return 20}return 10}doLayout(){this.width=tn.getSize(this._duration)*this.scale}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.registerBeatLineX("score",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}}class sn{constructor(){this.x=0,this.y=-3e3,this.width=0}}class an extends ha{constructor(){super(0,0)}doLayout(){if(this.glyphs&&0!==this.glyphs.length){this.glyphs.sort((e,t)=>e.y<t.y?-1:e.y>t.y?1:0);var i=[],s=(i.push(new sn),21*this.scale);for(let t=0,e=this.glyphs.length;t<e;t++){var a=this.glyphs[t];a.renderer=this.renderer,a.doLayout();let e=0;for(;i[e].y>a.y;)++e===i.length&&i.push(new sn);i[a.x=e].y=a.y+s,i[e].width<a.width&&(i[e].width=a.width)}this.width=0;for(const e of i)this.width+=e.width,e.x=this.width;for(let e=0,t=this.glyphs.length;e<t;e++){var r=this.glyphs[e],n=i[r.x];r.x=this.width-n.x}}else this.width=0}}class rn extends $r{constructor(e,t=!1){super(),this._showParenthesis=!1,this._noteValueLookup=new Map,this._accidentals=new an,this._preNoteParenthesis=null,this._postNoteParenthesis=null,this.isEmpty=!0,this.noteHeadOffset=0,this._beat=e,(this._showParenthesis=t)&&(this._preNoteParenthesis=new Qr(!0),this._postNoteParenthesis=new Qr(!1))}get direction(){return E.Up}containsNoteValue(e){return this._noteValueLookup.has(e)}getNoteValueY(e){return this._noteValueLookup.has(e)?this.y+this._noteValueLookup.get(e).y:0}addGlyph(e,t=!1){var i=this.renderer,s=new R(0,0,x.Quarter,!0),t=i.accidentalHelper.applyAccidentalForValue(this._beat,e,t,!0),a=i.accidentalHelper.getNoteLineForValue(e,!1);s.y=i.getScoreY(a),this._showParenthesis&&(this._preNoteParenthesis.renderer=this.renderer,this._postNoteParenthesis.renderer=this.renderer,this._preNoteParenthesis.addParenthesisOnLine(a,!0),this._postNoteParenthesis.addParenthesisOnLine(a,!0)),t!==Gs.None&&((i=new Rr(0,s.y,t,!0)).renderer=this.renderer,this._accidentals.renderer=this.renderer,this._accidentals.addGlyph(i)),this._noteValueLookup.set(e,s),this.add(s,a),this.isEmpty=!1}doLayout(){let e=0;this._showParenthesis&&(this._preNoteParenthesis.x=e,this._preNoteParenthesis.renderer=this.renderer,this._preNoteParenthesis.doLayout(),e+=this._preNoteParenthesis.width+rn.ElementPadding*this.scale),this._accidentals.isEmpty||(e+=this._accidentals.width+rn.ElementPadding*this.scale,this._accidentals.x=e,this._accidentals.renderer=this.renderer,this._accidentals.doLayout(),e+=this._accidentals.width+rn.ElementPadding*this.scale),this.noteStartX=e,super.doLayout(),this.noteHeadOffset=this.noteStartX+(this.width-this.noteStartX)/2,this._showParenthesis&&(this._postNoteParenthesis.x=this.width+rn.ElementPadding*this.scale,this._postNoteParenthesis.renderer=this.renderer,this._postNoteParenthesis.doLayout(),this.width+=this._postNoteParenthesis.width+rn.ElementPadding*this.scale)}paint(e,t,i){this._accidentals.isEmpty||this._accidentals.paint(e+this.x,t+this.y,i),this._showParenthesis&&(this._preNoteParenthesis.paint(e+this.x,t+this.y,i),this._postNoteParenthesis.paint(e+this.x,t+this.y,i)),super.paint(e,t,i)}}rn.ElementPadding=2;class nn extends Ts{constructor(){super(...arguments),this.BendNoteHeads=[]}drawBendSlur(e,t,i,s,a,r,n,o){qr.drawBendSlur(e,t,i,s,a,r,n,o)}doLayout(){super.doLayout(),this.width=0;for(var e of this.BendNoteHeads)e.doLayout(),this.width+=e.width+10*this.scale}getTieDirection(e,t){return t.getBeatDirection(e)!==E.Up?E.Up:E.Down}}nn.EndPadding=8;class on extends B{constructor(e=0,t=0){super(e,t),this.lineValue=0,this.lineValue=t}}class hn extends Ts{constructor(){super(0,0),this._notes=[],this._renderPoints=new Map,this._preBendMinValue=-1,this._bendMiddleMinValue=-1,this._bendEndMinValue=-1,this._bendEndContinuedMinValue=-1,this._releaseMinValue=-1,this._releaseContinuedMinValue=-1,this._maxBendValue=-1}addBends(e){this._notes.push(e);var t=this.createRenderingPoints(e);this._renderPoints.set(e.id,t),(-1===this._maxBendValue||this._maxBendValue<e.maxBendPoint.value)&&(this._maxBendValue=e.maxBendPoint.value);let i=0;switch(e.bendType){case w.Bend:i=t[1].value,e.isTieOrigin?(-1===this._bendEndContinuedMinValue||i<this._bendEndContinuedMinValue)&&(this._bendEndContinuedMinValue=i):(-1===this._bendEndMinValue||i<this._bendEndMinValue)&&(this._bendEndMinValue=i);break;case w.Release:i=t[1].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||i<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=i):0<i&&(-1===this._releaseMinValue||i<this._releaseMinValue)&&(this._releaseMinValue=i);break;case w.BendRelease:i=t[1].value,(-1===this._bendMiddleMinValue||i<this._bendMiddleMinValue)&&(this._bendMiddleMinValue=i),i=t[2].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||i<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=i):0<i&&(-1===this._releaseMinValue||i<this._releaseMinValue)&&(this._releaseMinValue=i);break;case w.Prebend:i=t[0].value,(-1===this._preBendMinValue||i<this._preBendMinValue)&&(this._preBendMinValue=i);break;case w.PrebendBend:i=t[0].value,(-1===this._preBendMinValue||i<this._preBendMinValue)&&(this._preBendMinValue=i),i=t[1].value,e.isTieOrigin?(-1===this._bendEndContinuedMinValue||i<this._bendEndContinuedMinValue)&&(this._bendEndContinuedMinValue=i):(-1===this._bendEndMinValue||i<this._bendEndMinValue)&&(this._bendEndMinValue=i);break;case w.PrebendRelease:i=t[0].value,(-1===this._preBendMinValue||i<this._preBendMinValue)&&(this._preBendMinValue=i),i=t[1].value,e.isTieOrigin?(-1===this._releaseContinuedMinValue||i<this._releaseContinuedMinValue)&&(this._releaseContinuedMinValue=i):0<i&&(-1===this._releaseMinValue||i<this._releaseMinValue)&&(this._releaseMinValue=i)}}doLayout(){super.doLayout();var e,t=this._maxBendValue*hn.BendValueHeight*this.scale;this.renderer.registerOverflowTop(t);let i=0;for(e of this._notes){var s=this._renderPoints.get(e.id);switch(e.bendType){case w.Bend:s[1].lineValue=e.isTieOrigin?this._bendEndContinuedMinValue:this._bendEndMinValue;break;case w.Release:0<=(i=e.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue)&&(s[1].lineValue=i);break;case w.BendRelease:s[1].lineValue=this._bendMiddleMinValue,0<=(i=e.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue)&&(s[2].lineValue=i);break;case w.Prebend:s[0].lineValue=this._preBendMinValue;break;case w.PrebendBend:s[0].lineValue=this._preBendMinValue,s[1].lineValue=e.isTieOrigin?this._bendEndContinuedMinValue:this._bendEndMinValue;break;case w.PrebendRelease:s[0].lineValue=this._preBendMinValue,0<=(i=e.isTieOrigin?this._releaseContinuedMinValue:this._releaseMinValue)&&(s[1].lineValue=i)}}this.width=0,this._notes.sort((e,t)=>e.isStringed?e.string-t.string:e.realValue-t.realValue)}createRenderingPoints(e){var t=[];switch(e.bendType){case w.Custom:for(var i of e.bendPoints)t.push(new on(i.offset,i.value));break;case w.BendRelease:t.push(new on(0,e.bendPoints[0].value)),t.push(new on(B.MaxPosition/2|0,e.bendPoints[1].value)),t.push(new on(B.MaxPosition,e.bendPoints[3].value));break;case w.Bend:case w.Hold:case w.Prebend:case w.PrebendBend:case w.PrebendRelease:case w.Release:t.push(new on(0,e.bendPoints[0].value)),t.push(new on(B.MaxPosition,e.bendPoints[1].value))}return t}paint(o,h,l){var d,c=l.color;1<this._notes.length&&(l.color=this.renderer.resources.secondaryGlyphColor);for(d of this._notes){var u=this._renderPoints.get(d.id),p=this.renderer;let e=d,t=!1,i=null,s=!1;var g=d.bendStyle===z.Gradual?"grad.":"";let a=null;for(;e.isTieOrigin;){var m=e.tieDestination;if(!(i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,m.beat.voice.bar))||p.staff!==i.staff)break;if(e=m,t=!0,e.hasBend||!this.renderer.settings.notation.extendBendArrowsOnTiedNotes){s=!0;break}}a=e.beat,i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,a.voice.bar),a.isLastOfVoice&&!e.hasBend&&this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&(a=null);let r=0,n=0;var f=h+p.y,y=(r=o+p.x,0<u[0].value||d.isContinuedBend?r+=p.getBeatX(d.beat,Os.MiddleNotes):r+=p.getNoteX(d,Hs.Right),n=!a||a.isLastOfVoice&&!s?o+i.x+i.postBeatGlyphsStart:s||!a.nextBeat?o+i.x+i.getBeatX(a,Os.MiddleNotes):d.bendType===w.Hold?o+i.x+i.getBeatX(a.nextBeat,Os.OnNotes):o+i.x+i.getBeatX(a.nextBeat,Os.PreNotes),t||(n-=hn.ArrowSize*this.scale),n-r),b=y/B.MaxPosition;l.beginPath();for(let e=0,t=u.length-1;e<t;e++){var S=u[e],_=u[e+1];0!==e||0===S.value||d.isTieDestination||this.paintBend(d,new on(0,0),S,r,f,b,g,l),d.bendType!==w.Prebend?(0===e&&(r+=2*this.scale),this.paintBend(d,S,_,r,f,b,g,l)):d.isTieOrigin&&d.tieDestination.hasBend&&((_=new on(B.MaxPosition,S.value)).lineValue=S.lineValue,this.paintBend(d,S,_,r,f,b,g,l))}l.color=c}}paintBend(i,s,a,r,n,o,h,l){var d=this.renderer,c=this.renderer.resources,u=d.lineOffset/2,p=r+o*s.offset,g=hn.BendValueHeight*this.scale;let m=n-g*s.lineValue;0===s.value?a.offset===s.offset?m+=d.getNoteY(i.beat.maxStringNote,A.Top):m+=d.getNoteY(i,A.Center):m+=u;r+=o*a.offset;let f=n-g*a.lineValue,e=(0===a.lineValue?f+=d.getNoteY(i,A.Center):f+=u,0);o=hn.ArrowSize*this.scale;if(a.value>s.value?(f+o>m&&(f=m-o),l.beginPath(),l.moveTo(r,f),l.lineTo(r-.5*o,f+o),l.lineTo(r+.5*o,f+o),l.closePath(),l.fill(),e=o):a.value!==s.value&&(f<m&&(f=m+o),l.beginPath(),l.moveTo(r,f),l.lineTo(r-.5*o,f-o),l.lineTo(r+.5*o,f-o),l.closePath(),l.fill(),e=-o),l.stroke(),s.value===a.value){if(0<s.lineValue){let e=r;var t=hn.DashSize*this.scale,y=p+t;if((e-p)/(2*t)<1)l.moveTo(e,m),l.lineTo(p,m);else for(;e>y;)l.moveTo(e,m),l.lineTo(e-t,m),e-=2*t;l.stroke()}}else p<r?(l.moveTo(p,m),l.bezierCurveTo((p+r)/2,m,r,m,r,f+e)):(l.moveTo(p,m),l.lineTo(r,f)),l.stroke();if(h&&s.offset<a.offset){l.font=c.graceFont;d=l.measureText(h);let e=0,t=0;t=m>f?(i=Math.abs(m-f),e=i>1.3*l.font.size?m-i/2:m,(p+r-d)/2):(e=m,r-d),l.fillText(h,t,e)}if(0!==a.value&&s.value!==a.value){let e=a.value;u=a.value>s.value;let t="";if(4===(e=Math.abs(e))?(t="full",e-=4):(4<=e||e<=-4)&&(o=e/4|0,t+=o,e-=4*o),0<e&&(t+=hn.getFractionSign(e)),""!==t){let e=f=n-g*a.value;u||(e=m+ +Math.abs(f-m)/3),l.font=c.tablatureFont;i=l.measureText(t),p=e-.5*c.tablatureFont.size-2*this.scale;l.fillText(t,r-i/2,p)}}}static getFractionSign(e){switch(e){case 1:return"Â¼";case 2:return"Â½";case 3:return"Â¾";default:return e+"/ 4"}}}hn.ArrowSize=6,hn.DashSize=3,hn.BendValueHeight=6;class ln extends Ts{constructor(e){super(0,0),this._isSimpleDip=!1,this._beat=e,this._renderPoints=this.createRenderingPoints(e)}createRenderingPoints(e){if(e.whammyBarType===Q.Custom)return e.whammyBarPoints;var t=[];switch(e.whammyBarType){case Q.Dive:case Q.Hold:case Q.PrediveDive:case Q.Predive:t.push(new B(0,e.whammyBarPoints[0].value)),t.push(new B(B.MaxPosition,e.whammyBarPoints[1].value));break;case Q.Dip:t.push(new B(0,e.whammyBarPoints[0].value)),t.push(new B(B.MaxPosition/2|0,e.whammyBarPoints[1].value)),t.push(new B(B.MaxPosition,e.whammyBarPoints[e.whammyBarPoints.length-1].value))}return t}doLayout(){super.doLayout(),this._isSimpleDip=this.renderer.settings.notation.notationMode===T.NotationMode.SongBook&&this._beat.whammyBarType===Q.Dip;let e=null,t=null,i=this._beat;for(;i&&i.hasWhammyBar;)(!e||e.value>i.minWhammyPoint.value)&&(e=i.minWhammyPoint),(!t||t.value<i.maxWhammyPoint.value)&&(t=i.maxWhammyPoint),i=i.nextBeat;let s=0<t.value?Math.abs(this.getOffset(t.value)):0;(0<s||0!==this._beat.whammyBarPoints[0].value||this.renderer.settings.notation.isNotationElementVisible(f.ZerosOnDiveWhammys))&&(s+=2*this.renderer.resources.tablatureFont.size);var a=e.value<0?Math.abs(this.getOffset(e.value)):0,a=(this.renderer.registerOverflowTop(s+a),this.renderer.staff.getSharedLayoutData(ln.TopOffsetSharedDataKey,-1));s>a&&this.renderer.staff.setSharedLayoutData(ln.TopOffsetSharedDataKey,s)}getOffset(e){if(0===e)return 0;let t=ln.PerHalfSize*this.scale+Math.log2(Math.abs(e)/2)*ln.PerHalfSize*this.scale;return t=e<0?-t:t}paint(e,t,a){var i=this.renderer;let s=this._beat.nextBeat,r=null,n=Os.PreNotes,o=(s&&((r=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,s.voice.bar))&&r.staff===i.staff&&(r===i||s.hasWhammyBar)?n=!s.hasWhammyBar||i.settings.notation.notationMode===T.NotationMode.SongBook&&s.whammyBarType===Q.Dip?Os.PreNotes:Os.MiddleNotes:(s=null,r=null)),0),h=0;h=this._isSimpleDip?(o=e+i.x+i.getBeatX(this._beat,Os.OnNotes)-2*this.scale,e+i.x+i.getBeatX(this._beat,Os.PostNotes)+2*this.scale):(o=e+i.x+i.getBeatX(this._beat,Os.MiddleNotes),r?e+r.x+r.getBeatX(s,n):e+i.x+i.width-2*this.scale);e=a.textAlign;if(a.textAlign=N.Center,2<=this._renderPoints.length){var l=(h-o)/B.MaxPosition,d=(a.beginPath(),t+this.renderer.staff.getSharedLayoutData(ln.TopOffsetSharedDataKey,0));let s=this._beat.whammyStyle===z.Gradual?"grad.":"";for(let t=0,i=this._renderPoints.length-1;t<i;t++){var c=this._renderPoints[t],u=this._renderPoints[t+1],p=t<i-2?this._renderPoints[t+2]:null;let e=0===t;0!==t||0===c.value||this._beat.isContinuedWhammy||(this.paintWhammy(!1,new B(0,0),c,u,o,d,l,a),e=!1),this.paintWhammy(e,c,u,p,o,d,l,a,s),s=""}a.stroke()}a.textAlign=e}paintWhammy(e,i,s,a,r,n,o,h,l){var t=r+o*i.offset,r=r+o*s.offset,d=n-this.getOffset(i.value),o=n-this.getOffset(s.value);if(i.offset===s.offset){var c=ln.DashSize*this.scale;if(Math.abs(o-d)/(2*c)<1)h.moveTo(t,d),h.lineTo(r,o);else{var u=Math.max(d,o);let e=Math.min(d,o);for(;u>e;)h.moveTo(t,e),h.lineTo(t,e+c),e+=2*c}h.stroke()}else if(i.value===s.value){var p=ln.DashSize*this.scale;if(Math.abs(r-t)/(2*p)<1)h.moveTo(t,d),h.lineTo(r,o);else{let e=Math.max(t,r);for(var g=Math.min(t,r);e>g;)h.moveTo(e,d),h.lineTo(e-p,d),e-=2*p}h.stroke()}else h.moveTo(t,d),h.lineTo(r,o);n=this.renderer.resources;!e||this._beat.isContinuedWhammy||this._isSimpleDip||(e=d,e-=n.tablatureFont.size+2*this.scale,this.renderer.settings.notation.isNotationElementVisible(f.ZerosOnDiveWhammys)&&h.fillText("0",t,e),l&&(e-=n.tablatureFont.size+2*this.scale,h.fillText(l,t,e)));let m=Math.abs(s.value);if((0!==m||this.renderer.settings.notation.isNotationElementVisible(f.ZerosOnDiveWhammys)&&!this._isSimpleDip)&&i.value!==s.value){let e="";s.value<0&&(e+="-"),4<=m?(l=m/4|0,e+=l,m-=4*l):0===m&&(e+="0"),0<m&&(e+=hn.getFractionSign(m));let t=0;this._isSimpleDip?t=Math.min(d,o)-n.tablatureFont.size-2*this.scale:(t=i.offset===s.offset?Math.min(d,o):o,t-=n.tablatureFont.size+2*this.scale,a&&a.value>s.value&&(t-=2*this.scale)),h.fillText(e,r,t)}}}ln.TopOffsetSharedDataKey="tab.whammy.topoffset",ln.PerHalfSize=6,ln.DashSize=3;class dn extends nn{constructor(e){super(0,0),this._beat=e}doLayout(){var e=this.renderer.settings.notation.notationMode;switch(this._beat.whammyBarType){case Q.None:case Q.Custom:case Q.Hold:return;case Q.Dive:case Q.PrediveDive:var t,i=new rn(this._beat,!1),s=(i.renderer=this.renderer,this._beat.whammyBarPoints[this._beat.whammyBarPoints.length-1]);for(t of this._beat.notes)t.isTieOrigin||i.addGlyph(this.getBendNoteValue(t,s),s.value%2!=0);i.doLayout(),this.BendNoteHeads.push(i);break;case Q.Dip:if(e===T.NotationMode.SongBook){var a=this.renderer.resources;this.renderer.simpleWhammyOverflow=1.5*a.tablatureFont.size+dn.SimpleDipHeight*this.scale+dn.SimpleDipPadding*this.scale}else{var r=new rn(this._beat,!1);if(r.renderer=this.renderer,this.renderer.settings.notation.notationMode===T.NotationMode.GuitarPro){var n,o=this._beat.whammyBarPoints[1];for(n of this._beat.notes)r.addGlyph(this.getBendNoteValue(n,this._beat.whammyBarPoints[1]),o.value%2!=0)}r.doLayout(),this.BendNoteHeads.push(r);var h=new rn(this._beat,!1);if(h.renderer=this.renderer,this.renderer.settings.notation.notationMode===T.NotationMode.GuitarPro){var l,d=this._beat.whammyBarPoints[this._beat.whammyBarPoints.length-1];for(l of this._beat.notes)h.addGlyph(this.getBendNoteValue(l,d),d.value%2!=0)}h.doLayout(),this.BendNoteHeads.push(h)}break;case Q.Predive:}super.doLayout()}paint(o,h,l){var d=this._beat;switch(d.whammyBarType){case Q.None:case Q.Custom:return}var c=this.renderer.settings.notation.notationMode,u=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,d.voice.bar),p=o+u.x+u.getBeatX(d,Os.MiddleNotes),g=this.getTieDirection(d,u);let m=1===this._beat.notes.length?g:E.Up;var e=l.textAlign;for(let n=0;n<d.notes.length;n++){var f=d.notes[n];let e=h+u.y,t=((m=0<n&&n>=(this._beat.notes.length/2|0)?E.Down:m)===E.Down?e+=u.getNoteY(f,A.Bottom):e+=u.getNoteY(f,A.Top),o+u.x);d.isLastOfVoice?t+=u.width:t+=u.getBeatX(d,Os.EndBeat),t-=8*this.scale;var y=d.whammyStyle===z.Gradual&&0===n?"grad.":"";let i=null,s=(f.isTieOrigin&&((i=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,f.tieDestination.beat.voice.bar))&&i.staff===u.staff?t=o+i.x+i.getBeatX(f.tieDestination.beat,Os.MiddleNotes):i=null),R.NoteHeadHeight*this.scale*R.GraceScale*.5);m===E.Up&&(s=-s);var b,S,_,w=0<d.whammyBarPoints.length?this.getBendNoteValue(f,d.whammyBarPoints[d.whammyBarPoints.length-1]):0;let a=0,r=!1;switch(0<this.BendNoteHeads.length&&this.BendNoteHeads[0].containsNoteValue(w)?(a=this.BendNoteHeads[0].getNoteValueY(w)+s,r=!0):i&&(f.isTieOrigin&&f.tieDestination.beat.hasWhammyBar||f.beat.isContinuedWhammy)?(a=h+i.y+i.getNoteY(f.tieDestination,A.Top),r=!0,m===E.Down&&(a+=R.NoteHeadHeight*this.scale)):f.isTieOrigin&&(a=i?h+i.y+i.getNoteY(f.tieDestination,A.Top):e,m===E.Down)&&(a+=R.NoteHeadHeight*this.scale),d.whammyBarType){case Q.Hold:f.isTieOrigin&&qr.paintTie(l,this.scale,p,e,t,a,g===E.Down,22,4);break;case Q.Dive:0===n&&(this.BendNoteHeads[0].x=t-this.BendNoteHeads[0].noteHeadOffset,this.BendNoteHeads[0].y=h+u.y,this.BendNoteHeads[0].paint(0,0,l),this.BendNoteHeads[0].containsNoteValue(w))&&(a+=this.BendNoteHeads[0].y),r?this.drawBendSlur(l,p,e,t,a,m===E.Down,this.scale,y):f.isTieOrigin&&qr.paintTie(l,this.scale,p,e,t,a,g===E.Down,22,4);break;case Q.Dip:c===T.NotationMode.SongBook?(0===n&&(S=((b=o+u.x+u.getBeatX(this._beat,Os.OnNotes)-2*this.scale)+(v=o+u.x+u.getBeatX(this._beat,Os.PostNotes)+2*this.scale))/2,B=((this._beat.whammyBarPoints[1].value-this._beat.whammyBarPoints[0].value)/4|0).toString(),l.font=this.renderer.resources.tablatureFont,l.fillText(B,S,h+this.y),_=(B=h+this.y+l.font.size+2*this.scale)+dn.SimpleDipHeight*this.scale,this._beat.whammyBarPoints[1].value>this._beat.whammyBarPoints[0].value?(l.moveTo(b,_),l.lineTo(S,B),l.lineTo(v,_)):(l.moveTo(b,B),l.lineTo(S,_),l.lineTo(v,B)),l.stroke()),f.isTieOrigin&&qr.paintTie(l,this.scale,p,e,t,a,g===E.Down,22,4)):(b=(p+t)/2,this.BendNoteHeads[0].x=b-this.BendNoteHeads[0].noteHeadOffset,this.BendNoteHeads[0].y=h+u.y,this.BendNoteHeads[0].paint(0,0,l),S=this.getBendNoteValue(f,d.whammyBarPoints[1]),_=this.BendNoteHeads[0].getNoteValueY(S)+s,this.drawBendSlur(l,p,e,b,_,m===E.Down,this.scale,y),this.BendNoteHeads[1].x=t-this.BendNoteHeads[1].noteHeadOffset,this.BendNoteHeads[1].y=h+u.y,this.BendNoteHeads[1].paint(0,0,l),a=this.BendNoteHeads[1].getNoteValueY(w)+s,this.drawBendSlur(l,b,_,t,a,m===E.Down,this.scale,y));break;case Q.PrediveDive:case Q.Predive:var v=o+u.x+u.getBeatX(f.beat,Os.PreNotes),B=(v+=u.getPreNotesGlyphForBeat(f.beat).prebendNoteHeadOffset,h+u.y+u.getScoreY(u.accidentalHelper.getNoteLineForValue(f.displayValue-(f.beat.whammyBarPoints[0].value/2|0),!1))+s);this.drawBendSlur(l,v,B,p,e,m===E.Down,this.scale,y),0<this.BendNoteHeads.length&&(this.BendNoteHeads[0].x=t-this.BendNoteHeads[0].noteHeadOffset,this.BendNoteHeads[0].y=h+u.y,this.BendNoteHeads[0].paint(0,0,l),this.drawBendSlur(l,p,e,t,a,m===E.Down,this.scale,y))}}l.textAlign=e}getBendNoteValue(e,t){return e.displayValueWithoutBend+(t.value/2|0)}}dn.SimpleDipHeight=2*ln.PerHalfSize,dn.SimpleDipPadding=2;class cn extends Ts{constructor(e,t,i){super(e,t),this.width=i}}class un extends Ns{constructor(e,t,i,s,a){super(e,t,a?R.GraceScale:1,i.getSymbol(s)),this._isGrace=a,this._articulation=i}paint(e,t,i){var s=this._isGrace?this.scale:0;i.fillMusicFontSymbol(e+this.x,t+this.y+s,this.glyphScale*this.scale,this.symbol,!1),this._articulation.techniqueSymbol!==k.None&&this._articulation.techniqueSymbolPlacement===P.Middle&&i.fillMusicFontSymbol(e+this.x,t+this.y+s,this.glyphScale*this.scale,this._articulation.techniqueSymbol,!1)}doLayout(){var e=(this._isGrace?R.GraceScale:1)*this.scale;switch(this.symbol){case k.NoteheadWhole:this.width=14;break;case k.NoteheadCircleX:case k.NoteheadDiamondWhite:this.width=9;break;case k.NoteheadHeavyXHat:case k.NoteheadHeavyX:this.width=13;break;default:this.width=10}this.width=this.width*(this._isGrace?R.GraceScale:1)*this.scale,this.height=R.NoteHeadHeight*e}}class pn extends Ns{constructor(e,t){super(e,t,R.GraceScale,k.ArticStaccatoAbove)}doLayout(){this.width=R.QuarterNoteHeadWidth*this.scale,this.height=7*this.scale}paint(e,t,i){super.paint(e+3*this.scale,t+5*this.scale,i)}}class gn extends Ns{constructor(e,t){super(e,t,.5,k.PictEdgeOfCymbal)}doLayout(){this.width=22*this.scale,this.height=15*this.scale}paint(e,t,i){super.paint(e-3*this.scale,t+this.height,i)}}class mn extends Ns{constructor(e,t){super(e,t,R.GraceScale,k.GuitarGolpe)}doLayout(){this.width=9*this.scale,this.height=10*this.scale}paint(e,t,i){super.paint(e,t+this.height,i)}}class fn extends Na{constructor(){super(...arguments),this._collisionOffset=-1e3,this._skipPaint=!1,this.noteHeads=null,this.restGlyph=null}getNoteX(e,t){return this.noteHeads?this.noteHeads.getNoteX(e,t):0}buildBoundingsLookup(e,t,i){this.noteHeads&&this.noteHeads.buildBoundingsLookup(e,t+this.x,i+this.y)}getNoteY(e,t){return this.noteHeads?this.noteHeads.getNoteY(e,t):0}updateBeamingHelper(){var e;this.noteHeads?this.noteHeads.updateBeamingHelper(this.container.x+this.x):this.restGlyph&&(this.restGlyph.updateBeamingHelper(this.container.x+this.x),this.renderer.bar.isMultiVoice)&&-1e3===this._collisionOffset&&(this._collisionOffset=this.renderer.helpers.collisionHelper.applyRestCollisionOffset(this.container.beat,this.restGlyph.y,this.renderer.getScoreHeight(1)),this.y+=this._collisionOffset,(e=this.renderer.helpers.collisionHelper.restDurationsByDisplayTime).has(this.container.beat.playbackStart))&&e.get(this.container.beat.playbackStart).has(this.container.beat.playbackDuration)&&e.get(this.container.beat.playbackStart).get(this.container.beat.playbackDuration)!==this.container.beat.id&&(this._skipPaint=!0)}paint(e,t,i){this._skipPaint||super.paint(e,t,i)}doLayout(){var i=this.renderer;if(!this.container.beat.isEmpty)if(this.container.beat.isRest){let t=2*Math.ceil((this.renderer.bar.staff.standardNotationLineCount-1)/2);this.container.beat.duration===x.Whole&&1!==this.renderer.bar.staff.standardNotationLineCount&&3!==this.renderer.bar.staff.standardNotationLineCount&&(t-=2);var e=new tn(0,i.getScoreY(t),this.container.beat.duration);if((this.restGlyph=e).beat=this.container.beat,e.beamingHelper=this.beamingHelper,this.addGlyph(e),this.renderer.bar.isMultiVoice&&(0===this.container.beat.voice.index?(r=ma.computeLineHeightsForRest(this.container.beat.duration),a=e.y-i.getScoreHeight(r[0]),e=e.y+i.getScoreHeight(r[1]),this.renderer.helpers.collisionHelper.reserveBeatSlot(this.container.beat,a,e)):this.renderer.helpers.collisionHelper.registerRest(this.container.beat)),this.beamingHelper&&this.beamingHelper.applyRest(this.container.beat,t),0<this.container.beat.dots){this.addGlyph(new cn(0,0,5*this.scale));for(let e=0;e<this.container.beat.dots;e++){var s=new ha(0,0);s.renderer=this.renderer,this.createBeatDot(t,s),this.addGlyph(s)}}}else{var t,a,r=new en,n=((this.noteHeads=r).beat=this.container.beat,r.beamingHelper=this.beamingHelper,new Qr(!1));n.renderer=this.renderer;for(t of this.container.beat.notes)t.isVisible&&(this.createNoteGlyph(t),n.addParenthesis(t));if(this.addGlyph(r),n.isEmpty||(this.addGlyph(new cn(0,0,4*(this.container.beat.graceType!==_.None?R.GraceScale:1)*this.scale)),this.addGlyph(n)),this.container.beat.hasWhammyBar&&((a=new dn(this.container.beat)).renderer=this.renderer,a.doLayout(),this.container.ties.push(a)),0<this.container.beat.dots){this.addGlyph(new cn(0,0,5*this.scale));for(let e=0;e<this.container.beat.dots;e++){var o,h=new ha(0,0);h.renderer=this.renderer;for(o of this.container.beat.notes)this.createBeatDot(i.getNoteLine(o),h);this.addGlyph(h)}}}super.doLayout(),this.container.beat.isEmpty?this.centerX=this.width/2:this.container.beat.isRest?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.centerX=this.noteHeads.x+this.noteHeads.width/2}createBeatDot(e,t){var i=this.renderer;t.addGlyph(new Ur(0,i.getScoreY(e),1.5*this.scale))}createNoteHeadGlyph(e){var t=this.container.beat.graceType!==_.None;if(e.beat.voice.bar.staff.isPercussion){var i=Te.getArticulation(e);if(i)return new un(0,0,i,e.beat.duration,t);C.warning("Rendering","No articulation found for percussion instrument "+e.percussionArticulation)}return e.isDead?new Xr(0,0,t):e.beat.graceType===_.BendGrace?new R(0,0,x.Quarter,!0):new(e.harmonicType===g.Natural?Yr:R)(0,0,e.beat.duration,t)}createNoteGlyph(t){if(t.beat.graceType!==_.BendGrace||t.hasBend){var i=this.renderer;let e=this.createNoteHeadGlyph(t);var s=i.getNoteLine(t);if(e.y=i.getScoreY(s),this.noteHeads.addNoteGlyph(e,t,s),t.harmonicType!==g.None&&t.harmonicType!==g.Natural&&(a=t.displayValue+t.harmonicPitch,e=new Yr(0,0,t.beat.duration,this.container.beat.graceType!==_.None),s=i.accidentalHelper.getNoteLineForValue(a,!1),e.y=i.getScoreY(s),this.noteHeads.addNoteGlyph(e,t,s)),t.isStaccato&&!this.noteHeads.aboveBeatEffects.has("Staccato")&&this.noteHeads.belowBeatEffects.set("Staccato",new pn(0,0)),t.accentuated!==H.Normal||this.noteHeads.aboveBeatEffects.has("Accent")||this.noteHeads.belowBeatEffects.set("Accent",new zr(0,0,H.Normal)),t.accentuated!==H.Heavy||this.noteHeads.aboveBeatEffects.has("HAccent")||this.noteHeads.belowBeatEffects.set("HAccent",new zr(0,0,H.Heavy)),t.isPercussion){var a=Te.getArticulation(t);if(a&&a.techniqueSymbolPlacement!==P.Middle){var r=a.techniqueSymbolPlacement===P.Top?this.noteHeads.aboveBeatEffects:this.noteHeads.belowBeatEffects;switch(a.techniqueSymbol){case k.PictEdgeOfCymbal:r.set("PictEdgeOfCymbal",new gn(0,0));break;case k.ArticStaccatoAbove:r.set("ArticStaccatoAbove",new pn(0,0));break;case k.StringsUpBow:r.set("StringsUpBow",new ir(0,0,j.Up));break;case k.StringsDownBow:r.set("StringsDownBow",new ir(0,0,j.Down));break;case k.GuitarGolpe:r.set("GuitarGolpe",new mn(0,0))}}}}}}class yn extends Ts{constructor(e){super(0,0),this._beat=e}doLayout(){this.width=10*this.scale}paint(e,t,i){var s,a,r,n=this.renderer,o=n.lineOffset,h=t+this.y+(n.getNoteY(this._beat.maxNote,A.Bottom)-o),t=t+this.y+n.getNoteY(this._beat.minNote,A.Top)+o,n=e+this.x+this.width/2,o=8*this.scale;this._beat.brushType!==U.None&&((s=new nr(0,0,J.Slight,1.2,!0)).renderer=this.renderer,s.doLayout(),a=-s.height/2,this._beat.brushType===U.ArpeggioUp?(r=t-o,s.width=Math.abs(r-(h+o)),i.beginRotate(e+this.x+5*this.scale,r,-90),s.paint(0,a,i),i.endRotate(),i.beginPath(),i.moveTo(n,t),i.lineTo(n+o/2,t-o),i.lineTo(n-o/2,t-o),i.closePath(),i.fill()):this._beat.brushType===U.ArpeggioDown&&(r=h+o,s.width=Math.abs(t-r),i.beginRotate(e+this.x+5*this.scale,r,90),s.paint(0,a,i),i.endRotate(),i.beginPath(),i.moveTo(n,h),i.lineTo(n+o/2,h+o),i.lineTo(n-o/2,h+o),i.closePath(),i.fill()))}}class bn extends ka{constructor(){super(),this._prebends=null,this.accidentals=null}get prebendNoteHeadOffset(){return this._prebends?this._prebends.x+this._prebends.noteHeadOffset:0}doLayout(){if(!this.container.beat.isRest){var e,t=new an,i=(t.renderer=this.renderer,new Qr(!0)),s=(i.renderer=this.renderer,new rn(this.container.beat,!0));(this._prebends=s).renderer=this.renderer;for(e of this.container.beat.notes)if(e.isVisible){if(e.hasBend)switch(e.bendType){case w.PrebendBend:case w.Prebend:case w.PrebendRelease:s.addGlyph(e.displayValue-(e.bendPoints[0].value/2|0),!1)}else if(e.beat.hasWhammyBar)switch(e.beat.whammyBarType){case Q.PrediveDive:case Q.Predive:this._prebends.addGlyph(e.displayValue-(e.beat.whammyBarPoints[0].value/2|0),!1)}this.createAccidentalGlyph(e,t),i.addParenthesis(e)}s.isEmpty||(this.addGlyph(s),this.addGlyph(new cn(0,0,4*(this.container.beat.graceType!==_.None?R.GraceScale:1)*this.scale))),this.container.beat.brushType!==U.None&&(this.addGlyph(new yn(this.container.beat)),this.addGlyph(new cn(0,0,4*this.scale))),i.isEmpty||(this.addGlyph(i),this.addGlyph(new cn(0,0,4*(this.container.beat.graceType!==_.None?R.GraceScale:1)*this.scale))),t.isEmpty||(this.accidentals=t,this.addGlyph(new cn(0,0,2*(this.container.beat.graceType!==_.None?R.GraceScale:1)*this.scale)),this.addGlyph(t),this.addGlyph(new cn(0,0,2*(this.container.beat.graceType!==_.None?R.GraceScale:1)*this.scale)))}super.doLayout()}createAccidentalGlyph(e,t){var i,s=this.renderer,a=s.accidentalHelper.applyAccidental(e),r=s.getNoteLine(e),n=this.container.beat.graceType!==_.None;a!==Gs.None&&((i=new Rr(0,s.getScoreY(r),a,n)).renderer=this.renderer,t.addGlyph(i)),e.harmonicType!==g.None&&e.harmonicType!==g.Natural&&(i=e.displayValue+e.harmonicPitch,a=s.accidentalHelper.applyAccidentalForValue(e.beat,i,n,!1),r=s.accidentalHelper.getNoteLineForValue(i,!1),(e=new Rr(0,s.getScoreY(r),a,n)).renderer=this.renderer,t.addGlyph(e))}}class Sn extends Ns{constructor(e,t,i,s){super(e,t,s,Sn.getSymbol(i)),this._digit=0,this._scale=0,this._digit=i,this._scale=s}doLayout(){this.width=this.getDigitWidth(this._digit)*this.scale*this._scale}getDigitWidth(e){switch(e){case 0:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:return 14;case 1:return 10;default:return 0}}static getSymbol(e){switch(e){case 0:return k.TimeSig0;case 1:return k.TimeSig1;case 2:return k.TimeSig2;case 3:return k.TimeSig3;case 4:return k.TimeSig4;case 5:return k.TimeSig5;case 6:return k.TimeSig6;case 7:return k.TimeSig7;case 8:return k.TimeSig8;case 9:return k.TimeSig9;default:return k.None}}}class _n extends ha{constructor(e,t,i,s=1){super(e,t),this._number=0,this._scale=0,this._number=i,this._scale=s}doLayout(){let e=this._number;for(;0<e;){var t=e%10,t=new Sn(0,0,t,this._scale);this.addGlyph(t),e=e/10|0}if(this.glyphs){this.glyphs.reverse();let i=0;for(let e=0,t=this.glyphs.length;e<t;e++){var s=this.glyphs[e];s.x=i,s.y=0,s.renderer=this.renderer,s.doLayout(),i+=s.width}this.width=i}}}_n.numberHeight=18;class wn extends ha{constructor(e,t,i,s,a){super(e,t),this._numerator=0,this._denominator=0,this._numerator=i,this._denominator=s,this._isCommon=a}doLayout(){if(this._isCommon&&2===this._numerator&&2===this._denominator){var e=new Ns(0,0,this.commonScale,k.TimeSigCutCommon);e.width=14*this.scale,this.addGlyph(e),super.doLayout()}else if(this._isCommon&&4===this._numerator&&4===this._denominator){e=new Ns(0,0,this.commonScale,k.TimeSigCommon);e.width=14*this.scale,this.addGlyph(e),super.doLayout()}else{var e=_n.numberHeight*this.scale,t=new _n(0,-e/2,this._numerator,this.numberScale),e=new _n(0,e/2,this._denominator,this.numberScale);this.addGlyph(t),this.addGlyph(e),super.doLayout();for(let e=0,t=this.glyphs.length;e<t;e++){var i=this.glyphs[e];i.x=(this.width-i.width)/2}}}}class vn extends wn{get commonScale(){return 1}get numberScale(){return 1}}class Bn extends nn{constructor(e){super(0,0),this._notes=[],this._endNoteGlyph=null,this._middleNoteGlyph=null,this._beat=e}addBends(i){if(this._notes.push(i),!i.isTieOrigin)switch(i.bendType){case w.Bend:case w.PrebendRelease:case w.PrebendBend:{let e=this._endNoteGlyph;e||((e=new rn(i.beat,!1)).renderer=this.renderer,this._endNoteGlyph=e,this.BendNoteHeads.push(e));var s=i.bendPoints[i.bendPoints.length-1];e.addGlyph(this.getBendNoteValue(i,s),s.value%2!=0)}break;case w.Release:if(!i.isTieOrigin){let e=this._endNoteGlyph;e||((e=new rn(i.beat,!1)).renderer=this.renderer,this._endNoteGlyph=e,this.BendNoteHeads.push(e));s=i.bendPoints[i.bendPoints.length-1];e.addGlyph(this.getBendNoteValue(i,s),s.value%2!=0)}break;case w.BendRelease:{let e=this._middleNoteGlyph;e||(e=new rn(i.beat,!1),(this._middleNoteGlyph=e).renderer=this.renderer,this.BendNoteHeads.push(e));s=i.bendPoints[1];e.addGlyph(this.getBendNoteValue(i,i.bendPoints[1]),s.value%2!=0);let t=this._endNoteGlyph;t||((t=new rn(i.beat,!1)).renderer=this.renderer,this._endNoteGlyph=t,this.BendNoteHeads.push(t));s=i.bendPoints[i.bendPoints.length-1];t.addGlyph(this.getBendNoteValue(i,s),s.value%2!=0)}}}paint(a,r,n){var o=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,this._beat.voice.bar),h=a+o.x+o.getBeatX(this._beat,Os.MiddleNotes);let l=a+o.x;this._beat.isLastOfVoice?l+=o.postBeatGlyphsStart:l+=o.getBeatX(this._beat.nextBeat,Os.PreNotes);var d=(h+(l-=8*this.scale))/2,e=(this._middleNoteGlyph&&(this._middleNoteGlyph.x=d-this._middleNoteGlyph.noteHeadOffset,this._middleNoteGlyph.y=r+o.y,this._middleNoteGlyph.paint(0,0,n)),this._endNoteGlyph&&(this._endNoteGlyph.x=l-this._endNoteGlyph.noteHeadOffset,this._endNoteGlyph.y=r+o.y,this._endNoteGlyph.paint(0,0,n)),this._notes.sort((e,t)=>t.displayValue-e.displayValue),this._beat.graceType===_.BendGrace?this._beat.nextBeat:this._beat);let c=1===this._notes.length?this.getTieDirection(e,o):E.Up;for(let e=0;e<this._notes.length;e++){var u=this._notes[e];0<e&&e>=(this._notes.length/2|0)&&(c=E.Down);let i=r+o.y+o.getNoteY(u,A.Top),s=R.NoteHeadHeight*this.scale*R.GraceScale*.5;c===E.Down&&(i+=R.NoteHeadHeight*this.scale);var p=u.bendStyle===z.Gradual?"grad.":"";if(u.isTieOrigin){var t=u.tieDestination,g=t?this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,t.beat.voice.bar):null;if(g&&g.staff===o.staff){var m=a+g.x+g.getBeatX(t.beat,Os.MiddleNotes);let e=r+g.y+g.getNoteY(t,A.Top);c===E.Down&&(e+=R.NoteHeadHeight*this.scale),u.bendType===w.Hold||u.bendType===w.Prebend?qr.paintTie(n,this.scale,h,i,m,e,c===E.Down,22,4):this.drawBendSlur(n,h,i,m,e,c===E.Down,this.scale,p)}else{g=a+o.x+o.width,t=u.tieDestination.realValue,m=(o.accidentalHelper.applyAccidentalForValue(u.beat,t,!1,!0),r+o.y+o.getScoreY(o.accidentalHelper.getNoteLineForValue(t,!1)));u.bendType===w.Hold||u.bendType===w.Prebend?qr.paintTie(n,this.scale,h,i,g,m,c===E.Down,22,4):this.drawBendSlur(n,h,i,g,m,c===E.Down,this.scale,p)}switch(u.bendType){case w.Prebend:case w.PrebendBend:case w.PrebendRelease:var f=a+o.x+o.getBeatX(u.beat,Os.PreNotes),y=(f+=o.getPreNotesGlyphForBeat(u.beat).prebendNoteHeadOffset,r+o.y+o.getScoreY(o.accidentalHelper.getNoteLineForValue(u.displayValue-(u.bendPoints[0].value/2|0),!1))+s);this.drawBendSlur(n,f,y,h,i,c===E.Down,this.scale)}}else{c===E.Up&&(s=-s);let e=0,t=0;switch(u.bendType){case w.Bend:e=this.getBendNoteValue(u,u.bendPoints[u.bendPoints.length-1]),t=this._endNoteGlyph.getNoteValueY(e)+s,this.drawBendSlur(n,h,i,l,t,c===E.Down,this.scale,p);break;case w.BendRelease:var b=this.getBendNoteValue(u,u.bendPoints[1]),b=this._middleNoteGlyph.getNoteValueY(b)+s;this.drawBendSlur(n,h,i,d,b,c===E.Down,this.scale,p),e=this.getBendNoteValue(u,u.bendPoints[u.bendPoints.length-1]),t=this._endNoteGlyph.getNoteValueY(e)+s,this.drawBendSlur(n,d,b,l,t,c===E.Down,this.scale,p);break;case w.Release:0<this.BendNoteHeads.length&&(e=this.getBendNoteValue(u,u.bendPoints[u.bendPoints.length-1]),t=this.BendNoteHeads[0].getNoteValueY(e)+s,this.drawBendSlur(n,h,i,l,t,c===E.Down,this.scale,p));break;case w.Prebend:case w.PrebendBend:case w.PrebendRelease:var b=a+o.x+o.getBeatX(u.beat,Os.PreNotes),S=(b+=o.getPreNotesGlyphForBeat(u.beat).prebendNoteHeadOffset,r+o.y+o.getScoreY(o.accidentalHelper.getNoteLineForValue(u.displayValue-(u.bendPoints[0].value/2|0),!1))+s);this.drawBendSlur(n,b,S,h,i,c===E.Down,this.scale),0<this.BendNoteHeads.length&&(e=this.getBendNoteValue(u,u.bendPoints[u.bendPoints.length-1]),t=this.BendNoteHeads[0].getNoteValueY(e)+s,this.drawBendSlur(n,h,i,l,t,c===E.Down,this.scale,p))}}}}getBendNoteValue(e,t){return e.displayValueWithoutBend+(t.value/2|0)}}class Tn extends qr{constructor(e,t,i=!1){super(e,t,i)}doLayout(){super.doLayout()}getBeamDirection(e,t){return e.isRest||t.getBeatDirection(e)!==E.Up?E.Up:E.Down}getStartY(){return this.startBeat.isRest?this.startNoteRenderer.getScoreY(9):this.tieDirection!==E.Up?this.startNoteRenderer.getNoteY(this.startBeat.minNote,A.Bottom):this.startNoteRenderer.getNoteY(this.startBeat.maxNote,A.Top)}getEndY(){var e,t=this.endNoteRenderer;return this.endBeat.isRest?this.tieDirection!==E.Up?t.getScoreY(0):t.getScoreY(9):this.startNoteRenderer.getBeatDirection(this.startBeat)!==(e=t.getBeatDirection(this.endBeat))&&this.startBeat.graceType===_.None?e===this.tieDirection?this.tieDirection!==E.Up?t.getNoteY(this.endBeat.minNote,A.BottomWithStem):t.getNoteY(this.endBeat.maxNote,A.TopWithStem):this.tieDirection!==E.Up?t.getNoteY(this.endBeat.minNote,A.TopWithStem):t.getNoteY(this.endBeat.maxNote,A.BottomWithStem):this.tieDirection!==E.Up?t.getNoteY(this.endBeat.minNote,A.Bottom):t.getNoteY(this.endBeat.maxNote,A.Top)}getStartX(){return this.startNoteRenderer.getBeatX(this.startBeat,Os.MiddleNotes)}getEndX(){var e=this.endNoteRenderer.getBeatDirection(this.endBeat);return this.endNoteRenderer.getBeatX(this.endBeat,this.endBeat.duration>x.Whole&&e===this.tieDirection?Os.Stem:Os.MiddleNotes)}}class kn extends Ts{constructor(e,t,i,s){super(0,0),this._outType=t,this._inType=e,this._startNote=i,this._parent=s}doLayout(){this.width=0}paint(e,t,i){this.paintSlideIn(e,t,i),this.drawSlideOut(e,t,i)}paintSlideIn(e,t,i){var s=this.renderer,a=12*this.scale,e=e+s.x+s.getNoteX(this._startNote,Hs.Left)-2*this.scale,r=t+s.y+s.getNoteY(this._startNote,A.Center),a=e-a;let n=t+s.y;switch(this._inType){case q.IntoFromBelow:n+=s.getNoteY(this._startNote,A.Bottom);break;case q.IntoFromAbove:n+=s.getNoteY(this._startNote,A.Top);break;default:return}t=this.getAccidentalsWidth(s,this._startNote.beat);this.paintSlideLine(i,!1,a-=t,e-=t,n,r)}getAccidentalsWidth(e,t){e=e.getPreNotesGlyphForBeat(t);return e&&e.accidentals?e.accidentals.width:0}drawSlideOut(e,t,i){var s,a=this.renderer,r=12*this.scale,n=3*this.scale,o=+this.scale,h=2*this.scale;let l=0,d=0,c=0,u=0,p=!1;switch(this._outType){case m.Shift:case m.Legato:l=e+a.x+a.getBeatX(this._startNote.beat,Os.PostNotes)+n,d=t+a.y+a.getNoteY(this._startNote,A.Center),this._startNote.slideTarget?(s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,this._startNote.slideTarget.beat.voice.bar),u=s&&s.staff===a.staff?(c=e+s.x+s.getBeatX(this._startNote.slideTarget.beat,Os.PreNotes)-o,t+s.y+s.getNoteY(this._startNote.slideTarget,A.Center)):(c=e+a.x+this._parent.x,d),this._startNote.slideTarget.realValue>this._startNote.realValue?(d+=h,u-=h):(d-=h,u+=h)):(c=e+a.x+this._parent.x,u=d);break;case m.OutUp:l=e+a.x+a.getNoteX(this._startNote,Hs.Right),d=t+a.y+a.getNoteY(this._startNote,A.Center),c=l+r,u=t+a.y+a.getNoteY(this._startNote,A.Top);break;case m.OutDown:l=e+a.x+a.getNoteX(this._startNote,Hs.Right),d=t+a.y+a.getNoteY(this._startNote,A.Center),c=l+r,u=t+a.y+a.getNoteY(this._startNote,A.Bottom);break;case m.PickSlideUp:l=e+a.x+a.getNoteX(this._startNote,Hs.Right)+n,d=t+a.y+a.getNoteY(this._startNote,A.Center),u=t+a.y+a.getNoteY(this._startNote,A.Top),c=e+a.x+a.width,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(c=e+a.x+a.getBeatX(this._startNote.beat.nextBeat,Os.PreNotes)),p=!0;break;case m.PickSlideDown:l=e+a.x+a.getNoteX(this._startNote,Hs.Right)+n,d=t+a.y+a.getNoteY(this._startNote,A.Center),u=t+a.y+a.getNoteY(this._startNote,A.Bottom),c=e+a.x+a.width,this._startNote.beat.nextBeat&&this._startNote.beat.nextBeat.voice===this._startNote.beat.voice&&(c=e+a.x+a.getBeatX(this._startNote.beat.nextBeat,Os.PreNotes)),p=!0;break;default:return}this.paintSlideLine(i,p,l,c,d,u)}paintSlideLine(e,t,i,s,a,r){var n,o,h;t?((t=new nr(0,0,J.Slight,1.2)).renderer=this.renderer,t.doLayout(),a-=t.height/2,h=s-i,n=(r-=t.height/2)-a,o=Math.sqrt(Math.pow(n,2)+Math.pow(h,2)),t.width=h,h=Math.asin(n/o)*(180/Math.PI),e.beginRotate(i,a,h),t.paint(0,0,e),e.endRotate()):(e.beginPath(),e.moveTo(i,a),e.lineTo(s,r),e.stroke())}}class Nn extends Tn{constructor(e,t,i=!1){super(e.beat,t.beat,i),this._startNote=e,this._endNote=t}getTieHeight(e,t,i,s){return Math.log2(i-e+1)*this.renderer.settings.notation.slurHeight}getStartY(){return this.isStartCentered()?this.tieDirection!==E.Up?this.startNoteRenderer.getNoteY(this._startNote,A.Bottom):this.startNoteRenderer.getNoteY(this._startNote,A.Top):this.startNoteRenderer.getNoteY(this._startNote,A.Center)}getEndY(){return this.isEndCentered()?this.isEndOnStem()?this.tieDirection!==E.Up?this.endNoteRenderer.getNoteY(this._endNote,A.BottomWithStem):this.endNoteRenderer.getNoteY(this._endNote,A.TopWithStem):this.tieDirection!==E.Up?this.endNoteRenderer.getNoteY(this._endNote,A.Bottom):this.endNoteRenderer.getNoteY(this._endNote,A.Top):this.endNoteRenderer.getNoteY(this._endNote,A.Center)}isStartCentered(){return this._startNote===this._startNote.beat.maxNote&&this.tieDirection===E.Up||this._startNote===this._startNote.beat.minNote&&this.tieDirection===E.Down}isEndCentered(){return this._startNote.beat.graceType===_.None&&(this._endNote===this._endNote.beat.maxNote&&this.tieDirection===E.Up||this._endNote===this._endNote.beat.minNote&&this.tieDirection===E.Down)}isEndOnStem(){var e=this.endNoteRenderer;return this.startNoteRenderer.getBeatDirection(this.startBeat)!==e.getBeatDirection(this.endBeat)&&this.startBeat.graceType===_.None}getStartX(){return this.isStartCentered()?this.startNoteRenderer.getBeatX(this._startNote.beat,Os.MiddleNotes):this.startNoteRenderer.getNoteX(this._startNote,Hs.Right)}getEndX(){return this.isEndCentered()?this.isEndOnStem()?this.endNoteRenderer.getBeatX(this._endNote.beat,Os.Stem):this.endNoteRenderer.getNoteX(this._endNote,Hs.Center):this.endNoteRenderer.getBeatX(this._endNote.beat,Os.PreNotes)}}class xn extends qr{constructor(e,t,i=!1){super(e?e.beat:null,t?t.beat:null,i),this.startNote=e,this.endNote=t}shouldDrawBendSlur(){return this.renderer.settings.notation.extendBendArrowsOnTiedNotes&&!!this.startNote.bendOrigin&&this.startNote.isTieOrigin}doLayout(){super.doLayout()}getBeamDirection(e,t){return t.getBeatDirection(e)!==E.Up?E.Up:E.Down}getStartY(){return this.startBeat.isRest?this.startNoteRenderer.getScoreY(9):this.tieDirection!==E.Up?this.startNoteRenderer.getNoteY(this.startNote,A.Bottom):this.startNoteRenderer.getNoteY(this.startNote,A.Top)}getEndY(){var e=this.endNoteRenderer;return this.endBeat.isRest?this.tieDirection!==E.Up?e.getScoreY(0):e.getScoreY(9):this.tieDirection!==E.Up?e.getNoteY(this.endNote,A.Bottom):e.getNoteY(this.endNote,A.Top)}getStartX(){return this.startNoteRenderer.getBeatX(this.startNote.beat,Os.PostNotes)}getEndX(){return this.endNoteRenderer.getBeatX(this.endNote.beat,Os.PreNotes)}}class Pn extends Ps{constructor(e,t){super(e,t),this._bend=null,this._effectSlur=null,this._effectEndSlur=null}doLayout(){if(this._effectSlur=null,this._effectEndSlur=null,super.doLayout(),this.beat.isLegatoOrigin){if(!this.beat.previousBeat||!this.beat.previousBeat.isLegatoOrigin){let e=this.beat.nextBeat;for(;e.nextBeat&&e.nextBeat.isLegatoDestination;)e=e.nextBeat;this.addTie(new Tn(this.beat,e,!1))}}else if(this.beat.isLegatoDestination&&!this.beat.isLegatoOrigin){let e=this.beat.previousBeat;for(;e.previousBeat&&e.previousBeat.isLegatoOrigin;)e=e.previousBeat;this.addTie(new Tn(e,this.beat,!0))}this._bend&&(this._bend.renderer=this.renderer,this._bend.doLayout(),this.updateWidth())}createTies(e){var t,i;e.isVisible&&(e.isTieOrigin&&!e.hasBend&&!e.beat.hasWhammyBar&&e.beat.graceType!==_.BendGrace&&e.tieDestination&&e.tieDestination.isVisible&&(i=new xn(e,e.tieDestination,!1),this.addTie(i)),!e.isTieDestination||e.tieOrigin.hasBend||e.beat.hasWhammyBar||(i=new xn(e.tieOrigin,e,!0),this.addTie(i)),e.slideInType===q.None&&e.slideOutType===m.None||(i=new kn(e.slideInType,e.slideOutType,e,this),this.addTie(i)),e.isSlurOrigin&&e.slurDestination&&e.slurDestination.isVisible&&(i=new Nn(e,e.slurDestination,!1),this.addTie(i)),e.isSlurDestination&&(i=new Nn(e.slurOrigin,e,!0),this.addTie(i)),!this._effectSlur&&e.isEffectSlurOrigin&&e.effectSlurDestination&&(i=new Nn(e,e.effectSlurDestination,!1),this._effectSlur=i,this.addTie(i)),!this._effectEndSlur&&e.beat.isEffectSlurDestination&&e.beat.effectSlurOrigin&&(t=(i=this.onNotes.beamingHelper.direction)===E.Up?e.beat.effectSlurOrigin.minNote:e.beat.effectSlurOrigin.maxNote,i=i===E.Up?e.beat.minNote:e.beat.maxNote,t=new Nn(t,i,!0),this._effectEndSlur=t,this.addTie(t)),e.hasBend)&&(this._bend||(i=new Bn(e.beat),(this._bend=i).renderer=this.renderer,this.addTie(i)),this._bend.addBends(e))}}class En extends _a{constructor(e,t){super(e,t),this.simpleWhammyOverflow=0,this._firstLineY=0,this._startSpacing=!1,this.accidentalHelper=new ua(this)}getBeatDirection(e){return this.helpers.getBeamingHelperForBeat(e).direction}get lineOffset(){return(_a.LineSpacing+1)*this.scale}updateSizes(){var e=this.resources,e=e.tablatureFont.size/2+.2*e.tablatureFont.size;this.topPadding=e*this.scale,this.bottomPadding=e*this.scale,this.height=4*this.lineOffset+this.topPadding+this.bottomPadding,this.updateFirstLineY(),super.updateSizes()}updateFirstLineY(){var e=4*this.lineOffset,t=(this.bar.staff.standardNotationLineCount-1)*this.lineOffset;this._firstLineY=(e-t)/2}doLayout(){if(this.updateFirstLineY(),super.doLayout(),!this.bar.isEmpty&&this.accidentalHelper.maxLineBeat){var i=this.getScoreY(-2),s=this.getScoreY(6),a=this.simpleWhammyOverflow;this.registerOverflowTop(a);let e=this.getScoreY(this.accidentalHelper.maxLine);var r=this.helpers.getBeamingHelperForBeat(this.accidentalHelper.maxLineBeat);r.direction===E.Up&&(e=(e-=this.getStemSize(r))-r.fingeringCount*this.resources.graceFont.size,r.hasTuplet)&&(e-=2*this.resources.effectFont.size),r.hasTuplet&&(e-=1.5*this.resources.effectFont.size),e<i&&this.registerOverflowTop(Math.abs(e)+a);let t=this.getScoreY(this.accidentalHelper.minLine);r=this.helpers.getBeamingHelperForBeat(this.accidentalHelper.minLineBeat);(t=r.direction===E.Down?(t+=this.getStemSize(r))+r.fingeringCount*this.resources.graceFont.size:t)>s&&this.registerOverflowBottom(Math.abs(t)-s)}}paint(e,t,i){super.paint(e,t,i),this.paintBeams(e,t,i),this.paintTuplets(e,t,i)}paintTuplets(e,t,i){for(var s of this.bar.voices){var a;if(this.hasVoiceContainer(s))for(a of this.getVoiceContainer(s).tupletGroups)this.paintTupletHelper(e+this.beatGlyphsStart,t,i,a)}}paintBeams(i,s,a){for(let e=0,t=this.helpers.beamHelpers.length;e<t;e++){var r=this.helpers.beamHelpers[e];for(let e=0,t=r.length;e<t;e++){var n=r[e];this.paintBeamHelper(i+this.beatGlyphsStart,s,a,n)}}}paintBeamHelper(e,t,i,s){i.color=0===s.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,s.isRestBeamHelper||(1===s.beats.length?this.paintFlag(e,t,i,s):this.paintBar(e,t,i,s))}paintTupletHelper(r,n,o,h){var l=this.resources,e=o.textAlign,t=o.textBaseline;o.color=0===h.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,o.textAlign=N.Center,o.textBaseline=P.Middle;let d;var c=h.beats[0].tupletNumerator,u=h.beats[0].tupletDenominator;d=2===c&&3===u?"2":3===c&&2===u?"3":4===c&&6===u?"4":5===c&&4===u?"5":6===c&&4===u?"6":7===c&&4===u?"7":9===c&&8===u?"9":10===c&&8===u?"10":11===c&&8===u?"11":12===c&&8===u?"12":13===c&&8===u?"13":c+":"+u;let p=10*this.scale,g=5*this.scale;if(1!==h.beats.length&&h.isFull){c=h.beats[0],u=h.beats[h.beats.length-1];let t=null,i=null;for(let e=0;e<h.beats.length;e++)if(!h.beats[e].isRest){t=h.beats[e];break}for(let e=h.beats.length-1;0<=e;e--)if(!h.beats[e].isRest){i=h.beats[e];break}let e=!1;t||(t=c,e=!0),i=i||u;var m=this.helpers.beamHelperLookup[h.voice.index].get(c.index),f=this.helpers.beamHelperLookup[h.voice.index].get(u.index),c=m.getBeatLineX(c),f=f.getBeatLineX(u),u=this.helpers.beamHelperLookup[h.voice.index].get(t.index),y=this.helpers.beamHelperLookup[h.voice.index].get(i.index),m=m.direction;let s=this.calculateBeamYWithDirection(u,c,m),a=this.calculateBeamYWithDirection(y,f,m);e&&(s=Math.max(s,a),a=s),o.font=l.effectFont;var u=o.measureText(d),y=3*this.scale,b=(c+f)/2,S=b-u/2-y,u=b+u/2+y,y=(a-s)/(f-c),_=s-y*c,w=y*S+_,v=y*b+_,y=y*u+_;m===E.Down&&(p*=-1,g*=-1),o.beginPath(),o.moveTo(r+this.x+c,n+this.y+s-p|0),o.lineTo(r+this.x+c,n+this.y+s-p-g|0),o.lineTo(r+this.x+S,n+this.y+w-p-g|0),o.stroke(),o.beginPath(),o.moveTo(r+this.x+u,n+this.y+y-p-g|0),o.lineTo(r+this.x+f,n+this.y+a-p-g|0),o.lineTo(r+this.x+f,n+this.y+a-p|0),o.stroke(),o.fillText(d,r+this.x+b,n+this.y+v-p-g)}else for(let e=0,t=h.beats.length;e<t;e++){var i,s=h.beats[e],a=this.helpers.beamHelperLookup[h.voice.index].get(s.index);a&&(i=a.direction,s=a.getBeatLineX(s),a=this.calculateBeamYWithDirection(a,s,i),i===E.Down&&(p*=-1,g*=-1),o.font=l.effectFont,o.fillText(d,r+this.x+s,n+this.y+a-p-g))}o.textAlign=e,o.textBaseline=t}getStemSize(e){let t=1===e.beats.length?this.getFlagStemSize(e.shortestDuration):this.getBarStemSize(e.shortestDuration);return e.isGrace&&(t*=R.GraceScale),t}getBarStemSize(e){let t=0;switch(e){case x.QuadrupleWhole:case x.Half:case x.Quarter:case x.Eighth:case x.Sixteenth:t=6;break;case x.ThirtySecond:t=8;break;case x.SixtyFourth:case x.OneHundredTwentyEighth:t=9;break;case x.TwoHundredFiftySixth:t=10;break;default:t=0}return this.getScoreHeight(t)}getFlagStemSize(e){let t=0;switch(e){case x.QuadrupleWhole:case x.Half:case x.Quarter:case x.Eighth:case x.Sixteenth:case x.ThirtySecond:case x.SixtyFourth:case x.OneHundredTwentyEighth:case x.TwoHundredFiftySixth:t=6;break;default:t=0}return this.getScoreHeight(t)}get middleYPosition(){return this.getScoreY(this.bar.staff.standardNotationLineCount-1)}getNoteY(e,t){let i=super.getNoteY(e,t);return isNaN(i)&&(t=ua.computeLineWithoutAccidentals(this.bar,e),i=this.getScoreY(t)),i}calculateBeamY(e,t){return this.calculateBeamYWithDirection(e,t,e.direction)}applyLayoutingInfo(){var e,t,i,s=super.applyLayoutingInfo();return s&&this.bar.isMultiVoice&&(e=this.getScoreY(-2),t=this.getScoreY(6),(i=this.helpers.collisionHelper.getBeatMinMaxY())[0]<e&&this.registerOverflowTop(Math.abs(i[0])),i[1]>t)&&this.registerOverflowBottom(Math.abs(i[1])-t),s}calculateBeamYWithDirection(e,t,i){var s,a,r,n,o=this.getStemSize(e);return e.drawingInfos.has(i)||(s=new ga,e.drawingInfos.set(i,s),a=e.beats[0],n=e.beats[e.beats.length-1],r=e.isRestBeamHelper,s.startBeat=a,s.startX=e.getBeatLineX(a),s.startY=r?i===E.Up?this.getScoreY(e.minRestLine):this.getScoreY(e.maxRestLine):i===E.Up?this.getScoreY(this.accidentalHelper.getMinLine(a))-o:this.getScoreY(this.accidentalHelper.getMaxLine(a))+o,s.endBeat=n,s.endX=e.getBeatLineX(n),s.endY=r?i===E.Up?this.getScoreY(e.minRestLine):this.getScoreY(e.maxRestLine):i===E.Up?this.getScoreY(this.accidentalHelper.getMinLine(n))-o:this.getScoreY(this.accidentalHelper.getMaxLine(n))+o,a=10*this.scale,i===E.Down&&s.startY>s.endY&&s.startY-s.endY>a&&(s.endY=s.startY-a),i===E.Down&&s.endY>s.startY&&s.endY-s.startY>a&&(s.startY=s.endY-a),i===E.Up&&s.startY<s.endY&&s.endY-s.startY>a&&(s.endY=s.startY+a),i===E.Up&&s.endY<s.startY&&s.startY-s.endY>a&&(s.startY=s.endY+a),1<e.beats.length&&(i===E.Up?(r=this.getScoreY(this.accidentalHelper.getMinLine(e.beatOfHighestNote))-o,0<(n=s.calcY(e.getBeatLineX(e.beatOfHighestNote))-r)&&(s.startY-=n,s.endY-=n)):0<(a=this.getScoreY(this.accidentalHelper.getMaxLine(e.beatOfLowestNote))+o-s.calcY(e.getBeatLineX(e.beatOfLowestNote)))&&(s.startY+=a,s.endY+=a),null===e.minRestLine&&null===e.maxRestLine||(r=Be.getIndex(e.shortestDuration)-2,n=e.isGrace?R.GraceScale:1,o=r*(_a.BeamSpacing+_a.BeamThickness)*this.scale*n,o+=_a.BeamSpacing,i===E.Up&&null!==e.minRestLine?(a=this.getScoreY(e.minRestLine)-o,0<(r=s.calcY(e.getBeatLineX(e.beatOfMinRestLine))-a)&&(s.startY-=r,s.endY-=r)):i===E.Down&&null!==e.maxRestLine&&0<(n=this.getScoreY(e.maxRestLine)+o-s.calcY(e.getBeatLineX(e.beatOfMaxRestLine)))&&(s.startY+=n,s.endY+=n)))),e.drawingInfos.get(i).calcY(t)}paintBar(h,t,l,d){for(let o=0,e=d.beats.length;o<e;o++){var c=d.beats[o],i=c.graceType!==_.None?R.GraceScale:1,u=d.getBeatLineX(c),s=d.direction,a=t+this.y,p=(a+=s===E.Up?this.getScoreY(this.accidentalHelper.getMaxLine(c)):this.getScoreY(this.accidentalHelper.getMinLine(c)),t+this.y);p+=this.calculateBeamY(d,u),l.lineWidth=_a.StemWidth*this.scale,l.beginPath(),l.moveTo(h+this.x+u,a),l.lineTo(h+this.x+u,p),l.stroke(),l.lineWidth=this.scale;let e=p;s===E.Down?e+=2*l.font.size:0!==o&&(e-=1.5*l.font.size),this.paintFingering(l,c,h+this.x+u,s,e);var g=6*this.scale*i;let r=(_a.BeamSpacing+_a.BeamThickness)*this.scale*i,n=_a.BeamThickness*this.scale*i;var m=Be.getIndex(c.duration)-2,f=t+this.y;s===E.Down&&(r=-r,n=-n);for(let a=0;a<m;a++){let e=0,t=0,i=0,s=0;var y=f+a*r;if(o<d.beats.length-1){if(ma.isFullBarJoin(c,d.beats[o+1],a))e=u,t=d.getBeatLineX(d.beats[o+1]);else{if(0!==o&&ma.isFullBarJoin(d.beats[o-1],c,a))continue;e=u,t=e+g}i=y+this.calculateBeamY(d,e),s=y+this.calculateBeamY(d,t),En.paintSingleBar(l,h+this.x+e,i,h+this.x+t,s,n)}else 0<o&&!ma.isFullBarJoin(c,d.beats[o-1],a)&&(e=u-g,t=u,i=y+this.calculateBeamY(d,e),s=y+this.calculateBeamY(d,t),En.paintSingleBar(l,h+this.x+e,i,h+this.x+t,s,n))}}}static paintSingleBar(e,t,i,s,a,r){e.beginPath(),e.moveTo(t,i),e.lineTo(s,a),e.lineTo(s,a+r),e.lineTo(t,i+r),e.closePath(),e.fill()}paintFlag(a,r,n,o){var h=o.beats[0];if(h.graceType!==_.BendGrace&&(h.graceType===_.None||this.settings.notation.notationMode!==T.NotationMode.SongBook)){var l=h.graceType!==_.None,d=l?R.GraceScale:1,c=this.getFlagStemSize(o.shortestDuration),u=o.getBeatLineX(h),p=o.direction;let e=this.getScoreY(this.accidentalHelper.getMinLine(h)),t=this.getScoreY(this.accidentalHelper.getMaxLine(h)),i=0,s=0;s=p===E.Down?(t+=c*d,i=t,r+this.y+t):(e-=c*d,i=e,r+this.y+e),this.paintFingering(n,h,a+this.x+u,p,s),o.hasLine&&(n.lineWidth=_a.StemWidth*this.scale,n.beginPath(),n.moveTo(a+this.x+u,r+this.y+e),n.lineTo(a+this.x+u,r+this.y+t),n.stroke(),n.lineWidth=this.scale,h.graceType===_.BeforeBeat&&(c=15*this.scale,d=12*this.scale,n.beginPath(),p===E.Down?(n.moveTo(a+this.x+u-d/2,r+this.y+t-c),n.lineTo(a+this.x+u+d/2,r+this.y+t)):(n.moveTo(a+this.x+u-d/2,r+this.y+e+c),n.lineTo(a+this.x+u+d/2,r+this.y+e)),n.stroke()),o.hasFlag)&&((c=new xs(u-this.scale/2,i,h.duration,p,l)).renderer=this,c.doLayout(),c.paint(a+this.x,r+this.y,n))}}paintFingering(i,s,a,e,r){var n=this.settings;if(n.notation.fingeringMode===T.FingeringMode.ScoreDefault||n.notation.fingeringMode===T.FingeringMode.ScoreForcePiano){e===E.Up?a-=10*this.scale:a+=3*this.scale;var o=s.notes.slice(0);o.sort((e,t)=>e.realValue-t.realValue);for(let t=0;t<o.length;t++){var h=o[t];let e=null;h.leftHandFinger!==v.Unknown?e=Be.fingerToString(n,s,h.leftHandFinger,!0):h.rightHandFinger!==v.Unknown&&(e=Be.fingerToString(n,s,h.rightHandFinger,!1)),e&&(i.fillText(e,a,r),r-=0|i.font.size)}}}createPreBeatGlyphs(){if(super.createPreBeatGlyphs(),this.bar.masterBar.isRepeatStart&&this.addPreBeatGlyph(new Wr(0,0,1.5,3)),this.isFirstOfLine||this.bar.clef!==this.bar.previousBar.clef||this.bar.clefOttava!==this.bar.previousBar.clefOttava){let e=0;switch(this.bar.clef){case c.Neutral:e=this.bar.staff.standardNotationLineCount-1;break;case c.F4:e=2;break;case c.C3:e=4;break;case c.C4:e=2;break;case c.G2:e=6}this.createStartSpacing(),this.addPreBeatGlyph(new Gr(0,this.getScoreY(e)+.5*_a.StaffLineThickness,this.bar.clef,this.bar.clefOttava))}(0===this.index&&this.bar.masterBar.keySignature!==n.C||this.bar.previousBar&&this.bar.masterBar.keySignature!==this.bar.previousBar.masterBar.keySignature)&&(this.createStartSpacing(),this.createKeySignatureGlyphs()),(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator)&&(this.createStartSpacing(),this.createTimeSignatureGlyphs()),this.addPreBeatGlyph(new Ar(0,this.getScoreHeight(-.5),this.bar.index+1))}createBeatGlyphs(){for(let e=0;e<this.bar.voices.length;e++){var t=this.bar.voices[e];this.hasVoiceContainer(t)&&this.createVoiceGlyphs(t)}}createPostBeatGlyphs(){super.createPostBeatGlyphs(),this.bar.masterBar.isRepeatEnd?(this.addPostBeatGlyph(new Hr(this.x,0)),2<this.bar.masterBar.repeatCount&&this.addPostBeatGlyph(new Vr(0,this.getScoreHeight(-.5),this.bar.masterBar.repeatCount))):this.addPostBeatGlyph(new Or(0,0))}createStartSpacing(){this._startSpacing||(this.addPreBeatGlyph(new cn(0,0,2*this.scale)),this._startSpacing=!0)}createKeySignatureGlyphs(){let t=0;var i=this.bar.masterBar.keySignature,e=this.bar.previousBar?this.bar.previousBar.masterBar.keySignature:0;switch(this.bar.clef){case c.Neutral:t=0;break;case c.G2:t=1;break;case c.F4:t=3;break;case c.C3:t=2;break;case c.C4:t=0}var s=new Map,a=[];if(Be.keySignatureIsSharp(i))for(let e=0;e<Math.abs(i);e++){var r=En.SharpKsSteps[e]+t;a.push(new Rr(0,this.getScoreY(r),Gs.Sharp,!1)),s.set(r,!0)}else for(let e=0;e<Math.abs(i);e++){var n=En.FlatKsSteps[e]+t;a.push(new Rr(0,this.getScoreY(n),Gs.Flat,!1)),s.set(n,!0)}var o,h=Math.abs(e),l=Be.keySignatureIsSharp(e)?En.SharpKsSteps:En.FlatKsSteps;for(let e=0;e<h;e++){var d=l[e]+t;s.has(d)||this.addPreBeatGlyph(new Rr(0,this.getScoreY(l[e]+t),Gs.Natural,!1))}for(o of a)this.addPreBeatGlyph(o)}createTimeSignatureGlyphs(){this.addPreBeatGlyph(new cn(0,0,5*this.scale));var e=this.bar.staff.standardNotationLineCount-1;this.addPreBeatGlyph(new vn(0,this.getScoreY(e),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon))}createVoiceGlyphs(i){for(let e=0,t=i.beats.length;e<t;e++){var s=i.beats[e],s=new Pn(s,this.getVoiceContainer(i));s.preNotes=new bn,s.onNotes=new fn,this.addBeatGlyph(s)}}getNoteLine(e){return this.accidentalHelper.getNoteLine(e)}getScoreY(e){return this._firstLineY+this.lineOffset+this.getScoreHeight(e)}getScoreHeight(e){return this.lineOffset/2*e}paintBackground(t,i,s){super.paintBackground(t,i,s);var e=this.resources;s.color=e.staffLineColor;for(let e=0;e<this.bar.staff.standardNotationLineCount;e++){var a=i+this.y+this.getScoreY(2*e);s.fillRect(t+this.x,0|a,this.width,this.scale*_a.StaffLineThickness)}s.color=e.mainGlyphColor,this.paintSimileMark(t,i,s)}completeBeamingHelper(s){if(this.bar.isMultiVoice&&s.highestNoteInHelper&&s.lowestNoteInHelper){let e=this.getNoteY(s.highestNoteInHelper,A.Center),t=this.getNoteY(s.lowestNoteInHelper,A.Center),i=this.getStemSize(s);s.hasTuplet&&(i+=2*this.resources.effectFont.size),s.direction==E.Up?e-=i:t+=i;for(const a of s.beats)this.helpers.collisionHelper.reserveBeatSlot(a,e,t)}}}En.StaffId="score",En.SharpKsSteps=[-1,2,-2,1,4,0,3],En.FlatKsSteps=[3,0,4,1,5,2,6];class Cn extends oa{get staffId(){return En.StaffId}create(e,t){return new En(e,t)}constructor(){super()}}class Fn extends Ts{constructor(e,t,i,s){super(0,0),this._inType=e,this._outType=t,this._startNote=i,this._parent=s}doLayout(){this.width=0}paint(e,t,i){this.paintSlideIn(e,t,i),this.paintSlideOut(e,t,i)}paintSlideIn(e,t,i){var s=this.renderer,a=12*this.scale,r=3*this.scale;let n=0,o=0,h=0,l=0;switch(this._inType){case q.IntoFromBelow:h=e+s.x+s.getNoteX(this._startNote,Hs.Left),l=t+s.y+s.getNoteY(this._startNote,A.Center),n=h-a,o=t+s.y+s.getNoteY(this._startNote,A.Center)+r;break;case q.IntoFromAbove:h=e+s.x+s.getNoteX(this._startNote,Hs.Left),l=t+s.y+s.getNoteY(this._startNote,A.Center),n=h-a,o=t+s.y+s.getNoteY(this._startNote,A.Center)-r;break;default:return}this.paintSlideLine(i,!1,n,h,o,l)}paintSlideOut(e,t,i){var s=this.renderer,a=12*this.scale,r=3*this.scale;let n=0,o=0,h=0,l=0,d=!1;var c,u=2*this.scale;switch(this._outType){case m.Shift:case m.Legato:n=e+s.x+s.getBeatX(this._startNote.beat,Os.PostNotes),o=t+s.y+s.getNoteY(this._startNote,A.Center),this._startNote.slideTarget?(c=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,this._startNote.slideTarget.beat.voice.bar),l=c&&c.staff===s.staff?(h=e+c.x+c.getBeatX(this._startNote.slideTarget.beat,Os.OnNotes)-u,t+c.y+c.getNoteY(this._startNote.slideTarget,A.Center)):(h=e+s.x+this._parent.x,o),this._startNote.slideTarget.fret>this._startNote.fret?(o+=r,l-=r):(o-=r,l+=r)):(h=e+s.x+this._parent.x,l=o);break;case m.OutUp:n=e+s.x+s.getNoteX(this._startNote,Hs.Right),o=t+s.y+s.getNoteY(this._startNote,A.Center),h=n+a-u,l=t+s.y+s.getNoteY(this._startNote,A.Center)-r;break;case m.OutDown:n=e+s.x+s.getNoteX(this._startNote,Hs.Right),o=t+s.y+s.getNoteY(this._startNote,A.Center),h=n+a-u,l=t+s.y+s.getNoteY(this._startNote,A.Center)+r;break;case m.PickSlideDown:n=e+s.x+s.getNoteX(this._startNote,Hs.Right),o=t+s.y+s.getNoteY(this._startNote,A.Center),h=e+s.x+s.getBeatX(this._startNote.beat,Os.EndBeat),l=o+3*r,d=!0;break;case m.PickSlideUp:n=e+s.x+s.getNoteX(this._startNote,Hs.Right),o=t+s.y+s.getNoteY(this._startNote,A.Center),h=e+s.x+s.getBeatX(this._startNote.beat,Os.EndBeat),l=o-3*r,d=!0;break;default:return}this.paintSlideLine(i,d,n,h,o,l)}paintSlideLine(e,t,i,s,a,r){var n,o,h;t?((t=new nr(0,0,J.Slight,1.2)).renderer=this.renderer,t.doLayout(),a-=t.height/2,h=s-i,n=(r-=t.height/2)-a,o=Math.sqrt(Math.pow(n,2)+Math.pow(h,2)),t.width=h,h=Math.asin(n/o)*(180/Math.PI),e.beginRotate(i,a,h),t.paint(0,0,e),e.endRotate()):(e.beginPath(),e.moveTo(i,a),e.lineTo(s,r),e.stroke())}}class Ln extends qr{constructor(e,t,i=!1){super(e.beat,t.beat,i),this.startNote=e,this.endNote=t}getTieHeight(e,t,i,s){return this.startNote===this.endNote?15:super.getTieHeight(e,t,i,s)}getBeamDirection(e,t){return this.startNote===this.endNote?E.Up:Ln.getBeamDirectionForNote(this.startNote)}static getBeamDirectionForNote(e){return 3<e.string?E.Up:E.Down}getStartY(){return this.startNote===this.endNote?this.startNoteRenderer.getNoteY(this.startNote,A.Center):this.tieDirection===E.Up?this.startNoteRenderer.getNoteY(this.startNote,A.Top):this.startNoteRenderer.getNoteY(this.startNote,A.Bottom)}getEndY(){return this.getStartY()}getStartX(){return this.startNote===this.endNote?this.getEndX()-20*this.scale:this.startNoteRenderer.getNoteX(this.startNote,Hs.Center)}getEndX(){return this.startNote===this.endNote?this.endNoteRenderer.getNoteX(this.endNote,Hs.Left):this.endNoteRenderer.getNoteX(this.endNote,Hs.Center)}}class Mn extends Ln{constructor(e,t,i,s=!1){super(e,t,s),this._direction=Ln.getBeamDirectionForNote(e),this._forSlide=i}getTieHeight(e,t,i,s){return Math.log(i-e+1)*this.renderer.settings.notation.slurHeight}tryExpand(e,t,i,s){if(this._forSlide!==i)return!1;if(this.forEnd!==s)return!1;if(this.startNote.beat.id!==e.beat.id)return!1;if(this.endNote.beat.id!==t.beat.id)return!1;if(this._direction!==Ln.getBeamDirectionForNote(e))return!1;switch(this._direction){case E.Up:e.realValue>this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue>this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat);break;case E.Down:e.realValue<this.startNote.realValue&&(this.startNote=e,this.startBeat=e.beat),t.realValue<this.endNote.realValue&&(this.endNote=t,this.endBeat=t.beat)}return!0}paint(e,t,i){var s=this.renderer.scoreRenderer.layout.getRendererForBar(this.renderer.staff.staveId,this.startBeat.voice.bar),s=this.getBeamDirection(this.startBeat,s),s="tab.slur."+this.startNote.beat.id+"."+this.endNote.beat.id+"."+s,a=this.renderer;a.staff.getSharedLayoutData(s,!1)||(a.staff.setSharedLayoutData(s,!0),super.paint(e,t,i))}}class Dn extends Ps{constructor(e,t){super(e,t),this._bend=null,this._effectSlurs=[]}doLayout(){this._effectSlurs=[],super.doLayout(),this._bend&&(this._bend.renderer=this.renderer,this._bend.doLayout(),this.updateWidth())}createTies(t){if(t.isVisible){var i,s=this.renderer;if(t.isTieOrigin&&s.showTiedNotes&&t.tieDestination.isVisible&&(i=new Ln(t,t.tieDestination,!1),this.addTie(i)),t.isTieDestination&&s.showTiedNotes&&(i=new Ln(t.tieOrigin,t,!0),this.addTie(i)),t.isLeftHandTapped&&!t.isHammerPullDestination&&(s=new Ln(t,t,!1),this.addTie(s)),t.isEffectSlurOrigin&&t.effectSlurDestination){let e=!1;for(var a of this._effectSlurs)if(a.tryExpand(t,t.effectSlurDestination,!1,!1)){e=!0;break}e||(i=new Mn(t,t.effectSlurDestination,!1,!1),this._effectSlurs.push(i),this.addTie(i))}if(t.isEffectSlurDestination&&t.effectSlurOrigin){let e=!1;for(var r of this._effectSlurs)if(r.tryExpand(t.effectSlurOrigin,t,!1,!0)){e=!0;break}e||(s=new Mn(t.effectSlurOrigin,t,!1,!0),this._effectSlurs.push(s),this.addTie(s))}t.slideInType===q.None&&t.slideOutType===m.None||(i=new Fn(t.slideInType,t.slideOutType,t,this),this.addTie(i)),t.hasBend&&(this._bend||(s=new hn,(this._bend=s).renderer=this.renderer,this.addTie(s)),this._bend.addBends(t))}}}class In extends Ts{constructor(e,t,i){super(e,t),this._noteString=null,this._trillNoteString=null,this._trillNoteStringWidth=0,this.isEmpty=!1,this.noteStringWidth=0,this._note=i}doLayout(){var e,t=this._note;let i=t.fret-t.beat.voice.bar.staff.transpositionPitch;if(t.harmonicType===g.Natural&&0!==t.harmonicValue&&(i=t.harmonicValue-t.beat.voice.bar.staff.transpositionPitch),t.isTieDestination?0===t.beat.index&&this.renderer.settings.notation.notationMode==T.NotationMode.GuitarPro||(t.bendType===w.Bend||t.bendType===w.BendRelease)&&this.renderer.settings.notation.isNotationElementVisible(f.TabNotesOnTiedBends)?this._noteString="("+(t.tieOrigin.fret-t.beat.voice.bar.staff.transpositionPitch).toString()+")":this._noteString="":(this._noteString=t.isDead?"x":i.toString(),t.isGhost?this._noteString="("+this._noteString+")":t.harmonicType===g.Natural&&(0<=(e=this._noteString.indexOf(String.fromCharCode(46)))&&(this._noteString=this._noteString.substr(0,e+2)),this._noteString="<"+this._noteString+">")),t.isTrill)this._trillNoteString="("+(t.trillFret-t.beat.voice.bar.staff.transpositionPitch).toString()+")";else if(Be.isAlmostEqualTo(t.harmonicValue,0))this._trillNoteString="";else switch(t.harmonicType){case g.Artificial:case g.Pinch:case g.Tap:case g.Semi:case g.Feedback:let e=(i+t.harmonicValue).toString();var s=e.indexOf(String.fromCharCode(46));0<=s&&(e=e.substr(0,s+2)),this._trillNoteString="<"+e+">";break;default:this._trillNoteString=""}this.isEmpty=!this._noteString,this.isEmpty||(this.renderer.scoreRenderer.canvas.font=this.renderer.resources.tablatureFont,this.noteStringWidth=this.renderer.scoreRenderer.canvas.measureText(this._noteString)*this.scale,this.width=this.noteStringWidth,this.height=this.renderer.scoreRenderer.canvas.font.size,this._trillNoteString&&(this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,this._trillNoteStringWidth=3*this.scale+this.renderer.scoreRenderer.canvas.measureText(this._trillNoteString),this.width+=this._trillNoteStringWidth))}paint(e,t,i){var s;this.isEmpty||(s=this.noteStringWidth+this._trillNoteStringWidth,e=e+this.x+(this.width-s)/2,s=this.renderer.scoreRenderer.canvas.font,this.renderer.scoreRenderer.canvas.font=this.renderer.resources.graceFont,""!=this._note.realValue&&(i.color=Be.getNoteColor(this._note.realValue),i.lineWidth=2,i.strokeCircle(e+this.noteStringWidth/2,t+this.y,.8*i.font.size*this.scale),i.color=0===this._note.beat.voice.index?this.renderer.resources.mainGlyphColor:this.renderer.resources.secondaryGlyphColor),i.fillText(this._trillNoteString,e+this.noteStringWidth+3*this.scale,t+this.y),this.renderer.scoreRenderer.canvas.font=s,i.fillText(this._noteString,e,t+this.y))}buildBoundingsLookup(e,t,i){var s=new os;s.note=this._note,s.noteHeadBounds=new Ze,s.noteHeadBounds.x=t+this.x,s.noteHeadBounds.y=i+this.y-this.height/2,s.noteHeadBounds.w=this.width,s.noteHeadBounds.h=this.height,e.addNote(s)}}class Rn extends Ts{constructor(e,t,i){super(e,t),this._notes=[],this.minStringNote=null,this.beatEffects=new Map,this.notesPerString=new Map,this.noteStringWidth=0,this._isGrace=i}buildBoundingsLookup(e,t,i){for(const s of this._notes)s.buildBoundingsLookup(e,t+this.x,i+this.y)}getNoteX(t,i){if(this.notesPerString.has(t.string)){var s=this.notesPerString.get(t.string);let e=this.x+s.x;switch(i){case Hs.Left:break;case Hs.Center:e+=s.noteStringWidth/2;break;case Hs.Right:e+=s.width}return e}return 0}getNoteY(t,i){if(this.notesPerString.has(t.string)){var s=this.notesPerString.get(t.string);let e=this.y+s.y;switch(i){case A.Top:case A.TopWithStem:e-=s.height/2+2*this.scale;break;case A.Center:break;case A.Bottom:case A.BottomWithStem:e+=s.height/2}return e}return 0}doLayout(){let i=0,s=0;for(let e=0,t=this._notes.length;e<t;e++){var a=this._notes[e];a.renderer=this.renderer,a.doLayout(),a.width>i&&(i=a.width),a.noteStringWidth>s&&(s=a.noteStringWidth)}this.noteStringWidth=s;var e=this.renderer.resources.tablatureFont.size;let t=this.getNoteY(this.minStringNote,A.Center)+e/2;var r=7*this.scale;for(const n of this.beatEffects.values())n.y+=t,n.x+=this.width/2,n.renderer=this.renderer,t+=r,n.doLayout();this.width=i}addNoteGlyph(e,t){this._notes.push(e),this.notesPerString.set(t.string,e),(!this.minStringNote||t.string<this.minStringNote.string)&&(this.minStringNote=t)}paint(e,t,i){e+=this.x,t+=this.y;var s,a=this.renderer.resources,r=i.textBaseline,a=(i.textBaseline=P.Middle,i.font=this._isGrace?a.graceFont:a.tablatureFont,this._notes),n=this.width;for(s of a)s.renderer=this.renderer,s.width=n,s.paint(e,t,i);i.textBaseline=r;for(const o of this.beatEffects.values())o.paint(e,t,i)}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}}class An extends Ns{constructor(e,t,i,s){super(e,t,1,tn.getSymbol(s)),this._isVisibleRest=i,this._duration=s}doLayout(){this._isVisibleRest?this.width=tn.getSize(this._duration)*this.scale:this.width=10*this.scale}updateBeamingHelper(e){this.beamingHelper&&this.beamingHelper.isPositionFrom("tab",this.beat)&&this.beamingHelper.registerBeatLineX("tab",this.beat,e+this.x+this.width/2,e+this.x+this.width/2)}paint(e,t,i){this._isVisibleRest&&super.paint(e,t,i)}}class On extends Na{constructor(){super(...arguments),this.noteNumbers=null,this.restGlyph=null}getNoteX(e,t){return this.noteNumbers?this.noteNumbers.getNoteX(e,t):0}getNoteY(e,t){return this.noteNumbers?this.noteNumbers.getNoteY(e,t):0}buildBoundingsLookup(e,t,i){this.noteNumbers&&this.noteNumbers.buildBoundingsLookup(e,t+this.x,i+this.y)}doLayout(){var t=this.renderer;if(this.container.beat.isRest){var i=Math.floor((this.renderer.bar.staff.tuning.length-1)/2),s=t.getTabY(i),i=new An(0,s,t.showRests,this.container.beat.duration);if((this.restGlyph=i).beat=this.container.beat,i.beamingHelper=this.beamingHelper,this.addGlyph(i),0<this.container.beat.dots&&t.showRests){this.addGlyph(new cn(0,0,5*this.scale));for(let e=0;e<this.container.beat.dots;e++)this.addGlyph(new Ur(0,s,1.5*this.scale))}}else{var e,i=this.renderer.settings.notation.smallGraceTabNotes&&this.container.beat.graceType!==_.None,i=new Rn(0,0,i);(this.noteNumbers=i).beat=this.container.beat,i.beamingHelper=this.beamingHelper;for(e of this.container.beat.notes)e.isVisible&&this.createNoteGlyph(e);if(this.addGlyph(i),this.container.beat.hasWhammyBar&&((i=new ln(this.container.beat)).renderer=this.renderer,i.doLayout(),this.container.ties.push(i)),this.container.beat.isTremolo&&!this.noteNumbers.beatEffects.has("tremolo")){let e=0;i=this.container.beat.tremoloSpeed;switch(i){case x.ThirtySecond:e=10;break;case x.Sixteenth:e=5;break;case x.Eighth:e=0}this.noteNumbers.beatEffects.set("tremolo",new Zr(5*this.scale,e*this.scale,i))}if(0<this.container.beat.dots&&t.settings.notation.rhythmMode!==T.TabRhythmMode.Hidden){this.addGlyph(new cn(0,0,5*this.scale));for(let e=0;e<this.container.beat.dots;e++)this.addGlyph(new Ur(0,t.lineOffset*t.bar.staff.tuning.length+t.settings.notation.rhythmHeight*t.scale,1.5*this.scale))}}if(this.glyphs){let i=0;for(let e=0,t=this.glyphs.length;e<t;e++){var a=this.glyphs[e];a.x=i,a.renderer=this.renderer,a.doLayout(),i+=a.width}this.width=i,this.computedWidth=i,this.container.beat.isEmpty?this.centerX=this.width/2:this.container.beat.isRest?this.centerX=this.restGlyph.x+this.restGlyph.width/2:this.centerX=this.noteNumbers.x+this.noteNumbers.noteStringWidth/2}}updateBeamingHelper(){(this.container.beat.isRest?this.restGlyph:this.noteNumbers).updateBeamingHelper(this.container.x+this.x)}createNoteGlyph(e){var t=this.renderer,i=new In(0,0,e),s=e.beat.voice.bar.staff.tuning.length-e.string,t=(i.y=t.getTabY(s),i.renderer=this.renderer,i.doLayout(),this.noteNumbers.addNoteGlyph(i,e),i.y-i.height/2),s=t+i.height;this.renderer.helpers.collisionHelper.reserveBeatSlot(this.container.beat,t,s)}}class Gn extends Ts{constructor(e){super(0,0),this._beat=e}doLayout(){this.width=10*this.scale}paint(e,t,i){var s,a,r=this.renderer,n=t+this.x+r.getNoteY(this._beat.maxStringNote,A.Top),t=t+this.y+r.getNoteY(this._beat.minStringNote,A.Bottom),r=e+this.x+this.width/2|0,o=8*this.scale;this._beat.brushType!==U.None&&(this._beat.brushType===U.BrushUp||this._beat.brushType===U.BrushDown?(i.beginPath(),i.moveTo(r,n),i.lineTo(r,t),i.stroke()):this._beat.brushType===U.ArpeggioUp?((a=new nr(0,0,J.Slight,1.2,!0)).renderer=this.renderer,a.doLayout(),s=t-o,a.width=Math.abs(s-n),i.beginRotate(e+this.x+4*this.scale,s,-90),a.paint(0,-a.height/2,i),i.endRotate()):this._beat.brushType===U.ArpeggioDown&&((s=new nr(0,0,J.Slight,1.2,!0)).renderer=this.renderer,s.doLayout(),a=n+o,s.width=Math.abs(t-a),i.beginRotate(e+this.x+4*this.scale,a,90),s.paint(0,-s.height/2,i),i.endRotate()),this._beat.brushType===U.BrushUp||this._beat.brushType===U.ArpeggioUp?(i.beginPath(),i.moveTo(r,t),i.lineTo(r+o/2,t-o),i.lineTo(r-o/2,t-o)):(i.beginPath(),i.moveTo(r,n),i.lineTo(r+o/2,n+o),i.lineTo(r-o/2,n+o)),i.closePath(),i.fill())}}class Hn extends ka{doLayout(){this.container.beat.brushType===U.None||this.container.beat.isRest||(this.addGlyph(new Gn(this.container.beat)),this.addGlyph(new cn(0,0,4*this.scale))),super.doLayout()}constructor(){super()}}class Vn extends Ts{constructor(e,t){super(e,t)}doLayout(){this.width=28*this.scale}paint(e,t,i){var s=this.renderer.bar.staff.tuning.length,a=s<=4?k.FourStringTabClef:k.SixStringTabClef;i.fillMusicFontSymbol(e+this.x+5*this.scale,t+this.y,(s<=4?s/4.5:s/6.5)*this.scale,a,!1)}}class Wn extends wn{get commonScale(){return 1}get numberScale(){return this.renderer.bar.staff.tuning.length<=4?R.GraceScale:1}}class zn extends _a{constructor(e,t){super(e,t),this._firstLineY=0,this._tupletSize=0,this.showTimeSignature=!1,this.showRests=!1,this.showTiedNotes=!1,this._startSpacing=!1}get lineOffset(){return(zn.TabLineSpacing+1)*this.scale}updateSizes(){var e=this.resources,e=(e.tablatureFont.size/2+.2*e.tablatureFont.size)*this.scale;this.topPadding=e,this.bottomPadding=e,this.height=this.lineOffset*(this.bar.staff.tuning.length-1)+2*e,this.settings.notation.rhythmMode!==T.TabRhythmMode.Hidden&&(this.height+=this.settings.notation.rhythmHeight*this.settings.display.scale,this.bottomPadding+=this.settings.notation.rhythmHeight*this.settings.display.scale),this.updateFirstLineY(),super.updateSizes()}updateFirstLineY(){var e=this.resources;this._firstLineY=(e.tablatureFont.size/2+.2*e.tablatureFont.size)*this.scale}doLayout(){if(this.updateFirstLineY(),super.doLayout(),this.settings.notation.rhythmMode!==T.TabRhythmMode.Hidden){let e=!1;for(var t of this.bar.voices)if(this.hasVoiceContainer(t))if(0<this.getVoiceContainer(t).tupletGroups.length){e=!0;break}e&&(this._tupletSize=.8*this.resources.effectFont.size,this.registerOverflowBottom(this._tupletSize))}}createPreBeatGlyphs(){var e;super.createPreBeatGlyphs(),this.bar.masterBar.isRepeatStart&&this.addPreBeatGlyph(new Wr(0,0,1.5,3)),this.isFirstOfLine&&(e=(this.bar.staff.tuning.length-1)/2,this.addPreBeatGlyph(new Vn(5*this.scale,this.getTabY(e)))),this.showTimeSignature&&(!this.bar.previousBar||this.bar.previousBar&&this.bar.masterBar.timeSignatureNumerator!==this.bar.previousBar.masterBar.timeSignatureNumerator||this.bar.previousBar&&this.bar.masterBar.timeSignatureDenominator!==this.bar.previousBar.masterBar.timeSignatureDenominator)&&(this.createStartSpacing(),this.createTimeSignatureGlyphs()),this.addPreBeatGlyph(new Ar(0,this.getTabHeight(-.5),this.bar.index+1))}createStartSpacing(){this._startSpacing||(this.addPreBeatGlyph(new cn(0,0,2*this.scale)),this._startSpacing=!0)}createTimeSignatureGlyphs(){this.addPreBeatGlyph(new cn(0,0,5*this.scale));var e=(this.bar.staff.tuning.length+1)/2-1;this.addPreBeatGlyph(new Wn(0,this.getTabY(e),this.bar.masterBar.timeSignatureNumerator,this.bar.masterBar.timeSignatureDenominator,this.bar.masterBar.timeSignatureCommon))}createVoiceGlyphs(i){for(let e=0,t=i.beats.length;e<t;e++){var s=i.beats[e],s=new Dn(s,this.getVoiceContainer(i));s.preNotes=new Hn,s.onNotes=new On,this.addBeatGlyph(s)}}createPostBeatGlyphs(){super.createPostBeatGlyphs(),this.bar.masterBar.isRepeatEnd?(this.addPostBeatGlyph(new Hr(this.x,0)),2<this.bar.masterBar.repeatCount&&this.addPostBeatGlyph(new Vr(0,this.getTabY(-1),this.bar.masterBar.repeatCount))):this.addPostBeatGlyph(new Or(0,0))}getTabY(e){return this._firstLineY+this.getTabHeight(e)}getTabHeight(e){return this.lineOffset*e}get middleYPosition(){return this.getTabY(this.bar.staff.tuning.length-1)}paintBackground(i,s,a){super.paintBackground(i,s,a);var e,t,r=this.resources,n=(a.color=r.staffLineColor,this.scale),o=[];for(let e=0,t=this.bar.staff.tuning.length;e<t;e++)o.push([]);for(e of this.bar.voices)if(this.hasVoiceContainer(e)){var h,l=this.getVoiceContainer(e);for(h of l.beatGlyphs){var d=h.onNotes,c=d.noteNumbers;if(c)for(var[u,p]of c.notesPerString)p.isEmpty||o[this.bar.staff.tuning.length-u].push(new Float32Array([l.x+h.x+d.x+c.x,c.width+n]))}}for(t of o)t.sort((e,t)=>e[0]>t[0]?1:e[0]<t[0]?-1:0);for(let t=0,e=this.bar.staff.tuning.length;t<e;t++){var g,m=this.getTabY(t);let e=0;for(g of o[t])a.fillRect(i+this.x+e,s+this.y+m|0,g[0]-e,this.scale*_a.StaffLineThickness),e=g[0]+g[1];a.fillRect(i+this.x+e,s+this.y+m|0,this.width-e,this.scale*_a.StaffLineThickness)}a.color=r.mainGlyphColor,this.paintSimileMark(i,s,a)}paint(e,t,i){super.paint(e,t,i),this.settings.notation.rhythmMode!==T.TabRhythmMode.Hidden&&(this.paintBeams(e,t,i),this.paintTuplets(e,t,i))}paintBeams(i,s,a){for(let e=0,t=this.helpers.beamHelpers.length;e<t;e++){var r=this.helpers.beamHelpers[e];for(let e=0,t=r.length;e<t;e++){var n=r[e];this.paintBeamHelper(i+this.beatGlyphsStart,s,a,n)}}}paintTuplets(e,t,i){for(var s of this.bar.voices){var a;if(this.hasVoiceContainer(s))for(a of this.getVoiceContainer(s).tupletGroups)this.paintTupletHelper(e+this.beatGlyphsStart,t,i,a)}}paintBeamHelper(e,t,i,s){i.color=0===s.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,s.isRestBeamHelper||(1===s.beats.length||this.settings.notation.rhythmMode===T.TabRhythmMode.ShowWithBeams?this.paintFooter(e,t,i,s):this.paintBar(e,t,i,s))}paintBar(n,t,o,h){for(let r=0,e=h.beats.length;r<e;r++){var l=h.beats[r];if(h.hasBeatLineX(l)){var d=h.getBeatLineX(l);let e=t+this.y;var i=t+this.y+this.height-this._tupletSize,s=this.getOnNotesGlyphForBeat(l),c=(s.noteNumbers&&l.duration!==x.Half?e+=s.noteNumbers.getNoteY(s.noteNumbers.minStringNote,A.Bottom)+this.lineOffset/2:e+=this.height-this.settings.notation.rhythmHeight*this.settings.display.scale-this._tupletSize,this.paintBeamingStem(l,t+this.y,n+this.x+d,e,i,o),6*this.scale),u=-6*this.scale,p=3*this.scale,g=Be.getIndex(l.duration)-2,m=i;for(let a=0;a<g;a++){let e=0,t=0,i=0,s=0;var f=m+a*u;if(1===h.beats.length)e=d,t=d+c,i=f,s=f,zn.paintSingleBar(o,n+this.x+e,i,n+this.x+t,s,p);else if(r<h.beats.length-1){if(ma.isFullBarJoin(l,h.beats[r+1],a))e=d,t=h.getBeatLineX(h.beats[r+1]);else{if(0!==r&&ma.isFullBarJoin(h.beats[r-1],l,a))continue;e=d,t=e+c}i=f,s=f,zn.paintSingleBar(o,n+this.x+e,i,n+this.x+t,s,p)}else 0<r&&!ma.isFullBarJoin(l,h.beats[r-1],a)&&(e=d-c,t=d,i=f,s=f,zn.paintSingleBar(o,n+this.x+e,i,n+this.x+t,s,p))}}}}paintTupletHelper(i,s,a,r){var n=this.resources,e=a.textAlign,t=a.textBaseline;a.color=0===r.voice.index?this.resources.mainGlyphColor:this.resources.secondaryGlyphColor,a.textAlign=N.Center,a.textBaseline=P.Middle;let o;var h=r.beats[0].tupletNumerator,l=r.beats[0].tupletDenominator;if(o=2===h&&3===l?"2":3===h&&2===l?"3":4===h&&6===l?"4":5===h&&4===l?"5":6===h&&4===l?"6":7===h&&4===l?"7":9===h&&8===l?"9":10===h&&8===l?"10":11===h&&8===l?"11":12===h&&8===l?"12":13===h&&8===l?"13":h+":"+l,1!==r.beats.length&&r.isFull){var d,c,u,p,h=r.beats[0],l=r.beats[r.beats.length-1],g=this.helpers.beamHelperLookup[r.voice.index].get(h.index),m=this.helpers.beamHelperLookup[r.voice.index].get(l.index);g&&m&&(g=g.getBeatLineX(h),h=m.getBeatLineX(l),a.font=n.effectFont,d=(m=(g+h)/2)-(l=a.measureText(o))/2-(c=3*this.scale),l=m+l/2+c,c=s+this.y+this.height-this._tupletSize+.5*n.effectFont.size,u=.25*-n.effectFont.size,p=-5*this.scale,a.beginPath(),a.moveTo(i+this.x+g,c-u|0),a.lineTo(i+this.x+g,c-u-p|0),a.lineTo(i+this.x+d,c-u-p|0),a.stroke(),a.beginPath(),a.moveTo(i+this.x+l,c-u-p|0),a.lineTo(i+this.x+h,c-u-p|0),a.lineTo(i+this.x+h,c-u|0),a.stroke(),a.fillText(o,i+this.x+m,c-u-p))}else for(let e=0,t=r.beats.length;e<t;e++){var f=r.beats[e],y=this.helpers.beamHelperLookup[r.voice.index].get(f.index);y&&(y=y.getBeatLineX(f),f=s+this.y+this.height-this._tupletSize+.5*n.effectFont.size,a.font=n.effectFont,a.fillText(o,i+this.x+y,f))}a.textAlign=e,a.textBaseline=t}static paintSingleBar(e,t,i,s,a,r){e.beginPath(),e.moveTo(t,i),e.lineTo(s,a),e.lineTo(s,a-r),e.lineTo(t,i-r),e.closePath(),e.fill()}paintBeamingStem(e,t,i,s,a,r){r.beginPath();let n=[],o=(this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.has(e.displayStart)&&(n=this.helpers.collisionHelper.reservedLayoutAreasByDisplayTime.get(e.displayStart).slots.slice()).sort((e,t)=>e.topY-t.topY),a);for(;o>s;){r.moveTo(i,o);let e=s;if(!(0<n.length&&n[n.length-1].bottomY>e)){r.lineTo(i,e);break}var h=n.pop();e=t+h.bottomY,r.lineTo(i,e),o=t+h.topY}r.stroke()}paintFooter(t,i,s,a){for(var r of a.beats){if(r.graceType!==_.None||r.duration===x.Whole||r.duration===x.DoubleWhole||r.duration===x.QuadrupleWhole)return;var n=a.getBeatLineX(r);let e=i+this.y;var o=i+this.y+this.height-this._tupletSize,h=this.getOnNotesGlyphForBeat(r);h.noteNumbers&&r.duration!==x.Half?e+=h.noteNumbers.getNoteY(h.noteNumbers.minStringNote,A.Bottom):e+=this.height-this.settings.notation.rhythmHeight*this.settings.display.scale-this._tupletSize,this.paintBeamingStem(r,i+this.y,t+this.x+n,e,o,s),r.duration>x.Quarter&&((h=new xs(0,0,r.duration,E.Down,!1)).renderer=this,h.doLayout(),h.paint(t+this.x+n,o,s))}}}zn.StaffId="tab",zn.TabLineSpacing=10;class Un extends oa{constructor(e,t,i){super(),this._showTimeSignature=e,this._showRests=t,this._showTiedNotes=i,this.hideOnPercussionTrack=!0}get staffId(){return zn.StaffId}canCreate(e,t){return 0<t.tuning.length&&super.canCreate(e,t)}create(e,t){e=new zn(e,t);return e.showRests=this._showRests,e.showTimeSignature=this._showTimeSignature,e.showTiedNotes=this._showTiedNotes,e}}class Xn extends ks{constructor(){super(0,0)}doLayout(){super.doLayout();var e=this.renderer.resources.effectFont;this.height=e.size+Xn.Padding*this.scale}paint(e,t,i){var s=this.renderer.resources,s=(i.font=s.effectFont,i.textAlign);i.textAlign=N.Center,i.fillText("T",e+this.x,t+this.y+i.font.size/2),i.textAlign=s,i.strokeCircle(e+this.x,t+this.y+i.font.size/2+(Xn.Padding-1)*this.scale,i.font.size/1.6)}}Xn.Padding=4;class Yn extends Xa{get notationElement(){return f.EffectTap}get sizingMode(){return Vs.SingleOnBeat}shouldCreateGlyphForNote(e){return e.isLeftHandTapped}createNewGlyph(e,t){return new Xn}}class qn{constructor(){this.noteRange=1,this.x=0,this.y=0}}(e=zs=zs||{})[e.None=0]="None",e[e.Rectangle=1]="Rectangle",e[e.Ellipse=2]="Ellipse",e[e.Circle=3]="Circle";class Jn extends qn{constructor(){super(...arguments),this.align=N.Left,this.frame=zs.None,this.text="",this.fontFace="",this.weight=0,this.height=0}}class jn extends qn{constructor(){super(...arguments),this.chord=new De}}class Qn extends qn{}class Kn extends qn{}class $n extends qn{constructor(){super(...arguments),this.number=0}}class Zn extends qn{constructor(){super(...arguments),this.decrescendo=!1}}class eo extends qn{constructor(){super(...arguments),this.allNumbers=!1,this.firstNumber=0,this.lastNumber=0}}class to extends qn{constructor(){super(...arguments),this.octave=1}}class io extends qn{}class so{constructor(){this.defaultClef=c.G2,this.description="",this.percussion=!1,this.instrument=0,this.volume=0,this.transpose=0,this.index=0}}class ao{constructor(){this.from=0,this.to=0,this.curly=!1}}class ro{constructor(){this.currentBarIndex=-1,this.currentBarComplete=!0,this.currentBarDuration=0,this.currentPosition=0,this.voiceStemDir=null,this.repeatCount=0,this.repeatEnd=null}}class no{constructor(){this._trackChannel=0,this._beamingMode=K.Auto,this._isFirstSystem=!0,this._staffLookup=new Map,this._brackets=[],this._staffLayoutLookup=new Map,this._staffLayouts=[],this._timeSignature=new Re,this._voiceStates=new Map}parseXml(e,t){this._galleryObjects=new Map,this._tieStarts=[],this._tieStartIds=new Map,this._voiceCounts=new Map,this._slurs=new Map,this._crescendo=new Map,this._isFirstSystem=!0;var i=new rt;try{i.parse(e)}catch(e){throw new fe("Could not parse XML",e)}this.parseDom(i),this.consolidate(),this.score.finish(t)}consolidate(){let e=this.score.tempo;for(const a of this.score.tracks){var t,i=this._voiceCounts.get(a.index);for(const r of a.staves){for(;r.bars.length<this.score.masterBars.length;)this.addNewBar(r);for(const n of r.bars){for(;n.voices.length<i;)n.addVoice(new Ye);for(const o of n.voices)0===o.beats.length&&((t=new Me).isEmpty=!0,o.addBeat(t));var s=n.masterBar;s.tempoAutomation&&(s.tempoAutomation.value!==e?e=s.tempoAutomation.value:s.tempoAutomation=null)}}}no.applyEffectRange(this._slurs,(e,t)=>{t.isLegatoOrigin=!0}),no.applyEffectRange(this._crescendo,(e,t)=>{t.crescendo=e.decrescendo?X.Decrescendo:X.Crescendo})}static applyEffectRange(e,i){for(var[s,a]of e){var r=a.noteRange;let t=s;for(let e=0;e<r;e++)if(i(a,t),t.index+1<t.voice.beats.length)t=t.voice.beats[t.index+1];else{if(!(t.voice.bar.index+1<t.voice.bar.staff.bars.length))break;var n=t.voice.bar.staff.bars[t.voice.bar.index+1];t=n.voices[t.voice.index].beats[0]}}}parseDom(e){var t,e=e.firstElement;if(!e)throw new fe("No valid XML");if("score"!==e.localName)throw new fe('Root node of XML was not "score"');this.score=new Ge,this.score.tempo=120;for(t of e.childNodes)if(t.nodeType===b.Element)switch(t.localName){case"info":this.parseInfo(t);break;case"layout":this.parseLayout(t);break;case"gallery":this.parseGallery(t);break;case"pageObjects":this.parsePageObjects(t);break;case"systems":this.parseSystems(t)}}parseLayout(e){for(var t of e.childNodes)if(t.nodeType===b.Element)switch(t.localName){case"staves":this.parseLayoutStaves(t);break;case"brackets":this.parseBrackets(t)}var i=this._brackets.filter(e=>!!e.curly);i.sort((e,t)=>e.from-t.from);let s=0,a=null;for(let e=0;e<this._staffLayouts.length;e++){for(var r=this._staffLayouts[e];s<i.length&&e>i[s].to;)s++;a&&s<i.length&&e>i[s].from&&e<=i[s].to?a.ensureStaveCount(a.staves.length+1):((a=new Xe).ensureStaveCount(1),a.name=r.description,a.playbackInfo.volume=Math.floor(r.volume/128*16),a.playbackInfo.program=r.instrument,r.percussion?(a.playbackInfo.primaryChannel=9,a.playbackInfo.secondaryChannel=9):(a.playbackInfo.primaryChannel=this._trackChannel++,a.playbackInfo.secondaryChannel=this._trackChannel++),this.score.addTrack(a));var n=a.staves[a.staves.length-1];n.isPercussion=r.percussion,n.transpositionPitch=r.transpose,n.displayTranspositionPitch=0,n.showTablature=!1,this._staffLookup.set(r.index,n)}}parseBrackets(e){for(var t of e.childNodes)t.nodeType===b.Element&&"bracket"===t.localName&&this.parseBracket(t)}parseBracket(e){var t=new ao;t.from=parseInt(e.getAttribute("from")),t.to=parseInt(e.getAttribute("to")),e.attributes.has("curly")&&(t.curly="true"===e.attributes.get("curly")),this._brackets.push(t)}parseLayoutStaves(e){for(var t of e.childNodes)t.nodeType===b.Element&&"staffLayout"===t.localName&&this.parseStaffLayout(t)}parseStaffLayout(e){var t,i=new so;i.description=e.getAttribute("description");for(t of e.childNodes)if(t.nodeType===b.Element)switch(t.localName){case"notation":t.attributes.has("defaultClef")&&(i.defaultClef=this.parseClef(t.attributes.get("defaultClef")));break;case"sound":t.attributes.has("percussion")&&(i.percussion="true"===t.attributes.get("percussion")),t.attributes.has("instr")&&(i.instrument=parseInt(t.attributes.get("instr"))),t.attributes.has("volume")&&(i.volume=parseInt(t.attributes.get("volume"))),t.attributes.has("transpose")&&(i.transpose=parseInt(t.attributes.get("transpose")))}this._staffLayoutLookup.set(i.description,i),i.index=this._staffLayouts.length,this._staffLayouts.push(i)}parseClef(e){switch(e){case"treble":return c.G2;case"bass":return c.F4;case"alto":case"tenor":return c.C4}return c.G2}parseClefOttava(e){return e.endsWith("-")?W._8vb:e.endsWith("+")?W._8va:W.Regular}parseSystems(e){for(var t of e.childNodes)t.nodeType===b.Element&&"system"===t.localName&&this.parseSystem(t)}parseSystem(e){e.attributes.has("tempo")&&0===this.score.masterBars.length&&(this.score.tempo=parseInt(e.attributes.get("tempo"))),"0"===e.getAttribute("beamGrouping")&&(this._beamingMode=K.ForceSplitToNext);for(var t of e.childNodes)t.nodeType===b.Element&&"staves"===t.localName&&this.parseStaves(e,t);this._isFirstSystem=!1}parseStaves(e,t){var i,s=this.score.masterBars.length;for(i of t.childNodes)i.nodeType===b.Element&&"staff"===i.localName&&this.parseStaff(e,s,i)}parseStaff(e,t,i){for(var s,a=i.getAttribute("layout"),r=(this._currentStaffLayout=this._staffLayoutLookup.get(a),this._timeSignature.timeSignatureNumerator=4,this._timeSignature.timeSignatureDenominator=4,this._timeSignature.timeSignatureCommon=!1,this.parseTime(i.getAttribute("defaultTime")),this._staffLookup.get(this._currentStaffLayout.index));r.bars.length<t;)this.addNewBar(r);for(s of i.childNodes)s.nodeType===b.Element&&"voices"===s.localName&&this.parseVoices(a,r,e,t,s)}parseTime(e){switch(e){case"allaBreve":case"C":this._timeSignature.timeSignatureNumerator=2,this._timeSignature.timeSignatureDenominator=2,this._timeSignature.timeSignatureCommon=!0;break;case"longAllaBreve":this._timeSignature.timeSignatureNumerator=4,this._timeSignature.timeSignatureDenominator=4,this._timeSignature.timeSignatureCommon=!0;break;default:var t;0<e.indexOf("/")&&(t=e.split("/"),this._timeSignature.timeSignatureNumerator=parseInt(t[0]),this._timeSignature.timeSignatureDenominator=parseInt(t[1]),this._timeSignature.timeSignatureCommon=!1)}}parseVoices(e,t,i,s,a){let r=0;for(var n of a.childNodes)n.nodeType===b.Element&&"voice"===n.localName&&(this.parseVoice(e,t,i,r,s,n),r++)}getOrCreateBar(e,t){return t<e.bars.length?e.bars[t]:this.addNewBar(e)}addNewBar(e){var t=new be;return 0<e.bars.length?(t.clef=e.bars[e.bars.length-1].clef,t.clefOttava=e.bars[e.bars.length-1].clefOttava):t.clef=this._currentStaffLayout.defaultClef,e.addBar(t),e.bars.length>this.score.masterBars.length&&(e=new Re,this.score.addMasterBar(e),0<e.index&&(e.keySignature=e.previousMasterBar.keySignature,e.keySignatureType=e.previousMasterBar.keySignatureType,e.tripletFeel=e.previousMasterBar.tripletFeel),e.timeSignatureDenominator=this._timeSignature.timeSignatureDenominator,e.timeSignatureNumerator=this._timeSignature.timeSignatureNumerator,e.timeSignatureCommon=this._timeSignature.timeSignatureCommon),t}newBar(e,t){this._currentVoiceState.currentBarIndex++,this._currentBar=this.getOrCreateBar(e,this._currentVoiceState.currentBarIndex),this._currentVoiceState.currentBarDuration=this._currentBar.masterBar.calculateDuration(!1),this._currentVoiceState.currentBarComplete=!1,this._currentVoiceState.currentPosition=0,this.ensureVoice(e,t)}parseVoice(e,t,i,s,a,r){e=e+"_"+s;if(this._currentVoiceState&&!this._currentVoiceState.currentBarComplete&&(this._currentBar.masterBar.isAnacrusis=!0),this._voiceStates.has(e)?(this._currentVoiceState=this._voiceStates.get(e),this._currentBar=this.getOrCreateBar(t,this._currentVoiceState.currentBarIndex),this.ensureVoice(t,s)):(this._currentVoiceState=new ro,this._currentVoiceState.currentBarIndex=a-1,this._voiceStates.set(e,this._currentVoiceState),this.newBar(t,s)),r.attributes.has("stemDir"))switch(r.attributes.get("stemDir")){case"up":this._currentVoiceState.voiceStemDir=E.Up;break;case"down":this._currentVoiceState.voiceStemDir=E.Down;break;default:this._currentVoiceState.voiceStemDir=null}else this._currentVoiceState.voiceStemDir=null;a=r.findChildElement("noteObjects");if(i.attributes.has("tempo")&&(this._currentBar.masterBar.tempoAutomation=new ye,this._currentBar.masterBar.tempoAutomation.isLinear=!0,this._currentBar.masterBar.tempoAutomation.type=V.Tempo,this._currentBar.masterBar.tempoAutomation.value=parseInt(i.attributes.get("tempo"))),a)for(var n of a.childNodes)if(n.nodeType===b.Element)switch(this._currentVoiceState.currentBarComplete&&"barline"!==n.localName&&this.newBar(t,s),n.localName){case"clefSign":this._currentBar.clef=this.parseClef(n.getAttribute("clef")),this._currentBar.clefOttava=this.parseClefOttava(n.getAttribute("clef"));break;case"keySign":this._currentBar.masterBar.keySignature=parseInt(n.getAttribute("fifths"));break;case"timeSign":this.parseTime(n.getAttribute("time")),this._currentBar.masterBar.timeSignatureDenominator=this._timeSignature.timeSignatureDenominator,this._currentBar.masterBar.timeSignatureNumerator=this._timeSignature.timeSignatureNumerator,this._currentBar.masterBar.timeSignatureCommon=this._timeSignature.timeSignatureCommon,this._currentVoiceState.currentPosition=0,this._currentVoiceState.currentBarDuration=this._currentBar.masterBar.calculateDuration(!1);break;case"barline":switch(n.getAttribute("type")){case"double":this._currentBar.masterBar.isDoubleBar=!0,this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;case"end":this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0);break;case"repEnd":this._currentVoiceState.repeatEnd=this._currentBar.masterBar,this._currentBar.masterBar.repeatCount<this._currentVoiceState.repeatCount&&(this._currentBar.masterBar.repeatCount=this._currentVoiceState.repeatCount),this.parseBarDrawObject(n),this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0;break;case"repBegin":this.newBar(t,s),this._currentBar.masterBar.isRepeatStart=!0,this._currentVoiceState.repeatEnd=null,this._currentVoiceState.repeatCount=0;break;case"repEndBegin":this._currentVoiceState.repeatEnd=this._currentBar.masterBar,this._currentBar.masterBar.repeatCount<this._currentVoiceState.repeatCount&&(this._currentBar.masterBar.repeatCount=this._currentVoiceState.repeatCount),this.parseBarDrawObject(n),this.newBar(t,s),this._currentBar.masterBar.isRepeatStart=!0;break;default:this._currentVoiceState.currentBarComplete||(this._currentBar.masterBar.isAnacrusis=!0),this._currentVoiceState.currentBarComplete=!0}break;case"chord":var o=new Me;this.initFromPreviousBeat(o,this._currentVoice),o.beamingMode=this._beamingMode,this._currentVoiceState.voiceStemDir&&(o.preferredBeamDirection=this._currentVoiceState.voiceStemDir),this.parseDuration(this._currentBar,o,n.findChildElement("duration")),o.updateDurations(),this._currentVoiceState.currentPosition+=o.playbackDuration,this._currentVoice.addBeat(o),this.parseChord(o,n),this._currentVoiceState.currentPosition>=this._currentVoiceState.currentBarDuration&&(this._currentVoiceState.currentBarComplete=!0);break;case"rest":o=this.parseRestDurations(this._currentBar,n.findChildElement("duration"));o&&(this.initFromPreviousBeat(o,this._currentVoice),o.updateDurations(),this._currentVoiceState.currentPosition+=o.playbackDuration,this._currentVoice.addBeat(o),this._currentVoiceState.currentPosition>=this._currentVoiceState.currentBarDuration)&&(this._currentVoiceState.currentBarComplete=!0)}}initFromPreviousBeat(e,t){t=this.getLastBeat(t);t&&(e.dynamics=t.dynamics)}getLastBeat(e){if(0<e.beats.length)return e.beats[e.beats.length-1];if(0<e.bar.index){var t=e.bar.staff.bars[e.bar.index-1];if(e.index<t.voices.length)return t=t.voices[e.index],this.getLastBeat(t)}return null}ensureVoice(e,t){for(;this._currentBar.voices.length<t+1;)this._currentBar.addVoice(new Ye);(!this._voiceCounts.has(e.track.index)||this._voiceCounts.get(e.track.index)<this._currentBar.voices.length)&&this._voiceCounts.set(e.track.index,this._currentBar.voices.length),this._currentVoice=this._currentBar.voices[t]}parseChord(e,t){var i,s=new Ne;for(i of t.childNodes)if(i.nodeType===b.Element)switch(i.localName){case"stem":switch(i.getAttribute("dir")){case"up":e.preferredBeamDirection=E.Up;break;case"down":e.preferredBeamDirection=E.Down}break;case"articulation":switch(i.getAttribute("type")){case"staccato":s.isStaccato=!0;break;case"normalAccent":s.accentuated=H.Normal;break;case"strongAccent":s.accentuated=H.Heavy}break;case"lyric":this.parseLyric(e,i);break;case"drawObjects":this.parseBeatDrawObject(e,i);break;case"heads":this.parseHeads(e,s,i);break;case"beam":switch(i.getAttribute("group")){case"force":e.beamingMode=K.ForceMergeWithNext;break;case"divide":e.beamingMode=K.ForceSplitToNext}}}parseHeads(e,t,i){for(var s of i.childNodes)s.nodeType===b.Element&&"head"===s.localName&&this.parseHead(e,t,s)}parseHead(e,t,i){var s,a=new Ne,r=Be.parseTuning(i.getAttribute("pitch"));a.octave=r.octave-1,a.tone=r.noteValue,a.isStaccato=t.isStaccato,a.accentuated=t.accentuated,e.addNote(a);for(s of i.childNodes)if(s.nodeType===b.Element)switch(s.localName){case"alter":s.attributes.has("step")&&(a.tone+=parseInt(s.attributes.get("step")));break;case"tie":s.attributes.has("begin")?this._tieStartIds.has(a.id)||(this._tieStartIds.set(a.id,!0),this._tieStarts.push(a)):s.attributes.has("end")&&0<this._tieStarts.length&&!a.isTieDestination&&(a.isTieDestination=!0,a.tieOrigin=this._tieStarts[0],this._tieStarts.splice(0,1),this._tieStartIds.delete(a.id))}}parseBeatDrawObject(e,t){for(var i of t.childNodes)i.nodeType===b.Element&&"drawObj"===i.localName&&(i=this.parseDrawObj(i))&&(i instanceof Jn?i.fontFace.startsWith("capella")?"u"===i.text?(e.fermata=new tt,e.fermata.type=te.Medium):"f"===i.text?e.dynamics=l.F:"j"===i.text&&(e.dynamics=l.MF):this._isFirstSystem&&""===this.score.title&&i.align===N.Center&&16<i.height&&400<i.weight?this.score.title=i.text:this._isFirstSystem&&""===this.score.artist&&i.align===N.Center&&i.y<0?this.score.artist=i.text:this._isFirstSystem&&""===this.score.music&&i.align===N.Right&&i.y<0?this.score.music=i.text:i.text.startsWith("by capella")||(e.text=i.text):i instanceof jn||(i instanceof Kn?e.vibrato=J.Slight:i instanceof Zn?(e.crescendo=i.decrescendo?X.Decrescendo:X.Crescendo,i.noteRange++,this._crescendo.set(e,i)):i instanceof Qn?this._slurs.set(e,i):i instanceof eo&&this.applyVolta(i)))}parseBarDrawObject(e){for(var t of e.childNodes)t.nodeType===b.Element&&"drawObj"===t.localName&&(t=this.parseDrawObj(t))&&t instanceof eo&&this.applyVolta(t)}applyVolta(i){if(0<i.lastNumber?(this._currentVoiceState.repeatCount=i.lastNumber,this._currentVoiceState.repeatEnd&&this._currentVoiceState.repeatEnd.repeatCount<this._currentVoiceState.repeatCount&&(this._currentVoiceState.repeatEnd.repeatCount=this._currentVoiceState.repeatCount)):0<i.firstNumber&&(this._currentVoiceState.repeatCount=i.firstNumber,this._currentVoiceState.repeatEnd)&&this._currentVoiceState.repeatEnd.repeatCount<this._currentVoiceState.repeatCount&&(this._currentVoiceState.repeatEnd.repeatCount=this._currentVoiceState.repeatCount),0<i.lastNumber&&0<i.firstNumber){let t=0;for(let e=i.firstNumber;e<=i.lastNumber;e++)t|=1<<e-1;this._currentBar.masterBar.alternateEndings=t}else 0<i.lastNumber?this._currentBar.masterBar.alternateEndings=1<<i.lastNumber-1:0<i.firstNumber&&(this._currentBar.masterBar.alternateEndings=1<<i.firstNumber-1)}parseLyric(t,e){for(var i of e.childNodes)if(i.nodeType===b.Element&&"verse"===i.localName){t.lyrics||(t.lyrics=[]);let e=i.innerText;"true"===i.getAttribute("hyphen")&&(e+="-"),t.lyrics.push(e)}}parseRestDurations(e,t){var i,s=t.getAttribute("base");return-1!==s.indexOf("/")?((i=new Me).beamingMode=this._beamingMode,this.parseDuration(e,i,t),i):1===parseInt(s)?((e=new Me).beamingMode=this._beamingMode,e.duration=x.Whole,e):(C.warning("Importer","Multi-Bar rests are not supported"),null)}parseDurationValue(e){switch(e){case"2/1":return x.DoubleWhole;case"1/1":return x.Whole;case"1/2":return x.Half;case"1/4":return x.Quarter;case"1/8":return x.Eighth;case"1/16":return x.Sixteenth;case"1/32":return x.ThirtySecond;case"1/64":return x.SixtyFourth;case"1/128":return x.OneHundredTwentyEighth;default:return C.warning("Importer","Unsupported duration"),x.Quarter}}parseDuration(e,t,i){var s=i.getAttribute("base"),s=(t.duration=this.parseDurationValue(s),i.attributes.has("dots")&&(t.dots=parseInt(i.attributes.get("dots"))),i.findChildElement("tuplet"));if(s){t.tupletNumerator=parseInt(s.getAttribute("count"));var a="true"===s.getAttribute("tripartite")?3:1,r="true"===s.getAttribute("prolong")?0:1;let e=0;for(;a*Math.pow(2,e+r)<t.tupletNumerator;)e++;t.tupletDenominator=a*Math.pow(2,e)}}parsePageObjects(e){for(var t of e.childNodes)if(t.nodeType===b.Element&&"drawObj"===t.localName){var i=this.parseDrawObj(t);if(i&&i instanceof Jn)switch(i.align){case N.Center:this.score.title?this.score.subTitle||(this.score.subTitle=t.innerText):this.score.title=t.innerText;break;case N.Right:this.score.artist||(this.score.artist=t.innerText)}}}parseGallery(e){for(var t of e.childNodes){var i;t.nodeType===b.Element&&"drawObj"===t.localName&&(i=this.parseDrawObj(t))&&this._galleryObjects.set(t.getAttribute("name"),i)}}parseDrawObj(e){let t=null,i=1;for(var s of e.childNodes)if(s.nodeType===b.Element)switch(s.localName){case"text":t=this.parseText(s);break;case"guitar":t=this.parseGuitar(s);break;case"slur":t=this.parseSlur(s);break;case"wavyLine":t=this.parseWavyLine(s);break;case"bracket":t=this.parseTupletBracket(s);break;case"wedge":t=this.parseWedge(s);break;case"volta":t=this.parseVolta(s);break;case"octaveClef":t=this.parseOctaveClef(s);break;case"trill":t=this.parseTrill(s);break;case"basic":s.attributes.has("noteRange")&&(i=parseInt(s.attributes.get("noteRange")))}return t&&(t.noteRange=i),t}parseTrill(e){return new io}parseOctaveClef(e){var t=new to;return e.attributes.has("octave")&&(t.octave=parseInt(e.attributes.get("octave"))),t}parseVolta(e){var t=new eo;return t.allNumbers="true"===e.attributes.get("allNumbers"),e.attributes.has("firstNumber")&&(t.firstNumber=parseInt(e.attributes.get("firstNumber"))),e.attributes.has("lastNumber")&&(t.lastNumber=parseInt(e.attributes.get("lastNumber"))),t}parseWedge(e){var t=new Zn;return t.decrescendo="true"===e.attributes.get("decrescendo"),t}parseTupletBracket(e){var t=new $n;return e.attributes.has("number")&&(t.number=parseInt(e.attributes.get("number"))),t}parseWavyLine(e){return new Kn}parseSlur(e){return new Qn}parseGuitar(e){var t=new jn,i=e.innerText.trim();for(let e=0;e<i.length;e++)"/"===i.charAt(e)?t.chord.strings.push(0):t.chord.strings.push(parseInt(i.charAt(e)));return t}parseText(e){var t=new Jn;switch(e.attributes.has("x")&&(t.x=parseFloat(e.attributes.get("x"))),e.attributes.has("x")&&(t.y=parseFloat(e.attributes.get("y"))),e.getAttribute("align")){case"left":t.align=N.Left;break;case"center":t.align=N.Center;break;case"right":t.align=N.Right}switch(e.getAttribute("frame")){case"rectangle":t.frame=zs.Rectangle;break;case"ellipse":t.frame=zs.Ellipse;break;case"circle":t.frame=zs.Circle;break;case"none":t.frame=zs.None}if(e.firstElement){for(var i of e.childNodes)if(i.nodeType===b.Element)switch(i.localName){case"font":t.fontFace=i.getAttribute("face"),i.attributes.has("weight")&&(t.weight=parseInt(i.attributes.get("weight"))),i.attributes.has("height")&&(t.height=parseInt(i.attributes.get("height")));break;case"content":t.text=i.innerText}}else t.text=e.innerText;return t}parseInfo(e){for(var t of e.childNodes)if(t.nodeType===b.Element)switch(t.localName){case"author":this.score.tab=t.firstChild.innerText;break;case"comment":this.score.notices=t.firstChild.innerText}}}class oo extends ge{get name(){return"Capella"}constructor(){super()}readScore(){var e;C.debug(this.name,"Loading ZIP entries");let t=null;if(e=new _t(this.data).read(),C.debug(this.name,"Zip entries loaded"),0<e.length)for(var i of e)"score.xml"===i.fileName&&(t=L.toString(i.data,this.settings.importer.encoding));else this.data.reset(),t=L.toString(this.data.readAll(),this.settings.importer.encoding);if(!t)throw new fe("No valid capella file");C.debug(this.name,"Start Parsing score.xml");try{var s=new no,a=(s.parseXml(t,this.settings),C.debug(this.name,"score.xml parsed"),s.score);return a}catch(e){throw new fe("Failed to parse CapXML",e)}}}class ho{constructor(e){this._targets=new Set,this._callback=e,window.addEventListener("resize",this.onWindowResize.bind(this),!1)}observe(e){this._targets.add(e)}unobserve(e){this._targets.delete(e)}disconnect(){this._targets.clear()}onWindowResize(){var e=[];for(const t of this._targets)e.push({target:t,contentRect:void 0,borderBoxSize:void 0,contentBoxSize:[],devicePixelContentBoxSize:[]});this._callback(e,this)}}class lo{constructor(e){this._elements=[];let t=null;const i=this._check.bind(this);this._check=()=>{t=t||setTimeout(()=>{i(),t=null},100)},this._callback=e,window.addEventListener("resize",this._check,!0),document.addEventListener("scroll",this._check,!0)}observe(e){0<=this._elements.indexOf(e)||(this._elements.push(e),this._check())}unobserve(t){this._elements=this._elements.filter(e=>e!=t)}_check(){const i=[];this._elements.forEach(e=>{var t=e.getBoundingClientRect();0<=t.top+t.height&&t.top<=window.innerHeight&&0<=t.left+t.width&&t.left<=window.innerWidth&&i.push({target:e,isIntersecting:!0})}),i.length&&this._callback(i,this)}}class co{constructor(e,t){this.vertical=e,this.createLayout=t}}class uo{constructor(e,t){this.supportsWorkers=e,this.createCanvas=t}}class O{static createStyleElement(e,t){var i=e.getElementById("alphaTabStyle");i||(t?((i=e.createElement("style")).id="alphaTabStyle",t=`
            @font-face {
                font-family: 'alphaTab';
                 src: url('${t}Bravura.eot');
                 src: url('${t}Bravura.eot?#iefix') format('embedded-opentype')
                      , url('${t}Bravura.woff') format('woff')
                      , url('${t}Bravura.otf') format('opentype')
                      , url('${t}Bravura.svg#Bravura') format('svg');
                 font-weight: normal;
                 font-style: normal;
            }
            .at-surface * {
                cursor: default;
                vertical-align: top;
                overflow: visible;
            }
            .at-surface-svg text {
                dominant-baseline: central;
            }             
            .at {
                 font-family: 'alphaTab';
                 speak: none;
                 font-style: normal;
                 font-weight: normal;
                 font-variant: normal;
                 text-transform: none;
                 line-height: 1;
                 line-height: 1;
                 -webkit-font-smoothing: antialiased;
                 -moz-osx-font-smoothing: grayscale;
                 font-size: ${O.MusicFontSize}px;
                 overflow: visible !important;
            }`,i.innerHTML=t,e.getElementsByTagName("head").item(0).appendChild(i),O.bravuraFontChecker.checkForFontAvailability()):C.error("AlphaTab","Font directory could not be detected, cannot create style element"))}static get globalThis(){if(void 0===O._globalThis){try{O._globalThis=globalThis}catch(e){}void 0===O._globalThis&&(O._globalThis=self),void 0===O._globalThis&&(O._globalThis=global),void 0===O._globalThis&&(O._globalThis=window),void 0===O._globalThis&&(O._globalThis=Function("return this")())}return this._globalThis}static get isRunningInWorker(){return"WorkerGlobalScope"in O.globalThis}static get isRunningInAudioWorklet(){return"AudioWorkletGlobalScope"in O.globalThis}static createAlphaTabWorker(t){if(O.isWebPackBundled)return new Worker(new URL("@coderline/alphatab",{}));if(!t)throw new me(T.AlphaTabErrorType.General,"Could not detect alphaTab script file, cannot initialize renderer");try{var e,i;return O.webPlatform===Rs.BrowserModule?(e=new Blob([`import * as alphaTab from '${t}'`],{type:"text/javascript"}),new Worker(URL.createObjectURL(e),{type:"module"})):(i=new Blob([`importScripts('${t}')`]),new Worker(URL.createObjectURL(i)))}catch(e){return C.warning("Rendering","Could not create inline worker, fallback to normal worker"),new Worker(t)}}static throttle(e,t){let i=0;return()=>{O.globalThis.clearTimeout(i),i=O.globalThis.setTimeout(e,t)}}static detectScriptFile(){try{var e={};if(e&&-1===e.indexOf("file://"))return e}catch(e){}return"document"in O.globalThis&&document.currentScript?document.currentScript.src:null}static registerJQueryPlugin(){if(!O.isRunningInWorker&&O.globalThis&&"jQuery"in O.globalThis){var e=O.globalThis.jQuery;let a=new aa;e.fn.alphaTab=function(i){const s=Array.prototype.slice.call(arguments,1);return 1===this.length?a.exec(this[0],i,s):this.each((e,t)=>{a.exec(t,i,s)})},e.alphaTab={restore:aa.restore},e.fn.alphaTab.fn=a}}static getRenderEngineFactory(e){return e&&O.renderEngines.has(e)?O.renderEngines.get(e):O.renderEngines.get("default")}static getLayoutEngineFactory(e){return e&&O.layoutEngines.has(e)?O.layoutEngines.get(e):O.layoutEngines.get(T.LayoutMode.Page)}static buildImporters(){return[new Qe,new Nt,new wt,new xt,new oo,new je]}static createDefaultRenderEngines(){var e=new Map;return e.set("svg",new uo(!0,()=>new na)),e.set("default",e.get("svg")),O.createPlatformSpecificRenderEngines(e),e}static createPlatformSpecificRenderEngines(e){e.set("html5",new uo(!1,()=>new us))}static createDefaultStaveProfiles(){var e=new Map,t=(e.set(T.StaveProfile.ScoreTab,[new Pa("score-effects",[new dr,new mr,new Ka,new cr,new Da,new za,new fr,new pr,new Za(!0),new yr,new rr,new br,new or,new Yn,new Fa]),new Cn,new Pa("tab-effects",[new Aa,new Za(!1),new Ga,new Qa,new pr,new yr,new rr,new br,new or,new hr,new Va,new qa(g.Natural),new qa(g.Artificial),new qa(g.Pinch),new qa(g.Tap),new qa(g.Semi),new qa(g.Feedback),new Ja,new Ma,new Ua,new er,new sr,new tr,new Yn]),new Un(!1,!1,!1)]),e.set(T.StaveProfile.Score,[new Pa("score-effects",[new dr,new mr,new Ka,new cr,new Da,new za,new fr,new pr,new Za(!0),new yr,new rr,new br,new or,new Va,new Ja,new er,new sr,new tr,new Yn,new Fa]),new Cn,new Pa("score-bottom-effects",[new Aa,new Za(!1),new Ga,new Qa])]),[new dr,new mr,new Ka,new cr,new Da,new za,new pr,new yr,new rr,new br,new or,new hr,new Va,new qa(g.Artificial),new qa(g.Pinch),new qa(g.Tap),new qa(g.Semi),new qa(g.Feedback),new Ja,new Ma,new Ua,new er,new sr,new tr,new Yn,new Fa]);return e.set(T.StaveProfile.Tab,[new Pa("tab-effects",t),new Un(!0,!0,!0),new Pa("tab-bottom-effects",[new Qa])]),e.set(T.StaveProfile.TabMixed,[new Pa("tab-effects",t),new Un(!1,!1,!1),new Pa("tab-bottom-effects",[new Qa])]),e}static createDefaultLayoutEngines(){var e=new Map;return e.set(T.LayoutMode.Page,new co(!0,e=>new Ir(e))),e.set(T.LayoutMode.Horizontal,new co(!1,e=>new Dr(e))),e}static platformInit(){O.isRunningInAudioWorklet?Zs.init():O.isRunningInWorker?(cs.init(),ts.init()):O.webPlatform!==Rs.Browser&&O.webPlatform!==Rs.BrowserModule||(O.registerJQueryPlugin(),O.HighDpiFactor=window.devicePixelRatio,"ResizeObserver"in O.globalThis||(O.globalThis.ResizeObserver=ho),"IntersectionObserver"in O.globalThis||(O.globalThis.IntersectionObserver=lo),"replaceChildren"in Element.prototype||(Element.prototype.replaceChildren=function(...e){this.innerHTML="",this.append(...e)},Document.prototype.replaceChildren=Element.prototype.replaceChildren,DocumentFragment.prototype.replaceChildren=Element.prototype.replaceChildren),"replaceAll"in String.prototype)||(String.prototype.replaceAll=function(e,t){return this.replace(new RegExp(e,"g"),t)})}static detectWebPack(){try{if("function"==typeof __webpack_require__)return!0}catch(e){}return!1}static detectWebPlatform(){try{if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return Rs.NodeJs}catch(e){}try{var e={};if(e&&"string"==typeof e&&!e.startsWith("file://"))return Rs.BrowserModule}catch(e){}return Rs.Browser}}O.MusicFontSize=34,O.HighDpiFactor=1,O._globalThis=void 0,O.webPlatform=O.detectWebPlatform(),O.isWebPackBundled=O.detectWebPack(),O.scriptFile=O.detectScriptFile(),O.bravuraFontChecker=new Xs(["alphaTab"]),O.renderEngines=O.createDefaultRenderEngines(),O.layoutEngines=O.createDefaultLayoutEngines(),O.staveProfiles=O.createDefaultStaveProfiles(),O.platformInit();class po{constructor(){var e;this.scriptFile=null,this.fontDirectory=null,this.file=null,this.tex=!1,this.tracks=null,this.enableLazyLoading=!0,this.engine="default",this.logLevel=T.LogLevel.Info,this.useWorkers=!0,this.includeNoteBounds=!1,!O.isRunningInWorker&&O.globalThis.ALPHATAB_ROOT?(this.scriptFile=O.globalThis.ALPHATAB_ROOT,this.scriptFile=po.ensureFullUrl(this.scriptFile),this.scriptFile=po.appendScriptName(this.scriptFile)):this.scriptFile=O.scriptFile,!O.isRunningInWorker&&O.globalThis.ALPHATAB_FONT?(this.fontDirectory=O.globalThis.ALPHATAB_FONT,this.fontDirectory=po.ensureFullUrl(this.fontDirectory)):(this.fontDirectory=this.scriptFile,this.fontDirectory&&0<=(e=this.fontDirectory.lastIndexOf(String.fromCharCode(47)))&&(this.fontDirectory=this.fontDirectory.substr(0,e)+"/font/"))}static ensureFullUrl(t){if(!t)return"";if(t.startsWith("http")||t.startsWith("https")||t.startsWith("file"))return t;{let e="";var i,s=O.globalThis.location;return e=(e+=null==(i=s.protocol)?void 0:i.toString())+"//".toString(),s.hostname&&(e+=null==(i=s.hostname)?void 0:i.toString()),s.port&&(e=(e+=":".toString())+(null==(i=s.port)?void 0:i.toString())),t.startsWith("/")||0<(i=s.pathname.split("/").slice(0,-1).join("/")).length&&(i.startsWith("/")||(e+="/".toString()),e+=null==i?void 0:i.toString()),t.startsWith("/")||(e+="/".toString()),e+=null==t?void 0:t.toString()}}static appendScriptName(e){return e&&!e.endsWith(".js")&&(e.endsWith("/")||(e+="/"),e+="alphaTab.js"),e}}class go{}go.version="1.2.3",go.date="2022-10-16T13:33:07.436Z";var s,e=Object.freeze({__proto__:null,ScoreImporter:ge,ScoreLoader:Ms,UnsupportedFormatError:fe});class mo{init(e,t){this.data=e,this.settings=t}export(e,t=null){var i=qe.withCapacity(1024);return this.init(i,null!=t?t:new Di),this.writeScore(e),i.toArray()}}(To=s=s||{})[To.SteelGuitar=1]="SteelGuitar",To[To.AcousticGuitar=2]="AcousticGuitar",To[To.TwelveStringGuitar=3]="TwelveStringGuitar",To[To.ElectricGuitar=4]="ElectricGuitar",To[To.Bass=5]="Bass",To[To.ClassicalGuitar=23]="ClassicalGuitar",To[To.UprightBass=6]="UprightBass",To[To.Ukulele=7]="Ukulele",To[To.Banjo=8]="Banjo",To[To.Mandolin=9]="Mandolin",To[To.Piano=10]="Piano",To[To.Synth=12]="Synth",To[To.Strings=11]="Strings",To[To.Brass=13]="Brass",To[To.Reed=14]="Reed",To[To.Woodwind=15]="Woodwind",To[To.Vocal=16]="Vocal",To[To.PitchedIdiophone=17]="PitchedIdiophone",To[To.Fx=21]="Fx",To[To.PercussionKit=18]="PercussionKit",To[To.Idiophone=19]="Idiophone",To[To.Membraphone=20]="Membraphone";class t{constructor(e,t,i=null){this.icon=s.Piano,this.icon=e,this.instrumentSetName=t,i?this.instrumentSetType=i:((e=t.split(" "))[0]=e[0].substr(0,1).toLowerCase()+e[0].substr(1),this.instrumentSetType=e.join(""))}}class fo{constructor(){this._rhythmIdLookup=new Map}writeXml(e){var t=new rt;return this._rhythmIdLookup=new Map,this.writeDom(t,e),t.toFormattedString("",!0)}writeDom(e,t){var e=e.addElement("GPIF"),i=(e.addElement("GPVersion").innerText="7",e.addElement("GPRevision")),s=(i.innerText="7",i.attributes.set("required","12021"),i.attributes.set("recommended","12023"),i.innerText="12025",e.addElement("Encoding").addElement("EncodingDescription").innerText="GP7",this.writeScoreNode(e,t),this.writeMasterTrackNode(e,t),this.writeAudioTracksNode(e,t),this.writeTracksNode(e,t),this.writeMasterBarsNode(e,t),e.addElement("Bars")),a=e.addElement("Voices"),r=e.addElement("Beats"),n=e.addElement("Notes"),o=e.addElement("Rhythms");for(const h of t.tracks)for(const l of h.staves)for(const d of l.bars){this.writeBarNode(s,d);for(const c of d.voices){this.writeVoiceNode(a,c);for(const u of c.beats){this.writeBeatNode(r,u,o);for(const p of u.notes)this.writeNoteNode(n,p)}}}}writeNoteNode(e,t){var i=e.addElement("Note");i.attributes.set("id",t.id.toString()),this.writeNoteProperties(i,t),t.isGhost&&(i.addElement("AntiAccent").innerText="normal"),t.isLetRing&&i.addElement("LetRing"),t.isTrill&&(i.addElement("Trill").innerText=t.trillValue.toString());let s=0;switch(t.isStaccato&&(s|=1),t.accentuated){case H.Normal:s|=8;break;case H.Heavy:s|=4}switch(0<s&&(i.addElement("Accent").innerText=s.toString()),(t.isTieOrigin||t.isTieDestination)&&((e=i.addElement("Tie")).attributes.set("origin",t.isTieOrigin?"true":"false"),e.attributes.set("destination",t.isTieDestination?"true":"false")),t.vibrato){case J.Slight:i.addElement("Vibrato").innerText="Slight";break;case J.Wide:i.addElement("Vibrato").innerText="Wide"}if(t.isFingering){switch(t.leftHandFinger){case v.Thumb:i.addElement("LeftFingering").innerText="P";break;case v.IndexFinger:i.addElement("LeftFingering").innerText="I";break;case v.MiddleFinger:i.addElement("LeftFingering").innerText="M";break;case v.AnnularFinger:i.addElement("LeftFingering").innerText="A";break;case v.LittleFinger:i.addElement("LeftFingering").innerText="C"}switch(t.rightHandFinger){case v.Thumb:i.addElement("RightFingering").innerText="P";break;case v.IndexFinger:i.addElement("RightFingering").innerText="I";break;case v.MiddleFinger:i.addElement("RightFingering").innerText="M";break;case v.AnnularFinger:i.addElement("RightFingering").innerText="A";break;case v.LittleFinger:i.addElement("RightFingering").innerText="C"}}0<=t.percussionArticulation?i.addElement("InstrumentArticulation").innerText=t.percussionArticulation.toString():i.addElement("InstrumentArticulation").innerText="0"}writeNoteProperties(e,t){var i=e.addElement("Properties");if(this.writeConcertPitch(i,t),this.writeTransposedPitch(i,t),t.isStringed&&(this.writeSimplePropertyNode(i,"String","String",(t.string-1).toString()),this.writeSimplePropertyNode(i,"Fret","Fret",t.fret.toString()),this.writeSimplePropertyNode(i,"Midi","Number",t.realValue.toString())),t.isPiano&&(this.writeSimplePropertyNode(i,"Octave","Number",t.octave.toString()),this.writeSimplePropertyNode(i,"Tone","Step",t.tone.toString()),this.writeSimplePropertyNode(i,"Midi","Number",t.realValue.toString())),t.beat.tap&&this.writeSimplePropertyNode(i,"Tapped","Enable",null),t.harmonicType!==g.None){switch(t.harmonicType){case g.Natural:this.writeSimplePropertyNode(i,"HarmonicType","HType","Natural");break;case g.Artificial:this.writeSimplePropertyNode(i,"HarmonicType","HType","Artificial");break;case g.Pinch:this.writeSimplePropertyNode(i,"HarmonicType","HType","Pinch");break;case g.Tap:this.writeSimplePropertyNode(i,"HarmonicType","HType","Tap");break;case g.Semi:this.writeSimplePropertyNode(i,"HarmonicType","HType","Semi");break;case g.Feedback:this.writeSimplePropertyNode(i,"HarmonicType","HType","Feedback")}0!==t.harmonicValue&&this.writeSimplePropertyNode(i,"HarmonicFret","HFret",t.harmonicValue.toString())}t.isDead&&this.writeSimplePropertyNode(i,"Muted","Enable",null),t.isPalmMute&&this.writeSimplePropertyNode(i,"PalmMuted","Enable",null),t.hasBend&&this.writeBend(i,t),t.isHammerPullOrigin&&this.writeSimplePropertyNode(i,"HopoOrigin","Enable",null),t.isHammerPullDestination&&this.writeSimplePropertyNode(i,"HopoDestination","Enable",null),t.isLeftHandTapped&&this.writeSimplePropertyNode(i,"LeftHandTapped","Enable",null);let s=0;switch(t.slideInType){case q.IntoFromAbove:s|=32;break;case q.IntoFromBelow:s|=16}switch(t.slideOutType){case m.Shift:s|=1;break;case m.Legato:s|=2;break;case m.OutDown:s|=4;break;case m.OutUp:s|=8;break;case m.PickSlideDown:s|=64;break;case m.PickSlideUp:s|=128}0<s&&this.writeSimplePropertyNode(i,"Slide","Flags",s.toString())}writeTransposedPitch(e,t){t.isPercussion?this.writePitch(e,"ConcertPitch","C","-1",""):this.writePitchForValue(e,"TransposedPitch",t.displayValueWithoutBend,t.accidentalMode)}writeConcertPitch(e,t){t.isPercussion?this.writePitch(e,"ConcertPitch","C","-1",""):this.writePitchForValue(e,"ConcertPitch",t.realValueWithoutHarmonic,t.accidentalMode)}writePitchForValue(e,t,i,s){let a=0,r=0,n="",o="";var h=()=>{a=i%12,r=i/12|0,n=y.defaultSteps[a],o=y.defaultAccidentals[a]};switch(h(),s){case Y.Default:break;case Y.ForceNone:case Y.ForceNatural:o="";break;case Y.ForceSharp:o="#";break;case Y.ForceDoubleSharp:"#"===o&&(i-=2,h()),o="x";break;case Y.ForceFlat:"#"===o&&(i+=1,h()),o="b";break;case Y.ForceDoubleFlat:"#"===o&&(i+=2,h()),o="bb"}this.writePitch(e,t,n,r.toString(),o)}writePitch(e,t,i,s,a){e=e.addElement("Property"),e.attributes.set("name",t),t=e.addElement("Pitch");t.addElement("Step").innerText=i,t.addElement("Accidental").innerText=a,t.addElement("Octave").innerText=s}writeBend(e,t){t.hasBend&&t.bendPoints.length<=4&&this.writeStandardBend(e,t.bendPoints)}writeStandardBend(e,t){this.writeSimplePropertyNode(e,"Bended","Enable",null);var i,s,a=t[0],r=t[t.length-1];switch(t.length){case 4:i=t[1],s=t[2];break;case 3:i=t[1],s=t[1];break;default:s=i=new B((a.offset+r.offset)/2,(a.value+r.value)/2)}this.writeSimplePropertyNode(e,"BendDestinationOffset","Float",this.toBendOffset(r.offset).toString()),this.writeSimplePropertyNode(e,"BendDestinationValue","Float",this.toBendValue(r.value).toString()),this.writeSimplePropertyNode(e,"BendMiddleOffset1","Float",this.toBendOffset(i.offset).toString()),this.writeSimplePropertyNode(e,"BendMiddleOffset2","Float",this.toBendOffset(s.offset).toString()),this.writeSimplePropertyNode(e,"BendMiddleValue","Float",this.toBendValue(i.value).toString()),this.writeSimplePropertyNode(e,"BendOriginOffset","Float",this.toBendOffset(a.offset).toString()),this.writeSimplePropertyNode(e,"BendOriginValue","Float",this.toBendValue(a.value).toString())}toBendValue(e){return 25*e}toBendOffset(e){return e/B.MaxPosition*100}writeBeatNode(e,t,i){var s=e.addElement("Beat");if(s.attributes.set("id",t.id.toString()),s.addElement("Dynamic").innerText=l[t.dynamics],t.fadeIn&&(s.addElement("Fadding").innerText="FadeIn"),t.isTremolo)switch(t.tremoloSpeed){case x.Eighth:s.addElement("Tremolo").innerText="1/2";break;case x.Sixteenth:s.addElement("Tremolo").innerText="1/4";break;case x.ThirtySecond:s.addElement("Tremolo").innerText="1/8"}switch(t.hasChord&&s.addElement("Chord").setCData(t.chordId),t.crescendo!==X.None&&(s.addElement("Hairpin").innerText=X[t.crescendo]),t.brushType){case U.ArpeggioUp:s.addElement("Arpeggio").innerText="Up";break;case U.ArpeggioDown:s.addElement("Arpeggio").innerText="Down"}switch(t.text&&s.addElement("FreeText").setCData(t.text),t.graceType){case _.OnBeat:case _.BeforeBeat:s.addElement("GraceNotes").innerText=_[t.graceType]}if(t.ottava!==W.Regular&&(s.addElement("Ottavia").innerText=W[t.ottava].substr(1)),t.hasWhammyBar&&this.writeWhammyNode(s,t),(t.isLegatoOrigin||t.isLegatoDestination)&&((e=s.addElement("Legato")).attributes.set("origin",t.isLegatoOrigin?"true":"false"),e.attributes.set("destination",t.isLegatoDestination?"true":"false")),this.writeRhythm(s,t,i),null!==t.preferredBeamDirection)switch(t.preferredBeamDirection){case E.Up:s.addElement("TransposedPitchStemOrientation").innerText="Upward";break;case E.Down:s.addElement("TransposedPitchStemOrientation").innerText="Downward"}s.addElement("ConcertPitchStemOrientation").innerText="Undefined",t.isRest||(s.addElement("Notes").innerText=t.notes.map(e=>e.id).join(" ")),this.writeBeatProperties(s,t),this.writeBeatXProperties(s,t),t.lyrics&&0<t.lyrics.length&&this.writeBeatLyrics(s,t.lyrics)}writeBeatLyrics(e,t){var i=e.addElement("Lyrics");for(const s of t)i.addElement("Line").setCData(s)}writeBeatXProperties(e,t){e=e.addElement("XProperties");0<t.brushDuration&&this.writeSimpleXPropertyNode(e,"687935489","Int",t.brushDuration.toString())}writeBeatProperties(e,t){var i=e.addElement("Properties");switch(t.brushType){case U.BrushUp:this.writeSimplePropertyNode(i,"Brush","Direction","Up");break;case U.BrushDown:this.writeSimplePropertyNode(i,"Brush","Direction","Down")}switch(t.pickStroke){case j.Up:this.writeSimplePropertyNode(i,"PickStroke","Direction","Up");break;case j.Down:this.writeSimplePropertyNode(i,"PickStroke","Direction","Down")}switch(t.slap&&this.writeSimplePropertyNode(i,"Slapped","Enable",null),t.pop&&this.writeSimplePropertyNode(i,"Popped","Enable",null),t.vibrato){case J.Wide:this.writeSimplePropertyNode(i,"VibratoWTremBar","Strength","Wide");break;case J.Slight:this.writeSimplePropertyNode(i,"VibratoWTremBar","Strength","Slight")}}writeRhythm(e,t,i){var s=`${t.duration}_${t.dots}_${t.tupletNumerator}_${t.tupletDenominator}';`;let a;if(this._rhythmIdLookup.has(s))a=this._rhythmIdLookup.get(s);else{a=this._rhythmIdLookup.size.toString(),this._rhythmIdLookup.set(s,a);s=i.addElement("Rhythm");s.attributes.set("id",a),t.hasTuplet&&((i=s.addElement("PrimaryTuplet")).attributes.set("num",t.tupletNumerator.toString()),i.attributes.set("den",t.tupletDenominator.toString())),0<t.dots&&s.addElement("AugmentationDot").attributes.set("count",t.dots.toString());let e="Quarter";switch(t.duration){case x.QuadrupleWhole:e="Long";break;case x.DoubleWhole:e="DoubleWhole";break;case x.Whole:e="Whole";break;case x.Half:e="Half";break;case x.Quarter:e="Quarter";break;case x.Eighth:e="Eighth";break;case x.Sixteenth:e="16th";break;case x.ThirtySecond:e="32nd";break;case x.SixtyFourth:e="64th";break;case x.OneHundredTwentyEighth:e="128th";break;case x.TwoHundredFiftySixth:e="256th"}s.addElement("NoteValue").innerText=e}e.addElement("Rhythm").attributes.set("ref",a)}writeWhammyNode(e,t){t.hasWhammyBar&&t.whammyBarPoints.length<=4&&this.writeStandardWhammy(e,t.whammyBarPoints)}writeStandardWhammy(e,t){var i,s,e=e.addElement("Whammy"),a=t[0],r=t[t.length-1];switch(t.length){case 4:i=t[1],s=t[2];break;case 3:i=t[1],s=t[1];break;default:s=i=new B((a.offset+r.offset)/2,(a.value+r.value)/2)}e.attributes.set("destinationOffset",this.toBendOffset(r.offset).toString()),e.attributes.set("destinationValue",this.toBendValue(r.value).toString()),e.attributes.set("middleOffset1",this.toBendOffset(i.offset).toString()),e.attributes.set("middleOffset2",this.toBendOffset(s.offset).toString()),e.attributes.set("middleValue",this.toBendValue(i.value).toString()),e.attributes.set("originOffset",this.toBendOffset(a.offset).toString()),e.attributes.set("originValue",this.toBendValue(a.value).toString())}writeScoreNode(e,t){e=e.addElement("Score");e.addElement("Title").setCData(t.title),e.addElement("SubTitle").setCData(t.subTitle),e.addElement("Artist").setCData(t.artist),e.addElement("Album").setCData(t.album),e.addElement("Words").setCData(t.words),e.addElement("Music").setCData(t.music),e.addElement("WordsAndMusic").setCData(t.words===t.music?t.words:""),e.addElement("Copyright").setCData(t.copyright),e.addElement("Tabber").setCData(t.tab),e.addElement("Instructions").setCData(t.instructions),e.addElement("Notices").setCData(t.notices),e.addElement("FirstPageHeader").setCData(""),e.addElement("FirstPageFooter").setCData(""),e.addElement("PageHeader").setCData(""),e.addElement("PageFooter").setCData(""),e.addElement("ScoreSystemsDefaultLayout").setCData("4"),e.addElement("ScoreSystemsLayout").setCData("4"),e.addElement("ScoreZoomPolicy").innerText="Value",e.addElement("ScoreZoom").innerText="1",e.addElement("MultiVoice").innerText="1>"}writeMasterTrackNode(e,t){var i,e=e.addElement("MasterTrack"),s=(e.addElement("Tracks").innerText=t.tracks.map(e=>e.index).join(" "),e.addElement("Automations")),e=(0<t.masterBars.length&&t.masterBars[0].isAnacrusis&&e.addElement("Anacrusis"),s.addElement("Automation"));e.addElement("Type").innerText="Tempo",e.addElement("Linear").innerText="false",e.addElement("Bar").innerText="0",e.addElement("Position").innerText="0",e.addElement("Visible").innerText="true",e.addElement("Value").innerText=t.tempo+" 2",t.tempoLabel&&(e.addElement("Text").innerText=t.tempoLabel);for(const a of t.masterBars)0<a.index&&a.tempoAutomation&&((i=s.addElement("Automation")).addElement("Type").innerText="Tempo",i.addElement("Linear").innerText=a.tempoAutomation.isLinear?"true":"false",i.addElement("Bar").innerText=a.index.toString(),i.addElement("Position").innerText=a.tempoAutomation.ratioPosition.toString(),i.addElement("Visible").innerText="true",i.addElement("Value").innerText=a.tempoAutomation.value+" 2",a.tempoAutomation.text)&&(i.addElement("Text").innerText=a.tempoAutomation.text)}writeAudioTracksNode(e,t){e.addElement("AudioTracks")}writeTracksNode(e,t){var i=e.addElement("Tracks");for(const s of t.tracks)this.writeTrackNode(i,s)}writeTrackNode(e,t){e=e.addElement("Track");e.attributes.set("id",t.index.toString()),e.addElement("Name").setCData(t.name),e.addElement("ShortName").setCData(t.shortName),e.addElement("Color").innerText=`${t.color.r} ${t.color.g} `+t.color.b,e.addElement("SystemsDefautLayout").innerText="3",e.addElement("SystemsLayout").innerText="1",e.addElement("AutoBrush"),e.addElement("PalmMute").innerText="0",e.addElement("PlayingStyle").innerText=pe.isGuitar(t.playbackInfo.program)?"StringedPick":"Default",e.addElement("UseOneChannelPerString"),e.addElement("IconId").innerText=fo.getIconId(t.playbackInfo).toString(),this.writeInstrumentSetNode(e,t),this.writeTransposeNode(e,t),this.writeRseNode(e,t),e.addElement("ForcedSound").innerText="-1",this.writeMidiConnectionNode(e,t),t.playbackInfo.isSolo?e.addElement("PlaybackState").innerText="Solo":t.playbackInfo.isMute?e.addElement("PlaybackState").innerText="Mute":e.addElement("PlaybackState").innerText="Default",e.addElement("AudioEngineState").innerText="MIDI",this.writeLyricsNode(e,t),this.writeStavesNode(e,t),this.writeSoundsAndAutomations(e,t)}static getIconId(e){return 9===e.primaryChannel?fo.DrumKitProgramInfo.icon:fo.MidiProgramInfoLookup.has(e.program)?fo.MidiProgramInfoLookup.get(e.program).icon:s.SteelGuitar}writeSoundAndAutomation(e,t,i,s,a,r,n,o=0){e=e.addElement("Sound"),e.addElement("Name").setCData(i),e.addElement("Label").setCData(i),e.addElement("Path").setCData(s),e.addElement("Role").setCData(a),e=e.addElement("MIDI"),e.addElement("LSB").innerText="0",e.addElement("MSB").innerText="0",e.addElement("Program").innerText=n.toString(),e=t.addElement("Automation");e.addElement("Type").innerText="Sound",e.addElement("Linear").innerText="false",e.addElement("Bar").innerText=r.toString(),e.addElement("Position").innerText=o.toString(),e.addElement("Visible").innerText="true",e.addElement("Value").setCData(s+`;${i};`+a)}writeSoundsAndAutomations(e,t){var i=e.addElement("Sounds"),s=e.addElement("Automations");if(0<t.staves.length&&0<t.staves[0].bars.length){var a=`Track_${t.index}_Initial`,r="Midi/"+t.playbackInfo.program;let e=!1;for(const c of t.staves)for(const u of c.bars)for(const p of u.voices)for(const g of p.beats){var n,o,h,l=g.getAutomation(V.Instrument),d=0===u.index&&0===g.index;l&&(n=d?a:"ProgramChange_"+g.id,o=d?r:"Midi/"+l.value,h=d?"Factory":"User",d||e||(this.writeSoundAndAutomation(i,s,a,r,"Factory",t.staves[0].bars[0].index,t.playbackInfo.program),e=!0),this.writeSoundAndAutomation(i,s,n,o,h,u.index,l.value,l.ratioPosition),d)&&(e=!0)}}}writeMidiConnectionNode(e,t){e=e.addElement("MidiConnection");e.addElement("Port").innerText=t.playbackInfo.port.toString(),e.addElement("PrimaryChannel").innerText=t.playbackInfo.primaryChannel.toString(),e.addElement("SecondaryChannel").innerText=t.playbackInfo.secondaryChannel.toString(),e.addElement("ForeOneChannelPerString").innerText="false"}writeRseNode(e,t){e=e.addElement("RSE").addElement("ChannelStrip");e.attributes.set("version","E56"),e.addElement("Parameters").innerText=`0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 0.5 1 0.5 ${t.playbackInfo.balance/16} ${t.playbackInfo.volume/16} 0.5 0.5 0.5`}writeStavesNode(e,t){var i=e.addElement("Staves");for(const s of t.staves)this.writeStaffNode(i,s)}writeStaffNode(e,t){e=e.addElement("Staff").addElement("Properties");if(this.writeSimplePropertyNode(e,"CapoFret","Fret",t.capo.toString()),this.writeSimplePropertyNode(e,"FretCount","Fret","24"),0<t.tuning.length){var i=e.addElement("Property");switch(i.attributes.set("name","Tuning"),i.addElement("Pitches").innerText=t.tuning.slice().reverse().join(" "),i.addElement("Label").setCData(t.tuningName),i.addElement("LabelVisible").innerText=t.tuningName?"true":"false",i.addElement("Flat"),t.tuning.length){case 3:i.addElement("Instrument").innerText="Shamisen";break;case 4:105===t.track.playbackInfo.program?i.addElement("Instrument").innerText="Banjo":42==t.track.playbackInfo.program?i.addElement("Instrument").innerText="Cello":43==t.track.playbackInfo.program?i.addElement("Instrument").innerText="Contrabass":40==t.track.playbackInfo.program?i.addElement("Instrument").innerText="Violin":41==t.track.playbackInfo.program?i.addElement("Instrument").innerText="Viola":i.addElement("Instrument").innerText="Bass";break;case 5:105===t.track.playbackInfo.program?i.addElement("Instrument").innerText="Banjo":i.addElement("Instrument").innerText="Bass";break;case 6:105===t.track.playbackInfo.program?i.addElement("Instrument").innerText="Banjo":t.track.playbackInfo.program<=39?i.addElement("Instrument").innerText="Bass":i.addElement("Instrument").innerText="Guitar";break;case 7:t.track.playbackInfo.program<=39?i.addElement("Instrument").innerText="Bass":i.addElement("Instrument").innerText="Guitar";break;default:i.addElement("Instrument").innerText="Guitar"}}this.writeSimplePropertyNode(e,"PartialCapoFret","Fret","0"),this.writeSimplePropertyNode(e,"PartialCapoStringFlags","Bitset",t.tuning.map(e=>"0").join("")),this.writeSimplePropertyNode(e,"TuningFlat","Enable",null),this.writeDiagramCollection(e,t,"DiagramCollection"),this.writeDiagramCollection(e,t,"DiagramWorkingSet")}writeDiagramCollection(e,t,i){var s,a,e=e.addElement("Property"),r=(e.attributes.set("name",i),e.addElement("Items"));for([s,a]of t.chords){var n=r.addElement("Item"),o=(n.attributes.set("id",s),n.attributes.set("name",a.name),n.addElement("Diagram")),h=(o.attributes.set("stringCount",a.strings.length.toString()),o.attributes.set("fretCount","5"),o.attributes.set("baseFret",(a.firstFret-1).toString()),o.attributes.set("barStates",a.strings.map(e=>"1").join(" ")),[]),l=new Map;for(let e=0;e<a.strings.length;e++){var d,c,u=a.strings[e];-1!==u&&(d=o.addElement("Fret"),c=a.strings.length-1-e,d.attributes.set("string",c.toString()),d.attributes.set("fret",(u-a.firstFret+1).toString()),l.has(u)||(l.set(u,[]),h.push(u)),l.get(u).push(c))}h.sort();var p=o.addElement("Fingering");if(0<a.barreFrets.length){var g=[v.LittleFinger,v.AnnularFinger,v.MiddleFinger,v.IndexFinger];for(const S of h){var m=l.get(S);if(1<m.length&&0<=a.barreFrets.indexOf(S)){var f=0<g.length?g.pop():v.IndexFinger;for(const _ of m){var y=p.addElement("Position");switch(f){case v.LittleFinger:y.attributes.set("finger","Pinky");break;case v.AnnularFinger:y.attributes.set("finger","Ring");break;case v.MiddleFinger:y.attributes.set("finger","Middle");break;case v.IndexFinger:y.attributes.set("finger","Index")}y.attributes.set("fret",(S-a.firstFret+1).toString()),y.attributes.set("string",_.toString())}}}}var n=o.addElement("Property"),n=(n.attributes.set("name","ShowName"),n.attributes.set("type","bool"),n.attributes.set("value",a.showName?"true":"false"),o.addElement("Property")),n=(n.attributes.set("name","ShowDiagram"),n.attributes.set("type","bool"),n.attributes.set("value",a.showDiagram?"true":"false"),o.addElement("Property")),n=(n.attributes.set("name","ShowFingering"),n.attributes.set("type","bool"),n.attributes.set("value",a.showFingering?"true":"false"),o.addElement("Chord")),b=n.addElement("KeyNote"),b=(b.attributes.set("step","C"),b.attributes.set("accidental","Natural"),n.addElement("BassNote")),b=(b.attributes.set("step","C"),b.attributes.set("accidental","Natural"),n.addElement("Degree")),b=(b.attributes.set("interval","Third"),b.attributes.set("alteration","Major"),b.attributes.set("omitted","false"),n.addElement("Degree"));b.attributes.set("interval","Fifth"),b.attributes.set("alteration","Perfect"),b.attributes.set("omitted","false")}}writeSimplePropertyNode(e,t,i,s){e=e.addElement("Property"),e.attributes.set("name",t),t=e.addElement(i);return null!==s&&(t.innerText=s),e}writeSimpleXPropertyNode(e,t,i,s){e=e.addElement("XProperty"),e.attributes.set("id",t),t=e.addElement(i);return null!==s&&(t.innerText=s),e}writeLyricsNode(e,t){var i=e.addElement("Lyrics"),s=(i.attributes.set("dispatched","true"),[]);for(const o of t.staves[0].bars)for(const h of o.voices)if(!h.isEmpty)for(const l of h.beats)if(l.lyrics)for(let e=0;e<l.lyrics.length;e++){for(;e>=s.length;){var a=new Ie;a.startBar=o.index,a.text="[Empty]",s.push(a)}var r=s[e];r.text="[Empty]"==r.text?l.lyrics[e]:r.text+" "+l.lyrics[e].split(" ").join("+")}for(let e=0;e<s.length;e++){var n=i.addElement("Line");n.addElement("Text").setCData(s[e].text),n.addElement("Offset").innerText=s[e].startBar.toString()}}writeTransposeNode(e,t){var e=e.addElement("Transpose"),i=Math.floor(t.staves[0].displayTranspositionPitch/12),t=t.staves[0].displayTranspositionPitch-12*i;e.addElement("Chromatic").innerText=t.toString(),e.addElement("Octave").innerText=i.toString()}writeInstrumentSetNode(e,t){var e=e.addElement("InstrumentSet"),i=t.staves[0];if(e.addElement("LineCount").innerText=i.standardNotationLineCount.toString(),0<t.percussionArticulations.length||i.isPercussion){var i=0<t.percussionArticulations.length?t.percussionArticulations:Array.from(Te.instrumentArticulations.values()),s=(e.addElement("Name").innerText=fo.DrumKitProgramInfo.instrumentSetName,e.addElement("Type").innerText=fo.DrumKitProgramInfo.instrumentSetType,new it),a=new Map,r=e.addElement("Elements");for(const l of i){{var n,o=r.addElement("Element");let e=l.elementType;a.has(e)?(n=a.get(e),e+=" "+n,a.set(e,n+1)):a.set(e,1),n=e,o.addElement("Name").innerText=e,o.addElement("Type").innerText=l.elementType,s=o.addElement("Articulations")}var h=s.addElement("Articulation");switch(h.addElement("Name").innerText=n+" "+s.childNodes.length,h.addElement("StaffLine").innerText=l.staffLine.toString(),h.addElement("Noteheads").innerText=[this.mapMusicSymbol(l.noteHeadDefault),this.mapMusicSymbol(l.noteHeadHalf),this.mapMusicSymbol(l.noteHeadWhole)].join(" "),l.techniqueSymbolPlacement){case P.Top:h.addElement("TechniquePlacement").innerText="below";break;case P.Middle:h.addElement("TechniquePlacement").innerText="inside";break;case P.Bottom:h.addElement("TechniquePlacement").innerText="above"}h.addElement("TechniqueSymbol").innerText=this.mapMusicSymbol(l.techniqueSymbol),h.addElement("InputMidiNumbers").innerText="",h.addElement("OutputMidiNumber").innerText=l.outputMidiNumber.toString()}}else{i=fo.MidiProgramInfoLookup.has(t.playbackInfo.program)?fo.MidiProgramInfoLookup.get(t.playbackInfo.program):fo.MidiProgramInfoLookup.get(0);e.addElement("Name").innerText=i.instrumentSetName,e.addElement("Type").innerText=i.instrumentSetType;t=e.addElement("Elements").addElement("Element");t.addElement("Pitched").innerText="Pitched",t.addElement("Type").innerText="pitched",t.addElement("SoundbankName").innerText="";i=t.addElement("Articulations").addElement("Articulation");i.addElement("Name").innerText="",i.addElement("StaffLine").innerText="0",i.addElement("Noteheads").innerText="noteheadBlack noteheadHalf noteheadWhole",i.addElement("TechniquePlacement").innerText="outside",i.addElement("TechniqueSymbol").innerText="",i.addElement("InputMidiNumbers").innerText="",i.addElement("OutputRSESound").innerText="",i.addElement("OutputMidiNumber").innerText="0"}}mapMusicSymbol(e){return e===k.None?"":(e=k[e]).substring(0,1).toLowerCase()+e.substring(1)}writeMasterBarsNode(e,t){var i=e.addElement("MasterBars");for(const s of t.masterBars)this.writeMasterBarNode(i,s)}writeMasterBarNode(i,s){var i=i.addElement("MasterBar"),e=i.addElement("Key"),t=(e.addElement("AccidentalCount").innerText=s.keySignature.toString(),e.addElement("Mode").innerText=Z[s.keySignatureType],e.addElement("Sharps").innerText="Sharps",i.addElement("Time").innerText=s.timeSignatureNumerator+"/"+s.timeSignatureDenominator,[]);for(const r of s.score.tracks)for(const n of r.staves)t.push(n.bars[s.index].id.toString());if(i.addElement("Bars").innerText=t.join(" "),s.isDoubleBar&&i.addElement("DoubleBar"),s.isSectionStart&&((e=i.addElement("Section")).addElement("Letter").setCData(s.section.marker),e.addElement("Text").setCData(s.section.text)),(s.isRepeatStart||s.isRepeatEnd)&&((e=i.addElement("Repeat")).attributes.set("start",s.isRepeatStart?"true":"false"),e.attributes.set("end",s.isRepeatEnd?"true":"false"),s.isRepeatEnd)&&e.attributes.set("count",s.repeatCount.toString()),0<s.alternateEndings){let e=s.alternateEndings;var a=[];let t=0;for(;0<e;)1==(e>>t&1)&&(a.push(t+1),e&=~(1<<t)),t++;i.addElement("AlternateEndings").innerText=a.join(" ")}s.tripletFeel!==u.NoTripletFeel&&(i.addElement("TripletFeel").innerText=u[s.tripletFeel]),this.writeFermatas(i,s)}writeFermatas(e,t){var i=t.fermata.size;if(0!==i&&0<i){var s,a,r=e.addElement("Fermatas");for([s,a]of t.fermata)this.writeFermata(r,s,a)}}writeFermata(e,t,i){let s=-1,a=1;if(0<t)for(;a<10&&(s=t/p.QuarterTime*a)!==Math.floor(s);)s=-1,a++;else s=0,a=1;-1!==s&&((e=e.addElement("Fermata")).addElement("Type").innerText=te[i.type],e.addElement("Length").innerText=i.length.toString(),e.addElement("Offset").innerText=s+"/"+a)}writeBarNode(e,t){e=e.addElement("Bar");e.attributes.set("id",t.id.toString()),e.addElement("Voices").innerText=t.voices.map(e=>e.isEmpty?"-1":e.id.toString()).join(" "),e.addElement("Clef").innerText=c[t.clef],t.clefOttava!==W.Regular&&(e.addElement("Ottavia").innerText=W[t.clefOttava].substr(1)),t.simileMark!==r.None&&(e.addElement("SimileMark").innerText=r[t.simileMark])}writeVoiceNode(e,t){t.isEmpty||((e=e.addElement("Voice")).attributes.set("id",t.id.toString()),e.addElement("Beats").innerText=t.beats.map(e=>e.id).join(" "))}}fo.MidiProgramInfoLookup=new Map([[0,new t(s.Piano,"Acoustic Piano")],[1,new t(s.Piano,"Acoustic Piano")],[2,new t(s.Piano,"Electric Piano")],[3,new t(s.Piano,"Acoustic Piano")],[4,new t(s.Piano,"Electric Piano")],[5,new t(s.Piano,"Electric Piano")],[6,new t(s.Piano,"Harpsichord")],[7,new t(s.Piano,"Harpsichord")],[8,new t(s.PitchedIdiophone,"Celesta")],[9,new t(s.PitchedIdiophone,"Vibraphone")],[10,new t(s.PitchedIdiophone,"Vibraphone")],[11,new t(s.PitchedIdiophone,"Vibraphone")],[12,new t(s.PitchedIdiophone,"Xylophone")],[13,new t(s.PitchedIdiophone,"Xylophone")],[14,new t(s.PitchedIdiophone,"Vibraphone")],[15,new t(s.Banjo,"Banjo")],[16,new t(s.Piano,"Electric Organ")],[17,new t(s.Piano,"Electric Organ")],[18,new t(s.Piano,"Electric Organ")],[19,new t(s.Piano,"Electric Organ")],[20,new t(s.Piano,"Electric Organ")],[21,new t(s.Piano,"Electric Organ")],[22,new t(s.Woodwind,"Recorder")],[23,new t(s.Piano,"Electric Organ")],[24,new t(s.ClassicalGuitar,"Nylon Guitar")],[25,new t(s.SteelGuitar,"Steel Guitar")],[26,new t(s.SteelGuitar,"Electric Guitar")],[27,new t(s.ElectricGuitar,"Electric Guitar")],[28,new t(s.ElectricGuitar,"Electric Guitar")],[29,new t(s.ElectricGuitar,"Electric Guitar")],[30,new t(s.SteelGuitar,"Electric Guitar")],[31,new t(s.SteelGuitar,"Electric Guitar")],[32,new t(s.Bass,"Acoustic Bass")],[33,new t(s.Bass,"Electric Bass")],[34,new t(s.Bass,"Electric Bass")],[35,new t(s.Bass,"Acoustic Bass")],[36,new t(s.Bass,"Electric Bass")],[37,new t(s.Bass,"Electric Bass")],[38,new t(s.Synth,"Synth Bass")],[39,new t(s.Synth,"Synth Bass")],[40,new t(s.Strings,"Violin")],[41,new t(s.Strings,"Viola")],[42,new t(s.Strings,"Cello")],[43,new t(s.Strings,"Contrabass")],[44,new t(s.Strings,"Violin")],[45,new t(s.Strings,"Violin")],[46,new t(s.Piano,"Harp")],[47,new t(s.Membraphone,"Timpani")],[48,new t(s.Strings,"Violin")],[49,new t(s.Strings,"Violin")],[50,new t(s.Strings,"Violin")],[51,new t(s.Strings,"Violin")],[52,new t(s.Vocal,"Voice")],[53,new t(s.Vocal,"Voice")],[54,new t(s.Vocal,"Voice")],[55,new t(s.Synth,"Pad Synthesizer")],[56,new t(s.Brass,"Trumpet")],[57,new t(s.Brass,"Trombone")],[58,new t(s.Brass,"Tuba")],[59,new t(s.Brass,"Trumpet")],[60,new t(s.Brass,"French Horn")],[61,new t(s.Brass,"Trumpet")],[62,new t(s.Brass,"Trumpet")],[63,new t(s.Brass,"Trumpet")],[64,new t(s.Reed,"Saxophone")],[65,new t(s.Reed,"Saxophone")],[66,new t(s.Reed,"Saxophone")],[67,new t(s.Reed,"Saxophone")],[68,new t(s.Reed,"Oboe")],[69,new t(s.Reed,"English Horn")],[70,new t(s.Reed,"Bassoon")],[71,new t(s.Reed,"Clarinet")],[72,new t(s.Reed,"Piccolo")],[73,new t(s.Woodwind,"Flute")],[74,new t(s.Woodwind,"Recorder")],[75,new t(s.Woodwind,"Flute")],[76,new t(s.Woodwind,"Recorder")],[77,new t(s.Woodwind,"Flute")],[78,new t(s.Woodwind,"Recorder")],[79,new t(s.Woodwind,"Flute")],[80,new t(s.Synth,"Lead Synthesizer")],[81,new t(s.Synth,"Lead Synthesizer")],[82,new t(s.Synth,"Lead Synthesizer")],[83,new t(s.Synth,"Lead Synthesizer")],[84,new t(s.Synth,"Lead Synthesizer")],[85,new t(s.Synth,"Lead Synthesizer")],[86,new t(s.Synth,"Lead Synthesizer")],[87,new t(s.Synth,"Lead Synthesizer")],[88,new t(s.Synth,"Pad Synthesizer")],[89,new t(s.Synth,"Pad Synthesizer")],[90,new t(s.Synth,"Pad Synthesizer")],[91,new t(s.Synth,"Pad Synthesizer")],[92,new t(s.Synth,"Pad Synthesizer")],[93,new t(s.Synth,"Pad Synthesizer")],[94,new t(s.Synth,"Pad Synthesizer")],[95,new t(s.Synth,"Pad Synthesizer")],[96,new t(s.Fx,"Pad Synthesizer")],[97,new t(s.Fx,"Pad Synthesizer")],[98,new t(s.Fx,"Pad Synthesizer")],[99,new t(s.Fx,"Pad Synthesizer")],[100,new t(s.Fx,"Lead Synthesizer")],[101,new t(s.Fx,"Lead Synthesizer")],[102,new t(s.Fx,"Lead Synthesizer")],[103,new t(s.Fx,"Trumpet")],[104,new t(s.ElectricGuitar,"Banjo")],[105,new t(s.Banjo,"Banjo")],[106,new t(s.Ukulele,"Ukulele")],[107,new t(s.Banjo,"Banjo")],[108,new t(s.PitchedIdiophone,"Xylophone")],[109,new t(s.Reed,"Bassoon")],[110,new t(s.Strings,"Violin")],[111,new t(s.Woodwind,"Flute")],[112,new t(s.PitchedIdiophone,"Xylophone")],[113,new t(s.Idiophone,"Celesta")],[114,new t(s.PitchedIdiophone,"Vibraphone")],[115,new t(s.Idiophone,"Xylophone")],[116,new t(s.Membraphone,"Xylophone")],[117,new t(s.Membraphone,"Xylophone")],[118,new t(s.Membraphone,"Xylophone")],[119,new t(s.Idiophone,"Celesta")],[120,new t(s.Fx,"Steel Guitar")],[121,new t(s.Fx,"Recorder")],[122,new t(s.Fx,"Recorder")],[123,new t(s.Fx,"Recorder")],[124,new t(s.Fx,"Recorder")],[125,new t(s.Fx,"Recorder")],[126,new t(s.Fx,"Recorder")],[127,new t(s.Fx,"Timpani")]]),fo.DrumKitProgramInfo=new t(s.PercussionKit,"Drums","drumKit");class yo{constructor(){this._checkValue=yo.CrcInit,this.reset()}static buildCrc32Lookup(){var i=new Uint32Array(256);for(let e=0;e<i.length;e++){let t=e;for(let e=0;e<8;e++)t=1==(1&t)?t>>>1^3988292384:t>>>1;i[e]=t}return i}get value(){return~this._checkValue}update(t,i,s){for(let e=0;e<s;e++)this._checkValue=yo.Crc32Lookup[255&(this._checkValue^t[i+e])]^this._checkValue>>>8}reset(){this._checkValue=yo.CrcInit}}yo.Crc32Lookup=yo.buildCrc32Lookup(),yo.CrcInit=4294967295;class G{}G.MAX_WBITS=15,G.WSIZE=1<<G.MAX_WBITS,G.WMASK=G.WSIZE-1,G.MIN_MATCH=3,G.MAX_MATCH=258,G.DEFAULT_MEM_LEVEL=8,G.PENDING_BUF_SIZE=1<<G.DEFAULT_MEM_LEVEL+8,G.HASH_BITS=G.DEFAULT_MEM_LEVEL+7,G.HASH_SIZE=1<<G.HASH_BITS,G.HASH_SHIFT=(G.HASH_BITS+G.MIN_MATCH-1)/G.MIN_MATCH,G.HASH_MASK=G.HASH_SIZE-1,G.MIN_LOOKAHEAD=G.MAX_MATCH+G.MIN_MATCH+1,G.MAX_DIST=G.WSIZE-G.MIN_LOOKAHEAD;class bo{constructor(e,t,i,s){this.length=null,this.numCodes=0,this.codes=null,this.huffman=e,this.minNumCodes=i,this.maxLength=s,this.freqs=new Int16Array(t),this.bitLengthCounts=new Int32Array(s)}reset(){for(let e=0;e<this.freqs.length;e++)this.freqs[e]=0;this.codes=null,this.length=null}buildTree(){var e=this.freqs.length,s=new Int32Array(e);let a=0,i=0;for(let t=0;t<e;t++){var r=this.freqs[t];if(0!==r){let e=a++;for(;;){if(!(0<e))break;var n=Math.floor((e-1)/2);if(!(this.freqs[s[n]]>r))break;s[e]=s[n],e=n}s[e]=t,i=t}}for(;a<2;){var t=i<2?++i:0;s[a++]=t}this.numCodes=Math.max(i+1,this.minNumCodes);var o=a,h=new Int32Array(4*a-2),l=new Int32Array(2*a-1);let d=o;for(let e=0;e<a;e++){var c=s[e];h[2*e]=c,h[2*e+1]=-1,l[e]=this.freqs[c]<<8,s[e]=e}do{var u=s[0],p=s[--a];let e=0,t=1;for(;t<a;)t+1<a&&l[s[t]]>l[s[t+1]]&&t++,s[e]=s[t],t=2*(e=t)+1;let i=l[p];for(;;){if(!(0<(t=e)))break;if(!(l[s[e=Math.floor((t-1)/2)]]>i))break;s[t]=s[e]}s[t]=p;var g=s[0],m=(h[2*(p=d++)]=u,h[2*p+1]=g,Math.min(255&l[u],255&l[g]));for(i=l[u]+l[g]-m+1,l[p]=i,e=0,t=1;t<a;)t+1<a&&l[s[t]]>l[s[t+1]]&&t++,s[e]=s[t],t=2*(e=t)+1;for(;;){if(!(0<(t=e)))break;if(!(l[s[e=Math.floor((t-1)/2)]]>i))break;s[t]=s[e]}s[t]=p}while(1<a);this.buildLength(h)}buildLength(s){this.length=new Uint8Array(this.freqs.length);var e=Math.floor(s.length/2),t=Math.floor((e+1)/2);let a=0;for(let e=0;e<this.maxLength;e++)this.bitLengthCounts[e]=0;var i=new Int32Array(e);i[e-1]=0;for(let t=e-1;0<=t;t--)if(-1!=s[2*t+1]){let e=i[t]+1;e>this.maxLength&&(e=this.maxLength,a++),i[s[2*t]]=e,i[s[2*t+1]]=e}else{var r=i[t];this.bitLengthCounts[r-1]++,this.length[s[2*t]]=i[t]}if(0!=a){let e=this.maxLength-1;do{for(;0==this.bitLengthCounts[--e];);for(;this.bitLengthCounts[e]--,this.bitLengthCounts[++e]++,0<(a-=1<<this.maxLength-1-e)&&e<this.maxLength-1;);}while(0<a);this.bitLengthCounts[this.maxLength-1]+=a,this.bitLengthCounts[this.maxLength-2]-=a;let i=2*t;for(let t=this.maxLength;0!=t;t--){let e=this.bitLengthCounts[t-1];for(;0<e;){var n=2*s[i++];-1==s[1+n]&&(this.length[s[n]]=t,e--)}}}}getEncodedLength(){let t=0;for(let e=0;e<this.freqs.length;e++)t+=this.freqs[e]*this.length[e];return t}calcBLFreq(e){let t,i,s,a=-1,r=0;for(;r<this.numCodes;){s=1;var n=this.length[r];for(0==n?(t=138,i=3):(t=6,i=3,a!=n&&(e.freqs[n]++,s=0)),a=n,r++;r<this.numCodes&&a==this.length[r]&&(r++,!(++s>=t)););s<i?e.freqs[a]+=s:0!=a?e.freqs[bo.Repeat3To6]++:s<=10?e.freqs[bo.Repeat3To10]++:e.freqs[bo.Repeat11To138]++}}setStaticCodes(e,t){this.codes=e,this.length=t}buildCodes(){var t=new Int32Array(this.maxLength);let i=0;this.codes=new Int16Array(this.freqs.length);for(let e=0;e<this.maxLength;e++)t[e]=i,i+=this.bitLengthCounts[e]<<15-e;for(let e=0;e<this.numCodes;e++){var s=this.length[e];0<s&&(this.codes[e]=o.bitReverse(t[s-1]),t[s-1]+=1<<16-s)}}writeTree(e){let t,i,s,a=-1,r=0;for(;r<this.numCodes;){s=1;var n=this.length[r];for(0==n?(t=138,i=3):(t=6,i=3,a!=n&&(e.writeSymbol(n),s=0)),a=n,r++;r<this.numCodes&&a==this.length[r]&&(r++,!(++s>=t)););if(s<i)for(;0<s--;)e.writeSymbol(a);else 0!=a?(e.writeSymbol(bo.Repeat3To6),this.huffman.pending.writeBits(s-3,2)):s<=10?(e.writeSymbol(bo.Repeat3To10),this.huffman.pending.writeBits(s-3,3)):(e.writeSymbol(bo.Repeat11To138),this.huffman.pending.writeBits(s-11,7))}}writeSymbol(e){this.huffman.pending.writeBits(65535&this.codes[e],this.length[e])}}bo.Repeat3To6=16,bo.Repeat3To10=17,bo.Repeat11To138=18;class o{constructor(e){this.last_lit=0,this.extra_bits=0,this.pending=e,this.literalTree=new bo(this,o.LITERAL_NUM,257,15),this.distTree=new bo(this,o.DIST_NUM,1,15),this.blTree=new bo(this,o.BITLEN_NUM,4,7),this.d_buf=new Int16Array(o.BUFSIZE),this.l_buf=new Uint8Array(o.BUFSIZE)}static staticInit(){let e=0;for(;e<144;)o.staticLCodes[e]=o.bitReverse(48+e<<8),o.staticLLength[e++]=8;for(;e<256;)o.staticLCodes[e]=o.bitReverse(256+e<<7),o.staticLLength[e++]=9;for(;e<280;)o.staticLCodes[e]=o.bitReverse(-256+e<<9),o.staticLLength[e++]=7;for(;e<o.LITERAL_NUM;)o.staticLCodes[e]=o.bitReverse(-88+e<<8),o.staticLLength[e++]=8;for(e=0;e<o.DIST_NUM;e++)o.staticDCodes[e]=o.bitReverse(e<<11),o.staticDLength[e]=5}static bitReverse(e){return o.bit4Reverse[15&e]<<12|o.bit4Reverse[e>>4&15]<<8|o.bit4Reverse[e>>8&15]<<4|o.bit4Reverse[e>>12]}isFull(){return this.last_lit>=o.BUFSIZE}reset(){this.last_lit=0,this.extra_bits=0,this.literalTree.reset(),this.distTree.reset(),this.blTree.reset()}flushStoredBlock(e,t,i,s){this.pending.writeBits((o.STORED_BLOCK<<1)+(s?1:0),3),this.pending.alignToByte(),this.pending.writeShort(i),this.pending.writeShort(~i),this.pending.writeBlock(e,t,i),this.reset()}flushBlock(e,t,i,s){this.literalTree.freqs[o.EOF_SYMBOL]++,this.literalTree.buildTree(),this.distTree.buildTree(),this.literalTree.calcBLFreq(this.blTree),this.distTree.calcBLFreq(this.blTree),this.blTree.buildTree();let a=4;for(let e=18;e>a;e--)0<this.blTree.length[o.BL_ORDER[e]]&&(a=e+1);let r=14+3*a+this.blTree.getEncodedLength()+this.literalTree.getEncodedLength()+this.distTree.getEncodedLength()+this.extra_bits,n=this.extra_bits;for(let e=0;e<o.LITERAL_NUM;e++)n+=this.literalTree.freqs[e]*o.staticLLength[e];for(let e=0;e<o.DIST_NUM;e++)n+=this.distTree.freqs[e]*o.staticDLength[e];r>=n&&(r=n),0<=t&&i+4<r>>3?this.flushStoredBlock(e,t,i,s):(r==n?(this.pending.writeBits((o.STATIC_TREES<<1)+(s?1:0),3),this.literalTree.setStaticCodes(o.staticLCodes,o.staticLLength),this.distTree.setStaticCodes(o.staticDCodes,o.staticDLength)):(this.pending.writeBits((o.DYN_TREES<<1)+(s?1:0),3),this.sendAllTrees(a)),this.compressBlock(),this.reset())}sendAllTrees(t){this.blTree.buildCodes(),this.literalTree.buildCodes(),this.distTree.buildCodes(),this.pending.writeBits(this.literalTree.numCodes-257,5),this.pending.writeBits(this.distTree.numCodes-1,5),this.pending.writeBits(t-4,4);for(let e=0;e<t;e++)this.pending.writeBits(this.blTree.length[o.BL_ORDER[e]],3);this.literalTree.writeTree(this.blTree),this.distTree.writeTree(this.blTree)}compressBlock(){for(let e=0;e<this.last_lit;e++){var t,i,s=255&this.l_buf[e],a=this.d_buf[e];0!=a--?(t=o.Lcode(s),this.literalTree.writeSymbol(t),0<(t=Math.floor((t-261)/4))&&t<=5&&this.pending.writeBits(s&(1<<t)-1,t),i=o.Dcode(a),this.distTree.writeSymbol(i),0<(t=Math.floor(i/2)-1)&&this.pending.writeBits(a&(1<<t)-1,t)):this.literalTree.writeSymbol(s)}this.literalTree.writeSymbol(o.EOF_SYMBOL)}tallyDist(e,t){this.d_buf[this.last_lit]=e,this.l_buf[this.last_lit++]=t-3;t=o.Lcode(t-3),this.literalTree.freqs[t]++,265<=t&&t<285&&(this.extra_bits+=Math.floor((t-261)/4)),t=o.Dcode(e-1);return this.distTree.freqs[t]++,4<=t&&(this.extra_bits+=Math.floor(t/2)-1),this.isFull()}tallyLit(e){return this.d_buf[this.last_lit]=0,this.l_buf[this.last_lit++]=e,this.literalTree.freqs[e]++,this.isFull()}static Lcode(e){if(255==e)return 285;let t=257;for(;8<=e;)t+=4,e>>=1;return t+e}static Dcode(e){let t=0;for(;4<=e;)t+=2,e>>=1;return t+e}}o.BUFSIZE=1<<G.DEFAULT_MEM_LEVEL+6,o.LITERAL_NUM=286,o.STORED_BLOCK=0,o.STATIC_TREES=1,o.DYN_TREES=2,o.DIST_NUM=30,o.staticLCodes=new Int16Array(o.LITERAL_NUM),o.staticLLength=new Uint8Array(o.LITERAL_NUM),o.staticDCodes=new Int16Array(o.DIST_NUM),o.staticDLength=new Uint8Array(o.DIST_NUM),o.BL_ORDER=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],o.bit4Reverse=new Uint8Array([0,8,4,12,2,10,6,14,1,9,5,13,3,11,7,15]),o.BITLEN_NUM=19,o.EOF_SYMBOL=256,o.staticInit();class So{constructor(e){this.maxChain=128,this.niceLength=128,this.goodLength=8,this.insertHashIndex=0,this.lookahead=0,this.inputBuf=null,this.inputOff=0,this.inputEnd=0,this.prevAvailable=!1,this.matchStart=0,this.matchLen=0,this.pending=e,this.huffman=new o(e),this.inputCrc=new yo,this.window=new Uint8Array(2*G.WSIZE),this.head=new Int16Array(G.HASH_SIZE),this.prev=new Int16Array(G.WSIZE),this.blockStart=1,this.strstart=1}reset(){this.huffman.reset(),this.inputCrc.reset(),this.blockStart=1,this.strstart=1,this.lookahead=0,this.prevAvailable=!1,this.matchLen=G.MIN_MATCH-1;for(let e=0;e<G.HASH_SIZE;e++)this.head[e]=0;for(let e=0;e<G.WSIZE;e++)this.prev[e]=0}updateHash(){this.insertHashIndex=this.window[this.strstart]<<G.HASH_SHIFT^this.window[this.strstart+1]}needsInput(){return this.inputEnd==this.inputOff}setInput(e,t,i){i=t+i;this.inputBuf=e,this.inputOff=t,this.inputEnd=i}deflate(e,t){let i;do{this.fillWindow();var s=e&&this.inputOff==this.inputEnd;i=this.deflateSlow(s,t)}while(this.pending.isFlushed&&i);return i}deflateSlow(e,t){if(this.lookahead<G.MIN_LOOKAHEAD&&!e)return!1;for(;this.lookahead>=G.MIN_LOOKAHEAD||e;){if(0==this.lookahead)return this.prevAvailable&&this.huffman.tallyLit(255&this.window[this.strstart-1]),this.prevAvailable=!1,this.huffman.flushBlock(this.window,this.blockStart,this.strstart-this.blockStart,t),this.blockStart=this.strstart,!1;this.strstart>=2*G.WSIZE-G.MIN_LOOKAHEAD&&this.slideWindow();var i=this.matchStart;let e=this.matchLen;if(this.lookahead>=G.MIN_MATCH&&0!=(s=this.insertString())&&this.strstart-s<=G.MAX_DIST&&this.findLongestMatch(s)&&this.matchLen==G.MIN_MATCH&&this.strstart-this.matchStart>So.TooFar&&(this.matchLen=G.MIN_MATCH-1),e>=G.MIN_MATCH&&this.matchLen<=e){for(this.huffman.tallyDist(this.strstart-1-i,e),e-=2;this.strstart++,this.lookahead--,this.lookahead>=G.MIN_MATCH&&this.insertString(),0<--e;);this.strstart++,this.lookahead--,this.prevAvailable=!1,this.matchLen=G.MIN_MATCH-1}else this.prevAvailable&&this.huffman.tallyLit(255&this.window[this.strstart-1]),this.prevAvailable=!0,this.strstart++,this.lookahead--;if(this.huffman.isFull()){let e=this.strstart-this.blockStart;this.prevAvailable&&e--;var s=t&&0==this.lookahead&&!this.prevAvailable;return this.huffman.flushBlock(this.window,this.blockStart,e,s),this.blockStart+=e,!s}}return!0}findLongestMatch(e){let t,i=this.strstart;var s=i+Math.min(G.MAX_MATCH,this.lookahead)-1,a=Math.max(i-G.MAX_DIST,0),r=this.window,n=this.prev;let o=this.maxChain;var h=Math.min(this.niceLength,this.lookahead);if(this.matchLen=Math.max(this.matchLen,G.MIN_MATCH-1),i+this.matchLen>s)return!1;let l=r[i+this.matchLen-1],d=r[i+this.matchLen];this.matchLen>=this.goodLength&&(o>>=2);do{if(t=e,i=this.strstart,r[t+this.matchLen]==d&&r[t+this.matchLen-1]==l&&r[t]==r[i]&&r[++t]==r[++i]){switch((s-i)%8){case 1:r[++i],r[++t];break;case 2:r[++i]==r[++t]&&(r[++i],r[++t]);break;case 3:r[++i]==r[++t]&&r[++i]==r[++t]&&(r[++i],r[++t]);break;case 4:r[++i]==r[++t]&&r[++i]==r[++t]&&r[++i]==r[++t]&&(r[++i],r[++t]);break;case 5:r[++i]==r[++t]&&r[++i]==r[++t]&&r[++i]==r[++t]&&r[++i]==r[++t]&&(r[++i],r[++t]);break;case 6:r[++i]==r[++t]&&r[++i]==r[++t]&&r[++i]==r[++t]&&r[++i]==r[++t]&&r[++i]==r[++t]&&(r[++i],r[++t]);break;case 7:r[++i]==r[++t]&&r[++i]==r[++t]&&r[++i]==r[++t]&&r[++i]==r[++t]&&r[++i]==r[++t]&&r[++i]==r[++t]&&(r[++i],r[++t])}if(r[i]==r[t])do{if(i==s){++i,++t;break}}while(r[++i]==r[++t]&&r[++i]==r[++t]&&r[++i]==r[++t]&&r[++i]==r[++t]&&r[++i]==r[++t]&&r[++i]==r[++t]&&r[++i]==r[++t]&&r[++i]==r[++t]);if(i-this.strstart>this.matchLen){if(this.matchStart=e,this.matchLen=i-this.strstart,this.matchLen>=h)break;l=r[i-1],d=r[i]}e=65535&n[e&G.WMASK]}}while(a<e&&0!=--o);return this.matchLen>=G.MIN_MATCH}insertString(){var e=(this.insertHashIndex<<G.HASH_SHIFT^this.window[this.strstart+(G.MIN_MATCH-1)])&G.HASH_MASK,t=this.head[e];return this.prev[this.strstart&G.WMASK]=t,this.head[e]=this.strstart,this.insertHashIndex=e,65535&t}fillWindow(){if(this.strstart>=G.WSIZE+G.MAX_DIST&&this.slideWindow(),this.lookahead<G.MIN_LOOKAHEAD&&this.inputOff<this.inputEnd){let e=2*G.WSIZE-this.lookahead-this.strstart;e>this.inputEnd-this.inputOff&&(e=this.inputEnd-this.inputOff),this.window.set(this.inputBuf.subarray(this.inputOff,this.inputOff+e),this.strstart+this.lookahead),this.inputCrc.update(this.inputBuf,this.inputOff,e),this.inputOff+=e,this.lookahead+=e}this.lookahead>=G.MIN_MATCH&&this.updateHash()}slideWindow(){this.window.set(this.window.subarray(G.WSIZE,G.WSIZE+G.WSIZE),0),this.matchStart-=G.WSIZE,this.strstart-=G.WSIZE,this.blockStart-=G.WSIZE;for(let e=0;e<G.HASH_SIZE;++e){var t=65535&this.head[e];this.head[e]=t>=G.WSIZE?t-G.WSIZE:0}for(let e=0;e<G.WSIZE;e++){var i=65535&this.prev[e];this.prev[e]=i>=G.WSIZE?i-G.WSIZE:0}}}So.TooFar=4096;class _o{constructor(e){this._start=0,this._end=0,this._bits=0,this.bitCount=0,this._buffer=new Uint8Array(e)}get isFlushed(){return 0===this._end}reset(){this._start=0,this._end=0,this.bitCount=0}writeShortMSB(e){this._buffer[this._end++]=e>>8&255,this._buffer[this._end++]=255&e}writeShort(e){this._buffer[this._end++]=e,this._buffer[this._end++]=e>>8}writeBlock(e,t,i){this._buffer.set(e.subarray(t,t+i),this._end),this._end+=i}flush(e,t,i){return 8<=this.bitCount&&(this._buffer[this._end++]=255&this._bits,this._bits>>=8,this.bitCount-=8),i>this._end-this._start?(i=this._end-this._start,e.set(this._buffer.subarray(this._start,this._start+i),t),this._start=0,this._end=0):(e.set(this._buffer.subarray(this._start,this._start+i),t),this._start+=i),i}writeBits(e,t){this._bits|=e<<this.bitCount,this.bitCount+=t,16<=this.bitCount&&(this._buffer[this._end++]=255&this._bits,this._buffer[this._end++]=this._bits>>8&255,this._bits>>=16,this.bitCount-=16)}alignToByte(){0<this.bitCount&&(this._buffer[this._end++]=255&this._bits,8<this.bitCount)&&(this._buffer[this._end++]=this._bits>>8&255),this._bits=0,this.bitCount=0}}class wo{constructor(){this._state=0,this._pending=new _o(G.PENDING_BUF_SIZE),this._engine=new So(this._pending),this.reset()}get inputCrc(){return this._engine.inputCrc.value}get isNeedingInput(){return this._engine.needsInput()}get isFinished(){return this._state==wo.FinishedState&&this._pending.isFlushed}reset(){this._state=wo.BusyState,this._pending.reset(),this._engine.reset()}setInput(e,t,i){this._engine.setInput(e,t,i)}deflate(e,t,i){for(var s=i;;){var a=this._pending.flush(e,t,i);if(t+=a,0==(i-=a)||this._state==wo.FinishedState)break;if(!this._engine.deflate(0!=(this._state&wo.IsFlushing),0!=(this._state&wo.IsFinishing)))switch(this._state){case wo.BusyState:return s-i;case wo.FlushingState:let e=8+(7&-this._pending.bitCount);for(;0<e;)this._pending.writeBits(2,10),e-=10;this._state=wo.BusyState;break;case wo.FinishingState:this._pending.alignToByte(),this._state=wo.FinishedState}}return s-i}finish(){this._state|=wo.IsFlushing|wo.IsFinishing}}wo.IsFlushing=4,wo.IsFinishing=8,wo.BusyState=16,wo.FlushingState=20,wo.FinishingState=28,wo.FinishedState=30;class vo{constructor(e,t,i,s,a){this.entry=e,this.crc32=t,this.localHeaderOffset=i,this.compressionMode=s,this.compressedSize=a}}class Bo{constructor(e){this._centralDirectoryHeaders=[],this._deflater=new wo,this._data=e}writeEntry(e){var t=St.CompressionMethodDeflate,i=qe.empty(),s=this.compress(i,e.data,t),a=i.toArray(),i=new vo(e,s,this._data.bytesWritten,t,i.length),i=(this._centralDirectoryHeaders.push(i),L.writeInt32LE(this._data,St.LocalFileHeaderSignature),L.writeUInt16LE(this._data,10),L.writeUInt16LE(this._data,2048),L.writeUInt16LE(this._data,t),L.writeInt16LE(this._data,0),L.writeInt16LE(this._data,0),L.writeInt32LE(this._data,s),L.writeInt32LE(this._data,a.length),L.writeInt32LE(this._data,e.data.length),L.writeInt16LE(this._data,e.fullName.length),L.writeInt16LE(this._data,0),L.stringToBytes(e.fullName));this._data.write(i,0,i.length),this._data.write(a,0,a.length)}compress(e,t,i){if(i!=St.CompressionMethodDeflate)return(i=new yo).update(t,0,t.length),e.write(t,0,t.length),i.value;var s=new Uint8Array(512);for(this._deflater.reset(),this._deflater.setInput(t,0,t.length);!this._deflater.isNeedingInput;){var a=this._deflater.deflate(s,0,s.length);if(a<=0)break;e.write(s,0,a)}for(this._deflater.finish();!this._deflater.isFinished;){var r=this._deflater.deflate(s,0,s.length);if(r<=0)break;e.write(s,0,r)}return this._deflater.inputCrc}end(){var e=this._data.bytesWritten;for(const i of this._centralDirectoryHeaders)this.writeCentralDirectoryHeader(i);var t=this._data.bytesWritten;this.writeEndOfCentralDirectoryRecord(e,t)}writeEndOfCentralDirectoryRecord(e,t){L.writeInt32LE(this._data,St.EndOfCentralDirSignature),L.writeInt16LE(this._data,0),L.writeInt16LE(this._data,0),L.writeInt16LE(this._data,this._centralDirectoryHeaders.length),L.writeInt16LE(this._data,this._centralDirectoryHeaders.length),L.writeInt32LE(this._data,t-e),L.writeInt32LE(this._data,e),L.writeInt16LE(this._data,0)}writeCentralDirectoryHeader(e){L.writeInt32LE(this._data,St.CentralFileHeaderSignature),L.writeUInt16LE(this._data,10),L.writeUInt16LE(this._data,10),L.writeUInt16LE(this._data,2048),L.writeUInt16LE(this._data,e.compressionMode),L.writeInt16LE(this._data,0),L.writeInt16LE(this._data,0),L.writeInt32LE(this._data,e.crc32),L.writeInt32LE(this._data,e.compressedSize),L.writeInt32LE(this._data,e.entry.data.length),L.writeInt16LE(this._data,e.entry.fullName.length),L.writeInt16LE(this._data,0),L.writeInt16LE(this._data,0),L.writeInt16LE(this._data,0),L.writeInt16LE(this._data,0),L.writeInt32LE(this._data,0),L.writeInt32LE(this._data,e.localHeaderOffset);e=L.stringToBytes(e.entry.fullName);this._data.write(e,0,e.length)}}var To=Object.freeze({__proto__:null,ScoreExporter:mo,Gp7Exporter:class extends mo{get name(){return"Guitar Pro 7"}constructor(){super()}writeScore(e){C.debug(this.name,"Writing data entries");var t=(new fo).writeXml(e),i=et.writeForScore(e),e=ct.writeForScore(e),s=(C.debug(this.name,"Writing ZIP entries"),new Bo(this.data));s.writeEntry(new St("VERSION",L.stringToBytes("7.0"))),s.writeEntry(new St("Content/",new Uint8Array(0))),s.writeEntry(new St("Content/BinaryStylesheet",i)),s.writeEntry(new St("Content/PartConfiguration",e)),s.writeEntry(new St("Content/score.gpif",L.stringToBytes(t))),s.end()}}}),ko=Object.freeze({__proto__:null,BeatTickLookup:gs,MasterBarTickLookup:ys,MidiTickLookup:Ss,MidiTickLookupFindBeatResult:bs,MidiFile:pi,get ControllerType(){return ue},MetaDataEvent:gi,MetaEvent:Et,get MetaEventType(){return ae},MetaNumberEvent:mi,MidiEvent:Pt,get MidiEventType(){return se},Midi20PerNotePitchBendEvent:Ii,SystemCommonEvent:Ct,get SystemCommonType(){return a},SystemExclusiveEvent:Ft,MidiFileGenerator:vs,AlphaSynthMidiFileHandler:ps}),No=Object.freeze({__proto__:null,get AccentuationType(){return H},get AccidentalType(){return Gs},get AutomationType(){return V},Automation:ye,Bar:be,Beat:Me,BendPoint:B,get BendStyle(){return z},get BendType(){return w},get BrushType(){return U},Chord:De,get Clef(){return c},Color:We,get CrescendoType(){return X},get Duration(){return x},get DynamicValue(){return l},get FermataType(){return te},Fermata:tt,get Fingers(){return v},get FontStyle(){return de},Font:bi,get GraceType(){return _},get HarmonicType(){return g},InstrumentArticulation:h,JsonConverter:Zi,get KeySignature(){return n},get KeySignatureType(){return Z},Lyrics:Ie,MasterBar:Re,get MusicFontSymbol(){return k},Note:Ne,get NoteAccidentalMode(){return Y},get Ottavia(){return W},get PickStroke(){return j},PlaybackInformation:ze,RenderStylesheet:Ae,RepeatGroup:Oe,Score:Ge,Section:He,get SimileMark(){return r},get SlideInType(){return q},get SlideOutType(){return m},Staff:Ue,Track:Xe,get TripletFeel(){return u},Tuning:y,TupletGroup:xe,get VibratoType(){return J},Voice:Ye,get WhammyType(){return Q}}),xo=Object.freeze({__proto__:null,RenderFinishedEventArgs:ss,ScoreRenderer:ds,BarBounds:as,BeatBounds:rs,Bounds:Ze,BoundsLookup:ls,MasterBarBounds:ns,NoteBounds:os,StaveGroupBounds:hs}),Po=Object.freeze({__proto__:null,AlphaSynth:ui,CircularSampleBuffer:Ys,PlaybackRange:Bs,get PlayerState(){return ne},PlayerStateChangedEventArgs:Rt,PlaybackRangeChangedEventArgs:ci,PositionChangedEventArgs:At,MidiEventsPlayedEventArgs:di,ActiveBeatsChangedEventArgs:Cs,AlphaSynthWebWorkerApi:Qs,AlphaSynthWebAudioOutputBase:qs,AlphaSynthScriptProcessorOutput:Js,AlphaSynthAudioWorkletOutput:ea});T.AlphaTabApi=sa,T.AlphaTabError=me,T.CoreSettings=po,T.DisplaySettings=_i,T.FileLoadError=Ls,T.FormatError=Ve,T.ImporterSettings=wi,T.Logger=C,T.NotationSettings=Se,T.PlayerSettings=Ti,T.ProgressEventArgs=js,T.RenderingResources=Si,T.ResizeEventArgs=Es,T.Settings=Di,T.VibratoPlaybackSettings=vi,T.exporter=To,T.importer=e,T.meta=go,T.midi=ko,T.model=No,T.rendering=xo,T.synth=Po,Object.defineProperty(T,"__esModule",{value:!0})});
